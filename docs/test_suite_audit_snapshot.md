# Test Suite Audit Snapshot

Audit completed by GPT-5.2 (Codex CLI) on 2026-01-01.

This document is a one-shot snapshot of the completed audit and is not intended
to be maintained day-to-day. If you re-audit or materially rewrite the test suite,
create a new snapshot (or resurrect a progress tracker) rather than editing this one.

## Status

- Last updated: 2026-01-01 14:35:44
- Started: 2026-01-01
- Current focus: complete

## Commands

- Pyright (Pylance parity): `PYTHONPATH=. .venv/bin/python -m pyright tests`
- Pytest: `PYTHONPATH=. .venv/bin/pytest tests -q`

## Conventions

- `Check Done`: use `yes` when verified non-drifting + type-clean.
- `Drift Risk`: `low/med/high`.
- `Code Under Test`: prefer `module.py:func` or `Class.method`.
- Total test files: 37
- Total tests discovered: 371

---

## `tests/openrouter/test_chat_completions_adapter.py`

| Test Name | Description | What It Tests | Code Under Test | Mocks/Fixtures | Assertions | Drift Risk | Check Done | Codex Notes | Codex TODO |
|---|---|---|---|---|---|---|---|---|---|
| `test_responses_payload_to_chat_preserves_cache_control` | Preserves cache_control when converting Responses input to Chat Completions messages. | Adapter keeps cache_control and system instructions | `_responses_payload_to_chat_completions_payload` | none | Asserts stream + usage flags, instruction injection, cache_control preserved | low | yes | Reviewed: calls production adapter and checks observable payload fields. |  |
| `test_force_chat_completions_models_matches_slash_glob` | FORCE_CHAT glob matches both slash and dot model ids. | Endpoint selection model glob semantics | `Pipe._select_llm_endpoint` | `Pipe.Valves.model_copy` | Asserts endpoint is `chat_completions` for both id forms | low | yes | Reviewed: exercises production endpoint routing via valves. |  |
| `test_force_responses_models_overrides_force_chat_models` | FORCE_RESPONSES overrides FORCE_CHAT when both match. | Endpoint selection precedence | `Pipe._select_llm_endpoint` | `Pipe.Valves.model_copy` | Asserts endpoint is `responses` | low | yes | Added to eliminate drift from deleted fallback file. |  |
| `test_responses_payload_to_chat_converts_tools_schema` | Responses tools schema converts into Chat Completions schema. | Tools adapter correctness | `_responses_payload_to_chat_completions_payload` | none | Asserts `tools` mapping output | low | yes | Exercises production conversion instead of comparing hand-built dicts. |  |
| `test_chat_completions_stream_adapts_tool_calls_and_usage` | Adapts Chat Completions SSE stream into Responses-style events and final response object. | Streaming adapter for text, annotations, reasoning, tool_calls, and usage/cost | `Pipe.send_openai_chat_completions_streaming_request` | `_FakeSession`, `_FakeResponse` | Asserts event types, final usage mapping, tool call merge, HTTP body params | med | yes | Reviewed: uses real streaming adapter with minimal fake HTTP layer. |  |
| `test_chat_completions_inlines_internal_file_urls` | Inlines internal file URLs for chat streaming requests. | Request body rewrite for input_file blocks | `Pipe.send_openai_chat_completions_streaming_request` | `monkeypatch` `_inline_internal_file_url`, `_FakeSession` | Asserts chat content includes file block with file_data data URL | low | yes | Reviewed: verifies observable outgoing request payload. |  |
| `test_transform_messages_to_input_preserves_annotations` | Preserves assistant annotations and reasoning_details when building Responses input. | Message transform retains metadata fields | `Pipe.transform_messages_to_input` | none | Asserts assistant message item contains annotations and reasoning_details | low | yes | Reviewed: directly calls production transformer. |  |
| `test_send_openrouter_streaming_request_falls_back_to_chat` | Falls back from /responses to /chat/completions when configured and /responses is unsupported. | Fallback routing and event passthrough | `Pipe.send_openrouter_streaming_request` | `monkeypatch` adapters to raise/yield | Asserts chat events yielded after /responses error | med | yes | Reviewed: checks externally visible stream events. |  |
| `test_send_openrouter_streaming_request_does_not_fallback_after_output` | Does not fallback after emitting visible /responses output. | Fallback guard after partial output | `Pipe.send_openrouter_streaming_request` | `monkeypatch` adapters | Asserts partial output preserved, chat not called, error raised | med | yes | Reviewed: enforces contract to avoid mid-stream endpoint switching. |  |
| `test_send_openrouter_streaming_request_fallback_discards_nonvisible_events` | Discards non-visible /responses events before fallback. | Fallback drops response.created and similar internal events | `Pipe.send_openrouter_streaming_request` | `monkeypatch` adapters | Asserts response.created not forwarded and chat output is forwarded | med | yes | Reviewed: ensures user-visible stream stays clean across fallback. |  |
| `test_send_openrouter_nonstreaming_request_as_events_chat_adapter` | Emits a non-streaming chat completion as Responses-style events. | Non-streaming adapter for annotations, reasoning, tool_calls, and usage/cost | `Pipe.send_openrouter_nonstreaming_request_as_events` | `_FakeSession`, `_FakeResponse` | Asserts event types, final usage mapping, tool call output, HTTP body usage include | med | yes | Reviewed: exercises production non-streaming adapter with fake HTTP. |  |
| `test_chat_completions_nonstreaming_inlines_internal_file_urls` | Inlines internal file URLs for chat non-streaming requests. | Request body rewrite for input_file blocks | `Pipe.send_openai_chat_completions_nonstreaming_request` | `monkeypatch` `_inline_internal_file_url`, `_FakeSession` | Asserts outgoing chat content includes file_data data URL | low | yes | Reviewed: verifies observable outgoing request payload. |  |

## `tests/openrouter/test_compliance.py`

| Test Name | Description | What It Tests | Code Under Test | Mocks/Fixtures | Assertions | Drift Risk | Check Done | Codex Notes | Codex TODO |
|---|---|---|---|---|---|---|---|---|---|
| `test_supported_image_formats_are_inlined[image/png]` | Image/png survives and is inlined. | Image format compliance | `Pipe.transform_messages_to_input` | monkeypatch storage + inline | Asserts input_image + data: URL preserved | med | yes | Paramised per pytest collection. |  |
| `test_supported_image_formats_are_inlined[image/jpeg]` | Image/jpeg survives and is inlined. | Image format compliance | `Pipe.transform_messages_to_input` | monkeypatch storage + inline | Asserts input_image + data: URL preserved | med | yes | Paramised per pytest collection. |  |
| `test_supported_image_formats_are_inlined[image/webp]` | Image/webp survives and is inlined. | Image format compliance | `Pipe.transform_messages_to_input` | monkeypatch storage + inline | Asserts input_image + data: URL preserved | med | yes | Paramised per pytest collection. |  |
| `test_supported_image_formats_are_inlined[image/gif]` | Image/gif survives and is inlined. | Image format compliance | `Pipe.transform_messages_to_input` | monkeypatch storage + inline | Asserts input_image + data: URL preserved | med | yes | Paramised per pytest collection. |  |
| `test_supported_audio_formats_map_correctly[block0-mp3]` | Responses-style audio mp3 passes through. | Audio format compliance | `Pipe.transform_messages_to_input` | none | Asserts input_audio format mp3 | low | yes | Paramised per pytest collection. |  |
| `test_supported_audio_formats_map_correctly[block1-wav]` | Tool-style audio/wav maps to wav. | Audio format mapping | `Pipe.transform_messages_to_input` | none | Asserts input_audio format wav | low | yes | Paramised per pytest collection. |  |
| `test_supported_audio_formats_map_correctly[block2-mp3]` | Tool-style audio/mp3 maps to mp3. | Audio format mapping | `Pipe.transform_messages_to_input` | none | Asserts input_audio format mp3 | low | yes | Paramised per pytest collection. |  |
| `test_audio_requires_base64_not_urls` | Remote audio URLs rejected (base64 required). | Audio URL rejection | `Pipe.transform_messages_to_input` | AsyncMock `_emit_error` | Asserts empty data and error emitted | med | yes | Enforces OpenRouter audio requirements. |  |
| `test_file_size_limit_enforced` | Base64 size limit enforced before decode. | Base64 size guard | `Pipe._validate_base64_size` | valves override | Asserts small ok and large rejected | low | yes | Shrinks valve for deterministic test sizes. |  |

## `tests/openrouter/test_errors.py`

| Test Name | Description | What It Tests | Code Under Test | Mocks/Fixtures | Assertions | Drift Risk | Check Done | Codex Notes | Codex TODO |
|---|---|---|---|---|---|---|---|---|---|
| `test_openrouter_api_error_includes_provider_and_request_details` | Parses provider/raw metadata and renders markdown. | Error parsing + markdown output | `_build_openrouter_api_error`, `OpenRouterAPIError.to_markdown` | none | Asserts provider, upstream type, request id, and markdown content | med | yes | Exercises production JSON parsing + markdown template. |  |
| `test_openrouter_api_error_handles_plain_text_payload` | Plain text error bodies still produce useful markdown. | Robust error fallback | `_build_openrouter_api_error`, `OpenRouterAPIError.to_markdown` | none | Asserts fallback guidance appears in markdown | low | yes | Prevents drift where non-JSON bodies crash formatting. |  |
| `test_openrouter_api_error_includes_moderation_metadata` | Moderation metadata extracted and rendered. | Moderation fields | `_build_openrouter_api_error`, `OpenRouterAPIError` fields | none | Asserts model_slug/reasons/flagged_input and markdown includes them | med | yes | Protects UI for moderation failures. |  |
| `test_openrouter_error_markdown_accepts_model_label_and_diagnostics` | to_markdown accepts model label + diagnostics + metrics. | Template inputs wiring | `OpenRouterAPIError.to_markdown` | none | Asserts formatted model limits and labels present | low | yes | Validates operator-facing template contract. |  |
| `test_resolve_error_model_context_uses_registry_spec` | Registry specs drive display name and limits. | Model context resolution | `_resolve_error_model_context`, `ModelFamily.set_dynamic_specs` | dynamic specs set/reset | Asserts display label, diagnostics, and metrics | med | yes | Uses real registry resolution path. |  |
| `test_custom_error_template_skips_lines_for_missing_values` | Missing template values remove conditional lines. | Template conditional removal | `OpenRouterAPIError.to_markdown` | none | Asserts lines with missing values are removed | low | yes | Prevents noisy templates with blank placeholders. |  |
| `test_openrouter_error_includes_metadata_and_raw_blocks` | Metadata and raw blocks serialised for templates. | Metadata serialisation | `_build_openrouter_api_error` | none | Asserts metadata_json/provider_raw_json include content | low | yes | Ensures debugging info is preserved. |  |
| `test_build_openrouter_api_error_merges_extra_metadata` | extra_metadata merged into error metadata. | Metadata merge semantics | `_build_openrouter_api_error` | none | Asserts keys preserved in err.metadata | low | yes | Locks in behaviour for retry hints. |  |
| `test_streaming_fields_render_in_templates` | Streaming error fields available to templates. | Streaming template fields | `OpenRouterAPIError.to_markdown` | none | Asserts native_finish_reason/chunk fields rendered | low | yes | Protects SSE error reporting. |  |
| `test_pipe_builds_streaming_error_from_event` | Pipe builds OpenRouterAPIError from response.failed event. | SSE error parsing | `Pipe._build_streaming_openrouter_error` | none | Asserts streaming flags and parsed fields | med | yes | Exercises production event-shape parsing. |  |
| `test_select_openrouter_template_by_status` | Status codes map to configured templates. | Template selection | `Pipe._select_openrouter_template` | none | Asserts mapping for common codes | low | yes | Protects operator overrides by status. |  |

## `tests/openrouter/test_registry.py`

| Test Name | Description | What It Tests | Code Under Test | Mocks/Fixtures | Assertions | Drift Risk | Check Done | Codex Notes | Codex TODO |
|---|---|---|---|---|---|---|---|---|---|
| `test_capabilities_detects_modalities_and_pricing` | Capabilities derived from modalities and pricing. | Capability derivation | `OpenRouterModelRegistry._derive_capabilities` | none | Asserts vision/image_generation/web_search/etc booleans | low | yes | Uses production capability logic (no reimplementation). |  |
| `test_capabilities_zero_web_search_is_disabled` | web_search pricing of 0 disables web_search capability. | Pricing edge-case | `OpenRouterModelRegistry._derive_capabilities` | none | Asserts web_search False for \"0\" | low | yes | Prevents drift in string/number handling. |  |
| `test_model_family_capabilities_returns_copy_and_defaults` | capabilities() returns a copy and unknown models return {}. | Spec isolation + defaults | `ModelFamily.capabilities`, `ModelFamily.set_dynamic_specs` | dynamic specs set/reset | Asserts copy semantics and unknown default | med | yes | Guards against accidental shared mutation. |  |

## `tests/openrouter/test_streaming.py`

| Test Name | Description | What It Tests | Code Under Test | Mocks/Fixtures | Assertions | Drift Risk | Check Done | Codex Notes | Codex TODO |
|---|---|---|---|---|---|---|---|---|---|
| `test_completion_events_preserve_streamed_text` | Aggregates streamed text into final output and completion events. | SSE aggregation + event emission | `Pipe._run_streaming_loop` | monkeypatch streaming generator | Asserts output text and chat:completion usage fields | med | yes | Uses production loop; mocks only upstream stream. |  |
| `test_streaming_loop_handles_openrouter_errors` | OpenRouterAPIError yields status event and reports error. | Error handling in stream loop | `Pipe._run_streaming_loop`, `Pipe._report_openrouter_error` | monkeypatch stream to raise, spy report | Asserts status done + report args include model ids | med | yes | Validates observable user status + internal reporting. |  |
| `test_streaming_loop_reasoning_status_and_tools` | Reasoning/status/tool calls handled and persisted. | Reasoning/status + tool execution + persistence | `Pipe._run_streaming_loop` | monkeypatch DB persist + execute + ModelFamily.supports | Asserts citation/status events and persisted rows | high | yes | Exercises multi-feature streaming path with minimal IO stubs. |  |
| `test_pipe_stream_mode_outputs_openai_reasoning_chunks` | Stream mode yields OpenAI chat chunks with reasoning_content. | Middleware stream translation | `Pipe.pipe` streaming generator | monkeypatch `_enqueue_job` + producer | Asserts reasoning_content present and internal events suppressed | high | yes | End-to-end pipe streaming path (no network). |  |
| `test_thinking_output_mode_open_webui_suppresses_thinking_status` | open_webui mode shows generic Thinking status, not summary text. | Thinking output mode mapping | `Pipe._run_streaming_loop` | monkeypatch stream | Asserts reasoning events forwarded and summary not in status | med | yes | Protects UI behaviour for thinking summaries. |  |
| `test_thinking_output_mode_status_suppresses_reasoning_events` | status mode emits status text instead of reasoning events. | Thinking output mode mapping | `Pipe._run_streaming_loop` | monkeypatch stream | Asserts reasoning events suppressed and status includes summary | med | yes | Ensures modes are mutually exclusive as intended. |  |
| `test_reasoning_summary_only_streams_to_reasoning_box_in_open_webui_mode` | Summary-only still populates reasoning box events. | Reasoning summary mapping | `Pipe._run_streaming_loop` | monkeypatch stream | Asserts reasoning:delta/completed emitted, status generic | med | yes | Prevents regressions when only summary provided. |  |
| `test_reasoning_summary_part_done_does_not_replay_after_incremental` | Incremental summary emits one delta and avoids replay. | De-duplication of summary events | `Pipe._run_streaming_loop` | monkeypatch stream | Asserts deltas list matches incremental text only | med | yes | Locks in “no duplicate deltas” contract. |  |
| `test_reasoning_done_snapshots_do_not_replay_after_delta` | Reasoning done snapshots don’t duplicate earlier deltas. | De-duplication of reasoning done | `Pipe._run_streaming_loop` | monkeypatch stream | Asserts only initial delta emitted | med | yes | Protects against double-emission regressions. |  |
| `test_function_call_status_invalid_json_arguments_does_not_crash` | Invalid tool arguments don’t crash status rendering. | Robust tool status formatting | `Pipe._run_streaming_loop` | monkeypatch stream | Asserts output still returned and no error completion emitted | med | yes | Ensures bad args fail-soft in UI. |  |
| `test_legacy_tool_execution_invalid_arguments_returns_failed_output` | Legacy tool executor returns failed output on invalid JSON. | Tool exec error handling | `Pipe._execute_function_calls_legacy` | none | Asserts failed output includes “Invalid arguments” | low | yes | Covers backwards compatibility executor path. |  |
| `test_anthropic_interleaved_thinking_header_applied` | Adds Anthropic beta header when valve enabled and preserves existing. | Header mutation | `Pipe._maybe_apply_anthropic_beta_headers` | none | Asserts header added/merged/absent when disabled | low | yes | Prevents drift in header concatenation. |  |
| `test_function_call_loop_limit_emits_warning` | MAX_FUNCTION_CALL_LOOPS emits notification and message. | Tool loop limiter | `Pipe._run_streaming_loop` | monkeypatch stream + execute + ModelFamily.supports | Asserts notification and chat message content | high | yes | Enforces safety against infinite tool loops. |  |

## `tests/openrouter/test_structured_output_adapter.py`

| Test Name | Description | What It Tests | Code Under Test | Mocks/Fixtures | Assertions | Drift Risk | Check Done | Codex Notes | Codex TODO |
|---|---|---|---|---|---|---|---|---|---|
| `test_filter_openrouter_request_translates_response_format_to_text_format` | response_format moved to text.format for Responses API. | Structured output mapping | `_filter_openrouter_request` | none | Asserts response_format removed and text.format created | low | yes | Uses production request filter. |  |
| `test_filter_openrouter_request_prefers_existing_text_format` | Existing text.format wins over response_format. | Precedence rules | `_filter_openrouter_request` | none | Asserts text.format unchanged | low | yes | Prevents accidental override. |  |
| `test_filter_openrouter_request_drops_invalid_text_format` | Invalid text.format dropped. | Validation | `_filter_openrouter_request` | none | Asserts text key removed | low | yes | Ensures only supported formats forwarded. |  |
| `test_responses_payload_to_chat_maps_text_format_to_response_format` | text.format mapped to Chat Completions response_format. | Adapter mapping | `_responses_payload_to_chat_completions_payload` | none | Asserts response_format created | low | yes | Keeps structured outputs working via chat adapter. |  |
| `test_responses_payload_to_chat_prefers_response_format_over_text_format` | response_format wins when both present. | Precedence rules | `_responses_payload_to_chat_completions_payload` | none | Asserts explicit response_format used | low | yes | Avoids schema drift when both keys supplied. |  |

## `tests/test_anthropic_prompt_caching.py`

| Test Name | Description | What It Tests | Code Under Test | Mocks/Fixtures | Assertions | Drift Risk | Check Done | Codex Notes | Codex TODO |
|---|---|---|---|---|---|---|---|---|---|
| `test_anthropic_prompt_caching_inserts_breakpoints` | Anthropic cache_control inserted at breakpoint messages. | Prompt caching injection | `Pipe.transform_messages_to_input` | valves override | Asserts cache_control ephemeral ttl applied to system/user blocks | med | yes | Tests production injection points and TTL propagation. |  |
| `test_non_anthropic_models_do_not_insert_cache_control` | Non-Anthropic models do not get cache_control. | Model gating | `Pipe.transform_messages_to_input`, `Pipe._input_contains_cache_control` | none | Asserts no cache_control markers present | low | yes | Prevents cache-control leaking to other providers. |  |
| `test_strip_cache_control_from_input_removes_markers` | strip removes all cache_control blocks. | Cleanup helper | `Pipe._strip_cache_control_from_input`, `_input_contains_cache_control` | none | Asserts markers removed after strip | low | yes | Ensures retry/fallback paths can remove caching metadata. |  |
| `test_anthropic_prompt_caching_applied_to_existing_input` | Streaming loop applies cache_control to existing Responses input. | Request-body mutation before streaming | `Pipe._run_streaming_loop` | monkeypatch stream capture | Asserts outgoing request input contains cache_control | med | yes | Tests integration with streaming request construction. |  |

## `tests/test_artifact_helpers.py`

| Test Name | Description | What It Tests | Code Under Test | Mocks/Fixtures | Assertions | Drift Risk | Check Done | Codex Notes | Codex TODO |
|---|---|---|---|---|---|---|---|---|---|
| `test_normalize_function_call_serializes_arguments_and_ids` | Function calls normalised with ids and JSON arguments. | Persisted item normalisation | `_normalize_persisted_item` | none | Asserts arguments JSON, status, call_id/id set | low | yes | Uses production normaliser. |  |
| `test_normalize_function_call_output_assigns_defaults` | Outputs get call_id/status and stringified output. | Persisted output normalisation | `_normalize_persisted_item` | none | Asserts output is str and defaults set | low | yes | Ensures storage schema consistent. |  |
| `test_normalize_reasoning_and_file_search_payloads` | Reasoning/file_search/web_search items coerced to expected shapes. | Multitype normalisation | `_normalize_persisted_item` | none | Asserts content/summary/actions coerced | low | yes | Prevents drift in persisted artifact shapes. |  |
| `test_classify_function_call_artifacts_identifies_orphans` | Orphan calls/outputs detected correctly. | Artifact classification | `_classify_function_call_artifacts` | none | Asserts valid and orphan sets | low | yes | Protects replay logic against partial artifacts. |  |
| `test_dedupe_tools_prefers_latest_definition` | Latest tool definitions win during dedupe. | Tool dedupe | `_dedupe_tools` | none | Asserts latest function schema and tool mode kept | low | yes | Matches production “last wins” semantics. |  |

## `tests/test_breaker_recovery.py`

| Test Name | Description | What It Tests | Code Under Test | Mocks/Fixtures | Assertions | Drift Risk | Check Done | Codex Notes | Codex TODO |
|---|---|---|---|---|---|---|---|---|---|
| `TestRequestBreaker.test_request_breaker_trips_after_threshold` | Threshold failures block further requests. | Breaker trip | `Pipe._record_failure`, `Pipe._breaker_allows` | monkeypatch time | Asserts breaker_allows False after threshold | med | yes | Rewritten to call production breaker helpers (no deque poking). |  |
| `TestRequestBreaker.test_request_breaker_resets_on_success` | Reset clears failures and allows again. | Breaker reset | `Pipe._reset_failure_counter`, `Pipe._breaker_allows` | monkeypatch time | Asserts breaker blocks then allows after reset | med | yes | Models “success resets” behaviour via reset helper. |  |
| `TestRequestBreaker.test_breaker_window_sliding` | Old failures outside window are evicted. | Window eviction | `Pipe._breaker_allows` | monkeypatch time across calls | Asserts breaker allows once failures age out | med | yes | Exercises production eviction logic. |  |
| `TestToolBreaker.test_tool_breaker_tracks_failures_by_type` | Tool type breaker blocks only the failing type. | Per-tool-type breaker | `Pipe._record_tool_failure_type`, `Pipe._tool_type_allows` | monkeypatch time | Asserts failing type blocked, other types allowed | med | yes | Avoids drift vs internal dict structure. |  |
| `TestToolBreaker.test_tool_breaker_skips_failing_tool_type` | Blocked tool type emits a status notification. | Breaker notification | `Pipe._notify_tool_breaker` | `_ToolExecutionContext` + emitter | Asserts status event content | med | yes | Tests observable UI status emission. |  |
| `TestDatabaseBreaker.test_db_breaker_tracks_failures` | DB breaker blocks after threshold failures. | DB breaker trip | `Pipe._record_db_failure`, `Pipe._db_breaker_allows` | monkeypatch time | Asserts allows True then False at threshold | med | yes | Uses production helpers (no direct deque assertions). |  |
| `TestDatabaseBreaker.test_db_breaker_suppresses_persistence_on_failure` | DB breaker makes _db_persist skip and emit warning. | DB persist suppression | `Pipe._db_persist` | `_ToolExecutionContext`, SessionLogger.user_id | Asserts [] returned and notification emitted | high | yes | Exercises real suppression path + UI notification. |  |

## `tests/test_concurrency_limits.py`

| Test Name | Description | What It Tests | Code Under Test | Mocks/Fixtures | Assertions | Drift Risk | Check Done | Codex Notes | Codex TODO |
|---|---|---|---|---|---|---|---|---|---|
| `TestRequestQueueLimits.test_request_queue_full_rejects_enqueue` | When queue is full, _enqueue_job returns False. | Queue backpressure | `Pipe._ensure_concurrency_controls` + `Pipe._enqueue_job` | none | Asserts `Queue.full()` then enqueue False | med | yes | No conditional skip: asserts queue is initialized after ensure. |  |
| `TestRequestQueueLimits.test_global_semaphore_limits_parallel_requests` | MAX_CONCURRENT_REQUESTS blocks when all slots are held. | Concurrency limiting | `Pipe._ensure_concurrency_controls` + `Pipe._global_semaphore` | none | Behavior-based blocking (no timing hacks) | med | yes | Resets class semaphore safely to avoid cross-test drift. |  |
| `TestToolSemaphore.test_global_tool_semaphore_limits_parallel_tools` | MAX_PARALLEL_TOOLS_GLOBAL blocks when all slots are held. | Global tool limiting | `Pipe._ensure_concurrency_controls` + `Pipe._tool_global_semaphore` | none | Behavior-based blocking | med | yes | Replaced “slow task” false-positive with real semaphore blocking. |  |
| `TestToolSemaphore.test_per_request_tool_semaphore_is_configured_from_valves` | Per-request tool semaphore uses MAX_PARALLEL_TOOLS_PER_REQUEST. | Tool context wiring | `Pipe._execute_pipe_job` (tool context setup) | monkeypatch `_handle_pipe_call` | Asserts additional acquire blocks | med | yes | Verifies pipe-created semaphore, not a standalone test semaphore. |  |
| `TestSemaphoreRuntimeUpdate.test_semaphore_limit_increase_at_runtime` | Increasing MAX_CONCURRENT_REQUESTS releases permits immediately. | Runtime limit increase support | `Pipe._ensure_concurrency_controls` (increase path) | none | Asserts blocked acquire completes after increase | med | yes | Matches production: increase works, decrease requires restart. |  |

## `tests/test_direct_tool_servers.py`

| Test Name | Description | What It Tests | Code Under Test | Mocks/Fixtures | Assertions | Drift Risk | Check Done | Codex Notes | Codex TODO |
|---|---|---|---|---|---|---|---|---|---|
| `test_direct_tool_servers_are_advertised_and_executable` | Tool servers become callable OWUI tools and emit execute:tool events. | Direct tool server adapter | `Pipe._process_transformed_request` | monkeypatch `_run_nonstreaming_loop` | Asserts tool callable, params filtering, event payload | med | yes | Required a production hardening: `Pipe._stop_request_worker` now skips awaiting tasks bound to other event loops (pytest-asyncio per-test loops). |  |
| `test_direct_tool_servers_skipped_without_event_call` | Without __event_call__, direct tool servers are not wired. | Guard rails for tool servers | `Pipe._process_transformed_request` | monkeypatch `_run_nonstreaming_loop` | Asserts tool wiring skipped | med | yes |  |  |

## `tests/test_encryption_edge_cases.py`

| Test Name | Description | What It Tests | Code Under Test | Mocks/Fixtures | Assertions | Drift Risk | Check Done | Codex Notes | Codex TODO |
|---|---|---|---|---|---|---|---|---|---|
| `test_maybe_compress_payload_respects_min_bytes_threshold` | MIN_COMPRESS_BYTES skips compression for small payloads. | Compression threshold behavior | `Pipe._maybe_compress_payload` | none | Asserts `compressed is False` + bytes unchanged | low | yes | Replaced drifted test that assumed default threshold > 0. |  |
| `test_encode_payload_bytes_sets_plain_flag_when_not_compressed` | Uncompressed payloads use plain flag and decode roundtrips. | Encoding/decoding correctness | `Pipe._encode_payload_bytes/_decode_payload_bytes` | none | Asserts flag + roundtrip | low | yes |  |  |
| `test_encode_payload_bytes_uses_lz4_flag_when_compression_is_effective` | Large repetitive payloads may compress; decode always roundtrips. | LZ4 path coverage | `Pipe._encode_payload_bytes` | none | Asserts roundtrip + flag is plain or lz4 | low | yes | Keeps assertion flexible if compression not beneficial. |  |
| `test_encrypt_payload_requires_encryption_key` | _encrypt_payload raises without a configured key. | Encryption guardrail | `Pipe._encrypt_payload` | none | Asserts `RuntimeError` | low | yes | Matches production contract (no “return original payload”). |  |
| `test_encrypt_decrypt_payload_roundtrip_with_key` | Encrypt/decrypt roundtrip when key is configured. | Payload encryption correctness | `Pipe._encrypt_payload/_decrypt_payload` | none | Asserts dict roundtrip | low | yes | Forces key on the Pipe instance to avoid env coupling. |  |
| `test_encrypt_if_needed_encrypts_reasoning_only_when_encrypt_all_false` | ENCRYPT_ALL False → only reasoning encrypted. | Selective encryption | `Pipe._encrypt_if_needed/_should_encrypt` | none | Asserts tool stays plain; reasoning decrypts | low | yes | Replaces previous “toggle flag” non-test. |  |

## `tests/test_error_template_rendering.py`

| Test Name | Description | What It Tests | Code Under Test | Mocks/Fixtures | Assertions | Drift Risk | Check Done | Codex Notes | Codex TODO |
|---|---|---|---|---|---|---|---|---|---|
| `TestOpenRouterErrorTemplateRendering.test_openrouter_error_template_full_context` | All placeholders filled → complete error message. | Template rendering with model limits enabled | `_build_error_template_values` + `DEFAULT_OPENROUTER_ERROR_TEMPLATE` | none | Asserts model limits only appear when “middle-out” hint present | med | yes | Updated to match production gating for `include_model_limits`. |  |
| `TestOpenRouterErrorTemplateRendering.test_openrouter_error_template_missing_optionals` | Missing optional fields → lines omitted cleanly. | Optional section omission | `_build_error_template_values` + `DEFAULT_OPENROUTER_ERROR_TEMPLATE` | none | Asserts provider/model/request id sections omitted when empty | low | yes | Verifies conditional rendering is clean for minimal errors. |  |
| `TestOpenRouterErrorTemplateRendering.test_network_timeout_template` | Timeout error renders with timeout_seconds placeholder. | Timeout template | `DEFAULT_NETWORK_TIMEOUT_TEMPLATE` + `_render_error_template` | none | Asserts timeout seconds, timestamp, and support email render | low | yes | Tests default timeout template output. |  |
| `TestOpenRouterErrorTemplateRendering.test_rate_limit_template_with_retry_after` | 429 error includes retry_after_seconds from header. | Rate limit template | `DEFAULT_RATE_LIMIT_TEMPLATE` + `_render_error_template` | none | Asserts retry-after and scope render in template | low | yes | Locks in operator-facing retry guidance. |  |
| `TestOpenRouterErrorTemplateRendering.test_authentication_error_template` | 401 error renders authentication guidance. | Auth template | `DEFAULT_AUTHENTICATION_ERROR_TEMPLATE` + `_render_error_template` | none | Asserts key help link and message render | low | yes | Guards user guidance content for auth failures. |  |
| `TestOpenRouterErrorTemplateRendering.test_insufficient_credits_template` | 402 error includes balance and cost info. | Insufficient credits template rendering | `DEFAULT_INSUFFICIENT_CREDITS_TEMPLATE` | none | Asserts ${required_cost}/${account_balance} render | low | yes | Updated expectation to match raw float formatting (`$0.5` not `$0.50`). |  |
| `TestOpenRouterErrorTemplateRendering.test_conditional_blocks_render_correctly` | {{#if}} blocks render only when truthy. | Conditional rendering | `_render_error_template` | none | Asserts truthy/falsy blocks included/excluded | low | yes | Exercises production conditional syntax. |  |
| `TestOpenRouterErrorTemplateRendering.test_custom_template_override` | Custom templates render with provided variables. | Custom template rendering | `_render_error_template` | none | Asserts full rendered line matches expected | low | yes | Ensures overrides remain functional. |  |
| `TestTemplateValueBuilding.test_build_values_with_minimal_error` | Build values from a minimal error. | Placeholder building for minimal errors | `_build_error_template_values` | none | Asserts `reason` matches `str(OpenRouterAPIError)` | med | yes | Updated drifted expectation for `reason`. |  |
| `TestTemplateValueBuilding.test_build_values_with_full_error` | Build values from a fully populated error. | Placeholder building for full errors | `_build_error_template_values` | none | Asserts joined lists + optional gating | med | yes | Updated moderation/diagnostics newline expectations and model-limits gating. |  |

## `tests/test_error_templates.py`

| Test Name | Description | What It Tests | Code Under Test | Mocks/Fixtures | Assertions | Drift Risk | Check Done | Codex Notes | Codex TODO |
|---|---|---|---|---|---|---|---|---|---|
| `TestEmitTemplatedError.test_basic_template_rendering` | Emits templated chat message + completion. | Template emission contract | `Pipe._emit_templated_error` | `mock_pipe`, `_Emitter` | Asserts two events and rendered content includes variables | med | yes | Calls production emitter; asserts observable event payloads. |  |
| `TestEmitTemplatedError.test_error_id_generation` | Generated error_id appears in output. | Error id injection | `Pipe._emit_templated_error` | `mock_pipe`, `_Emitter` | Asserts 16-char id included in rendered content | low | yes | Guards operator support workflow (error_id reference). |  |
| `TestEmitTemplatedError.test_conditional_rendering` | {{#if}} conditionals include/omit lines. | Template conditional support | `Pipe._emit_templated_error` | `mock_pipe`, `_Emitter` | Asserts conditional line present and missing section absent | med | yes | Prevents drift in template syntax handling. |  |
| `TestEmitTemplatedError.test_support_email_injection` | SUPPORT_EMAIL injected when referenced. | Support info injection | `Pipe._emit_templated_error` | `mock_pipe` valves | Asserts support email appears | low | yes | Protects operator custom templates. |  |
| `TestEmitTemplatedError.test_timestamp_injection` | Timestamp injected in ISO form. | Timestamp injection | `Pipe._emit_templated_error` | `mock_pipe`, `_Emitter` | Asserts timestamp token included with Z | low | yes | Ensures templates can include timestamp. |  |
| `TestNetworkTimeoutError.test_timeout_exception_caught` | TimeoutException yields templated error output. | Timeout handling | `Pipe._handle_pipe_call` | patch registry + `_process_transformed_request` raising Timeout | Asserts empty return and error template emitted | high | yes | Exercises production error mapping for timeouts via _handle_pipe_call. |  |
| `TestConnectionError.test_connect_error_caught` | ConnectError yields templated error output. | Connection error handling | `Pipe._handle_pipe_call` | patch registry + `_process_transformed_request` raising ConnectError | Asserts error content includes connection hint + error id | high | yes | Validates user-facing messaging on connection failures. |  |
| `TestServiceError.test_500_error_caught` | HTTPStatusError 5xx yields service-error template. | 5xx handling | `Pipe._handle_pipe_call` | patch registry + `_process_transformed_request` raising HTTPStatusError | Asserts service error content and error id | high | yes | Exercises production mapping for upstream 5xx failures. |  |
| `TestInternalError.test_generic_exception_caught` | Generic exceptions yield internal error template. | Catch-all handling | `Pipe._handle_pipe_call` | patch registry + `_process_transformed_request` raising ValueError | Asserts error type included and templated response | high | yes | Ensures unexpected errors are caught and surfaced safely. |  |
| `TestTemplateCustomization.test_custom_template_used` | Custom template valve overrides default. | Template override | `Pipe._handle_pipe_call` | set `INTERNAL_ERROR_TEMPLATE` + patch process raise | Asserts custom content rendered | med | yes | Verifies operator customisation path. |  |

## `tests/test_helper_utilities.py`

| Test Name | Description | What It Tests | Code Under Test | Mocks/Fixtures | Assertions | Drift Risk | Check Done | Codex Notes | Codex TODO |
|---|---|---|---|---|---|---|---|---|---|
| `test_render_error_template_hides_missing_sections` | Conditional blocks omitted when values empty. | Template conditional rendering | `_render_error_template` | none | Asserts optional section omitted | low | yes | Uses production template helper. |  |
| `test_render_error_template_uses_default_template` | Empty template falls back to default. | Default template fallback | `_render_error_template` | none | Asserts default header/error id included | low | yes | Protects operator template behaviour. |  |
| `test_build_error_template_values_reports_model_limits` | Model limits appear when metrics provided. | Error template values | `_build_error_template_values` | none | Asserts include_model_limits and formatted tokens | low | yes | Exercises production value builder. |  |
| `test_template_utils_cover_edge_cases` | Truthiness + pretty JSON edge cases. | Helper robustness | `_template_value_present`, `_pretty_json` | none | Asserts truthiness and non-serialisable handling | low | yes | Avoids drift in template rendering inputs. |  |
| `test_encrypted_str_roundtrip` | EncryptedStr encrypt/decrypt roundtrip. | Encryption wrapper | `EncryptedStr.encrypt`, `EncryptedStr.decrypt` | env var `WEBUI_SECRET_KEY` | Asserts prefix and decrypt equals original | med | yes | Exercises real crypto path with test key. |  |
| `test_strictify_schema_enforces_required_and_nullability` | strictify_schema adds required fields and nullability. | Schema strictification | `_strictify_schema` | none | Asserts required set and nullability added | low | yes | Prevents drift in tool schema enforcement. |  |
| `test_build_tools_combines_registry_and_extras` | Registry + extra tools merged and deduped. | Tool assembly | `build_tools` | monkeypatch `ModelFamily.supports` | Asserts both tools present and alpha deduped | med | yes | Uses production build_tools with strict calling valve. |  |
| `test_tool_output_clamps_failed_status` | Tool output status clamped to completed. | Tool output normalisation | `Pipe._build_tool_output` | none | Asserts status \"completed\" even when failed requested | low | yes | Locks in OpenAI-compatible status values. |  |
| `test_select_openrouter_http_referer_defaults_without_override` | Default referer used without override. | Referer selection | `_select_openrouter_http_referer` | none | Asserts default constant returned | low | yes | Guards default header behaviour. |  |
| `test_select_openrouter_http_referer_accepts_full_url_override` | Full URL override honoured. | Referer override | `_select_openrouter_http_referer` | `Pipe.Valves` | Asserts override returned | low | yes | Ensures operator override works. |  |
| `test_select_openrouter_http_referer_rejects_non_url_override` | Non-URL override rejected. | Override validation | `_select_openrouter_http_referer` | `Pipe.Valves` | Asserts fallback to default | low | yes | Prevents unsafe/invalid referer overrides. |  |
| `test_normalize_persisted_items_and_classifier` | Normalises persisted items and classifies orphans. | Artifact normalisation/classification | `_normalize_persisted_item`, `_classify_function_call_artifacts` | none | Asserts call_id/arguments JSON and orphan sets | med | yes | Exercises production persistence normalisers. |  |
| `test_marker_helpers_and_ulids` | Marker detection and ULID uniqueness. | Marker utilities | `generate_item_id`, `contains_marker`, `split_text_by_markers` | none | Asserts marker split and generated ids unique | low | yes | Guards marker parsing used for artifact replay. |  |

## `tests/test_middleware_stream_queue.py`

| Test Name | Description | What It Tests | Code Under Test | Mocks/Fixtures | Assertions | Drift Risk | Check Done | Codex Notes | Codex TODO |
|---|---|---|---|---|---|---|---|---|---|
| `test_middleware_stream_queue_valves_defaults` | Middleware stream queue defaults are safe. | Default valves | `Pipe.Valves` | none | Asserts unbounded queue default and timeout default | low | yes | Guards default streaming backpressure config. |  |
| `test_try_put_middleware_stream_nowait_does_not_raise_when_full` | try_put is fail-soft when queue is full. | Non-raising enqueue | `Pipe._try_put_middleware_stream_nowait` | asyncio.Queue | Asserts queue size unchanged and no exception | low | yes | Prevents streaming paths from crashing on full queues. |  |
| `test_put_middleware_stream_item_times_out_when_full` | put times out when queue is full and timeout small. | Backpressure timeout | `Pipe._put_middleware_stream_item` | fake job + asyncio.Queue | Asserts asyncio.TimeoutError | med | yes | Tests real timeout behaviour on bounded queues. |  |

## `tests/test_model_fallback.py`

| Test Name | Description | What It Tests | Code Under Test | Mocks/Fixtures | Assertions | Drift Risk | Check Done | Codex Notes | Codex TODO |
|---|---|---|---|---|---|---|---|---|---|
| `test_model_fallback_csv_to_models_array` | Parses model_fallback CSV into payload models list. | CSV parsing, trimming, dedupe, and field cleanup | `_apply_model_fallback_to_payload` | none | Asserts normalized models list and model_fallback removed | low | yes | Reviewed: calls production helper and asserts externally observable payload mutation. |  |
| `test_model_fallback_merges_with_existing_models_list` | Appends fallback models to existing payload models list. | Merge semantics with existing models list | `_apply_model_fallback_to_payload` | none | Asserts ordering preserved and new models appended without duplicates | low | yes | Reviewed: exercises production merge behavior directly. |  |

## `tests/test_model_metadata_sync.py`

| Test Name | Description | What It Tests | Code Under Test | Mocks/Fixtures | Assertions | Drift Risk | Check Done | Codex Notes | Codex TODO |
|---|---|---|---|---|---|---|---|---|---|
| `test_build_icon_mapping_success` | Builds model→icon mapping and normalises relative URLs. | Icon mapping extraction | `Pipe._build_icon_mapping` | none | Asserts absolute URL mapping and missing icons skipped | low | yes | Uses production mapping logic; covers relative URL prefixing. |  |
| `test_build_icon_mapping_empty` | Empty/None frontend data yields {}. | Null-handling | `Pipe._build_icon_mapping` | none | Asserts {} for None/empty inputs | low | yes | Guards against KeyError drift on missing fields. |  |
| `test_extract_openrouter_og_image` | Extracts og:image from HTML. | OG image parsing | `Pipe._extract_openrouter_og_image` | none | Asserts correct URL extracted | low | yes | Locks in HTML parsing contract for maker pages. |  |
| `test_guess_image_mime_type_svg_and_png` | Guess mime from URL/content-type/magic bytes. | Mime inference | `Pipe._guess_image_mime_type` | none | Asserts svg+xml and png detection | low | yes | Prevents wrong data URL prefixes. |  |
| `test_build_icon_mapping_uses_first_provider_icon` | Duplicate slugs keep first icon. | Duplicate handling | `Pipe._build_icon_mapping` | none | Asserts first icon wins | low | yes | Guards stable icon choice in merged feeds. |  |
| `test_build_web_search_support_mapping_detects_multiple_signals` | Detects web_search support via features/params/pricing. | Web search capability mapping | `Pipe._build_web_search_support_mapping` | none | Asserts mapping includes models with any signal | low | yes | Matches production “any signal => True” semantics. |  |
| `test_build_web_search_support_mapping_unions_duplicates` | Duplicate entries union to True if any supports. | Duplicate union | `Pipe._build_web_search_support_mapping` | none | Asserts duplicate slug yields True when later entry supports | low | yes | Prevents false negatives from partial feeds. |  |
| `test_sync_model_metadata_prefixes_pipe_id_and_prefers_icon_mapping` | Sync prefixes pipe id and uses icon mapping when available. | Metadata sync (icons + ids) | `Pipe._sync_model_metadata_to_owui` | AsyncMock fetch catalog + fetch image, patch run_in_threadpool | Asserts update called with prefixed id and data URL | high | yes | Exercises end-to-end sync flow without real network/DB. |  |
| `test_sync_model_metadata_sets_web_search_from_frontend` | Frontend web_search signal overrides stored capabilities. | Metadata sync (capabilities) | `Pipe._sync_model_metadata_to_owui` | AsyncMock fetch catalog, patch run_in_threadpool | Asserts web_search updated and flags returned | high | yes | Ensures capabilities stay aligned with OpenRouter frontend. |  |
| `test_sync_model_metadata_falls_back_to_maker_image_mapping` | Falls back to maker profile image mapping when icon missing. | Metadata sync (fallback icons) | `Pipe._sync_model_metadata_to_owui` | AsyncMock maker mapping + fetch image, patch run_in_threadpool | Asserts data URL set and capabilities unchanged | high | yes | Covers fallback branch to avoid missing model icons. |  |

## `tests/test_module_helpers.py`

| Test Name | Description | What It Tests | Code Under Test | Mocks/Fixtures | Assertions | Drift Risk | Check Done | Codex Notes | Codex TODO |
|---|---|---|---|---|---|---|---|---|---|
| `test_detect_runtime_pipe_id_from_module_prefix` | Derives runtime pipe id from module prefix. | Pipe id derivation | `ow._detect_runtime_pipe_id` | monkeypatch module `__name__` | Asserts derived id string | low | yes | Calls production helper; no reimplementation. |  |
| `test_detect_runtime_pipe_id_default` | Falls back to default id for canonical module name. | Pipe id fallback | `ow._detect_runtime_pipe_id` | monkeypatch module `__name__` | Asserts fallback returned | low | yes | Guards stable pipe identifiers. |  |
| `test_render_error_template_handles_conditionals` | Conditionals render only when values present. | Template conditional semantics | `ow._render_error_template` | none | Asserts conditional block included/omitted | low | yes | Tests real templater helper. |  |
| `test_pretty_json_and_template_value_present` | Pretty JSON and template truthiness helpers. | JSON formatting + value presence | `ow._pretty_json`, `ow._template_value_present` | none | Asserts whitespace trimming and truthiness | low | yes | Prevents drift in operator-facing templates. |  |
| `test_build_error_template_values_includes_context` | Error template values include diagnostics/metrics/context. | Error rendering inputs | `ow._build_error_template_values` | helper `_make_error` | Asserts retry_after + diagnostics included | low | yes | Exercises production value builder (no dict copy). |  |
| `test_get_open_webui_config_module` | Returns configured Open WebUI config module override. | Config module indirection | `ow._get_open_webui_config_module` | monkeypatch `_OPEN_WEBUI_CONFIG_MODULE` | Asserts sentinel returned | low | yes | Guards wiring for config access. |  |
| `test_unwrap_and_coerce_helpers` | Unwraps config values and coerces types. | Config normalisation | `ow._unwrap_config_value`, `_coerce_positive_int`, `_coerce_bool` | none | Asserts conversion rules | low | yes | Matches production parsing semantics. |  |
| `test_retry_after_seconds_parses_date` | Parses HTTP-date Retry-After headers. | Retry-After parsing | `ow._retry_after_seconds` | none | Asserts numeric delay and None on invalid | low | yes | Ensures stable retry parsing. |  |
| `test_classify_retryable_http_error` | 5xx classified as retryable. | HTTP error classification | `ow._classify_retryable_http_error` | httpx error | Asserts retryable True | low | yes | Uses real httpx exception shape. |  |
| `test_read_rag_file_constraints` | Reads RAG enablement and size constraints. | RAG constraint lookup | `ow._read_rag_file_constraints` | monkeypatch config module getter | Asserts rag_enabled + limit values | med | yes | Ensures behaviour matches Open WebUI config shapes. |  |
| `test_sanitize_model_id` | Sanitises model ids for storage/metrics. | Model id normalisation | `ow.sanitize_model_id` | none | Asserts slash→dot conversion | low | yes | Guards stable metric keys. |  |
| `test_debug_print_request_redacts` | Debug request logging redacts auth headers. | Secret redaction | `ow._debug_print_request` | monkeypatch `ow.LOGGER` | Asserts truncated auth in logs | med | yes | Ensures no secret leakage in debug logs. |  |
| `test_debug_print_error_response` | Logs and returns error response body. | Error response debugging | `ow._debug_print_error_response` | monkeypatch `ow.LOGGER`, fake response | Asserts body returned and log message | med | yes | Uses production helper with aiohttp-like response. |  |
| `test_safe_json_and_normalizers` | Safe JSON loads and string/list normalisers. | Parsing/normalisation helpers | `ow._safe_json_loads`, `_normalize_optional_str`, `_normalize_string_list` | none | Asserts conversions and None on invalid JSON | low | yes | Prevents drift in payload cleaning. |  |
| `test_extract_openrouter_error_details_and_builder` | Extracts OpenRouter error metadata and builds OpenRouterAPIError. | Error extraction/build | `ow._extract_openrouter_error_details`, `_build_openrouter_api_error` | none | Asserts provider_raw parsed and error built | med | yes | Exercises production parsing of nested JSON strings. |  |
| `test_resolve_and_format_openrouter_error_markdown` | Resolves model context and formats markdown. | User-facing error formatting | `ow._resolve_error_model_context`, `_format_openrouter_error_markdown` | set/reset `ModelFamily` specs | Asserts metrics and template rendering | med | yes | Uses production model registry integration. |  |
| `test_filter_openrouter_request_drops_invalid_keys` | Filters payload to allowed keys and trims reasoning. | Request filtering | `ow._filter_openrouter_request` | none | Asserts unknown keys dropped, reasoning pruned | low | yes | Prevents drift sending unsupported params upstream. |  |
| `test_internal_file_helpers` | Detects/extracts internal file ids and URLs. | Internal URL utilities | `ow._extract_internal_file_id`, `_is_internal_file_url` | none | Asserts id extraction + detection | low | yes | Locks in internal URL contract. |  |
| `test_wrap_event_emitter_controls_events` | Emitter wrapper suppresses chat messages when configured. | Event filtering | `ow._wrap_event_emitter` | none | Asserts only non-chat event forwarded | low | yes | Tests observable event emission behaviour. |  |
| `test_merge_usage_stats_and_wrap_code_block` | Merges usage stats and wraps code blocks. | Utility formatting/merge | `ow.merge_usage_stats`, `ow.wrap_code_block` | none | Asserts nested merge and code fence prefix | low | yes | Prevents drift in usage aggregation. |  |
| `test_normalize_persisted_item_variants` | Normalises persisted item variants. | Persisted item normalisation | `ow._normalize_persisted_item` | none | Asserts coercions for outputs and reasoning | low | yes | Ensures storage schema stays consistent. |  |
| `test_classify_function_call_artifacts` | Groups function_call + output by call_id. | Artifact classification | `ow._classify_function_call_artifacts` | none | Asserts valid grouping and no orphans | low | yes | Matches production marker replay semantics. |  |
| `test_crockford_and_markers` | Generates ULIDs and handles marker parsing/splitting. | Marker/ULID helpers | `ow.generate_item_id`, `_serialize_marker`, `_extract_marker_ulid`, `contains_marker`, `split_text_by_markers` | none | Asserts marker roundtrip and segmentation | low | yes | Prevents drift in artifact markers. |  |
| `test_sanitize_table_fragment` | Sanitises table fragment for safe keys. | Key sanitisation | `ow._sanitize_table_fragment` | none | Asserts lowercase/underscore output | low | yes | Guards stable storage keys. |  |
| `test_build_tools_and_dedupe` | Builds tool list and dedupes by name. | Tool assembly | `ow.build_tools`, `ow._dedupe_tools` | monkeypatch `ModelFamily.supports` | Asserts one tool after merge | med | yes | Exercises production tool-building path. |  |
| `test_strictify_schema_helpers` | Strictifies schema and dedupes tools. | Schema strictification + tool dedupe | `ow._strictify_schema`, `ow._dedupe_tools` | none | Asserts required/nullability + dedupe result | low | yes | Prevents drift in tool schema enforcement. |  |
| `test_decode_payload_bytes_rejects_headerless_ciphertext` | Rejects legacy payload bytes missing encryption flag. | Artifact decode guard | `Pipe._decode_payload_bytes` | none | Asserts ValueError raised | med | yes | Protects against accepting ambiguous ciphertext/plaintext. |  |
| `test_prepare_rows_for_storage_encrypts_payloads` | Storage rows are encrypted and decryptable. | Artifact encryption path | `Pipe._prepare_rows_for_storage`, `Pipe._decrypt_payload` | helper `_build_encryption_ready_pipe` | Asserts enc flags/version and roundtrip content | med | yes | Uses production crypto helpers (no fake cipher). |  |
| `test_prepare_rows_for_storage_idempotent` | Encrypting already-encrypted rows is idempotent. | Idempotency | `Pipe._prepare_rows_for_storage` | helper `_build_encryption_ready_pipe` | Asserts payload unchanged on second run | med | yes | Prevents double-encryption regressions. |  |
| `test_redis_fetch_rows_decrypts_cached_payloads` | Redis fetch decrypts cached encrypted rows. | Redis cache decrypt flow | `Pipe._redis_fetch_rows` | FakeRedis mget | Asserts fetched payload decrypted | med | yes | Tests observable output from cache layer. |  |
| `test_flush_redis_queue_warns_when_lock_release_returns_zero` | Warns when Redis lock release fails. | Redis flush safety logging | `Pipe._flush_redis_queue` | FakeRedis eval returns 0 + caplog | Asserts warning logged | med | yes | Ensures operator-visible warning on lock mismatch. |  |

## `tests/test_multimodal_inputs.py`

| Test Name | Description | What It Tests | Code Under Test | Mocks/Fixtures | Assertions | Drift Risk | Check Done | Codex Notes | Codex TODO |
|---|---|---|---|---|---|---|---|---|---|
| `TestDataURLParsing.test_parse_valid_image_data_url` | Parses a valid image data URL. | Data URL parse contract | `Pipe._parse_data_url` | `pipe_instance` | Asserts mime/b64/bytes extracted | low | yes | Directly exercises production parser (no reimplementation). |  |
| `TestDataURLParsing.test_parse_normalizes_image_jpg_to_jpeg` | Normalises image/jpg to image/jpeg. | MIME normalisation | `Pipe._parse_data_url` | `pipe_instance` | Asserts mime type normalised | low | yes | Matches production normalisation logic. |  |
| `TestDataURLParsing.test_parse_audio_data_url` | Parses an audio data URL. | Audio data URL parsing | `Pipe._parse_data_url` | `pipe_instance` | Asserts mime/b64 preserved | low | yes | Uses production parser. |  |
| `TestDataURLParsing.test_parse_invalid_data_url_returns_none` | Rejects invalid/missing data URLs. | Invalid input handling | `Pipe._parse_data_url` | `pipe_instance` | Asserts None for invalid/empty values | low | yes | Fails closed like production. |  |
| `TestDataURLParsing.test_parse_invalid_base64_returns_none` | Rejects malformed base64. | Base64 validation | `Pipe._parse_data_url` | `pipe_instance` | Asserts None for invalid base64 | low | yes | Prevents silent garbage decode drift. |  |
| `TestImageTransformations.test_remote_images_rehosted_and_inlined` | Remote images are rehosted then inlined for providers. | End-to-end image_url block rewrite | `Pipe.transform_messages_to_input` | AsyncMock download/upload/inline | Asserts output is input_image + inline data URL and calls | med | yes | Calls production transform; mocks only external IO. |  |
| `TestFileEncoding.test_encode_file_path_base64_matches_standard_encoder` | Chunked file base64 encoding matches stdlib. | Chunked base64 correctness | `Pipe._encode_file_path_base64` | `tmp_path` | Asserts exact base64 output | low | yes | Prevents drift in chunking/edge-byte handling. |  |
| `TestRemoteURLDownloading.test_download_successful` | Downloads content and returns bytes + mime. | HTTP download happy-path | `Pipe._download_remote_url` | patch `httpx.AsyncClient`, stub `_is_safe_url` | Asserts data/mime/url returned | med | yes | Avoids DNS flake by stubbing SSRF guard. |  |
| `TestRemoteURLDownloading.test_download_normalizes_mime_type` | Normalises response Content-Type. | MIME normalisation on download | `Pipe._download_remote_url` | patch `httpx.AsyncClient`, stub `_is_safe_url` | Asserts image/jpg → image/jpeg | med | yes | Ensures prod header parsing is used. |  |
| `TestRemoteURLDownloading.test_download_rejects_files_over_default_limit` | Rejects oversized downloads using Content-Length. | Size limiting (header path) | `Pipe._download_remote_url` | patch `httpx.AsyncClient`, stub `_is_safe_url` | Asserts None when Content-Length exceeds limit | med | yes | Avoids huge allocations while exercising prod limit logic. |  |
| `TestRemoteURLDownloading.test_download_invalid_url_returns_none` | Non-http(s) URLs are rejected. | Scheme validation | `Pipe._download_remote_url` | none | Asserts None for file/ftp/empty | low | yes | Matches production early-return semantics. |  |
| `TestRemoteURLDownloading.test_download_network_error_returns_none` | Retries on network error then returns None. | Retry + exhaustion behaviour | `Pipe._download_remote_url` | patch `httpx.AsyncClient`, stub `_is_safe_url` | Asserts None and stream called twice (1 retry) | med | yes | Sets retry delays to 0 to keep test fast + real. |  |
| `TestRemoteURLDownloading.test_download_does_not_retry_on_client_errors` | 4xx (non-429) does not retry. | Non-retryable error classification | `Pipe._download_remote_url` | patch `httpx.AsyncClient`, stub `_is_safe_url` | Asserts None and single attempt | med | yes | Guards against accidental retry broadening. |  |
| `TestRemoteURLDownloading.test_download_blocks_unsafe_url` | SSRF guard aborts before HTTP. | SSRF enforcement for downloads | `Pipe._download_remote_url` | stub `_is_safe_url`, patch `httpx.AsyncClient` | Asserts None and no client constructed | low | yes | Ensures safety check runs before network IO. |  |
| `TestRemoteURLDownloading.test_download_retries_on_429_then_succeeds` | 429 triggers one retry then succeeds. | Retry-on-429 and Retry-After handling | `Pipe._download_remote_url` | patch `httpx.AsyncClient`, stub `_is_safe_url` | Asserts two attempts and successful payload | med | yes | Exercises production tenacity loop (no stubs). |  |
| `TestSSRFIPv6Validation.test_blocks_private_ipv6_literal` | Blocks IPv6 ULA literals. | IPv6 SSRF guard | `Pipe._is_safe_url` | none | Asserts False for fd00::/8 | low | yes | Covers literal parsing path. |  |
| `TestSSRFIPv6Validation.test_allows_global_ipv6_literal` | Allows global IPv6 literals. | IPv6 allowlist semantics | `Pipe._is_safe_url` | none | Asserts True for public IPv6 | low | yes | Confirms guard doesn’t over-block. |  |
| `TestSSRFIPv6Validation.test_blocks_domain_with_private_ipv6_record` | Blocks hosts resolving to any private IPv6. | DNS-mixed response handling | `Pipe._is_safe_url` | monkeypatch `socket.getaddrinfo` | Asserts False when any record is private | med | yes | Matches production “any private = block” rule. |  |
| `TestSSRFIPv6Validation.test_allows_domain_with_public_ips_only` | Allows hosts resolving only to public IPs. | DNS allow semantics | `Pipe._is_safe_url` | monkeypatch `socket.getaddrinfo` | Asserts True with only public records | med | yes | Guards against false positives. |  |
| `TestRemoteFileLimitResolution.test_uses_valve_when_rag_disabled` | Uses valve limit when RAG is bypassed. | Effective limit resolution | `Pipe._get_effective_remote_file_limit_mb` | monkeypatch config module | Asserts valve value returned | med | yes | Avoids test-only reimplementation; hits prod helper. |  |
| `TestRemoteFileLimitResolution.test_caps_to_rag_when_smaller` | Caps remote download to smaller RAG limit. | RAG cap enforcement | `Pipe._get_effective_remote_file_limit_mb` | monkeypatch config module | Asserts RAG size wins when smaller | med | yes | Protects against drift in FILE_MAX_SIZE alignment. |  |
| `TestRemoteFileLimitResolution.test_adopts_rag_when_default_and_larger` | Adopts larger RAG cap when valve is default. | Default upgrade behaviour | `Pipe._get_effective_remote_file_limit_mb` | monkeypatch config module | Asserts default valve upgrades to RAG limit | med | yes | Locks in “default follows RAG” behaviour. |  |
| `TestRemoteFileLimitResolution.test_respects_custom_limit_when_lower_than_rag` | Keeps custom valve below RAG cap. | Custom override behaviour | `Pipe._get_effective_remote_file_limit_mb` | monkeypatch config module | Asserts custom limit preserved | med | yes | Ensures operator intent not overwritten. |  |
| `TestRemoteFileLimitResolution.test_falls_back_to_file_max_size_when_rag_missing` | Falls back to FILE_MAX_SIZE when RAG cap unset. | Fallback config path | `Pipe._get_effective_remote_file_limit_mb` | monkeypatch config module | Asserts FILE_MAX_SIZE used | med | yes | Matches production fallback semantics. |  |
| `TestRetryHelpers.test_retry_after_seconds_parses_numeric` | Parses numeric Retry-After. | Retry-After parsing | `pipe_module._retry_after_seconds` | none | Asserts seconds parsed | low | yes | Protects date/number parsing contract. |  |
| `TestRetryHelpers.test_retry_after_seconds_parses_http_date` | Parses HTTP-date Retry-After. | HTTP-date parsing | `pipe_module._retry_after_seconds` | none | Asserts delay is near expected | low | yes | Uses real time-based parse path. |  |
| `TestRetryHelpers.test_retry_wait_honors_retry_after` | Uses retry_after override in wait strategy. | Wait strategy override | `pipe_module._RetryWait` | SimpleNamespace outcome | Asserts wait == retry_after | low | yes | Ensures prod retry logic respects server hints. |  |
| `TestRetryHelpers.test_classify_retryable_http_error_identifies_425` | 425 is retryable with Retry-After. | Retry classification | `pipe_module._classify_retryable_http_error` | httpx error | Asserts retryable + parsed retry_after | low | yes | Guards against accidental status list drift. |  |
| `TestRetryHelpers.test_classify_retryable_http_error_rejects_403` | 403 is not retryable. | Non-retryable classification | `pipe_module._classify_retryable_http_error` | httpx error | Asserts not retryable | low | yes | Matches production “4xx non-429 no retry”. |  |
| `TestStorageContext.test_resolve_storage_context_prefers_existing_user` | Uses provided request/user. | Storage context resolution | `Pipe._resolve_storage_context` | `mock_request`, `mock_user` | Asserts same objects returned | low | yes | Pure production helper call. |  |
| `TestStorageContext.test_resolve_storage_context_uses_fallback_user` | Creates fallback storage user when missing. | Fallback user creation | `Pipe._resolve_storage_context` | AsyncMock `_ensure_storage_user` | Asserts fallback returned and helper awaited | low | yes | Verifies observable calls, not internals. |  |
| `TestStorageContext.test_resolve_storage_context_without_request` | No request => returns (None, None). | No-request behaviour | `Pipe._resolve_storage_context` | none | Asserts both None and no helper call | low | yes | Avoids drift in null-handling. |  |
| `TestImageTransformer.test_image_data_url_saved_to_storage` | Base64 image saved and status emitted. | Image data-url rehosting | `Pipe.transform_messages_to_input` | monkeypatch upload/status | Asserts stored URL + status message | med | yes | IO mocked; transformation is production. |  |
| `TestImageTransformer.test_image_remote_url_downloaded_and_saved` | Remote image downloaded and stored. | Remote image pipeline | `Pipe.transform_messages_to_input` | monkeypatch download/upload/status | Asserts stored URL + status emitted | med | yes | Exercises end-to-end branch selection. |  |
| `TestImageTransformer.test_image_detail_level_preserved` | Detail survives image transformation. | Detail propagation | `Pipe.transform_messages_to_input` | none | Asserts detail unchanged | low | yes | Prevents silent detail dropping regressions. |  |
| `TestImageTransformer.test_internal_file_url_inlined_to_data_url` | Internal file URL becomes data URL. | Inline internal file fetch | `Pipe.transform_messages_to_input` | monkeypatch `_get_file_by_id` | Asserts data: URL produced | med | yes | Confirms provider-facing contract for internal files. |  |
| `TestImageTransformer.test_image_error_returns_empty_block` | Image errors do not crash; returns fallback. | Exception containment | `Pipe.transform_messages_to_input` | monkeypatch upload to raise | Asserts fallback data URL + auto detail | med | yes | Locks in “fail soft” behaviour. |  |
| `TestFileTransformer.test_file_remote_url_downloaded_and_saved` | Remote file saved to OWUI storage. | File rehosting pipeline | `Pipe.transform_messages_to_input` | monkeypatch download/upload/status | Asserts stored file_url + status emitted | med | yes | IO mocked; uses production transform. |  |
| `TestFileTransformer.test_file_remote_url_passthrough_when_disabled` | Remote file_url passes through when valve off. | Valve gating | `Pipe.transform_messages_to_input` | valve + mocked IO | Asserts original URL preserved and no IO called | low | yes | Ensures operator valve works. |  |
| `TestFileTransformer.test_file_remote_url_warns_when_download_returns_none` | Download failure yields notification and passthrough. | Failure handling | `Pipe.transform_messages_to_input` | monkeypatch download/notify | Asserts file_url preserved, notify called | med | yes | Ensures user gets feedback without crash. |  |
| `TestFileTransformer.test_file_data_remote_url_moves_to_file_url_when_download_returns_none` | file_data remote URL moved to file_url on failure. | Shape normalisation | `Pipe.transform_messages_to_input` | monkeypatch download/notify | Asserts file_url set and file_data removed | med | yes | Prevents leaking wrong schema to provider. |  |
| `TestAudioTransformer.test_audio_already_correct_format_passthrough` | Responses-style audio passes through. | Audio validation/passthrough | `Pipe.transform_messages_to_input` | none | Asserts data/format unchanged | low | yes | Uses production transform branch. |  |
| `TestAudioTransformer.test_audio_chat_completions_format_converted` | Chat-style audio converted to Responses shape. | Audio schema conversion | `Pipe.transform_messages_to_input` | none | Asserts output type and format mapping | low | yes | Protects against schema drift. |  |
| `TestAudioTransformer.test_audio_tool_output_format_converted` | Tool-output audio converted using mimeType. | Tool audio conversion | `Pipe.transform_messages_to_input` | none | Asserts format derived and data preserved | low | yes | Matches OWUI tool output semantics. |  |
| `TestAudioTransformer.test_audio_mime_type_to_format_mapping[audio/mpeg-mp3]` | MIME audio/mpeg maps to mp3. | MIME→format mapping | `Pipe.transform_messages_to_input` | paramised case | Asserts mp3 selected | low | yes | Paramised to match actual pytest collection. |  |
| `TestAudioTransformer.test_audio_mime_type_to_format_mapping[audio/mp3-mp3]` | MIME audio/mp3 maps to mp3. | MIME→format mapping | `Pipe.transform_messages_to_input` | paramised case | Asserts mp3 selected | low | yes | Paramised to match actual pytest collection. |  |
| `TestAudioTransformer.test_audio_mime_type_to_format_mapping[audio/wav-wav]` | MIME audio/wav maps to wav. | MIME→format mapping | `Pipe.transform_messages_to_input` | paramised case | Asserts wav selected | low | yes | Paramised to match actual pytest collection. |  |
| `TestAudioTransformer.test_audio_mime_type_to_format_mapping[audio/wave-wav]` | MIME audio/wave maps to wav. | MIME→format mapping | `Pipe.transform_messages_to_input` | paramised case | Asserts wav selected | low | yes | Paramised to match actual pytest collection. |  |
| `TestAudioTransformer.test_audio_mime_type_to_format_mapping[audio/x-wav-wav]` | MIME audio/x-wav maps to wav. | MIME→format mapping | `Pipe.transform_messages_to_input` | paramised case | Asserts wav selected | low | yes | Paramised to match actual pytest collection. |  |
| `TestAudioTransformer.test_audio_mime_type_to_format_mapping[audio/unknown-mp3]` | Unknown MIME defaults to mp3. | Default mapping | `Pipe.transform_messages_to_input` | paramised case | Asserts mp3 default | low | yes | Protects default fallback. |  |
| `TestAudioTransformer.test_audio_mime_type_to_format_mapping[None-mp3]` | Missing MIME defaults to mp3. | Default mapping | `Pipe.transform_messages_to_input` | paramised case | Asserts mp3 default | low | yes | Protects null-handling fallback. |  |
| `TestAudioTransformer.test_audio_invalid_payload_returns_empty_block` | Invalid audio payload yields empty data + default format. | Invalid payload handling | `Pipe.transform_messages_to_input` | none | Asserts empty data and mp3 | low | yes | Prevents exceptions leaking. |  |
| `TestAudioTransformer.test_audio_error_returns_minimal_block` | Exceptions in audio parsing are swallowed. | Exception containment | `Pipe.transform_messages_to_input` | monkeypatch `_parse_data_url` to raise | Asserts minimal empty audio block | med | yes | Ensures robust stream processing. |  |
| `TestAudioTransformer.test_audio_data_url_supported` | Audio data URLs are accepted. | Data URL audio path | `Pipe.transform_messages_to_input` | none | Asserts base64 preserved + mp3 | low | yes | Matches OpenRouter audio requirements. |  |
| `TestAudioTransformer.test_audio_rejects_remote_urls` | Remote audio URLs are rejected. | Compliance enforcement | `Pipe.transform_messages_to_input` | none | Asserts empty audio payload | low | yes | Prevents SSRF-ish audio fetch. |  |
| `TestAudioTransformer.test_audio_partial_dict_without_format` | Derives format when dict missing format. | Format derivation | `Pipe.transform_messages_to_input` | none | Asserts wav derived from mime_type | low | yes | Avoids schema drift for tool outputs. |  |
| `TestConversationRebuild.test_transform_messages_prunes_artifacts_and_reuses_images` | Replays artifacts, prunes long tool output, and preserves images. | Conversation rebuild semantics | `Pipe.transform_messages_to_input` | `artifact_loader`, monkeypatch `ModelFamily.supports` | Asserts pruned tool output marker and image reuse | med | yes | Exercises production pruning thresholds and marker parsing. |  |
| `TestMultimodalIntegration.test_combined_text_image_file` | Multi-block message transforms all blocks. | Multi-block ordering + combined transforms | `Pipe.transform_messages_to_input` | monkeypatch download/upload | Asserts block types/order and stored URLs | med | yes | Replaces prior placeholder; catches loop short-circuit regressions. |  |
| `TestMultimodalIntegration.test_combined_text_audio_image` | Multi-block message with audio and image. | Mixed audio+image conversion | `Pipe.transform_messages_to_input` | monkeypatch upload | Asserts audio converted and image stored | med | yes | Ensures mixed blocks coexist correctly. |  |
| `TestMultimodalIntegration.test_multiple_images_in_message` | Multiple images handled in one message. | Multi-image ordering | `Pipe.transform_messages_to_input` | monkeypatch upload | Asserts both images processed in order | med | yes | Prevents “first image only” regressions. |  |
| `TestMultimodalIntegration.test_error_in_one_block_does_not_crash_others` | One block failure does not abort others. | Per-block error isolation | `Pipe.transform_messages_to_input` | monkeypatch upload to raise once | Asserts image falls back and file still stored | med | yes | Replaces prior placeholder; enforces fail-soft semantics. |  |

## `tests/test_pipe_guards.py`

| Test Name | Description | What It Tests | Code Under Test | Mocks/Fixtures | Assertions | Drift Risk | Check Done | Codex Notes | Codex TODO |
|---|---|---|---|---|---|---|---|---|---|
| `test_wrap_safe_event_emitter_returns_none_for_missing` | None emitter returns None wrapper. | Emitter wrapping contract | `Pipe._wrap_safe_event_emitter` | none | Asserts None returned | low | yes | Calls production helper; no mocks. |  |
| `test_wrap_safe_event_emitter_swallows_transport_errors` | Wrapper swallows emitter exceptions and logs. | Emitter robustness | `Pipe._wrap_safe_event_emitter` | caplog | Asserts no raise + log message emitted | med | yes | Exercises async wrapper behaviour and logging. |  |
| `test_resolve_pipe_identifier_returns_class_id` | Pipe id stable and non-empty. | Pipe identification | `Pipe.id` | none | Asserts id value | low | yes | Guards against accidental id changes (routing/registry). |  |
| `test_pipe_handles_job_failure` | Job failure returns user-friendly message and emits event. | Failure path in `pipe.pipe` | `Pipe.pipe` | monkeypatch `_enqueue_job`, fake emitter | Asserts message + chat:completion event | med | yes | Tests externally observable behaviour, not internal queue. |  |
| `test_pipe_coerces_none_metadata` | None metadata coerced to {}. | Input normalisation | `Pipe.pipe` | monkeypatch `_enqueue_job` | Asserts success path with __metadata__ None | low | yes | Locks in null-handling semantics. |  |
| `test_handle_pipe_call_tolerates_metadata_model_none` | Metadata model=None does not crash model resolution. | Model metadata robustness | `Pipe._handle_pipe_call` | monkeypatch registry + process | Asserts handler returns result | med | yes | Mocks registry IO; executes production handler flow. |  |
| `test_run_streaming_loop_tolerates_null_item` | Streaming loop tolerates item=None events. | Streaming robustness | `Pipe._run_streaming_loop` | monkeypatch streaming generator | Asserts no crash and empty result | med | yes | Verifies loop doesn’t assume non-null items. |  |
| `test_from_completions_preserves_system_message_in_input` | System/user messages preserved when converting to Responses body. | Completions→Responses conversion | `ResponsesBody.from_completions` | none | Asserts system/user message items included | low | yes | Uses production conversion (no dict hand-build). |  |
| `test_merge_valves_no_overrides_returns_global` | No user overrides returns same valves object. | Valve merge identity | `Pipe._merge_valves` | none | Asserts object identity | low | yes | Prevents drift in unnecessary valve copying. |  |
| `test_merge_valves_applies_user_boolean_override` | User boolean override applies without touching other fields. | Valve override semantics | `Pipe._merge_valves` | none | Asserts override + baseline unchanged elsewhere | low | yes | Confirms partial overrides behave as intended. |  |
| `test_merge_valves_honors_reasoning_retention_alias` | Alias next_reply maps to reasoning persistence valve. | Back-compat alias mapping | `Pipe._merge_valves` | none | Asserts PERSIST_REASONING_TOKENS set | low | yes | Guards schema/valve migration behaviour. |  |
| `test_redis_candidate_requires_full_multiworker_env` | Missing env disables Redis candidate with warning. | Redis eligibility detection | `Pipe.__init__` (redis candidate logic) | env vars + caplog | Asserts _redis_candidate False + warning logged | med | yes | Avoids false positives that would break multiworker. |  |
| `test_redis_candidate_enabled_with_complete_env` | Complete env enables Redis candidate. | Redis eligibility detection | `Pipe.__init__` | env vars + aioredis stub | Asserts _redis_candidate True | med | yes | Uses production init logic; stubs aioredis import. |  |
| `test_apply_task_reasoning_preferences_sets_effort` | Supported reasoning param gets effort dict. | Task reasoning application | `Pipe._apply_task_reasoning_preferences` | monkeypatch supported_parameters | Asserts reasoning dict set | low | yes | Ensures task requests get correct parameter shape. |  |
| `test_apply_task_reasoning_preferences_include_only` | Legacy include_reasoning flag toggled from effort. | Legacy reasoning compatibility | `Pipe._apply_task_reasoning_preferences` | monkeypatch supported_parameters | Asserts include_reasoning True/False per effort | low | yes | Locks in compatibility with models lacking reasoning dict. |  |
| `test_retry_without_reasoning_handles_thinking_error` | Thinking error triggers retry without reasoning and clears fields. | Retry rewrite behaviour | `Pipe._should_retry_without_reasoning` | none | Asserts True + reasoning cleared/mutated | low | yes | Ensures safe retry payload mutation. |  |
| `test_retry_without_reasoning_ignores_unrelated_errors` | Unrelated errors do not rewrite body. | Retry guard | `Pipe._should_retry_without_reasoning` | none | Asserts False + include_reasoning unchanged | low | yes | Prevents over-eager mutation. |  |
| `test_apply_reasoning_preferences_prefers_reasoning_payload` | Prefers reasoning dict over legacy flag when both supported. | Reasoning parameter selection | `Pipe._apply_reasoning_preferences` | monkeypatch supported_parameters | Asserts reasoning dict set and include_reasoning cleared | low | yes | Matches production precedence. |  |
| `test_apply_reasoning_preferences_legacy_only_sets_flag` | Only legacy supported => sets include_reasoning. | Legacy-only models | `Pipe._apply_reasoning_preferences` | monkeypatch supported_parameters | Asserts include_reasoning set/cleared by effort | low | yes | Prevents sending unsupported reasoning dicts. |  |
| `test_retry_without_reasoning_handles_reasoning_dict` | Retry clears reasoning dict when present. | Retry mutation (dict form) | `Pipe._should_retry_without_reasoning` | none | Asserts True + reasoning removed | low | yes | Covers dict-based reasoning path. |  |
| `test_transform_messages_skips_image_generation_artifacts` | Image generation artifacts are not replayed into input. | Artifact replay filtering | `Pipe.transform_messages_to_input` | artifact_loader + monkeypatch ModelFamily.supports | Asserts no image_generation_call items emitted | med | yes | Prevents drift leaking non-chat artifacts to provider. |  |
| `test_apply_gemini_thinking_config_sets_level` | Gemini models set thinking_level for HIGH effort. | Gemini thinking config mapping | `Pipe._apply_gemini_thinking_config` | monkeypatch supported_parameters | Asserts thinking_config level set and reasoning cleared | med | yes | Locks in model-specific parameter mapping. |  |
| `test_apply_gemini_thinking_config_sets_budget` | Gemini thinking budget passes through valve. | Gemini budget mapping | `Pipe._apply_gemini_thinking_config` | monkeypatch supported_parameters | Asserts thinking_budget set | med | yes | Ensures budget valve is honoured. |  |
| `test_task_reasoning_valve_applies_only_for_owned_models` | TASK_MODEL_REASONING_EFFORT applies only to owned models. | Task model selection + reasoning injection | `Pipe._process_transformed_request` | monkeypatch registry + supported_parameters + task runner | Asserts task body includes reasoning effort | high | yes | Exercises end-to-end gating via allowed_norm_ids. |  |
| `test_task_reasoning_valve_skips_unowned_models` | TASK_MODEL_REASONING_EFFORT skipped for unlisted models. | Task model gating | `Pipe._process_transformed_request` | monkeypatch registry + task runner | Asserts reasoning effort remains default | high | yes | Prevents leaking task valves onto arbitrary models. |  |
| `test_task_models_dump_costs_when_usage_available` | Usage triggers costs snapshot dump for tasks. | Cost dumping integration | `Pipe._run_task_model_request` | monkeypatch send + dump | Asserts dump called with usage and ids | med | yes | Tests observable side effect (dump) with production task flow. |  |

## `tests/test_pipe_shutdown.py`

| Test Name | Description | What It Tests | Code Under Test | Mocks/Fixtures | Assertions | Drift Risk | Check Done | Codex Notes | Codex TODO |
|---|---|---|---|---|---|---|---|---|---|
| `test_shutdown_db_executor_non_blocking_by_default` | shutdown uses wait=False and cancel_futures=True by default. | Non-blocking DB executor shutdown semantics | `Pipe.shutdown` | Fake executor | Asserts executor cleared and shutdown called with expected args | low | yes | Calls real shutdown and checks externally observable teardown behaviour. |  |
| `test_shutdown_falls_back_when_cancel_futures_unsupported` | shutdown falls back when executor lacks cancel_futures kwarg. | Compatibility with older executors | `Pipe.shutdown` | Fake executor without cancel_futures | Asserts fallback shutdown(wait=False) used and executor cleared | low | yes | Covers TypeError branch so we do not regress older ThreadPoolExecutor APIs. |  |
| `test_shutdown_tolerates_executor_shutdown_exceptions` | shutdown swallows executor shutdown exceptions. | Shutdown robustness | `Pipe.shutdown` | Fake executor raising RuntimeError | Asserts executor cleared even when shutdown raises | low | yes | Ensures shutdown is best-effort and never blocks teardown. |  |

## `tests/test_redis_shutdown.py`

| Test Name | Description | What It Tests | Code Under Test | Mocks/Fixtures | Assertions | Drift Risk | Check Done | Codex Notes | Codex TODO |
|---|---|---|---|---|---|---|---|---|---|
| `test_stop_redis_cancels_tasks_and_closes_client` | stop cancels tasks, clears pointers, and closes redis client. | Redis shutdown cleanup contract | `Pipe._stop_redis` | asyncio tasks and FakeRedis client | Asserts tasks cleared, client closed once, and redis disabled | med | yes | Exercises cancellation path plus close path with real async tasks. |  |
| `test_stop_redis_logs_close_failure` | close failures are logged and do not block shutdown. | Redis close failure handling | `Pipe._stop_redis` | FakeRedis raising + caplog | Asserts client cleared and debug log emitted | med | yes | Ensures redis shutdown is fail-safe on client.close exceptions. |  |

## `tests/test_registry_plumbing.py`

| Test Name | Description | What It Tests | Code Under Test | Mocks/Fixtures | Assertions | Drift Risk | Check Done | Codex Notes | Codex TODO |
|---|---|---|---|---|---|---|---|---|---|
| `test_registry_refresh_populates_models_and_specs` | Refresh populates models/specs with derived features. | Registry refresh | `OpenRouterModelRegistry.ensure_loaded` | DummySession/DummyResponse | Asserts model id normalisation, id mapping, and derived feature flags | high | yes | Runs production ensure_loaded with fake HTTP response payload. |  |
| `test_registry_cache_prevents_refresh` | Cache window prevents refresh call. | Cache gating | `OpenRouterModelRegistry.ensure_loaded` | monkeypatch `_refresh` | Asserts refresh not called when next_refresh_after in future | med | yes | Tests real cache bookkeeping semantics. |  |
| `test_registry_refresh_failure_uses_cache` | Refresh errors fall back to cached models. | Failure fallback | `OpenRouterModelRegistry.ensure_loaded` | monkeypatch `_refresh` to raise | Asserts cached models retained on refresh failure | med | yes | Prevents outage from transient refresh errors. |  |
| `test_registry_raises_when_key_missing` | Missing API key raises ValueError. | Input validation | `OpenRouterModelRegistry.ensure_loaded` | DummySession | Asserts ValueError on empty key | low | yes | Guards against silent unauthenticated refresh. |  |
| `test_registry_refresh_error_no_cache` | No cache + refresh error propagates. | Error propagation | `OpenRouterModelRegistry.ensure_loaded` | monkeypatch `_refresh` to raise | Asserts RuntimeError when no cached models | med | yes | Locks in fail-fast when registry cannot load. |  |
| `test_registry_record_refresh_bookkeeping` | Bookkeeping updated on success/failure. | Refresh bookkeeping | `OpenRouterModelRegistry._record_refresh_success`, `_record_refresh_failure` | none | Asserts counters/timestamps/error fields updated | low | yes | Protects backoff/health reporting state. |  |
| `test_registry_feature_and_capability_derivation` | Derived features/capabilities match supported params/modalities/pricing. | Feature/capability derivation | `_derive_features`, `_supports_web_search`, `_derive_capabilities` | none | Asserts expected feature set and capability booleans | low | yes | Prevents drift in registry-derived UI capability flags. |  |
| `test_registry_list_models_and_mapping` | list_models merges capabilities and api_model_id maps norm id. | Model listing + mapping | `OpenRouterModelRegistry.list_models`, `api_model_id` | preloaded registry state | Asserts merged capabilities and id mapping works | low | yes | Ensures consumer-facing model list stays consistent. |  |

## `tests/test_request_identifiers.py`

| Test Name | Description | What It Tests | Code Under Test | Mocks/Fixtures | Assertions | Drift Risk | Check Done | Codex Notes | Codex TODO |
|---|---|---|---|---|---|---|---|---|---|
| `test_identifier_valves_default_omit_everything` | Default valves omit user/session/metadata fields. | Identifier omission defaults | `_apply_identifier_valves_to_payload` | none | Asserts user/session_id/metadata removed | low | yes | Ensures privacy-preserving defaults. |  |
| `test_identifier_valves_populate_expected_fields[valves_kwargs0-expected_payload0]` | SEND_END_USER_ID populates user + metadata.user_id. | Identifier inclusion | `_apply_identifier_valves_to_payload` | paramised case | Asserts expected keys added | low | yes | Paramised per pytest collection. |  |
| `test_identifier_valves_populate_expected_fields[valves_kwargs1-expected_payload1]` | SEND_SESSION_ID populates session_id + metadata.session_id. | Identifier inclusion | `_apply_identifier_valves_to_payload` | paramised case | Asserts expected keys added | low | yes | Paramised per pytest collection. |  |
| `test_identifier_valves_populate_expected_fields[valves_kwargs2-expected_payload2]` | SEND_CHAT_ID populates metadata.chat_id only. | Identifier inclusion | `_apply_identifier_valves_to_payload` | paramised case | Asserts expected keys added | low | yes | Paramised per pytest collection. |  |
| `test_identifier_valves_populate_expected_fields[valves_kwargs3-expected_payload3]` | SEND_MESSAGE_ID populates metadata.message_id only. | Identifier inclusion | `_apply_identifier_valves_to_payload` | paramised case | Asserts expected keys added | low | yes | Paramised per pytest collection. |  |
| `test_identifier_valves_populate_expected_fields[valves_kwargs4-expected_payload4]` | All SEND_* valves populate combined payload fields. | Identifier inclusion | `_apply_identifier_valves_to_payload` | paramised case | Asserts combined keys added | low | yes | Paramised per pytest collection. |  |
| `test_filter_openrouter_request_sanitizes_metadata_constraints` | Invalid metadata keys/values dropped by filter. | Metadata sanitisation | `_filter_openrouter_request` | none | Asserts bad keys and long values removed | low | yes | Protects upstream metadata constraints. |  |

## `tests/test_responses_body.py`

| Test Name | Description | What It Tests | Code Under Test | Mocks/Fixtures | Assertions | Drift Risk | Check Done | Codex Notes | Codex TODO |
|---|---|---|---|---|---|---|---|---|---|
| `test_from_completions_maps_response_format_to_text_format` | response_format maps to Responses text.format. | Structured output mapping | `ResponsesBody.from_completions` | monkeypatch `Pipe.transform_messages_to_input` | Asserts `responses.text.format` shape matches schema input | med | yes | Tests mapping logic without reimplementing transformer. |  |
| `test_from_completions_preserves_parallel_tool_calls` | parallel_tool_calls preserved. | Field preservation | `ResponsesBody.from_completions` | monkeypatch transformer | Asserts parallel_tool_calls remains False | low | yes | Ensures routing decisions can rely on value. |  |
| `test_from_completions_converts_legacy_function_call_dict` | Legacy function_call dict becomes tool_choice. | Legacy compatibility | `ResponsesBody.from_completions` | monkeypatch transformer | Asserts tool_choice dict set from function_call | low | yes | Prevents drift in legacy OpenAI params. |  |
| `test_from_completions_converts_legacy_function_call_strings` | Legacy function_call string passes through. | Legacy compatibility | `ResponsesBody.from_completions` | monkeypatch transformer | Asserts tool_choice == \"none\" | low | yes | Keeps backwards-compatible behaviour. |  |
| `test_from_completions_does_not_override_explicit_tool_choice` | Explicit tool_choice wins over legacy function_call. | Precedence rules | `ResponsesBody.from_completions` | monkeypatch transformer | Asserts tool_choice remains explicit | low | yes | Guards against accidental override regressions. |  |
| `test_auto_context_trimming_enabled_by_default` | Default applies middle-out transform. | Auto context trimming default | `Pipe._apply_context_transforms` | `minimal_pipe` | Asserts transforms == [\"middle-out\"] | low | yes | Locks in default transform safety behaviour. |  |
| `test_auto_context_trimming_respects_explicit_transforms` | Explicit transforms not overridden. | Transform precedence | `Pipe._apply_context_transforms` | `minimal_pipe` | Asserts custom transforms preserved | low | yes | Prevents surprising user override behaviour. |  |
| `test_auto_context_trimming_disabled_via_valve` | Valve disables auto trimming. | Valve gating | `Pipe._apply_context_transforms` | `minimal_pipe` valves override | Asserts transforms None when disabled | low | yes | Ensures feature flag respected. |  |

## `tests/test_security_methods.py`

| Test Name | Description | What It Tests | Code Under Test | Mocks/Fixtures | Assertions | Drift Risk | Check Done | Codex Notes | Codex TODO |
|---|---|---|---|---|---|---|---|---|---|
| `test_is_safe_url_allows_public_ips` | Public IPs pass SSRF guard. | Allowlist behaviour | `Pipe._is_safe_url` | monkeypatch `socket.getaddrinfo` | Asserts True for public IP resolution | med | yes | Uses getaddrinfo stub for determinism. |  |
| `test_is_safe_url_blocks_private_ranges[10.0.0.1]` | Private IPv4 blocked. | SSRF blocklist | `Pipe._is_safe_url` | paramised IP + getaddrinfo stub | Asserts False | med | yes | Paramised per pytest collection. |  |
| `test_is_safe_url_blocks_private_ranges[192.168.1.1]` | Private IPv4 blocked. | SSRF blocklist | `Pipe._is_safe_url` | paramised IP + getaddrinfo stub | Asserts False | med | yes | Paramised per pytest collection. |  |
| `test_is_safe_url_blocks_private_ranges[172.16.0.1]` | Private IPv4 blocked. | SSRF blocklist | `Pipe._is_safe_url` | paramised IP + getaddrinfo stub | Asserts False | med | yes | Paramised per pytest collection. |  |
| `test_is_safe_url_blocks_private_ranges[127.0.0.1]` | Loopback blocked. | SSRF blocklist | `Pipe._is_safe_url` | paramised IP + getaddrinfo stub | Asserts False | med | yes | Paramised per pytest collection. |  |
| `test_is_safe_url_blocks_private_ranges[169.254.169.254]` | Link-local metadata blocked. | SSRF blocklist | `Pipe._is_safe_url` | paramised IP + getaddrinfo stub | Asserts False | med | yes | Covers common metadata endpoint. |  |
| `test_is_safe_url_blocks_private_ranges[224.0.0.1]` | Multicast blocked. | SSRF blocklist | `Pipe._is_safe_url` | paramised IP + getaddrinfo stub | Asserts False | med | yes | Ensures multicast cannot be targeted. |  |
| `test_is_safe_url_blocks_private_ranges[fd00::1]` | IPv6 ULA blocked. | SSRF blocklist | `Pipe._is_safe_url` | paramised IP + getaddrinfo stub | Asserts False | med | yes | Ensures IPv6 private ranges blocked. |  |
| `test_is_safe_url_blocks_literal_loopback` | Literal loopback blocked without DNS. | Fast-path hostname parsing | `Pipe._is_safe_url` | none | Asserts False for 127.0.0.1 literal URL | low | yes | Guards against regressions bypassing DNS checks. |  |
| `test_is_safe_url_handles_dns_failures` | DNS errors treated as unsafe. | Failure handling | `Pipe._is_safe_url` | monkeypatch getaddrinfo to raise | Asserts False | med | yes | Prevents fail-open on resolver issues. |  |
| `test_is_safe_url_rejects_urls_without_hostname` | file:// and data: rejected. | Scheme validation | `Pipe._is_safe_url` | none | Asserts False for non-http(s) URLs | low | yes | Matches production early-return semantics. |  |
| `test_is_safe_url_respects_disabled_valve` | Disabled valve allows private URLs. | Operator override | `Pipe._is_safe_url` | valve set to False | Asserts True for private URL | low | yes | Ensures feature flag respected. |  |
| `test_download_remote_url_halts_when_ssrf_blocks` | Download short-circuits when SSRF blocks. | SSRF integration | `Pipe._download_remote_url` | AsyncMock `_is_safe_url`, monkeypatch httpx.AsyncClient | Asserts None and no HTTP client created | med | yes | Ensures SSRF blocks before network IO. |  |
| `test_is_youtube_url_variants` | Detects YouTube standard/short URLs. | URL classification | `Pipe._is_youtube_url` | none | Asserts True/False for known formats | low | yes | Avoids drift in regex/hostname logic. |  |
| `test_status_messages_are_strings` | Status messages are non-empty and include emoji cues. | Operator/UI strings | `StatusMessages` | none | Asserts non-empty string and emoji | low | yes | Protects UI/User Interface contract for statuses. |  |
| `test_valve_defaults_are_sensible` | Safety valves stay within bounds. | Valve defaults | `Pipe.Valves` | none | Asserts VIDEO_MAX_SIZE range and SSRF default | low | yes | Guards default safety posture. |  |

## `tests/test_session_log_storage.py`

| Test Name | Description | What It Tests | Code Under Test | Mocks/Fixtures | Assertions | Drift Risk | Check Done | Codex Notes | Codex TODO |
|---|---|---|---|---|---|---|---|---|---|
| `test_sanitize_path_component_blocks_traversal` | Sanitises path fragments to prevent traversal. | Path sanitisation | `_sanitize_path_component` | none | Asserts traversal removed and fallback used | low | yes | Exercises production sanitiser. |  |
| `test_write_session_log_archive_creates_encrypted_zip` | Writes encrypted session log zip with meta+logs. | Archive creation | `Pipe._write_session_log_archive` | `tmp_path`, pyzipper | Asserts zip exists, decrypts with password, and contents correct | med | yes | End-to-end archive write + readback. |  |
| `test_enqueue_session_log_archive_skips_when_missing_ids` | Missing ids prevent queue start/enqueue. | Enqueue guard | `Pipe._enqueue_session_log_archive` | monkeypatch worker start + queue | Asserts worker not started | low | yes | Prevents creating invalid archive jobs. |  |
| `test_session_log_buffer_captures_debug_even_when_console_level_warning` | Debug lines captured in buffer even when console level is WARNING. | SessionLogger buffering | `SessionLogger.get_logger` | capsys + contextvars | Asserts stdout and buffer diverge appropriately | med | yes | Protects operator debugging without noisy console logs. |  |
| `TestSessionLogArchiveEdgeCases.test_archive_with_missing_ids_skipped` | Missing required ids => archive not written. | Archive guard | `Pipe._write_session_log_archive` | `tmp_path` | Asserts no zip created | low | yes | Ensures fail-closed for incomplete identifiers. |  |
| `TestSessionLogArchiveEdgeCases.test_archive_password_encryption` | Wrong password cannot read; correct can. | Zip encryption | `Pipe._write_session_log_archive` | pyzipper | Asserts wrong password raises and correct reads meta | med | yes | Validates AES encryption is actually enforced. |  |
| `TestSessionLogArchiveEdgeCases.test_archive_compression_options` | Supports multiple compression modes. | Compression support | `Pipe._write_session_log_archive` | pyzipper | Asserts archives readable across compression types | med | yes | Prevents drift in compression option mapping. |  |
| `TestSessionLogArchiveEdgeCases.test_cleanup_deletes_old_archives` | Cleanup deletes expired zips and prunes empty dirs. | Retention cleanup | `Pipe._cleanup_session_log_archives` | monkeypatch time + utime | Asserts old zip removed, new kept, and old dirs pruned | high | yes | Uses real cleanup (no simulated asserts). |  |
| `TestSessionLogArchiveEdgeCases.test_cleanup_prunes_empty_directories` | Cleanup prunes empty user/chat dirs after deletion. | Directory pruning | `Pipe._cleanup_session_log_archives` | monkeypatch time + utime | Asserts zip deleted and empty dirs removed | high | yes | Exercises real prune logic end-to-end. |  |

## `tests/test_session_logger_thread_safety.py`

| Test Name | Description | What It Tests | Code Under Test | Mocks/Fixtures | Assertions | Drift Risk | Check Done | Codex Notes | Codex TODO |
|---|---|---|---|---|---|---|---|---|---|
| `test_session_logger_thread_safety_filter_and_cleanup` | filter and cleanup run concurrently without dict-size RuntimeError. | Locking around session_last_seen and buffer updates | `SessionLogger.get_logger`, `SessionLogger.cleanup` | ThreadPoolExecutor | Asserts no RuntimeError and request buffer exists and has entries | med | yes | Real concurrent calls hit production locks and fail if locking is removed. |  |
| `test_session_logger_cleanup_removes_stale_entries` | cleanup removes stale request buffers. | Time-based log eviction | `SessionLogger.cleanup`, `SessionLogger.process_record` | direct LogRecord inputs | Asserts stale request_id removed and fresh retained | low | yes | Makes one entry stale and calls real cleanup; avoids sleeping. |  |
| `test_session_logger_concurrent_writes_same_request` | concurrent logging to same request_id retains expected lines. | Thread-safe buffer append and maxlen behaviour | `SessionLogger.get_logger`, `SessionLogger.process_record` | ThreadPoolExecutor | Asserts deque length equals min(total messages, max_lines) | med | yes | Guards against lost log lines or buffer corruption under concurrency. |  |

## `tests/test_status_formatting.py`

| Test Name | Description | What It Tests | Code Under Test | Mocks/Fixtures | Assertions | Drift Risk | Check Done | Codex Notes | Codex TODO |
|---|---|---|---|---|---|---|---|---|---|
| `test_format_final_status_description_includes_cost_tokens_and_tps` | Formats final status with time, tps, cost, and token breakdown. | User-facing final usage status string | `Pipe._format_final_status_description` | none | Asserts tps computed from output tokens, cost formatting, and token details included | low | yes | Asserts externally visible status line content and math. |  |
| `test_format_final_status_description_respects_disabled_flag` | Disabled valve returns default thought-for message. | SHOW_FINAL_USAGE_STATUS gating | `Pipe._format_final_status_description` | valves override | Asserts fallback description returned | low | yes | Ensures operator valve disables status content. |  |

## `tests/test_streaming_queues.py`

| Test Name | Description | What It Tests | Code Under Test | Mocks/Fixtures | Assertions | Drift Risk | Check Done | Codex Notes | Codex TODO |
|---|---|---|---|---|---|---|---|---|---|
| `test_queue_valves_unbounded_defaults` | Default queue valves are unbounded (0). | Safe defaults | `Pipe.Valves` | none | Asserts default maxsizes and warn threshold | low | yes | Ensures defaults avoid deadlocks by default. |  |
| `test_valve_descriptions_warn_deadlock` | Valve descriptions warn about deadlock and 0=unbounded. | Operator docs | `Pipe.Valves.model_fields` | none | Asserts descriptions mention deadlock and unbounded behaviour | low | yes | Keeps operator-facing docs aligned with risks. |  |
| `test_warn_condition_logic[999-1000-0-False]` | Below warn threshold => no warn. | Warn condition | `Pipe._should_warn_event_queue_backlog` | paramised case | Asserts should_warn False | low | yes | Uses production helper (no duplicated condition). |  |
| `test_warn_condition_logic[999-1000-30-False]` | Below warn threshold => no warn. | Warn condition | `Pipe._should_warn_event_queue_backlog` | paramised case | Asserts should_warn False | low | yes | Uses production helper (no duplicated condition). |  |
| `test_warn_condition_logic[999-1000-60-False]` | Below warn threshold => no warn. | Warn condition | `Pipe._should_warn_event_queue_backlog` | paramised case | Asserts should_warn False | low | yes | Uses production helper (no duplicated condition). |  |
| `test_warn_condition_logic[1000-1000-0-False]` | At threshold but within cooldown => no warn. | Warn condition | `Pipe._should_warn_event_queue_backlog` | paramised case | Asserts should_warn False | low | yes | Uses production helper (no duplicated condition). |  |
| `test_warn_condition_logic[1000-1000-29.9-False]` | At threshold but <30s => no warn. | Warn condition | `Pipe._should_warn_event_queue_backlog` | paramised case | Asserts should_warn False | low | yes | Uses production helper (no duplicated condition). |  |
| `test_warn_condition_logic[1000-1000-30.0-True]` | At threshold and >=30s => warn. | Warn condition | `Pipe._should_warn_event_queue_backlog` | paramised case | Asserts should_warn True | low | yes | Uses production helper (no duplicated condition). |  |
| `test_warn_condition_logic[1000-1000-60-True]` | At threshold and >=30s => warn. | Warn condition | `Pipe._should_warn_event_queue_backlog` | paramised case | Asserts should_warn True | low | yes | Uses production helper (no duplicated condition). |  |
| `test_warn_condition_logic[1200-1000-0-False]` | Above threshold but within cooldown => no warn. | Warn condition | `Pipe._should_warn_event_queue_backlog` | paramised case | Asserts should_warn False | low | yes | Uses production helper (no duplicated condition). |  |
| `test_warn_condition_logic[1200-1000-29-False]` | Above threshold but <30s => no warn. | Warn condition | `Pipe._should_warn_event_queue_backlog` | paramised case | Asserts should_warn False | low | yes | Uses production helper (no duplicated condition). |  |
| `test_warn_condition_logic[1200-1000-30-True]` | Above threshold and >=30s => warn. | Warn condition | `Pipe._should_warn_event_queue_backlog` | paramised case | Asserts should_warn True | low | yes | Uses production helper (no duplicated condition). |  |
| `test_warn_condition_logic[1200-1000-100-True]` | Above threshold and >=30s => warn. | Warn condition | `Pipe._should_warn_event_queue_backlog` | paramised case | Asserts should_warn True | low | yes | Uses production helper (no duplicated condition). |  |
| `test_warn_condition_logic[0-1000-30-False]` | Empty queue => no warn. | Warn condition | `Pipe._should_warn_event_queue_backlog` | paramised case | Asserts should_warn False | low | yes | Uses production helper (no duplicated condition). |  |
| `test_warn_condition_logic[5000-1000-30-True]` | Very large backlog => warn. | Warn condition | `Pipe._should_warn_event_queue_backlog` | paramised case | Asserts should_warn True | low | yes | Uses production helper (no duplicated condition). |  |
| `test_warn_condition_logic[1000-100-30-True]` | Lower warn threshold triggers warn. | Warn condition | `Pipe._should_warn_event_queue_backlog` | paramised case | Asserts should_warn True | low | yes | Uses production helper (no duplicated condition). |  |
| `test_queue_valve_constraints` | Field constraints enforce non-negative sizes and warn_size>=100. | Valve constraints | `Pipe.Valves.model_fields` | none | Asserts pydantic ge constraints | low | yes | Prevents misconfiguration that would spam logs. |  |
| `test_valve_accepts_various_queue_sizes[0-0]` | Accepts unbounded sizes. | Valve assignment | `Pipe.valves` | paramised case | Asserts values set | low | yes | Checks runtime valve assignment behaviour. |  |
| `test_valve_accepts_various_queue_sizes[1000-1000]` | Accepts large bounded sizes. | Valve assignment | `Pipe.valves` | paramised case | Asserts values set | low | yes | Checks runtime valve assignment behaviour. |  |
| `test_valve_accepts_various_queue_sizes[50-50]` | Accepts small bounded sizes. | Valve assignment | `Pipe.valves` | paramised case | Asserts values set | low | yes | Risk documented elsewhere; still allowed. |  |
| `test_valve_accepts_various_queue_sizes[100-200]` | Accepts asymmetric sizes. | Valve assignment | `Pipe.valves` | paramised case | Asserts values set | low | yes | Guards against assignment restrictions drift. |  |
| `test_warning_cooldown_prevents_spam` | Cooldown only warns every 30s. | Cooldown behaviour | `Pipe._should_warn_event_queue_backlog` | simulated timestamps | Asserts warnings at 30s intervals | low | yes | Uses production helper for cooldown logic. |  |
| `test_unbounded_queue_semantics` | asyncio.Queue maxsize=0 is unbounded. | Queue semantics | stdlib `asyncio.Queue` | none | Asserts maxsize markers | low | yes | Documents behaviour depended on by valve defaults. |  |
| `test_warning_size_minimum[100]` | warn_size>=100 accepted. | Valve assignment | `Pipe.valves` | paramised case | Asserts warn_size set | low | yes | Keeps minimum bound aligned with pydantic constraint. |  |
| `test_warning_size_minimum[500]` | warn_size>=100 accepted. | Valve assignment | `Pipe.valves` | paramised case | Asserts warn_size set | low | yes | Keeps minimum bound aligned with pydantic constraint. |  |
| `test_warning_size_minimum[1000]` | warn_size>=100 accepted. | Valve assignment | `Pipe.valves` | paramised case | Asserts warn_size set | low | yes | Keeps minimum bound aligned with pydantic constraint. |  |
| `test_warning_size_minimum[5000]` | warn_size>=100 accepted. | Valve assignment | `Pipe.valves` | paramised case | Asserts warn_size set | low | yes | Keeps minimum bound aligned with pydantic constraint. |  |

## `tests/test_tool_exception_logging.py`

| Test Name | Description | What It Tests | Code Under Test | Mocks/Fixtures | Assertions | Drift Risk | Check Done | Codex Notes | Codex TODO |
|---|---|---|---|---|---|---|---|---|---|
| `test_tool_exception_logs_stack_trace` | Tool exception yields failed output and debug log includes exc_info. | Tool error surfacing and diagnostic logging | `Pipe._execute_tool_batch` | `_QueuedToolCall`, `_ToolExecutionContext`, caplog | Asserts future resolves to failed tool output and debug record has exc_info | med | yes | Uses real batching path so logging stays aligned with production retries and error handling. |  |

## `tests/test_tool_schema.py`

| Test Name | Description | What It Tests | Code Under Test | Mocks/Fixtures | Assertions | Drift Risk | Check Done | Codex Notes | Codex TODO |
|---|---|---|---|---|---|---|---|---|---|
| `test_strictify_preserves_required_fields` | Required fields stay non-null; optional become nullable. | Required/nullability rules | `_strictify_schema` | none | Asserts required list expanded and types adjusted | low | yes | Calls production strictifier; no hand-rolled conversion. |  |
| `test_strictify_keeps_optional_fields_optional` | Properties without required list become required-but-nullable. | Default required behaviour | `_strictify_schema` | none | Asserts required includes all keys and types include null | low | yes | Matches production “strict tools” semantics. |  |
| `test_strictify_handles_nested_objects` | Nested objects become strict with required + nullability. | Nested strictification | `_strictify_schema` | none | Asserts nested required/properties types updated | low | yes | Guards recursion behaviour. |  |
| `test_strictify_adds_type_to_empty_property` | Empty property schemas get inferred object type. | Type inference (empty schema) | `_strictify_schema` | none | Asserts inferred object type and additionalProperties False | low | yes | Prevents OpenAI schema validation errors. |  |
| `test_strictify_adds_type_to_schema_with_only_description` | Description-only schemas infer object type. | Type inference (description-only) | `_strictify_schema` | none | Asserts inferred type and description preserved | low | yes | Ensures metadata doesn’t break strictification. |  |
| `test_strictify_handles_nested_empty_schemas` | Nested empty schemas infer type correctly. | Type inference (nested) | `_strictify_schema` | none | Asserts nested inferred object type | low | yes | Covers deep recursion edge case. |  |
| `test_strictify_adds_type_to_empty_items` | Array items {} infer object type. | Items inference | `_strictify_schema` | none | Asserts items type becomes object | low | yes | Prevents invalid array item schemas. |  |
| `test_strictify_handles_empty_anyof_branch` | anyOf empty branches infer object type. | anyOf inference | `_strictify_schema` | none | Asserts empty branch becomes object | low | yes | Guards against partially-specified anyOf. |  |
| `test_strictify_infers_object_type_from_properties` | Schemas with properties infer object type. | Object inference | `_strictify_schema` | none | Asserts object+null in inferred type list | low | yes | Matches production inference rule. |  |
| `test_strictify_infers_array_type_from_items` | Schemas with items infer array type. | Array inference | `_strictify_schema` | none | Asserts array+null in inferred type list | low | yes | Matches production inference rule. |  |
| `test_strictify_preserves_existing_behavior_for_valid_schemas` | Previously-valid schemas unchanged aside from strictification rules. | Regression coverage | `_strictify_schema` | none | Asserts same outcomes as earlier test | low | yes | Protects against breaking prior behaviour. |  |
| `test_strictify_handles_auth_headers_scenario` | Bug-repro schema now becomes valid OpenAI schema. | Bug regression test | `_strictify_schema` | none | Asserts required object gets non-null object type | low | yes | Locks in fix for “empty object schema” error. |  |

## `tests/test_tool_shutdown_timeout.py`

| Test Name | Description | What It Tests | Code Under Test | Mocks/Fixtures | Assertions | Drift Risk | Check Done | Codex Notes | Codex TODO |
|---|---|---|---|---|---|---|---|---|---|
| `test_shutdown_tool_context_times_out_and_cancels` | Shutdown times out and cancels stuck tool workers. | Bounded graceful shutdown then cancellation | `Pipe._shutdown_tool_context` | stuck asyncio task + caplog | Asserts worker task cancelled or done and warning emitted | med | yes | Protects shutdown from hanging forever on misbehaving tool workers. |  |

## `tests/test_top_k_passthrough.py`

| Test Name | Description | What It Tests | Code Under Test | Mocks/Fixtures | Assertions | Drift Risk | Check Done | Codex Notes | Codex TODO |
|---|---|---|---|---|---|---|---|---|---|
| `test_filter_openrouter_request_forwards_numeric_top_k` | Numeric top_k is forwarded as float. | top_k normalization | `_filter_openrouter_request` | none | Asserts int coerces to float | low | yes | Calls production request filter; no duplicate parsing logic. |  |
| `test_filter_openrouter_request_parses_string_top_k` | String top_k is parsed and forwarded as float. | top_k parsing | `_filter_openrouter_request` | none | Asserts trimmed numeric string coerces to float | low | yes | Guards against regressions in whitespace handling. |  |
| `test_filter_openrouter_request_drops_invalid_top_k` | Invalid top_k is dropped. | top_k validation | `_filter_openrouter_request` | none | Asserts invalid string removes top_k key | low | yes | Ensures invalid provider params are filtered out. |  |

## `tests/test_transform_messages.py`

| Test Name | Description | What It Tests | Code Under Test | Mocks/Fixtures | Assertions | Drift Risk | Check Done | Codex Notes | Codex TODO |
|---|---|---|---|---|---|---|---|---|---|
| `test_transform_messages_skips_orphaned_function_calls` | Orphaned tool calls are not replayed. | Artifact replay filtering | `Pipe.transform_messages_to_input` | artifact_loader | Asserts function_call items not emitted | med | yes | Exercises real marker parsing + loader integration. |  |
| `test_transform_messages_keeps_complete_function_call_pairs` | Complete call+output pairs are replayed. | Artifact replay inclusion | `Pipe.transform_messages_to_input` | artifact_loader | Asserts function_call then function_call_output with shared call_id | med | yes | Ensures tools replay when both halves present. |  |
| `test_transform_messages_skips_orphaned_function_call_outputs` | Orphaned tool outputs are not replayed. | Artifact replay filtering | `Pipe.transform_messages_to_input` | artifact_loader | Asserts function_call_output not emitted | med | yes | Prevents injecting unusable outputs into input. |  |
| `test_classify_function_call_artifacts_partitions_sets` | Classifier returns valid/orphan sets. | Artifact classification | `_classify_function_call_artifacts` | none | Asserts valid and orphan partitions | low | yes | Uses production classifier helper. |  |
| `test_transform_limits_user_images` | Enforces MAX_INPUT_IMAGES_PER_REQUEST and emits status. | Image limiting | `Pipe.transform_messages_to_input` | monkeypatch inline + event_emitter | Asserts only first image kept and status mentions dropped | high | yes | Protects against large multimodal payloads. |  |
| `test_transform_falls_back_to_assistant_images` | Assistant markdown images used when user turn lacks images. | Image selection fallback | `Pipe.transform_messages_to_input` | monkeypatch inline | Asserts assistant image included in user content | med | yes | Ensures edit flows retain context images. |  |
| `test_transform_respects_user_turn_only_selection` | user_turn_only prevents assistant image fallback. | Image selection valve | `Pipe.transform_messages_to_input` | monkeypatch inline | Asserts no input_image in user content | med | yes | Locks in valve semantics. |  |
| `test_transform_skips_images_when_model_lacks_vision` | Models without vision drop image inputs and emit status. | Vision capability gating | `Pipe.transform_messages_to_input`, `ModelFamily` specs | monkeypatch inline + event_emitter | Asserts images removed and status explains why | high | yes | Prevents sending images to text-only models. |  |
| `test_transform_preserves_system_and_developer_message_text_exactly` | System/developer text preserved byte-for-byte. | Message text preservation | `Pipe.transform_messages_to_input` | none | Asserts whitespace/newlines preserved in output blocks | low | yes | Prevents drift trimming system instructions. |  |

## `tests/test_valve_validation.py`

| Test Name | Description | What It Tests | Code Under Test | Mocks/Fixtures | Assertions | Drift Risk | Check Done | Codex Notes | Codex TODO |
|---|---|---|---|---|---|---|---|---|---|
| `TestEncryptedStr.test_encrypted_str_roundtrip` | EncryptedStr encrypts/decrypts when WEBUI_SECRET_KEY is set. | `EncryptedStr.encrypt/decrypt` behavior | `open_webui_openrouter_pipe.py:EncryptedStr.encrypt/decrypt` | `monkeypatch` env | Asserts prefix + roundtrip | low | yes | Replaced env-dependent implicit secret with explicit `WEBUI_SECRET_KEY`. |  |
| `TestEncryptedStr.test_encrypted_str_without_webui_secret` | No WEBUI_SECRET_KEY → values stored/returned plain. | Keyless encryption is a no-op | `open_webui_openrouter_pipe.py:EncryptedStr.encrypt/decrypt` | `monkeypatch` env | Asserts encrypt==plain and decrypt==plain | low | yes | Avoids test drift from developer env vars. |  |
| `TestValveNumericBounds.test_valve_numeric_bounds_enforced` | Pydantic bounds reject invalid valve values. | Valve numeric constraints are enforced | `Pipe.Valves` pydantic fields | none | Asserts `ValidationError` for invalid values | low | yes | Removed fake comparisons; now hits pydantic validation. |  |
| `TestValveEnvironmentDefaults.test_default_log_level_from_env` | LOG_LEVEL defaults from GLOBAL_LOG_LEVEL env. | Env default plumbing for LOG_LEVEL | `open_webui_openrouter_pipe.py:_resolve_log_level_default` + `Pipe.Valves.LOG_LEVEL` | `monkeypatch` env | Asserts LOG_LEVEL reflects env | low | yes |  |  |
| `TestValveEnvironmentDefaults.test_invalid_log_level_env_falls_back_to_info` | Invalid GLOBAL_LOG_LEVEL → INFO. | Env normalization for LOG_LEVEL | `open_webui_openrouter_pipe.py:_resolve_log_level_default` | `monkeypatch` env | Asserts invalid env coerces to INFO | low | yes |  |  |
| `TestValveEnvironmentDefaults.test_api_key_default_from_env` | API_KEY defaults from OPENROUTER_API_KEY env. | Env default plumbing for API_KEY | `open_webui_openrouter_pipe.py:_default_api_key` + `Pipe.Valves.API_KEY` | `monkeypatch` env | Asserts decrypted value equals env | low | yes | Uses keyless decrypt to avoid secret coupling. |  |
| `TestValveValidation.test_valve_boolean_defaults` | Boolean valve fields are bools. | Valve schema/type stability | `Pipe.Valves` fields | none | `isinstance(..., bool)` checks | med | yes | Kept assertions contract-level (types), not specific default values. |  |
| `TestValveValidation.test_valve_pattern_defaults` | Pattern valves are strings and default empty. | Endpoint-selection config inputs | `Pipe.Valves.FORCE_*_MODELS` | none | Asserts type `str` | med | yes | Reflects production glob patterns (not regex). |  |
| `TestValveValidation.test_valve_encryption_key_default` | ARTIFACT_ENCRYPTION_KEY defaults to empty EncryptedStr. | Artifact encryption key default | `open_webui_openrouter_pipe.py:_default_artifact_encryption_key` | none | Asserts decrypted default empty | low | yes |  |  |
| `TestValveValidation.test_valve_compression_settings` | Compression settings accept defaults. | LZ4/compression valve schema | `Pipe.Valves.ENABLE_LZ4_COMPRESSION/MIN_COMPRESS_BYTES` | none | Asserts types + non-negative | low | yes |  |  |
| `TestValveValidation.test_valve_breaker_settings` | Breaker settings are present and positive. | Breaker valve schema | `Pipe.Valves.BREAKER_*` | none | Asserts >0 | low | yes |  |  |
| `TestValveValidation.test_valve_concurrency_settings` | Concurrency settings are present and sane. | Concurrency valve schema | `Pipe.Valves.MAX_CONCURRENT_REQUESTS/MAX_PARALLEL_TOOLS_*` | none | Asserts >0 / >=0 | low | yes | Removed drifted request-queue assertions. |  |
