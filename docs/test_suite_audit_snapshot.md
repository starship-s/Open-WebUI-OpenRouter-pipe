# Test Suite Audit Snapshot

Audit completed by Claude Sonnet 4.5 (Claude Code) on 2026-01-22.

This document is a one-shot snapshot of the completed audit and is not intended
to be maintained day-to-day. If you re-audit or materially rewrite the test suite,
create a new snapshot (or resurrect a progress tracker) rather than editing this one.

**Security note:** SSRF-related test expectations assume HTTPS-only defaults; plaintext HTTP is disabled by default and only allowed via the `ALLOW_INSECURE_HTTP` allowlist valves.

## Status

- Last updated: 2026-01-22
- Started: 2026-01-22
- Current focus: complete

## Commands

- Pyright (Pylance parity): `PYTHONPATH=. .venv/bin/python -m pyright tests`
- Pytest: `PYTHONPATH=. .venv/bin/pytest tests -q`

## Conventions

- `Check Done`: use `yes` when verified non-drifting + type-clean.
- `Drift Risk`: `low/med/high`.
- `Code Under Test`: prefer `module.py:func` or `Class.method`.
- Total test files: 41
- Total tests documented: 3233 (100% of 3233 collected by pytest)

---



## `tests/test_anthropic.py`

| Test Name | Description | What It Tests | Code Under Test | Mocks/Fixtures | Assertions | Drift Risk | Check Done | Codex Notes | Codex TODO |
|-----------|-------------|---------------|-----------------|----------------|------------|------------|------------|-------------|------------|
| test_prompt_caching_disabled_returns_early | Tests early return when ENABLE_ANTHROPIC_PROMPT_CACHING is False. Verifies line 36 coverage. | That the function returns immediately without modification when caching is disabled. | Pipe._maybe_apply_anthropic_prompt_caching | pipe_instance fixture | Asserts no cache_control was added using Pipe._input_contains_cache_control | low | yes | Tests disabled feature path | |
| test_skips_non_dict_items_in_input | Tests that non-dict items (strings, integers, None) in input_items are skipped. Covers line 49. | That the function gracefully handles invalid item types without crashing. | Pipe._maybe_apply_anthropic_prompt_caching | pipe_instance fixture | Asserts cache_control added only to valid dict message | low | yes | Tests input validation robustness | |
| test_skips_non_message_type_items | Tests that items with type != "message" are skipped. Covers line 51. | That only message-type items are processed for caching. | Pipe._maybe_apply_anthropic_prompt_caching | pipe_instance fixture | Asserts tool_call and function_call types ignored, only message processed | low | yes | Tests type filtering logic | |
| test_caches_third_user_message_when_more_than_two | Tests that when > 2 user messages exist, the third-to-last gets cached. Covers line 66. | That all three most recent user messages receive cache_control when available. | Pipe._maybe_apply_anthropic_prompt_caching | pipe_instance fixture | Asserts system + 3 user messages cached, assistant messages not cached | low | yes | Tests multi-turn conversation caching | |
| test_seen_set_prevents_duplicate_processing | Tests the defensive seen set logic (line 71). Documents that duplicates don't occur in normal paths. | That the defensive check for duplicate indices works correctly. | Pipe._maybe_apply_anthropic_prompt_caching | pipe_instance fixture | Asserts single user message cached only once | low | yes | Documents defensive code that's unreachable in practice | |
| test_skips_messages_with_invalid_content | Tests that messages with non-list or empty content are skipped. Covers line 76. | That content validation prevents processing of malformed messages. | Pipe._maybe_apply_anthropic_prompt_caching | pipe_instance fixture | Asserts string/None/empty content unchanged, only valid list processed | low | yes | Tests content structure validation | |
| test_skips_non_dict_blocks_in_content | Tests that non-dict blocks in content are skipped during reversed iteration. Covers line 79. | That content blocks must be dicts to receive cache_control. | Pipe._maybe_apply_anthropic_prompt_caching | pipe_instance fixture | Asserts valid block cached, string block unchanged | low | yes | Tests reversed() iteration with mixed types | |
| test_skips_blocks_with_wrong_type | Tests that blocks with type != "input_text" are skipped. Covers line 81. | That only input_text blocks receive cache_control. | Pipe._maybe_apply_anthropic_prompt_caching | pipe_instance fixture | Asserts input_text cached, image/file blocks not cached | low | yes | Tests block type filtering | |
| test_skips_blocks_with_invalid_text | Tests that blocks with non-string or empty text are skipped. Covers line 84. | That text field validation prevents caching malformed blocks. | Pipe._maybe_apply_anthropic_prompt_caching | pipe_instance fixture | Asserts only block with valid string text cached, None/empty/int skipped | low | yes | Tests text field validation | |
| test_existing_cache_control_with_ttl_not_overwritten | Tests that existing cache_control with ttl is preserved. Covers lines 88-90. | That existing cache_control settings are respected and not overwritten. | Pipe._maybe_apply_anthropic_prompt_caching | pipe_instance fixture | Asserts original 10m ttl preserved, not replaced with 5m | low | yes | Tests idempotency and respect for existing config | |
| test_existing_cache_control_without_ttl_gets_ttl_added | Tests that existing cache_control without ttl gets ttl merged in. Covers lines 88-90. | That ttl is added to incomplete existing cache_control. | Pipe._maybe_apply_anthropic_prompt_caching | pipe_instance fixture | Asserts ttl: "5m" added to existing {type: ephemeral} | low | yes | Tests ttl merge behavior | |
| test_existing_cache_control_non_dict_is_not_modified | Tests that non-dict existing cache_control is preserved as-is. Covers lines 88-90 branch. | That malformed cache_control values are left unchanged. | Pipe._maybe_apply_anthropic_prompt_caching | pipe_instance fixture | Asserts "not a dict" string preserved unchanged | low | yes | Tests defensive handling of malformed data | |
| test_non_anthropic_model_skipped | Tests that non-Anthropic models don't receive cache_control. | That model ID filtering prevents caching for non-Anthropic providers. | Pipe._maybe_apply_anthropic_prompt_caching | pipe_instance fixture | Asserts no cache_control added for openai/gpt-4o | low | yes | Tests provider filtering logic | |
| test_developer_role_treated_as_system | Tests that developer role messages are cached like system messages. | That developer role is treated equivalently to system role. | Pipe._maybe_apply_anthropic_prompt_caching | pipe_instance fixture | Asserts both developer and user messages cached | low | yes | Tests role equivalence mapping | |
| test_empty_ttl_omits_ttl_field | Tests that empty TTL string results in no ttl field in cache_control. | That empty string TTL is treated as omitted/unset. | Pipe._maybe_apply_anthropic_prompt_caching | pipe_instance fixture | Asserts cache_control has only type, no ttl field | low | yes | Tests optional field handling | |
| test_non_string_ttl_omits_ttl_field | Tests that non-string TTL (integer) results in no ttl field. | That TTL type validation prevents invalid values. | Pipe._maybe_apply_anthropic_prompt_caching | pipe_instance fixture | Asserts integer 300 ignored, only type field present | low | yes | Tests type validation for TTL | |
| test_caches_last_input_text_block_in_content | Tests that only the last input_text block in content gets cached. | That reversed iteration finds the correct block to cache. | Pipe._maybe_apply_anthropic_prompt_caching | pipe_instance fixture | Asserts only 5th block (last input_text) cached, not 1st or 3rd | low | yes | Tests reversed() iteration logic | |
| test_anthropic_model_with_dot_prefix | Tests that models with "anthropic." prefix are recognized. | That both slash and dot separators work for provider detection. | Pipe._maybe_apply_anthropic_prompt_caching | pipe_instance fixture | Asserts anthropic.claude-3-opus recognized and cached | low | yes | Tests alternative model ID format | |
| test_is_anthropic_model_id_with_non_string | Tests _is_anthropic_model_id returns False for non-string inputs. | That model ID validation handles type errors gracefully. | Pipe._is_anthropic_model_id | None (static method) | Asserts None/int/list/dict all return False | low | yes | Tests input type validation | |
| test_is_anthropic_model_id_with_whitespace | Tests _is_anthropic_model_id handles whitespace correctly. | That model ID matching is whitespace-tolerant. | Pipe._is_anthropic_model_id | None (static method) | Asserts whitespace-padded model IDs return True | low | yes | Tests string normalization | |
| test_message_with_none_role | Tests that messages with None or missing role are handled gracefully. | That role field validation prevents crashes on malformed data. | Pipe._maybe_apply_anthropic_prompt_caching | pipe_instance fixture | Asserts None role and missing role skipped, only valid user cached | low | yes | Tests missing field handling | |
| test_prompt_caching_via_transform_messages | Integration test for prompt caching through transform_messages_to_input. | That caching works end-to-end through the transform pipeline. | Pipe.transform_messages_to_input, Pipe._maybe_apply_anthropic_prompt_caching | pipe_instance_async fixture | Asserts cache_control present and 4 messages cached (1 system + 3 user) | med | yes | Integration test with full pipeline | |
| test_anthropic_prompt_caching_inserts_breakpoints | Tests that cache breakpoints are inserted at correct positions for Anthropic models. | That system and last two user messages get cache_control, assistant does not. | Pipe.transform_messages_to_input, Pipe._maybe_apply_anthropic_prompt_caching | pipe_instance_async fixture | Asserts system[-1] and user[-1,-2] have cache_control, assistant[-1] does not | med | yes | Integration test from legacy test file | |
| test_non_anthropic_models_do_not_insert_cache_control | Tests that non-Anthropic models don't get cache_control through transform_messages_to_input. | That provider filtering works in the full pipeline. | Pipe.transform_messages_to_input | pipe_instance_async fixture | Asserts no cache_control in input_items for openai/gpt-5.1 | med | yes | Integration test for negative case | |
| test_strip_cache_control_from_input_removes_markers | Tests that _strip_cache_control_from_input removes cache_control markers. | That cache_control cleanup function works correctly. | Pipe._strip_cache_control_from_input, Pipe._input_contains_cache_control | None (static methods) | Asserts cache_control detected then removed and no longer detected | low | yes | Tests cleanup utility function | |
| test_anthropic_prompt_caching_applied_to_existing_input | Tests that prompt caching is applied when input already exists in ResponsesBody. | That caching works with pre-built input arrays in streaming requests. | Pipe._run_streaming_loop, Pipe._maybe_apply_anthropic_prompt_caching | pipe_instance_async, monkeypatch (fake_stream) | Asserts cache_control present in captured request_body.input | high | yes | Tests streaming integration with mocked HTTP layer | |


## `tests/test_api_transforms.py`

| Test Name | Description | What It Tests | Code Under Test | Mocks/Fixtures | Assertions | Drift Risk | Check Done | Codex Notes | Codex TODO |
|-----------|-------------|---------------|-----------------|----------------|------------|------------|------------|-------------|------------|
| test_removes_unknown_keys | Unknown keys filtered from request | _filter_openrouter_request removes unknown keys from payload | _filter_openrouter_request() | None | Checks unknown keys not in result | LOW | YES | Validates request sanitization | None |
| test_preserves_valid_keys | Valid Responses API keys preserved | _filter_openrouter_request keeps valid fields | _filter_openrouter_request() | None | Checks valid keys preserved with correct values | LOW | YES | Core filtering functionality | None |
| test_handles_empty_payload | Empty payload handling | _filter_openrouter_request with empty dict | _filter_openrouter_request() | None | Result equals empty dict | LOW | YES | Edge case coverage | None |
| test_handles_non_dict | Non-dict input raises ValueError | _filter_openrouter_request with string input | _filter_openrouter_request() | None | Raises ValueError | LOW | YES | Input validation | None |
| test_null_values_dropped | Explicit null values dropped | _filter_openrouter_request removes None values | _filter_openrouter_request() | None | temperature not in result | LOW | YES | Null filtering | None |
| test_top_k_int_converted_to_float | top_k integer to float conversion | _filter_openrouter_request converts int to float | _filter_openrouter_request() | None | top_k is 10.0 and isinstance float | LOW | YES | Type coercion | None |
| test_top_k_string_converted | top_k string to float conversion | _filter_openrouter_request converts string to float | _filter_openrouter_request() | None | top_k equals 5.0 | LOW | YES | String parsing | None |
| test_top_k_empty_string_dropped | top_k empty string dropped | _filter_openrouter_request removes whitespace strings | _filter_openrouter_request() | None | top_k not in result | LOW | YES | Empty value handling | None |
| test_top_k_invalid_string_dropped | top_k invalid string dropped | _filter_openrouter_request removes unparseable strings | _filter_openrouter_request() | None | top_k not in result | LOW | YES | Invalid value handling | None |
| test_metadata_sanitized | Metadata sanitization | _filter_openrouter_request sanitizes metadata dict | _filter_openrouter_request() | None | metadata contains only valid keys | MEDIUM | YES | Calls _sanitize_openrouter_metadata | None |
| test_metadata_invalid_dropped | Invalid metadata dropped | _filter_openrouter_request removes non-dict metadata | _filter_openrouter_request() | None | metadata not in result | LOW | YES | Type validation | None |
| test_reasoning_filtered | Reasoning dict filtered | _filter_openrouter_request filters reasoning to allowed fields | _filter_openrouter_request() | None | Only allowed reasoning fields present | MEDIUM | YES | Field whitelisting | None |
| test_reasoning_non_dict_dropped | Non-dict reasoning dropped | _filter_openrouter_request removes non-dict reasoning | _filter_openrouter_request() | None | reasoning not in result | LOW | YES | Type validation | None |
| test_reasoning_empty_dropped | Empty reasoning dropped | _filter_openrouter_request removes empty reasoning dict | _filter_openrouter_request() | None | reasoning not in result | LOW | YES | Empty dict handling | None |
| test_text_non_dict_dropped | Non-dict text dropped | _filter_openrouter_request removes non-dict text | _filter_openrouter_request() | None | text not in result | LOW | YES | Type validation | None |
| test_text_empty_dropped | Empty text dict dropped | _filter_openrouter_request removes empty text dict | _filter_openrouter_request() | None | text not in result | LOW | YES | Empty dict handling | None |
| test_removes_responses_only_keys | Responses-only keys filtered from chat | _filter_openrouter_chat_request removes Responses API fields | _filter_openrouter_chat_request() | None | input, instructions not in result | MEDIUM | YES | API format separation | None |
| test_preserves_chat_keys | Chat Completions keys preserved | _filter_openrouter_chat_request keeps chat fields | _filter_openrouter_chat_request() | None | messages, model, temperature preserved | LOW | YES | Chat API filtering | None |
| test_non_dict_returns_empty | Non-dict input returns empty dict | _filter_openrouter_chat_request with invalid input | _filter_openrouter_chat_request() | None | Returns empty dict for non-dict | LOW | YES | Graceful error handling | None |
| test_preserves_allowed_fields | Allowed chat fields preserved | _filter_openrouter_chat_request preserves valid fields | _filter_openrouter_chat_request() | None | All valid fields present | LOW | YES | Field whitelisting | None |
| test_removes_unknown_fields | Unknown chat fields removed | _filter_openrouter_chat_request removes unknown fields | _filter_openrouter_chat_request() | None | Unknown fields not in result | LOW | YES | Field filtering | None |
| test_converts_input_to_messages | input array to messages conversion | _responses_payload_to_chat_completions_payload converts input | _responses_payload_to_chat_completions_payload() | None | messages present with correct structure | HIGH | YES | Core API transformation | None |
| test_converts_instructions_to_system | instructions to system message | _responses_payload_to_chat_completions_payload converts instructions | _responses_payload_to_chat_completions_payload() | None | First message is system with instructions | MEDIUM | YES | System prompt handling | None |
| test_converts_max_output_tokens | max_output_tokens to max_tokens | _responses_payload_to_chat_completions_payload field rename | _responses_payload_to_chat_completions_payload() | None | max_tokens equals 500, max_output_tokens not present | MEDIUM | YES | Field name mapping | None |
| test_converts_tools | Responses tools to Chat tools | _responses_payload_to_chat_completions_payload converts tools | _responses_payload_to_chat_completions_payload() | None | Tools in Chat format with function wrapper | HIGH | YES | Tool format conversion | None |
| test_sets_stream_options | Stream options set for streaming | _responses_payload_to_chat_completions_payload adds stream_options | _responses_payload_to_chat_completions_payload() | None | stream_options.include_usage is True | MEDIUM | YES | Streaming configuration | None |
| test_rounds_top_k | top_k rounded to integer | _responses_payload_to_chat_completions_payload rounds float | _responses_payload_to_chat_completions_payload() | None | top_k equals 3 (rounded from 2.7) | LOW | YES | Numeric rounding | None |
| test_preserves_cache_control | cache_control preserved in blocks | _responses_payload_to_chat_completions_payload preserves cache_control | _responses_payload_to_chat_completions_payload() | None | cache_control present in text block | HIGH | YES | Anthropic-specific feature | Verify OpenRouter support |
| test_non_dict_returns_empty | Non-dict input returns empty | _responses_payload_to_chat_completions_payload error handling | _responses_payload_to_chat_completions_payload() | None | Returns empty dict | LOW | YES | Input validation | None |
| test_non_streaming_no_stream_options | Non-streaming no stream_options | _responses_payload_to_chat_completions_payload stream handling | _responses_payload_to_chat_completions_payload() | None | stream_options not present when stream=False | LOW | YES | Conditional field addition | None |
| test_existing_stream_options_preserved | Existing stream_options merged | _responses_payload_to_chat_completions_payload preserves custom options | _responses_payload_to_chat_completions_payload() | None | Custom and default options both present | MEDIUM | YES | Option merging | None |
| test_existing_usage_merged | Existing usage merged with include | _responses_payload_to_chat_completions_payload usage handling | _responses_payload_to_chat_completions_payload() | None | Custom usage field and include=True | MEDIUM | YES | Usage tracking | None |
| test_int_params_rounded | Integer params rounded | _responses_payload_to_chat_completions_payload rounds int params | _responses_payload_to_chat_completions_payload() | None | top_k=3, seed=10 from floats | LOW | YES | Multiple param rounding | None |
| test_int_param_string_converted | String integer params converted | _responses_payload_to_chat_completions_payload parses strings | _responses_payload_to_chat_completions_payload() | None | top_k equals 5 from "5" | LOW | YES | String to int conversion | None |
| test_int_param_empty_string_removed | Empty string params removed | _responses_payload_to_chat_completions_payload removes empty strings | _responses_payload_to_chat_completions_payload() | None | top_k not in result | LOW | YES | Empty string handling | None |
| test_invalid_response_format_removed | Invalid response_format removed | _responses_payload_to_chat_completions_payload validates format | _responses_payload_to_chat_completions_payload() | caplog | response_format not in result, warning logged | MEDIUM | YES | Format validation | None |
| test_text_format_mapped_to_response_format | text.format to response_format | _responses_payload_to_chat_completions_payload maps text.format | _responses_payload_to_chat_completions_payload() | None | response_format has type json_object | MEDIUM | YES | Format field mapping | None |
| test_text_verbosity_preserved | text.verbosity mapped | _responses_payload_to_chat_completions_payload preserves verbosity | _responses_payload_to_chat_completions_payload() | None | verbosity field present | LOW | YES | Verbosity handling | None |
| test_instructions_prepended_to_existing_system | Instructions prepended to system | _responses_payload_to_chat_completions_payload merges instructions | _responses_payload_to_chat_completions_payload() | None | Both instructions and existing prompt in system | MEDIUM | YES | System message merging | None |
| test_instructions_prepended_to_list_content | Instructions with list content | _responses_payload_to_chat_completions_payload list merging | _responses_payload_to_chat_completions_payload() | None | Instructions as first block in list | MEDIUM | YES | Content block handling | None |
| test_instructions_with_no_messages | Instructions create system message | _responses_payload_to_chat_completions_payload creates system | _responses_payload_to_chat_completions_payload() | None | System message created with instructions | LOW | YES | Message creation | None |
| test_instructions_with_non_system_first_message | Instructions prepended when first not system | _responses_payload_to_chat_completions_payload inserts system | _responses_payload_to_chat_completions_payload() | None | System first, user second | MEDIUM | YES | Message ordering | None |
| test_converts_format | Responses tools to Chat wrapped format | _responses_tools_to_chat_tools wraps in function | _responses_tools_to_chat_tools() | None | Tool has function wrapper with name | HIGH | YES | Tool wrapping | None |
| test_skips_wrapped_format | Already wrapped tools skipped | _responses_tools_to_chat_tools detects wrapped format | _responses_tools_to_chat_tools() | None | Returns empty list (no name at top level) | MEDIUM | YES | Prevents double-wrapping | None |
| test_handles_empty | Empty tools list handling | _responses_tools_to_chat_tools with empty/None | _responses_tools_to_chat_tools() | None | Returns empty list | LOW | YES | Edge case | None |
| test_non_list_returns_empty | Non-list input returns empty | _responses_tools_to_chat_tools type validation | _responses_tools_to_chat_tools() | None | Returns empty for non-list | LOW | YES | Input validation | None |
| test_non_dict_items_skipped | Non-dict items skipped | _responses_tools_to_chat_tools filters non-dicts | _responses_tools_to_chat_tools() | None | Only dict item converted | LOW | YES | Item filtering | None |
| test_non_function_type_skipped | Non-function types skipped | _responses_tools_to_chat_tools type filtering | _responses_tools_to_chat_tools() | None | Only type=function converted | MEDIUM | YES | Type validation | None |
| test_whitespace_name_skipped | Whitespace-only names skipped | _responses_tools_to_chat_tools name validation | _responses_tools_to_chat_tools() | None | Empty name tool skipped | LOW | YES | Name validation | None |
| test_description_preserved | Tool description preserved | _responses_tools_to_chat_tools copies description | _responses_tools_to_chat_tools() | None | Description in function block | LOW | YES | Field copying | None |
| test_parameters_preserved | Tool parameters preserved | _responses_tools_to_chat_tools copies parameters | _responses_tools_to_chat_tools() | None | Parameters in function block | LOW | YES | Field copying | None |
| test_unwraps | Chat tools unwrapped to Responses | _chat_tools_to_responses_tools unwraps function | _chat_tools_to_responses_tools() | None | Name at top level, no function wrapper | HIGH | YES | Tool unwrapping | None |
| test_handles_already_flat | Already flat tools preserved | _chat_tools_to_responses_tools handles flat format | _chat_tools_to_responses_tools() | None | Flat format preserved | MEDIUM | YES | Format detection | None |
| test_non_list_returns_empty | Non-list input returns empty | _chat_tools_to_responses_tools type validation | _chat_tools_to_responses_tools() | None | Returns empty for non-list | LOW | YES | Input validation | None |
| test_non_dict_items_skipped | Non-dict items skipped | _chat_tools_to_responses_tools filters items | _chat_tools_to_responses_tools() | None | Returns empty when all invalid | LOW | YES | Item filtering | None |
| test_non_function_type_skipped | Non-function types skipped | _chat_tools_to_responses_tools type filtering | _chat_tools_to_responses_tools() | None | type!=function skipped | MEDIUM | YES | Type validation | None |
| test_name_from_function_block | Name extracted from function block | _chat_tools_to_responses_tools extracts nested name | _chat_tools_to_responses_tools() | None | Name from function.name | MEDIUM | YES | Field extraction | None |
| test_description_from_function_block | Description from function block | _chat_tools_to_responses_tools extracts description | _chat_tools_to_responses_tools() | None | Description from function block | LOW | YES | Field extraction | None |
| test_top_level_description_preferred | Top-level description preferred | _chat_tools_to_responses_tools prefers top-level | _chat_tools_to_responses_tools() | None | Top-level description used | MEDIUM | YES | Field precedence | None |
| test_parameters_from_function_block | Parameters from function block | _chat_tools_to_responses_tools extracts parameters | _chat_tools_to_responses_tools() | None | Parameters extracted | LOW | YES | Field extraction | None |
| test_empty_description_not_included | Empty description not included | _chat_tools_to_responses_tools filters empty | _chat_tools_to_responses_tools() | None | description not in result | LOW | YES | Empty field filtering | None |
| test_string_values | String tool_choice preserved | _responses_tool_choice_to_chat_tool_choice preserves strings | _responses_tool_choice_to_chat_tool_choice() | None | auto, none, required unchanged | LOW | YES | String passthrough | None |
| test_dict_converted | Dict tool_choice converted | _responses_tool_choice_to_chat_tool_choice wraps dict | _responses_tool_choice_to_chat_tool_choice() | None | Dict wrapped with function.name | MEDIUM | YES | Choice wrapping | None |
| test_none_returns_none | None returns None | _responses_tool_choice_to_chat_tool_choice None handling | _responses_tool_choice_to_chat_tool_choice() | None | Returns None | LOW | YES | Null handling | None |
| test_non_dict_non_string_returned_as_is | Invalid types returned as-is | _responses_tool_choice_to_chat_tool_choice passthrough | _responses_tool_choice_to_chat_tool_choice() | None | Returns input unchanged | LOW | YES | Graceful handling | None |
| test_dict_without_function_type | Non-function dict returned as-is | _responses_tool_choice_to_chat_tool_choice type check | _responses_tool_choice_to_chat_tool_choice() | None | Returns input unchanged | LOW | YES | Type filtering | None |
| test_dict_with_function_block_name | Function block name extracted | _responses_tool_choice_to_chat_tool_choice nested extraction | _responses_tool_choice_to_chat_tool_choice() | None | Name from function.name | MEDIUM | YES | Nested field handling | None |
| test_dict_with_empty_function_name | Empty function name returns as-is | _responses_tool_choice_to_chat_tool_choice validation | _responses_tool_choice_to_chat_tool_choice() | None | Returns input unchanged | LOW | YES | Name validation | None |
| test_text_converts | Text format conversion | _chat_response_format_to_responses_text_format text type | _chat_response_format_to_responses_text_format() | None | type=text preserved | LOW | YES | Format conversion | None |
| test_json_object_converts | JSON object format conversion | _chat_response_format_to_responses_text_format json_object | _chat_response_format_to_responses_text_format() | None | type=json_object preserved | MEDIUM | YES | Format conversion | None |
| test_json_schema_converts | JSON schema format conversion | _chat_response_format_to_responses_text_format json_schema | _chat_response_format_to_responses_text_format() | None | Schema extracted to top level | HIGH | YES | Complex format handling | None |
| test_non_dict_returns_none | Non-dict returns None | _chat_response_format_to_responses_text_format validation | _chat_response_format_to_responses_text_format() | None | Returns None for non-dict | LOW | YES | Input validation | None |
| test_unknown_type_returns_none | Unknown type returns None | _chat_response_format_to_responses_text_format type validation | _chat_response_format_to_responses_text_format() | None | Returns None for unknown type | MEDIUM | YES | Type validation | None |
| test_json_schema_without_json_schema_key | Missing json_schema key returns None | _chat_response_format_to_responses_text_format validation | _chat_response_format_to_responses_text_format() | None | Returns None | MEDIUM | YES | Schema validation | None |
| test_json_schema_with_non_dict_json_schema | Non-dict json_schema returns None | _chat_response_format_to_responses_text_format type check | _chat_response_format_to_responses_text_format() | None | Returns None | LOW | YES | Type validation | None |
| test_json_schema_without_name | Schema without name returns None | _chat_response_format_to_responses_text_format validation | _chat_response_format_to_responses_text_format() | None | Returns None | MEDIUM | YES | Required field check | None |
| test_json_schema_with_empty_name | Empty schema name returns None | _chat_response_format_to_responses_text_format validation | _chat_response_format_to_responses_text_format() | None | Returns None for whitespace | LOW | YES | Name validation | None |
| test_json_schema_without_schema | Schema without schema field returns None | _chat_response_format_to_responses_text_format validation | _chat_response_format_to_responses_text_format() | None | Returns None | MEDIUM | YES | Required field check | None |
| test_json_schema_with_description | Schema description preserved | _chat_response_format_to_responses_text_format field copy | _chat_response_format_to_responses_text_format() | None | Description in result | LOW | YES | Optional field handling | None |
| test_json_schema_with_strict | Schema strict flag preserved | _chat_response_format_to_responses_text_format field copy | _chat_response_format_to_responses_text_format() | None | strict=True in result | MEDIUM | YES | Flag preservation | None |
| test_reverses | Responses format to Chat format | _responses_text_format_to_chat_response_format reverse transform | _responses_text_format_to_chat_response_format() | None | json_schema wrapped | HIGH | YES | Reverse transformation | None |
| test_non_dict_returns_none | Non-dict returns None | _responses_text_format_to_chat_response_format validation | _responses_text_format_to_chat_response_format() | None | Returns None | LOW | YES | Input validation | None |
| test_unknown_type_returns_none | Unknown type returns None | _responses_text_format_to_chat_response_format type validation | _responses_text_format_to_chat_response_format() | None | Returns None | MEDIUM | YES | Type validation | None |
| test_json_schema_without_name | Schema without name returns None | _responses_text_format_to_chat_response_format validation | _responses_text_format_to_chat_response_format() | None | Returns None | MEDIUM | YES | Required field check | None |
| test_json_schema_without_schema | Schema without schema returns None | _responses_text_format_to_chat_response_format validation | _responses_text_format_to_chat_response_format() | None | Returns None | MEDIUM | YES | Required field check | None |
| test_json_schema_with_description | Schema description preserved | _responses_text_format_to_chat_response_format field copy | _responses_text_format_to_chat_response_format() | None | Description in json_schema block | LOW | YES | Optional field handling | None |
| test_json_schema_with_strict | Schema strict preserved | _responses_text_format_to_chat_response_format field copy | _responses_text_format_to_chat_response_format() | None | strict in json_schema block | MEDIUM | YES | Flag preservation | None |
| test_non_dict_is_noop | Non-dict is no-op | _normalise_openrouter_responses_text_format type handling | _normalise_openrouter_responses_text_format() | None | No exception raised | LOW | YES | Graceful handling | None |
| test_removes_response_format_when_no_text | Invalid response_format removed | _normalise_openrouter_responses_text_format validation | _normalise_openrouter_responses_text_format() | None | response_format not in payload | MEDIUM | YES | Invalid format removal | None |
| test_migrates_response_format_to_text | response_format migrated to text.format | _normalise_openrouter_responses_text_format migration | _normalise_openrouter_responses_text_format() | None | text.format has response_format value | HIGH | YES | Format migration | None |
| test_existing_text_format_preferred | Existing text.format preferred | _normalise_openrouter_responses_text_format precedence | _normalise_openrouter_responses_text_format() | None | text.format unchanged | MEDIUM | YES | Field precedence | None |
| test_invalid_text_format_dropped | Invalid text.format dropped | _normalise_openrouter_responses_text_format validation | _normalise_openrouter_responses_text_format() | caplog | format not in text, warning logged | MEDIUM | YES | Format validation | None |
| test_empty_text_removed_when_no_format | Empty text dict removed | _normalise_openrouter_responses_text_format cleanup | _normalise_openrouter_responses_text_format() | None | text not in payload | LOW | YES | Empty dict removal | None |
| test_non_dict_text_with_response_format | Non-dict text replaced | _normalise_openrouter_responses_text_format type correction | _normalise_openrouter_responses_text_format() | None | text is dict with format | MEDIUM | YES | Type correction | None |
| test_non_dict_text_without_response_format | Non-dict text preserved when no migration | _normalise_openrouter_responses_text_format preservation | _normalise_openrouter_responses_text_format() | None | Early return, text unchanged | LOW | YES | Conditional handling | None |
| test_handles_user_message | User message conversion | _responses_input_to_chat_messages user role | _responses_input_to_chat_messages() | None | Role=user, content as text blocks | HIGH | YES | Message conversion | None |
| test_handles_assistant_message | Assistant message conversion | _responses_input_to_chat_messages assistant role | _responses_input_to_chat_messages() | None | Role=assistant, output_text to text | HIGH | YES | Message conversion | None |
| test_handles_system_message | System message conversion | _responses_input_to_chat_messages system role | _responses_input_to_chat_messages() | None | Role=system, content blocks | MEDIUM | YES | Message conversion | None |
| test_handles_image_content | Image content block conversion | _responses_input_to_chat_messages input_image | _responses_input_to_chat_messages() | None | image_url block present | HIGH | YES | Multimodal support | None |
| test_handles_function_call_output | Function call output to tool message | _responses_input_to_chat_messages function_call_output | _responses_input_to_chat_messages() | None | Role=tool, tool_call_id set | HIGH | YES | Tool result conversion | None |
| test_handles_function_call | Function call to tool_calls | _responses_input_to_chat_messages function_call | _responses_input_to_chat_messages() | None | Role=assistant, tool_calls present | HIGH | YES | Tool call conversion | None |
| test_handles_empty | Empty input handling | _responses_input_to_chat_messages with empty/None | _responses_input_to_chat_messages() | None | Returns empty list | LOW | YES | Edge case | None |
| test_string_input | String input to user message | _responses_input_to_chat_messages string conversion | _responses_input_to_chat_messages() | None | User message with string content | MEDIUM | YES | Simple input handling | None |
| test_empty_string_input | Empty string returns empty | _responses_input_to_chat_messages whitespace handling | _responses_input_to_chat_messages() | None | Returns empty list | LOW | YES | Empty input handling | None |
| test_non_list_non_string_returns_empty | Invalid input returns empty | _responses_input_to_chat_messages type validation | _responses_input_to_chat_messages() | None | Returns empty for invalid types | LOW | YES | Input validation | None |
| test_non_dict_items_skipped | Non-dict items skipped | _responses_input_to_chat_messages item filtering | _responses_input_to_chat_messages() | None | Only dict item converted | LOW | YES | Item filtering | None |
| test_message_without_role_skipped | Messages without role skipped | _responses_input_to_chat_messages role validation | _responses_input_to_chat_messages() | None | Returns empty when no role | MEDIUM | YES | Role requirement | None |
| test_message_with_string_content | String content handling | _responses_input_to_chat_messages simple content | _responses_input_to_chat_messages() | None | String content preserved | LOW | YES | Content type handling | None |
| test_message_with_annotations | Annotations preserved | _responses_input_to_chat_messages annotation copy | _responses_input_to_chat_messages() | None | annotations in message | MEDIUM | YES | Metadata preservation | Verify OpenRouter support |
| test_message_with_reasoning_details | Reasoning details preserved | _responses_input_to_chat_messages reasoning copy | _responses_input_to_chat_messages() | None | reasoning_details in message | MEDIUM | YES | Reasoning metadata | Verify OpenRouter support |
| test_image_url_block_dict | image_url block with dict | _responses_input_to_chat_messages image_url dict | _responses_input_to_chat_messages() | None | image_url.url set | MEDIUM | YES | Image URL handling | None |
| test_image_url_block_string | image_url block with string | _responses_input_to_chat_messages image_url string | _responses_input_to_chat_messages() | None | String wrapped in {url: ...} | MEDIUM | YES | Image URL normalization | None |
| test_input_image_with_detail | input_image with detail setting | _responses_input_to_chat_messages image detail | _responses_input_to_chat_messages() | None | detail field preserved | MEDIUM | YES | Image quality control | None |
| test_input_audio_block | input_audio block conversion | _responses_input_to_chat_messages audio support | _responses_input_to_chat_messages() | None | input_audio block present | HIGH | YES | Audio input support | Verify OpenRouter support |
| test_video_url_block_dict | video_url block with dict | _responses_input_to_chat_messages video dict | _responses_input_to_chat_messages() | None | video_url block with dict | MEDIUM | YES | Video URL handling | Verify OpenRouter support |
| test_video_url_block_string | video_url block with string | _responses_input_to_chat_messages video string | _responses_input_to_chat_messages() | None | String wrapped in {url: ...} | MEDIUM | YES | Video URL normalization | Verify OpenRouter support |
| test_input_file_block_with_data | input_file with file_data | _responses_input_to_chat_messages file data | _responses_input_to_chat_messages() | None | file block with file_data | MEDIUM | YES | File upload support | Verify OpenRouter support |
| test_input_file_block_with_url | input_file with file_url | _responses_input_to_chat_messages file URL | _responses_input_to_chat_messages() | None | file_url mapped to file_data | MEDIUM | YES | File URL handling | Verify OpenRouter support |
| test_empty_content_blocks | Empty content blocks list | _responses_input_to_chat_messages empty content | _responses_input_to_chat_messages() | None | Content becomes empty string | LOW | YES | Empty content handling | None |
| test_function_call_output_non_string_output | Non-string output JSON-serialized | _responses_input_to_chat_messages output serialization | _responses_input_to_chat_messages() | None | Dict output becomes JSON string | MEDIUM | YES | Output serialization | None |
| test_function_call_output_none_output | None output handling | _responses_input_to_chat_messages None output | _responses_input_to_chat_messages() | None | Content becomes empty string | LOW | YES | Null output handling | None |
| test_function_call_with_call_id | call_id field support | _responses_input_to_chat_messages call_id vs id | _responses_input_to_chat_messages() | None | call_id used as tool_call id | MEDIUM | YES | ID field variants | None |
| test_function_call_non_string_arguments | Non-string arguments serialized | _responses_input_to_chat_messages args serialization | _responses_input_to_chat_messages() | None | Dict args become JSON string | MEDIUM | YES | Argument serialization | None |
| test_function_call_none_arguments | None arguments default to {} | _responses_input_to_chat_messages None args | _responses_input_to_chat_messages() | None | arguments becomes "{}" | LOW | YES | Null argument handling | None |
| test_function_call_missing_required_fields | Missing required fields skipped | _responses_input_to_chat_messages field validation | _responses_input_to_chat_messages() | None | Returns empty for missing id/name | MEDIUM | YES | Required field validation | None |
| test_with_dict | Dict input passthrough | _model_params_to_dict with dict | _model_params_to_dict() | None | Returns input dict | LOW | YES | Normal case | None |
| test_with_non_dict | Non-dict returns empty | _model_params_to_dict type handling | _model_params_to_dict() | None | Returns {} for non-dict | LOW | YES | Type validation | None |
| test_returns_bool | Boolean extraction | _get_disable_param gets bool flags | _get_disable_param() | None | Returns correct bool values | MEDIUM | YES | Flag extraction | None |
| test_non_dict | Non-dict returns False | _get_disable_param type handling | _get_disable_param() | None | Returns False for non-dict | LOW | YES | Type validation | None |
| test_from_custom_params | Get from custom_params | _get_disable_param custom_params source | _get_disable_param() | None | Finds flag in custom_params | MEDIUM | YES | Nested param search | None |
| test_from_openrouter_pipe_container | Get from openrouter_pipe | _get_disable_param openrouter_pipe source | _get_disable_param() | None | Finds flag in openrouter_pipe | MEDIUM | YES | Nested param search | None |
| test_from_openrouter_container | Get from openrouter | _get_disable_param openrouter source | _get_disable_param() | None | Finds flag in openrouter | MEDIUM | YES | Nested param search | None |
| test_from_pipe_container | Get from pipe | _get_disable_param pipe source | _get_disable_param() | None | Finds flag in pipe | MEDIUM | YES | Nested param search | None |
| test_from_nested_custom_params_container | Get from nested custom_params.openrouter_pipe | _get_disable_param nested search | _get_disable_param() | None | Finds flag in nested structure | MEDIUM | YES | Deep nesting support | None |
| test_object_with_model_dump | Object with model_dump() | _get_disable_param Pydantic object | _get_disable_param() | None | Calls model_dump() to get dict | MEDIUM | YES | Pydantic support | None |
| test_object_model_dump_exception | model_dump() exception handling | _get_disable_param error handling | _get_disable_param() | None | Returns False on exception | LOW | YES | Error handling | None |
| test_with_valid_dict | Valid metadata dict | _sanitize_openrouter_metadata string pairs | _sanitize_openrouter_metadata() | None | String-string pairs preserved | MEDIUM | YES | Metadata filtering | None |
| test_filters_none_values | None values filtered | _sanitize_openrouter_metadata None removal | _sanitize_openrouter_metadata() | None | None values not in result | LOW | YES | Null filtering | None |
| test_non_dict | Non-dict returns None | _sanitize_openrouter_metadata type validation | _sanitize_openrouter_metadata() | None | Returns None for non-dict | LOW | YES | Input validation | None |
| test_max_pairs_limit | Max 16 pairs allowed | _sanitize_openrouter_metadata limit enforcement | _sanitize_openrouter_metadata() | None | Result has 16 pairs max | HIGH | YES | OpenRouter API limit | Check current limit |
| test_long_key_filtered | Long keys filtered | _sanitize_openrouter_metadata key length limit | _sanitize_openrouter_metadata() | None | Keys >64 chars removed | MEDIUM | YES | Key length validation | Check current limit |
| test_long_value_filtered | Long values filtered | _sanitize_openrouter_metadata value length limit | _sanitize_openrouter_metadata() | None | Values >512 chars removed | MEDIUM | YES | Value length validation | Check current limit |
| test_brackets_in_key_filtered | Bracket keys filtered | _sanitize_openrouter_metadata key character validation | _sanitize_openrouter_metadata() | None | Keys with [] removed | MEDIUM | YES | Character validation | None |
| test_all_invalid_returns_none | All invalid returns None | _sanitize_openrouter_metadata empty result handling | _sanitize_openrouter_metadata() | None | Returns None when all filtered | LOW | YES | Empty result handling | None |
| test_removes_disable_params | Disable params removed | _strip_disable_model_settings_params removes flags | _strip_disable_model_settings_params() | None | All disable_* params removed | MEDIUM | YES | Control flag cleanup | None |
| test_non_dict_is_noop | Non-dict is no-op | _strip_disable_model_settings_params type handling | _strip_disable_model_settings_params() | None | No exception raised | LOW | YES | Graceful handling | None |
| test_non_dict_is_noop | Non-dict is no-op | _apply_model_fallback_to_payload type handling | _apply_model_fallback_to_payload() | None | No exception raised | LOW | YES | Graceful handling | None |
| test_no_fallback_no_models | No changes when no fallback | _apply_model_fallback_to_payload no-op case | _apply_model_fallback_to_payload() | None | models not added | LOW | YES | Conditional application | None |
| test_csv_fallback_parsed | CSV fallback parsed to list | _apply_model_fallback_to_payload CSV parsing | _apply_model_fallback_to_payload() | None | models list created from CSV | HIGH | YES | Fallback parsing | None |
| test_existing_models_preserved | Existing models come first | _apply_model_fallback_to_payload model ordering | _apply_model_fallback_to_payload() | None | Existing models at start of list | MEDIUM | YES | Order preservation | None |
| test_duplicates_removed | Duplicate models removed | _apply_model_fallback_to_payload deduplication | _apply_model_fallback_to_payload() | None | Each model appears once | MEDIUM | YES | Deduplication | None |
| test_empty_fallback | Empty fallback handled | _apply_model_fallback_to_payload empty string | _apply_model_fallback_to_payload() | None | models not added for empty | LOW | YES | Empty value handling | None |
| test_non_dict_is_noop | Non-dict is no-op | _apply_disable_native_websearch_to_payload type handling | _apply_disable_native_websearch_to_payload() | None | No exception raised | LOW | YES | Graceful handling | None |
| test_flag_not_set_is_noop | Flag not set is no-op | _apply_disable_native_websearch_to_payload no flag | _apply_disable_native_websearch_to_payload() | None | No changes made | LOW | YES | Conditional application | None |
| test_flag_false_is_noop | Flag False is no-op | _apply_disable_native_websearch_to_payload flag=False | _apply_disable_native_websearch_to_payload() | None | No changes made | LOW | YES | Flag check | None |
| test_removes_web_search_options | web_search_options removed | _apply_disable_native_websearch_to_payload options removal | _apply_disable_native_websearch_to_payload() | None | web_search_options not in payload | MEDIUM | YES | Search disable | None |
| test_removes_web_plugin | Web plugin removed | _apply_disable_native_websearch_to_payload plugin filtering | _apply_disable_native_websearch_to_payload() | None | web plugin filtered from list | MEDIUM | YES | Plugin filtering | None |
| test_removes_plugins_when_only_web | plugins removed when only web | _apply_disable_native_websearch_to_payload cleanup | _apply_disable_native_websearch_to_payload() | None | plugins key removed | LOW | YES | Empty list cleanup | None |
| test_alternative_flag_name | Alternative flag name support | _apply_disable_native_websearch_to_payload flag variants | _apply_disable_native_websearch_to_payload() | None | disable_native_web_search works | MEDIUM | YES | Flag name variants | None |
| test_non_list_returns_as_is | Non-list returns as-is | _filter_replayable_input_items type handling | _filter_replayable_input_items() | None | Returns input unchanged | LOW | YES | Type validation | None |
| test_non_dict_items_preserved | Non-dict items preserved | _filter_replayable_input_items item preservation | _filter_replayable_input_items() | None | Non-dict items in result | LOW | YES | Mixed type handling | None |
| test_non_replayable_filtered | Non-replayable artifacts filtered | _filter_replayable_input_items artifact filtering | _filter_replayable_input_items() | None | Tool artifacts removed | HIGH | YES | Artifact filtering | None |
| test_no_changes_returns_original | No changes returns same object | _filter_replayable_input_items optimization | _filter_replayable_input_items() | None | Returns same list object | LOW | YES | Performance optimization | None |
| test_non_dict_payload_is_noop | Non-dict payload is no-op | _apply_identifier_valves_to_payload type handling | _apply_identifier_valves_to_payload() | pipe_instance | No exception raised | LOW | YES | Graceful handling | None |
| test_user_id_added_when_valve_enabled | user_id added when enabled | _apply_identifier_valves_to_payload user_id valve | _apply_identifier_valves_to_payload() | pipe_instance | user and metadata.user_id set | MEDIUM | YES | User ID injection | None |
| test_user_removed_when_valve_disabled | user removed when disabled | _apply_identifier_valves_to_payload user_id off | _apply_identifier_valves_to_payload() | pipe_instance | user not in payload | MEDIUM | YES | User ID removal | None |
| test_session_id_added_when_valve_enabled | session_id added when enabled | _apply_identifier_valves_to_payload session_id valve | _apply_identifier_valves_to_payload() | pipe_instance | session_id and metadata set | MEDIUM | YES | Session ID injection | None |
| test_session_id_removed_when_valve_disabled | session_id removed when disabled | _apply_identifier_valves_to_payload session_id off | _apply_identifier_valves_to_payload() | pipe_instance | session_id not in payload | MEDIUM | YES | Session ID removal | None |
| test_chat_id_added_to_metadata | chat_id added to metadata | _apply_identifier_valves_to_payload chat_id valve | _apply_identifier_valves_to_payload() | pipe_instance | metadata.chat_id set | MEDIUM | YES | Chat ID injection | None |
| test_message_id_added_to_metadata | message_id added to metadata | _apply_identifier_valves_to_payload message_id valve | _apply_identifier_valves_to_payload() | pipe_instance | metadata.message_id set | MEDIUM | YES | Message ID injection | None |
| test_metadata_removed_when_empty | Empty metadata removed | _apply_identifier_valves_to_payload cleanup | _apply_identifier_valves_to_payload() | pipe_instance | metadata not in payload | LOW | YES | Empty dict cleanup | None |
| test_invalid_user_id_omitted | Invalid user_id omitted | _apply_identifier_valves_to_payload validation | _apply_identifier_valves_to_payload() | pipe_instance, caplog | user not in payload, debug log | LOW | YES | ID validation | None |
| test_invalid_session_id_omitted | Invalid session_id omitted | _apply_identifier_valves_to_payload validation | _apply_identifier_valves_to_payload() | pipe_instance, caplog | session_id not in payload, debug log | LOW | YES | ID validation | None |
| test_strip_blank_string_whitespace_only | Whitespace-only becomes None | ResponsesBody._strip_blank_string validator | ResponsesBody._strip_blank_string() | None | Returns None | LOW | YES | String validation | None |
| test_strip_blank_string_empty | Empty string becomes None | ResponsesBody._strip_blank_string validator | ResponsesBody._strip_blank_string() | None | Returns None | LOW | YES | String validation | None |
| test_strip_blank_string_valid | Valid strings trimmed | ResponsesBody._strip_blank_string validator | ResponsesBody._strip_blank_string() | None | Returns trimmed string | LOW | YES | String trimming | None |
| test_strip_blank_string_non_string | Non-strings returned as-is | ResponsesBody._strip_blank_string validator | ResponsesBody._strip_blank_string() | None | Returns input unchanged | LOW | YES | Type passthrough | None |
| test_coerce_int_fields_bool_raises | Bool raises ValidationError | ResponsesBody._coerce_int_fields validator | ResponsesBody._coerce_int_fields() | None | Raises ValidationError | MEDIUM | YES | Type rejection | None |
| test_coerce_int_fields_float_rounds | Float values rounded | ResponsesBody._coerce_int_fields validator | ResponsesBody._coerce_int_fields() | None | max_tokens=101 from 100.7 | LOW | YES | Float rounding | None |
| test_coerce_int_fields_string_numeric | Numeric strings converted | ResponsesBody._coerce_int_fields validator | ResponsesBody._coerce_int_fields() | None | "200" becomes 200 | LOW | YES | String parsing | None |
| test_coerce_int_fields_string_float | Float strings converted and rounded | ResponsesBody._coerce_int_fields validator | ResponsesBody._coerce_int_fields() | None | "150.9" becomes 151 | LOW | YES | String float parsing | None |
| test_coerce_int_fields_invalid_string | Invalid string raises ValidationError | ResponsesBody._coerce_int_fields validator | ResponsesBody._coerce_int_fields() | None | Raises ValidationError | MEDIUM | YES | String validation | None |
| test_coerce_int_fields_invalid_type | Invalid types raise ValidationError | ResponsesBody._coerce_int_fields validator | ResponsesBody._coerce_int_fields() | None | Raises ValidationError | LOW | YES | Type validation | None |
| test_coerce_int_fields_whitespace_string | Whitespace string becomes None | ResponsesBody._coerce_int_fields validator | ResponsesBody._coerce_int_fields() | None | max_tokens is None | LOW | YES | Empty string handling | None |
| test_coerce_float_fields_whitespace | Whitespace becomes None for floats | ResponsesBody field validators | ResponsesBody validators | None | temperature is None | LOW | YES | Float field handling | None |
| test_coerce_models_list_csv_string | CSV string parsed to list | ResponsesBody._coerce_models_list validator | ResponsesBody._coerce_models_list() | None | models is list with 3 items | MEDIUM | YES | CSV parsing | None |
| test_coerce_models_list_csv_with_empty | Empty CSV entries filtered | ResponsesBody._coerce_models_list validator | ResponsesBody._coerce_models_list() | None | Empty entries removed | LOW | YES | Empty entry handling | None |
| test_coerce_models_list_all_empty | All-empty CSV becomes None | ResponsesBody._coerce_models_list validator | ResponsesBody._coerce_models_list() | None | models is None | LOW | YES | Empty list handling | None |
| test_coerce_models_list_array_with_non_strings | Non-string entries filtered | ResponsesBody._coerce_models_list validator | ResponsesBody._coerce_models_list() | None | Only string items in result | MEDIUM | YES | Type filtering | None |
| test_coerce_models_list_array_with_whitespace | Whitespace entries filtered | ResponsesBody._coerce_models_list validator | ResponsesBody._coerce_models_list() | None | Whitespace items removed | LOW | YES | Whitespace filtering | None |
| test_coerce_models_list_invalid_type | Invalid type raises ValidationError | ResponsesBody._coerce_models_list validator | ResponsesBody._coerce_models_list() | None | Raises ValidationError | LOW | YES | Type validation | None |
| test_empty_tools | Empty/None tools returns empty list | ResponsesBody.transform_owui_tools | ResponsesBody.transform_owui_tools() | None | Returns empty list | LOW | YES | Empty input handling | None |
| test_malformed_entries_skipped | Malformed entries skipped | ResponsesBody.transform_owui_tools validation | ResponsesBody.transform_owui_tools() | None | Returns empty for invalid tools | MEDIUM | YES | Entry validation | None |
| test_valid_tool_converted | Valid tool converted | ResponsesBody.transform_owui_tools conversion | ResponsesBody.transform_owui_tools() | None | Tool has type, name, description, params | HIGH | YES | OWUI tool format | None |
| test_tool_without_description | Tool without description uses name | ResponsesBody.transform_owui_tools defaults | ResponsesBody.transform_owui_tools() | None | description=name | LOW | YES | Default description | None |
| test_tool_without_parameters | Tool without parameters gets default | ResponsesBody.transform_owui_tools defaults | ResponsesBody.transform_owui_tools() | None | parameters has default schema | LOW | YES | Default parameters | None |
| test_strict_mode | Strict mode adds strict flag | ResponsesBody.transform_owui_tools strict param | ResponsesBody.transform_owui_tools() | None | strict=True in tool | MEDIUM | YES | Strict schema support | None |
| test_none_returns_none | None returns None | ResponsesBody._convert_function_call_to_tool_choice | ResponsesBody._convert_function_call_to_tool_choice() | None | Returns None | LOW | YES | Null handling | None |
| test_string_auto | 'auto' string handling | ResponsesBody._convert_function_call_to_tool_choice strings | ResponsesBody._convert_function_call_to_tool_choice() | None | Returns "auto" | LOW | YES | String normalization | None |
| test_string_none | 'none' string handling | ResponsesBody._convert_function_call_to_tool_choice strings | ResponsesBody._convert_function_call_to_tool_choice() | None | Returns "none" | LOW | YES | String normalization | None |
| test_string_other | Other strings return None | ResponsesBody._convert_function_call_to_tool_choice validation | ResponsesBody._convert_function_call_to_tool_choice() | None | Returns None for unknown | LOW | YES | String validation | None |
| test_dict_with_name | Dict with name converted | ResponsesBody._convert_function_call_to_tool_choice dict | ResponsesBody._convert_function_call_to_tool_choice() | None | Returns {type: function, name} | MEDIUM | YES | Dict conversion | None |
| test_dict_with_function_name | Dict with function.name extracted | ResponsesBody._convert_function_call_to_tool_choice nested | ResponsesBody._convert_function_call_to_tool_choice() | None | Name from function.name | MEDIUM | YES | Nested extraction | None |
| test_dict_name_stripped | Name whitespace stripped | ResponsesBody._convert_function_call_to_tool_choice trimming | ResponsesBody._convert_function_call_to_tool_choice() | None | Name trimmed | LOW | YES | String trimming | None |
| test_dict_empty_name | Empty name returns None | ResponsesBody._convert_function_call_to_tool_choice validation | ResponsesBody._convert_function_call_to_tool_choice() | None | Returns None for empty | LOW | YES | Name validation | None |
| test_dict_no_name | No name returns None | ResponsesBody._convert_function_call_to_tool_choice validation | ResponsesBody._convert_function_call_to_tool_choice() | None | Returns None | LOW | YES | Required field check | None |
| test_basic_creation | Basic CompletionsBody creation | CompletionsBody Pydantic model | CompletionsBody | None | Model and messages set | LOW | YES | Model initialization | None |
| test_stream_default_false | stream defaults to False | CompletionsBody defaults | CompletionsBody | None | stream is False | LOW | YES | Default values | None |
| test_extra_fields_allowed | Extra fields allowed | CompletionsBody config | CompletionsBody | None | custom_field accessible | LOW | YES | Extra field support | None |
| test_basic_creation | Basic ResponsesBody creation | ResponsesBody Pydantic model | ResponsesBody | None | Model and input set | LOW | YES | Model initialization | None |
| test_input_as_list | input as list of messages | ResponsesBody input field | ResponsesBody | None | input is list | LOW | YES | Input type flexibility | None |
| test_extra_fields_allowed | Extra fields allowed | ResponsesBody config | ResponsesBody | None | custom_field accessible | LOW | YES | Extra field support | None |
| test_model_normalized | Model ID normalized | ResponsesBody model validator | ResponsesBody | None | Model not None | MEDIUM | YES | Model normalization | Verify ModelFamily logic |
| test_requires_transformer_context | from_completions requires context | ResponsesBody.from_completions validation | ResponsesBody.from_completions() | None | Raises RuntimeError | HIGH | YES | Context requirement | None |
| test_basic_conversion | Basic completions to responses | ResponsesBody.from_completions conversion | ResponsesBody.from_completions() | pipe_instance_async | Model, stream, temp, input set | HIGH | YES | Core conversion | None |
| test_max_tokens_converted | max_tokens to max_output_tokens | ResponsesBody.from_completions field mapping | ResponsesBody.from_completions() | pipe_instance_async | max_output_tokens=500 | MEDIUM | YES | Field renaming | None |
| test_reasoning_effort_converted | reasoning_effort to reasoning.effort | ResponsesBody.from_completions reasoning | ResponsesBody.from_completions() | pipe_instance_async | reasoning.effort set | MEDIUM | YES | Reasoning format | None |
| test_function_call_converted | function_call to tool_choice | ResponsesBody.from_completions function_call | ResponsesBody.from_completions() | pipe_instance_async | tool_choice with function name | MEDIUM | YES | Legacy function_call support | None |
| test_unsupported_fields_dropped | Unsupported fields dropped | ResponsesBody.from_completions field filtering | ResponsesBody.from_completions() | pipe_instance_async, caplog | n and suffix dropped, warning logged | MEDIUM | YES | Field validation | None |
| test_filters_invalid_messages | Messages without role filtered | ResponsesBody.from_completions message validation | ResponsesBody.from_completions() | pipe_instance_async | input still present | MEDIUM | YES | Message filtering | None |
| test_tool_choice_normalized | tool_choice normalized | ResponsesBody.from_completions tool_choice | ResponsesBody.from_completions() | pipe_instance_async | tool_choice in responses format | MEDIUM | YES | Tool choice format | None |
| test_tools_normalized | tools normalized | ResponsesBody.from_completions tools | ResponsesBody.from_completions() | pipe_instance_async | tools in responses format | HIGH | YES | Tools format | None |
| test_extra_params_merged | extra_params merged | ResponsesBody.from_completions param merging | ResponsesBody.from_completions() | pipe_instance_async | custom_param in result | LOW | YES | Extra params support | None |
| test_with_response_format | response_format handled | ResponsesBody.from_completions response_format | ResponsesBody.from_completions() | pipe_instance_async | text.format set | MEDIUM | YES | Response format mapping | None |
| test_applies_request_transforms | Pipe applies request transforms | Full integration through Pipe | Pipe.send_openai_chat_completions_streaming_request() | pipe_instance_async, aioresponses | Payload transformed correctly | HIGH | YES | End-to-end transform | None |
| test_converts_responses_tools_to_chat | Pipe converts Responses tools | Tool transformation through Pipe | Pipe.send_openai_chat_completions_streaming_request() | pipe_instance_async, aioresponses | Tools wrapped in function format | HIGH | YES | Tool conversion integration | None |
| test_converts_instructions_to_system | Pipe converts instructions | Instructions transformation through Pipe | Pipe.send_openai_chat_completions_streaming_request() | pipe_instance_async, aioresponses | System message created | MEDIUM | YES | Instructions integration | None |
| test_strip_disable_model_settings_params_removes_pipe_control_flags | Remove pipe control flags | Imported from test_strip_disable_model_settings_params | _strip_disable_model_settings_params() | None | All disable flags removed | MEDIUM | YES | Legacy test migration | None |
| test_filter_openrouter_request_forwards_numeric_top_k | Numeric top_k forwarded | Imported from test_top_k_passthrough | _filter_openrouter_request() | None | top_k=50.0 | LOW | YES | Legacy test migration | None |
| test_filter_openrouter_request_parses_string_top_k | String top_k parsed | Imported from test_top_k_passthrough | _filter_openrouter_request() | None | "50" becomes 50.0 | LOW | YES | Legacy test migration | None |
| test_filter_openrouter_request_drops_invalid_top_k | Invalid top_k dropped | Imported from test_top_k_passthrough | _filter_openrouter_request() | None | top_k not in result | LOW | YES | Legacy test migration | None |


## `tests/test_chat_gateway.py`

| Test Name | Description | What It Tests | Code Under Test | Mocks/Fixtures | Assertions | Drift Risk | Check Done | Codex Notes | Codex TODO |
|-----------|-------------|---------------|-----------------|----------------|------------|------------|------------|-------------|------------|
| test_chat_completions_streaming_tool_call_without_id | Tests tool calls without id get generated IDs | Tool call ID generation when provider omits id field | Pipe.send_openai_chat_completions_streaming_request | aioresponses, pipe_instance_async | Generated ID starts with "toolcall-" | med | yes | ID generation is a fallback mechanism for incomplete provider responses | |
| test_chat_completions_streaming_tool_call_without_index | Tests tool calls without index get auto-assigned indices | Tool call index defaulting to 0 when missing | Pipe.send_openai_chat_completions_streaming_request | aioresponses, pipe_instance_async | Tool call processed with default index | med | yes | Handles incomplete tool call deltas | |
| test_chat_completions_streaming_reasoning_text_merge | Tests reasoning.text deltas are properly merged | Reasoning text chunk accumulation across stream | Pipe.send_openai_chat_completions_streaming_request | aioresponses, pipe_instance_async | Multiple reasoning deltas emitted | med | yes | Validates incremental reasoning display | |
| test_chat_completions_streaming_reasoning_summary | Tests reasoning.summary handling | Reasoning summary event emission | Pipe.send_openai_chat_completions_streaming_request | aioresponses, pipe_instance_async | Summary event text matches input | med | yes | Separate from reasoning text | |
| test_chat_completions_streaming_reasoning_encrypted | Tests reasoning.encrypted handling | Encrypted reasoning data merge | Pipe.send_openai_chat_completions_streaming_request | aioresponses, pipe_instance_async | Completes without error | med | yes | OpenRouter proprietary extension | |
| test_chat_completions_streaming_reasoning_no_id | Tests reasoning details without explicit id get generated id | Reasoning item ID generation | Pipe.send_openai_chat_completions_streaming_request | aioresponses, pipe_instance_async | Generated ID starts with "reasoning-" | med | yes | Ensures every reasoning item is uniquely identifiable | |
| test_chat_completions_streaming_error_with_retry_after | Tests error handling with Retry-After header | Rate limit error metadata extraction | Pipe.send_openai_chat_completions_streaming_request | aioresponses, pipe_instance_async | Exception raised with 429 status | med | yes | Circuit breaker and retry logic depend on this | |
| test_chat_completions_streaming_error_500 | Tests error handling for 500 status | Generic server error handling | Pipe.send_openai_chat_completions_streaming_request | aioresponses, pipe_instance_async | RuntimeError with "500" in message | med | yes | Non-retryable error path | |
| test_chat_completions_streaming_with_breaker_key | Tests streaming with breaker_key parameter | Circuit breaker key integration | Pipe.send_openai_chat_completions_streaming_request | aioresponses, pipe_instance_async | Events emitted successfully | med | yes | Per-user circuit breaking | |
| test_chat_completions_streaming_invalid_json_chunk | Tests handling of invalid JSON in SSE stream | Robustness against malformed JSON | Pipe.send_openai_chat_completions_streaming_request | aioresponses, pipe_instance_async | Completes despite invalid chunk | low | yes | Real-world provider may emit bad data | |
| test_chat_completions_streaming_empty_choices | Tests handling of empty choices array | Defensive parsing of choices | Pipe.send_openai_chat_completions_streaming_request | aioresponses, pipe_instance_async | Completes successfully | low | yes | Provider may send empty arrays | |
| test_chat_completions_streaming_sse_comment_lines | Tests SSE comment lines are ignored | SSE spec compliance for comments | Pipe.send_openai_chat_completions_streaming_request | aioresponses, pipe_instance_async | Completes successfully | low | yes | Comments start with : per SSE spec | |
| test_chat_completions_streaming_annotation_no_url_citation_key | Tests annotations where url/title are at top level | Annotation schema flexibility | Pipe.send_openai_chat_completions_streaming_request | aioresponses, pipe_instance_async | Annotation URL extracted correctly | med | yes | Handles provider schema variations | |
| test_chat_completions_streaming_duplicate_citation_urls | Tests duplicate citation URLs are deduplicated | Citation deduplication logic | Pipe.send_openai_chat_completions_streaming_request | aioresponses, pipe_instance_async | Only 1 annotation event despite 2 inputs | med | yes | Prevents duplicate citations in UI | |
| test_chat_completions_streaming_annotation_non_string_title | Tests annotations where title is not a string | Title fallback to URL | Pipe.send_openai_chat_completions_streaming_request | aioresponses, pipe_instance_async | Title falls back to URL | med | yes | Defensive programming | |
| test_chat_completions_streaming_message_reasoning_details | Tests reasoning_details in message object | Final message reasoning extraction | Pipe.send_openai_chat_completions_streaming_request | aioresponses, pipe_instance_async | Completes with reasoning recorded | med | yes | Some providers put reasoning in final message | |
| test_chat_completions_nonstreaming_error_with_retry_after | Tests non-streaming error with Retry-After header | Rate limit handling in non-streaming | Pipe.send_openai_chat_completions_nonstreaming_request | aioresponses, pipe_instance_async | Exception with 429 status | med | yes | Consistent error handling across modes | |
| test_chat_completions_nonstreaming_error_500 | Tests non-streaming 500 error handling | Server error in non-streaming | Pipe.send_openai_chat_completions_nonstreaming_request | aioresponses, pipe_instance_async | RuntimeError with "500" | med | yes | Consistent error path | |
| test_chat_completions_nonstreaming_with_breaker_key_failure | Tests non-streaming with breaker_key and failure recording | Circuit breaker failure recording | Pipe.send_openai_chat_completions_nonstreaming_request | aioresponses, pipe_instance_async | Exception raised | med | yes | Failures are tracked per user | |
| test_chat_completions_nonstreaming_non_dict_response | Tests non-streaming with non-dict response returns empty dict | Invalid response handling | Pipe.send_openai_chat_completions_nonstreaming_request | aioresponses, pipe_instance_async | Returns empty dict {} | med | yes | Graceful degradation | |
| test_chat_completions_streaming_finish_reason_length | Tests finish_reason='length' handling | Token limit reached scenario | Pipe.send_openai_chat_completions_streaming_request | aioresponses, pipe_instance_async | Completes with length finish reason | low | yes | Important for UI to indicate truncation | |
| test_chat_completions_streaming_finish_reason_content_filter | Tests finish_reason='content_filter' handling | Content moderation scenario | Pipe.send_openai_chat_completions_streaming_request | aioresponses, pipe_instance_async | Completes with filter finish reason | low | yes | Safety feature indicator | |
| test_chat_completions_streaming_tool_call_no_name | Tests tool call without name excluded from output | Incomplete tool call filtering | Pipe.send_openai_chat_completions_streaming_request | aioresponses, pipe_instance_async | No function calls in output | med | yes | Prevents broken tool calls from being executed | |
| test_chat_completions_streaming_reasoning_entry_no_type | Tests reasoning entry without type is skipped | Invalid reasoning entry filtering | Pipe.send_openai_chat_completions_streaming_request | aioresponses, pipe_instance_async | Completes successfully | med | yes | Defensive parsing | |
| test_chat_completions_streaming_reasoning_entry_not_dict | Tests reasoning entries that are not dicts are skipped | Type validation for reasoning entries | Pipe.send_openai_chat_completions_streaming_request | aioresponses, pipe_instance_async | Completes successfully | med | yes | Array may contain invalid items | |
| test_send_openrouter_streaming_fallback_after_responses_error | Tests fallback to /chat/completions when /responses fails | Endpoint fallback mechanism | Pipe.send_openrouter_streaming_request | aioresponses, pipe_instance_async | Fallback text delta received | med | yes | Critical resilience feature for unsupported models | |
| test_send_openrouter_streaming_no_fallback_when_disabled | Tests fallback disabled when AUTO_FALLBACK_CHAT_COMPLETIONS is False | Fallback configuration respected | Pipe.send_openrouter_streaming_request | aioresponses, pipe_instance_async | Exception raised without fallback | low | yes | User control over behavior | |
| test_send_openrouter_streaming_responses_buffering | Tests non-visible events buffered until first visible event | Event buffering logic | Pipe.send_openrouter_streaming_request | aioresponses, pipe_instance_async | Events received | med | yes | Optimizes for first visible content | |
| test_chat_completions_streaming_annotation_empty_url | Tests annotations with empty/whitespace URLs are skipped | URL validation | Pipe.send_openai_chat_completions_streaming_request | aioresponses, pipe_instance_async | Only valid URL added | med | yes | Prevents empty citations | |
| test_chat_completions_streaming_annotation_other_type | Tests annotations with non-url_citation type are skipped | Annotation type filtering | Pipe.send_openai_chat_completions_streaming_request | aioresponses, pipe_instance_async | No annotation events | med | yes | Only URL citations currently supported | |
| test_chat_completions_nonstreaming_json_text_fallback | Tests non-streaming falls back to text parsing when json() fails | JSON parse error handling | Pipe.send_openai_chat_completions_nonstreaming_request | aioresponses, pipe_instance_async | Choices in result | low | yes | Robustness against content-type mismatch | |
| test_chat_completions_streaming_rate_limit_scope | Tests error handling extracts X-RateLimit-Scope header | Rate limit scope metadata | Pipe.send_openai_chat_completions_streaming_request | aioresponses, pipe_instance_async | Exception with 429 status | med | yes | User/org/model level rate limit info | |
| test_chat_completions_streaming_empty_chunk | Tests empty chunks in stream are handled | Empty chunk filtering | Pipe.send_openai_chat_completions_streaming_request | aioresponses, pipe_instance_async | Completes successfully | low | yes | Network or provider may send empty chunks | |
| test_chat_completions_streaming_tool_call_done_events | Tests tool_call done events are emitted properly | Tool call completion signaling | Pipe.send_openai_chat_completions_streaming_request | aioresponses, pipe_instance_async | Done event with completed status | med | yes | UI needs to know when tool call is complete | |
| test_chat_completions_streaming_reasoning_done_item | Tests reasoning done item is emitted with full content | Reasoning completion event | Pipe.send_openai_chat_completions_streaming_request | aioresponses, pipe_instance_async | Done event with content/summary | med | yes | Signals end of reasoning phase | |
| test_chat_completions_streaming_breaker_open | Tests streaming with breaker open raises RuntimeError | Circuit breaker blocking | Pipe.send_openai_chat_completions_streaming_request | aioresponses, pipe_instance_async | RuntimeError with "Breaker open" | med | yes | Prevents cascading failures | |
| test_chat_completions_streaming_error_with_breaker_recording | Tests streaming error records failure on breaker key | Failure tracking | Pipe.send_openai_chat_completions_streaming_request | aioresponses, pipe_instance_async | Exception raised | med | yes | Breaker state management | |
| test_chat_completions_streaming_reasoning_text_merge_with_next_only | Tests reasoning text merge when prev_text is not string but next_text is | Edge case in text merging | Pipe.send_openai_chat_completions_streaming_request | aioresponses, pipe_instance_async | Completes successfully | med | yes | First chunk may not have text field | |
| test_chat_completions_streaming_reasoning_summary_merge | Tests reasoning summary merge behavior | Summary update logic | Pipe.send_openai_chat_completions_streaming_request | aioresponses, pipe_instance_async | Completes with updated summary | med | yes | Later summaries override earlier ones | |
| test_chat_completions_streaming_reasoning_encrypted_next_only | Tests reasoning.encrypted merge when prev_data is not string | Encrypted data merge edge case | Pipe.send_openai_chat_completions_streaming_request | aioresponses, pipe_instance_async | Completes successfully | med | yes | First chunk may not have data field | |
| test_chat_completions_streaming_annotation_not_dict | Tests annotations that are not dicts are skipped | Annotation type validation | Pipe.send_openai_chat_completions_streaming_request | aioresponses, pipe_instance_async | Only valid annotation added | med | yes | Array may contain invalid items | |
| test_chat_completions_streaming_tool_call_not_dict | Tests tool calls that are not dicts are skipped | Tool call type validation | Pipe.send_openai_chat_completions_streaming_request | aioresponses, pipe_instance_async | Only valid tool call processed | med | yes | Array may contain invalid items | |
| test_chat_completions_nonstreaming_with_rate_limit_scope | Tests non-streaming error extracts X-RateLimit-Scope header | Rate limit scope in non-streaming | Pipe.send_openai_chat_completions_nonstreaming_request | aioresponses, pipe_instance_async | Exception with 429 status | med | yes | Consistent metadata extraction | |
| test_chat_completions_nonstreaming_breaker_open | Tests non-streaming with breaker open raises RuntimeError | Circuit breaker in non-streaming | Pipe.send_openai_chat_completions_nonstreaming_request | aioresponses, pipe_instance_async | RuntimeError with "Breaker open" | med | yes | Consistent circuit breaking | |
| test_send_openrouter_streaming_responses_content_part_visible | Tests response.content_part events are user-visible | Event visibility classification | Pipe.send_openrouter_streaming_request | aioresponses, pipe_instance_async | Events received | med | yes | Content part additions are visible | |
| test_send_openrouter_streaming_responses_reasoning_visible | Tests response.reasoning events are user-visible | Reasoning visibility | Pipe.send_openrouter_streaming_request | aioresponses, pipe_instance_async | Events received | med | yes | Reasoning should not be buffered | |
| test_send_openrouter_streaming_responses_error_visible | Tests error events are user-visible and raise exception | Error handling in responses | Pipe.send_openrouter_streaming_request | aioresponses, pipe_instance_async | Exception with error message | med | yes | Errors are immediately visible | |
| test_send_openrouter_streaming_event_no_type | Tests events without type are user-visible | Default visibility for unknown events | Pipe.send_openrouter_streaming_request | aioresponses, pipe_instance_async | Events received | med | yes | Conservative approach to new event types | |
| test_send_openrouter_streaming_fallback_after_visible_output | Tests no fallback when /responses already emitted visible output | Fallback prevention after output | Pipe.send_openrouter_streaming_request | aioresponses, pipe_instance_async | Completes normally | med | yes | Prevents duplicate/mixed responses | |
| test_send_openrouter_streaming_fallback_discards_buffer | Tests non-visible events discarded on fallback | Buffer clearing on fallback | Pipe.send_openrouter_streaming_request | aioresponses, pipe_instance_async | Fallback text delta received | med | yes | Clean slate for fallback endpoint | |
| test_chat_completions_streaming_data_blob_empty | Tests empty data blobs are skipped | Empty line filtering | Pipe.send_openai_chat_completions_streaming_request | aioresponses, pipe_instance_async | Completes successfully | low | yes | SSE may have empty data lines | |
| test_chat_completions_streaming_no_choices_in_chunk | Tests chunks without choices field are skipped | Defensive choices access | Pipe.send_openai_chat_completions_streaming_request | aioresponses, pipe_instance_async | Completes successfully | low | yes | Metadata-only chunks may lack choices | |
| test_chat_completions_streaming_choices_not_list | Tests chunks where choices is not a list are skipped | Choices type validation | Pipe.send_openai_chat_completions_streaming_request | aioresponses, pipe_instance_async | Completes successfully | low | yes | Malformed response handling | |
| test_chat_completions_streaming_choice_not_dict | Tests chunks where choice[0] is not a dict | Choice element validation | Pipe.send_openai_chat_completions_streaming_request | aioresponses, pipe_instance_async | Completes successfully | low | yes | Array may contain non-dict items | |
| test_chat_completions_streaming_delta_not_dict | Tests chunks where delta is not a dict | Delta type validation | Pipe.send_openai_chat_completions_streaming_request | aioresponses, pipe_instance_async | Completes successfully | low | yes | Malformed delta handling | |
| test_send_openrouter_streaming_response_failed_visible | Tests response.failed events are user-visible and raise exception | Failed response handling | Pipe.send_openrouter_streaming_request | aioresponses, pipe_instance_async | Exception raised | med | yes | Explicit failure indicator | |
| test_send_openrouter_streaming_response_error_visible | Tests response.error events are user-visible and raise exception | Error event handling | Pipe.send_openrouter_streaming_request | aioresponses, pipe_instance_async | Exception with error message | med | yes | Different from generic error | |
| test_pipe_creates_chat_completions_adapter | Tests Pipe lazily creates ChatCompletionsAdapter | Adapter lazy initialization | Pipe._ensure_chat_completions_adapter | pipe_instance | Adapter created and cached | low | yes | Singleton pattern for adapter | |
| test_chat_completions_streaming_simple_text | Tests simple streaming text response | Basic text streaming | Pipe.send_openai_chat_completions_streaming_request | aioresponses, pipe_instance_async | Text deltas and completion received | low | yes | Fundamental streaming capability | |
| test_chat_completions_streaming_with_usage | Tests streaming response with usage data | Usage data extraction | Pipe.send_openai_chat_completions_streaming_request | aioresponses, pipe_instance_async | Input/output tokens in completed event | low | yes | Essential for cost tracking | |
| test_chat_completions_streaming_with_tool_calls | Tests streaming response with tool calls | Tool call streaming and merging | Pipe.send_openai_chat_completions_streaming_request | aioresponses, pipe_instance_async | Tool call in output with correct arguments | med | yes | Incremental tool call assembly | |
| test_chat_completions_streaming_with_reasoning | Tests streaming response with reasoning/thinking content | Reasoning content streaming | Pipe.send_openai_chat_completions_streaming_request | aioresponses, pipe_instance_async | Completes with reasoning | med | yes | Claude/GPT reasoning support | |
| test_chat_completions_streaming_with_annotations | Tests streaming response with annotations | Annotation streaming | Pipe.send_openai_chat_completions_streaming_request | aioresponses, pipe_instance_async | Annotation events emitted | med | yes | Citation support | |
| test_chat_completions_nonstreaming_simple | Tests non-streaming chat completion request | Basic non-streaming | Pipe.send_openai_chat_completions_nonstreaming_request | aioresponses, pipe_instance_async | Choices and usage in result | low | yes | Returns raw Chat Completions format | |
| test_chat_completions_nonstreaming_with_tool_calls | Tests non-streaming response with tool calls | Tool calls in non-streaming | Pipe.send_openai_chat_completions_nonstreaming_request | aioresponses, pipe_instance_async | Tool calls in message | med | yes | Non-streaming tool support | |
| test_chat_completions_nonstreaming_error_response | Tests error handling for non-streaming request | Error response handling | Pipe.send_openai_chat_completions_nonstreaming_request | aioresponses, pipe_instance_async | Exception raised | med | yes | Standard error path | |
| test_chat_usage_to_responses_usage_basic | Tests conversion of chat usage to responses format | Usage format conversion | ChatCompletionsAdapter._chat_usage_to_responses_usage | None | input_tokens and output_tokens set | low | yes | Format translation layer | |
| test_chat_usage_to_responses_usage_with_cached | Tests usage conversion with cached tokens | Cached token handling | ChatCompletionsAdapter._chat_usage_to_responses_usage | None | cached_tokens in details | low | yes | Prompt caching support | |
| test_chat_usage_to_responses_usage_with_reasoning | Tests usage conversion with reasoning tokens | Reasoning token tracking | ChatCompletionsAdapter._chat_usage_to_responses_usage | None | reasoning_tokens in details | low | yes | Extended context tracking | |
| test_chat_usage_to_responses_usage_empty | Tests usage conversion with empty input | Empty dict handling | ChatCompletionsAdapter._chat_usage_to_responses_usage | None | Returns empty dict | low | yes | Graceful handling of missing data | |
| test_chat_usage_to_responses_usage_non_dict | Tests usage conversion with non-dict input | Type error handling | ChatCompletionsAdapter._chat_usage_to_responses_usage | None | Returns empty dict | low | yes | Defensive programming | |
| test_chat_usage_to_responses_usage_none | Tests usage conversion with None input | None handling | ChatCompletionsAdapter._chat_usage_to_responses_usage | None | Returns empty dict | low | yes | Null safety | |
| test_send_openrouter_streaming_with_responses_endpoint | Tests send_openrouter_streaming_request with responses endpoint | Responses endpoint selection | Pipe.send_openrouter_streaming_request | aioresponses, pipe_instance_async | Events received | med | yes | Native responses API path | |
| test_send_openrouter_streaming_with_chat_override | Tests endpoint override to chat_completions | Endpoint override parameter | Pipe.send_openrouter_streaming_request | aioresponses, pipe_instance_async | Events received | med | yes | Per-request endpoint control | |
| test_chat_completions_streaming_multiple_tool_calls | Tests streaming response with multiple parallel tool calls | Multiple tool call handling | Pipe.send_openai_chat_completions_streaming_request | aioresponses, pipe_instance_async | 2 tool calls in output | med | yes | Parallel function execution support | |
| test_full_pipe_call_with_chat_completions | Tests full pipe call that uses chat completions adapter | End-to-end integration | Pipe._handle_pipe_call | aioresponses, pipe_instance_async | Result dict with choices | high | yes | Integration test covering full stack | |
| test_chat_usage_with_cost | Tests usage conversion with cost field | Cost tracking | ChatCompletionsAdapter._chat_usage_to_responses_usage | None | Cost preserved in result | low | yes | Financial tracking | |
| test_chat_usage_with_cache_discount | Tests usage conversion with cache discount fields | Cache discount metadata | ChatCompletionsAdapter._chat_usage_to_responses_usage | None | Discount fields preserved | low | yes | Cost optimization info | |
| test_chat_usage_with_total_tokens | Tests usage conversion with total tokens | Total token preservation | ChatCompletionsAdapter._chat_usage_to_responses_usage | None | total_tokens in result | low | yes | Aggregate metrics | |
| test_chat_usage_prompt_details_not_dict | Tests usage conversion when prompt_tokens_details is not dict | Invalid details handling | ChatCompletionsAdapter._chat_usage_to_responses_usage | None | input_tokens_details not created | low | yes | Defensive parsing | |
| test_chat_usage_completion_details_not_dict | Tests usage conversion when completion_tokens_details is not dict | Invalid details handling | ChatCompletionsAdapter._chat_usage_to_responses_usage | None | output_tokens_details not created | low | yes | Defensive parsing | |
| test_responses_payload_to_chat_preserves_cache_control | Tests cache_control preserved in payload conversion | Anthropic cache_control support | _responses_payload_to_chat_completions_payload | None | cache_control in converted messages | low | yes | Critical for prompt caching | |
| test_responses_payload_to_chat_rounds_top_k_for_chat_completions | Tests top_k is rounded for chat completions | Parameter compatibility | _responses_payload_to_chat_completions_payload | None | top_k rounded to integer | low | yes | Chat API requires integer top_k | |
| test_force_chat_completions_models_matches_slash_glob | Tests FORCE_CHAT_COMPLETIONS_MODELS glob matching | Model forcing configuration | Pipe._select_llm_endpoint | pipe_instance | Returns chat_completions | low | yes | Wildcard model selection | |
| test_force_responses_models_overrides_force_chat_models | Tests FORCE_RESPONSES_MODELS overrides FORCE_CHAT_COMPLETIONS_MODELS | Configuration precedence | Pipe._select_llm_endpoint | pipe_instance | Returns responses | low | yes | Explicit override mechanism | |
| test_responses_payload_to_chat_converts_tools_schema | Tests tools schema conversion from responses to chat format | Tool schema transformation | _responses_payload_to_chat_completions_payload | None | Tools wrapped in function objects | low | yes | Different tool formats between APIs | |
| test_chat_completions_stream_adapts_tool_calls_and_usage | Tests chat completions streaming adapter transforms responses correctly | Full streaming transformation with all features | Pipe.send_openai_chat_completions_streaming_request | aioresponses | Reasoning, tool calls, usage, annotations all present | med | yes | Comprehensive integration test | |
| test_chat_completions_inlines_internal_file_urls | Tests internal file URLs are inlined in streaming | File URL inlining | Pipe.send_openai_chat_completions_streaming_request | aioresponses, monkeypatch | File inlining function called | med | yes | Upload support for chat completions | |
| test_transform_messages_to_input_preserves_annotations | Tests assistant message annotations preserved in transformation | Message format conversion | Pipe.transform_messages_to_input | None | Annotations and reasoning_details preserved | low | yes | Bidirectional format support | |
| test_send_openrouter_streaming_request_falls_back_to_chat | Tests fallback from responses to chat on unsupported model error | Automatic fallback logic | Pipe.send_openrouter_streaming_request | monkeypatch | Chat adapter called after responses fails | high | yes | Real test with mocked adapters | |
| test_send_openrouter_streaming_request_does_not_fallback_after_output | Tests no fallback after responses emitted output | Fallback prevention after partial output | Pipe.send_openrouter_streaming_request | monkeypatch | OpenRouterAPIError raised, no fallback | high | yes | Prevents response mixing | |
| test_send_openrouter_streaming_request_fallback_discards_nonvisible_events | Tests non-visible events discarded on fallback | Buffer clearing on fallback | Pipe.send_openrouter_streaming_request | monkeypatch | response.created not in output | high | yes | Clean fallback transition | |
| test_send_openrouter_nonstreaming_request_as_events_chat_adapter | Tests non-streaming chat adapter transforms to events | Non-streaming event transformation | Pipe.send_openrouter_nonstreaming_request_as_events | aioresponses | All event types present with correct data | med | yes | Non-streaming responses format compatibility | |
| test_chat_completions_nonstreaming_inlines_internal_file_urls | Tests internal file URLs inlined in non-streaming | File inlining in non-streaming | Pipe.send_openai_chat_completions_nonstreaming_request | aioresponses, monkeypatch | File inlining function called | med | yes | Consistent upload handling | |


## `tests/test_circuit_breaker.py`

| Test Name | Description | What It Tests | Code Under Test | Mocks/Fixtures | Assertions | Drift Risk | Check Done | Codex Notes | Codex TODO |
|-----------|-------------|---------------|-----------------|----------------|------------|------------|------------|-------------|------------|
| `test_threshold_getter_returns_initial_value` | Threshold getter returns configured value | Getter property for threshold configuration | `CircuitBreaker.threshold` (line 66) | None | `assert breaker.threshold == 5` | Low - simple property |  | Tests line 66 coverage | None |
| `test_threshold_setter_updates_value` | Threshold setter updates internal value | Setter updates _threshold attribute | `CircuitBreaker.threshold` setter | None | `assert breaker.threshold == 10` | Low - simple property |  | Basic setter behavior | None |
| `test_threshold_setter_enforces_minimum_of_one` | Threshold setter enforces minimum=1 | Value validation preventing zero/negative thresholds | `CircuitBreaker.threshold` setter validation | None | Two assertions for 0 and -5 input | Low - validation logic |  | Prevents invalid configuration | None |
| `test_threshold_setter_rebuilds_breaker_records` | Threshold setter rebuilds existing breaker deques | Deque reconstruction with new maxlen (line 77) | `CircuitBreaker.threshold` setter, `_breaker_records` | None | Threshold change preserves failure records | Medium - deque rebuild |  | Tests line 77 coverage for existing breakers | Verify deque maxlen change |
| `test_threshold_setter_rebuilds_tool_breakers` | Threshold setter rebuilds tool breaker deques | Tool breaker deque reconstruction with new maxlen (line 82) | `CircuitBreaker.threshold` setter, `_tool_breakers` | None | Threshold change preserves tool failure records | Medium - deque rebuild |  | Tests line 82 coverage for tool breakers | Verify tool deque maxlen |
| `test_window_seconds_getter_returns_initial_value` | Window seconds getter returns configured value (line 95) | Getter property for window configuration | `CircuitBreaker.window_seconds` (line 95) | None | `assert breaker.window_seconds == 30.5` | Low - simple property |  | Tests line 95 coverage | None |
| `test_window_seconds_setter_updates_value` | Window seconds setter updates value | Setter updates _window_seconds attribute | `CircuitBreaker.window_seconds` setter | None | `assert breaker.window_seconds == 120.0` | Low - simple property |  | Basic setter behavior | None |
| `test_window_seconds_setter_enforces_minimum` | Window seconds setter enforces minimum=0.1s | Value validation preventing invalid windows | `CircuitBreaker.window_seconds` setter validation | None | Two assertions for 0.05 and -10.0 input | Low - validation logic |  | Prevents invalid window values | None |
| `test_allows_returns_true_for_empty_user_id` | Allows returns True for empty/None user_id | Empty user ID bypass logic | `CircuitBreaker.allows()` | None | Two assertions for "" and None | Low - guard clause |  | Safety for missing user context | None |
| `test_record_failure_does_nothing_for_empty_user_id` | Record failure early-returns for empty user_id (line 139) | Empty user ID guard in record_failure | `CircuitBreaker.record_failure()` (line 139) | None | Verify no state created in `_breaker_records` | Low - guard clause |  | Tests line 139 coverage | None |
| `test_allows_evicts_old_failures` | Allows evicts failures outside time window | Time-based failure eviction logic | `CircuitBreaker.allows()` eviction | `patch.object(time, "time")` | Breaker tripped at t=0, recovered at t=15 | Medium - time-based logic |  | Sliding window implementation | Verify eviction timing |
| `test_reset_clears_failures` | Reset clears all failures for user | Reset functionality restoring breaker state | `CircuitBreaker.reset()` | None | Breaker tripped then recovered after reset | Low - state clearing |  | Manual recovery mechanism | None |
| `test_reset_handles_empty_user_id` | Reset handles empty user_id gracefully | Empty user ID guard in reset | `CircuitBreaker.reset()` | None | No exceptions raised | Low - guard clause |  | Safety for missing user | None |
| `test_reset_handles_nonexistent_user` | Reset handles nonexistent users gracefully | Missing key handling in reset | `CircuitBreaker.reset()` | None | No exceptions raised | Low - error handling |  | Defensive programming | None |
| `test_tool_allows_returns_true_for_empty_user_id` | Tool allows returns True for empty user_id (line 174) | Empty user ID bypass in tool_allows | `CircuitBreaker.tool_allows()` (line 174) | None | Two assertions for "" and None | Low - guard clause |  | Tests line 174 coverage | None |
| `test_tool_allows_returns_true_for_empty_tool_type` | Tool allows returns True for empty tool_type (line 174) | Empty tool type bypass in tool_allows | `CircuitBreaker.tool_allows()` (line 174) | None | Two assertions for "" and None | Low - guard clause |  | Tests line 174 coverage | None |
| `test_tool_allows_evicts_old_failures` | Tool allows evicts failures outside window (line 181) | Time-based tool failure eviction | `CircuitBreaker.tool_allows()` eviction (line 181) | `patch.object(time, "time")` | Tool breaker tripped at t=0, recovered at t=15 | Medium - time-based logic |  | Tests line 181 coverage | Verify tool eviction timing |
| `test_record_tool_failure_does_nothing_for_empty_user_id` | Record tool failure early-returns for empty user_id (line 194) | Empty user ID guard in record_tool_failure | `CircuitBreaker.record_tool_failure()` (line 194) | None | Verify no state created in `_tool_breakers` | Low - guard clause |  | Tests line 194 coverage | None |
| `test_record_tool_failure_does_nothing_for_empty_tool_type` | Record tool failure early-returns for empty tool_type (line 194) | Empty tool type guard in record_tool_failure | `CircuitBreaker.record_tool_failure()` (line 194) | None | Verify no state created in `_tool_breakers` | Low - guard clause |  | Tests line 194 coverage | None |
| `test_reset_tool_does_nothing_for_empty_user_id` | Reset tool early-returns for empty user_id (line 206) | Empty user ID guard in reset_tool | `CircuitBreaker.reset_tool()` (line 206) | None | No exceptions raised | Low - guard clause |  | Tests line 206 coverage | None |
| `test_reset_tool_does_nothing_for_empty_tool_type` | Reset tool early-returns for empty tool_type (line 206) | Empty tool type guard in reset_tool | `CircuitBreaker.reset_tool()` (line 206) | None | No exceptions raised | Low - guard clause |  | Tests line 206 coverage | None |
| `test_reset_tool_clears_failures` | Reset tool clears failures for specific tool type | Tool-specific reset functionality | `CircuitBreaker.reset_tool()` | None | Tool breaker tripped then recovered after reset | Low - state clearing |  | Manual tool recovery | None |
| `test_reset_tool_handles_nonexistent_records` | Reset tool handles nonexistent user/tool gracefully | Missing key handling in reset_tool | `CircuitBreaker.reset_tool()` | None | No exceptions raised for invalid keys | Low - error handling |  | Defensive programming | None |
| `test_tool_breakers_independent_per_tool_type` | Different tool types have independent breakers | Tool type isolation in breaker tracking | `CircuitBreaker.tool_allows()`, `record_tool_failure()` | None | tool_a tripped, tool_b still allowed | Medium - isolation logic |  | Per-tool-type tracking | None |
| `test_note_auth_failure_does_nothing_for_empty_scope_key` | Note auth failure early-returns for empty scope (line 226) | Empty scope key guard in note_auth_failure | `CircuitBreaker.note_auth_failure()` (line 226) | None | Verify no state created in `_AUTH_FAILURE_UNTIL` | Low - guard clause |  | Tests line 226 coverage | None |
| `test_note_auth_failure_uses_default_ttl_for_zero` | Note auth failure treats ttl=0 as default 60s | Python falsy value fallback (`0 or 60`) | `CircuitBreaker.note_auth_failure()` | `patch.object(time, "time")` | TTL of 0 becomes 60s (1060.0 timestamp) | Medium - subtle behavior |  | Python `or` operator behavior | Document this quirk |
| `test_note_auth_failure_does_nothing_for_negative_ttl` | Note auth failure early-returns for negative TTL (lines 230-231) | Negative TTL validation | `CircuitBreaker.note_auth_failure()` (lines 230-231) | None | Verify no state created for negative TTL | Low - validation logic |  | Tests lines 230-231 coverage | None |
| `test_note_auth_failure_records_with_default_ttl` | Note auth failure records with default 60s TTL (lines 229, 233-235) | Default TTL application | `CircuitBreaker.note_auth_failure()` (lines 229, 233-235) | `patch.object(time, "time")` | Timestamp = current + 60s | Low - default behavior |  | Tests lines 229, 233-235 | None |
| `test_note_auth_failure_records_with_custom_ttl` | Note auth failure records with custom TTL | Custom TTL parameter handling | `CircuitBreaker.note_auth_failure()` | `patch.object(time, "time")` | Timestamp = current + 120s | Low - parameter passing |  | Custom TTL configuration | None |
| `test_auth_failure_active_returns_false_for_empty_scope_key` | Auth failure active returns False for empty scope (line 249) | Empty scope key guard in auth_failure_active | `CircuitBreaker.auth_failure_active()` (line 249) | None | Two assertions for "" and None | Low - guard clause |  | Tests line 249 coverage | None |
| `test_auth_failure_active_returns_false_for_unknown_scope` | Auth failure active returns False for unknown scope (lines 254-255) | Missing key handling in auth_failure_active | `CircuitBreaker.auth_failure_active()` (lines 254-255) | None | Unknown scope returns False | Low - missing key |  | Tests lines 254-255 coverage | None |
| `test_auth_failure_active_returns_true_when_active` | Auth failure active returns True when within TTL (line 259) | Active auth failure detection | `CircuitBreaker.auth_failure_active()` (line 259) | `patch.object(time, "time")` | Returns True at t=1030 (within TTL) | Low - timestamp comparison |  | Tests line 259 coverage | None |
| `test_auth_failure_active_returns_false_when_expired` | Auth failure active returns False and cleans up expired entries (lines 256-258) | Expired auth failure cleanup | `CircuitBreaker.auth_failure_active()` (lines 256-258) | `patch.object(time, "time")` | Returns False at t=1100, entry removed | Medium - cleanup logic |  | Tests lines 256-258 coverage | Verify cleanup timing |
| `test_auth_failure_thread_safe` | Auth failure operations are thread-safe | Thread safety of class-level dict operations | `CircuitBreaker.note_auth_failure()`, `auth_failure_active()` | `threading.Thread` | No exceptions from concurrent access | High - concurrency |  | Thread safety validation | Load test concurrency |
| `test_full_breaker_lifecycle` | Complete lifecycle: record, trip, evict, recover | End-to-end breaker state transitions | Full `CircuitBreaker` flow | `patch.object(time, "time")` | Breaker trips at threshold, recovers after window | Medium - integration |  | Integration test for core flow | None |
| `test_threshold_change_with_active_failures` | Threshold change affects active failures immediately | Dynamic threshold adjustment with existing failures | `CircuitBreaker.threshold` setter with active state | None | Reducing threshold trips active breakers | Medium - state interaction |  | Dynamic configuration | Test edge cases |
| `test_multiple_users_isolated` | Different users have isolated breakers | User isolation in breaker tracking | `CircuitBreaker` user_id keying | None | user-1 tripped, user-2 allowed | Medium - isolation |  | Per-user tracking | None |
| `test_auth_failure_shared_across_instances` | Auth failures shared across breaker instances | Class-level state sharing | `CircuitBreaker._AUTH_FAILURE_UNTIL` | `patch.object(time, "time")` | Both instances see same auth failure | Medium - class variable |  | Global auth state | None |
| `test_request_breaker_trips_after_threshold` | Request breaker trips after N failures in window | Pipe wrapper for request breaker | `Pipe._record_failure()`, `_breaker_allows()` | `monkeypatch`, `pipe_instance` | Breaker blocks after 3 failures | Low - wrapper test |  | Pipe integration test | None |
| `test_request_breaker_resets_on_success` | Reset clears failures allowing requests again | Pipe wrapper for breaker reset | `Pipe._reset_failure_counter()` | `monkeypatch`, `pipe_instance` | Reset recovers blocked breaker | Low - wrapper test |  | Pipe recovery mechanism | None |
| `test_breaker_window_sliding` | Failures outside window evicted and don't count | Sliding window eviction in Pipe wrapper | `Pipe._record_failure()`, `_breaker_allows()` | `monkeypatch`, `pipe_instance` | Old failures evicted after window | Medium - time-based |  | Time window behavior | None |
| `test_tool_breaker_tracks_failures_by_type` | Tool breaker tracks failures per type, blocks only that type | Pipe wrapper for tool breaker | `Pipe._record_tool_failure_type()`, `_tool_type_allows()` | `monkeypatch`, `pipe_instance` | Function type blocked, other_type allowed | Medium - isolation |  | Tool-specific tracking | None |
| `test_tool_breaker_skips_failing_tool_type` | Blocked tool types emit status notification | Tool breaker notification mechanism | `Pipe._notify_tool_breaker()` | `pipe_instance_async`, event emitter | Status event emitted with "Skipping" message | Medium - async notification |  | User notification for blocked tools | Verify message format |
| `test_db_breaker_tracks_failures` | DB breaker tracks failures and blocks DB ops | Pipe wrapper for database breaker | `Pipe._record_db_failure()`, `_db_breaker_allows()` | `monkeypatch`, `pipe_instance` | DB ops blocked after 2 failures | Low - wrapper test |  | Database circuit breaker | None |
| `test_db_breaker_suppresses_persistence_on_failure` | Tripped DB breaker returns empty list and emits warning | DB persistence bypass when breaker tripped | `Pipe._db_persist()` with tripped breaker | `monkeypatch`, `pipe_instance_async`, event emitter, context tokens | Empty list returned, warning notification emitted | High - complex async |  | DB failure handling | Verify warning content |
| `test_invalid_encrypted_api_key_returns_auth_error_and_skips_catalog` | Invalid API key returns error without calling catalog | Auth failfast preventing unnecessary API calls | `Pipe._handle_pipe_call()` with invalid key | `monkeypatch`, `aioresponses` | Auth error returned, no catalog call made | High - security flow |  | Early auth validation | None |
| `test_invalid_encrypted_api_key_task_returns_safe_stub` | Invalid API key for task returns safe stub response | Task-specific auth failure handling | `Pipe._handle_pipe_call()` with task parameter | `monkeypatch`, `aioresponses` | Safe JSON stub returned for task | Medium - task handling |  | Task failure safety | Verify stub format |
| `test_process_transformed_request_accepts_string_task` | Process transformed request accepts string task parameter | Task parameter type handling and processing | `Pipe._process_transformed_request()` with task | `aioresponses` (catalog + responses mocks) | Task processed successfully with mocked responses | High - integration |  | End-to-end task flow | Verify API contract |


## `tests/test_concurrency_limits.py`

| Test Name | Description | What It Tests | Code Under Test | Mocks/Fixtures | Assertions | Drift Risk | Check Done | Codex Notes | Codex TODO |
|-----------|-------------|---------------|-----------------|----------------|------------|------------|------------|-------------|------------|
| TestRequestQueueLimits.test_request_queue_full_rejects_enqueue | Tests that when the internal request queue reaches capacity (500), _enqueue_job correctly rejects new jobs. Fills queue to maxsize, then attempts to enqueue another job and verifies it returns False. | Queue capacity enforcement: verifies that once the request queue is full, additional enqueue attempts fail gracefully rather than blocking or erroring | Pipe._enqueue_job, Pipe._ensure_concurrency_controls, Pipe._request_queue | pipe_instance_async fixture; manually creates _PipeJob instances with loop.create_future(); uses asyncio.Queue operations | assert queue.full() after filling; assert result is False when enqueueing to full queue | low | yes | Tests instance-level queue (not class-level); creates 500 jobs to fill queue; properly cleans up by draining queue | |
| TestRequestQueueLimits.test_global_semaphore_limits_parallel_requests | Tests that MAX_CONCURRENT_REQUESTS valve setting correctly limits concurrent requests using a global semaphore. Acquires all permits (2), verifies third acquire blocks, then releases one permit and confirms blocked task completes. | Global semaphore enforcement: validates that MAX_CONCURRENT_REQUESTS valve creates a working semaphore that blocks when all slots are held and unblocks when permits are released | Pipe._ensure_concurrency_controls, Pipe class._global_semaphore, Pipe class._semaphore_limit | pipe_instance_async fixture; resets class-level _global_semaphore and _semaphore_limit; creates async task for blocked acquire | assert semaphore is not None; assert not blocked_task.done() while blocked; await asyncio.wait_for(blocked_task, timeout=1.0) after release | med | yes | Uses class-level semaphore; properly saves/restores original values; handles cleanup with contextlib.suppress; casts semaphore type for clarity | |
| TestToolSemaphore.test_global_tool_semaphore_limits_parallel_tools | Tests that MAX_PARALLEL_TOOLS_GLOBAL valve setting correctly limits parallel tool executions using a global tool semaphore. Acquires both permits (2), verifies third acquire blocks, then releases and confirms unblocking. | Global tool semaphore enforcement: validates that MAX_PARALLEL_TOOLS_GLOBAL valve creates a working tool semaphore that limits concurrent tool executions across all requests | Pipe._ensure_concurrency_controls, Pipe class._tool_global_semaphore, Pipe class._tool_global_limit | pipe_instance_async fixture; resets class-level _tool_global_semaphore and _tool_global_limit; creates async task for blocked acquire | assert semaphore is not None; assert not blocked_task.done() while blocked; await asyncio.wait_for(blocked_task, timeout=1.0) after release | med | yes | Mirrors structure of test_global_semaphore_limits_parallel_requests but for tool execution; uses class-level tool semaphore; proper cleanup | |
| TestToolSemaphore.test_per_request_tool_semaphore_is_configured_from_valves | Tests that MAX_PARALLEL_TOOLS_PER_REQUEST valve correctly configures the limit for per-request tool execution. Creates a semaphore with the valve limit and verifies it can acquire up to the limit and blocks beyond. | Per-request tool concurrency configuration: validates that the valve setting would create a correctly-configured semaphore for limiting tools within a single request | asyncio.Semaphore creation with valves.MAX_PARALLEL_TOOLS_PER_REQUEST | pipe_instance_async fixture; manually creates asyncio.Semaphore with configured limit | assert len(acquired) == limit; pytest.raises(asyncio.TimeoutError) when exceeding limit | low | yes | Unit test of semaphore behavior rather than full integration; simulates what _execute_pipe_job does; uses timeout to detect blocking | |
| TestSemaphoreRuntimeUpdate.test_semaphore_limit_increase_at_runtime | Tests that increasing MAX_CONCURRENT_REQUESTS at runtime immediately releases additional semaphore permits. Starts with limit of 1, blocks second acquire, increases to 2, and verifies blocked task completes. | Dynamic semaphore reconfiguration: validates that increasing the concurrency limit at runtime (via valve update) immediately makes additional permits available without requiring pipe restart | Pipe._ensure_concurrency_controls with different valve values, Pipe class._global_semaphore | pipe_instance_async fixture; resets class-level semaphore; creates valves with different MAX_CONCURRENT_REQUESTS values; creates async task for blocked acquire | assert not blocked.done() before increase; await asyncio.wait_for(blocked, timeout=1.0) after increase to verify unblocking | med | yes | Tests hot-reconfiguration capability; demonstrates graceful limit increase; properly saves/restores class-level state | |


## `tests/test_debug.py`

| Test Name | Description | What It Tests | Code Under Test | Mocks/Fixtures | Assertions | Drift Risk | Check Done | Codex Notes | Codex TODO |
|-----------|-------------|---------------|-----------------|----------------|------------|------------|------------|-------------|------------|
| test_debug_print_request_success_with_payload | Tests normal success path with headers and payload for request debugging | Verifies that request headers and payload are logged with proper redaction of authorization tokens | `open_webui_openrouter_pipe.requests.debug._debug_print_request` | caplog fixture, test logger at DEBUG level | Checks that "OpenRouter request headers" and "OpenRouter request payload" appear in logs, and that auth token is redacted | low | yes | Uses caplog to verify debug output, tests authorization redaction |  |
| test_debug_print_request_no_payload | Tests _debug_print_request with None payload | Verifies function handles None payload gracefully without logging payload | `open_webui_openrouter_pipe.requests.debug._debug_print_request` | caplog fixture, test logger at DEBUG level | Checks that "OpenRouter request headers" appears in logs and no error occurs | low | yes | Tests None payload edge case |  |
| test_debug_print_request_empty_headers | Tests _debug_print_request with empty or None headers | Verifies function handles empty headers dict gracefully | `open_webui_openrouter_pipe.requests.debug._debug_print_request` | caplog fixture, test logger at DEBUG level | Checks that "OpenRouter request headers" appears in logs | low | yes | Tests empty dict edge case |  |
| test_debug_print_request_short_authorization | Tests _debug_print_request with short authorization token (<=10 chars) | Verifies short auth tokens are replaced with "***" | `open_webui_openrouter_pipe.requests.debug._debug_print_request` | caplog fixture, test logger at DEBUG level | Checks that "***" appears in output for short tokens | low | yes | Tests edge case of short token redaction |  |
| test_debug_print_request_exception_handling | Tests exception handling when json.dumps fails (lines 41-43) | Verifies exceptions are caught and logged rather than propagated | `open_webui_openrouter_pipe.requests.debug._debug_print_request` | _DebugEnabledLogger custom logger, unserializable object | Checks that "failed" appears in logged messages | med | yes | Explicitly targets lines 41-43 coverage, tests exception path |  |
| test_debug_print_request_redact_exception | Tests exception when _redact_payload_blobs raises (lines 41-43) | Verifies exceptions from redaction are caught and logged | `open_webui_openrouter_pipe.requests.debug._debug_print_request` | _DebugEnabledLogger, patch of _redact_payload_blobs | Checks that "failed" appears in logged messages | med | yes | Tests exception in redaction utility |  |
| test_debug_print_response_debug_disabled | Tests early return when DEBUG is not enabled (line 52) | Verifies function returns early without calling debug() when DEBUG disabled | `open_webui_openrouter_pipe.requests.debug._debug_print_response` | _NoDebugLogger custom logger | No assertion - test passes if debug() not called (would raise AssertionError) | low | yes | Explicitly targets line 52 coverage |  |
| test_debug_print_response_success | Tests normal success path for response logging | Verifies response payload is logged when DEBUG enabled | `open_webui_openrouter_pipe.requests.debug._debug_print_response` | caplog fixture, test logger at DEBUG level | Checks that "OpenRouter response payload" appears in logs | low | yes | Standard success path test |  |
| test_debug_print_response_non_dict_payload | Tests _debug_print_response with non-dict payload | Verifies non-dict payloads bypass redaction and are logged directly | `open_webui_openrouter_pipe.requests.debug._debug_print_response` | caplog fixture, test logger at DEBUG level | Checks that "OpenRouter response payload" appears in logs | low | yes | Tests edge case of list payload |  |
| test_debug_print_response_exception_handling | Tests exception handling when json.dumps fails (lines 56-57) | Verifies exceptions are caught and logged when serialization fails | `open_webui_openrouter_pipe.requests.debug._debug_print_response` | _DebugEnabledLogger, unserializable object | Checks that "failed" appears in logged messages | med | yes | Explicitly targets lines 56-57 coverage |  |
| test_debug_print_response_redact_exception | Tests exception when redaction fails (lines 56-57) | Verifies exceptions from _redact_payload_blobs are caught and logged | `open_webui_openrouter_pipe.requests.debug._debug_print_response` | _DebugEnabledLogger, patch of _redact_payload_blobs | Checks that "failed" appears in logged messages | med | yes | Tests exception in redaction utility |  |
| test_debug_print_error_response_debug_disabled_success | Tests early return path when DEBUG not enabled (lines 71-72) | Verifies function reads and returns response text without debug logging when DEBUG disabled | `open_webui_openrouter_pipe.requests.debug._debug_print_error_response` | _NoDebugLogger, MagicMock with AsyncMock text method | Checks result equals "Error body text" and text() was awaited once | low | yes | Async test, explicitly targets lines 71-72 coverage |  |
| test_debug_print_error_response_debug_disabled_text_fails | Tests exception reading text when DEBUG disabled (lines 73-74) | Verifies error message is returned when resp.text() fails with DEBUG disabled | `open_webui_openrouter_pipe.requests.debug._debug_print_error_response` | _NoDebugLogger, MagicMock with failing AsyncMock text | Checks result contains "failed to read body" and exception message | low | yes | Async test, explicitly targets lines 73-74 coverage |  |
| test_debug_print_error_response_debug_enabled_success | Tests success path when DEBUG is enabled | Verifies response body is returned and debug logging occurs | `open_webui_openrouter_pipe.requests.debug._debug_print_error_response` | _DebugEnabledLogger, MagicMock with response attributes and AsyncMock text | Checks result equals response text and "OpenRouter error response" logged | low | yes | Async test, standard success path |  |
| test_debug_print_error_response_debug_enabled_text_fails | Tests exception reading text when DEBUG enabled (lines 79-80) | Verifies error message is captured when resp.text() fails with DEBUG enabled | `open_webui_openrouter_pipe.requests.debug._debug_print_error_response` | _DebugEnabledLogger, MagicMock with failing AsyncMock text | Checks result contains "failed to read body" and exception message | low | yes | Async test, explicitly targets lines 79-80 coverage |  |
| test_debug_print_error_response_outer_exception_text_success | Tests outer exception handler with successful text retry (lines 89-92) | Verifies fallback text() call succeeds when outer try block fails | `open_webui_openrouter_pipe.requests.debug._debug_print_error_response` | _DebugEnabledLogger, MagicMock, patch of json.dumps to fail | Checks result equals "Error body" and "failed" logged | med | yes | Async test, explicitly targets lines 89-92, patches json.dumps |  |
| test_debug_print_error_response_outer_exception_text_fails | Tests outer exception handler when text retry also fails (lines 93-94) | Verifies error message returned when both outer block and fallback text() fail | `open_webui_openrouter_pipe.requests.debug._debug_print_error_response` | _DebugEnabledLogger, MagicMock with conditional AsyncMock behavior, patch of json.dumps | Checks result contains "failed to read body" and exception message | med | yes | Async test, explicitly targets lines 93-94, complex mock behavior |  |
| test_debug_print_error_response_missing_attributes | Tests with response object missing some attributes | Verifies function handles missing status/reason attributes gracefully | `open_webui_openrouter_pipe.requests.debug._debug_print_error_response` | _DebugEnabledLogger, MagicMock with deleted attributes | Checks result equals "Error body" and debug message logged | low | yes | Async test, tests getattr fallback behavior |  |
| test_debug_print_error_response_getattr_fallbacks | Tests getattr fallbacks for status, reason, url attributes | Verifies function works with minimal response object lacking expected attributes | `open_webui_openrouter_pipe.requests.debug._debug_print_error_response` | _DebugEnabledLogger, custom MinimalResponse class with only text() | Checks result equals "Minimal body" and "OpenRouter error response" logged | low | yes | Async test, uses custom minimal response class |  |
| test_redact_payload_blobs_truncates_data_urls | Tests that data URLs in payloads are truncated | Verifies data URLs are redacted and truncated to max_chars | `open_webui_openrouter_pipe.core.utils._redact_payload_blobs` | None | Checks redacted value starts with data URL prefix, contains "[REDACTED]", and is shorter than original | low | yes | Tests utility function for payload redaction |  |
| test_redact_payload_blobs_handles_nested_structures | Tests redaction of data URLs in nested dict/list structures | Verifies redaction works recursively on nested data structures | `open_webui_openrouter_pipe.core.utils._redact_payload_blobs` | None | Checks "[REDACTED]" appears in nested structure | low | yes | Tests recursive redaction behavior |  |
| test_debug_print_request_redacts_authorization_and_payload | Tests that both authorization header and payload blobs are redacted | Verifies comprehensive redaction of sensitive data in request logging | `open_webui_openrouter_pipe.requests.debug._debug_print_request` | caplog fixture, test logger at DEBUG level | Checks both header/payload messages logged, auth token not present, and "[REDACTED]" present | low | yes | Comprehensive redaction test covering both auth and payload |  |
| test_debug_print_request_no_output_when_not_debug | Tests that debug() is not called when DEBUG level not enabled | Verifies early return behavior when DEBUG disabled | `open_webui_openrouter_pipe.requests.debug._debug_print_request` | Custom _NoDebugLogger class that raises on debug() | No assertion - test passes if debug() not called | low | yes | Duplicate coverage of DEBUG disabled path with different implementation |  |
| test_debug_print_response_redacts_payload | Tests that response payload data URLs are redacted | Verifies payload redaction works for response logging | `open_webui_openrouter_pipe.requests.debug._debug_print_response` | caplog fixture, test logger at DEBUG level | Checks "OpenRouter response payload" logged and "[REDACTED]" present | low | yes | Tests response-specific redaction behavior |  |


## `tests/test_direct_tool_servers.py`

| Test Name | Description | What It Tests | Code Under Test | Mocks/Fixtures | Assertions | Drift Risk | Check Done | Codex Notes | Codex TODO |
|-----------|-------------|---------------|-----------------|----------------|------------|------------|------------|-------------|------------|
| test_direct_tool_servers_are_advertised_and_executable | Tests that tool servers from metadata are advertised in body.tools sent to OpenRouter via HTTP request capture and executable via callable that invokes __event_call__. | Verifies direct tool server integration: tools from metadata.tool_servers are registered in HTTP request to OpenRouter and can be executed via __event_call__. | Pipe._process_transformed_request, Pipe._create_http_session, ModelFamily.set_dynamic_specs | aioresponses for HTTP mocking (catalog and /responses endpoints), custom callback to capture request body, mock __event_call__ tracking | Captured HTTP request body contains getWeather tool with type="function", result is not None | low | yes | REAL TEST using aioresponses for HTTP boundary. Exercises real tool server integration logic and HTTP request construction. Tests full integration flow from metadata to request. | |
| test_direct_tool_servers_skipped_without_event_call | Tests that tool servers are NOT advertised when __event_call__ is None. Captures HTTP request to verify tools were NOT added. | Verifies conditional logic: direct tool servers should not be registered when __event_call__ is unavailable (None). | Pipe._process_transformed_request, Pipe._create_http_session, ModelFamily.set_dynamic_specs | aioresponses for HTTP mocking (catalog and /responses endpoints), custom callback to capture request body, __event_call__ explicitly set to None | Captured HTTP request body does NOT contain getWeather tool, result is not None | low | yes | REAL TEST using aioresponses for HTTP boundary. Tests the negative case - tools should be skipped when execution mechanism is unavailable. | |


## `tests/test_direct_uploads.py`

| Test Name | Description | What It Tests | Code Under Test | Mocks/Fixtures | Assertions | Drift Risk | Check Done | Codex Notes | Codex TODO |
|-----------|-------------|---------------|-----------------|----------------|------------|------------|------------|-------------|------------|
| test_direct_uploads_audio_with_allowlisted_format_routes_to_responses | Tests that audio files with allowlisted format (m4a) route to /responses endpoint when in the allowlist. Uses real Pipe instance with HTTP mocked. | Verifies endpoint routing logic when audio format matches responses_audio_format_allowlist ("m4a"). | Pipe.pipe(), endpoint selection logic, audio file handling | aioresponses (HTTP mock), AsyncMock for _get_file_by_id and _read_file_record_base64, MagicMock for file objects | Asserts total_calls >= 1 (at least one API call made) | med (mocks HTTP and file I/O) | yes | Tests allowlist-based endpoint routing for audio; uses real Pipe with boundary mocking | |
| test_direct_uploads_audio_without_allowlisted_format_forces_chat_completions | Tests that audio NOT in allowlist (m4a sniffed but allowlist is "mp3,wav") forces /chat/completions endpoint. Uses real Pipe instance. | Verifies that mismatched audio format forces chat_completions endpoint instead of /responses. | Pipe.pipe(), endpoint selection, audio format validation | aioresponses (HTTP mock), AsyncMock for _get_file_by_id and _read_file_record_base64, MagicMock for file objects | Asserts total_calls >= 1, messages presence, and audio inclusion in chat_called payloads | med (mocks HTTP and file I/O) | yes | Tests format mismatch handling; m4a signature vs mp3,wav allowlist | |
| test_direct_uploads_audio_injects_audio_blocks | Tests that audio direct uploads are properly injected into request payload as audio blocks. Uses real Pipe instance. | Verifies audio blocks are added to message content with correct structure. | Pipe.pipe(), audio injection logic, multimodal handling | aioresponses (HTTP mock), AsyncMock for _get_file_by_id and _read_file_record_base64, MagicMock for file objects | Asserts captured_payloads >= 1 and found_audio_block is True (audio block with "audio" in type) | med (mocks HTTP and file I/O) | yes | Tests audio block structure injection; checks for input_audio or audio block types | |
| test_task_requests_do_not_inject_direct_uploads | Tests that task requests (like title_generation) do NOT get direct uploads injected, preserving them for main chat. | Verifies __task__ parameter prevents direct upload injection, keeping files in metadata for later chat request. | Pipe.pipe(), task request handling, direct uploads preservation logic | aioresponses (HTTP mock), smart_callback for endpoint detection | Asserts direct_uploads still in metadata and no file blocks in task request payloads | med (mocks HTTP) | yes | Critical test for task vs chat request handling; prevents file consumption on title generation | |
| test_task_first_preserves_direct_uploads_for_chat | Tests sequential workflow: task request first (no files), then chat request (with files). Verifies direct uploads preserved for chat. | Verifies that after a task request, direct uploads remain in metadata and are injected only into subsequent chat request. | Pipe.pipe(), task/chat sequencing, direct uploads lifecycle | aioresponses (HTTP mock), AsyncMock for _inline_owui_file_id, smart_callback | Asserts task payloads have no file blocks, chat payloads have file blocks, and found_file_block is True | med (mocks HTTP and file inlining) | yes | Integration test for task->chat workflow; validates file injection timing and preservation | |
| test_direct_uploads_injected_into_chat_request_payload | Tests that direct uploads are injected into API request payload with proper file_data inlining. | Verifies file blocks are added to request with inlined data URLs when __task__ is None. | Pipe.pipe(), file injection, _inline_owui_file_id | aioresponses (HTTP mock), AsyncMock for _inline_owui_file_id, smart_callback | Asserts found_file_block is True, file_data exists, and file_data starts with "data:" | med (mocks HTTP and file inlining) | yes | Tests complete file injection with data URL inlining; validates file_data field presence | |
| test_auto_attach_direct_uploads_filter_and_persist_capabilities | Tests automatic attachment of direct uploads filter to model and capability persistence in metadata. | Verifies _update_or_insert_model_with_metadata adds filterIds and persists capabilities when auto_attach is True. | Pipe._update_or_insert_model_with_metadata() | patch for Models.get_model_by_id, Models.update_model_by_id, ModelForm; Mock for update_model_by_id | Asserts update_mock called once, filterIds == ["openrouter_direct_uploads"], direct_uploads_filter_id set, capabilities persisted | high (heavy patching of ORM) | yes | Tests model metadata update logic; validates filter attachment and capability storage | |
| test_auto_attach_removes_direct_uploads_filter_when_unsupported | Tests removal of direct uploads filter when model doesn't support files. Verifies cleanup when auto_attach is True but supported is False. | Verifies _update_or_insert_model_with_metadata removes filterIds when direct_uploads_filter_supported is False. | Pipe._update_or_insert_model_with_metadata() | patch for Models.get_model_by_id, Models.update_model_by_id, ModelForm; Mock for update_model_by_id | Asserts update_mock called once and filterIds == [] (empty list) | high (heavy patching of ORM) | yes | Tests filter removal when capabilities change; validates cleanup logic | |
| test_send_openrouter_streaming_request_respects_endpoint_override | Tests that endpoint_override parameter correctly routes to chat_completions vs responses endpoint. | Verifies send_openrouter_streaming_request honors endpoint_override="chat_completions" parameter. | Pipe.send_openrouter_streaming_request() | patch.object for send_openai_chat_completions_streaming_request and send_openai_responses_streaming_request | Asserts events == [{"type": "chat"}] (chat endpoint was used) | med (patches streaming methods) | yes | Tests explicit endpoint override routing; validates parameter-based routing control | |
| test_inline_internal_responses_input_files_inplace_rewrites_internal_urls | Tests in-place rewriting of internal file URLs to data URLs in Responses API format. | Verifies _inline_internal_responses_input_files_inplace converts /api/v1/files/ID/content URLs to data URLs. | Pipe._inline_internal_responses_input_files_inplace() | AsyncMock for _multimodal_handler._inline_owui_file_id | Asserts _inline_owui_file_id called with correct params, file_data starts with "data:", file_url removed | med (mocks file inlining) | yes | Tests URL rewriting for Responses API; validates input_file block transformation | |
| TestBlocklistFunction.test_blocklisted_model_returns_true | Tests that known blocklisted models return True from is_direct_upload_blocklisted(). | Verifies blocklist function correctly identifies blocklisted models. | is_direct_upload_blocklisted() | None (uses real blocklist) | Asserts True for gpt-4-turbo, gpt-4-1106-preview, llama-guard-3-8b, lfm2-8b-a1b | low (tests real code) | yes | Tests positive blocklist matches; uses REAL blocklist data | |
| TestBlocklistFunction.test_non_blocklisted_model_returns_false | Tests that non-blocklisted models return False. | Verifies blocklist function correctly identifies allowed models. | is_direct_upload_blocklisted() | None (uses real blocklist) | Asserts False for gpt-4o, claude-3-opus, gemini-pro, mistral-large | low (tests real code) | yes | Tests negative blocklist matches (allowed models) | |
| TestBlocklistFunction.test_case_insensitivity | Tests case-insensitive blocklist matching. | Verifies blocklist check ignores case (OpenAI, OPENAI, openai all match). | is_direct_upload_blocklisted() | None (uses real blocklist) | Asserts True for OpenAI/GPT-4-Turbo, OPENAI/GPT-4-TURBO, Meta-Llama/Llama-Guard-3-8B | low (tests real code) | yes | Tests case normalization in blocklist lookups | |
| TestBlocklistFunction.test_whitespace_handling | Tests that leading/trailing whitespace is ignored in blocklist checks. | Verifies blocklist function trims whitespace before matching. | is_direct_upload_blocklisted() | None (uses real blocklist) | Asserts True for "  openai/gpt-4-turbo  " and "\topenai/gpt-4-turbo\n" | low (tests real code) | yes | Tests whitespace normalization | |
| TestBlocklistFunction.test_empty_string_returns_false | Tests edge case of empty string input. | Verifies blocklist function doesn't crash on empty string and returns False. | is_direct_upload_blocklisted() | None (uses real blocklist) | Asserts False for empty string "" | low (tests real code) | yes | Tests edge case handling; no crash on empty input | |
| TestBlocklistFunction.test_none_like_values | Tests edge cases like whitespace-only strings. | Verifies blocklist function handles whitespace-only strings gracefully. | is_direct_upload_blocklisted() | None (uses real blocklist) | Asserts False for "   " (spaces only) | low (tests real code) | yes | Tests additional edge cases | |
| TestBlocklistFunction.test_blocklist_has_expected_count | Tests blocklist contains expected number of entries (29). | Verifies DIRECT_UPLOAD_BLOCKLIST has exactly 29 models. | DIRECT_UPLOAD_BLOCKLIST constant | None (uses real blocklist) | Asserts len(DIRECT_UPLOAD_BLOCKLIST) == 29 | low (tests real code) | yes | Regression test for blocklist size; will break if blocklist changes | Update count when blocklist changes |
| TestBlocklistFunction.test_all_blocklist_entries_are_strings | Tests blocklist data quality - all entries are non-empty strings with "/" separator. | Verifies each blocklist entry is valid provider/model format. | DIRECT_UPLOAD_BLOCKLIST constant | None (uses real blocklist) | Asserts each entry is str, len > 0, contains "/" | low (tests real code) | yes | Tests blocklist data structure; validates format consistency | |
| TestBlocklistCategories.test_provider_rejected_models_present | Tests that HTTP 400 models are in blocklist. | Verifies models that providers reject (liquid/lfm2-8b-a1b, etc.) are blocklisted. | DIRECT_UPLOAD_BLOCKLIST constant | None (uses real blocklist) | Asserts 6 provider-rejected models are in blocklist | low (tests real code) | yes | Tests specific category of blocklisted models | |
| TestBlocklistCategories.test_guard_models_present | Tests that guard/classifier models are in blocklist. | Verifies llama-guard-2-8b, llama-guard-3-8b, llama-guard-4-12b are blocklisted. | DIRECT_UPLOAD_BLOCKLIST constant | None (uses real blocklist) | Asserts 3 guard models are in blocklist | low (tests real code) | yes | Tests guard model category | |
| TestBlocklistCategories.test_explicit_no_file_support_present | Tests that models explicitly lacking file support are in blocklist. | Verifies gpt-4-turbo, gpt-4-1106-preview, qwen2.5-coder-7b-instruct are blocklisted. | DIRECT_UPLOAD_BLOCKLIST constant | None (uses real blocklist) | Asserts 3 no-file-support models are in blocklist | low (tests real code) | yes | Tests explicit no-support category | |
| test_upload_to_owui_storage_links_chat_file | Tests file upload properly links to chat and message via metadata. Uses real upload handler integration. | Verifies _upload_to_owui_storage passes chat_id/message_id in metadata and calls insert_chat_files. | Pipe._upload_to_owui_storage() | Mock for Chats.insert_chat_files; monkeypatch for upload_file_handler, run_in_threadpool | Asserts file_id == "file123", metadata structure correct, file object structure correct, insert_mock called once | med (mocks upload/ORM) | yes | Integration test for file-chat linking; validates metadata propagation and ORM calls | |
| test_upload_to_owui_storage_ignores_missing_insert_api | Tests graceful handling when insert_chat_files API is missing (backward compatibility). | Verifies _upload_to_owui_storage succeeds when Chats.insert_chat_files doesn't exist (older Open-WebUI). | Pipe._upload_to_owui_storage() | monkeypatch to remove insert_chat_files; Mock for upload_file_handler, run_in_threadpool | Asserts file_id == "file123" (succeeds despite missing API) | med (mocks upload, removes API) | yes | Backward compatibility test; validates graceful degradation | |
| test_direct_uploads_filter_fails_open_when_model_lacks_file_capability | Tests filter fails open (allows files through) when model lacks file_input capability, with warning. | Verifies Filter.inlet preserves files in body but adds warning when capabilities.file_input is False. | Filter.inlet() from openrouter_direct_uploads_toggle | None (uses real Filter) | Asserts files unchanged, direct_uploads is None, warnings list contains expected message | low (tests real filter) | yes | Fail-open safety test; ensures files aren't dropped even when unsupported | |
| test_direct_uploads_filter_bypasses_owui_file_context_via_metadata_files | Tests filter removes diverted files from both body.files AND metadata.files to bypass OWUI File Context. | Verifies Filter.inlet removes direct-upload files from metadata.files so OWUI doesn't show them in File Context. | Filter.inlet() from openrouter_direct_uploads_toggle | None (uses real Filter) | Asserts body.files == [retained], metadata.files == [retained], direct_uploads.files == [diverted] | low (tests real filter) | yes | Critical test for File Context bypass; validates metadata.files mutation to prevent OWUI interference | |


## `tests/test_encryption_edge_cases.py`

| Test Name | Description | What It Tests | Code Under Test | Mocks/Fixtures | Assertions | Drift Risk | Check Done | Codex Notes | Codex TODO |
|-----------|-------------|---------------|-----------------|----------------|------------|------------|------------|-------------|------------|
| `test_maybe_compress_payload_respects_min_bytes_threshold` | When MIN_COMPRESS_BYTES is set, small payloads are not compressed. | Validates that compression is skipped when payload size is below the configured minimum compression threshold | `pipe._maybe_compress_payload()` - compression logic with size threshold checking | `pipe_instance` fixture; manually sets `pipe._artifact_store._compression_enabled = True` and `pipe._artifact_store._compression_min_bytes = 10_000` | `assert data == serialized` - verifies original data returned unchanged; `assert compressed is False` - verifies compression flag is False | LOW - Compression threshold logic is stable; risk if internal threshold checking changes | MANUAL | Tests compression optimization feature; ensures small payloads bypass compression for performance | Verify MIN_COMPRESS_BYTES configuration is documented; check if threshold value is appropriate for production use |
| `test_encode_payload_bytes_sets_plain_flag_when_not_compressed` | _encode_payload_bytes uses the plain flag when compression is skipped. | Verifies that the PLAIN flag is set in encoded payload when compression threshold prevents compression | `pipe._encode_payload_bytes()`, `pipe._decode_payload_bytes()` - payload encoding/decoding with flag handling | `pipe_instance` fixture; sets compression enabled with high threshold (10,000 bytes); imports `_PAYLOAD_FLAG_PLAIN` constant | `assert encoded[:1] == bytes([_PAYLOAD_FLAG_PLAIN])` - verifies first byte is PLAIN flag; `assert pipe._decode_payload_bytes(encoded) == payload` - roundtrip verification | MEDIUM - Flag constants and encoding format could change; risk if payload format evolves | MANUAL | Tests payload flag system integrity; ensures format markers are correctly set based on compression decision | Document payload format specification; verify flag values are stable across versions |
| `test_encode_payload_bytes_uses_lz4_flag_when_compression_is_effective` | When LZ4 yields a smaller buffer, _encode_payload_bytes marks it as compressed. | Validates that LZ4 flag is used when compression is enabled and effective on large compressible payloads | `pipe._encode_payload_bytes()`, `pipe._decode_payload_bytes()` - compression and flag handling | `pipe_instance` fixture; sets compression enabled with 0 threshold; uses highly compressible payload (10,000 repeated characters); imports `_PAYLOAD_FLAG_PLAIN` and `_PAYLOAD_FLAG_LZ4` | `assert pipe._decode_payload_bytes(encoded) == payload` - roundtrip verification; `assert encoded[:1] in {bytes([_PAYLOAD_FLAG_PLAIN]), bytes([_PAYLOAD_FLAG_LZ4])}` - flag validation | MEDIUM - Compression effectiveness depends on LZ4 implementation; flag constants could change | MANUAL | Tests compression decision logic; ensures flag correctly indicates compression state | Verify LZ4 compression ratio meets performance requirements; consider testing compression failure scenarios |
| `test_encrypt_payload_requires_encryption_key` | _encrypt_payload raises when ARTIFACT_ENCRYPTION_KEY is not configured. | Ensures encryption operations fail fast when encryption key is missing | `pipe._encrypt_payload()` - encryption initialization and validation | `pipe_instance` fixture; explicitly clears encryption config: `pipe._artifact_store._encryption_key = ""` and `pipe._artifact_store._fernet = None` | `with pytest.raises(RuntimeError)` - verifies RuntimeError is raised when encryption attempted without key | LOW - Fail-fast validation is unlikely to change; core security requirement | MANUAL | Tests security precondition enforcement; prevents silent failures in encryption flow | Verify error message is actionable; document encryption key configuration requirements |
| `test_encrypt_decrypt_payload_roundtrip_with_key` | _encrypt_payload and _decrypt_payload roundtrip when a key is configured. | Validates encryption/decryption cycle produces identical payload when key is properly configured | `pipe._encrypt_payload()`, `pipe._decrypt_payload()` - full encryption roundtrip | `pipe_instance` fixture; sets test encryption key: `pipe._artifact_store._encryption_key = "unit-test-artifact-key"`; clears Fernet instance for reinitialization | `assert isinstance(ciphertext, str) and ciphertext` - verifies ciphertext is non-empty string; `assert pipe._decrypt_payload(ciphertext) == payload` - roundtrip equality check | MEDIUM - Encryption implementation could change (Fernet version, algorithm); payload structure changes | MANUAL | Tests core encryption functionality; validates cryptographic roundtrip integrity | Review encryption key derivation method; verify Fernet configuration is production-ready; test with various payload sizes |
| `test_encrypt_if_needed_encrypts_reasoning_only_when_encrypt_all_false` | When ENCRYPT_ALL is False, only reasoning items are encrypted. | Verifies selective encryption logic - reasoning content is encrypted while other content types are stored plaintext | `pipe._encrypt_if_needed()` - conditional encryption based on content type and configuration | `pipe_instance` fixture; configures selective encryption: `pipe._artifact_store._encryption_key = "unit-test-artifact-key"`, `pipe._artifact_store._fernet = None`, `pipe._artifact_store._encrypt_all = False` | For "tool" type: `assert is_encrypted is False`, `assert stored == payload` - verifies no encryption; For "reasoning" type: `assert is_encrypted is True`, `assert isinstance(stored, dict)`, `assert "ciphertext" in stored`, `decrypted == payload` - verifies encryption and structure | HIGH - Content type classification logic could change; encryption policy could evolve; reasoning detection might be refined | MANUAL | Tests privacy-aware encryption policy; ensures sensitive reasoning content is protected while allowing optimization for non-sensitive data | Document which content types are considered sensitive; verify reasoning classification is comprehensive; consider testing edge cases for content type detection |


## `tests/test_error_handling.py`

| Test Name | Description | What It Tests | Code Under Test | Mocks/Fixtures | Assertions | Drift Risk | Check Done | Codex Notes | Codex TODO |
|-----------|-------------|---------------|-----------------|----------------|------------|------------|------------|-------------|------------|
| `test_basic_template_rendering` | Tests basic error template rendering with title and message | Template rendering engine correctly substitutes variables | `Pipe._emit_templated_error` | `mock_pipe`, `mock_event_emitter` | 2 events emitted, content contains "Test Error" and "Test message" | LOW |  | Validates fundamental template variable substitution | None |
| `test_error_id_generation` | Tests automatic error ID generation and inclusion in templates | Error IDs are generated as 16-char hex strings | `Pipe._emit_templated_error` | `mock_pipe`, `mock_event_emitter` | Error ID present, 16 hex chars long | LOW |  | Error IDs help correlate logs with user reports | None |
| `test_conditional_rendering` | Tests conditional block rendering with {{#if}} syntax | Conditional blocks render only when variables are truthy | `Pipe._emit_templated_error` | `mock_pipe`, `mock_event_emitter` | "Detail" shown, "This should not appear" hidden | MEDIUM |  | Handlebars-style conditionals allow flexible templates | Verify conditional nesting works |
| `test_support_email_injection` | Tests automatic injection of support_email from valves | Valve values are automatically injected into template context | `Pipe._emit_templated_error` | `mock_pipe` with `SUPPORT_EMAIL` valve, `mock_event_emitter` | Content contains "support@example.com" | LOW |  | Auto-injection reduces template boilerplate | None |
| `test_timestamp_injection` | Tests automatic timestamp injection in ISO 8601 format | Timestamps are auto-generated and injected in UTC format | `Pipe._emit_templated_error` | `mock_pipe`, `mock_event_emitter` | Content contains "Z" suffix (UTC indicator) | LOW |  | Timestamps help with incident investigation | None |
| `test_timeout_exception_caught` | Tests httpx.TimeoutException is caught and formatted | Network timeout errors are caught and rendered with timeout template | `Pipe._handle_pipe_call`, `_process_transformed_request` | `aioresponses` for model registry, patched `_process_transformed_request` to raise `TimeoutException` | Empty result, 2 events, content has timeout indicator | MEDIUM |  | Full integration test through pipe call handler | Verify timeout value is extracted |
| `test_connect_error_caught` | Tests httpx.ConnectError is caught and formatted | Connection failures are caught and rendered appropriately | `Pipe._handle_pipe_call`, `_process_transformed_request` | `aioresponses` for model registry, patched to raise `ConnectError` | Empty result, 2 events, content has connection indicator | MEDIUM |  | Tests network failure handling | None |
| `test_500_error_caught` | Tests 5xx HTTP status errors are caught and formatted | Server errors (502 Bad Gateway) are caught and rendered | `Pipe._handle_pipe_call`, `_process_transformed_request` | `aioresponses`, patched to raise `HTTPStatusError(502)` | Empty result, 2 events, content has "Service Error" or "502" | MEDIUM |  | Tests upstream service failure handling | Verify other 5xx codes |
| `test_generic_exception_caught` | Tests any unhandled exception is caught and formatted | Generic exceptions are caught with fallback error handling | `Pipe._handle_pipe_call`, `_process_transformed_request` | `aioresponses`, patched to raise `ValueError` | Empty result, 2 events, content has "Unexpected" and "ValueError" | HIGH |  | Safety net for unforeseen errors | None |
| `test_custom_template_used` | Tests admin-provided custom templates via valves override defaults | Custom valve templates replace built-in templates | `Pipe._handle_pipe_call` with custom `INTERNAL_ERROR_TEMPLATE` | `aioresponses`, patched to raise `RuntimeError` | Content contains "Custom error" and "RuntimeError" | LOW |  | Allows admins to customize error messages | Verify all template valves |
| `test_openrouter_error_template_full_context` | Tests complete OpenRouter error with all fields populated | All error template placeholders are correctly filled | `_build_error_template_values`, `_render_error_template` | `OpenRouterAPIError` with full metadata | All fields present: error_id, timestamp, provider, model, status, metadata, moderation, formatted numbers | LOW |  | Comprehensive validation of full error context | None |
| `test_openrouter_error_template_missing_optionals` | Tests error rendering with minimal fields gracefully omits optional sections | Optional template sections are cleanly omitted when data missing | `_build_error_template_values`, `_render_error_template` | `OpenRouterAPIError` with minimal fields | Basic fields present, optional sections absent (no "Provider:", "Model:", etc.) | LOW |  | Ensures templates degrade gracefully | None |
| `test_network_timeout_template` | Tests timeout-specific template rendering with timeout_seconds | Timeout template includes retry guidance and timeout duration | `_render_error_template` with `DEFAULT_NETWORK_TIMEOUT_TEMPLATE` | Template values dict with `timeout_seconds` | Contains timeout emoji, error ID, "30s" duration | LOW |  | Validates timeout-specific user guidance | None |
| `test_rate_limit_template_with_retry_after` | Tests 429 rate limit template with retry_after_seconds | Rate limit template shows wait time and limit type | `_render_error_template` with `DEFAULT_RATE_LIMIT_TEMPLATE` | Template values with `retry_after_seconds`, `rate_limit_type` | Contains rate limit emoji, "60s", "requests" type | LOW |  | Helps users understand when to retry | None |
| `test_authentication_error_template` | Tests 401 authentication failure template | Auth error template provides key setup guidance | `_render_error_template` with `DEFAULT_AUTHENTICATION_ERROR_TEMPLATE` | Template values with 401 status, auth message | Contains auth emoji, 401, API key guidance, OpenRouter keys URL | LOW |  | Directs users to fix auth configuration | None |
| `test_insufficient_credits_template` | Tests 402 insufficient credits template with balance info | Credits template shows required vs available balance | `_render_error_template` with `DEFAULT_INSUFFICIENT_CREDITS_TEMPLATE` | Template values with `required_cost`, `account_balance` | Contains credits emoji, cost/balance amounts, credits URL | LOW |  | Clear guidance on funding requirements | None |
| `test_conditional_blocks_render_correctly` | Tests conditional block rendering with truthy/falsy values | Template conditionals correctly evaluate truthy/falsy expressions | `_render_error_template` | Template with `{{#if}}` blocks, test data with truthy/falsy values | Truthy sections included, falsy sections excluded | MEDIUM |  | Core template engine conditional logic | Test edge cases (0, "", None) |
| `test_custom_template_override` | Tests user-provided custom template replaces default | Template override mechanism works correctly | `_render_error_template` | Custom template string, values dict | Output matches custom format exactly | LOW |  | Validates template customization capability | None |
| `test_build_values_with_minimal_error` | Tests template value building from minimal error object | Value builder handles sparse error data gracefully | `_build_error_template_values` | `OpenRouterAPIError` with minimal fields | Basic values populated, detail/reason set correctly | LOW |  | Tests minimum viable error representation | None |
| `test_build_values_with_full_error` | Tests template value building from fully populated error | Value builder extracts all available error attributes | `_build_error_template_values` | `OpenRouterAPIError` with all fields, full context | All 30+ values correctly extracted and formatted | LOW |  | Comprehensive validation of value extraction | None |
| `test_openrouter_api_error_includes_provider_and_request_details` | Tests OpenRouter error parsing extracts provider and request metadata | Error builder parses nested JSON metadata from OpenRouter response | `_build_openrouter_api_error` | JSON body with nested provider metadata, raw error | Provider, upstream_type, request_id extracted; markdown contains all details | MEDIUM |  | Validates OpenRouter-specific error structure parsing | Monitor OpenRouter API changes |
| `test_openrouter_api_error_handles_plain_text_payload` | Tests error builder handles non-JSON response bodies | Plain text responses don't crash error handling | `_build_openrouter_api_error` | Plain text body string | Markdown output is safe, contains fallback text | LOW |  | Defensive handling of unexpected response formats | None |
| `test_openrouter_api_error_includes_moderation_metadata` | Tests moderation rejection metadata is extracted and displayed | Moderation errors include reasons and flagged content excerpt | `_build_openrouter_api_error` | JSON body with moderation metadata (reasons, flagged_input) | model_slug, reasons, flagged_input extracted; markdown shows moderation details | LOW |  | Critical for content policy transparency | None |
| `test_openrouter_error_markdown_accepts_model_label_and_diagnostics` | Tests error markdown can include model details and diagnostics | Error markdown incorporates model context and diagnostic info | `OpenRouterAPIError.to_markdown` | Error with model_label, diagnostics, metrics, fallback_model | Markdown contains model label, context limits, token counts formatted | LOW |  | Provides actionable model-specific guidance | None |
| `test_resolve_error_model_context_uses_registry_spec` | Tests error context resolution uses model registry specs | Model metadata from registry is used to enrich error context | `_resolve_error_model_context` | `ModelFamily` with dynamic specs, normalized model ID | Label, diagnostics, metrics populated from registry spec | MEDIUM |  | Links error handling to model registry | Registry schema changes could break this |
| `test_custom_error_template_skips_lines_for_missing_values` | Tests custom templates omit lines with missing placeholder values | Lines with unfilled placeholders are removed from output | `OpenRouterAPIError.to_markdown` | Custom template with mixed present/absent values | Only lines with filled placeholders remain | MEDIUM |  | Clean template output without placeholder artifacts | Edge cases with nested conditionals |
| `test_openrouter_error_includes_metadata_and_raw_blocks` | Tests error object includes both metadata and raw provider JSON | Both structured metadata and raw provider response are preserved | `_build_openrouter_api_error` | JSON body with metadata.raw nested object | metadata_json and provider_raw_json both populated | LOW |  | Preserves full error context for debugging | None |
| `test_build_openrouter_api_error_merges_extra_metadata` | Tests extra_metadata parameter merges into error metadata | Additional metadata (retry_after, rate_limit_type) is merged | `_build_openrouter_api_error` | Body with error, extra_metadata dict | metadata dict contains both parsed and extra fields | LOW |  | Allows enrichment from HTTP headers | None |
| `test_streaming_fields_render_in_templates` | Tests streaming-specific error fields render in templates | Streaming error attributes (native_finish_reason, chunk_id) populate templates | `OpenRouterAPIError.to_markdown` | Error with streaming fields, template with streaming placeholders | Template output contains streaming field values | MEDIUM |  | Validates streaming error path | Monitor streaming protocol changes |
| `test_pipe_builds_streaming_error_from_event` | Tests Pipe builds streaming error from SSE event | Streaming error events are parsed into OpenRouterAPIError | `Pipe._build_streaming_openrouter_error` | SSE event dict with response.failed type | Error marked as streaming, fields extracted from event | MEDIUM |  | Critical for SSE error handling | SSE format could change |
| `test_select_openrouter_template_by_status` | Tests template selection based on HTTP status code | Different status codes map to specific error templates | `Pipe._select_openrouter_template` | Pipe instance with valve templates | 401AUTH, 402CREDITS, 408TIMEOUT, 429RATE_LIMIT, 400GENERIC | LOW |  | Ensures appropriate template for each error type | None |
| `test_emit_error_returns_early_with_none_handler` | Tests _emit_error no-ops when event_emitter_handler is None | Method returns early without crashing when handler absent | `ErrorFormatter._emit_error` | ErrorFormatter with None handler | No exception raised | LOW |  | Safety for optional event emitter | None |
| `test_emit_templated_error_returns_early_with_none_handler` | Tests _emit_templated_error no-ops when handler is None | Method returns early without crashing when handler absent | `ErrorFormatter._emit_templated_error` | ErrorFormatter with None handler | No exception raised | LOW |  | Safety for optional event emitter | None |
| `test_build_error_context_returns_empty_with_none_handler` | Tests _build_error_context returns empty values when handler is None | Method returns ('', {}) when handler absent | `ErrorFormatter._build_error_context` | ErrorFormatter with None handler | Returns empty string and empty dict | LOW |  | Prevents crashes in error context building | None |
| `test_streaming_error_nested_response_error_message` | Tests extraction of error message from nested response.error.message | Error message found in deeply nested response structure | `Pipe._build_streaming_openrouter_error` | Event with empty error block but nested response.error.message | Error reason contains nested message | MEDIUM |  | Handles alternative SSE error structure | SSE format variations |
| `test_streaming_error_default_message` | Tests fallback to "Streaming error" when no message found | Default message used when all message fields absent | `Pipe._build_streaming_openrouter_error` | Event with no message fields | Error reason is "Streaming error" | LOW |  | Prevents empty error messages | None |
| `test_streaming_error_with_response_id` | Tests response ID extraction into metadata | response.id becomes request_id in metadata | `Pipe._build_streaming_openrouter_error` | Event with response.id field | metadata["request_id"] equals response.id | LOW |  | Preserves request correlation ID | None |
| `test_extract_streaming_error_with_none_event` | Tests _extract_streaming_error_event returns None for invalid input | Method handles non-dict input safely | `Pipe._extract_streaming_error_event` | None, string, int inputs | All return None without crashing | LOW |  | Type safety for SSE parsing | None |
| `test_to_int_handles_bool_values` | Tests _to_int converts boolean values to integers | True1, False0 in usage token counts | `Pipe._format_final_status_description` | Usage dict with boolean values | "Input: 1", "Output: 0" in result | LOW |  | Defensive handling of unexpected types | None |
| `test_to_int_handles_float_values` | Tests _to_int truncates float values to integers | Float token counts converted to ints | `Pipe._format_final_status_description` | Usage dict with float values | Floats truncated in output (42.742, 13.213) | LOW |  | Handles APIs that return float counts | None |
| `test_tokens_without_total_uses_tokens_prefix` | Tests token display when total_tokens is missing | Computed total used when total_tokens absent | `Pipe._format_final_status_description` | Usage with input/output but no total_tokens | Total computed from input+output | LOW |  | Handles incomplete usage data | None |
| `test_parse_supported_effort_values_no_match` | Tests _parse_supported_effort_values returns empty list when pattern not found | Returns [] when "Supported values are:" not in message | `_parse_supported_effort_values` | Various strings without pattern | All return empty list | LOW |  | Defensive parsing of error messages | None |
| `test_parse_supported_effort_values_with_match` | Tests extraction of quoted values from error message | Extracts quoted values from "Supported values are:" pattern | `_parse_supported_effort_values` | Message with quoted value list | Returns list of extracted values | LOW |  | Parses OpenRouter effort parameter errors | None |
| `test_wait_for_with_non_awaitable` | Tests _wait_for returns non-awaitable values directly | Synchronous values passed through unchanged | `_wait_for` | Strings, ints, lists, None | Values returned as-is | LOW |  | Type-agnostic utility function | None |
| `test_wait_for_with_awaitable_no_timeout` | Tests _wait_for awaits coroutines when timeout is None | Coroutines awaited without timeout | `_wait_for` | Async function with no timeout | Coroutine result returned | LOW |  | Async path without timeout | None |
| `test_wait_for_with_awaitable_and_timeout` | Tests _wait_for awaits coroutines with timeout | Coroutines awaited with timeout parameter | `_wait_for` | Async function with timeout=5.0 | Coroutine result returned | LOW |  | Async path with timeout | Test timeout expiry |


## `tests/test_event_emitter.py`

| Test Name | Description | What It Tests | Code Under Test | Mocks/Fixtures | Assertions | Drift Risk | Check Done | Codex Notes | Codex TODO |
|-----------|-------------|---------------|-----------------|----------------|------------|------------|------------|-------------|------------|
| test_stub_chat_chunk_template_basic | Test stub template generates basic chunk structure | Validates that _stub_chat_chunk_template creates proper OpenAI-compatible chunk structure | `streaming.event_emitter._stub_chat_chunk_template()` | None | Checks object type, model name, id format (chatcmpl-), created timestamp, empty delta, null finish_reason | Low - stable API format |  | Core fallback template when Open WebUI not available | None |
| test_stub_chat_chunk_template_with_content | Test stub template with content | Verifies content parameter is correctly added to delta | `streaming.event_emitter._stub_chat_chunk_template(content=...)` | None | Checks delta["content"] equals provided content | Low |  | Tests content streaming | None |
| test_stub_chat_chunk_template_with_reasoning_content | Test stub template with reasoning content | Verifies reasoning_content parameter is correctly added to delta | `streaming.event_emitter._stub_chat_chunk_template(reasoning_content=...)` | None | Checks delta["reasoning_content"] equals provided reasoning | Low |  | Tests extended reasoning support | None |
| test_stub_chat_chunk_template_with_tool_calls | Test stub template with tool calls | Verifies tool_calls parameter is correctly added to delta | `streaming.event_emitter._stub_chat_chunk_template(tool_calls=...)` | None | Checks delta["tool_calls"] equals provided tool calls list | Low |  | Tests function calling support | None |
| test_stub_chat_chunk_template_with_usage | Test stub template with usage | Verifies usage stats are correctly added to chunk | `streaming.event_emitter._stub_chat_chunk_template(usage=...)` | None | Checks chunk["usage"] equals provided usage dict | Low |  | Tests token usage reporting | None |
| test_openai_chat_chunk_message_template_uses_stub_on_import_error | Test that template falls back to stub when Open WebUI not available | Validates ImportError fallback mechanism for Open WebUI dependency | `streaming.event_emitter.openai_chat_chunk_message_template()` | None (relies on actual import state) | Checks chunk has object, model, choices keys | Medium - depends on import state |  | Critical fallback path for deployments without Open WebUI | Monitor Open WebUI API changes |
| test_emit_status_basic | Test basic status emission | Validates _emit_status sends correct status event structure | `EventEmitterHandler._emit_status()` | mock_valves, event_handler, capture_emitter | Checks event type is "status", description matches, done=False | Low |  | Core status communication to UI | None |
| test_emit_status_done | Test status emission with done flag | Validates done flag is correctly passed through | `EventEmitterHandler._emit_status(done=True)` | mock_valves, event_handler, capture_emitter | Checks done=True in emitted event | Low |  | Completion signaling | None |
| test_emit_status_with_none_emitter | Test status emission with None emitter is no-op | Validates graceful handling when no emitter available | `EventEmitterHandler._emit_status(None, ...)` | mock_valves, event_handler | No exception raised | Low |  | Defensive programming for optional emitter | None |
| test_emit_status_handles_emitter_exception | Test status emission catches and logs emitter exceptions | Validates error handling when emitter callback fails | `EventEmitterHandler._emit_status()` with failing emitter | mock_valves, event_handler, failing_emitter, caplog | Checks "Failed to emit status" in logs | Medium |  | Robustness against transport failures | None |
| test_emit_error_basic | Test basic error emission | Validates _emit_error sends correct error structure | `EventEmitterHandler._emit_error()` | mock_valves, event_handler, capture_emitter | Checks type is "chat:completion", error message matches | Low |  | Core error communication | None |
| test_emit_error_with_exception | Test error emission with exception object | Validates exception objects are converted to error messages | `EventEmitterHandler._emit_error(ValueError(...))` | mock_valves, event_handler, capture_emitter | Checks error message contains exception text | Low |  | Exception handling integration | None |
| test_emit_error_show_error_message_false | Test error emission with show_error_message=False does not emit to UI | Validates internal-only error logging | `EventEmitterHandler._emit_error(show_error_message=False)` | mock_valves, event_handler, capture_emitter | Checks no events emitted | Medium |  | Internal error tracking without user notification | None |
| test_emit_error_with_log_citation_and_logs | Test error emission with show_error_log_citation logs debug info | Validates debug log retrieval and formatting | `EventEmitterHandler._emit_error(show_error_log_citation=True)` | mock_valves, event_handler, SessionLogger, caplog | Verifies SessionLogger interaction | Medium |  | Debug support feature | Monitor SessionLogger API |
| test_emit_error_with_log_citation_no_logs | Test error emission with show_error_log_citation when no logs exist | Validates handling when request has no logs | `EventEmitterHandler._emit_error(show_error_log_citation=True)` | mock_valves, event_handler, SessionLogger, caplog | Checks "No debug logs found" in logs | Low |  | Edge case handling | None |
| test_emit_templated_error_basic | Test templated error emission | Validates template rendering and dual-event emission (message + completion) | `EventEmitterHandler._emit_templated_error()` | mock_valves, event_handler, capture_emitter | Checks 2 events: chat:message with rendered template, chat:completion with done=True | Low |  | User-friendly error formatting | None |
| test_emit_templated_error_with_none_emitter | Test templated error with None emitter logs but does not emit | Validates logging without emission when emitter unavailable | `EventEmitterHandler._emit_templated_error(None, ...)` | mock_valves, event_handler, caplog | Checks log message present, no events | Low |  | Error tracking in background operations | None |
| test_emit_templated_error_template_rendering_fails | Test templated error handles template rendering failure | Validates fallback error message when template fails | `EventEmitterHandler._emit_templated_error()` with mock exception | mock_valves, event_handler, patch _render_error_template | Checks fallback message "couldn't format the error message" | High |  | Critical fallback for template engine failures | Review template rendering implementation |
| test_emit_templated_error_emitter_fails | Test templated error handles emitter failure | Validates error logging when emitter callback fails | `EventEmitterHandler._emit_templated_error()` with failing emitter | mock_valves, event_handler, caplog | Checks "Failed to emit error message" in logs | Medium |  | Transport failure handling | None |
| test_build_error_context | Test error context building | Validates error ID generation and context variable population | `EventEmitterHandler._build_error_context()` | mock_valves, event_handler | Checks error_id length (16 hex chars), timestamp format (ISO with Z), support_email, support_url | Low |  | Error tracking metadata | None |
| test_emit_citation_basic | Test basic citation emission | Validates citation event structure and document wrapping | `EventEmitterHandler._emit_citation()` | mock_valves, event_handler, capture_emitter | Checks type is "source", document wrapped in list, source name/url present | Low |  | Search/RAG integration | None |
| test_emit_citation_none_emitter | Test citation emission with None emitter is no-op | Validates graceful handling when no emitter | `EventEmitterHandler._emit_citation(None, ...)` | mock_valves, event_handler | No exception raised | Low |  | Optional emitter handling | None |
| test_emit_citation_not_dict | Test citation emission with non-dict citation is no-op | Validates input validation | `EventEmitterHandler._emit_citation(..., "not a dict")` | mock_valves, event_handler, capture_emitter | Checks no events emitted | Low |  | Input sanitization | None |
| test_emit_citation_document_list | Test citation emission with document as list | Validates list handling and empty string filtering | `EventEmitterHandler._emit_citation()` with list document | mock_valves, event_handler, capture_emitter | Checks document list filtered (empty strings removed) | Low |  | Multi-document citations | None |
| test_emit_citation_empty_document | Test citation emission with empty document uses default | Validates fallback for missing content | `EventEmitterHandler._emit_citation()` with empty document | mock_valves, event_handler, capture_emitter | Checks document = ["Citation"] | Low |  | Default value handling | None |
| test_emit_citation_metadata_list | Test citation emission with metadata list | Validates metadata filtering (only dicts kept) | `EventEmitterHandler._emit_citation()` with mixed metadata | mock_valves, event_handler, capture_emitter | Checks metadata contains only dict items | Low |  | Metadata sanitization | None |
| test_emit_citation_source_without_name | Test citation emission with source missing name uses url | Validates fallback to URL when name missing | `EventEmitterHandler._emit_citation()` with source without name | mock_valves, event_handler, capture_emitter | Checks source name equals URL | Low |  | Source naming fallback | None |
| test_emit_citation_source_not_dict | Test citation emission with source not a dict | Validates fallback for invalid source type | `EventEmitterHandler._emit_citation()` with non-dict source | mock_valves, event_handler, capture_emitter | Checks source name = "source" | Low |  | Source type validation | None |
| test_emit_citation_generates_metadata_if_empty | Test citation generates default metadata if not provided | Validates auto-generation of metadata | `EventEmitterHandler._emit_citation()` without metadata | mock_valves, event_handler, capture_emitter | Checks metadata has date_accessed | Low |  | Metadata auto-generation | None |
| test_emit_completion_basic | Test basic completion emission | Validates completion event structure | `EventEmitterHandler._emit_completion()` | mock_valves, event_handler, capture_emitter | Checks type is "chat:completion", content matches, done=True | Low |  | Completion signaling | None |
| test_emit_completion_none_emitter | Test completion emission with None emitter is no-op | Validates optional emitter handling | `EventEmitterHandler._emit_completion(None, ...)` | mock_valves, event_handler | No exception raised | Low |  | Graceful degradation | None |
| test_emit_completion_with_title | Test completion emission with title | Validates title parameter passthrough | `EventEmitterHandler._emit_completion(..., title=...)` | mock_valves, event_handler, capture_emitter | Checks title in event data | Low |  | Chat title suggestion | None |
| test_emit_completion_with_usage | Test completion emission with usage | Validates usage stats passthrough | `EventEmitterHandler._emit_completion(..., usage=...)` | mock_valves, event_handler, capture_emitter | Checks usage dict in event data | Low |  | Token usage reporting | None |
| test_emit_completion_not_done | Test completion emission with done=False | Validates partial completion events | `EventEmitterHandler._emit_completion(..., done=False)` | mock_valves, event_handler, capture_emitter | Checks done=False | Low |  | Streaming progress | None |
| test_emit_notification_basic | Test basic notification emission | Validates notification event structure | `EventEmitterHandler._emit_notification()` | mock_valves, event_handler, capture_emitter | Checks type is "notification", content matches, type is "info" | Low |  | User notifications | None |
| test_emit_notification_none_emitter | Test notification emission with None emitter is no-op | Validates optional emitter handling | `EventEmitterHandler._emit_notification(None, ...)` | mock_valves, event_handler | No exception raised | Low |  | Graceful degradation | None |
| test_emit_notification_levels | Test notification emission with different levels | Validates all notification levels (info, success, warning, error) | `EventEmitterHandler._emit_notification(..., level=...)` | mock_valves, event_handler, capture_emitter | Checks each level is correctly set in event | Low |  | Notification severity levels | None |
| test_wrap_safe_event_emitter_none | Test wrapping None emitter returns None | Validates None passthrough | `EventEmitterHandler._wrap_safe_event_emitter(None)` | mock_valves, event_handler | Returns None | Low |  | Null object pattern | None |
| test_wrap_safe_event_emitter_success | Test wrapped emitter passes through events | Validates transparent event forwarding | `EventEmitterHandler._wrap_safe_event_emitter()` | mock_valves, event_handler, capture_emitter | Checks event passed through unchanged | Low |  | Wrapper transparency | None |
| test_wrap_safe_event_emitter_catches_exception | Test wrapped emitter catches and logs exceptions | Validates exception isolation and logging | `EventEmitterHandler._wrap_safe_event_emitter()` with failing emitter | mock_valves, event_handler, failing_emitter, caplog | Checks "Event emitter failure" in logs, event type logged, no exception raised | Medium |  | Critical robustness layer | None |
| test_try_put_middleware_stream_nowait_success | Test put_nowait succeeds when queue has space | Validates normal queue operation | `EventEmitterHandler._try_put_middleware_stream_nowait()` | mock_valves, event_handler, asyncio.Queue | Checks queue size increases | Low |  | Queue insertion | None |
| test_try_put_middleware_stream_nowait_full_queue | Test put_nowait silently fails when queue is full | Validates graceful backpressure handling | `EventEmitterHandler._try_put_middleware_stream_nowait()` with full queue | mock_valves, event_handler, asyncio.Queue | Checks queue size unchanged, no exception | Medium |  | Backpressure handling without blocking | None |
| test_try_put_middleware_stream_nowait_handles_exception | Test put_nowait silently handles other exceptions | Validates broad exception catching | `EventEmitterHandler._try_put_middleware_stream_nowait()` with mock exception | mock_valves, event_handler, Mock | No exception raised | Low |  | Defensive exception handling | None |
| test_put_middleware_stream_item_cancelled | Test put_middleware_stream_item raises when job is cancelled | Validates cancellation propagation | `Pipe._put_middleware_stream_item()` with cancelled future | pipe_instance_async, _FakeJob with cancelled future | Raises asyncio.CancelledError | Medium |  | Graceful cancellation | None |
| test_put_middleware_stream_item_unbounded_queue | Test put_middleware_stream_item with unbounded queue | Validates unbounded queue path (MAXSIZE=0) | `Pipe._put_middleware_stream_item()` with MAXSIZE=0 | pipe_instance_async, _FakeJob, asyncio.Queue | Checks queue size increases | Low |  | Unlimited buffering mode | None |
| test_put_middleware_stream_item_zero_timeout | Test put_middleware_stream_item with zero timeout | Validates infinite wait path (timeout=0) | `Pipe._put_middleware_stream_item()` with timeout=0 | pipe_instance_async, _FakeJob, asyncio.Queue | Checks queue size increases | Low |  | Blocking mode | None |
| test_put_middleware_stream_item_with_timeout_success | Test put_middleware_stream_item with timeout completes normally | Validates timed wait success path | `Pipe._put_middleware_stream_item()` with timeout=1.0 | pipe_instance_async, _FakeJob, asyncio.Queue | Checks queue size increases | Low |  | Normal timed operation | None |
| test_make_middleware_stream_emitter_basic | Test middleware stream emitter creation and basic usage | Validates emitter creation and chat:message conversion to chunk | `Pipe._make_middleware_stream_emitter()` | pipe_instance_async, _FakeJob, asyncio.Queue | Checks chunk queued | Low |  | Core streaming path | None |
| test_make_middleware_stream_emitter_reasoning_delta | Test middleware stream emitter with reasoning delta | Validates reasoning:delta -> reasoning_content conversion | `Pipe._make_middleware_stream_emitter()` with reasoning event | pipe_instance_async, _FakeJob, asyncio.Queue | Checks chunk with reasoning_content queued | Low |  | Reasoning streaming (open_webui mode) | None |
| test_make_middleware_stream_emitter_status_mode | Test middleware stream emitter with status thinking mode | Validates status mode buffering behavior | `Pipe._make_middleware_stream_emitter()` with THINKING_OUTPUT_MODE=status | pipe_instance_async, _FakeJob, asyncio.Queue | Tests status emission logic | Medium |  | Alternative reasoning display mode | None |
| test_make_middleware_stream_emitter_tool_calls | Test middleware stream emitter with tool calls | Validates tool call delta conversion | `Pipe._make_middleware_stream_emitter()` with tool_calls event | pipe_instance_async, _FakeJob, asyncio.Queue | Checks chunk with tool_calls queued | Low |  | Function calling support | None |
| test_make_middleware_stream_emitter_completion_with_error | Test middleware stream emitter with completion error | Validates error passthrough in completion event | `Pipe._make_middleware_stream_emitter()` with error in completion | pipe_instance_async, _FakeJob, asyncio.Queue | Checks error in queued item | Low |  | Error propagation | None |
| test_make_middleware_stream_emitter_completion_with_usage | Test middleware stream emitter with completion usage | Validates usage stats in completion event | `Pipe._make_middleware_stream_emitter()` with usage in completion | pipe_instance_async, _FakeJob, asyncio.Queue | Checks usage in queued item | Low |  | Usage reporting at end | None |
| test_make_middleware_stream_emitter_passthrough_event | Test middleware stream emitter passes through unknown events | Validates event passthrough for unrecognized types | `Pipe._make_middleware_stream_emitter()` with custom event | pipe_instance_async, _FakeJob, asyncio.Queue | Checks event wrapped and queued | Low |  | Extensibility for future event types | None |
| test_make_middleware_stream_emitter_non_dict_event | Test middleware stream emitter handles non-dict events | Validates input validation | `Pipe._make_middleware_stream_emitter()` with string event | pipe_instance_async, _FakeJob, asyncio.Queue | Checks no items queued | Low |  | Input sanitization | None |
| test_make_middleware_stream_emitter_original_emitter_called | Test middleware stream emitter calls original emitter | Validates dual emission (original + middleware) | `Pipe._make_middleware_stream_emitter()` with job.event_emitter set | pipe_instance_async, _FakeJob with original_emitter, asyncio.Queue | Checks original emitter received event | Medium |  | Backward compatibility with existing event flow | None |
| test_make_middleware_stream_emitter_original_emitter_exception | Test middleware stream emitter handles original emitter exception | Validates isolation of original emitter failures | `Pipe._make_middleware_stream_emitter()` with failing original emitter | pipe_instance_async, _FakeJob with failing_emitter, asyncio.Queue | Checks item still queued despite exception | High |  | Robustness against callback failures | None |
| test_make_middleware_stream_emitter_content_without_delta | Test middleware stream emitter with content but no delta | Validates delta computation from content changes | `Pipe._make_middleware_stream_emitter()` with content-only updates | pipe_instance_async, _FakeJob, asyncio.Queue | Checks delta calculated as diff from previous content | Medium |  | Delta inference for non-streaming sources | None |
| test_make_middleware_stream_emitter_reasoning_completed | Test middleware stream emitter handles reasoning:completed | Validates reasoning:completed triggers buffer flush | `Pipe._make_middleware_stream_emitter()` with reasoning:completed event | pipe_instance_async, _FakeJob with status mode, asyncio.Queue | Tests flush behavior | Medium |  | Reasoning phase completion signaling | None |
| test_make_middleware_stream_emitter_flush_reasoning_status | Test middleware stream emitter flush_reasoning_status attribute | Validates flush_reasoning_status callable exists and works | `Pipe._make_middleware_stream_emitter()` and call flush_reasoning_status | pipe_instance_async, _FakeJob with status mode, asyncio.Queue | Checks attribute exists, callable | Medium |  | Programmatic buffer flushing | None |
| test_make_middleware_stream_emitter_tool_calls_debug_logging | Test middleware stream emitter logs tool calls at debug level | Validates debug logging for tool calls | `Pipe._make_middleware_stream_emitter()` with debug logging enabled | pipe_instance_async, _FakeJob, asyncio.Queue, caplog | Tests log output presence | Low |  | Debugging support | None |
| test_make_middleware_stream_emitter_tool_calls_invalid | Test middleware stream emitter handles invalid tool_calls | Validates validation of tool_calls (empty list, non-list) | `Pipe._make_middleware_stream_emitter()` with invalid tool_calls | pipe_instance_async, _FakeJob, asyncio.Queue | Checks no items queued | Low |  | Input validation | None |
| test_make_middleware_stream_emitter_reasoning_status_punctuation | Test reasoning status emits on punctuation | Validates punctuation triggers status emission | `Pipe._make_middleware_stream_emitter()` with text ending in punctuation | pipe_instance_async, _FakeJob with status mode, asyncio.Queue | Checks queue has items | Medium |  | Smart buffering heuristic | None |
| test_make_middleware_stream_emitter_reasoning_status_max_chars | Test reasoning status emits when max chars exceeded | Validates length threshold triggers emission | `Pipe._make_middleware_stream_emitter()` with long text (>160 chars) | pipe_instance_async, _FakeJob with status mode, asyncio.Queue | Checks queue has items | Medium |  | Buffer overflow prevention | None |
| test_make_middleware_stream_emitter_reasoning_non_string_delta | Test reasoning delta handles non-string delta | Validates type checking for delta | `Pipe._make_middleware_stream_emitter()` with numeric delta | pipe_instance_async, _FakeJob with status mode, asyncio.Queue | Checks no items queued | Low |  | Type safety | None |
| test_make_middleware_stream_emitter_both_thinking_modes | Test middleware stream emitter with 'both' thinking mode | Validates simultaneous box and status emission | `Pipe._make_middleware_stream_emitter()` with THINKING_OUTPUT_MODE=both | pipe_instance_async, _FakeJob, asyncio.Queue | Checks chunk queued | Medium |  | Dual display mode | None |
| test_make_middleware_stream_emitter_data_not_dict | Test middleware stream emitter handles non-dict data | Validates data type checking | `Pipe._make_middleware_stream_emitter()` with non-dict data | pipe_instance_async, _FakeJob, asyncio.Queue | Tests early return path | Low |  | Input validation | None |
| test_make_middleware_stream_emitter_model_from_body | Test middleware stream emitter uses model from body as fallback | Validates model selection priority (metadata.model > body.model) | `Pipe._make_middleware_stream_emitter()` with model only in body | pipe_instance_async, _FakeJob without metadata.model, asyncio.Queue | Checks chunk uses body.model | Low |  | Model name fallback logic | None |
| test_make_middleware_stream_emitter_chat_message_content_updates_assistant_sent | Test that content updates properly track assistant_sent | Validates assistant_sent state tracking across multiple events | `Pipe._make_middleware_stream_emitter()` with sequential content updates | pipe_instance_async, _FakeJob, asyncio.Queue | Checks multiple chunks queued correctly | Medium |  | State tracking for delta computation | None |
| test_make_middleware_stream_emitter_answer_started_flushes_reasoning | Test that starting answer flushes reasoning buffer | Validates chat:message flushes reasoning when answer begins | `Pipe._make_middleware_stream_emitter()` with reasoning then chat:message | pipe_instance_async, _FakeJob with status mode, asyncio.Queue | Checks queue size increases | Medium |  | Transition from thinking to answering | None |
| test_emit_error_log_citation_format_exception | Test error emission handles exception during log formatting | Validates robustness when format_event_as_text fails | `EventEmitterHandler._emit_error()` with malformed logs | mock_valves, event_handler, SessionLogger with invalid logs, caplog | Checks graceful handling | High |  | Error handling in error handler | Test with various malformed log structures |
| test_emit_citation_document_not_string_or_list | Test citation with document that is neither string nor list | Validates type fallback for document field | `EventEmitterHandler._emit_citation()` with numeric document | mock_valves, event_handler, capture_emitter | Checks default "Citation" used | Low |  | Type coercion | None |
| test_put_middleware_stream_item_timeout_exception | Test put_middleware_stream_item timeout logs warning and re-raises | Validates timeout handling with logging | `Pipe._put_middleware_stream_item()` with short timeout and full queue | pipe_instance_async, _FakeJob, asyncio.Queue, caplog | Checks TimeoutError raised, "timed out" in logs | Medium |  | Timeout diagnostics | None |
| test_make_middleware_stream_emitter_reasoning_idle_timeout | Test reasoning status emits after idle timeout | Validates idle time threshold for status emission | `Pipe._make_middleware_stream_emitter()` with delayed emissions | pipe_instance_async, _FakeJob with status mode, asyncio.Queue, asyncio.sleep | Tests timing-based emission | High - timing-dependent |  | User experience during pauses | Consider using fake time/clocks |
| test_make_middleware_stream_emitter_reasoning_empty_buffer | Test reasoning status with empty buffer returns early | Validates early return for empty/whitespace buffers | `Pipe._make_middleware_stream_emitter()` with whitespace-only delta | pipe_instance_async, _FakeJob with status mode, asyncio.Queue | Tests no emission for empty content | Low |  | Noise filtering | None |
| test_make_middleware_stream_emitter_tool_calls_with_non_dict_call | Test tool calls with non-dict item in list | Validates filtering of non-dict items in tool_calls list | `Pipe._make_middleware_stream_emitter()` with mixed tool_calls list | pipe_instance_async, _FakeJob, asyncio.Queue, caplog | Tests item skipping | Low |  | Robustness against malformed data | None |
| test_make_middleware_stream_emitter_tool_calls_exception_path | Test tool calls exception handling | Validates error handling during tool call processing | `Pipe._make_middleware_stream_emitter()` with template mock exception | pipe_instance_async, _FakeJob, asyncio.Queue, patch, caplog | Checks "Failed to emit tool_calls" in logs | High |  | Critical error path | None |
| test_make_middleware_stream_emitter_completion_flushes_reasoning_buffer | Test completion event flushes reasoning buffer when in status mode | Validates completion triggers buffer flush | `Pipe._make_middleware_stream_emitter()` with reasoning then completion | pipe_instance_async, _FakeJob with status mode, asyncio.Queue | Tests flush on completion | Medium |  | Clean completion after reasoning | None |
| test_make_middleware_stream_emitter_reasoning_completed_flushes_buffer | Test reasoning:completed flushes buffer when in status mode | Validates reasoning:completed event triggers flush | `Pipe._make_middleware_stream_emitter()` with reasoning:completed | pipe_instance_async, _FakeJob with status mode, asyncio.Queue | Tests flush behavior | Medium |  | Explicit reasoning phase end | None |
| test_make_middleware_stream_emitter_flush_when_disabled | Test flush_reasoning_status when status mode is disabled | Validates flush is no-op when status mode not active | `Pipe._make_middleware_stream_emitter()` with open_webui mode, call flush | pipe_instance_async, _FakeJob with open_webui mode, asyncio.Queue | No error, no side effects | Low |  | Mode-specific behavior | None |
| test_make_middleware_stream_emitter_maybe_emit_non_string_delta | Test _maybe_emit_reasoning_status handles non-string delta | Validates type checking in internal reasoning handler | `Pipe._make_middleware_stream_emitter()` internal path | pipe_instance_async, _FakeJob with status mode, asyncio.Queue | Tests type guard behavior | Low |  | Internal type safety | None |
| test_make_middleware_stream_emitter_tool_calls_function_not_dict | Test tool calls with function that is not a dict | Validates function field type checking | `Pipe._make_middleware_stream_emitter()` with non-dict function | pipe_instance_async, _FakeJob, asyncio.Queue, caplog | Tests validation logic | Low |  | Function schema validation | None |
| test_make_middleware_stream_emitter_delta_with_mismatched_content | Test chat:message with delta but content that doesn't start with assistant_sent | Validates delta fallback when content inconsistent | `Pipe._make_middleware_stream_emitter()` with mismatched content | pipe_instance_async, _FakeJob, asyncio.Queue | Checks fallback to assistant_sent + delta | Medium |  | Robustness against inconsistent state | Investigate if this can occur in production |


## `tests/test_filters.py`

| Test Name | Description | What It Tests | Code Under Test | Mocks/Fixtures | Assertions | Drift Risk | Check Done | Codex Notes | Codex TODO |
|-----------|-------------|---------------|-----------------|----------------|------------|------------|------------|-------------|------------|
| test_filter_initializes_with_default_valves | Test Filter initializes with proper default valves | Filter class initialization with default valve values | Filter.__init__(), Filter.Valves | None | Checks toggle=True, valves instance, priority=0, payload limits 50/50/25/20 MB | LOW - Constructor defaults |  | Tests default configuration values for filter instance | None |
| test_filter_user_valves_defaults | Test Filter UserValves has proper defaults | UserValves initialization with default values | Filter.UserValves.__init__() | None | Checks DIRECT_FILES=False, DIRECT_AUDIO=False, DIRECT_VIDEO=False | LOW - Constructor defaults |  | Verifies user valve defaults are disabled | None |
| test_to_int_with_none | Test _to_int returns None for None input | Helper method handling None values | Filter._to_int() | None | Checks _to_int(None) is None | LOW - Type handling |  | Edge case for null values | None |
| test_to_int_with_bool | Test _to_int returns None for boolean input | Helper method handling boolean values | Filter._to_int() | None | Checks _to_int(True/False) is None | LOW - Type handling |  | Booleans explicitly rejected | None |
| test_to_int_with_int | Test _to_int passes through integers | Helper method with valid integer input | Filter._to_int() | None | Checks _to_int(42)=42, _to_int(0)=0, _to_int(-5)=-5 | LOW - Type handling |  | Integer passthrough behavior | None |
| test_to_int_with_float | Test _to_int converts floats to int | Helper method with float input | Filter._to_int() | None | Checks _to_int(3.7)=3, _to_int(10.0)=10 | LOW - Type conversion |  | Float truncation to int | None |
| test_to_int_with_valid_string | Test _to_int converts valid numeric strings | Helper method with string input | Filter._to_int() | None | Checks _to_int("123")=123, _to_int("  456  ")=456, _to_int("-789")=-789 | LOW - String parsing |  | Handles whitespace and signs | None |
| test_to_int_with_empty_string | Test _to_int returns None for empty string | Helper method with empty/whitespace string | Filter._to_int() | None | Checks _to_int("")=None, _to_int("   ")=None | LOW - Edge case |  | Empty string handling | None |
| test_to_int_with_invalid_string | Test _to_int returns None for non-numeric strings | Helper method with invalid string | Filter._to_int() | None | Checks _to_int("abc")=None, _to_int("12.34")=None | LOW - Error handling |  | Invalid string formats | None |
| test_to_int_with_other_types | Test _to_int returns None for unsupported types | Helper method with list/dict input | Filter._to_int() | None | Checks _to_int([1,2,3])=None, _to_int({"value":42})=None | LOW - Type handling |  | Complex types rejected | None |
| test_csv_set_with_valid_csv | Test _csv_set parses comma-separated values | Helper method parsing CSV string | Filter._csv_set() | None | Checks _csv_set("pdf,txt,md")={"pdf","txt","md"} | LOW - String parsing |  | Basic CSV parsing | None |
| test_csv_set_with_whitespace | Test _csv_set strips whitespace from values | Helper method with whitespace in CSV | Filter._csv_set() | None | Checks _csv_set("  pdf , txt ,  md  ")={"pdf","txt","md"} | LOW - String parsing |  | Whitespace trimming | None |
| test_csv_set_with_empty_values | Test _csv_set ignores empty values | Helper method with empty CSV elements | Filter._csv_set() | None | Checks _csv_set("pdf,,txt,,,md")={"pdf","txt","md"} | LOW - String parsing |  | Empty element filtering | None |
| test_csv_set_lowercases | Test _csv_set lowercases all values | Helper method case normalization | Filter._csv_set() | None | Checks _csv_set("PDF,TXT,Md")={"pdf","txt","md"} | LOW - String parsing |  | Case insensitive processing | None |
| test_csv_set_with_empty_string | Test _csv_set returns empty set for empty string | Helper method with empty input | Filter._csv_set() | None | Checks _csv_set("")=set() | LOW - Edge case |  | Empty string handling | None |
| test_csv_set_with_non_string | Test _csv_set returns empty set for non-string input | Helper method with invalid types | Filter._csv_set() | None | Checks _csv_set(None/123/["a","b"])=set() | LOW - Type handling |  | Non-string input handling | None |
| test_mime_allowed_exact_match | Test _mime_allowed with exact MIME type match | MIME type validation with exact match | Filter._mime_allowed() | None | Checks _mime_allowed("application/pdf", "application/pdf,text/plain")=True | MEDIUM - MIME validation |  | Exact type matching | None |
| test_mime_allowed_with_wildcard | Test _mime_allowed with wildcard patterns | MIME type validation with wildcards | Filter._mime_allowed() | None | Checks audio/mp3 matches audio/*, video/mp4 doesn't | MEDIUM - MIME validation |  | Wildcard pattern matching | None |
| test_mime_allowed_case_insensitive | Test _mime_allowed is case insensitive | MIME type validation case handling | Filter._mime_allowed() | None | Checks APPLICATION/PDF matches application/pdf | LOW - Case handling |  | Case insensitive matching | None |
| test_mime_allowed_with_empty_mime | Test _mime_allowed returns False for empty MIME | MIME type validation with empty input | Filter._mime_allowed() | None | Checks _mime_allowed("", "application/pdf")=False | LOW - Edge case |  | Empty MIME type handling | None |
| test_mime_allowed_with_empty_allowlist | Test _mime_allowed returns False for empty allowlist | MIME type validation with empty allowlist | Filter._mime_allowed() | None | Checks _mime_allowed("application/pdf", "")=False | LOW - Edge case |  | Empty allowlist handling | None |
| test_mime_allowed_no_match | Test _mime_allowed returns False when no match | MIME type validation with no match | Filter._mime_allowed() | None | Checks _mime_allowed("video/mp4", "audio/*,application/pdf")=False | LOW - Validation logic |  | No match scenario | None |
| test_infer_audio_format_from_mime_wav | Test _infer_audio_format detects wav from MIME | Audio format inference from MIME type | Filter._infer_audio_format() | None | Checks audio/wav, audio/wave, audio/x-wav all return "wav" | MEDIUM - Format detection |  | WAV format detection | None |
| test_infer_audio_format_from_mime_mp3 | Test _infer_audio_format detects mp3 from MIME | Audio format inference from MIME type | Filter._infer_audio_format() | None | Checks audio/mpeg, audio/mp3 return "mp3" | MEDIUM - Format detection |  | MP3 format detection | None |
| test_infer_audio_format_from_extension | Test _infer_audio_format falls back to filename extension | Audio format inference from file extension | Filter._infer_audio_format() | None | Checks .flac, .m4a, .ogg extensions | MEDIUM - Format detection |  | Extension fallback logic | None |
| test_infer_audio_format_no_extension | Test _infer_audio_format with no extension returns empty | Audio format inference with no extension | Filter._infer_audio_format() | None | Checks files without extensions return "" | LOW - Edge case |  | Missing extension handling | None |
| test_infer_audio_format_case_insensitive | Test _infer_audio_format is case insensitive | Audio format inference case handling | Filter._infer_audio_format() | None | Checks .MP3 and AUDIO/WAV work | LOW - Case handling |  | Case insensitive detection | None |
| test_infer_audio_format_with_non_string | Test _infer_audio_format handles non-string inputs | Audio format inference with invalid types | Filter._infer_audio_format() | None | Checks None/int inputs return "" or detect from MIME | LOW - Type handling |  | Non-string input handling | None |
| test_model_caps_with_full_structure | Test _model_caps extracts capabilities from proper structure | Model capabilities extraction | Filter._model_caps() | None | Checks extraction from info.meta.openrouter_pipe.capabilities | MEDIUM - Metadata parsing |  | Full capability structure | None |
| test_model_caps_with_missing_structure | Test _model_caps returns empty dict for missing structure | Model capabilities with missing data | Filter._model_caps() | None | Checks None, {}, missing nested keys return {} | LOW - Error handling |  | Missing structure handling | None |
| test_model_caps_with_non_dict | Test _model_caps returns empty dict for non-dict inputs | Model capabilities with invalid types | Filter._model_caps() | None | Checks string, list, non-dict values return {} | LOW - Type handling |  | Invalid type handling | None |
| test_inlet_returns_body_if_not_dict | Test inlet returns body unchanged if not a dict | Inlet early exit validation | Filter.inlet() | None | Checks non-dict body returns unchanged | LOW - Input validation |  | Type guard for body | None |
| test_inlet_returns_body_if_metadata_not_dict | Test inlet returns body unchanged if metadata is not dict | Inlet metadata validation | Filter.inlet() | None | Checks non-dict __metadata__ returns body unchanged | LOW - Input validation |  | Type guard for metadata | None |
| test_inlet_returns_body_if_no_files | Test inlet returns body unchanged if no files | Inlet with no files to process | Filter.inlet() | None | Checks body without files key returns unchanged | LOW - Early exit |  | No files scenario | None |
| test_inlet_returns_body_if_files_empty | Test inlet returns body unchanged if files list is empty | Inlet with empty files list | Filter.inlet() | None | Checks empty files list returns unchanged | LOW - Early exit |  | Empty files scenario | None |
| test_inlet_diverts_files_when_enabled | Test inlet diverts files to direct uploads when enabled | File diversion to direct uploads | Filter.inlet() | None | Checks files removed from body, added to metadata direct_uploads | HIGH - Core feature |  | Main file diversion flow | Verify OpenRouter API contract |
| test_inlet_retains_files_when_user_valve_disabled | Test inlet retains files when DIRECT_FILES is disabled | File retention when user valve disabled | Filter.inlet() | None | Checks files remain in body when DIRECT_FILES=False | MEDIUM - User control |  | User valve disabled scenario | None |
| test_inlet_retains_files_when_model_lacks_capability | Test inlet retains files when model doesn't support file input | File retention when model unsupported | Filter.inlet() | None | Checks files remain, warning added when file_input=False | HIGH - Model compatibility |  | Model capability check | Sync with model metadata |
| test_inlet_retains_files_with_unsupported_mime | Test inlet retains files with unsupported MIME types | File retention with invalid MIME | Filter.inlet() | None | Checks .docx files remain (fail-open) | MEDIUM - MIME filtering |  | Fail-open for unsupported | Document supported MIMEs |
| test_inlet_diverts_audio_when_enabled | Test inlet diverts audio files when enabled | Audio diversion to direct uploads | Filter.inlet() | None | Checks audio removed from body, added to metadata with format | HIGH - Core feature |  | Audio diversion flow | Verify OpenRouter API contract |
| test_inlet_retains_audio_when_format_not_allowed | Test inlet retains audio when format is not in allowlist | Audio retention with format filter | Filter.inlet() | None | Checks audio remains when format not in allowlist | MEDIUM - Format filtering |  | Audio format allowlist | None |
| test_inlet_diverts_video_when_enabled | Test inlet diverts video files when enabled | Video diversion to direct uploads | Filter.inlet() | None | Checks video removed from body, added to metadata | HIGH - Core feature |  | Video diversion flow | Verify OpenRouter API contract |
| test_inlet_retains_video_with_unsupported_mime | Test inlet retains video with unsupported MIME type | Video retention with invalid MIME | Filter.inlet() | None | Checks .avi video remains (not in allowlist) | MEDIUM - MIME filtering |  | Video MIME allowlist | None |
| test_inlet_raises_on_file_too_large | Test inlet raises exception when file exceeds size limit | File size limit enforcement | Filter.inlet() | None | Checks exception raised when file > limit | HIGH - Security |  | File size validation | None |
| test_inlet_raises_on_audio_too_large | Test inlet raises exception when audio exceeds size limit | Audio size limit enforcement | Filter.inlet() | None | Checks exception raised when audio > limit | HIGH - Security |  | Audio size validation | None |
| test_inlet_raises_on_video_too_large | Test inlet raises exception when video exceeds size limit | Video size limit enforcement | Filter.inlet() | None | Checks exception raised when video > limit | HIGH - Security |  | Video size validation | None |
| test_inlet_raises_on_total_payload_exceeded | Test inlet raises when total payload exceeds limit | Total payload size enforcement | Filter.inlet() | None | Checks exception raised when total > limit | HIGH - Security |  | Total payload validation | None |
| test_inlet_raises_on_missing_file_size | Test inlet raises when file is missing size | File size field validation | Filter.inlet() | None | Checks exception raised when size field missing | MEDIUM - Validation |  | Required field check | None |
| test_inlet_skips_legacy_files | Test inlet skips files with legacy=True | Legacy file handling | Filter.inlet() | None | Checks files with legacy=True remain unchanged | MEDIUM - Backwards compat |  | Legacy flag support | Document legacy behavior |
| test_inlet_skips_non_file_type | Test inlet skips items with type != 'file' | Non-file type filtering | Filter.inlet() | None | Checks items with type='image' remain unchanged | MEDIUM - Type filtering |  | Type field validation | None |
| test_inlet_skips_items_without_valid_id | Test inlet skips items without valid string id | Invalid ID handling | Filter.inlet() | None | Checks items with empty/non-string ID remain | MEDIUM - Validation |  | ID validation logic | None |
| test_inlet_handles_non_dict_items_in_files | Test inlet handles non-dict items in files list | Non-dict items in files array | Filter.inlet() | None | Checks string/int/None items remain unchanged | LOW - Error handling |  | Robust input handling | None |
| test_inlet_handles_user_not_dict | Test inlet handles non-dict __user__ | User parameter validation | Filter.inlet() | None | Checks processing continues with default valves | LOW - Error handling |  | Missing user handling | None |
| test_inlet_handles_user_valves_not_basemodel | Test inlet handles user valves that's not a BaseModel | User valves validation | Filter.inlet() | None | Checks uses default UserValves when invalid | LOW - Error handling |  | Invalid valves handling | None |
| test_inlet_updates_metadata_files | Test inlet updates metadata['files'] to match body['files'] | Metadata sync with body | Filter.inlet() | None | Checks metadata['files'] updated to match body['files'] | MEDIUM - Consistency |  | Metadata synchronization | None |
| test_inlet_merges_existing_direct_uploads | Test inlet merges with existing direct_uploads in metadata | Existing direct uploads handling | Filter.inlet() | None | Checks new files appended to existing direct_uploads | MEDIUM - Merging |  | Metadata merge logic | None |
| test_inlet_deduplicates_by_id | Test inlet deduplicates files by id | File deduplication logic | Filter.inlet() | None | Checks files with same ID are deduplicated | MEDIUM - Deduplication |  | ID-based deduplication | None |
| test_inlet_persists_responses_audio_format_allowlist | Test inlet persists responses audio format allowlist in metadata | Audio response allowlist persistence | Filter.inlet() | None | Checks DIRECT_RESPONSES_AUDIO_FORMAT_ALLOWLIST saved to metadata | MEDIUM - Configuration |  | Response format config | None |
| test_model_caps_with_meta_not_dict | Test _model_caps returns empty when info.meta is not a dict | Model caps with invalid meta | Filter._model_caps() | None | Checks info.meta as string returns {} | LOW - Error handling |  | Invalid meta handling | None |
| test_inlet_retains_audio_when_user_valve_disabled | Test inlet retains audio when DIRECT_AUDIO is disabled | Audio retention when valve disabled | Filter.inlet() | None | Checks audio remains when DIRECT_AUDIO=False | MEDIUM - User control |  | Audio valve disabled | None |
| test_inlet_retains_audio_when_model_lacks_capability | Test inlet retains audio when model doesn't support audio | Audio retention when unsupported | Filter.inlet() | None | Checks audio remains, warning when audio_input=False | HIGH - Model compatibility |  | Audio capability check | None |
| test_inlet_retains_audio_with_unsupported_mime | Test inlet retains audio with unsupported MIME type | Audio MIME filtering | Filter.inlet() | None | Checks audio remains when MIME not in allowlist | MEDIUM - MIME filtering |  | Audio MIME allowlist | None |
| test_inlet_raises_on_audio_total_payload_exceeded | Test inlet raises when audio total payload exceeds limit | Audio total payload limit | Filter.inlet() | None | Checks exception when multiple audio files exceed total | HIGH - Security |  | Audio total size check | None |
| test_inlet_retains_video_when_user_valve_disabled | Test inlet retains video when DIRECT_VIDEO is disabled | Video retention when valve disabled | Filter.inlet() | None | Checks video remains when DIRECT_VIDEO=False | MEDIUM - User control |  | Video valve disabled | None |
| test_inlet_retains_video_when_model_lacks_capability | Test inlet retains video when model doesn't support video | Video retention when unsupported | Filter.inlet() | None | Checks video remains, warning when video_input=False | HIGH - Model compatibility |  | Video capability check | None |
| test_inlet_raises_on_video_total_payload_exceeded | Test inlet raises when video total payload exceeds limit | Video total payload limit | Filter.inlet() | None | Checks exception when multiple video files exceed total | HIGH - Security |  | Video total size check | None |
| test_inlet_merges_existing_warnings | Test inlet merges with existing warnings in metadata | Warning merging logic | Filter.inlet() | None | Checks new warnings appended to existing | MEDIUM - Merging |  | Warning accumulation | None |
| test_inlet_deduplicates_warnings | Test inlet deduplicates duplicate warnings | Warning deduplication | Filter.inlet() | None | Checks duplicate warnings removed | LOW - Deduplication |  | Warning deduplication | None |
| test_filter_integration_with_pipe_direct_uploads | Test filter output integrates correctly with Pipe processing | End-to-end filter to pipe integration | Filter.inlet(), Pipe._handle_pipe_call() | aioresponses, pipe_instance_async fixture | Checks filtered body processed by pipe successfully | HIGH - Integration |  | Full filter+pipe flow | Integration contract validation |
| test_filter_warnings_passed_to_pipe | Test filter warnings are available to pipe processing | Warning propagation to pipe | Filter.inlet(), Pipe._handle_pipe_call() | pipe_instance_async fixture | Checks warnings in metadata accessible to pipe | MEDIUM - Integration |  | Warning flow through system | None |


## `tests/test_helpers.py`

| Test Name | Description | What It Tests | Code Under Test | Mocks/Fixtures | Assertions | Drift Risk | Check Done | Codex Notes | Codex TODO |
|-----------|-------------|---------------|-----------------|----------------|------------|------------|------------|-------------|------------|
| `TestStableCrockfordId::test_basic_generation` | Basic ID generation from seed string | Generates deterministic ID of correct length using Crockford encoding | `_stable_crockford_id("test-seed")` | None | ID length matches `ULID_LENGTH`, all chars in Crockford alphabet | LOW - Pure deterministic function |  | Tests basic happy path for ID generation | None |
| `TestStableCrockfordId::test_deterministic` | Same seed produces same ID | Verifies deterministic behavior - same input always yields same output | `_stable_crockford_id("same-seed")` called twice | None | Both IDs are identical | LOW - Core contract of function |  | Critical property for reproducible IDs | None |
| `TestStableCrockfordId::test_different_seeds` | Different seeds produce different IDs | Ensures different inputs produce different outputs | `_stable_crockford_id("seed-a")` vs `_stable_crockford_id("seed-b")` | None | IDs are not equal | LOW - Hash collision extremely unlikely |  | Validates hash function distributes well | None |
| `TestStableCrockfordId::test_custom_length` | Custom length parameter works | Tests optional length parameter | `_stable_crockford_id("test", length=10)` | None | Result length is 10 | LOW - Simple parameter |  | Allows flexible ID sizes | None |
| `TestStableCrockfordId::test_empty_seed` | Empty seed still generates valid ID | Edge case: empty string input | `_stable_crockford_id("")` | None | Valid ID of correct length | LOW - Hash of empty string is valid |  | Empty seed hashes consistently | None |
| `TestStableCrockfordId::test_none_seed_treated_as_empty` | None seed treated as empty string | Edge case: None input handling | `_stable_crockford_id(None)` | None | Same result as empty string | LOW - Consistent null handling |  | None coalesces to empty string | None |
| `TestStableCrockfordId::test_invalid_length_zero` | Zero length raises ValueError | Boundary validation | `_stable_crockford_id("test", length=0)` | None | Raises ValueError with "length must be positive" | LOW - Input validation |  | Prevents meaningless zero-length IDs | None |
| `TestStableCrockfordId::test_invalid_length_negative` | Negative length raises ValueError | Boundary validation | `_stable_crockford_id("test", length=-5)` | None | Raises ValueError with "length must be positive" | LOW - Input validation |  | Prevents negative lengths | None |
| `TestStableCrockfordId::test_length_too_long` | Requesting too many bits raises ValueError | Tests maximum length constraint based on SHA-256 hash size | `_stable_crockford_id("test", length=100)` | None | Raises ValueError with "seed hash too short" | LOW - Mathematical constraint |  | SHA-256 = 256 bits, max ~51 chars at 5 bits/char | None |
| `TestSafeJsonLoads::test_valid_json` | Valid JSON is parsed correctly | Happy path: well-formed JSON dict | `_safe_json_loads('{"key": "value"}')` | None | Returns expected dict | LOW - Standard JSON parsing |  | Uses stdlib json.loads internally | None |
| `TestSafeJsonLoads::test_valid_json_array` | Valid JSON array is parsed correctly | Happy path: well-formed JSON array | `_safe_json_loads('[1, 2, 3]')` | None | Returns expected list | LOW - Standard JSON parsing |  | Arrays work as well as objects | None |
| `TestSafeJsonLoads::test_invalid_json` | Invalid JSON returns None without raising | Error handling: malformed JSON | `_safe_json_loads('not valid json')` | None | Returns None | LOW - Try/except wrapper |  | Safe wrapper prevents exceptions | None |
| `TestSafeJsonLoads::test_empty_string` | Empty string returns None | Edge case: empty input | `_safe_json_loads('')` | None | Returns None | LOW - Empty case |  | Empty is invalid JSON | None |
| `TestSafeJsonLoads::test_none_input` | None input returns None | Edge case: None input | `_safe_json_loads(None)` | None | Returns None | LOW - Null handling |  | None input handled gracefully | None |
| `TestCoercePositiveInt::test_positive_integer` | Positive integer returns as-is | Happy path: valid positive int | `_coerce_positive_int(42)` | None | Returns 42 | LOW - Identity for valid input |  | No coercion needed for int | None |
| `TestCoercePositiveInt::test_positive_string` | Positive string integer is coerced | Type coercion: string to int | `_coerce_positive_int("100")` | None | Returns 100 | LOW - Standard int() conversion |  | Parses numeric strings | None |
| `TestCoercePositiveInt::test_zero_returns_none` | Zero returns None (not positive) | Boundary: zero is not positive | `_coerce_positive_int(0)` | None | Returns None | LOW - Definition of positive |  | Zero explicitly excluded | None |
| `TestCoercePositiveInt::test_negative_returns_none` | Negative integer returns None | Validation: rejects negative | `_coerce_positive_int(-5)` | None | Returns None | LOW - Positive constraint |  | Negatives filtered out | None |
| `TestCoercePositiveInt::test_none_returns_none` | None input returns None | Null handling | `_coerce_positive_int(None)` | None | Returns None | LOW - Pass-through |  | None passes through | None |
| `TestCoercePositiveInt::test_bool_true_returns_none` | Boolean True returns None (bool check before int coercion) | Type filtering: bool rejected | `_coerce_positive_int(True)` | None | Returns None | MEDIUM - Python's bool is int subclass |  | Explicit bool check prevents True=1 | None |
| `TestCoercePositiveInt::test_bool_false_returns_none` | Boolean False returns None | Type filtering: bool rejected | `_coerce_positive_int(False)` | None | Returns None | MEDIUM - Python's bool is int subclass |  | Explicit bool check prevents False=0 | None |
| `TestCoercePositiveInt::test_non_numeric_string_returns_none` | Non-numeric string returns None | Error handling: invalid string | `_coerce_positive_int("abc")` | None | Returns None | LOW - ValueError caught |  | Non-numeric strings fail gracefully | None |
| `TestCoercePositiveInt::test_float_string` | Float string returns None (int() raises ValueError) | Edge case: decimal in string | `_coerce_positive_int("3.14")` | None | Returns None | LOW - int("3.14") raises |  | Rejects fractional strings | None |
| `TestCoerceBool::test_bool_true` | Boolean True returns True | Happy path: native bool | `_coerce_bool(True)` | None | Returns True | LOW - Identity |  | Pass-through for bool | None |
| `TestCoerceBool::test_bool_false` | Boolean False returns False | Happy path: native bool | `_coerce_bool(False)` | None | Returns False | LOW - Identity |  | Pass-through for bool | None |
| `TestCoerceBool::test_string_true_variants` | Truthy string variants return True | String to bool coercion: truthy values | Various truthy strings | None | All return True | MEDIUM - List could expand |  | Covers common truthy representations | Review if adding new variants |
| `TestCoerceBool::test_string_false_variants` | Falsy string variants return False | String to bool coercion: falsy values | Various falsy strings | None | All return False | MEDIUM - List could expand |  | Covers common falsy representations | Review if adding new variants |
| `TestCoerceBool::test_string_with_whitespace` | Strings with whitespace are trimmed | Input normalization | `_coerce_bool("  true  ")` | None | Returns True (trimmed) | LOW - Standard strip() |  | Whitespace tolerance | None |
| `TestCoerceBool::test_unrecognized_string_returns_none` | Unrecognized string returns None | Invalid input handling | `_coerce_bool("maybe")` | None | Returns None | LOW - Explicit rejection |  | Unknown strings return None | None |
| `TestCoerceBool::test_integer_nonzero` | Non-zero integer returns True | Numeric truthiness | `_coerce_bool(1)`, `_coerce_bool(42)` | None | Both return True | LOW - Standard bool() |  | Non-zero ints are truthy | None |
| `TestCoerceBool::test_integer_zero` | Zero integer returns False | Numeric falsiness | `_coerce_bool(0)` | None | Returns False | LOW - Standard bool() |  | Zero is falsy | None |
| `TestCoerceBool::test_other_types_return_none` | Other types return None | Type rejection for complex types | Lists, dicts, None | None | All return None | LOW - Explicit type filtering |  | Only bool/int/str supported | None |
| `TestNormalizeStringList::test_list_of_strings` | List of strings is normalized | Happy path: string list normalization | `_normalize_string_list(["  hello  ", "world", ""])` | None | Returns trimmed, non-empty strings | LOW - Standard string ops |  | Trims and filters empties | None |
| `TestNormalizeStringList::test_list_with_non_strings` | List with non-strings converts them | Type coercion: mixed types | `_normalize_string_list([123, "text", None])` | None | Returns ["123", "text"] | LOW - str() conversion |  | Converts to strings, filters None | None |
| `TestNormalizeStringList::test_empty_list` | Empty list returns empty list | Edge case: empty input | `_normalize_string_list([])` | None | Returns [] | LOW - Identity |  | Empty list pass-through | None |
| `TestNormalizeStringList::test_non_list_returns_empty` | Non-list input returns empty list | Type validation | Various non-list types | None | All return [] | LOW - Type check |  | Non-list inputs rejected | None |
| `TestNormalizeOptionalStr::test_normal_string` | Normal string is trimmed | Happy path: string normalization | `_normalize_optional_str("  hello  ")` | None | Returns "hello" | LOW - Standard strip() |  | Whitespace trimming | None |
| `TestNormalizeOptionalStr::test_empty_string_returns_none` | Empty string returns None | Empty handling | `_normalize_optional_str("")` | None | Returns None | LOW - Explicit empty check |  | Empty/whitespace treated as None | None |
| `TestNormalizeOptionalStr::test_none_returns_none` | None input returns None | Null handling | `_normalize_optional_str(None)` | None | Returns None | LOW - Pass-through |  | None passes through | None |
| `TestNormalizeOptionalStr::test_non_string_converted` | Non-string is converted to string | Type coercion | `_normalize_optional_str(123)` | None | Returns "123" | LOW - str() conversion |  | Converts non-strings | None |
| `TestParseModelFallbackCsv::test_simple_csv` | Simple CSV is parsed correctly | Happy path: CSV parsing | `_parse_model_fallback_csv("model-a,model-b,model-c")` | None | Returns list of models | LOW - Standard split |  | Basic CSV parsing | None |
| `TestParseModelFallbackCsv::test_csv_with_whitespace` | CSV with whitespace is trimmed | Input normalization | CSV with extra spaces | None | Returns trimmed values | LOW - Strip per item |  | Whitespace tolerance | None |
| `TestParseModelFallbackCsv::test_csv_with_duplicates` | Duplicates are removed (order-preserving) | Deduplication logic | CSV with repeated models | None | Returns unique values, order preserved | MEDIUM - Order matters for fallback |  | First occurrence wins | None |
| `TestParseModelFallbackCsv::test_csv_with_empty_parts` | Empty parts are skipped | Empty value handling | CSV with empty segments | None | Empty strings filtered out | LOW - Explicit check |  | Empty parts ignored | None |
| `TestParseModelFallbackCsv::test_empty_string` | Empty string returns empty list | Edge case: empty input | `_parse_model_fallback_csv("")` | None | Returns [] | LOW - Empty check |  | Empty input handled | None |
| `TestParseModelFallbackCsv::test_non_string` | Non-string input returns empty list | Type validation | Various non-string types | None | All return [] | LOW - Type check |  | Non-strings rejected | None |
| `TestSelectBestEffortFallback::test_exact_match` | Exact match returns the requested effort | Happy path: exact match | `_select_best_effort_fallback("medium", ["low", "medium", "high"])` | None | Returns "medium" | LOW - Direct lookup |  | Exact match preferred | None |
| `TestSelectBestEffortFallback::test_case_insensitive` | Matching is case-insensitive | Case normalization | `_select_best_effort_fallback("MEDIUM", ...)` | None | Returns lowercase match | LOW - Lower() comparison |  | Case-insensitive matching | None |
| `TestSelectBestEffortFallback::test_fallback_to_lower` | Requests higher than max fall back to max | Fallback logic: too high | Request above max effort | None | Returns highest available | MEDIUM - Fallback algorithm |  | Clamps to maximum | None |
| `TestSelectBestEffortFallback::test_fallback_to_higher` | Requests lower than min fall back to min | Fallback logic: too low | Request below min effort | None | Returns lowest available | MEDIUM - Fallback algorithm |  | Clamps to minimum | None |
| `TestSelectBestEffortFallback::test_closest_match` | Finds closest available effort | Fallback logic: closest match | Request not in list | None | Returns nearest effort | MEDIUM - Distance calculation |  | Proximity-based fallback | None |
| `TestSelectBestEffortFallback::test_empty_supported_returns_none` | Empty supported list returns None | Edge case: no options | Empty supported list | None | Returns None | LOW - Empty check |  | Can't select from nothing | None |
| `TestSelectBestEffortFallback::test_unrecognized_requested_uses_first_supported` | Unrecognized requested effort uses first supported | Unknown request handling | Unknown effort level | None | Returns first in list | MEDIUM - Default behavior |  | Fallback to first option | None |
| `TestSelectBestEffortFallback::test_unrecognized_supported_values_ignored` | Unrecognized supported values are ignored for indexing | Custom value handling | Mix of standard and custom efforts | None | Only standard efforts indexed | MEDIUM - Effort ordering |  | Custom efforts not in ordering | None |
| `TestSelectBestEffortFallback::test_all_supported_unrecognized` | All unrecognized supported values returns first | Edge case: all custom | All custom effort levels | None | Returns first custom | MEDIUM - Fallback logic |  | First custom when no standard | None |
| `TestSelectBestEffortFallback::test_whitespace_trimmed` | Whitespace in values is trimmed | Input normalization | Values with whitespace | None | Returns trimmed result | LOW - Standard strip() |  | Whitespace tolerance | None |
| `TestMarkerSystem::test_serialize_marker` | _serialize_marker creates proper marker format | Marker serialization | `_serialize_marker(ulid)` | None | Returns `[ULID]: #` format | LOW - String formatting |  | Markdown reference link format | None |
| `TestMarkerSystem::test_contains_marker_true` | contains_marker returns True when marker present | Marker detection: positive case | Text with marker | None | Returns True | LOW - Regex search |  | Detects marker presence | None |
| `TestMarkerSystem::test_contains_marker_false` | contains_marker returns False when no marker | Marker detection: negative case | Text without marker | None | Returns False | LOW - Regex search |  | No false positives | None |
| `TestMarkerSystem::test_contains_marker_empty` | contains_marker returns False for empty text | Edge case: empty input | Empty string | None | Returns False | LOW - Empty check |  | Empty text has no markers | None |
| `TestMarkerSystem::test_split_text_by_markers_no_markers` | split_text_by_markers with no markers returns single text segment | No markers case | Text without markers | None | Returns single segment dict | LOW - Passthrough |  | Whole text as one segment | None |
| `TestMarkerSystem::test_split_text_by_markers_with_marker` | split_text_by_markers correctly splits around markers | Marker splitting logic | Text with marker | None | Multiple segments with marker type | MEDIUM - Splitting algorithm |  | Splits on marker boundaries | None |
| `TestMarkerSystem::test_split_text_by_markers_empty` | split_text_by_markers with empty text returns empty list | Edge case: empty input | Empty string | None | Returns [] | LOW - Empty check |  | Empty input yields empty output | None |
| `TestUnwrapConfigValue::test_none_input` | None input returns None | Null handling | `_unwrap_config_value(None)` | None | Returns None | LOW - Pass-through |  | None passes through | None |
| `TestUnwrapConfigValue::test_object_with_value_attr` | Object with .value attribute returns that value | Attribute unwrapping | Object with .value | None | Returns inner value | MEDIUM - Config object pattern |  | Open-WebUI config pattern | None |
| `TestUnwrapConfigValue::test_plain_value` | Plain value without .value attribute returns itself | Non-config value pass-through | Plain value | None | Returns same value | LOW - Identity |  | Plain values unchanged | None |
| `TestRedactPayloadBlobs::test_no_data_urls` | Text without data URLs is unchanged | Happy path: no redaction needed | Dict with plain text | None | Returns unchanged | LOW - No matches |  | Pass-through when no data URLs | None |
| `TestRedactPayloadBlobs::test_short_data_url_unchanged` | Short data URLs are not redacted | Threshold check: below limit | Short data URL | None | Returns unchanged | LOW - Size comparison |  | Small data URLs preserved | None |
| `TestRedactPayloadBlobs::test_long_data_url_redacted` | Long data URLs are redacted | Redaction logic: above limit | Long data URL | None | Contains [REDACTED] and size info | MEDIUM - Redaction logic |  | Large blobs hidden for logs | None |
| `TestRedactPayloadBlobs::test_nested_dict` | Nested dicts are walked | Deep traversal | Nested dict with data URL | None | Inner value redacted | MEDIUM - Recursive walk |  | Traverses nested structures | None |
| `TestRedactPayloadBlobs::test_list` | Lists are walked | List traversal | List with data URL | None | List item redacted | MEDIUM - List handling |  | Handles lists | None |
| `TestRedactPayloadBlobs::test_tuple` | Tuples are walked and returned as tuples | Tuple traversal | Tuple with data URL | None | Tuple item redacted, type preserved | MEDIUM - Tuple immutability |  | Reconstructs tuples | None |
| `TestRedactPayloadBlobs::test_non_data_url_string` | Non-data-URL strings are unchanged | Type filtering | Plain string | None | Returns unchanged | LOW - Pattern match |  | Only data URLs matched | None |
| `TestRedactPayloadBlobs::test_max_chars_bounds` | max_chars is bounded between 64 and 8192 | Parameter validation | Very small max_chars | None | Value clamped | LOW - Min/max bounds |  | Prevents unreasonable thresholds | None |
| `TestExtractPlainTextContent::test_string_content` | String content returns as-is | Happy path: plain string | String input | None | Returns same string | LOW - Identity |  | Strings pass through | None |
| `TestExtractPlainTextContent::test_list_of_strings` | List of strings is joined with newlines | String list joining | List of strings | None | Returns joined with \n | LOW - Join operation |  | Multiple strings combined | None |
| `TestExtractPlainTextContent::test_list_of_dicts_with_text` | List of dicts extracts text field | Dict field extraction: text | Dicts with "text" key | None | Extracts text fields | MEDIUM - Field selection |  | Anthropic message format | None |
| `TestExtractPlainTextContent::test_list_of_dicts_with_content` | List of dicts extracts content field | Dict field extraction: content | Dicts with "content" key | None | Extracts content fields | MEDIUM - Field selection |  | Alternative content field | None |
| `TestExtractPlainTextContent::test_single_dict_with_text` | Single dict extracts text field | Dict unwrapping: text | Dict with "text" | None | Returns text value | MEDIUM - Field access |  | Single dict handling | None |
| `TestExtractPlainTextContent::test_single_dict_with_content` | Single dict extracts content field | Dict unwrapping: content | Dict with "content" | None | Returns content value | MEDIUM - Field access |  | Content field priority | None |
| `TestExtractPlainTextContent::test_dict_without_text_or_content` | Dict without text/content converts to string | Fallback: stringify | Dict without expected keys | None | Returns string representation | LOW - str() fallback |  | Fallback for unknown dicts | None |
| `TestExtractPlainTextContent::test_none_content` | None content returns empty string | Null handling | None input | None | Returns "" | LOW - Default value |  | None becomes empty | None |
| `TestExtractPlainTextContent::test_mixed_list` | Mixed list (strings and dicts) is handled | Mixed type handling | List of strings and dicts | None | Both types extracted | MEDIUM - Type dispatch |  | Handles heterogeneous lists | None |
| `TestExtractFeatureFlags::test_with_features` | Features dict is extracted | Happy path: features present | Dict with "features" key | None | Returns features dict | LOW - Dict access |  | Feature flags extraction | None |
| `TestExtractFeatureFlags::test_no_features` | Missing features returns empty dict | Missing key handling | Dict without "features" | None | Returns {} | LOW - Default dict |  | No features is valid | None |
| `TestExtractFeatureFlags::test_features_not_dict` | Non-dict features returns empty dict | Type validation | features value not a dict | None | Returns {} | LOW - Type check |  | Invalid features ignored | None |
| `TestExtractFeatureFlags::test_non_dict_metadata` | Non-dict metadata returns empty dict | Input validation | Non-dict input | None | Returns {} | LOW - Type check |  | Non-dict metadata rejected | None |
| `TestMergeUsageStats::test_simple_merge` | Simple numeric merge | Happy path: numeric addition | Two usage dicts | None | Values summed | LOW - Addition |  | Token counts merged | None |
| `TestMergeUsageStats::test_nested_merge` | Nested dict merge | Deep merging | Nested usage dicts | None | Nested values summed | MEDIUM - Recursive merge |  | Handles nested structures | None |
| `TestMergeUsageStats::test_new_keys` | New keys are added | Key addition | New key in second dict | None | New key present in result | LOW - Dict update |  | New keys copied over | None |
| `TestMergeUsageStats::test_none_value_preserves_existing` | None value preserves existing value | None handling | None value in update | None | Original value preserved | MEDIUM - Merge strategy |  | None doesn't overwrite | None |
| `TestMergeUsageStats::test_non_numeric_overwrites` | Non-numeric non-None values overwrite | Non-numeric merging | String values | None | New value replaces old | MEDIUM - Type dispatch |  | Strings/bools overwrite | None |
| `TestWrapCodeBlock::test_basic_wrap` | Basic code block wrapping | Happy path: code wrapping | Plain code string | None | Wrapped in markdown fences | LOW - String formatting |  | Creates markdown code block | None |
| `TestWrapCodeBlock::test_custom_language` | Custom language tag | Language parameter | Code with language="javascript" | None | Language in fence | LOW - String interpolation |  | Language annotation | None |
| `TestWrapCodeBlock::test_adapts_fence_length` | Fence length adapts to content with backticks | Fence escaping | Code containing ``` | None | Longer fence used | MEDIUM - Escape logic |  | Prevents fence collision | None |
| `TestTemplateValuePresent::test_none_is_not_present` | None is not present | Null handling | None input | None | Returns False | LOW - None check |  | None means absent | None |
| `TestTemplateValuePresent::test_empty_string_is_not_present` | Empty string is not present | Empty string handling | "" input | None | Returns False | LOW - Empty check |  | Empty string means absent | None |
| `TestTemplateValuePresent::test_non_empty_string_is_present` | Non-empty string is present | String presence | Non-empty string | None | Returns True | LOW - Truthiness |  | Non-empty means present | None |
| `TestTemplateValuePresent::test_empty_collections_not_present` | Empty collections are not present | Collection emptiness | Empty list/tuple/set/dict | None | All return False | LOW - len() check |  | Empty collections absent | None |
| `TestTemplateValuePresent::test_non_empty_collections_present` | Non-empty collections are present | Collection presence | Non-empty collections | None | All return True | LOW - len() check |  | Non-empty collections present | None |
| `TestTemplateValuePresent::test_numbers_always_present` | Numbers are always present (even 0) | Numeric handling | Zero and non-zero numbers | None | All return True | MEDIUM - Zero edge case |  | Zero is present value | None |
| `TestTemplateValuePresent::test_other_types_use_bool` | Other types use bool() for presence | Custom type handling | Custom objects with __bool__ | None | Uses bool() result | LOW - Delegation |  | Fallback to bool() | None |
| `TestSanitizePathComponent::test_simple_string` | Simple alphanumeric string is unchanged | Happy path: safe string | Alphanumeric string | None | Returns unchanged | LOW - No changes needed |  | Safe strings pass through | None |
| `TestSanitizePathComponent::test_with_special_chars` | Special characters are replaced with underscore | Character replacement | String with / and : | None | Special chars replaced | MEDIUM - Replacement rules |  | Path-unsafe chars sanitized | None |
| `TestSanitizePathComponent::test_empty_returns_fallback` | Empty string returns fallback | Empty handling | Empty or whitespace string | None | Returns "unknown" | LOW - Default value |  | Empty uses fallback | None |
| `TestSanitizePathComponent::test_custom_fallback` | Custom fallback is used | Fallback parameter | Empty with custom fallback | None | Returns custom fallback | LOW - Parameter use |  | Fallback configurable | None |
| `TestSanitizePathComponent::test_max_length` | Long strings are truncated | Length limiting | String longer than max | None | Length capped | LOW - Slice operation |  | Prevents overly long names | None |
| `TestSanitizePathComponent::test_strips_leading_trailing_special` | Leading/trailing dots, underscores, dashes are stripped | Edge trimming | String with special edges | None | Leading/trailing removed | MEDIUM - Strip rules |  | Cleans path component edges | None |
| `TestSanitizePathComponent::test_all_special_returns_fallback` | All special chars returns fallback | Edge case: all invalid | String of only special chars | None | Returns fallback | LOW - Empty after sanitize |  | Nothing left means use fallback | None |
| `TestRetryAfterSeconds::test_numeric_seconds` | Numeric string is parsed as seconds | Happy path: numeric parsing | Numeric string "60" | None | Returns 60.0 | LOW - Float conversion |  | Direct numeric parsing | None |
| `TestRetryAfterSeconds::test_negative_clamped_to_zero` | Negative values are clamped to 0 | Boundary validation | Negative numeric string | None | Returns 0.0 | LOW - Max with zero |  | No negative delays | None |
| `TestRetryAfterSeconds::test_empty_returns_none` | Empty value returns None | Empty handling | Empty or whitespace string | None | Returns None | LOW - Empty check |  | Empty means no retry-after | None |
| `TestRetryAfterSeconds::test_none_returns_none` | None returns None | Null handling | None input | None | Returns None | LOW - Pass-through |  | None passes through | None |
| `TestRetryAfterSeconds::test_http_date_format` | HTTP date format is parsed | Date parsing: future date | HTTP date string 120s future | None | Returns ~120 seconds | MEDIUM - Date parsing |  | RFC 7231 date format | None |
| `TestRetryAfterSeconds::test_past_date_returns_zero` | Past date returns 0 | Date parsing: past date | HTTP date in past | None | Returns 0.0 | MEDIUM - Time comparison |  | Past means no delay | None |
| `TestRetryAfterSeconds::test_invalid_format_returns_none` | Invalid format returns None | Error handling | Invalid date/number string | None | Returns None | LOW - Exception catch |  | Invalid input handled | None |
| `TestPrettyJson::test_none_returns_empty` | None returns empty string | Null handling | None input | None | Returns "" | LOW - None check |  | None becomes empty | None |
| `TestPrettyJson::test_string_stripped` | String is stripped and returned | String handling | String with whitespace | None | Returns trimmed string | LOW - Strip operation |  | Strings cleaned | None |
| `TestPrettyJson::test_bytes_decoded` | Bytes are decoded and stripped | Bytes handling | Bytes with whitespace | None | Returns decoded trimmed string | LOW - Decode + strip |  | Bytes decoded UTF-8 | None |
| `TestPrettyJson::test_dict_formatted` | Dict is formatted as JSON | JSON formatting | Dict input | None | Returns JSON string with keys | LOW - json.dumps |  | Dicts serialized | None |
| `TestPrettyJson::test_non_serializable_uses_str` | Non-serializable objects use str() | Fallback for custom types | Custom object | None | Contains str() representation | MEDIUM - Fallback logic |  | Custom objects stringified | None |
| `TestRenderErrorTemplateEdgeCases::test_nested_conditionals` | Nested conditionals work correctly | Template nesting | Nested {{#if}} blocks | None | Correct nesting behavior | MEDIUM - Parser complexity |  | Supports nested conditions | None |
| `TestRenderErrorTemplateEdgeCases::test_extra_endif_ignored` | Extra {{/if}} without matching {{#if}} is gracefully handled | Parser robustness | Unmatched {{/if}} | None | No exception raised | LOW - Defensive parsing |  | Handles malformed templates | None |
| `TestRenderErrorTemplateEdgeCases::test_placeholder_with_none_value` | Placeholder with None value renders as empty | None placeholder handling | Placeholder with None | None | Line dropped | MEDIUM - Template logic |  | None placeholders removed | None |
| `TestRenderErrorTemplateEdgeCases::test_blank_line_inside_false_conditional` | Blank lines inside false conditional are skipped | Conditional blank handling | Blank lines in false block | None | Blank lines not in output | MEDIUM - Whitespace logic |  | False blocks fully removed | None |
| `TestRenderErrorTemplateEdgeCases::test_empty_template_uses_default` | Empty template falls back to default (line 79) | Default template fallback | Empty string template | None | Uses default template | MEDIUM - Fallback logic |  | Empty means use default | None |
| `TestRenderErrorTemplateEdgeCases::test_blank_line_preserved_when_active` | Blank lines are preserved when conditions are active (lines 116-117) | Whitespace preservation | Blank lines outside conditionals | None | Blank lines preserved | MEDIUM - Whitespace handling |  | Intentional blanks kept | None |
| `TestRenderErrorTemplateEdgeCases::test_blank_line_in_active_conditional` | Blank lines inside active conditional are preserved | Conditional whitespace | Blank in true block | None | Blank line present | MEDIUM - Conditional whitespace |  | Active blocks keep blanks | None |
| `TestExtractMarkerUlidEdgeCases::test_empty_line` | Empty line returns None | Empty handling | Empty or None line | None | Returns None | LOW - Empty check |  | Empty means no marker | None |
| `TestExtractMarkerUlidEdgeCases::test_wrong_length` | Wrong ULID length returns None | Length validation | ULID too short/long | None | Returns None | MEDIUM - Length check |  | ULID must be exact length | None |
| `TestExtractMarkerUlidEdgeCases::test_invalid_crockford_chars` | Invalid Crockford characters return None | Character validation | ULID with invalid chars (I, L, O, U) | None | Returns None | MEDIUM - Alphabet check |  | Must be valid Crockford base32 | None |
| `TestExtractMarkerUlidEdgeCases::test_no_marker_prefix` | Line without [ prefix returns None | Format validation: prefix | Line missing [ | None | Returns None | LOW - Prefix check |  | Marker needs [ prefix | None |
| `TestExtractMarkerUlidEdgeCases::test_no_marker_suffix` | Line without ]: # suffix returns None | Format validation: suffix | Line missing ]: # | None | Returns None | LOW - Suffix check |  | Marker needs ]: # suffix | None |
| `TestSelectBestEffortFallbackEdgeCases::test_fallback_loop_coverage` | Test the closest match loop path (lines 261-268) | Coverage: closest match loop | Request "minimal" with only "high" | None | Returns "high" | MEDIUM - Fallback path |  | Tests iteration fallback | None |
| `TestSelectBestEffortFallbackEdgeCases::test_middle_match_next_higher` | Test finding next higher effort when in between | Fallback: next higher | Request "low" with "none" and "medium" | None | Returns "medium" | MEDIUM - Upward fallback |  | Finds next higher option | None |
| `TestSelectBestEffortFallbackEdgeCases::test_closest_match_fallback_loop` | Test the closest distance fallback loop (lines 261-268) | Coverage: distance loop | Request "high" with "none" and "low" | None | Returns "low" | MEDIUM - Distance calculation |  | Closest when no higher option | None |
| `TestSelectBestEffortFallbackEdgeCases::test_closest_match_single_option_lower` | Test closest match when only lower options available | Fallback: single lower | Request "xhigh" with only "minimal" | None | Returns "minimal" | MEDIUM - Edge case |  | Returns max when all lower | None |
| `TestRedactPayloadBlobsEdgeCases::test_non_string_primitives` | Non-string primitive values pass through unchanged (line 399) | Primitive handling | Numbers, bools, None | None | All unchanged | LOW - Type filter |  | Primitives not redacted | None |
| `TestRedactPayloadBlobsEdgeCases::test_non_integer_max_chars` | Non-integer max_chars falls back to 256 | Parameter validation | Invalid max_chars type | None | Uses default 256 | LOW - Type check |  | Invalid max_chars ignored | None |
| `TestGetOpenWebuiConfigModule::test_returns_cached_module` | Returns cached module on subsequent calls | Caching behavior | Multiple calls | None | Same object returned | MEDIUM - Cache logic |  | Module cached after first load | None |
| `TestGetOpenWebuiConfigModule::test_caches_successful_import` | Caches module after successful import (lines 348-355) | Import caching | Import path | conftest stub | Module cached | MEDIUM - Import logic |  | Successful import cached | None |
| `TestGetOpenWebuiConfigModule::test_first_successful_import_caches` | Test first successful import caches the module (lines 352-355) | Cache initialization | First call with reset cache | conftest stub | Cache populated | MEDIUM - Cache state |  | First import sets cache | None |
| `TestRetryAfterSecondsEdgeCases::test_http_date_without_timezone` | HTTP date without explicit timezone still works (lines 549, 551) | Date parsing: timezone handling | HTTP date with TZ | None | Parses correctly | MEDIUM - Timezone logic |  | Timezone-aware parsing | None |
| `TestRetryAfterSecondsEdgeCases::test_malformed_date_returns_none` | Malformed date that raises exception returns None | Error handling | Invalid date format | None | Returns None | LOW - Exception catch |  | Malformed dates caught | None |
| `TestRetryAfterSecondsEdgeCases::test_date_returns_none_path` | Test the dt is None branch (line 549) | Coverage: None branch | Mock parsedate returns None | monkeypatch | Returns None | MEDIUM - Branch coverage |  | Handles parse failure | None |
| `TestRetryAfterSecondsEdgeCases::test_naive_datetime_gets_utc` | Test the timezone-naive datetime branch (line 551) | Coverage: naive datetime | Mock returns naive datetime | monkeypatch | Converts to UTC | MEDIUM - Timezone conversion |  | Naive datetimes get UTC | None |
| `test_detect_runtime_pipe_id_from_module_prefix` | Detects pipe ID from function_demo.plugin prefix | Runtime ID detection | Patched __name__ | monkeypatch | Returns "demo.plugin" | MEDIUM - Module introspection |  | Extracts ID from module name | None |
| `test_detect_runtime_pipe_id_default` | Uses fallback when standard package name | Fallback ID | Standard package name | monkeypatch | Returns fallback | LOW - Default case |  | Fallback when no custom prefix | None |
| `test_render_error_template_handles_conditionals` | Template rendering with conditionals | Conditional rendering | Template with {{#if}} blocks | None | Correct sections shown/hidden | MEDIUM - Template logic |  | If/endif blocks work | None |
| `test_pretty_json_and_template_value_present` | Tests both pretty_json and template_value_present | Multiple utilities | Dict and strings | None | JSON formatted, presence checked | LOW - Combined test |  | Two helper functions | None |
| `test_build_error_template_values_includes_context` | Error template values include all context | Template value building | OpenRouterAPIError with metadata | None | All fields present in values | MEDIUM - Value mapping |  | Complete context mapping | None |
| `test_get_open_webui_config_module` | Config module retrieval | Module getter | Cached module | monkeypatch | Returns sentinel object | LOW - Getter function |  | Returns cached config module | None |
| `test_unwrap_and_coerce_helpers` | Tests unwrap, coerce_positive_int, coerce_bool | Multiple coercion utilities | Various inputs | None | All coercions correct | LOW - Utility combo |  | Three helper functions | None |
| `test_retry_after_seconds_parses_date` | Retry-After date parsing | Date to seconds conversion | Future date string | None | Returns positive seconds | MEDIUM - Date arithmetic |  | HTTP date format parsed | None |
| `test_classify_retryable_http_error` | HTTP error classification for retryability | Error classification | 502 HTTPStatusError | None | Marked as retryable | MEDIUM - Status code logic |  | 5xx errors are retryable | None |
| `test_read_rag_file_constraints` | Reads RAG config constraints | Config reading | Config with RAG settings | monkeypatch | Returns enabled flag and limit | MEDIUM - Config access |  | RAG constraints from config | None |
| `test_sanitize_model_id` | Sanitizes model IDs by replacing slashes | Model ID sanitization | Model IDs with / | None | Returns with dots | LOW - String replace |  | Slashes become dots | None |
| `test_debug_print_request_redacts` | Debug logging redacts sensitive headers | Debug logging | Headers with auth token | Logger fixture | Token truncated in log | HIGH - Security logging |  | Authorization headers redacted | None |
| `test_debug_print_error_response` | Async error response logging | Async debug logging | Fake ClientResponse | Logger fixture, pytest.mark.asyncio | Body logged | LOW - Async logging |  | Error responses logged | None |
| `test_safe_json_and_normalizers` | Tests safe JSON and string normalizers | Multiple normalizers | Various inputs | None | All work correctly | LOW - Combined test |  | Multiple helper functions | None |
| `test_extract_openrouter_error_details_and_builder` | OpenRouter error extraction and building | Error parsing | JSON error payload | None | Details extracted, error built | MEDIUM - Error parsing |  | OpenRouter error handling | None |
| `test_resolve_and_format_openrouter_error_markdown` | Error formatting to markdown | Error formatting | OpenRouterAPIError | ModelFamily specs | Markdown contains context | HIGH - User-facing errors |  | Error displayed as markdown | Check template changes |
| `test_filter_openrouter_request_drops_invalid_keys` | Filters request to remove invalid keys | Request filtering | Request with extra/invalid keys | None | Invalid keys removed | HIGH - API contract |  | Only valid keys sent to API | Review on API changes |
| `test_internal_file_helpers` | Internal file URL/ID helpers | File URL parsing | File URLs and IDs | None | ID extracted, URL detected | MEDIUM - File handling |  | Open-WebUI file URLs | None |
| `test_wrap_event_emitter_controls_events` | Event emitter wrapper filters events | Event filtering | Emitter with suppress flag | pytest.mark.asyncio, pipe fixture | Suppressed events not emitted | MEDIUM - Event control |  | Selective event emission | None |
| `test_merge_usage_stats_and_wrap_code_block` | Merges usage stats and wraps code | Combined utilities | Usage dicts and code | None | Stats merged, code wrapped | LOW - Combined test |  | Two utility functions | None |
| `test_normalize_persisted_item_variants` | Normalizes different persisted item types | Item normalization | function_call, output, reasoning | None | All normalized correctly | MEDIUM - Type dispatch |  | Multiple item types handled | None |
| `test_classify_function_call_artifacts` | Classifies function call artifacts | Artifact classification | Mixed artifacts | None | Valid, orphan calls, orphan outputs | MEDIUM - Pairing logic |  | Matches calls with outputs | None |
| `test_crockford_and_markers` | Tests Crockford encoding and markers | Multiple marker functions | ULIDs and marker text | None | All marker operations work | MEDIUM - Marker system |  | ULID generation and markers | None |
| `test_sanitize_table_fragment` | Sanitizes table fragment names | Table name sanitization | Model name with special chars | None | Returns sanitized name | LOW - String sanitization |  | Table-safe names | None |
| `test_build_tools_and_dedupe` | Builds and deduplicates tool list | Tool building | Registry and extra tools | ModelFamily specs | Deduplicated tool list | HIGH - Tool calling |  | Tools from multiple sources | Review on tool changes |
| `test_strictify_schema_helpers` | Strictifies JSON schema and dedupes tools | Schema strictification | JSON schema | None | Required fields added, nullable | MEDIUM - Schema transformation |  | OpenAI strict mode compliance | None |
| `test_decode_payload_bytes_rejects_headerless_ciphertext` | Rejects legacy payload without header | Payload validation | Legacy bytes without header | pipe fixture | Raises ValueError | HIGH - Security validation |  | Prevents legacy format | None |
| `test_prepare_rows_for_storage_encrypts_payloads` | Encrypts payloads before storage | Encryption | Rows with payloads | pipe with encryption enabled | Payloads encrypted | HIGH - Data encryption |  | At-rest encryption works | None |
| `test_prepare_rows_for_storage_idempotent` | Row preparation is idempotent | Idempotency | Same rows twice | pipe with encryption | Same result both times | MEDIUM - Idempotency |  | Multiple calls safe | None |
| `test_redis_fetch_rows_decrypts_cached_payloads` | Decrypts payloads fetched from Redis | Redis decryption | Encrypted cached row | pytest.mark.asyncio, pipe, fake Redis | Decrypted correctly | HIGH - Cache decryption |  | Redis cache decryption | None |
| `test_flush_redis_queue_warns_when_lock_release_returns_zero` | Warns when Redis lock release fails | Lock release warning | Fake Redis returning 0 | pytest.mark.asyncio, caplog, pipe | Warning logged | MEDIUM - Lock safety |  | Lock release failure detected | None |
| `test_render_error_template_hides_missing_sections` | Hides sections with missing values | Template conditional hiding | Template with optional sections | None | Only populated sections shown | MEDIUM - Template logic |  | Clean error messages | None |
| `test_render_error_template_uses_default_template` | Uses default template when empty | Default template fallback | Empty template string | None | Default template used | MEDIUM - Fallback |  | Always has error template | None |
| `test_build_error_template_values_reports_model_limits` | Reports model limits in error template | Model limit reporting | Error with model context | None | Limits in template values | HIGH - User guidance |  | Shows token limits in errors | None |
| `test_template_utils_cover_edge_cases` | Template utility edge cases | Edge cases for template utils | Various edge inputs | None | All handled correctly | LOW - Edge cases |  | Robust template helpers | None |
| `test_encrypted_str_roundtrip` | Encrypts and decrypts strings | Encryption roundtrip | String value | monkeypatch (env var) | Decrypted matches original | HIGH - Encryption correctness |  | EncryptedStr works | None |
| `test_strictify_schema_enforces_required_and_nullability` | Schema strictification with nesting | Deep schema strictification | Nested schema | None | All fields required, nullable | MEDIUM - Schema transformation |  | Nested schemas handled | None |
| `test_build_tools_combines_registry_and_extras` | Combines tools from registry and extras | Tool combination | Registry + extra tools | ModelFamily specs | Both sources merged | HIGH - Tool calling |  | Multiple tool sources | None |
| `test_tool_output_clamps_failed_status` | Tool output clamps failed to completed | Status clamping | Failed tool output | pipe fixture | Status changed to completed | MEDIUM - OpenRouter compatibility |  | No "failed" status sent | None |
| `test_select_openrouter_http_referer_defaults_without_override` | Uses default referer without override | Default referer | No override | None | Returns default | LOW - Default value |  | Default referer used | None |
| `test_select_openrouter_http_referer_accepts_full_url_override` | Accepts full URL referer override | Referer override | Valid URL override | None | Returns override URL | MEDIUM - Referer customization |  | Custom referer allowed | None |
| `test_select_openrouter_http_referer_rejects_non_url_override` | Rejects non-URL referer override | Referer validation | Invalid URL override | None | Returns default | MEDIUM - Referer validation |  | Only valid URLs accepted | None |
| `test_normalize_persisted_items_and_classifier` | Normalizes items and classifies artifacts | Item normalization + classification | Various item types | None | All normalized and classified | MEDIUM - Persistence logic |  | Item storage preparation | None |
| `test_marker_helpers_and_ulids` | Tests ULID and marker helpers | ULID generation and markers | Generated ULIDs | None | Markers work, ULIDs unique | MEDIUM - Marker system |  | ULID uniqueness and markers | None |
| `test_format_final_status_description_includes_cost_tokens_and_tps` | Formats final status with all details | Status formatting | Usage with all fields | pipe fixture | All details in description | HIGH - User feedback |  | Complete status info shown | None |
| `test_format_final_status_description_respects_disabled_flag` | Respects disabled usage status flag | Flag handling | Disabled flag in valves | pipe fixture | Simple message when disabled | LOW - Config flag |  | Status can be simplified | None |


## `tests/test_logging_system.py`

| Test Name | Description | What It Tests | Code Under Test | Mocks/Fixtures | Assertions | Drift Risk | Check Done | Codex Notes | Codex TODO |
|-----------|-------------|---------------|-----------------|----------------|------------|-----------|------------|-------------|------------|
| TestPyzipperImportFallback::test_write_session_log_archive_no_pyzipper | Test behavior when pyzipper is not available | write_session_log_archive returns early when pyzipper is None | write_session_log_archive, lines 37-38 fallback handling | tmp_path fixture, patches pyzipper to None | No zip file created | LOW | YES | Tests import fallback path for optional dependency | None |
| TestClassifyEventType::test_classify_openrouter_request_headers | Test classification of OpenRouter request headers | Event type detection for OpenRouter request headers | SessionLogger._classify_event_type, lines 101-110 | None | Returns "openrouter.request.headers" | LOW | YES | Tests pattern matching for specific log type | None |
| TestClassifyEventType::test_classify_openrouter_request_payload | Test classification of OpenRouter request payload | Event type detection for OpenRouter request payload | SessionLogger._classify_event_type | None | Returns "openrouter.request.payload" | LOW | YES | Tests pattern matching for payload logs | None |
| TestClassifyEventType::test_classify_openrouter_sse_event | Test classification of OpenRouter SSE event | Event type detection for SSE events | SessionLogger._classify_event_type | None | Returns "openrouter.sse.event" | LOW | YES | Tests SSE data stream detection | None |
| TestClassifyEventType::test_classify_tool_message | Test classification of tool execution message | Event type detection for tool execution logs | SessionLogger._classify_event_type | None | Returns "pipe.tools" | LOW | YES | Tests tool execution log classification | None |
| TestClassifyEventType::test_classify_tool_emoji_message | Test classification of tool message with emoji prefix | Event type detection for tool logs with wrench emoji | SessionLogger._classify_event_type | None | Returns "pipe.tools" | LOW | YES | Tests emoji-prefixed tool log detection | None |
| TestClassifyEventType::test_classify_skipping_message | Test classification of skipping message | Event type detection for skipped tool calls | SessionLogger._classify_event_type | None | Returns "pipe.tools" | LOW | YES | Tests skipping action classification | None |
| TestClassifyEventType::test_classify_generic_pipe_message | Test classification of generic pipe message | Event type detection for non-specific messages | SessionLogger._classify_event_type | None | Returns "pipe" | LOW | YES | Tests default fallback classification | None |
| TestClassifyEventType::test_classify_empty_message | Test classification of empty message | Event type detection with empty string | SessionLogger._classify_event_type | None | Returns "pipe" | LOW | YES | Tests edge case for empty input | None |
| TestClassifyEventType::test_classify_none_message | Test classification of None message | Event type detection with None input | SessionLogger._classify_event_type | None | Returns "pipe" | LOW | YES | Tests null safety in classification | None |
| TestClassifyEventType::test_classify_message_with_leading_whitespace | Test classification with leading whitespace | Event type detection strips whitespace before matching | SessionLogger._classify_event_type | None | Returns "openrouter.request.headers" | LOW | YES | Tests whitespace normalization | None |
| TestBuildEvent::test_build_event_basic | Test basic event building from LogRecord | Structured event creation from standard LogRecord | SessionLogger._build_event, lines 116-147 | None | Event has all expected fields (level, logger, request_id, session_id, user_id, message, lineno, created, event_type) | LOW | YES | Tests core event building functionality | None |
| TestBuildEvent::test_build_event_with_exc_text | Test event building with exc_text | Event creation includes exception text when present | SessionLogger._build_event | None | Event has exception field with text | LOW | YES | Tests exception text inclusion | None |
| TestBuildEvent::test_build_event_with_exc_info | Test event building with exc_info | Event creation includes formatted exception from exc_info | SessionLogger._build_event | None | Event has exception field with ValueError and message | LOW | YES | Tests exception info formatting | None |
| TestBuildEvent::test_build_event_getMessage_fails | Test event building when getMessage() raises | Fallback to str(msg) when getMessage fails | SessionLogger._build_event | None | Message is str(msg) | MEDIUM | YES | Tests error handling in message extraction | None |
| TestBuildEvent::test_build_event_missing_attributes | Test event building with minimal LogRecord | Event creation with missing custom attributes | SessionLogger._build_event | None | request_id, session_id, user_id are None | LOW | YES | Tests graceful handling of missing attrs | None |
| TestFormatEventAsText::test_format_event_basic | Test basic text formatting of event | Text output includes timestamp, level, user, message | SessionLogger.format_event_as_text, lines 153-171 | None | Output contains "[INFO]", "[user=user-1]", "Test message" | LOW | YES | Tests core text formatting | None |
| TestFormatEventAsText::test_format_event_missing_created | Test text formatting without created timestamp | Text formatting works without created field | SessionLogger.format_event_as_text | None | Output contains level and message | LOW | YES | Tests handling of missing timestamp | None |
| TestFormatEventAsText::test_format_event_invalid_created | Test text formatting with invalid created timestamp | Text formatting handles non-numeric created | SessionLogger.format_event_as_text | None | Output contains "[ERROR]", "[user=-]" | LOW | YES | Tests invalid timestamp handling | None |
| TestFormatEventAsText::test_format_event_none_message | Test text formatting with None message | Text formatting handles None message | SessionLogger.format_event_as_text | None | Output contains "[DEBUG]" | LOW | YES | Tests null message handling | None |
| TestFormatEventAsText::test_format_event_exception_in_strftime | Test text formatting when time.localtime fails | Fallback datetime formatting when localtime raises | SessionLogger.format_event_as_text, lines 162-163 | Patches time.localtime to raise | Output contains "[INFO]" | MEDIUM | YES | Tests exception handling in time formatting | None |
| TestFormatEventAsText::test_format_event_message_str_fails | Test text formatting when str(message) fails | Fallback when message string conversion fails | SessionLogger.format_event_as_text | None (BadStr class) | Output contains "[INFO]" | MEDIUM | YES | Tests message conversion error handling | None |
| TestGetLogger::test_get_logger_basic | Test basic logger creation | Logger is created with correct name, level, propagate | SessionLogger.get_logger, lines 175-226 | None | logger.name, logger.level, logger.propagate | LOW | YES | Tests logger initialization | None |
| TestGetLogger::test_get_logger_adds_null_handler_to_root | Test NullHandler added to root logger | NullHandler is added to root if not present | SessionLogger.get_logger, line 192 | None | Root logger has NullHandler | LOW | YES | Tests root logger configuration | None |
| TestGetLogger::test_get_logger_filter_attaches_metadata | Test filter attaches session metadata to records | Filter adds session_id, request_id, user_id from context | SessionLogger.get_logger filter logic | Contextvar tokens | Record has attached metadata | LOW | YES | Tests contextvar-based metadata attachment | None |
| TestGetLogger::test_get_logger_filter_handles_exception | Test filter doesn't break on exception | Filter always returns True even on errors | SessionLogger.get_logger filter logic | None | Filter returns True | LOW | YES | Tests filter error resilience | None |
| TestSetMaxLines::test_set_max_lines_valid | Test setting valid max_lines | max_lines is updated to valid value | SessionLogger.set_max_lines, lines 241-246 | None | max_lines == 5000 | LOW | YES | Tests valid configuration | None |
| TestSetMaxLines::test_set_max_lines_below_minimum | Test setting max_lines below minimum | Value clamped to minimum of 100 | SessionLogger.set_max_lines | None | max_lines == 100 | LOW | YES | Tests lower bound enforcement | None |
| TestSetMaxLines::test_set_max_lines_above_maximum | Test setting max_lines above maximum | Value clamped to maximum of 200000 | SessionLogger.set_max_lines | None | max_lines == 200000 | LOW | YES | Tests upper bound enforcement | None |
| TestSetMaxLines::test_set_max_lines_invalid_value | Test setting invalid max_lines value | Invalid value doesn't change max_lines | SessionLogger.set_max_lines | None | max_lines unchanged | LOW | YES | Tests type safety | None |
| TestEnqueue::test_enqueue_no_queue | Test enqueue when queue is None | process_record called directly when no queue | SessionLogger._enqueue, lines 250-268 | Patches process_record | process_record called once | LOW | YES | Tests synchronous fallback path | None |
| TestEnqueue::test_enqueue_same_loop | Test enqueue in same event loop | Record added to queue via _safe_put | SessionLogger._enqueue | asyncio event loop and queue | Record in queue | LOW | YES | Tests same-loop async path | None |
| TestEnqueue::test_enqueue_different_loop_threadsafe | Test enqueue from different thread | call_soon_threadsafe used when loop differs | SessionLogger._enqueue | Mock loop | call_soon_threadsafe called | LOW | YES | Tests cross-thread enqueueing | None |
| TestEnqueue::test_enqueue_closed_loop_fallback | Test enqueue when main loop is closed | Falls back to process_record when loop closed | SessionLogger._enqueue | Mock loop with is_closed=True | process_record called | LOW | YES | Tests closed loop handling | None |
| TestSafePut::test_safe_put_success | Test safe queue put operation | Record added to queue successfully | SessionLogger._safe_put, lines 272-276 | asyncio queue | Record in queue | LOW | YES | Tests normal queue put | None |
| TestSafePut::test_safe_put_queue_full | Test safe put when queue is full | Falls back to process_record when queue full | SessionLogger._safe_put | Queue with maxsize=1 | process_record called | LOW | YES | Tests queue overflow handling | None |
| TestProcessRecord::test_process_record_writes_to_stdout | Test process_record writes to stdout | Log message appears in stdout | SessionLogger.process_record, lines 280-320 | capsys fixture | Message in captured output | LOW | YES | Tests console output | None |
| TestProcessRecord::test_process_record_respects_log_level | Test process_record respects log level | Messages below session_log_level filtered | SessionLogger.process_record | capsys fixture | Message not in output | LOW | YES | Tests log level filtering | None |
| TestProcessRecord::test_process_record_stores_in_buffer | Test process_record stores in logs buffer | Records with request_id stored in SessionLogger.logs | SessionLogger.process_record | None | request_id in logs, buffer has event | MEDIUM | YES | Tests buffer storage logic | None |
| TestProcessRecord::test_process_record_creates_new_buffer | Test process_record creates new buffer | New deque created for new request_id | SessionLogger.process_record | None | New buffer is deque | MEDIUM | YES | Tests buffer initialization | None |
| TestProcessRecord::test_process_record_build_event_fails | Test process_record when _build_event raises | Fallback event created when _build_event fails | SessionLogger.process_record | Patches _build_event to raise | Fallback event in buffer | MEDIUM | YES | Tests error resilience | None |
| TestProcessRecord::test_process_record_resizes_buffer_on_maxlen_change | Test process_record recreates buffer on max_lines change | Buffer recreated with new maxlen when max_lines changes | SessionLogger.process_record | None | Buffer maxlen updated | MEDIUM | YES | Tests dynamic buffer resizing | None |
| TestCleanup::test_cleanup_removes_stale_sessions | Test cleanup removes stale sessions | Old sessions removed, fresh ones kept | SessionLogger.cleanup, lines 326-331 | None | Stale session removed, fresh kept | LOW | YES | Tests cleanup logic | None |
| TestCleanup::test_cleanup_no_stale_sessions | Test cleanup with no stale sessions | All fresh sessions retained | SessionLogger.cleanup | None | All sessions kept | LOW | YES | Tests no-op cleanup | None |
| TestWriteSessionLogArchive::test_archive_empty_base_dir | Test archive with empty base_dir | Returns early when base_dir is empty | write_session_log_archive, lines 353-564 | None | No error, early return | LOW | YES | Tests input validation | None |
| TestWriteSessionLogArchive::test_archive_whitespace_base_dir | Test archive with whitespace base_dir | Returns early when base_dir is whitespace | write_session_log_archive | None | No error, early return | LOW | YES | Tests whitespace handling | None |
| TestWriteSessionLogArchive::test_archive_creates_zip_jsonl_format | Test archive creation with JSONL format | Creates encrypted zip with meta.json and logs.jsonl | write_session_log_archive | tmp_path, pyzipper | Zip exists with correct files | LOW | YES | Tests JSONL archive creation | None |
| TestWriteSessionLogArchive::test_archive_creates_zip_text_format | Test archive creation with text format | Creates encrypted zip with meta.json and logs.txt | write_session_log_archive | tmp_path, pyzipper | Zip exists with text log | LOW | YES | Tests text archive creation | None |
| TestWriteSessionLogArchive::test_archive_creates_zip_both_format | Test archive creation with both formats | Creates encrypted zip with both logs.txt and logs.jsonl | write_session_log_archive | tmp_path, pyzipper | Zip has both formats | LOW | YES | Tests dual-format archive | None |
| TestWriteSessionLogArchive::test_archive_invalid_log_format_defaults_jsonl | Test archive with invalid log_format | Defaults to jsonl when format invalid | write_session_log_archive | tmp_path, pyzipper | logs.jsonl in zip | LOW | YES | Tests format fallback | None |
| TestWriteSessionLogArchive::test_archive_stored_compression | Test archive with stored (no) compression | Creates zip with stored compression mode | write_session_log_archive | tmp_path, pyzipper | Zip exists | LOW | YES | Tests compression option | None |
| TestWriteSessionLogArchive::test_archive_handles_non_dict_events | Test archive coerces non-dict events | Non-dict events coerced to dict format | write_session_log_archive | tmp_path, pyzipper | Zip created successfully | MEDIUM | YES | Tests type coercion | None |
| TestWriteSessionLogArchive::test_archive_handles_exception_in_event | Test archive with exception block in event | Events with exception field handled | write_session_log_archive | tmp_path, pyzipper | Zip has exception data | LOW | YES | Tests exception serialization | None |
| TestWriteSessionLogArchive::test_archive_extracts_request_ids | Test archive extracts unique request_ids | Unique request_ids from events added to meta | write_session_log_archive | tmp_path, pyzipper | meta.json has request_ids list | LOW | YES | Tests request_id extraction | None |
| TestWriteSessionLogArchive::test_archive_mkdir_fails | Test archive when mkdir fails | Handles permission errors gracefully | write_session_log_archive | Patches mkdir to raise | No error raised | MEDIUM | YES | Tests mkdir error handling | None |
| TestWriteSessionLogArchive::test_archive_zip_write_fails | Test archive when zip creation fails | Handles zip write errors gracefully | write_session_log_archive | Patches AESZipFile to raise | No zip created | MEDIUM | YES | Tests zip write error handling | None |
| TestWriteSessionLogArchive::test_archive_replace_fails | Test archive when os.replace fails | Handles replace errors, cleans up temp file | write_session_log_archive | Patches os.replace to raise | No final zip exists | MEDIUM | YES | Tests atomic replace error handling | None |
| TestWriteSessionLogArchive::test_archive_invalid_created_timestamp | Test archive with invalid created timestamps | Handles non-numeric created values | write_session_log_archive | tmp_path, pyzipper | Zip created | LOW | YES | Tests timestamp validation | None |
| TestWriteSessionLogArchive::test_archive_json_encode_fails | Test archive when JSON encoding fails | Fallback when json.dumps fails on event | write_session_log_archive | Patches json.dumps, pyzipper | Zip created with fallback | MEDIUM | YES | Tests JSON serialization errors | None |
| TestWriteSessionLogArchive::test_archive_empty_events | Test archive with empty events list | Creates zip even with no events | write_session_log_archive | tmp_path, pyzipper | Zip exists | LOW | YES | Tests empty archive creation | None |
| TestQueueAndLoopSetters::test_set_log_queue | Test setting log queue | log_queue can be set and cleared | SessionLogger.set_log_queue, lines 230-235 | None | log_queue updated | LOW | YES | Tests queue configuration | None |
| TestQueueAndLoopSetters::test_set_main_loop | Test setting main loop | _main_loop can be set and cleared | SessionLogger.set_main_loop, lines 230-235 | None | _main_loop updated | LOW | YES | Tests loop configuration | None |
| TestSessionLogArchiveJob::test_job_creation | Test archive job dataclass creation | All fields properly assigned in dataclass | _SessionLogArchiveJob | None | All fields match input | LOW | YES | Tests dataclass structure | None |
| TestConsoleFormatterException::test_formatter_exception_caught | Test console formatter exception handling | Exceptions in formatter.format caught gracefully | SessionLogger.process_record, lines 288-289 | Mock formatter that raises | No exception propagates | MEDIUM | YES | Tests formatter error resilience | None |
| TestFilterContextUpdates::test_filter_updates_last_seen | Test filter updates _session_last_seen | Filter updates last_seen timestamp for request_id | SessionLogger.get_logger filter, lines 208-212 | Contextvar tokens | request_id in _session_last_seen | LOW | YES | Tests session tracking | None |
| TestBuildEventExceptionInTraceback::test_build_event_traceback_format_fails | Test _build_event when traceback formatting fails | Exception field gracefully omitted when format fails | SessionLogger._build_event | Patches traceback.format_exception | No exception field or None | MEDIUM | YES | Tests traceback error handling | None |
| TestArchiveEdgeCases::test_archive_coerce_event_str_fails | Test archive when str() fails on non-dict event | _coerce_event handles str conversion failures | write_session_log_archive _coerce_event | tmp_path, pyzipper, BadStr class | Zip created | MEDIUM | YES | Tests type coercion error handling | None |
| TestArchiveEdgeCases::test_archive_message_str_fails_in_jsonl | Test archive when message str() fails in JSONL | _build_jsonl_record handles message str failures | write_session_log_archive | tmp_path, pyzipper, BadMessage class | Zip created | MEDIUM | YES | Tests message serialization errors | None |
| TestArchiveEdgeCases::test_archive_text_format_with_none_values | Test archive text format with None/empty values | Text formatting handles None and empty values | write_session_log_archive | tmp_path, pyzipper | Zip created | LOW | YES | Tests null safety in text format | None |
| TestArchiveEdgeCases::test_archive_format_iso_utc_fails | Test archive when _format_iso_utc fails | Handles invalid timestamps (infinity) gracefully | write_session_log_archive _format_iso_utc | tmp_path, pyzipper | Zip created | MEDIUM | YES | Tests ISO timestamp error handling | None |
| TestArchiveEdgeCases::test_archive_request_ids_extraction_exception | Test archive when request_ids extraction fails | Handles iteration errors during extraction | write_session_log_archive | tmp_path, pyzipper | Zip created | MEDIUM | YES | Tests extraction error handling | None |
| TestProcessRecordOuterException::test_process_record_outer_exception_caught | Test process_record outer exception handling | Outer exception in process_record caught | SessionLogger.process_record | Mock lock that raises | No exception propagates | HIGH | YES | Tests critical error handling path | None |
| TestEmitHandler::test_emit_handler_calls_enqueue | Test emit handler calls _enqueue | Handler emit method calls _enqueue | SessionLogger.get_logger handler emit | Patches _enqueue | _enqueue called once | LOW | YES | Tests handler integration | None |


## `tests/test_models.py`

| Test Name | Description | What It Tests | Code Under Test | Mocks/Fixtures | Assertions | Drift Risk | Check Done | Codex Notes | Codex TODO |
|-----------|-------------|---------------|-----------------|----------------|------------|------------|------------|-------------|------------|
| test_build_icon_mapping_with_protocol_relative_url | Protocol-relative URLs get https prefix | Icon URL normalization for protocol-relative URLs | _build_icon_mapping | pipe_instance, frontend_data dict | icon_mapping["test/model"] == "https://cdn.example.com/icon.png" | Low | Yes | Tests icon URL normalization for protocol-relative URLs (//example.com) |  |
| test_build_icon_mapping_with_bare_path | Bare paths get site URL prefix | Icon URL normalization for bare paths | _build_icon_mapping | pipe_instance, frontend_data dict | icon_mapping["test/model"] == "https://openrouter.ai/images/icon.png" | Low | Yes | Tests bare path (no leading slash) gets site prefix |  |
| test_build_icon_mapping_with_string_icon | Icon can be plain string | Icon field type handling (string vs dict) | _build_icon_mapping | pipe_instance, frontend_data dict | icon_mapping["test/model"] == "https://example.com/icon.png" | Low | Yes | Tests icon can be string URL instead of dict |  |
| test_build_icon_mapping_item_level_icon_fallback | Falls back to item-level icon | Icon fallback hierarchy | _build_icon_mapping | pipe_instance, frontend_data dict | icon_mapping["test/model"] == "https://example.com/fallback.png" | Low | Yes | Tests fallback to item-level icon when endpoint icon missing |  |
| test_build_icon_mapping_item_level_string_icon | Item-level icon can be string | Item-level icon type handling | _build_icon_mapping | pipe_instance, frontend_data dict | icon_mapping["test/model"] == "https://example.com/string-icon.png" | Low | Yes | Tests item-level icon as string |  |
| test_build_icon_mapping_favicon_from_base_url | Uses favicon service from baseUrl | Favicon URL generation from baseUrl | _build_icon_mapping | pipe_instance, frontend_data dict | "gstatic.com/faviconV2" in icon_mapping, "api.provider.com" in icon_mapping | Low | Yes | Tests favicon service URL generation from baseUrl |  |
| test_build_icon_mapping_favicon_from_status_page_url | Uses favicon service from statusPageUrl | Favicon URL generation from statusPageUrl | _build_icon_mapping | pipe_instance, frontend_data dict | "status.provider.com" in icon_mapping | Low | Yes | Tests favicon service URL from statusPageUrl when baseUrl missing |  |
| test_build_icon_mapping_favicon_from_data_policy_urls | Uses favicon service from data policy URLs | Favicon URL generation from data policy URLs | _build_icon_mapping | pipe_instance, frontend_data dict | Both termsOfServiceURL and privacyPolicyURL tested | Low | Yes | Tests favicon service from termsOfServiceURL and privacyPolicyURL |  |
| test_build_icon_mapping_skips_invalid_entries | Skips invalid entries | Input validation for icon mapping | _build_icon_mapping | pipe_instance, frontend_data with invalid entries | len(icon_mapping) == 1, only "valid/model" present | Low | Yes | Tests skipping None, non-dict, empty/invalid slugs |  |
| test_build_icon_mapping_data_image_url_passthrough | Data URLs pass through unchanged | Data URL handling | _build_icon_mapping | pipe_instance, frontend_data dict | icon_mapping["test/model"] == "data:image/png;base64,ABC123" | Low | Yes | Tests data URLs are not modified |  |
| test_build_icon_mapping_skips_no_icon_or_fallback | Skips models without icon source | Icon availability checking | _build_icon_mapping | pipe_instance, frontend_data dict | "test/model" not in icon_mapping | Low | Yes | Tests models without any icon source are skipped |  |
| test_build_web_search_support_mapping_empty_cases | Returns empty dict for invalid input | Input validation for web search mapping | _build_web_search_support_mapping | pipe_instance | Multiple empty dict assertions | Low | Yes | Tests None, non-dict, empty dict, non-list data |  |
| test_build_web_search_support_mapping_skips_invalid_entries | Skips invalid entries | Entry validation for web search mapping | _build_web_search_support_mapping | pipe_instance, frontend_data with invalid entries | mapping == {} | Low | Yes | Tests skipping None, string, invalid slugs, non-dict endpoints |  |
| test_build_web_search_support_mapping_web_search_options_parameter | Detects via supported_parameters | Web search detection via parameters | _build_web_search_support_mapping | pipe_instance, frontend_data dict | mapping == {"test/model": True} | Medium | Yes | Tests detection via web_search_options in supported_parameters | Verify OpenRouter API changes |
| test_build_web_search_support_mapping_whitespace_handling | Handles whitespace in parameters | Parameter string trimming | _build_web_search_support_mapping | pipe_instance, frontend_data dict | mapping == {"test/model": True} | Low | Yes | Tests whitespace handling in web_search_options |  |
| test_build_web_search_support_mapping_supported_parameters_not_list | Handles non-list supported_parameters | Type safety for supported_parameters | _build_web_search_support_mapping | pipe_instance, frontend_data dict | mapping == {"test/model": True} from features | Low | Yes | Tests graceful handling when supported_parameters not a list |  |
| test_build_web_search_support_mapping_non_string_parameter_entries | Skips non-string parameter entries | Parameter entry type validation | _build_web_search_support_mapping | pipe_instance, frontend_data dict | mapping == {} | Low | Yes | Tests skipping int, None, dict entries in parameters |  |
| test_build_web_search_support_mapping_features_not_dict | Handles non-dict features | Type safety for features field | _build_web_search_support_mapping | pipe_instance, frontend_data dict | mapping == {"test/model": True} from pricing | Low | Yes | Tests detection falls through to pricing when features not dict |  |
| test_build_web_search_support_mapping_pricing_not_dict | Handles non-dict pricing | Type safety for pricing field | _build_web_search_support_mapping | pipe_instance, frontend_data dict | mapping == {"test/model": True} from features | Low | Yes | Tests detection from features when pricing not dict |  |
| test_fetch_frontend_model_catalog_success | Successfully fetches catalog | HTTP fetch success path | _fetch_frontend_model_catalog | pipe_instance_async, aioresponses | result == {"data": [{"slug": "test/model"}]} | Medium | Yes | Tests successful fetch from frontend/models endpoint | Monitor endpoint stability |
| test_fetch_frontend_model_catalog_http_error | Returns None on HTTP errors | HTTP error handling | _fetch_frontend_model_catalog | pipe_instance_async, aioresponses (500 status) | result is None | Low | Yes | Tests 500 error returns None and logs debug |  |
| test_fetch_frontend_model_catalog_invalid_json_type | Returns None for non-dict JSON | Response type validation | _fetch_frontend_model_catalog | pipe_instance_async, aioresponses (list payload) | result is None | Low | Yes | Tests list response returns None (expects dict) |  |
| test_fetch_frontend_model_catalog_connection_error | Returns None on connection errors | Connection error handling | _fetch_frontend_model_catalog | pipe_instance_async, aioresponses (exception) | result is None | Low | Yes | Tests connection failures are handled gracefully |  |
| test_build_maker_profile_image_mapping_empty_input | Returns empty dict for empty input | Empty input handling | _build_maker_profile_image_mapping | pipe_instance_async | result == {} for empty list and None/empty/whitespace strings | Low | Yes | Tests empty maker ID list returns empty dict |  |
| test_build_maker_profile_image_mapping_deduplicates_makers | Deduplicates maker IDs | Deduplication logic | _build_maker_profile_image_mapping | pipe_instance_async, mock_fetch | call_count == 2, len(result) == 2 | Low | Yes | Tests duplicate maker IDs only fetched once |  |
| test_build_maker_profile_image_mapping_handles_none_results | Filters out None results | None result filtering | _build_maker_profile_image_mapping | pipe_instance_async, mock_fetch | "openai" in result, "anthropic" not in result | Low | Yes | Tests makers with None URLs are excluded |  |
| test_maybe_schedule_model_metadata_sync_no_valves_enabled | Does not schedule when valves disabled | Scheduling guard conditions | maybe_schedule_model_metadata_sync | pipe_instance, all valves disabled | _model_metadata_sync_task is None | Low | Yes | Tests no scheduling when all relevant valves disabled |  |
| test_maybe_schedule_model_metadata_sync_empty_models | Does not schedule for empty models | Empty models handling | maybe_schedule_model_metadata_sync | pipe_instance | _model_metadata_sync_task is None | Low | Yes | Tests no scheduling when models list empty |  |
| test_maybe_schedule_model_metadata_sync_same_key_no_reschedule | Does not reschedule with same key | Idempotency of scheduling | maybe_schedule_model_metadata_sync | pipe_instance, pre-set sync_key | _model_metadata_sync_task is None | Low | Yes | Tests no reschedule when sync key unchanged |  |
| test_maybe_schedule_model_metadata_sync_running_task_no_reschedule | Does not reschedule when task running | Concurrent task prevention | maybe_schedule_model_metadata_sync | pipe_instance, mock running task | _model_metadata_sync_key is None | Low | Yes | Tests running task prevents rescheduling |  |
| test_sync_model_metadata_returns_early_no_valves | Returns early when valves disabled | Early return optimization | _sync_model_metadata_to_owui | pipe_instance_async, all valves disabled | No exception raised | Low | Yes | Tests early return without error when valves disabled |  |
| test_sync_model_metadata_returns_early_empty_models | Returns early for empty models | Empty models guard | _sync_model_metadata_to_owui | pipe_instance_async | No exception raised | Low | Yes | Tests early return for empty models list |  |
| test_sync_model_metadata_returns_early_no_pipe_identifier | Returns early without pipe identifier | Pipe identifier validation | _sync_model_metadata_to_owui | pipe_instance_async | No exception raised | Low | Yes | Tests early return when pipe_identifier empty |  |
| test_sync_model_metadata_skips_model_without_valid_id | Skips models with invalid id | Model ID validation | _sync_model_metadata_to_owui | pipe_instance_async, patch run_in_threadpool | update_mock.call_count == 0 | Low | Yes | Tests skipping None, empty, non-string IDs |  |
| test_sync_model_metadata_uses_id_as_name_when_missing | Uses id as name fallback | Name fallback logic | _sync_model_metadata_to_owui | pipe_instance_async, patch run_in_threadpool | args[1] == "test.model" | Low | Yes | Tests id used as name when name None |  |
| test_sync_model_metadata_ors_filter_warning_not_installed | Logs warning when filter not installed | Filter installation warning | _sync_model_metadata_to_owui | pipe_instance_async, patch logger.warning | mock_warning.assert_called_once with expected message | Low | Yes | Tests warning when AUTO_ATTACH_ORS_FILTER enabled but filter missing |  |
| test_sync_model_metadata_direct_uploads_filter_warning | Logs warning for direct uploads filter | Direct uploads filter warning | _sync_model_metadata_to_owui | pipe_instance_async, patch logger.warning | mock_warning.assert_called_once with expected message | Low | Yes | Tests warning when AUTO_ATTACH_DIRECT_UPLOADS_FILTER enabled but filter missing |  |
| test_sync_model_metadata_logs_supported_model_counts | Logs info about supported models | Info logging for filters | _sync_model_metadata_to_owui | pipe_instance_async, AsyncMock catalog, patch logger.info | "Auto-attaching OpenRouter Search filter" in log | Low | Yes | Tests info log about filter attachment |  |
| test_sync_model_metadata_handles_update_exception | Handles update exceptions gracefully | Exception handling in update loop | _sync_model_metadata_to_owui | pipe_instance_async, Mock with side_effect exception | No exception raised | Low | Yes | Tests DB error doesn't crash sync |  |
| test_sync_model_metadata_ensure_filter_exception_handling | Handles filter ensure exceptions | Filter installation exception handling | _sync_model_metadata_to_owui | pipe_instance_async, Mock with side_effect exception | No exception raised | Low | Yes | Tests filter install failure doesn't crash |  |
| test_update_or_insert_empty_model_id_returns_early | Returns early for empty model_id | Model ID validation | _update_or_insert_model_with_metadata | pipe_instance, patch Models | get_model_by_id not called | Low | Yes | Tests empty and whitespace-only IDs return early |  |
| test_update_or_insert_uses_model_id_as_name_fallback | Uses model_id as name fallback | Name fallback for insert | _update_or_insert_model_with_metadata | pipe_instance, patch Models/ModelForm/etc | inserted_form.name == model_id | Low | Yes | Tests model_id used when name empty |  |
| test_update_or_insert_new_model_with_capabilities | Inserts new model with capabilities | New model insertion | _update_or_insert_model_with_metadata | pipe_instance, patch Models/ModelForm/etc | insert_mock called, capabilities/image verified | Low | Yes | Tests inserting new model with vision, web_search |  |
| test_update_or_insert_new_model_skips_when_no_metadata | Skips insert when no metadata | Metadata requirement check | _update_or_insert_model_with_metadata | pipe_instance, patch Models | insert_mock not called | Low | Yes | Tests no insert when no capabilities or image |  |
| test_update_or_insert_new_model_access_control_admins | Sets admins-only access control | Access control for new models (admins) | _update_or_insert_model_with_metadata | pipe_instance, patch Models/ModelForm/etc | inserted_form.access_control == {} | Low | Yes | Tests NEW_MODEL_ACCESS_CONTROL="admins" sets {} |  |
| test_update_or_insert_new_model_access_control_all | Sets all-users access control | Access control for new models (all) | _update_or_insert_model_with_metadata | pipe_instance, patch Models/ModelForm/etc | inserted_form.access_control is None | Low | Yes | Tests NEW_MODEL_ACCESS_CONTROL="all" sets None |  |
| test_update_existing_model_merges_capabilities | Merges capabilities with existing | Capability merging logic | _update_or_insert_model_with_metadata | pipe_instance, patch Models/ModelForm/etc | vision True, web_search True, file_upload True | Low | Yes | Tests merging: vision overwritten, web_search added, file_upload preserved |  |
| test_update_existing_model_no_changes_skips_update | Skips update when no changes | Change detection optimization | _update_or_insert_model_with_metadata | pipe_instance, patch Models | update_mock not called | Low | Yes | Tests no update when capabilities match existing |  |
| test_update_existing_model_updates_profile_image | Updates profile image when different | Profile image update | _update_or_insert_model_with_metadata | pipe_instance, patch Models/ModelForm/etc | meta["profile_image_url"] == new value | Low | Yes | Tests profile image updated when changed |  |
| test_update_existing_model_updates_openrouter_pipe_capabilities | Updates openrouter_pipe capabilities | openrouter_pipe.capabilities update | _update_or_insert_model_with_metadata | pipe_instance, patch Models/ModelForm/etc | meta["openrouter_pipe"]["capabilities"] verified | Low | Yes | Tests setting openrouter_pipe.capabilities |  |
| test_update_existing_model_filter_id_migration | Migrates filter IDs when changed | Filter ID migration logic | _update_or_insert_model_with_metadata | pipe_instance, patch Models/ModelForm/etc | old filter removed, new filter added | Low | Yes | Tests migration from old_openrouter_search to new |  |
| test_update_existing_model_filter_removal_when_unsupported | Removes filter when unsupported | Filter removal for unsupported models | _update_or_insert_model_with_metadata | pipe_instance, patch Models/ModelForm/etc | openrouter_search removed, other_filter preserved | Low | Yes | Tests filter removed when filter_supported=False |  |
| test_update_existing_model_direct_uploads_filter_with_previous_id | Handles direct uploads filter migration | Direct uploads filter ID migration | _update_or_insert_model_with_metadata | pipe_instance, patch Models/ModelForm/etc | old filter removed, new filter added, metadata updated | Low | Yes | Tests direct uploads filter migration |  |
| test_update_existing_model_default_filter_migration | Migrates default filter IDs | Default filter ID migration | _update_or_insert_model_with_metadata | pipe_instance, patch Models/ModelForm/etc | new filter in defaultFilterIds | Low | Yes | Tests defaultFilterIds migrated when filter changes |  |
| test_update_existing_model_default_filter_not_attached_skips | Skips default filter when not attached | Default filter attachment guard | _update_or_insert_model_with_metadata | pipe_instance, patch Models | update_mock not called | Low | Yes | Tests default filter not added if filter not in filterIds |  |
| test_insert_new_model_with_filters | Inserts new model with filters | New model with filter attachments | _update_or_insert_model_with_metadata | pipe_instance, patch Models/ModelForm/etc | both filters in filterIds, search in defaultFilterIds | Low | Yes | Tests inserting model with ORS and direct uploads filters |  |
| test_normalize_filter_ids_handles_non_list | Handles non-list filterIds | filterIds type normalization | _update_or_insert_model_with_metadata | pipe_instance, patch Models/ModelForm/etc | meta["filterIds"] == ["openrouter_search"] | Low | Yes | Tests filterIds normalized from string to list |  |
| test_normalize_filter_ids_filters_non_strings | Filters non-string entries | filterIds entry type validation | _update_or_insert_model_with_metadata | pipe_instance, patch Models/ModelForm/etc | only string filters remain | Low | Yes | Tests filtering out int, None, empty string from filterIds |  |
| test_dedupe_preserves_order | Deduplication preserves order | filterIds deduplication | _update_or_insert_model_with_metadata | pipe_instance, patch Models/ModelForm/etc | filterIds == ["filter_a", "filter_b", "filter_c", "openrouter_search"] | Low | Yes | Tests duplicates removed while preserving order |  |
| test_existing_model_null_meta_handled | Handles None meta gracefully | None meta handling | _update_or_insert_model_with_metadata | pipe_instance, patch Models/ModelForm/etc | update_mock called once | Low | Yes | Tests existing model with meta=None doesn't crash |  |
| test_sync_model_metadata_direct_uploads_logs_supported_count | Logs direct uploads filter info | Direct uploads filter logging | _sync_model_metadata_to_owui | pipe_instance_async, patch logger.info | "Auto-attaching OpenRouter Direct Uploads filter" in log | Low | Yes | Tests info log for direct uploads filter |  |
| test_sync_model_metadata_with_images_and_maker_mapping | Tests full image sync flow | Image sync with icon mapping | _sync_model_metadata_to_owui | pipe_instance_async, AsyncMock catalog/fetch | profile_image_url == data URL | Medium | Yes | Tests full flow: fetch catalog, build mapping, fetch image | Monitor image fetch stability |
| test_sync_model_metadata_maker_image_fallback | Tests maker image fallback | Maker image fallback logic | _sync_model_metadata_to_owui | pipe_instance_async, AsyncMock catalog/fetch | profile_image_url from maker mapping | Low | Yes | Tests fallback to maker image when model icon not found |  |
| test_sync_model_metadata_skips_model_without_original_id_for_images | Skips models without original_id | original_id requirement for images | _sync_model_metadata_to_owui | pipe_instance_async, AsyncMock catalog/fetch | profile_image_url is None | Low | Yes | Tests image sync skipped when original_id missing |  |
| test_update_existing_model_with_description | Updates description | Description update | _update_or_insert_model_with_metadata | pipe_instance, patch Models/ModelForm/etc | meta["description"] == "New description" | Low | Yes | Tests description updated when update_descriptions=True |  |
| test_update_existing_model_description_no_change_skips_update | Skips update when description unchanged | Description change detection | _update_or_insert_model_with_metadata | pipe_instance, patch Models | update_mock not called | Low | Yes | Tests no update when description matches existing |  |
| test_insert_new_model_with_description | Inserts model with description | New model description | _update_or_insert_model_with_metadata | pipe_instance, patch Models/ModelForm/etc | meta["description"] == "Model description" | Low | Yes | Tests inserting new model with description |  |
| test_insert_new_model_with_openrouter_pipe_capabilities | Inserts with openrouter_pipe capabilities | openrouter_pipe capabilities on insert | _update_or_insert_model_with_metadata | pipe_instance, patch Models/ModelForm/etc | meta["openrouter_pipe"]["capabilities"] verified | Low | Yes | Tests inserting new model with openrouter_pipe.capabilities |  |
| test_update_existing_model_with_existing_params | Preserves existing params | Params preservation | _update_or_insert_model_with_metadata | pipe_instance, patch Models/ModelForm/etc | params == existing params | Low | Yes | Tests existing params not overwritten |  |
| test_update_existing_model_same_image_skips_update | Skips update when image unchanged | Image change detection | _update_or_insert_model_with_metadata | pipe_instance, patch Models | update_mock not called | Low | Yes | Tests no update when profile_image_url matches |  |
| test_update_existing_model_preserves_openrouter_pipe_meta | Preserves openrouter_pipe metadata | openrouter_pipe meta preservation | _update_or_insert_model_with_metadata | pipe_instance, patch Models/ModelForm/etc | existing_key preserved, capabilities added | Low | Yes | Tests existing openrouter_pipe keys preserved when adding new ones |  |
| test_existing_model_with_none_params_handled | Handles None params gracefully | None params handling | _update_or_insert_model_with_metadata | pipe_instance, patch Models/ModelForm/etc | update_mock called once | Low | Yes | Tests existing model with params=None doesn't crash |  |
| test_sync_model_metadata_direct_uploads_filter_exception_handling | Handles direct uploads filter exceptions | Direct uploads filter exception handling | _sync_model_metadata_to_owui | pipe_instance_async, Mock with side_effect exception | No exception raised | Low | Yes | Tests direct uploads filter install failure doesn't crash |  |
| test_build_icon_mapping_success | Successfully builds icon mapping | Icon mapping from multiple sources | _build_icon_mapping | pipe_instance | len == 3, URLs verified | Low | Yes | Tests absolute URL, relative URL, and bare path icons |  |
| test_build_icon_mapping_empty | Returns empty for invalid input | Empty input handling | _build_icon_mapping | pipe_instance | Multiple empty dict assertions | Low | Yes | Tests None, empty data, empty dict |  |
| test_extract_openrouter_og_image | Extracts og:image from HTML | HTML parsing for og:image | _extract_openrouter_og_image (static) | HTML string | Extracted URL matches | Low | Yes | Tests extracting OpenGraph image from HTML |  |
| test_guess_image_mime_type_svg_and_png | Guesses MIME types correctly | MIME type detection | _guess_image_mime_type (static) | URL, content_type, data | MIME types match expected | Low | Yes | Tests SVG and PNG MIME type detection from URL, content_type, data |  |
| test_build_icon_mapping_uses_first_provider_icon | Uses first icon for duplicates | Duplicate slug handling | _build_icon_mapping | pipe_instance | icon == first URL | Low | Yes | Tests first icon used when duplicate slugs |  |
| test_build_web_search_support_mapping_detects_multiple_signals | Detects web search via multiple signals | Multi-signal web search detection | _build_web_search_support_mapping | pipe_instance | 3 models detected as True | Medium | Yes | Tests features.supports_native_web_search, web_search_options param, pricing.web_search | Verify signal priority |
| test_build_web_search_support_mapping_unions_duplicates | Unions duplicate model entries | Duplicate slug web search detection | _build_web_search_support_mapping | pipe_instance | dup/model == True | Low | Yes | Tests web search detected when any duplicate entry supports it |  |
| test_sync_model_metadata_prefixes_pipe_id_and_prefers_icon_mapping | Prefixes pipe ID and uses icon mapping | Full sync with pipe ID prefixing | _sync_model_metadata_to_owui | pipe_instance_async, AsyncMock catalog/fetch, patch run_in_threadpool | args[0] has pipe prefix, capabilities merged, image present | Medium | Yes | Tests full sync: pipe prefix, icon mapping, web_search merge | Monitor integration stability |
| test_sync_model_metadata_sets_web_search_from_frontend | Sets web search from frontend data | Web search capability merge | _sync_model_metadata_to_owui | pipe_instance_async, AsyncMock catalog, patch run_in_threadpool | args[2] == {"web_search": True} | Medium | Yes | Tests web_search set to True from frontend even when False in model | Verify override logic |
| test_sync_model_metadata_falls_back_to_maker_image_mapping | Falls back to maker image | Maker image fallback flow | _sync_model_metadata_to_owui | pipe_instance_async, AsyncMock catalog/fetch, patch run_in_threadpool | image from maker mapping | Low | Yes | Tests maker image used when icon mapping empty |  |
| test_sync_model_metadata_includes_description_when_enabled | Includes description when enabled | Description sync when enabled | _sync_model_metadata_to_owui | pipe_instance_async, patch _lookup_spec/run_in_threadpool | update_descriptions=True, description from catalog | Low | Yes | Tests description included when UPDATE_MODEL_DESCRIPTIONS=True |  |
| test_sync_model_metadata_skips_description_when_disabled | Skips description when disabled | Description sync when disabled | _sync_model_metadata_to_owui | pipe_instance_async, patch _lookup_spec/run_in_threadpool | update_descriptions=False, description=None | Low | Yes | Tests description not included when UPDATE_MODEL_DESCRIPTIONS=False |  |
| test_basic_qualification_with_valid_inputs | Basic model qualification | Pipe ID prefixing | _qualify_model_for_pipe | pipe_instance | result == "mypipe.gpt-4" | Low | Yes | Tests basic qualification with pipe.model format |  |
| test_qualification_with_normalized_model_id | Normalizes model IDs | Model ID normalization before qualification | _qualify_model_for_pipe | pipe_instance | result == "mypipe.openai.gpt-4" | Low | Yes | Tests / replaced with . during normalization |  |
| test_already_qualified_model_returns_as_is | Idempotent qualification | Already-qualified model handling | _qualify_model_for_pipe | pipe_instance | result == "mypipe.gpt-4" | Low | Yes | Tests already-qualified models not double-qualified |  |
| test_no_pipe_identifier_returns_model_id | Handles empty pipe identifier | Empty pipe_identifier handling | _qualify_model_for_pipe | pipe_instance | result == "gpt-4" for None/"" | Low | Yes | Tests None and empty string pipe_identifier |  |
| test_none_model_id_returns_none | Handles None model_id | None model_id handling | _qualify_model_for_pipe | pipe_instance | result is None | Low | Yes | Tests None model_id returns None |  |
| test_non_string_model_id_returns_none | Handles non-string model_id | Type validation for model_id | _qualify_model_for_pipe | pipe_instance | result is None for int/list/dict | Low | Yes | Tests non-string model IDs return None |  |
| test_empty_string_model_id_returns_none | Handles empty model_id | Empty/whitespace model_id handling | _qualify_model_for_pipe | pipe_instance | result is None for empty/whitespace | Low | Yes | Tests empty string and whitespace return None |  |
| test_model_id_with_leading_trailing_whitespace | Trims whitespace | Whitespace trimming | _qualify_model_for_pipe | pipe_instance | result == "mypipe.gpt-4" | Low | Yes | Tests leading/trailing whitespace trimmed |  |
| test_complex_model_ids_with_slashes | Normalizes slashes to dots | Slash normalization | _qualify_model_for_pipe | pipe_instance | result == "mypipe.anthropic.claude-3-opus" | Low | Yes | Tests / normalized to . |  |
| test_model_ids_with_dates_are_normalized | Strips date suffixes | Date suffix normalization | _qualify_model_for_pipe | pipe_instance | "2024" not in result | Low | Yes | Tests date patterns stripped by normalization |  |
| test_case_normalization | Lowercases model IDs | Case normalization | _qualify_model_for_pipe | pipe_instance | result == "mypipe.gpt-4" | Low | Yes | Tests uppercase converted to lowercase |  |
| test_pipe_identifier_with_special_characters | Handles special characters in pipe ID | Pipe identifier character handling | _qualify_model_for_pipe | pipe_instance | Hyphens, underscores preserved | Low | Yes | Tests alphanumeric, hyphens, underscores work |  |
| test_multiple_dots_in_qualified_id | Handles multi-dot qualified IDs | Multi-dot ID handling | _qualify_model_for_pipe | pipe_instance | result == "mypipe.provider.model-v1" | Low | Yes | Tests already-qualified IDs with multiple dots |  |
| test_normalization_fallback_behavior | Falls back when normalization fails | Normalization fallback | _qualify_model_for_pipe | pipe_instance | result not None, starts with "mypipe." | Low | Yes | Tests fallback to trimmed value if normalization returns None |  |
| test_preserves_hyphenated_model_names | Preserves hyphens in names | Hyphen preservation | _qualify_model_for_pipe | pipe_instance | "claude-3-opus" in result | Low | Yes | Tests hyphens in model names preserved |  |
| test_prefix_detection_is_exact | Requires exact prefix match | Prefix detection precision | _qualify_model_for_pipe | pipe_instance | "mygpt-4" qualified, "my.gpt-4" not | Low | Yes | Tests prefix requires dot separator |  |
| test_real_world_openrouter_model_ids | Handles real OpenRouter IDs | Real-world model ID formats | _qualify_model_for_pipe | pipe_instance | openai/gpt-4-turbo, anthropic/claude with dates | Low | Yes | Tests realistic OpenRouter model ID formats |  |
| test_unicode_characters_in_model_id | Preserves unicode characters | Unicode handling | _qualify_model_for_pipe | pipe_instance | result not None, contains unicode | Low | Yes | Tests unicode characters preserved |  |
| test_very_long_model_id | Handles long model IDs | Long string handling | _qualify_model_for_pipe | pipe_instance | result not None, len > 200 | Low | Yes | Tests 200-character model ID |  |
| test_qualification_is_idempotent | Idempotent qualification | Idempotency verification | _qualify_model_for_pipe | pipe_instance | first == second == "mypipe.gpt-4" | Low | Yes | Tests qualifying twice yields same result |  |
| test_disable_model_metadata_sync_skips_all_updates | Skips all updates when disabled | disable_model_metadata_sync flag | _update_or_insert_model_with_metadata | pipe_instance, patch Models | update_mock.call_count == 0 | Low | Yes | Tests disable_model_metadata_sync in params skips all updates |  |
| test_disable_capability_updates_preserves_existing_caps | Preserves capabilities when disabled | disable_capability_updates flag | _update_or_insert_model_with_metadata | pipe_instance, patch Models/ModelForm | capabilities unchanged, filters still updated | Low | Yes | Tests disable_capability_updates preserves existing capabilities |  |
| test_disable_image_updates_skips_profile_image_changes | Skips image updates when disabled | disable_image_updates flag | _update_or_insert_model_with_metadata | pipe_instance, patch Models | update_mock.call_count == 0 | Low | Yes | Tests disable_image_updates in params prevents image changes |  |
| test_disable_direct_uploads_auto_attach_skips_filter_ids | Skips direct uploads filter when disabled | disable_direct_uploads_auto_attach flag | _update_or_insert_model_with_metadata | pipe_instance, patch Models | update_mock.call_count == 0 | Low | Yes | Tests disable_direct_uploads_auto_attach prevents filter attachment |  |
| test_description_updates_when_enabled | Updates description when enabled | Description update flag | _update_or_insert_model_with_metadata | pipe_instance, patch Models/ModelForm | meta["description"] == "Example description" | Low | Yes | Tests description updated when update_descriptions=True |  |
| test_disable_description_updates_prevents_overwrites | Prevents description overwrites when disabled | disable_description_updates flag (top-level) | _update_or_insert_model_with_metadata | pipe_instance, patch Models | update_mock.call_count == 0 | Low | Yes | Tests disable_description_updates in params prevents overwrites |  |
| test_disable_description_updates_namespaced_in_openrouter_pipe_params | Respects namespaced disable flag | disable_description_updates in openrouter_pipe | _update_or_insert_model_with_metadata | pipe_instance, patch Models | update_mock.call_count == 0 | Low | Yes | Tests params.openrouter_pipe.disable_description_updates works |  |
| test_disable_description_updates_in_custom_params | Respects custom_params disable flag | disable_description_updates in custom_params | _update_or_insert_model_with_metadata | pipe_instance, patch Models | update_mock.call_count == 0 | Low | Yes | Tests params.custom_params.disable_description_updates works |  |
| test_model_fallback_csv_to_models_array | Converts CSV to models array | model_fallback CSV parsing | _apply_model_fallback_to_payload | None | models array correct, model_fallback removed | Low | Yes | Tests CSV string parsed, deduplicated, model_fallback removed |  |
| test_model_fallback_merges_with_existing_models_list | Merges with existing models | model_fallback merge logic | _apply_model_fallback_to_payload | None | models array merged and deduplicated | Low | Yes | Tests model_fallback CSV merged with existing models list |  |
| test_capabilities_detects_modalities_and_pricing | Derives capabilities from modalities | Capability derivation | _derive_capabilities (OpenRouterModelRegistry) | None | vision, file_upload, image_generation, web_search, etc. verified | Medium | Yes | Tests capability flags derived from architecture and pricing | Monitor OpenRouter schema |
| test_capabilities_zero_web_search_is_disabled | Treats "0" web_search as disabled | Web search pricing interpretation | _derive_capabilities (OpenRouterModelRegistry) | None | web_search is False | Low | Yes | Tests "0" in pricing.web_search means disabled |  |
| test_model_family_capabilities_returns_copy_and_defaults | Returns copy and defaults | ModelFamily.capabilities behavior | ModelFamily.capabilities | None | Returns copy (mutation doesn't affect original), unknown models return {} | Low | Yes | Tests capabilities returns defensive copy and defaults |  |


## `tests/test_multimodal.py`

| Test Name | Description | What It Tests | Code Under Test | Mocks/Fixtures | Assertions | Drift Risk | Check Done | Codex Notes | Codex TODO |
|-----------|-------------|---------------|-----------------|----------------|------------|------------|------------|-------------|------------|
| TestGuessImageMimeType::test_returns_image_content_type_as_is | If content-type starts with image/, return it directly | MIME type passthrough for image types | `_guess_image_mime_type` | None | result == "image/png" | Low | [ ] | Tests direct content-type passthrough | |
| TestGuessImageMimeType::test_handles_content_type_with_charset | Should strip charset from content-type | Charset stripping from MIME type | `_guess_image_mime_type` | None | result == "image/jpeg" | Low | [ ] | Verifies charset handling | |
| TestGuessImageMimeType::test_detects_png_magic_bytes | Should detect PNG from magic bytes | PNG magic byte detection | `_guess_image_mime_type` | None | result == "image/png" | Low | [ ] | Tests PNG header detection | |
| TestGuessImageMimeType::test_detects_jpeg_magic_bytes | Should detect JPEG from magic bytes | JPEG magic byte detection | `_guess_image_mime_type` | None | result == "image/jpeg" | Low | [ ] | Tests JPEG header detection | |
| TestGuessImageMimeType::test_detects_gif87a_magic_bytes | Should detect GIF87a from magic bytes | GIF87a magic byte detection | `_guess_image_mime_type` | None | result == "image/gif" | Low | [ ] | Tests GIF87a header detection | |
| TestGuessImageMimeType::test_detects_gif89a_magic_bytes | Should detect GIF89a from magic bytes | GIF89a magic byte detection | `_guess_image_mime_type` | None | result == "image/gif" | Low | [ ] | Tests GIF89a header detection | |
| TestGuessImageMimeType::test_detects_webp_magic_bytes | Should detect WebP from RIFF header with WEBP signature | WebP magic byte detection | `_guess_image_mime_type` | None | result == "image/webp" | Low | [ ] | Tests WebP header detection | |
| TestGuessImageMimeType::test_detects_ico_magic_bytes | Should detect ICO from magic bytes | ICO magic byte detection | `_guess_image_mime_type` | None | result == "image/x-icon" | Low | [ ] | Tests ICO header detection | |
| TestGuessImageMimeType::test_detects_cur_magic_bytes | Should detect CUR (cursor) from magic bytes | CUR magic byte detection | `_guess_image_mime_type` | None | result == "image/x-icon" | Low | [ ] | Tests CUR header detection | |
| TestGuessImageMimeType::test_detects_svg_from_xml_declaration | Should detect SVG from XML declaration with svg tag | SVG XML detection | `_guess_image_mime_type` | None | result == "image/svg+xml" | Low | [ ] | Tests SVG XML detection | |
| TestGuessImageMimeType::test_detects_svg_from_svg_tag | Should detect SVG from opening svg tag | SVG tag detection | `_guess_image_mime_type` | None | result == "image/svg+xml" | Low | [ ] | Tests SVG tag detection | |
| TestGuessImageMimeType::test_extension_fallback_for_svg | Should use .svg extension fallback when content-type is octet-stream | SVG extension fallback | `_guess_image_mime_type` | None | result == "image/svg+xml" | Low | [ ] | Tests extension fallback | |
| TestGuessImageMimeType::test_extension_fallback_for_png | Should use .png extension fallback | PNG extension fallback | `_guess_image_mime_type` | None | result == "image/png" | Low | [ ] | Tests extension fallback | |
| TestGuessImageMimeType::test_extension_fallback_for_jpg | Should use .jpg extension fallback | JPG extension fallback | `_guess_image_mime_type` | None | result == "image/jpeg" | Low | [ ] | Tests extension fallback | |
| TestGuessImageMimeType::test_extension_fallback_for_jpeg | Should use .jpeg extension fallback | JPEG extension fallback | `_guess_image_mime_type` | None | result == "image/jpeg" | Low | [ ] | Tests extension fallback | |
| TestGuessImageMimeType::test_extension_fallback_for_webp | Should use .webp extension fallback | WebP extension fallback | `_guess_image_mime_type` | None | result == "image/webp" | Low | [ ] | Tests extension fallback | |
| TestGuessImageMimeType::test_extension_fallback_for_gif | Should use .gif extension fallback | GIF extension fallback | `_guess_image_mime_type` | None | result == "image/gif" | Low | [ ] | Tests extension fallback | |
| TestGuessImageMimeType::test_extension_fallback_for_ico | Should use .ico extension fallback | ICO extension fallback | `_guess_image_mime_type` | None | result == "image/x-icon" | Low | [ ] | Tests extension fallback | |
| TestGuessImageMimeType::test_extension_fallback_for_cur | Should use .cur extension fallback | CUR extension fallback | `_guess_image_mime_type` | None | result == "image/x-icon" | Low | [ ] | Tests extension fallback | |
| TestGuessImageMimeType::test_no_extension_fallback_when_content_type_provided | Should not use extension fallback if content-type is not octet-stream | Extension fallback skip for non-octet-stream | `_guess_image_mime_type` | None | result is None | Low | [ ] | Verifies no fallback when content-type provided | |
| TestGuessImageMimeType::test_returns_none_for_unknown_format | Should return None when format cannot be determined | Unknown format handling | `_guess_image_mime_type` | None | result is None | Low | [ ] | Tests unknown format return | |
| TestExtractOpenrouterOgImage::test_extracts_og_image_property_first | Should extract og:image with property before content | OpenGraph image extraction | `_extract_openrouter_og_image` | None | result == expected URL | Low | [ ] | Tests og:image extraction | |
| TestExtractOpenrouterOgImage::test_extracts_og_image_content_first | Should extract og:image with content before property | OpenGraph image extraction alternate order | `_extract_openrouter_og_image` | None | result == expected URL | Low | [ ] | Tests og:image extraction | |
| TestExtractOpenrouterOgImage::test_extracts_twitter_image | Should extract twitter:image if og:image not found | Twitter image extraction fallback | `_extract_openrouter_og_image` | None | result == expected URL | Low | [ ] | Tests twitter:image fallback | |
| TestExtractOpenrouterOgImage::test_extracts_twitter_image_content_first | Should extract twitter:image with content before name | Twitter image extraction alternate order | `_extract_openrouter_og_image` | None | result == expected URL | Low | [ ] | Tests twitter:image extraction | |
| TestExtractOpenrouterOgImage::test_returns_none_for_empty_string | Should return None for empty string | Empty string handling | `_extract_openrouter_og_image` | None | result is None | Low | [ ] | Tests empty string return | |
| TestExtractOpenrouterOgImage::test_returns_none_for_none | Should return None for None input | None input handling | `_extract_openrouter_og_image` | None | result is None | Low | [ ] | Tests None input return | |
| TestExtractOpenrouterOgImage::test_returns_none_for_non_string | Should return None for non-string input | Non-string input handling | `_extract_openrouter_og_image` | None | result is None | Low | [ ] | Tests non-string return | |
| TestExtractOpenrouterOgImage::test_returns_none_when_no_image_tags | Should return None when no og:image or twitter:image found | No image tags handling | `_extract_openrouter_og_image` | None | result is None | Low | [ ] | Tests missing tags return | |
| TestExtractInternalFileId::test_extracts_file_id_from_api_url | Should extract file ID from /api/v1/files/ID/content URL | File ID extraction from API URL | `_extract_internal_file_id` | None | result == "abc123-def456" | Low | [ ] | Tests API URL ID extraction | |
| TestExtractInternalFileId::test_extracts_file_id_from_files_url | Should extract file ID from /files/ID URL pattern | File ID extraction from files URL | `_extract_internal_file_id` | None | result == "xyz789" | Low | [ ] | Tests files URL ID extraction | |
| TestExtractInternalFileId::test_returns_none_for_non_string | Should return None for non-string input | Non-string input handling | `_extract_internal_file_id` | None | result is None | Low | [ ] | Tests non-string return | |
| TestExtractInternalFileId::test_returns_none_for_non_matching_url | Should return None when URL doesn't match pattern | Non-matching URL handling | `_extract_internal_file_id` | None | result is None | Low | [ ] | Tests non-matching return | |
| TestIsInternalFileUrl::test_detects_api_v1_files_url | Should detect /api/v1/files/ URLs | API files URL detection | `_is_internal_file_url` | None | result is True | Low | [ ] | Tests API URL detection | |
| TestIsInternalFileUrl::test_detects_files_url | Should detect /files/ URLs | Files URL detection | `_is_internal_file_url` | None | result is True | Low | [ ] | Tests files URL detection | |
| TestIsInternalFileUrl::test_returns_false_for_non_string | Should return False for non-string input | Non-string input handling | `_is_internal_file_url` | None | result is False | Low | [ ] | Tests non-string return | |
| TestIsInternalFileUrl::test_returns_false_for_external_url | Should return False for external URLs | External URL handling | `_is_internal_file_url` | None | result is False | Low | [ ] | Tests external URL return | |
| TestGetFileById::test_returns_none_when_files_is_none | Should return None when Files module is unavailable | Files module unavailability | `Pipe._get_file_by_id` | pipe_instance_async, multimodal_module patch | result is None | Medium | [ ] | Tests Files module check | |
| TestGetFileById::test_returns_none_on_exception | Should return None and log error on exception | Exception handling in file lookup | `Pipe._get_file_by_id` | pipe_instance_async, Mock Files | result is None | Medium | [ ] | Tests exception handling | |
| TestInferFileMimeType::test_normalizes_image_jpg_to_jpeg | Should normalize image/jpg to image/jpeg | MIME type normalization | `Pipe._infer_file_mime_type` | pipe_instance | result == "image/jpeg" | Low | [ ] | Tests MIME normalization | |
| TestInferFileMimeType::test_returns_application_octet_stream_as_default | Should return application/octet-stream when no MIME type found | Default MIME type | `Pipe._infer_file_mime_type` | pipe_instance | result == "application/octet-stream" | Low | [ ] | Tests default MIME type | |
| TestInferFileMimeType::test_uses_meta_dict_content_type | Should extract content_type from meta dict | Meta dict content_type extraction | `Pipe._infer_file_mime_type` | pipe_instance | result == "application/pdf" | Low | [ ] | Tests meta dict extraction | |
| TestInferFileMimeType::test_uses_meta_dict_mimeType | Should extract mimeType from meta dict | Meta dict mimeType extraction | `Pipe._infer_file_mime_type` | pipe_instance | result == "text/plain" | Low | [ ] | Tests meta dict extraction | |
| TestInferFileMimeType::test_prefers_direct_mime_type_attribute | Should prefer mime_type attribute over meta dict | MIME type attribute priority | `Pipe._infer_file_mime_type` | pipe_instance | result == "image/png" | Low | [ ] | Tests attribute priority | |
| TestReadFileRecordBase64::test_raises_when_max_bytes_zero | Should raise ValueError when max_bytes is zero | Zero max_bytes validation | `Pipe._read_file_record_base64` | pipe_instance_async | raises ValueError | Low | [ ] | Tests zero max_bytes | |
| TestReadFileRecordBase64::test_reads_inline_b64_from_data_dict | Should read b64 from data dict | Inline b64 reading | `Pipe._read_file_record_base64` | pipe_instance_async | result == b64_content | Low | [ ] | Tests b64 key reading | |
| TestReadFileRecordBase64::test_reads_inline_base64_from_data_dict | Should read base64 key from data dict | Inline base64 reading | `Pipe._read_file_record_base64` | pipe_instance_async | result == b64_content | Low | [ ] | Tests base64 key reading | |
| TestReadFileRecordBase64::test_reads_inline_data_key_from_data_dict | Should read data key from data dict | Inline data key reading | `Pipe._read_file_record_base64` | pipe_instance_async | result == b64_content | Low | [ ] | Tests data key reading | |
| TestReadFileRecordBase64::test_reads_bytes_from_data_dict | Should read bytes from data dict and encode | Bytes reading and encoding | `Pipe._read_file_record_base64` | pipe_instance_async | result == encoded bytes | Low | [ ] | Tests bytes encoding | |
| TestReadFileRecordBase64::test_reads_bytearray_from_data_dict | Should read bytearray from data dict and encode | Bytearray reading and encoding | `Pipe._read_file_record_base64` | pipe_instance_async | result == encoded bytes | Low | [ ] | Tests bytearray encoding | |
| TestReadFileRecordBase64::test_raises_when_stored_b64_exceeds_limit | Should raise ValueError when stored b64 exceeds size limit | B64 size limit validation | `Pipe._read_file_record_base64` | pipe_instance_async | raises ValueError | Low | [ ] | Tests size limit | |
| TestReadFileRecordBase64::test_reads_from_file_path_attribute | Should read from file path when data dict not available | File path reading | `Pipe._read_file_record_base64` | pipe_instance_async, tmp_path | result == encoded content | Low | [ ] | Tests path reading | |
| TestReadFileRecordBase64::test_reads_from_file_path_attribute_file_path | Should read from file_path attribute | File_path attribute reading | `Pipe._read_file_record_base64` | pipe_instance_async, tmp_path | result == encoded content | Low | [ ] | Tests file_path attribute | |
| TestReadFileRecordBase64::test_reads_from_content_attribute | Should read from content attribute as bytes | Content attribute reading | `Pipe._read_file_record_base64` | pipe_instance_async | result == encoded bytes | Low | [ ] | Tests content attribute | |
| TestReadFileRecordBase64::test_reads_from_blob_attribute | Should read from blob attribute as bytes | Blob attribute reading | `Pipe._read_file_record_base64` | pipe_instance_async | result == encoded bytes | Low | [ ] | Tests blob attribute | |
| TestReadFileRecordBase64::test_returns_none_when_no_data_source | Should return None when file_obj has no readable data | No data source handling | `Pipe._read_file_record_base64` | pipe_instance_async | result is None | Low | [ ] | Tests no data return | |
| TestReadFileRecordBase64::test_raises_when_raw_bytes_exceed_limit | Should raise when raw bytes exceed max_bytes | Raw bytes limit validation | `Pipe._read_file_record_base64` | pipe_instance_async | raises ValueError | Low | [ ] | Tests bytes limit | |
| TestReadFileRecordBase64::test_skips_nonexistent_path | Should skip path if file doesn't exist | Nonexistent path handling | `Pipe._read_file_record_base64` | pipe_instance_async | result == fallback content | Low | [ ] | Tests path fallback | |
| TestEncodeFilePathBase64::test_raises_when_file_exceeds_limit | Should raise ValueError when file exceeds max_bytes during encoding | File size limit during encoding | `Pipe._encode_file_path_base64` | pipe_instance_async, tmp_path | raises ValueError | Low | [ ] | Tests file size limit | |
| TestInlineOwuiFileId::test_returns_none_for_empty_file_id | Should return None for empty file ID | Empty file ID handling | `Pipe._inline_owui_file_id` | pipe_instance_async | result is None | Low | [ ] | Tests empty ID return | |
| TestInlineOwuiFileId::test_returns_none_for_whitespace_file_id | Should return None for whitespace-only file ID | Whitespace file ID handling | `Pipe._inline_owui_file_id` | pipe_instance_async | result is None | Low | [ ] | Tests whitespace ID return | |
| TestInlineOwuiFileId::test_returns_none_when_file_not_found | Should return None when file lookup returns None | File not found handling | `Pipe._inline_owui_file_id` | pipe_instance_async, AsyncMock | result is None | Medium | [ ] | Tests file not found | |
| TestInlineOwuiFileId::test_returns_data_url_for_valid_file | Should return data URL for valid file | Valid file inlining | `Pipe._inline_owui_file_id` | pipe_instance_async, tmp_path, AsyncMock | result == expected data URL | Medium | [ ] | Tests valid file inlining | |
| TestInlineOwuiFileId::test_returns_none_when_read_fails | Should return None when file read raises ValueError | File read failure handling | `Pipe._inline_owui_file_id` | pipe_instance_async, AsyncMock | result is None | Medium | [ ] | Tests read failure | |
| TestInlineOwuiFileId::test_returns_none_when_b64_is_none | Should return None when _read_file_record_base64 returns None | B64 None handling | `Pipe._inline_owui_file_id` | pipe_instance_async, AsyncMock | result is None | Medium | [ ] | Tests b64 None return | |
| TestInlineInternalFileUrl::test_returns_none_for_non_internal_url | Should return None for external URLs | External URL handling | `Pipe._inline_internal_file_url` | pipe_instance_async | result is None | Low | [ ] | Tests external URL return | |
| TestInlineInternalFileUrl::test_inlines_internal_file_url | Should inline internal file URL to data URL | Internal URL inlining | `Pipe._inline_internal_file_url` | pipe_instance_async, tmp_path, AsyncMock | result == expected data URL | Medium | [ ] | Tests URL inlining | |
| TestInlineInternalResponsesInputFilesInplace::test_does_nothing_for_empty_input | Should do nothing when input is empty | Empty input handling | `Pipe._inline_internal_responses_input_files_inplace` | pipe_instance_async | body unchanged | Low | [ ] | Tests empty input | |
| TestInlineInternalResponsesInputFilesInplace::test_does_nothing_for_non_list_input | Should do nothing when input is not a list | Non-list input handling | `Pipe._inline_internal_responses_input_files_inplace` | pipe_instance_async | body unchanged | Low | [ ] | Tests non-list input | |
| TestInlineInternalResponsesInputFilesInplace::test_skips_non_dict_items | Should skip non-dict items in input | Non-dict items handling | `Pipe._inline_internal_responses_input_files_inplace` | pipe_instance_async | body unchanged | Low | [ ] | Tests non-dict skip | |
| TestInlineInternalResponsesInputFilesInplace::test_skips_items_without_content | Should skip items without content | Missing content handling | `Pipe._inline_internal_responses_input_files_inplace` | pipe_instance_async | body unchanged | Low | [ ] | Tests no content skip | |
| TestInlineInternalResponsesInputFilesInplace::test_skips_non_input_file_blocks | Should skip blocks that are not input_file type | Non-input_file type handling | `Pipe._inline_internal_responses_input_files_inplace` | pipe_instance_async | type unchanged | Low | [ ] | Tests type skip | |
| TestInlineInternalResponsesInputFilesInplace::test_skips_file_id_starting_with_file_prefix | Should skip file_id that starts with 'file-' (OpenAI format) | OpenAI file ID handling | `Pipe._inline_internal_responses_input_files_inplace` | pipe_instance_async | file_id unchanged | Low | [ ] | Tests OpenAI format skip | |
| TestInlineInternalResponsesInputFilesInplace::test_skips_external_file_url | Should skip input_file block when file_url is external | External file_url handling | `Pipe._inline_internal_responses_input_files_inplace` | pipe_instance_async | file_url unchanged | Low | [ ] | Tests external URL skip | |
| TestInlineInternalResponsesInputFilesInplace::test_inlines_internal_file_id | Should inline internal file_id to file_data | Internal file_id inlining | `Pipe._inline_internal_responses_input_files_inplace` | pipe_instance_async, tmp_path, AsyncMock | file_data set, file_id removed | Medium | [ ] | Tests file_id inlining | |
| TestInlineInternalResponsesInputFilesInplace::test_inlines_internal_file_data_url | Should inline internal file_data URL | Internal file_data URL inlining | `Pipe._inline_internal_responses_input_files_inplace` | pipe_instance_async, tmp_path, AsyncMock | file_data starts with data: | Medium | [ ] | Tests file_data inlining | |
| TestInlineInternalResponsesInputFilesInplace::test_inlines_internal_file_url | Should inline internal file_url | Internal file_url inlining | `Pipe._inline_internal_responses_input_files_inplace` | pipe_instance_async, tmp_path, AsyncMock | file_data set, file_url removed | Medium | [ ] | Tests file_url inlining | |
| TestInlineInternalResponsesInputFilesInplace::test_raises_when_inlining_fails | Should raise ValueError when inlining fails | Inlining failure handling | `Pipe._inline_internal_responses_input_files_inplace` | pipe_instance_async, AsyncMock | raises ValueError | Medium | [ ] | Tests inlining failure | |
| TestInlineInternalResponsesInputFilesInplace::test_skips_non_list_content | Should skip items where content is not a list | Non-list content handling | `Pipe._inline_internal_responses_input_files_inplace` | pipe_instance_async | content unchanged | Low | [ ] | Tests non-list content | |
| TestInlineInternalResponsesInputFilesInplace::test_skips_non_dict_blocks | Should skip non-dict blocks in content list | Non-dict blocks handling | `Pipe._inline_internal_responses_input_files_inplace` | pipe_instance_async | content unchanged | Low | [ ] | Tests non-dict blocks | |
| TestTryLinkFileToChat::test_returns_false_for_non_string_chat_id | Should return False for non-string chat_id | Non-string chat_id validation | `Pipe._try_link_file_to_chat` | pipe_instance | result is False | Low | [ ] | Tests chat_id validation | |
| TestTryLinkFileToChat::test_returns_false_for_empty_chat_id | Should return False for empty chat_id | Empty chat_id validation | `Pipe._try_link_file_to_chat` | pipe_instance | result is False | Low | [ ] | Tests empty chat_id | |
| TestTryLinkFileToChat::test_returns_false_for_local_chat_id | Should return False for chat_id starting with 'local:' | Local chat_id handling | `Pipe._try_link_file_to_chat` | pipe_instance | result is False | Low | [ ] | Tests local chat_id | |
| TestTryLinkFileToChat::test_returns_false_for_empty_file_id | Should return False for empty file_id | Empty file_id validation | `Pipe._try_link_file_to_chat` | pipe_instance | result is False | Low | [ ] | Tests empty file_id | |
| TestTryLinkFileToChat::test_returns_false_for_non_string_user_id | Should return False for non-string user_id | Non-string user_id validation | `Pipe._try_link_file_to_chat` | pipe_instance | result is False | Low | [ ] | Tests user_id validation | |
| TestTryLinkFileToChat::test_returns_false_for_empty_user_id | Should return False for empty user_id | Empty user_id validation | `Pipe._try_link_file_to_chat` | pipe_instance | result is False | Low | [ ] | Tests empty user_id | |
| TestTryLinkFileToChat::test_returns_false_when_chats_import_fails | Should return False when open_webui.models.chats import fails | Chats import failure handling | `Pipe._try_link_file_to_chat` | pipe_instance, patch sys.modules | None | Medium | [ ] | Tests import failure | |
| TestTryLinkFileToChat::test_calls_insert_with_keyword_args | Should call insert_chat_files with keyword arguments | Keyword args call verification | `Pipe._try_link_file_to_chat` | pipe_instance, MockChats | result is True, args verified | Medium | [ ] | Tests kwarg call | |
| TestTryLinkFileToChat::test_falls_back_to_positional_args_on_type_error | Should fall back to positional arguments on TypeError | Positional args fallback | `Pipe._try_link_file_to_chat` | pipe_instance, MockChats | result is True | Medium | [ ] | Tests positional fallback | |
| TestTryLinkFileToChat::test_returns_false_when_insert_fn_not_callable | Should return False when insert_chat_files is not callable | Non-callable function handling | `Pipe._try_link_file_to_chat` | pipe_instance, MockChats | result is False | Medium | [ ] | Tests non-callable | |
| TestTryLinkFileToChat::test_returns_false_on_general_exception | Should return False on general exception from insert | Exception handling | `Pipe._try_link_file_to_chat` | pipe_instance, MockChats | result is False | Medium | [ ] | Tests exception handling | |
| TestTryLinkFileToChat::test_handles_none_message_id | Should handle None message_id gracefully | None message_id handling | `Pipe._try_link_file_to_chat` | pipe_instance, MockChats | result is True, message_id is None | Low | [ ] | Tests None message_id | |
| TestTryLinkFileToChat::test_handles_positional_args_exception | Should return False when both keyword and positional args fail | Both arg types failure | `Pipe._try_link_file_to_chat` | pipe_instance, MockChats | result is False | Medium | [ ] | Tests both args fail | |
| TestResolveStorageContext::test_returns_none_when_request_is_none | Should return (None, None) when request is None | None request handling | `Pipe._resolve_storage_context` | pipe_instance_async, mock_user | request is None, user is None | Low | [ ] | Tests None request | |
| TestResolveStorageContext::test_returns_provided_user_when_available | Should return provided user when available | Provided user passthrough | `Pipe._resolve_storage_context` | pipe_instance_async, mock_request, mock_user | user is mock_user | Low | [ ] | Tests user passthrough | |
| TestResolveStorageContext::test_returns_none_when_fallback_user_fails | Should return (None, None) when fallback user creation fails | Fallback user failure | `Pipe._resolve_storage_context` | pipe_instance_async, mock_request, AsyncMock | request is None, user is None | Medium | [ ] | Tests fallback failure | |
| TestResolveStorageContext::test_uses_fallback_user_when_user_is_none | Should use fallback user when user_obj is None | Fallback user usage | `Pipe._resolve_storage_context` | pipe_instance_async, mock_request, AsyncMock | user is fallback_user | Medium | [ ] | Tests fallback user | |
| TestEnsureStorageUser::test_returns_none_when_users_unavailable | Should return None when Users module unavailable | Users module unavailability | `Pipe._ensure_storage_user` | pipe_instance_async, multimodal_module patch | result is None | Medium | [ ] | Tests Users check | |
| TestEnsureStorageUser::test_returns_cached_user | Should return cached user on subsequent calls | User caching | `Pipe._ensure_storage_user` | pipe_instance_async | result is cached_user | Low | [ ] | Tests caching | |
| TestEnsureStorageUser::test_warns_on_privileged_role | Should warn when using privileged role | Privileged role warning | `Pipe._ensure_storage_user` | pipe_instance_async, caplog, multimodal_module patch | "highly privileged" in log | Medium | [ ] | Tests role warning | |
| TestEnsureStorageUser::test_returns_cached_user_after_lock | Should return cached user if another task set it while waiting for lock | Lock race condition | `Pipe._ensure_storage_user` | pipe_instance_async, multimodal_module patch | result is cached_user | Medium | [ ] | Tests lock race | |
| TestEnsureStorageUser::test_creates_user_when_not_exists | Should create new user when not found by email | User creation | `Pipe._ensure_storage_user` | pipe_instance_async, multimodal_module patch | result is created_user | Medium | [ ] | Tests user creation | |
| TestEnsureStorageUser::test_handles_oauth_param_name | Should handle 'oauth' parameter in insert signature | OAuth param handling | `Pipe._ensure_storage_user` | pipe_instance_async, multimodal_module patch | result is created_user | Medium | [ ] | Tests oauth param | |
| TestEnsureStorageUser::test_handles_oauth_sub_param_name | Should handle 'oauth_sub' parameter in insert signature | OAuth_sub param handling | `Pipe._ensure_storage_user` | pipe_instance_async, multimodal_module patch | result is created_user | Medium | [ ] | Tests oauth_sub param | |
| TestEnsureStorageUser::test_returns_none_when_get_user_raises | Should return None when get_user_by_email raises exception | Get user exception | `Pipe._ensure_storage_user` | pipe_instance_async, multimodal_module patch | result is None | Medium | [ ] | Tests get user exception | |
| TestEnsureStorageUser::test_returns_none_when_insert_raises | Should return None when insert_new_user raises exception | Insert exception | `Pipe._ensure_storage_user` | pipe_instance_async, multimodal_module patch | result is None | Medium | [ ] | Tests insert exception | |
| TestEnsureStorageUser::test_handles_signature_inspection_error | Should handle error when inspecting insert signature | Signature inspection error | `Pipe._ensure_storage_user` | pipe_instance_async, multimodal_module patch | result is created_user | Medium | [ ] | Tests signature error | |
| TestDownloadRemoteUrl::test_uses_default_timeout_when_none | Should use default timeout when timeout_seconds is None and valve is None | Default timeout usage | `Pipe._download_remote_url` | pipe_instance_async, patch httpx.AsyncClient | None | Medium | [ ] | Tests default timeout | |
| TestDownloadRemoteUrl::test_returns_none_for_ftp_url | Should return None for FTP URLs | FTP URL rejection | `Pipe._download_remote_url` | pipe_instance_async | result is None | Low | [ ] | Tests FTP rejection | |
| TestDownloadRemoteUrl::test_returns_none_for_file_url | Should return None for file:// URLs | File URL rejection | `Pipe._download_remote_url` | pipe_instance_async | result is None | Low | [ ] | Tests file:// rejection | |
| TestDownloadRemoteUrl::test_returns_none_for_empty_url | Should return None for empty URL | Empty URL rejection | `Pipe._download_remote_url` | pipe_instance_async | result is None | Low | [ ] | Tests empty URL | |
| TestDownloadRemoteUrl::test_returns_none_when_ssrf_blocked | Should return None when SSRF protection blocks the URL | SSRF blocking | `Pipe._download_remote_url` | pipe_instance_async | result is None | Medium | [ ] | Tests SSRF block | |
| TestDownloadRemoteUrl::test_normalizes_image_jpg_to_jpeg | Should normalize image/jpg to image/jpeg | MIME normalization | `Pipe._download_remote_url` | pipe_instance_async, patch httpx.AsyncClient | mime_type == "image/jpeg" | Low | [ ] | Tests MIME normalization | |
| TestDownloadRemoteUrl::test_rejects_content_length_exceeding_limit | Should reject files when Content-Length exceeds limit | Content-Length limit | `Pipe._download_remote_url` | pipe_instance_async, patch httpx.AsyncClient | result is None | Medium | [ ] | Tests size limit | |
| TestDownloadRemoteUrl::test_handles_invalid_content_length | Should handle non-integer Content-Length gracefully | Invalid Content-Length | `Pipe._download_remote_url` | pipe_instance_async, patch httpx.AsyncClient | data == b"data" | Low | [ ] | Tests invalid header | |
| TestDownloadRemoteUrl::test_skips_empty_chunks | Should skip empty chunks during streaming | Empty chunk handling | `Pipe._download_remote_url` | pipe_instance_async, patch httpx.AsyncClient | data == b"actual data" | Low | [ ] | Tests empty chunks | |
| TestDownloadRemoteUrl::test_aborts_when_streaming_exceeds_limit | Should abort download when streaming data exceeds size limit | Streaming size limit | `Pipe._download_remote_url` | pipe_instance_async, patch httpx.AsyncClient | result is None | Medium | [ ] | Tests streaming limit | |
| TestDownloadRemoteUrl::test_returns_none_on_final_exception | Should return None and log error on unrecoverable exception | Unrecoverable exception | `Pipe._download_remote_url` | pipe_instance_async, patch httpx.AsyncClient | result is None | Medium | [ ] | Tests exception handling | |
| TestDownloadRemoteUrl::test_handles_http_404_error | Should return None on non-retryable HTTP errors like 404 | HTTP 404 handling | `Pipe._download_remote_url` | pipe_instance_async, patch httpx.AsyncClient | result is None | Medium | [ ] | Tests 404 handling | |
| TestIsSafeUrlBlocking::test_returns_false_for_empty_hostname | Should return False for URL with no hostname | Empty hostname handling | `Pipe._is_safe_url_blocking` | pipe_instance | result is False | Low | [ ] | Tests empty hostname | |
| TestIsSafeUrlBlocking::test_blocks_loopback_ip | Should block loopback IP addresses | Loopback IP blocking | `Pipe._is_safe_url_blocking` | pipe_instance | result is False | Low | [ ] | Tests loopback block | |
| TestIsSafeUrlBlocking::test_blocks_link_local_ip | Should block link-local IP addresses | Link-local IP blocking | `Pipe._is_safe_url_blocking` | pipe_instance | result is False | Low | [ ] | Tests link-local block | |
| TestIsSafeUrlBlocking::test_blocks_multicast_ip | Should block multicast IP addresses | Multicast IP blocking | `Pipe._is_safe_url_blocking` | pipe_instance | result is False | Low | [ ] | Tests multicast block | |
| TestIsSafeUrlBlocking::test_blocks_reserved_ipv6 | Should block reserved IPv6 addresses | Reserved IPv6 blocking | `Pipe._is_safe_url_blocking` | pipe_instance | result is False | Low | [ ] | Tests IPv6 block | |
| TestIsSafeUrlBlocking::test_blocks_unspecified_ipv6 | Should block unspecified address :: | Unspecified IPv6 blocking | `Pipe._is_safe_url_blocking` | pipe_instance | result is False | Low | [ ] | Tests :: block | |
| TestIsSafeUrlBlocking::test_returns_false_on_dns_failure | Should return False when DNS resolution fails | DNS failure handling | `Pipe._is_safe_url_blocking` | pipe_instance, monkeypatch | result is False | Low | [ ] | Tests DNS failure | |
| TestIsSafeUrlBlocking::test_returns_false_on_unicode_error | Should return False on UnicodeError during DNS resolution | Unicode error handling | `Pipe._is_safe_url_blocking` | pipe_instance, monkeypatch | result is False | Low | [ ] | Tests Unicode error | |
| TestIsSafeUrlBlocking::test_returns_false_when_no_ips_resolved | Should return False when hostname resolves to empty IP list | Empty IP list handling | `Pipe._is_safe_url_blocking` | pipe_instance, monkeypatch | result is False | Low | [ ] | Tests empty IP list | |
| TestIsSafeUrlBlocking::test_returns_false_for_invalid_ip_in_response | Should return False when sockaddr contains invalid IP | Invalid IP handling | `Pipe._is_safe_url_blocking` | pipe_instance, monkeypatch | result is False | Low | [ ] | Tests invalid IP | |
| TestIsSafeUrlBlocking::test_handles_empty_sockaddr | Should handle empty sockaddr in DNS response | Empty sockaddr handling | `Pipe._is_safe_url_blocking` | pipe_instance, monkeypatch | result is True | Low | [ ] | Tests empty sockaddr | |
| TestIsSafeUrlBlocking::test_blocks_private_ipv4 | Should block private IPv4 addresses | Private IPv4 blocking | `Pipe._is_safe_url_blocking` | pipe_instance | result is False | Low | [ ] | Tests private IPv4 | |
| TestIsSafeUrlBlocking::test_blocks_private_192_168 | Should block 192.168.x.x private addresses | 192.168.x.x blocking | `Pipe._is_safe_url_blocking` | pipe_instance | result is False | Low | [ ] | Tests 192.168 block | |
| TestIsSafeUrlBlocking::test_returns_false_on_unexpected_exception | Should return False on unexpected exception | Unexpected exception | `Pipe._is_safe_url_blocking` | pipe_instance, monkeypatch, patch | None | Low | [ ] | Tests unexpected exception | |
| TestIsSafeUrlBlocking::test_blocks_reserved_ip | Should block reserved IP addresses (240.0.0.0/4 class E) | Reserved IP blocking | `Pipe._is_safe_url_blocking` | pipe_instance, monkeypatch | result is False | Low | [ ] | Tests class E block | |
| TestIsYoutubeUrl::test_detects_standard_youtube_url | Should detect standard YouTube watch URL | YouTube URL detection | `Pipe._is_youtube_url` | pipe_instance | result is True | Low | [ ] | Tests YouTube detection | |
| TestIsYoutubeUrl::test_detects_short_youtube_url | Should detect short youtu.be URL | Short YouTube URL detection | `Pipe._is_youtube_url` | pipe_instance | result is True | Low | [ ] | Tests youtu.be detection | |
| TestIsYoutubeUrl::test_detects_http_youtube_url | Should detect HTTP YouTube URL | HTTP YouTube detection | `Pipe._is_youtube_url` | pipe_instance | result is True | Low | [ ] | Tests HTTP YouTube | |
| TestIsYoutubeUrl::test_returns_false_for_empty | Should return False for empty string | Empty string handling | `Pipe._is_youtube_url` | pipe_instance | result is False | Low | [ ] | Tests empty string | |
| TestIsYoutubeUrl::test_returns_false_for_none | Should return False for None | None handling | `Pipe._is_youtube_url` | pipe_instance | result is False | Low | [ ] | Tests None | |
| TestIsYoutubeUrl::test_returns_false_for_non_youtube | Should return False for non-YouTube URLs | Non-YouTube handling | `Pipe._is_youtube_url` | pipe_instance | result is False | Low | [ ] | Tests non-YouTube | |
| TestValidateBase64Size::test_returns_true_for_empty_string | Should return True for empty string | Empty string validation | `Pipe._validate_base64_size` | pipe_instance | result is True | Low | [ ] | Tests empty string | |
| TestValidateBase64Size::test_returns_true_for_small_data | Should return True for data within limits | Small data validation | `Pipe._validate_base64_size` | pipe_instance | result is True | Low | [ ] | Tests small data | |
| TestValidateBase64Size::test_returns_false_for_large_data | Should return False for data exceeding limits | Large data validation | `Pipe._validate_base64_size` | pipe_instance | result is False | Low | [ ] | Tests large data | |
| TestParseDataUrl::test_returns_none_when_validation_fails | Should return None when base64 size validation fails | Size validation failure | `Pipe._parse_data_url` | pipe_instance | result is None | Low | [ ] | Tests size validation | |
| TestParseDataUrl::test_returns_none_for_none_input | Should return None for None input | None input handling | `Pipe._parse_data_url` | pipe_instance | result is None | Low | [ ] | Tests None input | |
| TestParseDataUrl::test_returns_none_for_non_data_url | Should return None for non-data URLs | Non-data URL handling | `Pipe._parse_data_url` | pipe_instance | result is None | Low | [ ] | Tests non-data URL | |
| TestParseDataUrl::test_returns_none_for_missing_base64_separator | Should return None when ;base64, separator is missing | Missing separator handling | `Pipe._parse_data_url` | pipe_instance | result is None | Low | [ ] | Tests missing separator | |
| TestParseDataUrl::test_normalizes_image_jpg_in_data_url | Should normalize image/jpg to image/jpeg in data URLs | MIME normalization in data URL | `Pipe._parse_data_url` | pipe_instance | mime_type == "image/jpeg" | Low | [ ] | Tests MIME normalization | |
| TestParseDataUrl::test_decodes_valid_base64 | Should decode valid base64 data | Valid base64 decoding | `Pipe._parse_data_url` | pipe_instance | data == original_data | Low | [ ] | Tests base64 decode | |
| TestParseDataUrl::test_returns_none_for_invalid_base64 | Should return None for invalid base64 data | Invalid base64 handling | `Pipe._parse_data_url` | pipe_instance | result is None | Low | [ ] | Tests invalid base64 | |
| TestFetchImageAsDataUrl::test_returns_none_for_empty_url | Should return None for empty URL | Empty URL handling | `Pipe._fetch_image_as_data_url` | pipe_instance_async, aiohttp.ClientSession | result is None | Low | [ ] | Tests empty URL | |
| TestFetchImageAsDataUrl::test_returns_existing_data_url | Should return existing data URL as-is | Data URL passthrough | `Pipe._fetch_image_as_data_url` | pipe_instance_async, aiohttp.ClientSession | result == data_url | Low | [ ] | Tests data URL passthrough | |
| TestFetchImageAsDataUrl::test_prepends_https_for_protocol_relative_url | Should prepend https: for protocol-relative URLs | Protocol-relative URL handling | `Pipe._fetch_image_as_data_url` | pipe_instance_async, aiohttp.ClientSession | result is None | Low | [ ] | Tests protocol-relative | |
| TestFetchImageAsDataUrl::test_prepends_site_url_for_relative_path | Should prepend site URL for relative paths starting with / | Relative path handling | `Pipe._fetch_image_as_data_url` | pipe_instance_async, aiohttp.ClientSession | result is None | Low | [ ] | Tests relative path | |
| TestFetchImageAsDataUrl::test_prepends_site_url_for_bare_path | Should prepend site URL for paths without leading slash | Bare path handling | `Pipe._fetch_image_as_data_url` | pipe_instance_async, aiohttp.ClientSession | result is None | Low | [ ] | Tests bare path | |
| TestFetchImageAsDataUrl::test_handles_svg_with_cairosvg_unavailable | Should return None when cairosvg is unavailable for SVG | Cairosvg unavailable | `Pipe._fetch_image_as_data_url` | pipe_instance_async, aiohttp.ClientSession, aioresponses, patch | result is None or starts with data: | Medium | [ ] | Tests cairosvg missing | |
| TestFetchImageAsDataUrl::test_handles_svg_rasterization_failure | Should return None when SVG rasterization fails | SVG rasterization failure | `Pipe._fetch_image_as_data_url` | pipe_instance_async, aiohttp.ClientSession, aioresponses, Mock | result is None or starts with data: | Medium | [ ] | Tests rasterization failure | |
| TestFetchImageAsDataUrl::test_handles_pillow_unavailable | Should return None when Pillow is unavailable | Pillow unavailable | `Pipe._fetch_image_as_data_url` | pipe_instance_async, aiohttp.ClientSession, aioresponses | result is None or starts with data: | Medium | [ ] | Tests Pillow missing | |
| TestFetchImageAsDataUrl::test_converts_non_rgb_image | Should convert non-RGB/RGBA images to RGBA | Non-RGB image conversion | `Pipe._fetch_image_as_data_url` | pipe_instance_async, aiohttp.ClientSession, aioresponses | result is None or starts with data:image/png;base64, | Medium | [ ] | Tests image conversion | |
| TestFetchImageAsDataUrl::test_returns_png_data_url | Should return PNG data URL for valid image | PNG data URL return | `Pipe._fetch_image_as_data_url` | pipe_instance_async, aiohttp.ClientSession, aioresponses | result is None or starts with data: | Medium | [ ] | Tests PNG return | |
| TestFetchImageAsDataUrl::test_skips_oversized_image | Should skip images exceeding the size limit | Oversized image handling | `Pipe._fetch_image_as_data_url` | pipe_instance_async, aiohttp.ClientSession, aioresponses | result is None | Medium | [ ] | Tests size limit | |
| TestFetchImageAsDataUrl::test_skips_unsupported_content_type | Should skip images with unsupported content type | Unsupported content type | `Pipe._fetch_image_as_data_url` | pipe_instance_async, aiohttp.ClientSession, aioresponses | result is None | Medium | [ ] | Tests unsupported type | |
| TestFetchImageAsDataUrl::test_handles_http_error | Should return None on HTTP error | HTTP error handling | `Pipe._fetch_image_as_data_url` | pipe_instance_async, aiohttp.ClientSession, aioresponses | result is None | Medium | [ ] | Tests HTTP error | |
| TestFetchMakerProfileImageUrl::test_returns_none_for_empty_maker_id | Should return None for empty maker ID | Empty maker ID handling | `Pipe._fetch_maker_profile_image_url` | pipe_instance_async, aiohttp.ClientSession | result is None | Low | [ ] | Tests empty maker ID | |
| TestFetchMakerProfileImageUrl::test_returns_none_for_whitespace_maker_id | Should return None for whitespace-only maker ID | Whitespace maker ID handling | `Pipe._fetch_maker_profile_image_url` | pipe_instance_async, aiohttp.ClientSession | result is None | Low | [ ] | Tests whitespace maker ID | |
| TestFetchMakerProfileImageUrl::test_returns_none_for_non_string_html | Should return None when HTML response is not a string | Non-string HTML handling | `Pipe._fetch_maker_profile_image_url` | pipe_instance_async, aiohttp.ClientSession, aioresponses | result is None or isinstance str | Medium | [ ] | Tests non-string HTML | |
| TestFetchMakerProfileImageUrl::test_extracts_og_image_from_page | Should extract og:image from maker page HTML | OG image extraction | `Pipe._fetch_maker_profile_image_url` | pipe_instance_async, aiohttp.ClientSession, aioresponses | result == expected URL | Medium | [ ] | Tests og:image extraction | |
| TestFetchMakerProfileImageUrl::test_returns_none_on_http_error | Should return None on HTTP error | HTTP error handling | `Pipe._fetch_maker_profile_image_url` | pipe_instance_async, aiohttp.ClientSession, aioresponses | result is None | Medium | [ ] | Tests HTTP error | |
| TestFetchMakerProfileImageUrl::test_returns_none_when_no_og_image | Should return None when page has no og:image | No og:image handling | `Pipe._fetch_maker_profile_image_url` | pipe_instance_async, aiohttp.ClientSession, aioresponses | result is None | Medium | [ ] | Tests no og:image | |
| TestIsSafeUrlAsync::test_bypasses_when_ssrf_protection_disabled | Should return True immediately when SSRF protection is disabled | SSRF bypass when disabled | `Pipe._is_safe_url` | pipe_instance_async | result is True | Low | [ ] | Tests SSRF bypass | |
| TestIsSafeUrlAsync::test_delegates_to_blocking_when_enabled | Should delegate to blocking implementation when enabled | SSRF delegation | `Pipe._is_safe_url` | pipe_instance_async | result is False | Low | [ ] | Tests SSRF delegation | |
| TestGetEffectiveRemoteFileLimit::test_returns_base_limit_when_rag_disabled | Should return base limit when RAG is disabled | RAG disabled limit | `Pipe._get_effective_remote_file_limit_mb` | pipe_instance, patch | result == 100 | Medium | [ ] | Tests RAG disabled | |
| TestGetEffectiveRemoteFileLimit::test_returns_rag_limit_when_lower | Should return RAG limit when it's lower than base | RAG lower limit | `Pipe._get_effective_remote_file_limit_mb` | pipe_instance, patch | result == 50 | Medium | [ ] | Tests RAG lower limit | |
| TestGetEffectiveRemoteFileLimit::test_upgrades_default_to_rag_limit | Should upgrade default limit to RAG limit when RAG limit is higher | RAG higher limit upgrade | `Pipe._get_effective_remote_file_limit_mb` | pipe_instance, patch | result == 200 | Medium | [ ] | Tests RAG upgrade | |
| TestGetEffectiveRemoteFileLimit::test_returns_base_limit_when_non_default_and_lower_than_rag | Should return base limit when it's non-default and lower than RAG | Custom limit priority | `Pipe._get_effective_remote_file_limit_mb` | pipe_instance, patch | result == 30 | Medium | [ ] | Tests custom limit | |
| TestUploadToOwuiStorage::test_returns_none_when_helpers_unavailable | Should return None when upload helpers are not available | Helpers unavailable | `Pipe._upload_to_owui_storage` | pipe_instance_async, mock_request, mock_user, multimodal_module patch | result is None | Medium | [ ] | Tests helpers check | |
| TestUploadToOwuiStorage::test_handles_dict_response | Should handle dict response from upload handler | Dict response handling | `Pipe._upload_to_owui_storage` | pipe_instance_async, mock_request, mock_user, multimodal_module patch | result == "dict-file-id" | Medium | [ ] | Tests dict response | |
| TestUploadToOwuiStorage::test_handles_object_response | Should handle object response with id attribute | Object response handling | `Pipe._upload_to_owui_storage` | pipe_instance_async, mock_request, mock_user, multimodal_module patch | result == "object-file-id" | Medium | [ ] | Tests object response | |
| TestUploadToOwuiStorage::test_returns_none_on_exception | Should return None and log error on exception | Exception handling | `Pipe._upload_to_owui_storage` | pipe_instance_async, mock_request, mock_user, multimodal_module patch | result is None | Medium | [ ] | Tests exception | |
| TestUploadToOwuiStorage::test_skips_local_chat_id_in_metadata | Should skip chat_id in metadata if it starts with 'local:' | Local chat_id handling | `Pipe._upload_to_owui_storage` | pipe_instance_async, mock_request, mock_user, multimodal_module patch | "chat_id" not in metadata | Medium | [ ] | Tests local chat_id | |
| TestUploadToOwuiStorage::test_uses_owui_user_id_override | Should use owui_user_id when provided instead of user.id | User ID override | `Pipe._upload_to_owui_storage` | pipe_instance_async, mock_request, mock_user, multimodal_module patch | user_id == "override-user-id" | Medium | [ ] | Tests user ID override | |
| TestUploadToOwuiStorage::test_swallows_link_exception | Should swallow exception from _try_link_file_to_chat and still return file_id | Link exception handling | `Pipe._upload_to_owui_storage` | pipe_instance_async, mock_request, mock_user, multimodal_module patch | result == "uploaded-file-id" | Medium | [ ] | Tests link exception | |
| TestUploadToOwuiStorage::test_handles_response_without_id | Should return None when response has no id | No id response handling | `Pipe._upload_to_owui_storage` | pipe_instance_async, mock_request, mock_user, multimodal_module patch | result is None | Medium | [ ] | Tests no id response | |
| TestUploadToOwuiStorage::test_handles_dict_response_without_id | Should return None when dict response has no id | Dict no id handling | `Pipe._upload_to_owui_storage` | pipe_instance_async, mock_request, mock_user, multimodal_module patch | result is None | Medium | [ ] | Tests dict no id | |
| TestUploadToOwuiStorage::test_includes_chat_id_and_message_id_in_metadata | Should include valid chat_id and message_id in metadata | Metadata inclusion | `Pipe._upload_to_owui_storage` | pipe_instance_async, mock_request, mock_user, multimodal_module patch | chat_id and message_id in metadata | Medium | [ ] | Tests metadata | |
| TestDataURLParsing::test_parse_valid_image_data_url | Should parse valid image data URL correctly | Data URL parsing | `Pipe._parse_data_url` | pipe_instance, sample_image_base64 | mime_type, b64, data verified | Low | [ ] | Tests data URL parsing | |
| TestDataURLParsing::test_parse_normalizes_image_jpg_to_jpeg | Should normalize image/jpg to image/jpeg | MIME normalization | `Pipe._parse_data_url` | pipe_instance | mime_type == "image/jpeg" | Low | [ ] | Tests MIME normalization | |
| TestDataURLParsing::test_parse_audio_data_url | Should parse audio data URL correctly | Audio data URL parsing | `Pipe._parse_data_url` | pipe_instance, sample_audio_base64 | mime_type, b64 verified | Low | [ ] | Tests audio parsing | |
| TestDataURLParsing::test_parse_invalid_data_url_returns_none | Should return None for invalid data URLs | Invalid URL handling | `Pipe._parse_data_url` | pipe_instance | result is None for all invalid | Low | [ ] | Tests invalid URLs | |
| TestDataURLParsing::test_parse_invalid_base64_returns_none | Should return None for invalid base64 data | Invalid base64 handling | `Pipe._parse_data_url` | pipe_instance | result is None | Low | [ ] | Tests invalid base64 | |
| TestImageTransformations::test_remote_images_rehosted_and_inlined | Remote images should be re-hosted and then inlined for provider delivery | Remote image rehosting | `Pipe.transform_messages_to_input` | pipe_instance, mock_request, mock_user, sample_image_base64, AsyncMock | image_url == inlined data URL | High | [ ] | Tests image rehosting | |
| TestFileEncoding::test_encode_file_path_base64_matches_standard_encoder | Chunked base64 encoding should match the standard encoder output | Base64 encoding consistency | `Pipe._encode_file_path_base64` | pipe_instance, tmp_path | result == expected base64 | Low | [ ] | Tests encoding consistency | |
| TestRemoteURLDownloading::test_download_successful | Should download remote file successfully | Successful download | `Pipe._download_remote_url` | pipe_instance_async, patch httpx.AsyncClient | data, mime_type, url verified | Medium | [ ] | Tests successful download | |
| TestRemoteURLDownloading::test_download_normalizes_mime_type | Should normalize image/jpg to image/jpeg | MIME normalization on download | `Pipe._download_remote_url` | pipe_instance_async, patch httpx.AsyncClient | mime_type == "image/jpeg" | Medium | [ ] | Tests MIME normalization | |
| TestRemoteURLDownloading::test_download_rejects_files_over_default_limit | Should reject files larger than the configured limit (default 50MB) | Size limit enforcement | `Pipe._download_remote_url` | pipe_instance_async, patch httpx.AsyncClient | result is None | Medium | [ ] | Tests size limit | |
| TestRemoteURLDownloading::test_download_invalid_url_returns_none | Should return None for non-HTTP URLs | Invalid URL handling | `Pipe._download_remote_url` | pipe_instance_async | result is None for all | Low | [ ] | Tests invalid URLs | |
| TestRemoteURLDownloading::test_download_network_error_returns_none | Should retry on network errors and return None when exhausted | Network error retry | `Pipe._download_remote_url` | pipe_instance_async, patch httpx.AsyncClient | result is None, call_count == 2 | Medium | [ ] | Tests network retry | |
| TestRemoteURLDownloading::test_download_does_not_retry_on_client_errors | Should not retry on non-429 HTTP 4xx errors | No retry on 4xx | `Pipe._download_remote_url` | pipe_instance_async, patch httpx.AsyncClient | result is None, call_count == 1 | Medium | [ ] | Tests no 4xx retry | |
| TestRemoteURLDownloading::test_download_blocks_unsafe_url | SSRF guard should abort before making any HTTP request | SSRF blocking | `Pipe._download_remote_url` | pipe_instance_async, AsyncMock, patch httpx.AsyncClient | result is None, client not called | Medium | [ ] | Tests SSRF block | |
| TestRemoteURLDownloading::test_download_retries_on_429_then_succeeds | HTTP 429 should trigger a retry and succeed on a later attempt | 429 retry success | `Pipe._download_remote_url` | pipe_instance_async, patch httpx.AsyncClient | data == b"ok", call_count == 2 | Medium | [ ] | Tests 429 retry | |
| TestSSRFIPv6Validation::test_blocks_private_ipv6_literal | IPv6 literals in unique-local ranges should be rejected | Private IPv6 blocking | `Pipe._is_safe_url` | pipe_instance_async | result is False | Low | [ ] | Tests private IPv6 | |
| TestSSRFIPv6Validation::test_allows_global_ipv6_literal | Public IPv6 literals should be considered safe | Public IPv6 allowance | `Pipe._is_safe_url` | pipe_instance_async | result is True | Low | [ ] | Tests public IPv6 | |
| TestSSRFIPv6Validation::test_blocks_domain_with_private_ipv6_record | Hosts resolving to any private IPv6 addresses are rejected | DNS private IPv6 blocking | `Pipe._is_safe_url` | pipe_instance_async, monkeypatch | result is False | Medium | [ ] | Tests DNS IPv6 block | |
| TestSSRFIPv6Validation::test_allows_domain_with_public_ips_only | Hosts resolving exclusively to public IPv4/IPv6 addresses pass the guard | Public IP DNS allowance | `Pipe._is_safe_url` | pipe_instance_async, monkeypatch | result is True | Medium | [ ] | Tests public DNS | |
| TestRemoteFileLimitResolution::test_uses_valve_when_rag_disabled | Should use valve when RAG disabled | RAG disabled valve usage | `Pipe._get_effective_remote_file_limit_mb` | pipe_instance, monkeypatch | result == 60 | Medium | [ ] | Tests valve usage | |
| TestRemoteFileLimitResolution::test_caps_to_rag_when_smaller | Should cap to RAG when smaller | RAG cap when smaller | `Pipe._get_effective_remote_file_limit_mb` | pipe_instance, monkeypatch | result == 25 | Medium | [ ] | Tests RAG cap | |
| TestRemoteFileLimitResolution::test_adopts_rag_when_default_and_larger | Should adopt RAG when default and larger | RAG adoption | `Pipe._get_effective_remote_file_limit_mb` | pipe_instance, monkeypatch | result == 120 | Medium | [ ] | Tests RAG adoption | |
| TestRemoteFileLimitResolution::test_respects_custom_limit_when_lower_than_rag | Should respect custom limit when lower than RAG | Custom limit respect | `Pipe._get_effective_remote_file_limit_mb` | pipe_instance, monkeypatch | result == 80 | Medium | [ ] | Tests custom limit | |
| TestRemoteFileLimitResolution::test_falls_back_to_file_max_size_when_rag_missing | Should fall back to FILE_MAX_SIZE when RAG missing | FILE_MAX_SIZE fallback | `Pipe._get_effective_remote_file_limit_mb` | pipe_instance, monkeypatch | result == 180 | Medium | [ ] | Tests FILE_MAX_SIZE | |
| TestRetryHelpers::test_retry_after_seconds_parses_numeric | Should parse numeric Retry-After | Numeric Retry-After parsing | `_retry_after_seconds` | None | 5.0, 0.0, None | Low | [ ] | Tests numeric parsing | |
| TestRetryHelpers::test_retry_after_seconds_parses_http_date | Should parse HTTP date Retry-After | HTTP date parsing | `_retry_after_seconds` | None | delay <= 4.0 | Low | [ ] | Tests date parsing | |
| TestRetryHelpers::test_retry_wait_honors_retry_after | Should honor Retry-After in wait calculation | Retry wait calculation | `_RetryWait` | SimpleNamespace | wait == 5.0 | Low | [ ] | Tests retry wait | |
| TestRetryHelpers::test_classify_retryable_http_error_identifies_425 | Should identify 425 as retryable | 425 retryable classification | `_classify_retryable_http_error` | None | retryable is True, retry_after == 2.0 | Low | [ ] | Tests 425 classification | |
| TestRetryHelpers::test_classify_retryable_http_error_rejects_403 | Should reject 403 as non-retryable | 403 non-retryable classification | `_classify_retryable_http_error` | None | retryable is False | Low | [ ] | Tests 403 classification | |
| TestStorageContext::test_resolve_storage_context_prefers_existing_user | Should prefer existing user | Existing user preference | `Pipe._resolve_storage_context` | pipe_instance, mock_request, mock_user | user is mock_user | Low | [ ] | Tests user preference | |
| TestStorageContext::test_resolve_storage_context_uses_fallback_user | Should use fallback user | Fallback user usage | `Pipe._resolve_storage_context` | pipe_instance, mock_request, AsyncMock | user is fallback_user | Medium | [ ] | Tests fallback user | |
| TestStorageContext::test_resolve_storage_context_without_request | Should handle no request | No request handling | `Pipe._resolve_storage_context` | pipe_instance | request is None, user is None | Low | [ ] | Tests no request | |
| TestImageTransformer::test_image_data_url_saved_to_storage | Base64 images should be re-hosted and emit status updates | Base64 image storage | `Pipe.transform_messages_to_input` | pipe_instance, mock_request, mock_user, sample_image_base64, monkeypatch | image_url == inlined, status emitted | High | [ ] | Tests base64 storage | |
| TestImageTransformer::test_image_remote_url_downloaded_and_saved | Remote URLs are downloaded, uploaded, and statuses emitted | Remote URL processing | `Pipe.transform_messages_to_input` | pipe_instance, mock_request, mock_user, monkeypatch | image_url == inlined, download called | High | [ ] | Tests remote URL | |
| TestImageTransformer::test_image_detail_level_preserved | Explicit detail selection should survive transformation | Detail level preservation | `Pipe.transform_messages_to_input` | pipe_instance, mock_request, mock_user, monkeypatch | detail == "low" | Medium | [ ] | Tests detail level | |
| TestImageTransformer::test_internal_file_url_inlined_to_data_url | Internal OWUI URLs should be converted to data URLs to satisfy providers | Internal URL inlining | `Pipe.transform_messages_to_input` | pipe_instance, mock_request, mock_user, tmp_path, monkeypatch | image_url starts with data: | Medium | [ ] | Tests internal URL | |
| TestImageTransformer::test_internal_file_url_missing_is_dropped | Missing OWUI file ids should not be sent upstream as internal URLs | Missing file handling | `Pipe.transform_messages_to_input` | pipe_instance, mock_request, mock_user, monkeypatch | image_block is None | Medium | [ ] | Tests missing file | |
| TestImageTransformer::test_image_error_returns_empty_block | Errors while processing images should not leak exceptions | Image error handling | `Pipe.transform_messages_to_input` | pipe_instance, mock_request, mock_user, monkeypatch | image_url == original, detail == "auto" | Medium | [ ] | Tests error handling | |
| TestFileTransformer::test_file_remote_url_downloaded_and_saved | Remote file_url inputs should be downloaded and re-hosted in OWUI | Remote file processing | `Pipe.transform_messages_to_input` | pipe_instance, mock_request, mock_user, monkeypatch | file_id == stored_id, download called | High | [ ] | Tests remote file | |
| TestFileTransformer::test_file_remote_url_passthrough_when_disabled | Remote file_url should pass through when valve disabled | Valve disabled passthrough | `Pipe.transform_messages_to_input` | pipe_instance, mock_request, mock_user, monkeypatch | file_url unchanged, download not called | Medium | [ ] | Tests valve disabled | |
| TestFileTransformer::test_file_remote_url_warns_when_download_returns_none | Should warn when download returns None | Download failure warning | `Pipe.transform_messages_to_input` | pipe_instance, mock_request, mock_user, monkeypatch | file_url unchanged, notification called | Medium | [ ] | Tests download failure | |
| TestFileTransformer::test_file_data_remote_url_moves_to_file_url_when_download_returns_none | Should move file_data URL to file_url when download fails | File_data failure handling | `Pipe.transform_messages_to_input` | pipe_instance, mock_request, mock_user, monkeypatch | file_url == remote_url, file_data removed | Medium | [ ] | Tests file_data failure | |
| TestAudioTransformer::test_audio_already_correct_format_passthrough | Should pass through audio already in Responses API format after validation | Audio passthrough | `Pipe.transform_messages_to_input` | pipe_instance, mock_request, mock_user, sample_audio_base64 | data and format preserved | Low | [ ] | Tests audio passthrough | |
| TestAudioTransformer::test_audio_chat_completions_format_converted | Should convert Chat Completions-style audio payloads | Chat Completions audio conversion | `Pipe.transform_messages_to_input` | pipe_instance, mock_request, mock_user, sample_audio_base64 | data and format correct | Medium | [ ] | Tests CC audio | |
| TestAudioTransformer::test_audio_tool_output_format_converted | Should convert Open WebUI tool audio output format using mimeType | Tool audio conversion | `Pipe.transform_messages_to_input` | pipe_instance, mock_request, mock_user, sample_audio_base64 | format == "wav" | Medium | [ ] | Tests tool audio | |
| TestAudioTransformer::test_audio_mime_type_to_format_mapping[audio/mpeg-mp3] | Should correctly map audio/mpeg to mp3 | MIME to format mapping | `Pipe.transform_messages_to_input` | pipe_instance, mock_request, mock_user, sample_audio_base64 | format == expected | Low | [ ] | Tests MIME mapping | |
| TestAudioTransformer::test_audio_mime_type_to_format_mapping[audio/mp3-mp3] | Should correctly map audio/mp3 to mp3 | MIME to format mapping | `Pipe.transform_messages_to_input` | pipe_instance, mock_request, mock_user, sample_audio_base64 | format == expected | Low | [ ] | Tests MIME mapping | |
| TestAudioTransformer::test_audio_mime_type_to_format_mapping[audio/wav-wav] | Should correctly map audio/wav to wav | MIME to format mapping | `Pipe.transform_messages_to_input` | pipe_instance, mock_request, mock_user, sample_audio_base64 | format == expected | Low | [ ] | Tests MIME mapping | |
| TestAudioTransformer::test_audio_mime_type_to_format_mapping[audio/wave-wav] | Should correctly map audio/wave to wav | MIME to format mapping | `Pipe.transform_messages_to_input` | pipe_instance, mock_request, mock_user, sample_audio_base64 | format == expected | Low | [ ] | Tests MIME mapping | |
| TestAudioTransformer::test_audio_mime_type_to_format_mapping[audio/x-wav-wav] | Should correctly map audio/x-wav to wav | MIME to format mapping | `Pipe.transform_messages_to_input` | pipe_instance, mock_request, mock_user, sample_audio_base64 | format == expected | Low | [ ] | Tests MIME mapping | |
| TestAudioTransformer::test_audio_mime_type_to_format_mapping[audio/unknown-mp3] | Should default unknown audio to mp3 | Unknown MIME default | `Pipe.transform_messages_to_input` | pipe_instance, mock_request, mock_user, sample_audio_base64 | format == expected | Low | [ ] | Tests unknown MIME | |
| TestAudioTransformer::test_audio_mime_type_to_format_mapping[None-mp3] | Should default None MIME to mp3 | None MIME default | `Pipe.transform_messages_to_input` | pipe_instance, mock_request, mock_user, sample_audio_base64 | format == expected | Low | [ ] | Tests None MIME | |
| TestAudioTransformer::test_audio_invalid_payload_returns_empty_block | Should return empty audio block for malformed payloads | Malformed payload handling | `Pipe.transform_messages_to_input` | pipe_instance, mock_request, mock_user | data == "", format == "mp3" | Low | [ ] | Tests malformed audio | |
| TestAudioTransformer::test_audio_error_returns_minimal_block | Should swallow exceptions and return minimal block | Audio error handling | `Pipe.transform_messages_to_input` | pipe_instance, mock_request, mock_user, sample_audio_base64, monkeypatch | data == "", format == "mp3" | Medium | [ ] | Tests audio error | |
| TestAudioTransformer::test_audio_data_url_supported | Should parse and accept audio data URLs | Audio data URL support | `Pipe.transform_messages_to_input` | pipe_instance, mock_request, mock_user, sample_audio_base64 | data and format correct | Low | [ ] | Tests audio data URL | |
| TestAudioTransformer::test_audio_rejects_remote_urls | Should reject remote URLs to match OpenRouter requirements | Remote URL rejection | `Pipe.transform_messages_to_input` | pipe_instance, mock_request, mock_user | data == "", format == "mp3" | Low | [ ] | Tests remote audio rejection | |
| TestAudioTransformer::test_audio_partial_dict_without_format | Should derive format for dict payloads missing explicit format | Format derivation | `Pipe.transform_messages_to_input` | pipe_instance, mock_request, mock_user, sample_audio_base64 | format == "wav" | Low | [ ] | Tests format derivation | |
| TestConversationRebuild::test_transform_messages_prunes_artifacts_and_reuses_images | Should prune artifacts and reuse images | Conversation rebuild | `Pipe.transform_messages_to_input` | pipe_instance, sample_image_base64, monkeypatch | artifacts pruned, images reused | High | [ ] | Tests conversation rebuild | |
| TestMultimodalIntegration::test_combined_text_image_file | Should handle message with text, image, and file | Combined multimodal | `Pipe.transform_messages_to_input` | pipe_instance, mock_request, mock_user, sample_image_base64, monkeypatch | all block types correct | High | [ ] | Tests combined inputs | |
| TestMultimodalIntegration::test_combined_text_audio_image | Should handle message with text, audio, and image | Combined text/audio/image | `Pipe.transform_messages_to_input` | pipe_instance, mock_request, mock_user, sample_audio_base64, monkeypatch | all block types correct | High | [ ] | Tests combined inputs | |
| TestMultimodalIntegration::test_multiple_images_in_message | Should handle multiple images in single message | Multiple images | `Pipe.transform_messages_to_input` | pipe_instance, mock_request, mock_user, sample_image_base64, monkeypatch | both images processed | High | [ ] | Tests multiple images | |
| TestMultimodalIntegration::test_error_in_one_block_does_not_crash_others | Should process other blocks even if one fails | Error isolation | `Pipe.transform_messages_to_input` | pipe_instance, mock_request, mock_user, monkeypatch | both blocks present, file processed | High | [ ] | Tests error isolation | |
| TestSSRFBlockingSpecificIPTypes::test_blocks_loopback_ipv4_directly | Should block loopback 127.x.x.x addresses | Direct loopback blocking | `Pipe._is_safe_url_blocking` | pipe_instance | result is False | Low | [ ] | Tests loopback | |
| TestSSRFBlockingSpecificIPTypes::test_blocks_link_local_ipv4_directly | Should block link-local 169.254.x.x addresses | Direct link-local blocking | `Pipe._is_safe_url_blocking` | pipe_instance | result is False | Low | [ ] | Tests link-local | |
| TestSSRFBlockingSpecificIPTypes::test_blocks_reserved_class_e_ipv4 | Should block reserved class E (240.0.0.0/4) addresses | Class E blocking | `Pipe._is_safe_url_blocking` | pipe_instance, monkeypatch | result is False | Low | [ ] | Tests class E | |
| TestSSRFBlockingSpecificIPTypes::test_blocks_unspecified_ipv4 | Should block unspecified address 0.0.0.0 | Unspecified IPv4 blocking | `Pipe._is_safe_url_blocking` | pipe_instance, monkeypatch | result is False | Low | [ ] | Tests 0.0.0.0 | |
| TestDownloadRetryTimeoutExceeded::test_download_retry_timeout_exceeded | Should return None when retry timeout is exceeded | Retry timeout exceeded | `Pipe._download_remote_url` | pipe_instance_async, patch httpx.AsyncClient | result is None | Medium | [ ] | Tests retry timeout | |
| TestEnsureStorageUserCacheLock::test_returns_cached_user_inside_lock | Should return cached user when cache is already set | Cache lock behavior | `Pipe._ensure_storage_user` | pipe_instance_async | result is cached_user | Low | [ ] | Tests cache lock | |
| TestSignatureInspectionException::test_handles_type_error_in_signature_inspection | Should handle TypeError when inspecting insert signature | Signature TypeError handling | `Pipe._ensure_storage_user` | pipe_instance_async, multimodal_module patch, inspect patch | result is created_user | Medium | [ ] | Tests signature error | |
| TestFetchImageSVGEdgeCases::test_svg_returns_non_bytes_type | Should return None when cairosvg returns non-bytes type | SVG non-bytes handling | `Pipe._fetch_image_as_data_url` | pipe_instance_async, aiohttp.ClientSession, aioresponses, Mock | result is None | Medium | [ ] | Tests SVG non-bytes | |
| TestFetchImageSVGEdgeCases::test_svg_returns_bytearray | Should convert bytearray to bytes from cairosvg | SVG bytearray conversion | `Pipe._fetch_image_as_data_url` | pipe_instance_async, aiohttp.ClientSession, aioresponses, Mock | result starts with data:image/png;base64, | Medium | [ ] | Tests SVG bytearray | |
| TestFetchImageSVGEdgeCases::test_svg_rasterized_exceeds_size_limit | Should return None when rasterized SVG exceeds size limit | SVG size limit | `Pipe._fetch_image_as_data_url` | pipe_instance_async, aiohttp.ClientSession, aioresponses, Mock | result is None | Medium | [ ] | Tests SVG size | |
| TestFetchMakerProfileNonStringHTML::test_non_string_html_response | Should return None when HTML response is not a string | Non-string HTML handling | `Pipe._fetch_maker_profile_image_url` | pipe_instance_async, MockResponse | result is None | Medium | [ ] | Tests non-string HTML | |
| TestEnsureStorageUserCacheInsideLock::test_concurrent_access_returns_cached_user | Should return cached user when second call finds cache set inside lock | Concurrent cache access | `Pipe._ensure_storage_user` | pipe_instance_async, multimodal_module patch | result is existing_user | Medium | [ ] | Tests concurrent cache | |


## `tests/test_nonstreaming_adapter.py`

| Test Name | Description | What It Tests | Code Under Test | Mocks/Fixtures | Assertions | Drift Risk | Check Done | Codex Notes | Codex TODO |
|-----------|-------------|---------------|-----------------|----------------|------------|------------|------------|-------------|------------|
| `test_pipe_creates_nonstreaming_adapter` | Test that Pipe lazily creates NonStreamingAdapter | Verifies lazy initialization of NonStreamingAdapter via `_ensure_nonstreaming_adapter()` and singleton pattern | `Pipe._ensure_nonstreaming_adapter()`, `Pipe._nonstreaming_adapter` | `pipe_instance` fixture | Asserts adapter is None initially, becomes NonStreamingAdapter instance after first call, same instance returned on second call | LOW - Basic initialization pattern | YES | Tests lazy singleton pattern for adapter creation | None |
| `test_nonstreaming_chat_message_not_dict` | Test _extract_chat_message_text with non-dict message (line 62) | Validates handling of invalid message type (string instead of dict) in chat completions response | `NonStreamingAdapter._extract_chat_message_text()`, line 62 edge case | `pipe_instance_async`, aioresponses mocking OpenRouter API | Asserts response.completed event is generated despite invalid message format | MEDIUM - Depends on API response format | YES | Tests defensive programming for malformed API responses | None |
| `test_nonstreaming_chat_message_content_list` | Test _extract_chat_message_text with list content blocks (lines 66-74) | Tests extraction of text from content array with mixed block types (text, image, missing fields, non-string values) | `NonStreamingAdapter._extract_chat_message_text()`, lines 66-74 | `pipe_instance_async`, aioresponses | Asserts "Hello" and "World" extracted from valid text blocks, other blocks skipped | MEDIUM - Content block format may evolve | YES | Tests content block filtering: only type="text" with string text field extracted, gracefully handles invalid blocks | None |
| `test_nonstreaming_responses_non_dict_output_item` | Test _run_responses skips non-dict items in output (line 91) | Validates filtering of invalid output array items (strings, None) in /responses endpoint | `NonStreamingAdapter._run_responses()`, line 91 | `pipe_instance_async`, aioresponses | Asserts text delta generated from valid dict item, invalid items skipped | MEDIUM - Output array format | YES | Tests defensive filtering: non-dict items in output array are safely skipped | None |
| `test_nonstreaming_responses_special_item_types` | Test _run_responses yields special item types (line 101) | Tests handling of special output item types: reasoning, web_search_call, file_search_call, image_generation_call, local_shell_call | `NonStreamingAdapter._run_responses()`, line 101 | `pipe_instance_async`, aioresponses | Asserts output_item.done events generated for reasoning and web_search_call types | LOW - Well-defined item types | YES | Tests that special item types are properly yielded as events in /responses endpoint | None |
| `test_nonstreaming_responses_function_call` | Test _run_responses handles function_call items | Validates function_call output item processing in /responses endpoint | `NonStreamingAdapter._run_responses()` function_call handling | `pipe_instance_async`, aioresponses | Asserts output_item.added event contains function_call type | LOW - Standard function call format | YES | Tests function_call items in /responses output are properly transformed into events | None |
| `test_nonstreaming_chat_reasoning_details_non_dict_entry` | Test _run_chat skips non-dict reasoning_details entries (line 138) | Tests filtering of invalid reasoning_details array entries (strings, None) | `NonStreamingAdapter._run_chat()`, line 138 | `pipe_instance_async`, aioresponses | Asserts reasoning delta generated from valid entry, invalid entries skipped | MEDIUM - Reasoning format may vary | YES | Tests defensive programming: non-dict reasoning_details entries are safely skipped | None |
| `test_nonstreaming_chat_reasoning_invalid_type` | Test _run_chat skips reasoning entries with invalid/empty type (line 141) | Validates handling of reasoning entries with None, empty string, or non-string type fields | `NonStreamingAdapter._run_chat()`, line 141 | `pipe_instance_async`, aioresponses | Asserts only one reasoning delta from entry with valid type, others skipped | MEDIUM - Type field validation | YES | Tests type field validation: reasoning entries must have non-empty string type | None |
| `test_nonstreaming_chat_reasoning_summary` | Test _run_chat handles reasoning.summary type (lines 154-158) | Tests processing of reasoning.summary entries with whitespace trimming | `NonStreamingAdapter._run_chat()`, lines 154-158 | `pipe_instance_async`, aioresponses | Asserts reasoning_summary_text.done event generated with trimmed summary text | LOW - Standard reasoning summary format | YES | Tests reasoning.summary extraction and whitespace normalization | None |
| `test_nonstreaming_chat_annotations_non_dict_skipped` | Test _run_chat skips non-dict annotations (line 165) | Validates filtering of invalid annotation entries (non-dict values) | `NonStreamingAdapter._run_chat()`, line 165 | `pipe_instance_async`, aioresponses | Asserts one annotation event from valid dict entry, non-dict skipped | MEDIUM - Annotation format | YES | Tests defensive filtering: non-dict annotations array entries are skipped | None |
| `test_nonstreaming_chat_annotations_non_url_citation_skipped` | Test _run_chat skips non url_citation annotations (line 167) | Tests filtering of non-url_citation annotation types (e.g., file_citation) | `NonStreamingAdapter._run_chat()`, line 167 | `pipe_instance_async`, aioresponses | Asserts only url_citation type processed, file_citation skipped | LOW - Well-defined annotation types | YES | Tests type filtering: only url_citation annotations are processed | None |
| `test_nonstreaming_chat_annotations_flat_format` | Test _run_chat handles flat annotation format (lines 173-174) | Tests extraction from flat url_citation format (url/title at top level vs nested in url_citation object) | `NonStreamingAdapter._run_chat()`, lines 173-174 | `pipe_instance_async`, aioresponses | Asserts annotation extracted from flat format with url at top level | MEDIUM - Provider format variations | YES | Tests backward compatibility: handles both nested and flat url_citation formats | None |
| `test_nonstreaming_chat_annotations_empty_url_skipped` | Test _run_chat skips annotations with empty/whitespace URL (line 176) | Validates URL validation: empty string, whitespace, and None URLs are filtered | `NonStreamingAdapter._run_chat()`, line 176 | `pipe_instance_async`, aioresponses | Asserts only annotation with valid URL processed, empty/whitespace/None URLs skipped | LOW - Basic validation | YES | Tests URL validation: annotations must have non-empty, non-whitespace URL | None |
| `test_nonstreaming_chat_annotations_duplicate_urls_skipped` | Test _run_chat skips duplicate annotation URLs (line 179) | Tests deduplication of annotations with same URL | `NonStreamingAdapter._run_chat()`, line 179 | `pipe_instance_async`, aioresponses | Asserts two annotations (one dupe.com, one unique.com), duplicate URL filtered | LOW - Deduplication logic | YES | Tests URL deduplication: multiple annotations with same URL are deduplicated | None |
| `test_nonstreaming_chat_annotations_non_string_title` | Test _run_chat handles non-string title (falls back to URL) (line 184) | Tests title fallback: when title is non-string or whitespace, URL is used as title | `NonStreamingAdapter._run_chat()`, line 184 | `pipe_instance_async`, aioresponses | Asserts title falls back to URL when title is non-string or whitespace | LOW - Defensive fallback | YES | Tests title fallback logic: non-string or empty titles default to URL | None |
| `test_nonstreaming_chat_tool_calls_non_dict_skipped` | Test _run_chat skips non-dict tool calls (line 195) | Validates filtering of invalid tool_calls array entries (non-dict values) | `NonStreamingAdapter._run_chat()`, line 195 | `pipe_instance_async`, aioresponses | Asserts one function call from valid dict entry, non-dict skipped | MEDIUM - Tool calls format | YES | Tests defensive filtering: non-dict tool_calls entries are skipped | None |
| `test_nonstreaming_chat_tool_calls_non_dict_function_skipped` | Test _run_chat skips tool calls with non-dict function (line 198) | Tests filtering of tool calls where function field is not a dict | `NonStreamingAdapter._run_chat()`, line 198 | `pipe_instance_async`, aioresponses | Asserts one function call from entry with valid function dict, invalid skipped | MEDIUM - Function field format | YES | Tests function field validation: tool calls must have function as dict | None |
| `test_nonstreaming_chat_tool_calls_invalid_name_skipped` | Test _run_chat skips tool calls with invalid/empty name (line 201) | Validates name field validation: empty string, None, and non-string names are filtered | `NonStreamingAdapter._run_chat()`, line 201 | `pipe_instance_async`, aioresponses | Asserts one function call from entry with valid name string, others skipped | LOW - Basic validation | YES | Tests name validation: function name must be non-empty string | None |
| `test_nonstreaming_chat_tool_calls_non_string_arguments` | Test _run_chat serializes non-string arguments (line 204) | Tests JSON serialization of non-string arguments (dict, None) | `NonStreamingAdapter._run_chat()`, line 204 | `pipe_instance_async`, aioresponses | Asserts dict arguments serialized to JSON string, None becomes "{}" | MEDIUM - Arguments serialization | YES | Tests arguments normalization: dicts are JSON-serialized, None becomes empty object | None |
| `test_nonstreaming_chat_tool_calls_missing_id` | Test _run_chat generates call_id when missing (lines 207-208) | Tests automatic call_id generation for tool calls with missing, empty, or whitespace id | `NonStreamingAdapter._run_chat()`, lines 207-208 | `pipe_instance_async`, aioresponses | Asserts all three tool calls get generated call_ids containing "toolcall-" | LOW - ID generation logic | YES | Tests ID generation: missing/empty/whitespace IDs are auto-generated with "toolcall-" prefix | None |
| `test_nonstreaming_fallback_from_responses_to_chat` | Test fallback from /responses to /chat/completions (lines 276-285) | Tests automatic endpoint fallback when /responses returns unsupported_model error and AUTO_FALLBACK_CHAT_COMPLETIONS=True | `NonStreamingAdapter` fallback logic, lines 276-285 | `pipe_instance_async`, aioresponses (400 error then 200 success) | Asserts response.completed event generated from fallback /chat/completions call | MEDIUM - Fallback conditions | YES | Tests auto-fallback: /responses errors trigger /chat/completions retry when enabled | None |
| `test_nonstreaming_no_fallback_when_disabled` | Test no fallback when AUTO_FALLBACK_CHAT_COMPLETIONS is disabled | Validates fallback is disabled when AUTO_FALLBACK_CHAT_COMPLETIONS=False | `NonStreamingAdapter` fallback logic with valve disabled | `pipe_instance_async`, aioresponses (400 error) | Asserts OpenRouterAPIError raised, no fallback attempted | LOW - Configuration flag | YES | Tests fallback disable: when valve is False, errors propagate without retry | None |
| `test_nonstreaming_no_fallback_for_non_responses_error` | Test no fallback for errors that don't indicate unsupported responses | Tests that non-unsupported-model errors (e.g., rate_limit_error) don't trigger fallback | `NonStreamingAdapter` fallback logic with rate limit error | `pipe_instance_async`, aioresponses (429 error) | Asserts OpenRouterAPIError raised with status 429, no fallback | LOW - Error type discrimination | YES | Tests fallback selectivity: only unsupported-model errors trigger fallback, not all errors | None |
| `test_nonstreaming_complete_chat_workflow` | Test complete non-streaming workflow with all features | Integration test: validates end-to-end processing of chat response with reasoning, annotations, tool_calls, and usage details | `NonStreamingAdapter._run_chat()` full workflow | `pipe_instance_async`, aioresponses with comprehensive response | Asserts all event types present: reasoning, annotation, tool call, text delta, completed with proper usage | MEDIUM - Full integration | YES | Integration test: validates complete event generation pipeline for /chat/completions with all features | None |
| `test_nonstreaming_responses_complete_workflow` | Test complete non-streaming workflow via /responses endpoint | Integration test: validates end-to-end processing of /responses with reasoning, function_call, and message output items | `NonStreamingAdapter._run_responses()` full workflow | `pipe_instance_async`, aioresponses with comprehensive response | Asserts output_item.done events for reasoning and function_call, text deltas, and completed event | MEDIUM - Full integration | YES | Integration test: validates complete event generation pipeline for /responses endpoint with multiple output item types | None |


## `tests/test_openrouter_compliance.py`

| Test Name | Description | What It Tests | Code Under Test | Mocks/Fixtures | Assertions | Drift Risk | Check Done | Codex Notes | Codex TODO |
|-----------|-------------|---------------|-----------------|----------------|------------|------------|------------|-------------|------------|
| test_supported_image_formats_are_inlined[image/png] | All documented OpenRouter image formats should survive the transform pipeline. | Verifies PNG images with data URI are correctly transformed to input_image type and inlined via OWUI storage. | `Pipe.transform_messages_to_input()`, `Pipe._resolve_storage_context()`, `Pipe._upload_to_owui_storage()`, `Pipe._inline_owui_file_id()` | `pipe_instance`, `mock_request`, `mock_user`, `sample_image_base64`, `monkeypatch`; mocks `_resolve_storage_context`, `_upload_to_owui_storage`, `_inline_owui_file_id` | `result["type"] == "input_image"`, `result["image_url"]` equals expected inline value, `_inline_owui_file_id` was awaited once | Medium - OpenRouter image format support may change | [ ] | Parametrized test covering image/png MIME type | Verify OpenRouter still supports PNG format |
| test_supported_image_formats_are_inlined[image/jpeg] | All documented OpenRouter image formats should survive the transform pipeline. | Verifies JPEG images with data URI are correctly transformed to input_image type and inlined via OWUI storage. | `Pipe.transform_messages_to_input()`, `Pipe._resolve_storage_context()`, `Pipe._upload_to_owui_storage()`, `Pipe._inline_owui_file_id()` | `pipe_instance`, `mock_request`, `mock_user`, `sample_image_base64`, `monkeypatch`; mocks `_resolve_storage_context`, `_upload_to_owui_storage`, `_inline_owui_file_id` | `result["type"] == "input_image"`, `result["image_url"]` equals expected inline value, `_inline_owui_file_id` was awaited once | Medium - OpenRouter image format support may change | [ ] | Parametrized test covering image/jpeg MIME type | Verify OpenRouter still supports JPEG format |
| test_supported_image_formats_are_inlined[image/webp] | All documented OpenRouter image formats should survive the transform pipeline. | Verifies WebP images with data URI are correctly transformed to input_image type and inlined via OWUI storage. | `Pipe.transform_messages_to_input()`, `Pipe._resolve_storage_context()`, `Pipe._upload_to_owui_storage()`, `Pipe._inline_owui_file_id()` | `pipe_instance`, `mock_request`, `mock_user`, `sample_image_base64`, `monkeypatch`; mocks `_resolve_storage_context`, `_upload_to_owui_storage`, `_inline_owui_file_id` | `result["type"] == "input_image"`, `result["image_url"]` equals expected inline value, `_inline_owui_file_id` was awaited once | Medium - OpenRouter image format support may change | [ ] | Parametrized test covering image/webp MIME type | Verify OpenRouter still supports WebP format |
| test_supported_image_formats_are_inlined[image/gif] | All documented OpenRouter image formats should survive the transform pipeline. | Verifies GIF images with data URI are correctly transformed to input_image type and inlined via OWUI storage. | `Pipe.transform_messages_to_input()`, `Pipe._resolve_storage_context()`, `Pipe._upload_to_owui_storage()`, `Pipe._inline_owui_file_id()` | `pipe_instance`, `mock_request`, `mock_user`, `sample_image_base64`, `monkeypatch`; mocks `_resolve_storage_context`, `_upload_to_owui_storage`, `_inline_owui_file_id` | `result["type"] == "input_image"`, `result["image_url"]` equals expected inline value, `_inline_owui_file_id` was awaited once | Medium - OpenRouter image format support may change | [ ] | Parametrized test covering image/gif MIME type | Verify OpenRouter still supports GIF format |
| test_supported_audio_formats_map_correctly[block0-mp3] | OpenRouter accepts only wav/mp3 audio and we enforce the same. | Verifies input_audio block with mp3 format is correctly transformed, preserving format and data. | `Pipe.transform_messages_to_input()`, `Pipe._emit_error()` | `pipe_instance`, `mock_request`, `mock_user`, `sample_audio_base64`, `monkeypatch`; mocks `_emit_error` | `result["type"] == "input_audio"`, `result["input_audio"]["data"]` matches sample, `result["input_audio"]["format"] == "mp3"`, `_emit_error` not awaited | Medium - OpenRouter audio format requirements may evolve | [ ] | Tests input_audio block format with explicit mp3 format | Verify OpenRouter audio spec unchanged |
| test_supported_audio_formats_map_correctly[block1-wav] | OpenRouter accepts only wav/mp3 audio and we enforce the same. | Verifies audio block with audio/wav MIME type is correctly mapped to wav format. | `Pipe.transform_messages_to_input()`, `Pipe._emit_error()` | `pipe_instance`, `mock_request`, `mock_user`, `sample_audio_base64`, `monkeypatch`; mocks `_emit_error` | `result["type"] == "input_audio"`, `result["input_audio"]["data"]` matches sample, `result["input_audio"]["format"] == "wav"`, `_emit_error` not awaited | Medium - OpenRouter audio format requirements may evolve | [ ] | Tests audio block with mimeType audio/wav conversion | Verify OpenRouter audio spec unchanged |
| test_supported_audio_formats_map_correctly[block2-mp3] | OpenRouter accepts only wav/mp3 audio and we enforce the same. | Verifies audio block with audio/mp3 MIME type is correctly mapped to mp3 format. | `Pipe.transform_messages_to_input()`, `Pipe._emit_error()` | `pipe_instance`, `mock_request`, `mock_user`, `sample_audio_base64`, `monkeypatch`; mocks `_emit_error` | `result["type"] == "input_audio"`, `result["input_audio"]["data"]` matches sample, `result["input_audio"]["format"] == "mp3"`, `_emit_error` not awaited | Medium - OpenRouter audio format requirements may evolve | [ ] | Tests audio block with mimeType audio/mp3 conversion | Verify OpenRouter audio spec unchanged |
| test_audio_requires_base64_not_urls | Remote URLs should be rejected per OpenRouter's audio spec. | Verifies that audio blocks with URLs instead of base64 data are rejected with an error emitted. | `Pipe.transform_messages_to_input()`, `Pipe._emit_error()` | `pipe_instance`, `mock_request`, `mock_user`; mocks `_emit_error` | `result["type"] == "input_audio"`, `result["input_audio"]["data"] == ""`, `_emit_error.await_count == 1` | Low - URL rejection is a security/compliance requirement unlikely to change | [ ] | Tests that audio URLs are rejected (base64 only per OpenRouter spec) | None |
| test_file_size_limit_enforced | Large base64 payloads must be rejected to honor OpenRouter limits. | Verifies the _validate_base64_size method correctly accepts small payloads and rejects oversized ones based on BASE64_MAX_SIZE_MB valve. | `Pipe._validate_base64_size()`, `Pipe.valves.BASE64_MAX_SIZE_MB` | `pipe_instance` (no mocks needed) | `_validate_base64_size(small_payload)` returns True, `_validate_base64_size(large_payload)` returns False | Medium - OpenRouter file size limits may change | [ ] | Tests 256KB passes and 2MB fails with 1MB limit | Track OpenRouter size limit changes |


## `tests/test_orchestrator.py`

| Test Name | Description | What It Tests | Code Under Test | Mocks/Fixtures | Assertions | Drift Risk | Check Done | Codex Notes | Codex TODO |
|-----------|-------------|---------------|-----------------|----------------|------------|------------|------------|-------------|------------|
| `test_empty_data_returns_empty_bytes` | Empty input data should return empty bytes (line 147) | Tests that empty base64 data from audio attachments returns empty bytes and fails gracefully | `RequestOrchestrator.process_request()` with `_decode_base64_prefix()` for audio attachments | `orchestrator_and_pipe`, `mock_valves`, `mock_session`, `base_request_body`, `pipe._get_file_by_id`, `pipe._read_file_record_base64`, `pipe._emit_templated_error` | `assert result == ""`, `pipe._emit_templated_error.assert_called()` | Medium - base64 decoding edge case, could drift if error handling changes | Yes | Covers edge case where audio attachment has empty base64 data, triggering line 147 in _decode_base64_prefix | Ensure error message template is validated |
| `test_invalid_base64_chars_in_prefix` | Non-base64 characters in prefix should return empty bytes and use declared format (line 160) | Tests that invalid base64 with unicode chars causes sniff to fail but falls back to declared format | `RequestOrchestrator.process_request()` with invalid base64 but declared format in audio metadata | `orchestrator_and_pipe`, `mock_valves`, `mock_session`, `base_request_body`, mock Pipe methods, invalid base64 string with unicode | `assert result == "Test response"` | Medium - base64 validation fallback behavior, could drift if validation logic changes | Yes | Validates fallback to declared format when base64 sniffing fails due to invalid characters | Test with more unicode edge cases |
| `test_file_attachment_with_invalid_id_skipped` | File attachments with non-string or empty id should be skipped (line 197) | Tests that file attachments with None, int, empty string, or whitespace-only IDs are skipped | `RequestOrchestrator.process_request()` file attachment validation | `orchestrator_and_pipe`, `mock_valves`, `mock_session`, `base_request_body`, mock Pipe methods, metadata with invalid file IDs | `assert result == "Test response"` | Low - ID validation is stable, unlikely to change | Yes | Tests skip path for invalid file IDs (None, 123, "", "  ") at line 197 | Verify no partial processing occurs |
| `test_audio_attachment_with_invalid_id_skipped` | Audio attachments with non-string or empty id should be skipped (line 229) | Tests that audio attachments with None or empty string IDs are skipped | `RequestOrchestrator.process_request()` audio attachment validation | `orchestrator_and_pipe`, `mock_valves`, `mock_session`, `base_request_body`, mock Pipe methods, metadata with invalid audio IDs | `assert result == "Test response"` | Low - ID validation is stable | Yes | Tests skip path for invalid audio IDs (None, "") at line 229 | None |
| `test_video_attachment_with_invalid_id_skipped` | Video attachments with non-string or empty id should be skipped (line 255) | Tests that video attachments with None or int IDs are skipped | `RequestOrchestrator.process_request()` video attachment validation | `orchestrator_and_pipe`, `mock_valves`, `mock_session`, `base_request_body`, mock Pipe methods, metadata with invalid video IDs | `assert result == "Test response"` | Low - ID validation is stable | Yes | Tests skip path for invalid video IDs (None, "", 456) at line 255 | None |
| `test_csv_set_with_non_string_returns_empty_set` | Non-string input to _csv_set should return empty set (line 213) | Tests that non-string value (int) for CSV parsing returns empty set | `RequestOrchestrator.process_request()` with `_csv_set()` helper for audio allowlist | `orchestrator_and_pipe`, `mock_valves`, `mock_session`, `base_request_body`, mock Pipe methods, metadata with non-string allowlist (12345) | `assert result == "Test response"` | Low - CSV parsing helper is stable | Yes | Tests _csv_set edge case with non-string input (int 12345) at line 213 | None |
| `test_extra_tools_exception_caught` | Exception when accessing extra_tools should be caught (lines 556-557) | Tests that exceptions when accessing extra_tools property are handled gracefully | `RequestOrchestrator.process_request()` extra_tools access | `orchestrator_and_pipe`, `mock_valves`, `mock_session`, `base_request_body`, mock Pipe methods, patched CompletionsBody with failing extra_tools property | `assert result == "Test response"` | Medium - error handling around CompletionsBody validation could drift | Yes | Validates exception handling when extra_tools property raises RuntimeError at lines 556-557 | Add more exception types |
| `test_tool_renames_logged_when_debug_enabled` | Tool renames should be logged when DEBUG level is enabled (line 624) | Tests that tool renaming for collision avoidance is logged at DEBUG level | `RequestOrchestrator.process_request()` with tool collision handling | `orchestrator_and_pipe`, `mock_valves`, `mock_session`, `base_request_body`, mock Pipe methods, patched `_build_collision_safe_tool_specs_and_registry`, DEBUG logging enabled | `assert result == "Test response"` | Low - logging behavior is stable | Yes | Tests debug logging of tool renames at line 624 | Verify log message format |
| `test_web_search_skipped_with_minimal_effort` | Web search should be skipped when reasoning effort is 'minimal' (lines 642-646) | Tests that web search plugin is not added when REASONING_EFFORT is 'minimal' | `RequestOrchestrator.process_request()` with web search plugin configuration | `orchestrator_and_pipe`, `mock_valves.REASONING_EFFORT = "minimal"`, `mock_session`, `base_request_body`, mock Pipe methods, patched ModelFamily | `assert result == "Test response"` | Medium - web search configuration logic could change | Yes | Validates web search is skipped when reasoning effort is 'minimal' at lines 642-646 | Verify feature flag interaction |
| `test_web_search_added_with_non_minimal_effort` | Web search should be added when reasoning effort is not 'minimal' (lines 647-653) | Tests that web search plugin is added when REASONING_EFFORT is 'medium' | `RequestOrchestrator.process_request()` with web search plugin configuration | `orchestrator_and_pipe`, `mock_valves.REASONING_EFFORT = "medium"`, `mock_valves.WEB_SEARCH_MAX_RESULTS = 10`, `mock_session`, `base_request_body`, mock Pipe methods, patched ModelFamily | `assert result == "Test response"`, verify plugins contain web search | Medium - web search configuration logic could change | Yes | Validates web search plugin is added with max_results when effort is not minimal at lines 647-653 | Test other effort levels |
| `test_anthropic_prompt_cache_retry` | Anthropic prompt cache error should trigger retry without cache_control (lines 694-708) | Tests retry logic when OpenRouterAPIError contains prompt caching error for Anthropic models | `RequestOrchestrator.process_request()` error retry with cache_control stripping | `orchestrator_and_pipe`, `mock_valves.ENABLE_ANTHROPIC_PROMPT_CACHING = True`, `mock_session`, `base_request_body`, mock Pipe methods, patched Pipe class with cache_control methods | `assert result == "Test response after retry"`, `assert call_count[0] == 2` | High - retry logic for Anthropic prompt caching is complex and version-dependent | Yes | Tests retry path when prompt caching fails at lines 694-708, verifies cache_control is stripped on retry | Verify cache_control stripping actually occurs |
| `test_reasoning_effort_retry` | Reasoning effort error should trigger retry with fallback effort (lines 710-755) | Tests retry logic when reasoning.effort value is unsupported by the model | `RequestOrchestrator.process_request()` error retry with reasoning effort adjustment | `orchestrator_and_pipe`, `mock_valves`, `mock_session`, `base_request_body`, mock Pipe methods, event_emitter mock | `assert result == "Test response after retry"`, `assert call_count[0] == 2`, `event_emitter.assert_called()` | High - reasoning effort retry logic is complex and model-specific | Yes | Tests retry when upstream rejects reasoning.effort 'high', validates fallback to lower effort at lines 710-755 | Verify status message content |
| `test_reasoning_retry_without_reasoning` | Error that should retry without reasoning (lines 757-762) | Tests retry logic that removes reasoning entirely when model doesn't support it | `RequestOrchestrator.process_request()` error retry removing reasoning | `orchestrator_and_pipe`, `mock_valves`, `mock_session`, `base_request_body`, mock Pipe methods, `pipe._should_retry_without_reasoning = True` | `assert result == "Test response after retry"`, `assert call_count[0] == 2` | High - retry condition logic could drift with new model capabilities | Yes | Tests retry path that removes reasoning entirely when model doesn't support it at lines 757-762 | Verify reasoning is actually removed |
| `test_error_reported_when_no_retry_applicable` | Error should be reported when no retry is applicable (lines 764-771) | Tests that errors not eligible for retry are reported via _report_openrouter_error | `RequestOrchestrator.process_request()` error reporting | `orchestrator_and_pipe`, `mock_valves`, `mock_session`, `base_request_body`, mock Pipe methods, `pipe._should_retry_without_reasoning = False`, `pipe._report_openrouter_error` | `assert result == ""`, `pipe._report_openrouter_error.assert_called_once()` | Medium - error reporting path is stable but could add new error types | Yes | Tests error reporting when no retry conditions apply at lines 764-771 | Verify error template rendering |
| `test_event_emitter_error_caught_on_status_update` | Event emitter errors should be caught when emitting status update (line 747-748) | Tests that exceptions from event emitter during status update don't break retry flow | `RequestOrchestrator.process_request()` with failing event emitter | `orchestrator_and_pipe`, `mock_valves`, `mock_session`, `base_request_body`, mock Pipe methods, failing_event_emitter that raises RuntimeError | `assert result == "Test response after retry"`, `assert call_count[0] == 2` | Medium - exception handling around event emitter could drift | Yes | Validates exception handling when event emitter fails during status update at lines 747-748 | Test other emitter failures |
| `test_nonstreaming_request` | Non-streaming requests should use _run_nonstreaming_loop (lines 679-691) | Tests that requests with stream=False use the non-streaming code path | `RequestOrchestrator.process_request()` non-streaming path | `orchestrator_and_pipe`, `mock_valves`, `mock_session`, `base_request_body` with `stream=False`, mock Pipe methods, `pipe._run_nonstreaming_loop`, `pipe._run_streaming_loop` | `assert result == {"result": "complete"}`, `pipe._run_nonstreaming_loop.assert_called_once()`, `pipe._run_streaming_loop.assert_not_called()` | Low - streaming vs non-streaming routing is stable | Yes | Tests non-streaming path selection at lines 679-691 | None |
| `test_sniff_wav_format` | WAV format should be sniffed from RIFF header | Tests audio format sniffing for WAV files via RIFF header | `RequestOrchestrator.process_request()` with `_sniff_audio_format()` for WAV | `orchestrator_and_pipe`, `mock_valves`, `mock_session`, `base_request_body`, mock Pipe methods, base64-encoded WAV header (RIFF...WAVE) | `assert result == "Test response"` | Low - format sniffing magic bytes are stable | Yes | Tests WAV format detection via RIFF...WAVE header | None |
| `test_sniff_mp3_id3_format` | MP3 with ID3 header should be sniffed | Tests audio format sniffing for MP3 files with ID3 tags | `RequestOrchestrator.process_request()` with `_sniff_audio_format()` for MP3 ID3 | `orchestrator_and_pipe`, `mock_valves`, `mock_session`, `base_request_body`, mock Pipe methods, base64-encoded MP3 ID3 header | `assert result == "Test response"` | Low - format sniffing magic bytes are stable | Yes | Tests MP3 format detection via ID3 tag | None |
| `test_sniff_mp3_sync_frame` | MP3 sync frame should be sniffed | Tests audio format sniffing for MP3 files with sync frame | `RequestOrchestrator.process_request()` with `_sniff_audio_format()` for MP3 sync | `orchestrator_and_pipe`, `mock_valves`, `mock_session`, `base_request_body`, mock Pipe methods, base64-encoded MP3 sync frame (0xFF 0xFB) | `assert result == "Test response"` | Low - format sniffing magic bytes are stable | Yes | Tests MP3 format detection via MPEG-1 Layer 3 sync frame | None |
| `test_sniff_m4a_format` | M4A (ISO BMFF) format should be sniffed from ftyp marker | Tests audio format sniffing for M4A files | `RequestOrchestrator.process_request()` with `_sniff_audio_format()` for M4A | `orchestrator_and_pipe`, `mock_valves`, `mock_session`, `base_request_body`, mock Pipe methods, base64-encoded M4A ftyp header | `assert result == "Test response"` | Low - format sniffing magic bytes are stable | Yes | Tests M4A format detection via ISO BMFF ftyp marker | None |
| `test_sniff_flac_format` | FLAC format should be sniffed from fLaC magic bytes | Tests audio format sniffing for FLAC files | `RequestOrchestrator.process_request()` with `_sniff_audio_format()` for FLAC | `orchestrator_and_pipe`, `mock_valves`, `mock_session`, `base_request_body`, mock Pipe methods, base64-encoded FLAC header | `assert result == "Test response"` | Low - format sniffing magic bytes are stable | Yes | Tests FLAC format detection via fLaC magic bytes | None |
| `test_sniff_ogg_format` | OGG format should be sniffed from OggS magic bytes | Tests audio format sniffing for OGG files | `RequestOrchestrator.process_request()` with `_sniff_audio_format()` for OGG | `orchestrator_and_pipe`, `mock_valves`, `mock_session`, `base_request_body`, mock Pipe methods, base64-encoded OGG header | `assert result == "Test response"` | Low - format sniffing magic bytes are stable | Yes | Tests OGG format detection via OggS magic bytes | None |
| `test_sniff_webm_format` | WebM format should be sniffed from EBML magic bytes | Tests audio format sniffing for WebM files | `RequestOrchestrator.process_request()` with `_sniff_audio_format()` for WebM | `orchestrator_and_pipe`, `mock_valves`, `mock_session`, `base_request_body`, mock Pipe methods, base64-encoded WebM/Matroska EBML header | `assert result == "Test response"` | Low - format sniffing magic bytes are stable | Yes | Tests WebM format detection via EBML magic bytes | None |
| `test_tools_registry_as_list_with_spec` | Tools registry as list with spec objects should be processed | Tests tool registry handling when provided as list instead of dict | `RequestOrchestrator.process_request()` with tools as list | `orchestrator_and_pipe`, `mock_valves`, `mock_session`, `base_request_body`, mock Pipe methods, tools_list with mixed spec formats | `assert result == "Test response"` | Medium - tools registry handling could change with new tool formats | Yes | Tests tools registry list handling at lines 570-578, validates spec extraction and filtering | Verify tool name extraction logic |
| `test_reasoning_initialized_when_not_dict` | Reasoning should be initialized as dict when None (lines 750-751) | Tests that reasoning field is initialized as dict during retry when originally None | `RequestOrchestrator.process_request()` with reasoning effort retry | `orchestrator_and_pipe`, `mock_valves`, `mock_session`, `base_request_body`, mock Pipe methods, captured_body validation | `assert result == "Test response after retry"`, `assert call_count[0] == 2`, verify reasoning is dict with effort | Medium - reasoning initialization logic could drift | Yes | Tests reasoning initialization from None to dict during retry at lines 750-751 | None |
| `test_empty_base64_data` | Empty base64 data should return empty bytes (line 147) | Tests that empty base64 string returns empty bytes and fails when no format declared | `RequestOrchestrator.process_request()` with `_decode_base64_prefix()` | `orchestrator_and_pipe`, `mock_valves`, `mock_session`, `base_request_body`, mock Pipe methods, empty base64 string | `assert result == ""`, `pipe._emit_templated_error.assert_called()` | Low - empty string handling is stable | Yes | Duplicate coverage of line 147 with empty base64 and no declared format | Consolidate with first test |
| `test_base64_with_corrupted_data_fallback_decode` | Base64 with slightly corrupted padding triggers fallback decode (lines 165-169) | Tests fallback decode path when validate=True fails | `RequestOrchestrator.process_request()` with base64 fallback decode | `orchestrator_and_pipe`, `mock_valves`, `mock_session`, `base_request_body`, mock Pipe methods, valid base64 with declared format | `assert result == "Test response"` | Low - fallback decode is stable | Yes | Tests fallback decode path at lines 165-169 when validate=True decode fails | Trigger actual validation failure |
| `test_file_with_mixed_valid_and_invalid_ids` | Mix of valid and invalid file IDs - valid ones should be processed (line 197) | Tests that file attachment loop correctly skips invalid IDs and processes valid ones | `RequestOrchestrator.process_request()` file attachment filtering | `orchestrator_and_pipe`, `mock_valves`, `mock_session`, `base_request_body`, mock Pipe methods, metadata with mixed valid/invalid file IDs | `assert result == "Test response"` | Low - ID filtering is stable | Yes | Tests continue statement at line 197 with mixed valid/invalid file IDs | None |
| `test_audio_with_only_invalid_ids` | Only invalid audio IDs - all should be skipped (line 229) | Tests that all invalid audio attachments are skipped | `RequestOrchestrator.process_request()` audio attachment filtering | `orchestrator_and_pipe`, `mock_valves`, `mock_session`, `base_request_body`, mock Pipe methods, metadata with only invalid audio IDs | `assert result == "Test response"` | Low - ID filtering is stable | Yes | Tests continue statement at line 229 with all invalid audio IDs (None, "", 123) | None |
| `test_video_with_only_invalid_ids` | Only invalid video IDs - all should be skipped (line 255) | Tests that all invalid video attachments are skipped | `RequestOrchestrator.process_request()` video attachment filtering | `orchestrator_and_pipe`, `mock_valves`, `mock_session`, `base_request_body`, mock Pipe methods, metadata with only invalid video IDs | `assert result == "Test response"` | Low - ID filtering is stable | Yes | Tests continue statement at line 255 with all invalid video IDs (None, "", 999) | None |
| `test_csv_set_with_non_string_value` | Non-string value in _csv_set returns empty set (line 213) | Tests _csv_set helper with None value for audio format allowlist | `RequestOrchestrator.process_request()` with `_csv_set()` | `orchestrator_and_pipe`, `mock_valves`, `mock_session`, `base_request_body`, mock Pipe methods, metadata with None allowlist | `assert result == "Test response"` | Low - CSV parsing is stable | Yes | Tests _csv_set with None value at line 213 | None |
| `test_reasoning_effort_retry_no_emitter` | Reasoning effort retry should work without event emitter (line 715 path) | Tests reasoning effort retry when __event_emitter__ is None | `RequestOrchestrator.process_request()` with reasoning effort retry, no event emitter | `orchestrator_and_pipe`, `mock_valves`, `mock_session`, `base_request_body`, mock Pipe methods, no event_emitter | `assert result == "Test response after retry"`, `assert call_count[0] == 2` | Medium - null check path could drift | Yes | Tests line 715 path where event_emitter is None during reasoning effort retry | None |
| `test_reasoning_effort_retry_with_existing_dict_reasoning` | Reasoning effort retry when responses_body.reasoning is already a dict (line 715) | Tests reasoning effort extraction when reasoning is already dict on first attempt | `RequestOrchestrator.process_request()` with reasoning effort retry, reasoning as dict | `orchestrator_and_pipe`, `mock_valves`, `mock_session`, `base_request_body`, mock Pipe methods, reasoning set to dict before failure | `assert result == "Test response after retry"`, `assert call_count[0] == 2` | Medium - reasoning dict handling could drift | Yes | Tests line 715 path where reasoning is already a dict with effort field, validates original_effort extraction | None |


## `tests/test_owui.py`

| Test Name | Description | What It Tests | Code Under Test | Mocks/Fixtures | Assertions | Drift Risk | Check Done | Codex Notes | Codex TODO |
|-----------|-------------|---------------|-----------------|----------------|------------|------------|------------|-------------|------------|
| `test_owui_metadata_tools_registry_is_used_for_native_tools` | Verifies that OWUI 0.7.x native tools from `__metadata__["tools"]` are properly extracted, passed to OpenRouter API, and executed through the real infrastructure | 1. Tools from `__metadata__["tools"]` are extracted<br>2. Tools passed to OpenRouter API request<br>3. Tool calling infrastructure processes correctly<br>4. Tool execution with real callable functions<br>5. Non-streaming response returns string | `Pipe.pipe()`, `Pipe._create_http_session()`, `OpenRouterModelRegistry` (catalog fetch), tool extraction from metadata, tool execution orchestration | `monkeypatch` (env var OPENROUTER_API_KEY), `aioresponses` (mock HTTP for catalog endpoint `/api/v1/models` and responses endpoint `/api/v1/responses` twice), custom async callable `builtin_search_web`, manual registry reset (clear `_models`, `_specs`, `_id_map`, `_last_fetch`) | `assert tool_called` (tool executed), `assert tool_call_args is not None`, `assert tool_call_args["query"] == "hello world"`, `assert result is not None`, `assert isinstance(result, str)` | **HIGH** - OWUI 0.7.x changed tool registry location from `__tools__` to `__metadata__["tools"]`. Test depends on exact metadata structure, Responses API format (`type:"function_call"` with `call_id`, `name`, `arguments`), and tool execution flow. Changes to OWUI tool registry, OpenRouter Responses API, or internal tool orchestration will break this. | Yes | Integration test exercising full tool calling pipeline. Uses Responses API (non-streaming) with function_call output type. Verifies OWUI 0.7.x compatibility. Tool registry cleared before/after to isolate test. Session cleanup in finally block. | Verify OWUI 0.8+ still uses metadata["tools"]. Monitor OpenRouter Responses API changes. Consider extracting tool execution assertions to helper function. |
| `test_claim_pipe_model_metadata_sync_merges_existing_capabilities` | Verifies the pipe preserves existing OWUI-only capability keys (`builtin_tools`, `file_context`) while updating OpenRouter-derived capability fields (`vision`) during model metadata sync | 1. Existing OWUI capabilities preserved during update<br>2. OpenRouter capabilities merged into existing<br>3. `_update_or_insert_model_with_metadata()` correctly merges capabilities<br>4. ModelMeta capabilities dict properly merged | `Pipe._update_or_insert_model_with_metadata()`, internal capability merging logic | `monkeypatch` (stubbed OWUI modules), sys.modules manipulation (inject stub `open_webui.models.models` with `ModelMeta`, `ModelParams`, `ModelForm`, `Models`), stub `DummyModels` with `get_model_by_id()` returning existing model with capabilities, `update_model_by_id()` capturing updates, captured dict to inspect results | `assert meta is not None`, `assert meta_dict.get("capabilities") == {"builtin_tools": False, "file_context": False, "vision": True}` (existing keys preserved + new key added) | **MEDIUM** - Test depends on OWUI model schema structure (ModelMeta, ModelParams, ModelForm, Models API). If OWUI changes capabilities storage format or merge strategy, test breaks. Internal pipe merge logic may change. | Yes | Uses extensive module stubbing to isolate pipe logic from actual OWUI DB. Verifies claim that pipe doesn't clobber OWUI-only metadata. Cleanup includes pipe shutdown, async close handling (running loop detection), and sys.modules restoration. | Monitor OWUI model schema evolution. Consider testing with multiple capability merge scenarios (empty existing, empty new, overlapping keys). |
| `test_discover_engine_prefers_db_context_over_symbol_names` | Verifies the pipe's OWUI database autodiscovery prefers `get_db_context().get_bind()` method over direct symbol lookup for finding the SQLAlchemy engine | 1. Autodiscovery calls `get_db_context()`<br>2. Extracts session from context manager<br>3. Calls `get_bind()` on session<br>4. Returns correct engine object<br>5. Details report correct source | `Pipe._discover_owui_engine_and_schema()` static method | Stub `open_webui.internal.db` module with `get_db_context()` returning custom `_ContextManager` wrapping `_Session` with `get_bind()` returning mock engine object | `assert discovered_engine is engine` (correct object identity), `assert discovered_schema is None` (no schema discovered in this scenario), `assert details["engine_source"] == "get_db_context.get_bind"` | **MEDIUM** - Test depends on OWUI DB module structure. If OWUI removes `get_db_context()` or changes session API, autodiscovery and test fail. Discovery preference order is internal implementation detail. | Yes | Unit test for autodiscovery logic. Uses duck-typed stubs (no real DB). Verifies preference order documented in implementation. No cleanup needed (no state modified). | Document full autodiscovery preference order. Test fallback paths (direct symbol lookup). Monitor OWUI DB API changes. |
| `test_discover_schema_prefers_base_metadata_schema` | Verifies the pipe's OWUI database autodiscovery prefers `Base.metadata.schema` attribute for finding the database schema name | 1. Autodiscovery reads `owui_db.Base.metadata.schema`<br>2. Returns correct schema string<br>3. Returns engine from direct attribute<br>4. Details report correct source | `Pipe._discover_owui_engine_and_schema()` static method | Stub `open_webui.internal.db` module with `engine` attribute (direct object), `Base` class with `metadata` having `schema` attribute set to `"owui_schema"` | `assert discovered_engine is engine` (engine found via direct attribute), `assert discovered_schema == "owui_schema"` (schema from Base.metadata), `assert details["schema_source"] == "owui_db.Base.metadata.schema"` | **MEDIUM** - Test depends on OWUI DB structure using SQLAlchemy Base with metadata.schema. If OWUI changes schema storage or removes Base, discovery and test fail. | Yes | Unit test for schema autodiscovery. Verifies preference for SQLAlchemy standard `Base.metadata.schema`. No cleanup needed. | Test fallback to env var. Monitor SQLAlchemy usage in OWUI. Verify schema is actually used in queries. |
| `test_discover_schema_falls_back_to_open_webui_env` | Verifies the pipe's OWUI database autodiscovery falls back to `open_webui.env.DATABASE_SCHEMA` when `Base.metadata.schema` is not available | 1. Autodiscovery attempts Base.metadata.schema (not present)<br>2. Falls back to importing `open_webui.env`<br>3. Reads `DATABASE_SCHEMA` from env module<br>4. Returns correct schema string<br>5. Details report correct source | `Pipe._discover_owui_engine_and_schema()` static method, env module fallback logic | Stub `open_webui.internal.db` module with `engine` only (no Base/schema), stub `open_webui.env` module with `DATABASE_SCHEMA = "fallback_schema"`, sys.modules manipulation to inject env module, original `__path__` saved/restored on open_webui package | `assert discovered_engine is engine` (engine found), `assert discovered_schema == "fallback_schema"` (schema from env module), `assert details["schema_source"] == "open_webui.env.DATABASE_SCHEMA"` | **HIGH** - Test depends on OWUI env module structure and fallback discovery order. If OWUI removes DATABASE_SCHEMA env var or changes priority, test fails. Manipulates sys.modules and package __path__ which is fragile. | Yes | Unit test for fallback discovery path. Complex setup manipulating Python module system. Cleanup restores original __path__ and removes injected module. Critical for deployments with custom schema configuration. | Simplify sys.modules manipulation if possible. Test other fallback scenarios. Monitor OWUI env configuration changes. Document when fallback is used in production. |


## `tests/test_persistence.py`

| Test Name | Description | What It Tests | Code Under Test | Mocks/Fixtures | Assertions | Drift Risk | Check Done | Codex Notes | Codex TODO |
|-----------|-------------|---------------|-----------------|----------------|------------|------------|------------|-------------|------------|
| test_discover_schema_from_base_metadata_raises | Test exception handling in Base.metadata.schema discovery | Tests line 351-352: exception handling when accessing Base.metadata.schema raises RuntimeError | Pipe._discover_owui_engine_and_schema() | Mock _DB class with Base.metadata property that raises RuntimeError | assert schema is None | LOW - Tests error recovery path |  | Tests specific exception handling in schema discovery from Base.metadata | None |
| test_discover_schema_from_metadata_obj_raises | Test exception handling in metadata_obj.schema discovery | Tests line 363-364: exception handling when accessing metadata_obj.schema raises RuntimeError | Pipe._discover_owui_engine_and_schema() | Mock _DB class with metadata_obj property that raises RuntimeError | assert schema is None | LOW - Tests error recovery path |  | Tests specific exception handling in schema discovery from metadata_obj | None |
| test_discover_engine_from_bind_fallback | Test engine discovery via session.bind when get_bind fails | Tests line 389-394: engine discovery falls back to session.bind when get_bind() raises exception | Pipe._discover_owui_engine_and_schema() | Mock _Session with bind attribute and get_bind() that raises RuntimeError, contextmanager for get_db_context | assert discovered_engine is engine_obj, assert details["engine_source"] == "get_db_context.bind" | MEDIUM - Tests fallback logic |  | Tests fallback path when get_bind() fails, should still discover engine from bind attribute | None |
| test_discover_engine_unavailable_sets_details | Test that engine_source is set to 'unavailable' when no engine found | Tests line 407: ensures details dict is populated with 'unavailable' when no engine can be discovered | Pipe._discover_owui_engine_and_schema() | Mock _DB class with no attributes | assert engine is None, assert details["engine_source"] == "unavailable", assert details["schema_source"] == "unavailable" | LOW - Tests metadata tracking |  | Tests metadata tracking when discovery fails completely | None |
| test_discover_engine_from_context_raises | Test exception handling in get_db_context | Tests line 393-394: exception handling when get_db_context itself raises during context entry | Pipe._discover_owui_engine_and_schema() | Mock _DB with get_db_context that raises RuntimeError on entry | assert engine is None | LOW - Tests error recovery |  | Tests error handling when context manager entry fails | None |
| test_init_artifact_store_dialect_logging_exception | Test that dialect logging exception is handled gracefully | Tests line 440-441: exception handling when engine.dialect.name property raises exception during logging | Pipe._init_artifact_store() | Mock _BrokenEngine with dialect.name property that raises RuntimeError, _install_internal_db() | No crash | LOW - Tests logging robustness |  | Ensures dialect logging failure doesn't crash initialization | None |
| test_schema_normalization_logic | Test schema normalization logic | Tests line 480-483, 489-490: schema string normalization with strip() and conditional inclusion in table_args | Direct logic testing (no methods called) | None | Multiple assertions for: whitespace stripping, empty string handling, None handling, table_args dict modification | LOW - Tests pure logic |  | Tests schema normalization logic directly without calling actual methods | None |
| test_init_artifact_store_existing_table_removal | Test that existing table metadata is removed | Tests line 477: ensures existing table is removed from metadata before re-creating | Pipe._init_artifact_store() | _sqlite_engine(), _install_internal_db() | assert store._item_model is not None | MEDIUM - Tests table re-initialization |  | Tests that re-initializing with same table name properly removes old metadata | None |
| test_init_artifact_store_inspection_error | Test SQLAlchemyError during table inspection sets table_exists=True | Tests line 515-516: when table inspection raises SQLAlchemyError, assumes table exists for safety | Pipe._init_artifact_store() | monkeypatch sa_inspect to raise SQLAlchemyError, _sqlite_engine(), _install_internal_db() | assert store._item_model is not None | MEDIUM - Tests error recovery behavior |  | Tests defensive assumption that table exists when inspection fails | None |
| test_maybe_heal_index_conflict_no_indexes | Test _maybe_heal_index_conflict returns False when no indexes to drop | Tests line 607: early return False when table has no indexes | ArtifactStore._maybe_heal_index_conflict() | Mock _DummyTable with empty indexes set | assert result is False | LOW - Tests early exit |  | Tests early exit when no indexes exist to heal | None |
| test_maybe_heal_index_conflict_empty_name | Test _maybe_heal_index_conflict skips empty index names | Tests line 613: skips indexes with empty name during conflict healing | ArtifactStore._maybe_heal_index_conflict() | Mock _DummyTable with index having empty name, _DummyEngine | assert isinstance(result, bool) | LOW - Tests validation |  | Tests that empty index names are properly skipped | None |
| test_maybe_heal_index_conflict_all_fail | Test _maybe_heal_index_conflict returns False when all drops fail | Tests line 635: returns False when all index drop attempts fail | ArtifactStore._maybe_heal_index_conflict() | Mock _DummyTable, _DummyEngine that raises SQLAlchemyError on execute | assert result is False | MEDIUM - Tests failure handling |  | Tests behavior when all index drops fail | None |
| test_prepare_rows_for_storage_non_dict_payload | Test _prepare_rows_for_storage skips non-dict payloads | Tests line 778: skips processing when payload is not a dict | ArtifactStore._prepare_rows_for_storage() | None | assert rows[0]["payload"] == "not a dict", assert rows[1]["payload"] == 123 | MEDIUM - Tests type validation |  | Tests type safety when payloads are not dicts | None |
| test_db_persist_sync_empty_rows | Test _db_persist_sync returns empty list for empty rows | Tests line 812: early return for empty input | Pipe._db_persist_sync() | _install_fake_store() | assert result == [] | LOW - Tests early exit |  | Tests optimization for empty input | None |
| test_db_persist_empty_rows | Test _db_persist returns empty list for empty rows | Tests line 916: async early return for empty input | Pipe._db_persist() | _install_fake_store() | assert result == [] | LOW - Tests early exit |  | Tests async optimization for empty input | None |
| test_db_persist_direct_reraises_non_duplicate | Test _db_persist_direct re-raises non-duplicate key errors | Tests line 975: re-raises SQLAlchemyError that is not duplicate key error | ArtifactStore._db_persist_direct() | _install_fake_store(), monkeypatch _db_persist_sync to raise non-duplicate SQLAlchemyError | pytest.raises(SQLAlchemyError) | HIGH - Tests error propagation |  | Tests that only duplicate key errors are suppressed, others propagate | None |
| test_is_duplicate_key_error_with_orig | Test _is_duplicate_key_error checks orig attribute | Tests line 988: checks exc.orig attribute for duplicate key error messages | ArtifactStore._is_duplicate_key_error() | Mock _OrigError with __str__ returning "duplicate key value" | assert result is True | MEDIUM - Tests error detection |  | Tests duplicate key detection via orig attribute | None |
| test_is_duplicate_key_error_non_sqlalchemy | Test _is_duplicate_key_error returns False for non-SQLAlchemy errors | Tests line 992: returns False for non-SQLAlchemyError exceptions | ArtifactStore._is_duplicate_key_error() | None | assert result is False for RuntimeError and ValueError | LOW - Tests type checking |  | Tests that only SQLAlchemyError instances are checked | None |
| test_db_fetch_sync_no_item_ids | Test _db_fetch_sync returns empty dict for empty item_ids | Tests line 1003: early return for empty item_ids list | Pipe._db_fetch_sync() | _install_fake_store() | assert result == {} | LOW - Tests early exit |  | Tests optimization for empty item_ids | None |
| test_db_fetch_sync_no_session_factory | Test _db_fetch_sync returns empty dict when no session_factory | Tests line 1003: early return when session_factory is None | ArtifactStore._db_fetch_sync() | None | assert result == {} | LOW - Tests guard clause |  | Tests safety check when DB is not initialized | None |
| test_db_fetch_sync_touch_outer_exception | Test _db_fetch_sync handles outer touch exception | Tests line 1049-1050: handles exception during touch session creation/query | ArtifactStore._db_fetch_sync() | Custom _FailingSession that raises on second session creation | assert "id-1" in result | MEDIUM - Tests error recovery |  | Tests that touch failures don't prevent fetch results from being returned | None |
| test_db_fetch_empty_chat_id | Test _db_fetch returns empty dict for empty chat_id | Tests line 1085: early return when chat_id is empty or None | Pipe._db_fetch() | _install_fake_store() | assert result == {} (for both "" and None) | LOW - Tests validation |  | Tests input validation for chat_id | None |
| test_db_fetch_no_missing_ids | Test _db_fetch returns cached when no missing IDs | Tests line 1095: returns early when all items found in Redis cache | ArtifactStore._db_fetch() | _install_fake_store(), mock _redis_fetch_rows | assert result == {"id-1": {"type": "cached"}} | MEDIUM - Tests optimization |  | Tests cache hit path that skips DB entirely | None |
| test_db_fetch_no_db_executor | Test _db_fetch returns cached when no db_executor | Tests line 1098: returns cached results when db_executor is None | ArtifactStore._db_fetch() | _install_fake_store(), set db_executor to None | assert result == {} | LOW - Tests guard clause |  | Tests safety when DB executor is not available | None |
| test_db_fetch_resets_failure_on_success | Test _db_fetch resets failure count on success | Tests line 1132: calls _reset_db_failure on successful fetch | ArtifactStore._db_fetch() | _install_fake_store(), monkeypatch _reset_db_failure and _db_fetch_direct, SessionLogger.user_id context | assert "test-user" in reset_calls | MEDIUM - Tests circuit breaker |  | Tests that circuit breaker resets on success | None |
| test_redis_pubsub_listener_no_client | Test _redis_pubsub_listener returns early when no client | Tests line 1202: early return when redis_client is None | ArtifactStore._redis_pubsub_listener() | None | No crash, early exit | LOW - Tests guard clause |  | Tests safety when Redis is not configured | None |
| test_redis_pubsub_listener_skips_non_message | Test _redis_pubsub_listener skips non-message types | Tests line 1208: only processes messages of type "message" | ArtifactStore._redis_pubsub_listener() | Mock _PubSub that yields different message types, mock _flush_redis_queue | assert flush_calls == ["flushed"] (only for "message" type) | MEDIUM - Tests message filtering |  | Tests that only actual messages trigger flush, not subscription events | None |
| test_redis_pubsub_listener_exception | Test _redis_pubsub_listener handles exception | Tests line 1212-1213: catches and logs exception during pubsub listening | ArtifactStore._redis_pubsub_listener() | Mock _PubSub.listen() that raises RuntimeError, caplog | assert warning logged with "pub/sub listener stopped" | MEDIUM - Tests error recovery |  | Tests graceful handling of pubsub failures | None |
| test_redis_periodic_flusher_no_client | Test _redis_periodic_flusher exits when no redis client | Tests line 1227: early exit when redis_client is None | ArtifactStore._redis_periodic_flusher() | Set redis_enabled=True but redis_client=None | No crash, early exit | LOW - Tests guard clause |  | Tests safety check for Redis client availability | None |
| test_redis_periodic_flusher_queue_depth_logging | Test _redis_periodic_flusher logs queue depth | Tests line 1234-1235: logs debug message with queue depth when > 0 | ArtifactStore._redis_periodic_flusher() | Mock _FakeRedis.llen(), monkeypatch asyncio.sleep, caplog | assert "queue depth" in log records | LOW - Tests logging |  | Tests queue depth monitoring logging | None |
| test_flush_redis_queue_disabled | Test _flush_redis_queue returns early when disabled | Tests line 1255: early return when redis_enabled is False | ArtifactStore._flush_redis_queue() | Set redis_enabled=False, Mock redis_client | No operations performed | LOW - Tests guard clause |  | Tests disabled state early exit | None |
| test_flush_redis_queue_lock_release_not_1 | Test _flush_redis_queue warns when lock release returns non-1 | Tests line 1337-1338: logs warning when lock release eval returns 0 | ArtifactStore._flush_redis_queue() | Mock _FakeRedis.eval() returning 0, caplog | assert "lock was not released" in warnings | MEDIUM - Tests lock safety |  | Tests detection of improper lock release | None |
| test_flush_redis_queue_lock_release_non_int | Test _flush_redis_queue handles non-int lock release result | Tests line 1337-1338: logs warning when lock release eval returns non-integer | ArtifactStore._flush_redis_queue() | Mock _FakeRedis.eval() returning "not an int", caplog | assert "lock was not released" in warnings | MEDIUM - Tests type safety |  | Tests handling of unexpected lock release return values | None |
| test_redis_enqueue_rows_empty | Test _redis_enqueue_rows returns empty list for empty rows | Tests line 1359: early return for empty input | Pipe._redis_enqueue_rows() | _install_fake_store() | assert result == [] | LOW - Tests early exit |  | Tests optimization for empty input | None |
| test_redis_enqueue_rows_fallback_disabled | Test _redis_enqueue_rows falls back to direct DB when redis disabled | Tests line 1362: falls back to _db_persist_direct when Redis disabled | ArtifactStore._redis_enqueue_rows() | _install_fake_store(), set redis_enabled=False, monkeypatch _db_persist_direct | assert len(result) == 1, assert len(direct_calls) == 1 | HIGH - Tests fallback path |  | Tests critical fallback when Redis is unavailable | None |
| test_redis_fetch_rows_empty_keys | Test _redis_fetch_rows returns empty dict when no keys | Tests line 1423: early return when no keys to fetch | ArtifactStore._redis_fetch_rows() | Set redis_enabled=True, Mock _FakeRedis | assert result == {} | LOW - Tests early exit |  | Tests optimization for empty keys | None |
| test_redis_fetch_rows_ciphertext_from_nested_payload | Test _redis_fetch_rows extracts ciphertext from row_data.payload | Tests line 1443-1444: extracts ciphertext from nested payload.ciphertext structure | ArtifactStore._redis_fetch_rows() | Set redis_enabled=True, encryption_key, Mock _FakeRedis.mget() with nested payload structure | assert result["id-1"]["text"] == "secret" | HIGH - Tests encryption path |  | Tests decryption when ciphertext is in nested payload structure | None |
| test_run_cleanup_once_no_model | Test _run_cleanup_once returns early when no model | Tests line 1474-1475: early return when _item_model is None | ArtifactStore._run_cleanup_once() | Set _item_model=None | No crash, early exit | LOW - Tests guard clause |  | Tests safety when model is not initialized | None |
| test_run_cleanup_once_executes | Test _run_cleanup_once executes cleanup | Tests line 1476-1479: executes _cleanup_sync with calculated cutoff | ArtifactStore._run_cleanup_once() | _install_fake_store(), mock _cleanup_sync | assert len(cleanup_called) == 1 | MEDIUM - Tests cleanup execution |  | Tests that cleanup is actually invoked with cutoff time | None |
| test_cleanup_sync_no_session_factory | Test _cleanup_sync returns early when no session_factory | Tests line 1487: early return when session_factory is None | ArtifactStore._cleanup_sync() | Set session_factory=None, _item_model=_FakeModel | No crash | LOW - Tests guard clause |  | Tests safety when DB session factory is not available | None |
| test_db_breaker_allows_empty_user_id | Test _db_breaker_allows returns True for empty user_id | Tests line 1511: returns True when user_id is empty or None | ArtifactStore._db_breaker_allows() | None | assert result is True (for both "" and None) | LOW - Tests edge case |  | Tests that circuit breaker allows when no user_id to track | None |
| test_db_breaker_allows_clears_old_failures | Test _db_breaker_allows clears old failures from window | Tests line 1515: removes failures older than breaker_window_seconds | ArtifactStore._db_breaker_allows() | Add old timestamps to _db_breakers | assert result is True | MEDIUM - Tests time-based cleanup |  | Tests that old failures outside the window are cleared | None |
| test_normalize_persisted_item_non_dict | Test normalize_persisted_item returns None for non-dict | Tests non-dict input handling | normalize_persisted_item() | None | assert result is None (for None, string, int) | LOW - Tests type validation |  | Tests input type validation | None |
| test_normalize_persisted_item_no_type | Test normalize_persisted_item returns None for dict without type | Tests dict without "type" key handling | normalize_persisted_item() | None | assert result is None (for {} and {"key": "value"}) | LOW - Tests validation |  | Tests required field validation | None |
| test_normalize_persisted_item_function_call_output | Test normalize_persisted_item for function_call_output | Tests function_call_output normalization with None output | normalize_persisted_item() | None | assert output == "", assert "id" in result, assert "call_id" in result | MEDIUM - Tests normalization |  | Tests default values for function_call_output | None |
| test_normalize_persisted_item_function_call_missing_name | Test normalize_persisted_item for function_call missing name | Tests function_call validation requires name | normalize_persisted_item() | None | assert result is None | MEDIUM - Tests validation |  | Tests required field validation for function_call | None |
| test_normalize_persisted_item_function_call_non_string_args | Test normalize_persisted_item for function_call with non-string arguments | Tests JSON serialization of dict arguments | normalize_persisted_item() | None | assert arguments == '{"key": "value"}' | MEDIUM - Tests serialization |  | Tests automatic JSON serialization of non-string arguments | None |
| test_normalize_persisted_item_function_call_non_serializable_args | Test normalize_persisted_item for function_call with non-serializable arguments | Tests fallback to str() for non-serializable arguments | normalize_persisted_item() | Custom _NonSerializable class | assert "NonSerializable" in arguments | MEDIUM - Tests fallback |  | Tests fallback serialization for objects that can't be JSON serialized | None |
| test_normalize_persisted_item_reasoning_with_string_content | Test normalize_persisted_item for reasoning with string content | Tests conversion of string content to list of reasoning_text blocks | normalize_persisted_item() | None | assert content == [{"type": "reasoning_text", "text": "test content"}] | MEDIUM - Tests normalization |  | Tests content normalization for reasoning blocks | None |
| test_normalize_persisted_item_reasoning_with_non_list_summary | Test normalize_persisted_item for reasoning with non-list summary | Tests conversion of string summary to list | normalize_persisted_item() | None | assert summary == ["a summary"] | MEDIUM - Tests normalization |  | Tests summary normalization to list format | None |
| test_normalize_persisted_item_file_search_call | Test normalize_persisted_item for file_search_call | Tests queries field normalization to empty list when not a list | normalize_persisted_item() | None | assert queries == [] | MEDIUM - Tests normalization |  | Tests default empty list for invalid queries | None |
| test_normalize_persisted_item_web_search_call | Test normalize_persisted_item for web_search_call | Tests action field normalization to empty dict when not a dict | normalize_persisted_item() | None | assert action == {} | MEDIUM - Tests normalization |  | Tests default empty dict for invalid action | None |
| test_shutdown_no_executor | Test shutdown handles no executor gracefully | Tests shutdown when db_executor is None | ArtifactStore.shutdown() | Set db_executor=None | No crash | LOW - Tests guard clause |  | Tests safety when executor is not initialized | None |
| test_shutdown_with_cancel_futures | Test shutdown with cancel_futures support | Tests shutdown with modern ThreadPoolExecutor supporting cancel_futures | ArtifactStore.shutdown() | _install_fake_store() | assert db_executor is None | LOW - Tests cleanup |  | Tests normal shutdown path | None |
| test_shutdown_without_cancel_futures | Test shutdown handles TypeError from old ThreadPoolExecutor | Tests fallback when cancel_futures parameter raises TypeError | ArtifactStore.shutdown() | Mock _OldExecutor that raises TypeError for cancel_futures | assert db_executor is None | MEDIUM - Tests backward compatibility |  | Tests backward compatibility with old ThreadPoolExecutor versions | None |
| test_wait_for_sync_value | Test _wait_for returns sync value immediately | Tests _wait_for with non-awaitable value | _wait_for() | None | assert result == 42 | LOW - Tests sync path |  | Tests passthrough for synchronous values | None |
| test_wait_for_async_without_timeout | Test _wait_for awaits async value without timeout | Tests _wait_for with coroutine and no timeout | _wait_for() | None | assert result == "async result" | LOW - Tests async path |  | Tests awaiting coroutines without timeout | None |
| test_wait_for_async_with_timeout | Test _wait_for awaits async value with timeout | Tests _wait_for with coroutine and timeout parameter | _wait_for() | None | assert result == "async result" | LOW - Tests async path |  | Tests awaiting coroutines with timeout | None |
| test_encode_crockford_negative | Test _encode_crockford raises for negative values | Tests input validation for negative numbers | _encode_crockford() | None | pytest.raises(ValueError) | LOW - Tests validation |  | Tests input validation rejects negative values | None |
| test_encode_crockford_zero | Test _encode_crockford handles zero | Tests encoding of zero value | _encode_crockford() | None | assert result == "0000" | LOW - Tests edge case |  | Tests zero padding for zero value | None |
| test_sanitize_table_fragment_empty | Test _sanitize_table_fragment handles empty input | Tests default fallback for empty or None input | _sanitize_table_fragment() | None | assert result == "pipe" (for both "" and None) | LOW - Tests default value |  | Tests default value when input is empty | None |
| test_sanitize_table_fragment_special_chars | Test _sanitize_table_fragment normalizes special characters | Tests character normalization and lowercasing | _sanitize_table_fragment() | None | assert "_" in result or result.isalnum(), assert result == result.lower() | LOW - Tests sanitization |  | Tests character sanitization for table names | None |


## `tests/test_pipe.py`

| Test Name | Description | What It Tests | Code Under Test | Mocks/Fixtures | Assertions | Drift Risk | Check Done | Codex Notes | Codex TODO |
|---|---|---|---|---|---|---|---|---|---|
| test_pipe_init_creates_subsystems | Test that Pipe.__init__ properly initializes all subsystems | Initialization of all pipe subsystems | Pipe.__init__ | None | artifact_store, multimodal_handler, streaming_handler, event_emitter_handler, circuit_breaker not None | Low | [ ] | | |
| test_pipe_del_triggers_shutdown | Test that __del__ properly cleans up resources | Destructor cleanup behavior | Pipe.__del__ | None | No exceptions raised | Low | [ ] | | |
| test_pipe_close_is_idempotent | Test that calling close() multiple times is safe | Idempotent close behavior | Pipe.close | asyncio.run | _closed is True after multiple calls | Low | [ ] | | |
| test_pipe_init_invalid_uvicorn_workers_env | Test that invalid UVICORN_WORKERS value logs a warning | Invalid environment variable handling | Pipe.__init__ | monkeypatch, caplog | Warning logged for invalid UVICORN_WORKERS | Low | [ ] | | |
| test_pipe_init_multi_worker_without_redis_valve | Test that multi-worker without ENABLE_REDIS_CACHE logs a warning | Multi-worker configuration validation | Pipe.__init__ | monkeypatch, caplog, patch | Warning logged when ENABLE_REDIS_CACHE is disabled | Medium | [ ] | | |
| test_pipe_init_multi_worker_without_redis_url | Test that multi-worker with valve enabled but no REDIS_URL logs a warning | Redis URL validation | Pipe.__init__ | monkeypatch, caplog | No crash with missing REDIS_URL | Medium | [ ] | | |
| test_pipe_init_multi_worker_without_websocket_manager | Test that multi-worker with valve enabled but wrong WEBSOCKET_MANAGER logs a warning | WebSocket manager validation | Pipe.__init__ | monkeypatch | No crash with wrong WEBSOCKET_MANAGER | Medium | [ ] | | |
| test_pipe_init_timing_log_enabled_success | Test that timing log configuration works when enabled | Timing log valve configuration | Pipe.__init__, valves.ENABLE_TIMING_LOG | tmp_path, monkeypatch | ENABLE_TIMING_LOG valve is True | Low | [ ] | | |
| test_ensure_catalog_manager_lazy_init | Test that _ensure_catalog_manager creates manager on first call | Lazy initialization of catalog manager | Pipe._ensure_catalog_manager | None | Manager created on first call, same instance on second | Low | [ ] | | |
| test_ensure_error_formatter_lazy_init | Test that _ensure_error_formatter creates formatter on first call | Lazy initialization of error formatter | Pipe._ensure_error_formatter | None | Formatter created on first call | Low | [ ] | | |
| test_ensure_reasoning_config_manager_lazy_init | Test that _ensure_reasoning_config_manager creates manager on first call | Lazy initialization of reasoning config manager | Pipe._ensure_reasoning_config_manager | None | Manager created on first call, same instance on second | Low | [ ] | | |
| test_ensure_nonstreaming_adapter_lazy_init | Test that _ensure_nonstreaming_adapter creates adapter on first call | Lazy initialization of nonstreaming adapter | Pipe._ensure_nonstreaming_adapter | None | Adapter created on first call, same instance on second | Low | [ ] | | |
| test_ensure_task_model_adapter_lazy_init | Test that _ensure_task_model_adapter creates adapter on first call | Lazy initialization of task model adapter | Pipe._ensure_task_model_adapter | None | Adapter created on first call, same instance on second | Low | [ ] | | |
| test_ensure_tool_executor_lazy_init | Test that _ensure_tool_executor creates executor on first call | Lazy initialization of tool executor | Pipe._ensure_tool_executor | None | Executor created on first call, same instance on second | Low | [ ] | | |
| test_ensure_responses_adapter_lazy_init | Test that _ensure_responses_adapter creates adapter on first call | Lazy initialization of responses adapter | Pipe._ensure_responses_adapter | None | Adapter created on first call, same instance on second | Low | [ ] | | |
| test_ensure_chat_completions_adapter_lazy_init | Test that _ensure_chat_completions_adapter creates adapter on first call | Lazy initialization of chat completions adapter | Pipe._ensure_chat_completions_adapter | None | Adapter created on first call, same instance on second | Low | [ ] | | |
| test_ensure_request_orchestrator_lazy_init | Test that _ensure_request_orchestrator creates orchestrator on first call | Lazy initialization of request orchestrator | Pipe._ensure_request_orchestrator | None | Orchestrator created on first call, same instance on second | Low | [ ] | | |
| test_db_executor_property_delegates_to_artifact_store | Test that _db_executor property delegates to artifact store | Property delegation for db_executor | Pipe._db_executor | Mock | Getter and setter delegate to artifact store | Low | [ ] | | |
| test_encryption_key_property_delegates_to_artifact_store | Test that _encryption_key property delegates to artifact store | Property delegation for encryption_key | Pipe._encryption_key | None | Getter and setter delegate to artifact store | Low | [ ] | | |
| test_fernet_property_delegates_to_artifact_store | Test that _fernet property delegates to artifact store | Property delegation for fernet | Pipe._fernet | Mock | Getter and setter delegate to artifact store | Low | [ ] | | |
| test_breaker_threshold_property_sync | Test that _breaker_threshold property syncs with CircuitBreaker and ArtifactStore | Breaker threshold synchronization | Pipe._breaker_threshold | None | Threshold synced to circuit_breaker and artifact_store | Low | [ ] | | |
| test_breaker_window_property_sync | Test that _breaker_window_seconds property syncs with CircuitBreaker and ArtifactStore | Breaker window synchronization | Pipe._breaker_window_seconds | None | Window synced to circuit_breaker and artifact_store | Low | [ ] | | |
| test_should_warn_event_queue_backlog_logic | Test the _should_warn_event_queue_backlog helper | Event queue backlog warning logic | Pipe._should_warn_event_queue_backlog | None | Returns False below threshold, within cooldown; True when threshold and cooldown expired | Low | [ ] | | |
| test_supports_tool_calling_checks_parameters | Test that _supports_tool_calling checks model supported_parameters | Tool calling support detection | Pipe._supports_tool_calling | ModelFamily.set_dynamic_specs | True for tool model, False for non-tool model | Medium | [ ] | | |
| test_sum_pricing_values_handles_various_types | Test that _sum_pricing_values handles various input types | Pricing value summation | Pipe._sum_pricing_values | None | Handles dict, list, string, invalid string, empty dict | Low | [ ] | | |
| test_quote_identifier_escapes_properly | Test that _quote_identifier escapes SQL identifiers | SQL identifier quoting | Pipe._quote_identifier | None | Normal identifier quoted, quotes escaped | Low | [ ] | | |
| test_auth_failure_scope_key_prefers_user | Test that _auth_failure_scope_key prefers user_id over session_id | Auth failure scope key generation | Pipe._auth_failure_scope_key | SessionLogger context vars | Returns user:X, session:X, or empty | Low | [ ] | | |
| test_maybe_start_startup_checks_already_complete | Test that _maybe_start_startup_checks returns early when checks are complete | Startup checks early return | Pipe._maybe_start_startup_checks | None | Returns early when _startup_checks_complete is True | Low | [ ] | | |
| test_maybe_start_startup_checks_task_running | Test that _maybe_start_startup_checks returns early when task is already running | Startup checks task deduplication | Pipe._maybe_start_startup_checks | asyncio.create_task | Returns early when task is running | Low | [ ] | | |
| test_maybe_start_startup_checks_task_done_clears | Test that _maybe_start_startup_checks clears a done task | Startup task cleanup | Pipe._maybe_start_startup_checks | asyncio.create_task | Clears done task | Low | [ ] | | |
| test_maybe_start_log_worker_stale_lock | Test that _maybe_start_log_worker handles a stale lock | Log worker stale lock handling | Pipe._maybe_start_log_worker | None | No crash with stale lock | Low | [ ] | | |
| test_maybe_start_log_worker_stale_worker_cancellation | Test that _maybe_start_log_worker cancels a stale worker task | Log worker task cancellation | Pipe._maybe_start_log_worker | None | Stale worker cancelled | Low | [ ] | | |
| test_select_models_returns_all_on_auto | Test that _select_models returns all models when filter is 'auto' | Model selection with auto filter | Pipe._select_models | None | Returns all models for auto, AUTO, empty string | Low | [ ] | | |
| test_select_models_filters_by_comma_list | Test that _select_models filters by comma-separated model IDs | Model selection by comma list | Pipe._select_models | None | Filters to matching models only | Low | [ ] | | |
| test_select_models_logs_missing_models | Test that _select_models logs warning for missing models | Model selection missing model warning | Pipe._select_models | caplog | Warning logged for nonexistent models | Low | [ ] | | |
| test_select_models_empty_available | Test that _select_models returns empty list when available_models is empty | Model selection with empty input | Pipe._select_models | None | Returns empty list | Low | [ ] | | |
| test_select_models_no_requested_after_split | Test that _select_models handles filter that produces no valid model IDs | Model selection with whitespace filter | Pipe._select_models | None | Returns all models when filter is whitespace | Low | [ ] | | |
| test_apply_model_filters_free_only | Test that _apply_model_filters with FREE_MODEL_FILTER=only filters correctly | Free model filter (only) | Pipe._apply_model_filters | OpenRouterModelRegistry._specs | Returns only free models | Medium | [ ] | | |
| test_apply_model_filters_free_exclude | Test that _apply_model_filters with FREE_MODEL_FILTER=exclude filters correctly | Free model filter (exclude) | Pipe._apply_model_filters | OpenRouterModelRegistry._specs | Returns only paid models | Medium | [ ] | | |
| test_apply_model_filters_tool_only | Test that _apply_model_filters with TOOL_CALLING_FILTER=only filters correctly | Tool calling filter (only) | Pipe._apply_model_filters | ModelFamily.set_dynamic_specs | Returns only tool-supporting models | Medium | [ ] | | |
| test_apply_model_filters_tool_exclude | Test that _apply_model_filters with TOOL_CALLING_FILTER=exclude works | Tool calling filter (exclude) | Pipe._apply_model_filters | ModelFamily.set_dynamic_specs | Returns only non-tool models | Medium | [ ] | | |
| test_apply_model_filters_empty_input | Test that _apply_model_filters returns empty list for empty input | Model filter with empty input | Pipe._apply_model_filters | None | Returns empty list | Low | [ ] | | |
| test_apply_model_filters_model_without_norm_id | Test that _apply_model_filters skips models without norm_id | Model filter norm_id validation | Pipe._apply_model_filters | None | Skips models without norm_id | Low | [ ] | | |
| test_model_restriction_reasons_catalog_check | Test that _model_restriction_reasons checks catalog membership | Model restriction catalog check | Pipe._model_restriction_reasons | None | Returns not_in_catalog for unknown model | Low | [ ] | | |
| test_model_restriction_reasons_model_id_filter | Test that _model_restriction_reasons checks MODEL_ID valve | Model restriction MODEL_ID check | Pipe._model_restriction_reasons | None | Returns MODEL_ID for non-allowed model | Low | [ ] | | |
| test_model_restriction_reasons_free_filter_only | Test that _model_restriction_reasons checks FREE_MODEL_FILTER=only | Model restriction free filter (only) | Pipe._model_restriction_reasons | OpenRouterModelRegistry._specs | Returns FREE_MODEL_FILTER=only for paid model | Medium | [ ] | | |
| test_model_restriction_reasons_free_filter_exclude | Test that _model_restriction_reasons checks FREE_MODEL_FILTER=exclude | Model restriction free filter (exclude) | Pipe._model_restriction_reasons | OpenRouterModelRegistry._specs | Returns FREE_MODEL_FILTER=exclude for free model | Medium | [ ] | | |
| test_model_restriction_reasons_tool_filter_only | Test that _model_restriction_reasons checks TOOL_CALLING_FILTER=only | Model restriction tool filter (only) | Pipe._model_restriction_reasons | ModelFamily.set_dynamic_specs | Returns TOOL_CALLING_FILTER=only for non-tool model | Medium | [ ] | | |
| test_model_restriction_reasons_tool_filter_exclude | Test that _model_restriction_reasons checks TOOL_CALLING_FILTER=exclude | Model restriction tool filter (exclude) | Pipe._model_restriction_reasons | ModelFamily.set_dynamic_specs | Returns TOOL_CALLING_FILTER=exclude for tool model | Medium | [ ] | | |
| test_apply_context_transforms_sets_middle_out | Test that _apply_context_transforms sets middle-out transform | Context transform application | Pipe._apply_context_transforms | None | Sets transforms to middle-out | Low | [ ] | | |
| test_apply_context_transforms_skips_if_disabled | Test that _apply_context_transforms skips if AUTO_CONTEXT_TRIMMING is False | Context transform skip behavior | Pipe._apply_context_transforms | None | transforms remains None | Low | [ ] | | |
| test_apply_context_transforms_preserves_existing | Test that _apply_context_transforms preserves existing transforms | Context transform preservation | Pipe._apply_context_transforms | None | Does not override existing transforms | Low | [ ] | | |
| test_apply_reasoning_preferences_with_no_support | Test that _apply_reasoning_preferences handles models without reasoning support | Reasoning preferences for non-reasoning model | Pipe._apply_reasoning_preferences | ModelFamily.set_dynamic_specs | reasoning remains None | Low | [ ] | | |
| test_apply_task_reasoning_preferences_none_effort | Test that _apply_task_reasoning_preferences handles 'none' effort | Task reasoning with none effort | Pipe._apply_task_reasoning_preferences | ModelFamily.set_dynamic_specs | Sets reasoning with effort=none | Low | [ ] | | |
| test_create_http_session_creates_session | Test that _create_http_session creates a valid aiohttp session | HTTP session creation | Pipe._create_http_session | None | Returns aiohttp.ClientSession | Low | [ ] | | |
| test_wrap_safe_event_emitter_handles_none | Test that _wrap_safe_event_emitter returns None for None input | Safe emitter wrapper null handling | Pipe._wrap_safe_event_emitter | None | Returns None for None input | Low | [ ] | | |
| test_wrap_safe_event_emitter_catches_exceptions | Test that wrapped emitter catches and logs exceptions | Safe emitter exception handling | Pipe._wrap_safe_event_emitter | caplog | Logs event emitter failure | Low | [ ] | | |
| test_infer_file_mime_type_delegates | Test that _infer_file_mime_type delegates to MultimodalHandler | Mime type inference delegation | Pipe._infer_file_mime_type | None | Returns octet-stream when handler is None | Low | [ ] | | |
| test_is_youtube_url_delegates | Test that _is_youtube_url delegates to MultimodalHandler | YouTube URL detection delegation | Pipe._is_youtube_url | None | Returns False when handler is None | Low | [ ] | | |
| test_get_effective_remote_file_limit_mb_delegates | Test that _get_effective_remote_file_limit_mb delegates correctly | Remote file limit delegation | Pipe._get_effective_remote_file_limit_mb | None | Returns 50 when handler is None | Low | [ ] | | |
| test_input_contains_cache_control_detects_nested | Test that _input_contains_cache_control detects nested cache_control | Cache control detection | Pipe._input_contains_cache_control | None | Detects cache_control in dict, list, nested | Low | [ ] | | |
| test_strip_cache_control_from_input_removes_nested | Test that _strip_cache_control_from_input removes nested cache_control | Cache control stripping | Pipe._strip_cache_control_from_input | None | Removes cache_control from nested structure | Low | [ ] | | |
| test_build_task_fallback_content_returns_appropriate_values | Test that _build_task_fallback_content returns appropriate fallback strings | Task fallback content generation | Pipe._build_task_fallback_content | None | Returns content for title, tags, follow_up; empty for others | Low | [ ] | | |
| test_task_name_extracts_correctly | Test that _task_name extracts task type correctly | Task name extraction | Pipe._task_name | None | Extracts from string, dict with type/task, handles None/int | Low | [ ] | | |
| test_merge_valves_applies_multiple_overrides | Test that _merge_valves applies multiple user overrides | Valve merging with overrides | Pipe._merge_valves | UserValves | Overrides applied correctly | Low | [ ] | | |
| test_merge_valves_empty_user_valves | Test that _merge_valves returns global valves when user valves are empty | Valve merging with null user valves | Pipe._merge_valves | None | Returns global valves | Low | [ ] | | |
| test_merge_valves_dict_user_valves | Test that _merge_valves handles dict user valves | Valve merging with dict input | Pipe._merge_valves | None | Applies dict overrides, filters LOG_LEVEL | Low | [ ] | | |
| test_merge_valves_inherit_value | Test that _merge_valves respects INHERIT value | Valve merging with INHERIT | Pipe._merge_valves | None | Uses global value for INHERIT | Low | [ ] | | |
| test_merge_valves_unknown_field | Test that _merge_valves handles unknown fields gracefully | Valve merging with unknown field | Pipe._merge_valves | None | Ignores unknown field without crash | Low | [ ] | | |
| test_merge_valves_next_reply_mapping | Test that _merge_valves maps next_reply to PERSIST_REASONING_TOKENS | Valve merging with alias | Pipe._merge_valves | None | Maps next_reply to PERSIST_REASONING_TOKENS | Low | [ ] | | |
| test_is_free_model_handles_missing_pricing | Test that _is_free_model handles missing pricing gracefully | Free model detection with missing pricing | Pipe._is_free_model | OpenRouterModelRegistry._specs | Returns False for missing pricing | Low | [ ] | | |
| test_build_chat_completion_payload | Test that _build_chat_completion_payload creates valid payload | Chat completion payload building | Pipe._build_chat_completion_payload | None | Returns valid chat.completion structure | Low | [ ] | | |
| test_is_anthropic_model_id | Test that _is_anthropic_model_id correctly identifies Anthropic models | Anthropic model detection | Pipe._is_anthropic_model_id | None | True for anthropic/, False for others, handles edge cases | Low | [ ] | | |
| test_chat_usage_to_responses_usage | Test that _chat_usage_to_responses_usage converts correctly | Usage conversion | Pipe._chat_usage_to_responses_usage | None | Converts prompt_tokens to input_tokens, etc. | Low | [ ] | | |
| test_maybe_start_redis_not_candidate | Test that _maybe_start_redis returns early when not a candidate | Redis init skip for non-candidate | Pipe._maybe_start_redis | None | No task created when not candidate | Low | [ ] | | |
| test_maybe_start_redis_already_enabled | Test that _maybe_start_redis returns early when already enabled | Redis init skip when enabled | Pipe._maybe_start_redis | None | Returns early when already enabled | Low | [ ] | | |
| test_maybe_start_redis_task_already_running | Test that _maybe_start_redis returns early when init task is running | Redis init task deduplication | Pipe._maybe_start_redis | asyncio.create_task | No new task when one is running | Low | [ ] | | |
| test_init_redis_client_no_aioredis | Test that _init_redis_client handles missing aioredis | Redis init without aioredis | Pipe._init_redis_client | monkeypatch | _redis_enabled remains False | Low | [ ] | | |
| test_init_redis_client_ping_timeout | Test that _init_redis_client handles connection failures | Redis connection failure handling | Pipe._init_redis_client | None | _redis_enabled remains False on failure | Low | [ ] | | |
| test_stop_redis_cancels_tasks | Test that _stop_redis cancels background tasks | Redis task cancellation | Pipe._stop_redis | asyncio.create_task | All redis tasks set to None | Low | [ ] | | |
| test_maybe_start_cleanup_already_running | Test that _maybe_start_cleanup returns early when task is running | Cleanup task deduplication | Pipe._maybe_start_cleanup | asyncio.create_task | No new task when one is running | Low | [ ] | | |
| test_maybe_start_cleanup_task_done_clears | Test that _maybe_start_cleanup clears a done task | Cleanup task clearing | Pipe._maybe_start_cleanup | asyncio.create_task | Clears done task | Low | [ ] | | |
| test_stop_session_log_workers_handles_none | Test that _stop_session_log_workers handles None workers gracefully | Session log worker null handling | Pipe._stop_session_log_workers | None | No crash with None workers | Low | [ ] | | |
| test_stop_session_log_workers_with_live_threads | Test that _stop_session_log_workers handles live threads gracefully | Session log worker thread stopping | Pipe._stop_session_log_workers | threading.Thread | stop_event is set | Low | [ ] | | |
| test_maybe_start_session_log_workers_already_running | Test that _maybe_start_session_log_workers returns early if already running | Session log worker deduplication | Pipe._maybe_start_session_log_workers | threading.Thread | Returns early with running thread | Low | [ ] | | |
| test_enqueue_session_log_archive_disabled | Test that _enqueue_session_log_archive returns early when disabled | Session log archive skip when disabled | Pipe._enqueue_session_log_archive | None | Returns early without error | Low | [ ] | | |
| test_enqueue_session_log_archive_missing_ids | Test that _enqueue_session_log_archive returns early with missing IDs | Session log archive ID validation | Pipe._enqueue_session_log_archive | None | Returns early with missing user_id | Low | [ ] | | |
| test_enqueue_session_log_archive_no_pyzipper | Test that _enqueue_session_log_archive handles missing pyzipper | Session log archive without pyzipper | Pipe._enqueue_session_log_archive | monkeypatch, caplog | Warning logged for missing pyzipper | Low | [ ] | | |
| test_enqueue_session_log_archive_empty_dir | Test that _enqueue_session_log_archive handles empty SESSION_LOG_DIR | Session log archive dir validation | Pipe._enqueue_session_log_archive | caplog | Warning logged for empty dir | Low | [ ] | | |
| test_enqueue_session_log_archive_no_password | Test that _enqueue_session_log_archive handles empty password | Session log archive password validation | Pipe._enqueue_session_log_archive | caplog | Warning logged for empty password | Low | [ ] | | |
| test_maybe_start_session_log_assembler_worker_already_running | Test that _maybe_start_session_log_assembler_worker returns early if running | Assembler worker deduplication | Pipe._maybe_start_session_log_assembler_worker | threading.Thread | Returns early with running thread | Low | [ ] | | |
| test_run_session_log_assembler_once_disabled | Test that _run_session_log_assembler_once returns early when disabled | Assembler skip when disabled | Pipe._run_session_log_assembler_once | None | Returns early without error | Low | [ ] | | |
| test_run_session_log_assembler_once_no_db_handles | Test that _run_session_log_assembler_once handles missing DB handles | Assembler without DB handles | Pipe._run_session_log_assembler_once | None | Returns early without error | Low | [ ] | | |
| test_cleanup_session_log_archives_no_dirs | Test that _cleanup_session_log_archives handles no directories | Archive cleanup with no dirs | Pipe._cleanup_session_log_archives | None | Returns early without error | Low | [ ] | | |
| test_cleanup_session_log_archives_nonexistent_dir | Test that _cleanup_session_log_archives handles nonexistent directory | Archive cleanup with nonexistent dir | Pipe._cleanup_session_log_archives | None | Handles gracefully | Low | [ ] | | |
| test_cleanup_session_log_archives_with_files | Test that _cleanup_session_log_archives removes old files | Archive cleanup file removal | Pipe._cleanup_session_log_archives | tmp_path | Old file deleted, new file remains | Low | [ ] | | |
| test_ensure_concurrency_controls_increases_semaphore | Test that _ensure_concurrency_controls can increase semaphore limit | Concurrency control semaphore increase | Pipe._ensure_concurrency_controls | None | Semaphore limit increased | Low | [ ] | | |
| test_ensure_concurrency_controls_warns_on_decrease | Test that _ensure_concurrency_controls warns when decreasing limit | Concurrency control decrease warning | Pipe._ensure_concurrency_controls | caplog | Warning logged on decrease | Low | [ ] | | |
| test_ensure_concurrency_controls_tool_semaphore_increase | Test tool semaphore limit increase | Tool concurrency control increase | Pipe._ensure_concurrency_controls | None | Tool semaphore limit increased | Low | [ ] | | |
| test_ensure_concurrency_controls_tool_semaphore_decrease_warns | Test tool semaphore decrease warning | Tool concurrency control decrease warning | Pipe._ensure_concurrency_controls | caplog | Warning logged on tool semaphore decrease | Low | [ ] | | |
| test_ensure_concurrency_controls_stale_queue_detection | Test stale queue detection in concurrency controls | Stale queue handling | Pipe._ensure_concurrency_controls | None | Stale queue handled | Low | [ ] | | |
| test_render_ors_filter_source_contains_marker | Test that _render_ors_filter_source contains marker | ORS filter source rendering | Pipe._render_ors_filter_source | None | Source contains marker | Low | [ ] | | |
| test_render_direct_uploads_filter_source_contains_marker | Test that _render_direct_uploads_filter_source contains marker | Direct uploads filter source rendering | Pipe._render_direct_uploads_filter_source | None | Source contains marker | Low | [ ] | | |
| test_ensure_ors_filter_function_id_no_functions_module | Test ORS filter without functions module | ORS filter without module | Pipe._ensure_ors_filter_function_id | patch sys.modules | Returns None | Low | [ ] | | |
| test_ensure_direct_uploads_filter_function_id_no_functions_module | Test direct uploads filter without functions module | Direct uploads filter without module | Pipe._ensure_direct_uploads_filter_function_id | patch sys.modules | Returns None | Low | [ ] | | |
| test_breaker_allows_returns_true_when_healthy | Test that _breaker_allows returns true when healthy | Circuit breaker healthy state | Pipe._breaker_allows | None | Returns True | Low | [ ] | | |
| test_record_failure_and_reset | Test recording failure and reset | Circuit breaker failure recording | Pipe._record_failure, Pipe._reset_failure | None | Records and resets failures | Low | [ ] | | |
| test_tool_type_allows_returns_true_when_healthy | Test that _tool_type_allows returns true when healthy | Tool type breaker healthy state | Pipe._tool_type_allows | None | Returns True | Low | [ ] | | |
| test_record_tool_failure_type_and_reset | Test recording tool failure and reset | Tool type failure recording | Pipe._record_tool_failure_type, Pipe._reset_tool_failure_type | None | Records and resets tool failures | Low | [ ] | | |
| test_run_streaming_loop_requires_streaming_handler | Test that _run_streaming_loop requires streaming_handler | Streaming loop handler requirement | Pipe._run_streaming_loop | None | Raises RuntimeError when handler is None | Low | [ ] | | |
| test_run_nonstreaming_loop_requires_streaming_handler | Test that _run_nonstreaming_loop requires streaming_handler | Nonstreaming loop handler requirement | Pipe._run_nonstreaming_loop | None | Raises RuntimeError when handler is None | Low | [ ] | | |
| test_build_error_context | Test error context building | Error context generation | Pipe._build_error_context | None | Returns context dict | Low | [ ] | | |
| test_select_openrouter_template | Test OpenRouter template selection | Template selection | Pipe._select_openrouter_template | None | Returns appropriate template | Low | [ ] | | |
| test_ensure_async_subsystems_initialized | Test async subsystems initialization | Async subsystem initialization | Pipe._ensure_async_subsystems_initialized | None | Subsystems initialized | Low | [ ] | | |
| test_ensure_async_subsystems_initialized_idempotent | Test async subsystems initialization is idempotent | Async subsystem idempotency | Pipe._ensure_async_subsystems_initialized | None | Safe to call multiple times | Low | [ ] | | |
| test_pipes_returns_empty_on_api_key_error | Test that pipes returns empty on API key error | Pipes API key error handling | Pipe.pipes | monkeypatch | Returns empty list on API key error | Medium | [ ] | | |
| test_pipe_entry_with_invalid_body_type | Test pipe entry with invalid body type | Pipe entry body validation | Pipe.pipe | monkeypatch | Handles invalid body type | Medium | [ ] | | |
| test_pipe_entry_with_invalid_user_type | Test pipe entry with invalid user type | Pipe entry user validation | Pipe.pipe | monkeypatch | Handles invalid user type | Medium | [ ] | | |
| test_pipe_entry_breaker_blocks_user | Test pipe entry when breaker blocks user | Pipe entry breaker blocking | Pipe.pipe | monkeypatch | Blocks when breaker trips | Medium | [ ] | | |
| test_pipe_entry_warmup_failed | Test pipe entry when warmup failed | Pipe entry warmup failure | Pipe.pipe | monkeypatch | Handles warmup failure | Medium | [ ] | | |
| test_pipe_streaming_with_invalid_referer_override | Test pipe streaming with invalid referer override | Pipe referer validation | Pipe.pipe | monkeypatch | Handles invalid referer | Medium | [ ] | | |
| test_enqueue_job_requires_queue | Test that _enqueue_job requires queue | Job enqueue queue requirement | Pipe._enqueue_job | None | Raises when queue not initialized | Low | [ ] | | |
| test_enqueue_job_request_queue_not_initialized | Test enqueue_job when request queue not initialized | Job enqueue without queue | Pipe._enqueue_job | None | Handles missing queue | Low | [ ] | | |
| test_apply_logging_context_sets_context_vars | Test that _apply_logging_context sets context vars | Logging context application | Pipe._apply_logging_context | None | Context vars set correctly | Low | [ ] | | |
| test_parse_tool_arguments_handles_string | Test that _parse_tool_arguments handles string | Tool argument parsing | Pipe._parse_tool_arguments | None | Parses string arguments | Low | [ ] | | |
| test_is_batchable_tool_call | Test batchable tool call detection | Tool batching detection | Pipe._is_batchable_tool_call | None | Detects batchable calls | Low | [ ] | | |
| test_handle_pipe_call_no_session | Test handle_pipe_call without session | Pipe call session requirement | Pipe._handle_pipe_call | None | Handles missing session | Medium | [ ] | | |
| test_handle_pipe_call_task_with_auth_failure | Test handle_pipe_call task with auth failure | Pipe call auth failure handling | Pipe._handle_pipe_call | monkeypatch | Handles auth failure in task | Medium | [ ] | | |
| test_handle_pipe_call_api_key_error_streaming | Test handle_pipe_call API key error in streaming | Pipe call API key error streaming | Pipe._handle_pipe_call | monkeypatch | Emits error for API key failure | Medium | [ ] | | |
| test_handle_pipe_call_catalog_load_error | Test handle_pipe_call catalog load error | Pipe call catalog error | Pipe._handle_pipe_call | monkeypatch | Handles catalog load failure | Medium | [ ] | | |
| test_execute_tool_batch_empty | Test executing empty tool batch | Tool batch empty handling | Pipe._execute_tool_batch | None | Returns early for empty batch | Low | [ ] | | |
| test_run_tool_with_retries_no_tenacity | Test tool execution without tenacity | Tool retry without tenacity | Pipe._run_tool_with_retries | None | Works without tenacity | Low | [ ] | | |
| test_run_tool_with_retries_missing_callable | Test tool execution with missing callable | Tool retry missing callable | Pipe._run_tool_with_retries | None | Handles missing callable | Low | [ ] | | |
| test_call_tool_callable_sync_function | Test calling sync tool function | Sync tool execution | Pipe._call_tool_callable | None | Executes sync function | Low | [ ] | | |
| test_call_tool_callable_async_function | Test calling async tool function | Async tool execution | Pipe._call_tool_callable | None | Executes async function | Low | [ ] | | |
| test_invoke_tool_call_breaker_blocks | Test tool invocation when breaker blocks | Tool invocation breaker blocking | Pipe._invoke_tool_call | None | Blocks when breaker trips | Low | [ ] | | |
| test_get_user_by_id_no_users_module | Test _get_user_by_id without Users module | User lookup without module | Pipe._get_user_by_id | None | Handles missing Users module | Low | [ ] | | |
| test_maybe_apply_anthropic_beta_headers_disabled | Test Anthropic beta headers when disabled | Anthropic headers disabled | Pipe._maybe_apply_anthropic_beta_headers | None | No headers when disabled | Low | [ ] | | |
| test_maybe_apply_anthropic_beta_headers_non_anthropic_model | Test Anthropic beta headers for non-Anthropic model | Anthropic headers non-Anthropic | Pipe._maybe_apply_anthropic_beta_headers | None | No headers for non-Anthropic | Low | [ ] | | |
| test_maybe_apply_anthropic_beta_headers_adds_header | Test Anthropic beta headers added | Anthropic headers addition | Pipe._maybe_apply_anthropic_beta_headers | None | Adds beta header | Low | [ ] | | |
| test_maybe_apply_anthropic_beta_headers_appends_to_existing | Test Anthropic beta headers appends to existing | Anthropic headers append | Pipe._maybe_apply_anthropic_beta_headers | None | Appends to existing header | Low | [ ] | | |
| test_maybe_apply_anthropic_beta_headers_non_dict_headers | Test Anthropic beta headers with non-dict | Anthropic headers type handling | Pipe._maybe_apply_anthropic_beta_headers | None | Handles non-dict headers | Low | [ ] | | |
| test_maybe_apply_anthropic_beta_headers_non_string_model | Test Anthropic beta headers with non-string model | Anthropic headers model type | Pipe._maybe_apply_anthropic_beta_headers | None | Handles non-string model | Low | [ ] | | |
| test_note_auth_failure_no_scope_key | Test noting auth failure with no scope key | Auth failure noting without key | Pipe._note_auth_failure | None | Handles missing scope key | Low | [ ] | | |
| test_auth_failure_active_no_scope_key | Test auth failure active with no scope key | Auth failure check without key | Pipe._auth_failure_active | None | Returns False without key | Low | [ ] | | |
| test_resolve_openrouter_api_key_encrypted_but_undecryptable | Test API key resolution with undecryptable key | API key decryption failure | Pipe._resolve_openrouter_api_key | monkeypatch | Handles decryption failure | Medium | [ ] | | |
| test_pipes_returns_cached_models_on_refresh_error | Test pipes returns cached models on refresh error | Pipes cache fallback | Pipe.pipes | monkeypatch, pipe_instance_async | Returns cached models on error | Medium | [ ] | | |
| test_pipes_returns_empty_when_refresh_error_no_models | Test pipes returns empty when refresh error and no cached models | Pipes empty on error without cache | Pipe.pipes | monkeypatch, pipe_instance_async | Returns empty list | Medium | [ ] | | |
| test_pipes_auto_install_filters_handles_exceptions | Test pipes handles filter auto-install exceptions | Pipes filter install error handling | Pipe.pipes | monkeypatch, pipe_instance_async | Handles filter install exceptions | Medium | [ ] | | |
| test_pipe_queue_full_returns_503 | Test pipe returns 503 when queue full | Pipe queue full handling | Pipe.pipe | monkeypatch, pipe_instance_async | Returns 503 error | Medium | [ ] | | |
| test_pipe_breaker_blocks_request | Test pipe blocks request when breaker trips | Pipe breaker blocking | Pipe.pipe | monkeypatch, pipe_instance_async | Blocks request | Medium | [ ] | | |
| test_pipe_warmup_failed_emits_error | Test pipe emits error when warmup failed | Pipe warmup error emission | Pipe.pipe | monkeypatch, pipe_instance_async | Emits error event | Medium | [ ] | | |
| test_pipe_streams_warning_on_invalid_referer | Test pipe streams warning on invalid referer | Pipe referer warning | Pipe.pipe | monkeypatch, pipe_instance_async | Logs warning | Medium | [ ] | | |
| test_handle_pipe_call_requires_session | Test handle_pipe_call requires session | Pipe call session validation | Pipe._handle_pipe_call | pipe_instance_async | Requires session | Medium | [ ] | | |
| test_handle_pipe_call_auth_error_streaming_emits | Test handle_pipe_call emits auth error in streaming | Pipe call auth error streaming | Pipe._handle_pipe_call | monkeypatch, pipe_instance_async | Emits auth error | Medium | [ ] | | |
| test_handle_pipe_call_auth_error_nonstreaming_fallback | Test handle_pipe_call auth error fallback in non-streaming | Pipe call auth error non-streaming | Pipe._handle_pipe_call | monkeypatch, pipe_instance_async | Falls back on auth error | Medium | [ ] | | |
| test_handle_pipe_call_auth_error_task_fallback | Test handle_pipe_call auth error task fallback | Pipe call auth error task | Pipe._handle_pipe_call | monkeypatch, pipe_instance_async | Falls back for task | Medium | [ ] | | |
| test_handle_pipe_call_openrouter_catalog_unavailable | Test handle_pipe_call with catalog unavailable | Pipe call catalog unavailable | Pipe._handle_pipe_call | monkeypatch, pipe_instance_async | Handles catalog unavailable | Medium | [ ] | | |
| test_handle_pipe_call_http_status_error_503 | Test handle_pipe_call with 503 status error | Pipe call 503 error | Pipe._handle_pipe_call | monkeypatch, pipe_instance_async | Handles 503 error | Medium | [ ] | | |
| test_handle_pipe_call_http_status_error_429_reports | Test handle_pipe_call reports 429 status error | Pipe call 429 error | Pipe._handle_pipe_call | monkeypatch, pipe_instance_async | Reports 429 error | Medium | [ ] | | |
| test_handle_pipe_call_timeout_and_connect | Test handle_pipe_call timeout and connect errors | Pipe call timeout/connect | Pipe._handle_pipe_call | monkeypatch, pipe_instance_async | Handles timeout/connect | Medium | [ ] | | |
| test_handle_pipe_call_reports_openrouter_api_error | Test handle_pipe_call reports OpenRouter API error | Pipe call API error | Pipe._handle_pipe_call | monkeypatch, pipe_instance_async | Reports API error | Medium | [ ] | | |
| test_ensure_ors_filter_auto_install_off_returns_none | Test ORS filter returns None when auto-install off | ORS filter auto-install disabled | Pipe._ensure_ors_filter_function_id | pipe_instance | Returns None | Low | [ ] | | |
| test_ensure_ors_filter_auto_install_creates_and_updates | Test ORS filter creates and updates | ORS filter creation/update | Pipe._ensure_ors_filter_function_id | pipe_instance | Creates and updates filter | Medium | [ ] | | |
| test_ensure_ors_filter_updates_existing | Test ORS filter updates existing | ORS filter update | Pipe._ensure_ors_filter_function_id | pipe_instance | Updates existing filter | Medium | [ ] | | |
| test_ensure_direct_uploads_filter_updates_existing | Test direct uploads filter updates existing | Direct uploads filter update | Pipe._ensure_direct_uploads_filter_function_id | pipe_instance | Updates existing filter | Medium | [ ] | | |
| test_wrap_safe_event_emitter_returns_none_for_missing | Test safe emitter returns None for missing | Safe emitter null handling | Pipe._wrap_safe_event_emitter | None | Returns None | Low | [ ] | | |
| test_wrap_safe_event_emitter_swallows_transport_errors | Test safe emitter swallows transport errors | Safe emitter error swallowing | Pipe._wrap_safe_event_emitter | caplog | Swallows transport errors | Low | [ ] | | |
| test_resolve_pipe_identifier_returns_class_id | Test resolve_pipe_identifier returns class ID | Pipe identifier resolution | Pipe._resolve_pipe_identifier | None | Returns class ID | Low | [ ] | | |
| test_pipe_handles_job_failure | Test pipe handles job failure | Pipe job failure handling | Pipe.pipe | monkeypatch | Handles job failure | Medium | [ ] | | |
| test_pipe_coerces_none_metadata | Test pipe coerces None metadata | Pipe metadata coercion | Pipe.pipe | monkeypatch | Coerces None metadata | Medium | [ ] | | |
| test_handle_pipe_call_tolerates_metadata_model_none | Test handle_pipe_call tolerates None model in metadata | Pipe call null model tolerance | Pipe._handle_pipe_call | monkeypatch | Tolerates None model | Medium | [ ] | | |
| test_run_streaming_loop_tolerates_null_item | Test streaming loop tolerates null item | Streaming null item tolerance | Pipe._run_streaming_loop | monkeypatch | Tolerates null item | Medium | [ ] | | |
| test_from_completions_preserves_system_message_in_input | Test completions conversion preserves system message | Completions system message | Pipe._from_completions | None | Preserves system message | Low | [ ] | | |
| test_merge_valves_no_overrides_returns_global | Test merge_valves returns global when no overrides | Valve merge no override | Pipe._merge_valves | None | Returns global valves | Low | [ ] | | |
| test_merge_valves_applies_user_boolean_override | Test merge_valves applies user boolean override | Valve merge boolean | Pipe._merge_valves | None | Applies boolean override | Low | [ ] | | |
| test_merge_valves_honors_reasoning_retention_alias | Test merge_valves honors reasoning retention alias | Valve merge alias | Pipe._merge_valves | None | Honors alias | Low | [ ] | | |
| test_redis_candidate_requires_full_multiworker_env | Test Redis candidate requires full multiworker env | Redis candidate requirements | Pipe.__init__ | monkeypatch, caplog | Requires full env | Low | [ ] | | |
| test_redis_candidate_enabled_with_complete_env | Test Redis candidate enabled with complete env | Redis candidate with env | Pipe.__init__ | monkeypatch | Enabled with complete env | Low | [ ] | | |
| test_apply_task_reasoning_preferences_sets_effort | Test apply_task_reasoning_preferences sets effort | Task reasoning effort | Pipe._apply_task_reasoning_preferences | None | Sets effort correctly | Low | [ ] | | |
| test_apply_task_reasoning_preferences_include_only | Test apply_task_reasoning_preferences include only | Task reasoning include | Pipe._apply_task_reasoning_preferences | None | Sets include parameter | Low | [ ] | | |
| test_retry_without_reasoning_handles_thinking_error | Test retry_without_reasoning handles thinking error | Retry without reasoning | Pipe._retry_without_reasoning | None | Handles thinking error | Low | [ ] | | |
| test_retry_without_reasoning_ignores_unrelated_errors | Test retry_without_reasoning ignores unrelated errors | Retry without reasoning filter | Pipe._retry_without_reasoning | None | Ignores unrelated errors | Low | [ ] | | |
| test_apply_reasoning_preferences_prefers_reasoning_payload | Test apply_reasoning_preferences prefers reasoning payload | Reasoning preference priority | Pipe._apply_reasoning_preferences | None | Prefers reasoning payload | Low | [ ] | | |
| test_apply_reasoning_preferences_legacy_only_sets_flag | Test apply_reasoning_preferences legacy only sets flag | Reasoning legacy flag | Pipe._apply_reasoning_preferences | None | Sets legacy flag | Low | [ ] | | |
| test_retry_without_reasoning_handles_reasoning_dict | Test retry_without_reasoning handles reasoning dict | Retry with reasoning dict | Pipe._retry_without_reasoning | None | Handles reasoning dict | Low | [ ] | | |
| test_transform_messages_skips_image_generation_artifacts | Test transform_messages skips image generation artifacts | Message transform skip artifacts | Pipe._transform_messages | monkeypatch | Skips image artifacts | Low | [ ] | | |
| test_apply_gemini_thinking_config_sets_level | Test apply_gemini_thinking_config sets level | Gemini thinking level | Pipe._apply_gemini_thinking_config | None | Sets thinking level | Low | [ ] | | |
| test_apply_gemini_thinking_config_sets_budget | Test apply_gemini_thinking_config sets budget | Gemini thinking budget | Pipe._apply_gemini_thinking_config | None | Sets thinking budget | Low | [ ] | | |
| test_task_reasoning_valve_applies_only_for_owned_models | Test task reasoning valve applies only for owned models | Task reasoning owned models | Pipe._handle_pipe_call | monkeypatch | Applies for owned models | Medium | [ ] | | |
| test_task_reasoning_valve_skips_unowned_models | Test task reasoning valve skips unowned models | Task reasoning unowned models | Pipe._handle_pipe_call | monkeypatch | Skips unowned models | Medium | [ ] | | |
| test_task_models_dump_costs_when_usage_available | Test task models dump costs when usage available | Task cost dumping | Pipe._handle_pipe_call | monkeypatch | Dumps costs with usage | Medium | [ ] | | |
| test_task_models_apply_identifier_valves_to_payload | Test task models apply identifier valves to payload | Task identifier valves | Pipe._handle_pipe_call | monkeypatch | Applies identifier valves | Medium | [ ] | | |
| test_sum_pricing_values_walks_all_nodes | Test sum_pricing_values walks all nodes | Pricing walk | Pipe._sum_pricing_values | None | Walks all nodes | Low | [ ] | | |
| test_free_model_requires_numeric_pricing | Test free model requires numeric pricing | Free model numeric check | Pipe._is_free_model | monkeypatch | Requires numeric pricing | Low | [ ] | | |
| test_model_filters_respect_free_mode | Test model filters respect free mode | Model filter free mode | Pipe._apply_model_filters | None | Respects free mode | Low | [ ] | | |
| test_model_restricted_template_includes_filter_name | Test model restricted template includes filter name | Model restriction template | Pipe._emit_model_restricted_error | monkeypatch | Includes filter name | Medium | [ ] | | |
| test_resolve_openrouter_api_key_missing | Test resolve_openrouter_api_key missing | API key missing | Pipe._resolve_openrouter_api_key | pipe_instance | Raises on missing key | Low | [ ] | | |
| test_resolve_openrouter_api_key_encrypted_invalid | Test resolve_openrouter_api_key encrypted invalid | API key invalid encryption | Pipe._resolve_openrouter_api_key | monkeypatch, pipe_instance | Handles invalid encryption | Low | [ ] | | |
| test_resolve_openrouter_api_key_plain | Test resolve_openrouter_api_key plain | API key plain | Pipe._resolve_openrouter_api_key | pipe_instance | Returns plain key | Low | [ ] | | |
| test_cache_control_helpers | Test cache control helpers | Cache control helper functions | Pipe._input_contains_cache_control, Pipe._strip_cache_control_from_input | None | Helpers work correctly | Low | [ ] | | |
| test_build_task_fallback_content | Test build_task_fallback_content | Task fallback content | Pipe._build_task_fallback_content | pipe_instance | Returns fallback content | Low | [ ] | | |
| test_auth_failure_scope_key_prefers_user_then_session | Test auth failure scope key prefers user then session | Auth scope key priority | Pipe._auth_failure_scope_key | None | Prefers user over session | Low | [ ] | | |
| test_ensure_concurrency_controls_initializes_queue | Test ensure_concurrency_controls initializes queue | Concurrency queue init | Pipe._ensure_concurrency_controls | pipe_instance | Initializes queue | Low | [ ] | | |
| test_enqueue_job_queue_full | Test enqueue_job queue full | Job enqueue full queue | Pipe._enqueue_job | pipe_instance | Handles full queue | Low | [ ] | | |
| test_run_tool_with_retries_success_and_missing_callable | Test run_tool_with_retries success and missing callable | Tool retry success/missing | Pipe._run_tool_with_retries | pipe_instance | Handles both cases | Low | [ ] | | |
| test_maybe_dump_costs_snapshot_writes_to_redis | Test maybe_dump_costs_snapshot writes to Redis | Cost snapshot Redis write | Pipe._maybe_dump_costs_snapshot | pipe_instance | Writes to Redis | Low | [ ] | | |
| test_resolve_session_log_archive_settings_disabled | Test resolve_session_log_archive_settings disabled | Archive settings disabled | Pipe._resolve_session_log_archive_settings | pipe_instance | Returns None when disabled | Low | [ ] | | |
| test_resolve_session_log_archive_settings_missing_dir_or_password | Test resolve_session_log_archive_settings missing dir or password | Archive settings validation | Pipe._resolve_session_log_archive_settings | pipe_instance, monkeypatch, tmp_path | Returns None for missing | Low | [ ] | | |
| test_resolve_session_log_archive_settings_success | Test resolve_session_log_archive_settings success | Archive settings success | Pipe._resolve_session_log_archive_settings | pipe_instance, monkeypatch, tmp_path | Returns settings tuple | Low | [ ] | | |
| test_enqueue_session_log_archive_queues_job | Test enqueue_session_log_archive queues job | Archive enqueue | Pipe._enqueue_session_log_archive | pipe_instance, monkeypatch, tmp_path | Queues job | Low | [ ] | | |
| test_enqueue_session_log_archive_queue_full | Test enqueue_session_log_archive queue full | Archive enqueue full | Pipe._enqueue_session_log_archive | pipe_instance, monkeypatch, tmp_path, caplog | Handles full queue | Low | [ ] | | |
| test_assemble_and_write_session_log_bundle_writes_zip | Test assemble_and_write_session_log_bundle writes zip | Archive bundle write | Pipe._assemble_and_write_session_log_bundle | pipe_instance, monkeypatch, tmp_path | Writes zip file | Low | [ ] | | |
| test_run_session_log_assembler_once_handles_terminal_and_stale | Test run_session_log_assembler_once handles terminal and stale | Assembler terminal/stale | Pipe._run_session_log_assembler_once | pipe_instance | Handles terminal and stale | Low | [ ] | | |
| test_shutdown_db_executor_non_blocking_by_default | Test shutdown db_executor non-blocking by default | DB executor shutdown | Pipe._shutdown_db_executor | None | Non-blocking by default | Low | [ ] | | |
| test_shutdown_falls_back_when_cancel_futures_unsupported | Test shutdown falls back when cancel_futures unsupported | Shutdown fallback | Pipe._shutdown_db_executor | None | Falls back gracefully | Low | [ ] | | |
| test_shutdown_tolerates_executor_shutdown_exceptions | Test shutdown tolerates executor shutdown exceptions | Shutdown exception tolerance | Pipe._shutdown_db_executor | None | Tolerates exceptions | Low | [ ] | | |
| test_pipe_init_redis_candidate_warnings | Test pipe init redis candidate warnings | Redis candidate warnings | Pipe.__init__ | monkeypatch | Logs warnings | Low | [ ] | | |
| test_pipe_init_invalid_uvicorn_workers_defaults | Test pipe init invalid uvicorn workers defaults | Invalid workers default | Pipe.__init__ | monkeypatch | Uses default on invalid | Low | [ ] | | |
| test_startup_checks_defer_without_loop | Test startup checks defer without loop | Startup defer no loop | Pipe._maybe_start_startup_checks | monkeypatch | Defers without loop | Low | [ ] | | |
| test_maybe_start_log_worker_initializes_queue | Test maybe_start_log_worker initializes queue | Log worker queue init | Pipe._maybe_start_log_worker | pipe_instance_async | Initializes queue | Low | [ ] | | |
| test_ensure_async_subsystems_initialized | Test ensure_async_subsystems_initialized | Async subsystem init | Pipe._ensure_async_subsystems_initialized | pipe_instance_async | Initializes subsystems | Low | [ ] | | |
| test_init_redis_client_success | Test init_redis_client success | Redis client init success | Pipe._init_redis_client | monkeypatch, pipe_instance_async | Initializes successfully | Low | [ ] | | |
| test_init_redis_client_failure_disables_cache | Test init_redis_client failure disables cache | Redis client init failure | Pipe._init_redis_client | monkeypatch, pipe_instance_async | Disables cache on failure | Low | [ ] | | |
| test_extract_feature_flags_uses_flat_metadata_shape | Test extract_feature_flags uses flat metadata shape | Feature flag extraction | Pipe._extract_feature_flags | None | Uses flat shape | Low | [ ] | | |
| test_extract_feature_flags_does_not_assume_nested_by_pipe_id | Test extract_feature_flags does not assume nested by pipe ID | Feature flag no nesting | Pipe._extract_feature_flags | None | Does not assume nested | Low | [ ] | | |
| test_stop_redis_cancels_tasks_and_closes_client | Test stop_redis cancels tasks and closes client | Redis stop | Pipe._stop_redis | pipe_instance_async | Cancels and closes | Low | [ ] | | |
| test_stop_redis_logs_close_failure | Test stop_redis logs close failure | Redis close failure log | Pipe._stop_redis | caplog, pipe_instance_async | Logs close failure | Low | [ ] | | |
| test_maybe_start_session_log_workers_creates_threads | Test maybe_start_session_log_workers creates threads | Session log thread creation | Pipe._maybe_start_session_log_workers | pipe_for_session_log | Creates threads | Low | [ ] | | |
| test_maybe_start_session_log_workers_idempotent | Test maybe_start_session_log_workers idempotent | Session log worker idempotency | Pipe._maybe_start_session_log_workers | pipe_for_session_log | Idempotent | Low | [ ] | | |
| test_maybe_start_session_log_assembler_worker_creates_thread | Test maybe_start_session_log_assembler_worker creates thread | Assembler thread creation | Pipe._maybe_start_session_log_assembler_worker | pipe_for_session_log | Creates thread | Low | [ ] | | |
| test_maybe_start_session_log_assembler_worker_idempotent | Test maybe_start_session_log_assembler_worker idempotent | Assembler worker idempotency | Pipe._maybe_start_session_log_assembler_worker | pipe_for_session_log | Idempotent | Low | [ ] | | |
| test_persist_session_log_segment_skips_when_disabled | Test persist_session_log_segment skips when disabled | Session log persist disabled | Pipe._persist_session_log_segment_to_db | None | Skips when disabled | Low | [ ] | | |
| test_persist_session_log_segment_skips_when_missing_ids | Test persist_session_log_segment skips when missing IDs | Session log persist missing IDs | Pipe._persist_session_log_segment_to_db | None | Skips with missing IDs | Low | [ ] | | |
| test_persist_session_log_segment_skips_when_no_events | Test persist_session_log_segment skips when no events | Session log persist no events | Pipe._persist_session_log_segment_to_db | None | Skips with no events | Low | [ ] | | |
| test_persist_session_log_segment_skips_when_archive_settings_unavailable | Test persist_session_log_segment skips when archive settings unavailable | Session log persist no settings | Pipe._persist_session_log_segment_to_db | None | Skips without settings | Low | [ ] | | |
| test_convert_jsonl_to_internal_converts_ts_to_created | Test convert_jsonl_to_internal converts ts to created | JSONL conversion ts | Pipe._convert_jsonl_to_internal | None | Converts ts to created | Low | [ ] | | |
| test_convert_jsonl_to_internal_preserves_existing_created | Test convert_jsonl_to_internal preserves existing created | JSONL conversion preserve | Pipe._convert_jsonl_to_internal | None | Preserves existing created | Low | [ ] | | |
| test_convert_jsonl_to_internal_handles_invalid_ts | Test convert_jsonl_to_internal handles invalid ts | JSONL conversion invalid ts | Pipe._convert_jsonl_to_internal | None | Handles invalid ts | Low | [ ] | | |
| test_dedupe_session_log_events_removes_duplicates | Test dedupe_session_log_events removes duplicates | Session log dedupe | Pipe._dedupe_session_log_events | None | Removes duplicates | Low | [ ] | | |
| test_dedupe_session_log_events_preserves_order | Test dedupe_session_log_events preserves order | Session log dedupe order | Pipe._dedupe_session_log_events | None | Preserves order | Low | [ ] | | |
| test_sum_pricing_values_handles_decimal_type | Test sum_pricing_values handles Decimal type | Pricing Decimal | Pipe._sum_pricing_values | None | Handles Decimal | Low | [ ] | | |
| test_sum_pricing_values_handles_string_type | Test sum_pricing_values handles string type | Pricing string | Pipe._sum_pricing_values | None | Handles string | Low | [ ] | | |
| test_sum_pricing_values_handles_empty_string | Test sum_pricing_values handles empty string | Pricing empty string | Pipe._sum_pricing_values | None | Handles empty string | Low | [ ] | | |
| test_sum_pricing_values_handles_invalid_string | Test sum_pricing_values handles invalid string | Pricing invalid string | Pipe._sum_pricing_values | None | Handles invalid string | Low | [ ] | | |
| test_sum_pricing_values_handles_non_numeric_non_container | Test sum_pricing_values handles non-numeric non-container | Pricing non-numeric | Pipe._sum_pricing_values | None | Handles non-numeric | Low | [ ] | | |
| test_get_file_by_id_delegates_to_handler | Test get_file_by_id delegates to handler | File by ID delegation | Pipe._get_file_by_id | Mock, AsyncMock | Delegates to handler | Low | [ ] | | |
| test_get_file_by_id_returns_none_when_no_handler | Test get_file_by_id returns None when no handler | File by ID no handler | Pipe._get_file_by_id | None | Returns None | Low | [ ] | | |
| test_infer_file_mime_type_delegates_to_handler | Test infer_file_mime_type delegates to handler | Mime type delegation | Pipe._infer_file_mime_type | Mock | Delegates to handler | Low | [ ] | | |
| test_infer_file_mime_type_returns_octet_stream_when_no_handler | Test infer_file_mime_type returns octet-stream when no handler | Mime type no handler | Pipe._infer_file_mime_type | None | Returns octet-stream | Low | [ ] | | |
| test_inline_owui_file_id_returns_none_when_no_handler | Test inline_owui_file_id returns None when no handler | Inline file no handler | Pipe._inline_owui_file_id | None | Returns None | Low | [ ] | | |
| test_inline_internal_file_url_returns_none_when_no_handler | Test inline_internal_file_url returns None when no handler | Inline URL no handler | Pipe._inline_internal_file_url | None | Returns None | Low | [ ] | | |
| test_inline_internal_responses_input_files_returns_when_no_handler | Test inline_internal_responses_input_files returns when no handler | Inline responses no handler | Pipe._inline_internal_responses_input_files_inplace | None | Returns without error | Low | [ ] | | |
| test_read_file_record_base64_returns_none_when_no_handler | Test read_file_record_base64 returns None when no handler | Read file no handler | Pipe._read_file_record_base64 | None | Returns None | Low | [ ] | | |
| test_encode_file_path_base64_raises_when_no_handler | Test encode_file_path_base64 raises when no handler | Encode file no handler | Pipe._encode_file_path_base64 | None | Raises RuntimeError | Low | [ ] | | |
| test_maybe_heal_index_conflict_delegates_to_artifact_store | Test maybe_heal_index_conflict delegates to artifact store | Index conflict delegation | Pipe._maybe_heal_index_conflict | Mock | Delegates to artifact store | Low | [ ] | | |
| test_get_fernet_delegates_to_artifact_store | Test get_fernet delegates to artifact store | Fernet delegation | Pipe._get_fernet | Mock | Delegates to artifact store | Low | [ ] | | |
| test_should_encrypt_delegates_to_artifact_store | Test should_encrypt delegates to artifact store | Encrypt check delegation | Pipe._should_encrypt | Mock | Delegates to artifact store | Low | [ ] | | |
| test_serialize_payload_bytes_delegates_to_artifact_store | Test serialize_payload_bytes delegates to artifact store | Serialize delegation | Pipe._serialize_payload_bytes | Mock | Delegates to artifact store | Low | [ ] | | |
| test_maybe_compress_payload_delegates_to_artifact_store | Test maybe_compress_payload delegates to artifact store | Compress delegation | Pipe._maybe_compress_payload | Mock | Delegates to artifact store | Low | [ ] | | |
| test_encode_payload_bytes_delegates_to_artifact_store | Test encode_payload_bytes delegates to artifact store | Encode delegation | Pipe._encode_payload_bytes | Mock | Delegates to artifact store | Low | [ ] | | |
| test_decode_payload_bytes_delegates_to_artifact_store | Test decode_payload_bytes delegates to artifact store | Decode delegation | Pipe._decode_payload_bytes | Mock | Delegates to artifact store | Low | [ ] | | |
| test_lz4_decompress_delegates_to_artifact_store | Test lz4_decompress delegates to artifact store | LZ4 decompress delegation | Pipe._lz4_decompress | Mock | Delegates to artifact store | Low | [ ] | | |
| test_encrypt_payload_delegates_to_artifact_store | Test encrypt_payload delegates to artifact store | Encrypt payload delegation | Pipe._encrypt_payload | Mock | Delegates to artifact store | Low | [ ] | | |
| test_decrypt_payload_delegates_to_artifact_store | Test decrypt_payload delegates to artifact store | Decrypt payload delegation | Pipe._decrypt_payload | Mock | Delegates to artifact store | Low | [ ] | | |
| test_encrypt_if_needed_delegates_to_artifact_store | Test encrypt_if_needed delegates to artifact store | Encrypt if needed delegation | Pipe._encrypt_if_needed | Mock | Delegates to artifact store | Low | [ ] | | |
| test_prepare_rows_for_storage_delegates_to_artifact_store | Test prepare_rows_for_storage delegates to artifact store | Prepare rows delegation | Pipe._prepare_rows_for_storage | Mock | Delegates to artifact store | Low | [ ] | | |
| test_make_db_row_delegates_to_artifact_store | Test make_db_row delegates to artifact store | Make row delegation | Pipe._make_db_row | Mock | Delegates to artifact store | Low | [ ] | | |
| test_merge_valves_with_dict_user_valves | Test merge_valves with dict user valves | Valve merge dict | Pipe._merge_valves | None | Handles dict user valves | Low | [ ] | | |
| test_merge_valves_with_inherit_value | Test merge_valves with INHERIT value | Valve merge INHERIT | Pipe._merge_valves | None | Ignores INHERIT values | Low | [ ] | | |
| test_merge_valves_with_next_reply_alias | Test merge_valves with next_reply alias | Valve merge alias | Pipe._merge_valves | None | Maps next_reply alias | Low | [ ] | | |
| test_merge_valves_with_unknown_fields | Test merge_valves with unknown fields | Valve merge unknown | Pipe._merge_valves | None | Ignores unknown fields | Low | [ ] | | |
| test_maybe_start_log_worker_handles_stale_lock | Test maybe_start_log_worker handles stale lock | Log worker stale lock | Pipe._maybe_start_log_worker | None | Handles stale lock | Low | [ ] | | |
| test_maybe_start_log_worker_handles_stale_queue | Test maybe_start_log_worker handles stale queue | Log worker stale queue | Pipe._maybe_start_log_worker | None | Handles stale queue | Low | [ ] | | |
| test_shutdown_stops_all_workers | Test shutdown stops all workers | Shutdown worker stop | Pipe.shutdown | None | Stops all workers | Low | [ ] | | |
| test_close_async_cleanup | Test close async cleanup | Close async | Pipe.close | None | Completes without error | Low | [ ] | | |
| test_stop_session_log_workers_handles_missing_threads | Test stop_session_log_workers handles missing threads | Session log stop missing | Pipe._stop_session_log_workers | None | Handles missing threads | Low | [ ] | | |
| test_persist_session_log_segment_to_db_with_successful_persist | Test persist_session_log_segment_to_db with successful persist | Session log persist success | Pipe._persist_session_log_segment_to_db | AsyncMock, Mock | Persists successfully | Low | [ ] | | |
| test_persist_session_log_segment_to_db_handles_exception | Test persist_session_log_segment_to_db handles exception | Session log persist exception | Pipe._persist_session_log_segment_to_db | AsyncMock, Mock | Handles exception | Low | [ ] | | |
| test_tool_type_allows_returns_false_after_many_failures | Test tool_type_allows returns False after many failures | Tool type breaker trip | Pipe._tool_type_allows | None | Returns False after failures | Low | [ ] | | |
| test_breaker_records_multiple_failures | Test breaker records multiple failures | Breaker failure recording | Pipe._record_failure | None | Records failures | Low | [ ] | | |
| test_encrypted_str_decrypt_returns_empty_for_empty | Test EncryptedStr.decrypt returns empty for empty | Encrypted string empty | EncryptedStr.decrypt | None | Returns empty string | Low | [ ] | | |
| test_pipe_logger_is_configured | Test Pipe logger is configured | Logger configuration | Pipe.logger | None | Logger has methods | Low | [ ] | | |
| test_pipe_log_level_can_be_set | Test Pipe log level can be set | Log level configuration | Pipe.valves.LOG_LEVEL | None | Log level configurable | Low | [ ] | | |
| test_ensure_direct_uploads_filter_returns_none_when_valve_disabled | Test direct uploads filter returns None when valve disabled | Direct uploads filter disabled | Pipe._ensure_direct_uploads_filter_function_id | Mock, patch | Returns None | Low | [ ] | | |
| test_ensure_direct_uploads_filter_with_auto_install_enabled | Test direct uploads filter with auto install enabled | Direct uploads filter enabled | Pipe._ensure_direct_uploads_filter_function_id | Mock, patch | Auto-installs filter | Medium | [ ] | | |
| test_ensure_direct_uploads_filter_suffix_loop_limit | Test direct uploads filter suffix loop limit | Direct uploads suffix limit | Pipe._ensure_direct_uploads_filter_function_id | Mock, patch | Stops after 50 attempts | Low | [ ] | | |
| test_ensure_direct_uploads_filter_updates_existing | Test direct uploads filter updates existing | Direct uploads update | Pipe._ensure_direct_uploads_filter_function_id | Mock, patch | Updates existing filter | Medium | [ ] | | |
| test_emit_templated_error_for_unexpected_exception | Test emit_templated_error for unexpected exception | Error emission | Pipe._emit_templated_error | Mock | Emits error event | Low | [ ] | | |
| test_emit_templated_error_handles_none_emitter | Test emit_templated_error handles None emitter | Error emission no emitter | Pipe._emit_templated_error | None | Handles None emitter | Low | [ ] | | |
| test_execute_tool_batch_empty_batch | Test execute_tool_batch empty batch | Tool batch empty | Pipe._execute_tool_batch | None | Returns early for empty | Low | [ ] | | |
| test_execute_tool_batch_with_timeout | Test execute_tool_batch with timeout | Tool batch timeout | Pipe._execute_tool_batch | asyncio | Handles timeout | Low | [ ] | | |
| test_execute_tool_batch_with_exception_result | Test execute_tool_batch with exception result | Tool batch exception | Pipe._execute_tool_batch | asyncio | Handles exception | Low | [ ] | | |
| test_execute_tool_batch_successful_execution | Test execute_tool_batch successful execution | Tool batch success | Pipe._execute_tool_batch | asyncio | Executes successfully | Low | [ ] | | |
| test_run_tool_without_tenacity_success | Test run_tool without tenacity success | Tool run no tenacity | Pipe._run_tool_with_retries | patch | Succeeds without tenacity | Low | [ ] | | |
| test_run_tool_with_missing_callable | Test run_tool with missing callable | Tool run no callable | Pipe._run_tool_with_retries | None | Returns failed status | Low | [ ] | | |
| test_read_session_log_archive_events_with_valid_zip | Test read_session_log_archive_events with valid zip | Archive read valid | Pipe._read_session_log_archive_events | tmp_path, pyzipper | Reads events from zip | Low | [ ] | | |
| test_read_session_log_archive_events_with_malformed_json | Test read_session_log_archive_events with malformed JSON | Archive read malformed | Pipe._read_session_log_archive_events | tmp_path, pyzipper | Skips malformed lines | Low | [ ] | | |
| test_maybe_start_session_log_assembler_worker_starts_thread | Test maybe_start_session_log_assembler_worker starts thread | Assembler start | Pipe._maybe_start_session_log_assembler_worker | tmp_path | Starts thread | Low | [ ] | | |
| test_assembler_worker_handles_exception_in_loop | Test assembler worker handles exception in loop | Assembler exception | Pipe._maybe_start_session_log_assembler_worker | tmp_path, patch | Handles exception | Low | [ ] | | |
| test_session_log_writer_handles_queue_empty | Test session log writer handles queue.Empty | Session log writer empty | Pipe._maybe_start_session_log_workers | None | Handles empty queue | Low | [ ] | | |
| test_session_log_writer_handles_exception_in_write | Test session log writer handles exception in write | Session log writer exception | Pipe._maybe_start_session_log_workers | patch | Handles write exception | Low | [ ] | | |
| test_shutdown_tool_context_with_zero_timeout | Test shutdown_tool_context with zero timeout | Tool context shutdown | Pipe._shutdown_tool_context | asyncio | Immediate cancellation | Low | [ ] | | |
| test_shutdown_tool_context_with_exception | Test shutdown_tool_context with exception | Tool context exception | Pipe._shutdown_tool_context | AsyncMock | Handles exception | Low | [ ] | | |
| test_invoke_tool_call_with_global_semaphore | Test invoke_tool_call with global semaphore | Tool invoke semaphore | Pipe._invoke_tool_call | asyncio | Acquires semaphore | Low | [ ] | | |
| test_call_tool_callable_sync_function | Test call_tool_callable sync function | Tool call sync | Pipe._call_tool_callable | None | Calls sync function | Low | [ ] | | |
| test_call_tool_callable_async_function | Test call_tool_callable async function | Tool call async | Pipe._call_tool_callable | None | Calls async function | Low | [ ] | | |
| test_call_tool_callable_sync_returning_awaitable | Test call_tool_callable sync returning awaitable | Tool call sync awaitable | Pipe._call_tool_callable | None | Handles sync returning awaitable | Low | [ ] | | |
| test_acquire_tool_global_releases_on_exit | Test acquire_tool_global releases on exit | Tool global release | Pipe._acquire_tool_global | asyncio | Releases on exit | Low | [ ] | | |
| test_acquire_tool_global_releases_on_exception | Test acquire_tool_global releases on exception | Tool global exception release | Pipe._acquire_tool_global | asyncio, pytest.raises | Releases on exception | Low | [ ] | | |
| test_resolve_settings_pyzipper_not_available | Test resolve_settings pyzipper not available | Archive settings no pyzipper | Pipe._resolve_session_log_archive_settings | caplog, patch | Returns None | Low | [ ] | | |
| test_resolve_settings_empty_dir | Test resolve_settings empty dir | Archive settings empty dir | Pipe._resolve_session_log_archive_settings | caplog | Returns None | Low | [ ] | | |
| test_resolve_settings_empty_password | Test resolve_settings empty password | Archive settings empty password | Pipe._resolve_session_log_archive_settings | caplog | Returns None | Low | [ ] | | |
| test_resolve_settings_stored_compression | Test resolve_settings stored compression | Archive settings stored | Pipe._resolve_session_log_archive_settings | None | Sets compresslevel to None | Low | [ ] | | |
| test_resolve_settings_lzma_compression | Test resolve_settings lzma compression | Archive settings lzma | Pipe._resolve_session_log_archive_settings | None | Sets compresslevel to None | Low | [ ] | | |
| test_persist_session_log_fallback_to_direct_write | Test persist_session_log fallback to direct write | Session log fallback | Pipe._persist_session_log_segment_to_db | tmp_path, AsyncMock, patch | Falls back to direct write | Low | [ ] | | |
| test_convert_jsonl_with_ts_field | Test convert_jsonl with ts field | JSONL convert ts | Pipe._convert_jsonl_to_internal | None | Converts ts field | Low | [ ] | | |
| test_convert_jsonl_without_ts_field | Test convert_jsonl without ts field | JSONL convert no ts | Pipe._convert_jsonl_to_internal | None | Preserves created | Low | [ ] | | |
| test_convert_jsonl_with_invalid_ts | Test convert_jsonl with invalid ts | JSONL convert invalid | Pipe._convert_jsonl_to_internal | None | Handles invalid ts | Low | [ ] | | |
| test_run_assembler_once_no_db_handles | Test run_assembler_once no db handles | Assembler no DB | Pipe._run_session_log_assembler_once | patch | Returns early | Low | [ ] | | |
| test_notify_tool_breaker_emits_status | Test notify_tool_breaker emits status | Tool breaker notify | Pipe._notify_tool_breaker | asyncio, Mock | Emits status event | Low | [ ] | | |
| test_build_tool_output_with_all_fields | Test build_tool_output with all fields | Tool output build | Pipe._build_tool_output | None | Builds complete output | Low | [ ] | | |
| test_build_tool_output_with_failed_status | Test build_tool_output with failed status | Tool output failed | Pipe._build_tool_output | None | Normalizes status to completed | Low | [ ] | | |
| test_notify_tool_breaker_with_none_emitter | Test notify_tool_breaker with None emitter | Tool breaker no emitter | Pipe._notify_tool_breaker | asyncio | Handles None emitter | Low | [ ] | | |
| test_batchable_tool_call_with_dependency_keys | Test batchable_tool_call with dependency keys | Tool batchable deps | Pipe._is_batchable_tool_call | None | Returns False for deps | Low | [ ] | | |
| test_tool_worker_loop_processes_items | Test tool_worker_loop processes items | Tool worker process | Pipe._tool_worker_loop | asyncio | Processes items | Low | [ ] | | |
| test_tool_worker_loop_handles_timeout | Test tool_worker_loop handles timeout | Tool worker timeout | Pipe._tool_worker_loop | asyncio | Sets timeout error | Low | [ ] | | |
| test_can_batch_tool_calls_same_name | Test can_batch_tool_calls same name | Tool batch same name | Pipe._can_batch_tool_calls | Mock | Returns True | Low | [ ] | | |
| test_can_batch_tool_calls_different_name | Test can_batch_tool_calls different name | Tool batch diff name | Pipe._can_batch_tool_calls | Mock | Returns False | Low | [ ] | | |
| test_can_batch_tool_calls_with_dependency | Test can_batch_tool_calls with dependency | Tool batch dependency | Pipe._can_batch_tool_calls | Mock | Returns False | Low | [ ] | | |
| test_emit_status_with_emitter | Test emit_status with emitter | Status emission | Pipe._emit_status | Mock | Emits status | Low | [ ] | | |
| test_emit_status_with_none_emitter | Test emit_status with None emitter | Status no emitter | Pipe._emit_status | None | Handles None emitter | Low | [ ] | | |
| test_emit_error_with_string_error | Test emit_error with string error | Error emission string | Pipe._emit_error | Mock | Emits error | Low | [ ] | | |
| test_emit_error_with_exception | Test emit_error with exception | Error emission exception | Pipe._emit_error | Mock | Emits exception | Low | [ ] | | |
| test_build_icon_mapping | Test build_icon_mapping | Icon mapping | Pipe._build_icon_mapping | None | Returns dict | Low | [ ] | | |
| test_build_web_search_support_mapping | Test build_web_search_support_mapping | Web search mapping | Pipe._build_web_search_support_mapping | None | Returns dict | Low | [ ] | | |
| test_dedupe_session_log_events_empty_list | Test dedupe_session_log_events empty list | Dedupe empty | Pipe._dedupe_session_log_events | None | Returns empty list | Low | [ ] | | |
| test_dedupe_session_log_events_unique_events | Test dedupe_session_log_events unique events | Dedupe unique | Pipe._dedupe_session_log_events | None | Returns all events | Low | [ ] | | |
| test_args_reference_call_with_depends_on | Test args_reference_call with depends_on | Args reference depends | Pipe._args_reference_call | None | Detects depends_on | Low | [ ] | | |
| test_args_reference_call_no_reference | Test args_reference_call no reference | Args reference none | Pipe._args_reference_call | None | Returns False | Low | [ ] | | |
| test_ensure_tool_executor_creates_instance | Test ensure_tool_executor creates instance | Tool executor create | Pipe._ensure_tool_executor | None | Creates instance | Low | [ ] | | |
| test_write_session_log_archive | Test write_session_log_archive | Archive write | Pipe._write_session_log_archive | tmp_path | Creates zip file | Low | [ ] | | |
| test_circuit_breaker_instance | Test circuit_breaker instance | Breaker instance | Pipe._circuit_breaker | None | Instance exists | Low | [ ] | | |
| test_stop_session_log_workers | Test stop_session_log_workers | Session log stop | Pipe._stop_session_log_workers | tmp_path | Stops workers | Low | [ ] | | |
| test_enqueue_session_log_archive | Test enqueue_session_log_archive | Archive enqueue | Pipe._enqueue_session_log_archive | tmp_path | Enqueues job | Low | [ ] | | |
| test_upload_to_owui_storage_with_no_handler | Test upload_to_owui_storage with no handler | Upload no handler | Pipe._upload_to_owui_storage | None | Returns None | Low | [ ] | | |
| test_try_link_file_to_chat_with_no_handler | Test try_link_file_to_chat with no handler | Link file no handler | Pipe._try_link_file_to_chat | None | Returns False | Low | [ ] | | |
| test_resolve_storage_context_with_no_handler | Test resolve_storage_context with no handler | Storage context no handler | Pipe._resolve_storage_context | None | Returns (None, None) | Low | [ ] | | |
| test_emit_status_with_no_handler | Test emit_status with no handler | Status no handler | Pipe._emit_status | Mock | Returns early | Low | [ ] | | |
| test_looks_like_responses_unsupported | Test looks_like_responses_unsupported | Responses unsupported check | Pipe._looks_like_responses_unsupported | Mock | Returns boolean | Low | [ ] | | |
| test_timing_log_config_success | Test timing log config success | Timing config success | Pipe.__init__ | tmp_path, monkeypatch, patch | Configures successfully | Low | [ ] | | |
| test_timing_log_config_failure | Test timing log config failure | Timing config failure | Pipe.__init__ | tmp_path, monkeypatch, caplog, patch | Logs warning | Low | [ ] | | |
| test_ors_filter_matches_candidate_empty_content | Test ORS filter matches candidate empty content | ORS filter empty | Pipe._ensure_ors_filter_function_id | MagicMock, patch | Returns None | Low | [ ] | | |
| test_ors_filter_feature_flag_match | Test ORS filter feature flag match | ORS filter flag | Pipe._ensure_ors_filter_function_id | MagicMock, patch | Returns filter ID | Low | [ ] | | |
| test_ors_filter_get_functions_exception | Test ORS filter get_functions exception | ORS filter exception | Pipe._ensure_ors_filter_function_id | MagicMock, patch | Returns None | Low | [ ] | | |
| test_ors_filter_multiple_candidates_warning | Test ORS filter multiple candidates warning | ORS filter multiple | Pipe._ensure_ors_filter_function_id | MagicMock, patch, caplog | Warns and picks newest | Low | [ ] | | |
| test_ors_filter_get_function_by_id_exception | Test ORS filter get_function_by_id exception | ORS filter ID exception | Pipe._ensure_ors_filter_function_id | MagicMock, patch | Handles exception | Low | [ ] | | |
| test_ors_filter_suffix_overflow | Test ORS filter suffix overflow | ORS filter overflow | Pipe._ensure_ors_filter_function_id | MagicMock, patch | Returns None | Low | [ ] | | |
| test_ors_filter_insert_fails | Test ORS filter insert fails | ORS filter insert fail | Pipe._ensure_ors_filter_function_id | MagicMock, patch | Returns None | Low | [ ] | | |
| test_ors_filter_empty_function_id | Test ORS filter empty function ID | ORS filter empty ID | Pipe._ensure_ors_filter_function_id | MagicMock, patch | Returns None | Low | [ ] | | |
| test_ors_filter_update_matching_source | Test ORS filter update matching source | ORS filter update | Pipe._ensure_ors_filter_function_id | MagicMock, patch | Updates filter | Medium | [ ] | | |
| test_direct_uploads_filter_get_functions_exception | Test direct uploads filter get_functions exception | Direct uploads exception | Pipe._ensure_direct_uploads_filter_function_id | MagicMock, patch | Returns None | Low | [ ] | | |
| test_direct_uploads_filter_multiple_candidates | Test direct uploads filter multiple candidates | Direct uploads multiple | Pipe._ensure_direct_uploads_filter_function_id | MagicMock, patch, caplog | Warns and picks newest | Low | [ ] | | |
| test_direct_uploads_filter_exception_get_by_id | Test direct uploads filter exception get_by_id | Direct uploads ID exception | Pipe._ensure_direct_uploads_filter_function_id | MagicMock, patch | Handles exception | Low | [ ] | | |
| test_direct_uploads_filter_suffix_overflow | Test direct uploads filter suffix overflow | Direct uploads overflow | Pipe._ensure_direct_uploads_filter_function_id | MagicMock, patch | Returns None | Low | [ ] | | |
| test_direct_uploads_filter_insert_fails | Test direct uploads filter insert fails | Direct uploads insert fail | Pipe._ensure_direct_uploads_filter_function_id | MagicMock, patch | Returns None | Low | [ ] | | |
| test_direct_uploads_filter_empty_function_id | Test direct uploads filter empty function ID | Direct uploads empty ID | Pipe._ensure_direct_uploads_filter_function_id | MagicMock, patch | Returns None | Low | [ ] | | |
| test_direct_uploads_filter_update_matching_source | Test direct uploads filter update matching source | Direct uploads update | Pipe._ensure_direct_uploads_filter_function_id | MagicMock, patch | Updates filter | Medium | [ ] | | |
| test_pipes_auto_install_ors_filter_exception | Test pipes auto install ORS filter exception | Pipes ORS exception | Pipe.pipes | caplog, patch | Logs debug message | Medium | [ ] | | |
| test_pipes_auto_install_direct_uploads_filter_exception | Test pipes auto install direct uploads filter exception | Pipes direct uploads exception | Pipe.pipes | caplog, patch | Logs debug message | Medium | [ ] | | |
| test_log_worker_stale_lock_runtime_error | Test log worker stale lock RuntimeError | Log worker lock error | Pipe._maybe_start_log_worker | MagicMock, asyncio.run | Replaces lock | Low | [ ] | | |
| test_log_worker_stale_worker_cancel | Test log worker stale worker cancel | Log worker cancel | Pipe._maybe_start_log_worker | MagicMock, asyncio.run | Cancels stale task | Low | [ ] | | |
| test_redis_already_enabled | Test Redis already enabled | Redis enabled check | Pipe._maybe_start_redis | asyncio.run | Returns early | Low | [ ] | | |
| test_redis_no_running_loop | Test Redis no running loop | Redis no loop | Pipe._maybe_start_redis | None | Returns without error | Low | [ ] | | |
| test_redis_ready_task_in_progress | Test Redis ready task in progress | Redis task in progress | Pipe._maybe_start_redis | MagicMock, asyncio.run | Returns early | Low | [ ] | | |
| test_cleanup_task_in_progress | Test cleanup task in progress | Cleanup in progress | Pipe._maybe_start_cleanup | MagicMock, asyncio.run | Returns early | Low | [ ] | | |
| test_cleanup_no_running_loop | Test cleanup no running loop | Cleanup no loop | Pipe._maybe_start_cleanup | None | Returns without error | Low | [ ] | | |
| test_init_redis_already_enabled | Test init_redis already enabled | Redis init enabled | Pipe._init_redis_client | None | Returns early | Low | [ ] | | |
| test_init_redis_client_none | Test init_redis client None | Redis client None | Pipe._init_redis_client | MagicMock, patch | Handles None client | Low | [ ] | | |
| test_startup_already_started_not_pending | Test startup already started not pending | Startup started | Pipe._maybe_start_startup_checks | asyncio.run | Returns early | Low | [ ] | | |
| test_db_persist_delegation | Test db_persist delegation | DB persist delegation | Pipe._db_persist | AsyncMock, patch | Delegates to artifact store | Low | [ ] | | |
| test_db_persist_direct_delegation | Test db_persist_direct delegation | DB persist direct delegation | Pipe._db_persist_direct | AsyncMock, patch | Delegates to artifact store | Low | [ ] | | |
| test_is_duplicate_key_error_delegation | Test is_duplicate_key_error delegation | Duplicate key delegation | Pipe._is_duplicate_key_error | patch | Delegates to artifact store | Low | [ ] | | |
| test_db_fetch_delegation | Test db_fetch delegation | DB fetch delegation | Pipe._db_fetch | AsyncMock, patch | Delegates to artifact store | Low | [ ] | | |
| test_db_fetch_direct_delegation | Test db_fetch_direct delegation | DB fetch direct delegation | Pipe._db_fetch_direct | AsyncMock, patch | Delegates to artifact store | Low | [ ] | | |
| test_delete_artifacts_delegation | Test delete_artifacts delegation | Delete artifacts delegation | Pipe._delete_artifacts | AsyncMock, patch | Delegates to artifact store | Low | [ ] | | |
| test_redis_pubsub_listener_delegation | Test redis_pubsub_listener delegation | Redis pubsub delegation | Pipe._redis_pubsub_listener | AsyncMock, patch | Delegates to artifact store | Low | [ ] | | |
| test_redis_periodic_flusher_delegation | Test redis_periodic_flusher delegation | Redis flusher delegation | Pipe._redis_periodic_flusher | AsyncMock, patch | Delegates to artifact store | Low | [ ] | | |
| test_flush_redis_queue_delegation | Test flush_redis_queue delegation | Flush queue delegation | Pipe._flush_redis_queue | AsyncMock, patch | Delegates to artifact store | Low | [ ] | | |
| test_redis_cache_key_delegation | Test redis_cache_key delegation | Cache key delegation | Pipe._redis_cache_key | patch | Delegates to artifact store | Low | [ ] | | |
| test_redis_enqueue_rows_delegation | Test redis_enqueue_rows delegation | Enqueue rows delegation | Pipe._redis_enqueue_rows | AsyncMock, patch | Delegates to artifact store | Low | [ ] | | |
| test_redis_cache_rows_delegation | Test redis_cache_rows delegation | Cache rows delegation | Pipe._redis_cache_rows | AsyncMock, patch | Delegates to artifact store | Low | [ ] | | |
| test_redis_requeue_entries_delegation | Test redis_requeue_entries delegation | Requeue entries delegation | Pipe._redis_requeue_entries | AsyncMock, patch | Delegates to artifact store | Low | [ ] | | |
| test_redis_fetch_rows_delegation | Test redis_fetch_rows delegation | Fetch rows delegation | Pipe._redis_fetch_rows | AsyncMock, patch | Delegates to artifact store | Low | [ ] | | |
| test_artifact_cleanup_worker_delegation | Test artifact_cleanup_worker delegation | Cleanup worker delegation | Pipe._artifact_cleanup_worker | AsyncMock, patch | Delegates to artifact store | Low | [ ] | | |
| test_run_cleanup_once_delegation | Test run_cleanup_once delegation | Cleanup once delegation | Pipe._run_cleanup_once | AsyncMock, patch | Delegates to artifact store | Low | [ ] | | |
| test_cleanup_sync_delegation | Test cleanup_sync delegation | Cleanup sync delegation | Pipe._cleanup_sync | patch | Delegates to artifact store | Low | [ ] | | |
| test_db_breaker_allows_delegation | Test db_breaker_allows delegation | DB breaker delegation | Pipe._db_breaker_allows | patch | Delegates to artifact store | Low | [ ] | | |
| test_record_db_failure_delegation | Test record_db_failure delegation | DB failure delegation | Pipe._record_db_failure | patch | Delegates to artifact store | Low | [ ] | | |
| test_reset_db_failure_delegation | Test reset_db_failure delegation | DB reset delegation | Pipe._reset_db_failure | patch | Delegates to artifact store | Low | [ ] | | |
| test_inline_internal_file_url_no_handler | Test inline_internal_file_url no handler | Inline URL no handler | Pipe._inline_internal_file_url | None | Returns None | Low | [ ] | | |
| test_read_file_record_base64_no_handler | Test read_file_record_base64 no handler | Read file no handler | Pipe._read_file_record_base64 | MagicMock | Returns None | Low | [ ] | | |
| test_encode_file_path_base64_no_handler | Test encode_file_path_base64 no handler | Encode file no handler | Pipe._encode_file_path_base64 | pytest.raises | Raises RuntimeError | Low | [ ] | | |
| test_upload_to_owui_storage_no_handler | Test upload_to_owui_storage no handler | Upload no handler | Pipe._upload_to_owui_storage | None | Returns None | Low | [ ] | | |
| test_try_link_file_to_chat_no_handler | Test try_link_file_to_chat no handler | Link file no handler | Pipe._try_link_file_to_chat | None | Returns False | Low | [ ] | | |
| test_resolve_storage_context_no_handler | Test resolve_storage_context no handler | Storage context no handler | Pipe._resolve_storage_context | None | Returns (None, None) | Low | [ ] | | |
| test_ensure_storage_user_no_handler | Test ensure_storage_user no handler | Storage user no handler | Pipe._ensure_storage_user | None | Returns None | Low | [ ] | | |
| test_download_remote_url_no_handler | Test download_remote_url no handler | Download URL no handler | Pipe._download_remote_url | None | Returns None | Low | [ ] | | |
| test_is_safe_url_no_handler | Test is_safe_url no handler | Safe URL no handler | Pipe._is_safe_url | None | Returns False | Low | [ ] | | |
| test_is_safe_url_blocking_no_handler | Test is_safe_url_blocking no handler | Safe URL blocking no handler | Pipe._is_safe_url_blocking | None | Returns False | Low | [ ] | | |
| test_is_youtube_url_no_handler | Test is_youtube_url no handler | YouTube URL no handler | Pipe._is_youtube_url | None | Returns False | Low | [ ] | | |
| test_get_effective_remote_file_limit_mb_no_handler | Test get_effective_remote_file_limit_mb no handler | Remote limit no handler | Pipe._get_effective_remote_file_limit_mb | None | Returns 50 | Low | [ ] | | |
| test_fetch_image_as_data_url_no_handler | Test fetch_image_as_data_url no handler | Fetch image no handler | Pipe._fetch_image_as_data_url | MagicMock | Returns None | Low | [ ] | | |
| test_fetch_maker_profile_image_url_no_handler | Test fetch_maker_profile_image_url no handler | Fetch profile no handler | Pipe._fetch_maker_profile_image_url | MagicMock | Returns None | Low | [ ] | | |
| test_validate_base64_size_no_handler | Test validate_base64_size no handler | Validate base64 no handler | Pipe._validate_base64_size | None | Returns False | Low | [ ] | | |
| test_parse_data_url_no_handler | Test parse_data_url no handler | Parse data URL no handler | Pipe._parse_data_url | None | Returns None | Low | [ ] | | |
| test_run_streaming_loop_no_handler | Test run_streaming_loop no handler | Streaming loop no handler | Pipe._run_streaming_loop | pytest.raises | Raises RuntimeError | Low | [ ] | | |
| test_run_nonstreaming_loop_no_handler | Test run_nonstreaming_loop no handler | Nonstreaming loop no handler | Pipe._run_nonstreaming_loop | pytest.raises | Raises RuntimeError | Low | [ ] | | |
| test_cleanup_replayed_reasoning_no_handler | Test cleanup_replayed_reasoning no handler | Cleanup reasoning no handler | Pipe._cleanup_replayed_reasoning | MagicMock | Returns without error | Low | [ ] | | |
| test_select_llm_endpoint_no_handler | Test select_llm_endpoint no handler | Select endpoint no handler | Pipe._select_llm_endpoint | None | Returns responses | Low | [ ] | | |
| test_select_llm_endpoint_with_forced_no_handler | Test select_llm_endpoint_with_forced no handler | Select endpoint forced no handler | Pipe._select_llm_endpoint_with_forced | None | Returns (responses, False) | Low | [ ] | | |
| test_compression_enabled_no_store | Test compression_enabled no store | Compression no store | Pipe._compression_enabled | None | Returns False | Low | [ ] | | |
| test_compression_min_bytes_no_store | Test compression_min_bytes no store | Compression bytes no store | Pipe._compression_min_bytes | None | Returns 0 | Low | [ ] | | |
| test_breaker_window_seconds_getter | Test breaker_window_seconds getter | Breaker window getter | Pipe._breaker_window_seconds | None | Returns numeric | Low | [ ] | | |
| test_non_string_model_id | Test non-string model_id | Qualify non-string | Pipe._qualify_model_for_pipe | None | Returns None | Low | [ ] | | |
| test_empty_model_id | Test empty model_id | Qualify empty | Pipe._qualify_model_for_pipe | None | Returns None | Low | [ ] | | |
| test_valid_model_id | Test valid model_id | Qualify valid | Pipe._qualify_model_for_pipe | None | Returns qualified ID | Low | [ ] | | |
| test_empty_pipe_identifier | Test empty pipe_identifier | Qualify empty identifier | Pipe._qualify_model_for_pipe | None | Returns model_id only | Low | [ ] | | |
| test_already_prefixed_model_id | Test already prefixed model_id | Qualify already prefixed | Pipe._qualify_model_for_pipe | None | Returns unchanged | Low | [ ] | | |
| test_event_ts_none_created | Test event_ts None created | Event timestamp None | Session log assembler | None | Handles None created | Low | [ ] | | |
| test_event_ts_invalid_created | Test event_ts invalid created | Event timestamp invalid | Session log assembler | None | Handles invalid created | Low | [ ] | | |
| test_stop_log_worker_no_task | Test stop_log_worker no task | Log worker stop no task | Pipe._stop_log_worker | None | Handles no task | Low | [ ] | | |
| test_del_with_running_loop_task_error | Test __del__ with running loop task error | Destructor task error | Pipe.__del__ | patch, MagicMock | Handles task error | Low | [ ] | | |
| test_del_with_new_loop_error | Test __del__ with new_event_loop error | Destructor loop error | Pipe.__del__ | patch | Handles loop error | Low | [ ] | | |
| test_stale_lock_runtime_error | Test stale lock RuntimeError | Concurrency stale lock | Pipe._ensure_concurrency_controls | MagicMock | Replaces lock | Low | [ ] | | |
| test_stale_worker_different_loop | Test stale worker different loop | Concurrency stale worker | Pipe._ensure_concurrency_controls | caplog, asyncio.new_event_loop | Drops stale worker | Low | [ ] | | |
| test_stale_queue_different_loop | Test stale queue different loop | Concurrency stale queue | Pipe._ensure_concurrency_controls | caplog, asyncio.new_event_loop | Recreates queue | Low | [ ] | | |
| test_chats_none_graceful_handling | Test Chats None graceful handling | Import fallback Chats | pipe module | None | Handles None gracefully | Low | [ ] | | |
| test_models_none_graceful_handling | Test Models None graceful handling | Import fallback Models | pipe module | None | Handles None gracefully | Low | [ ] | | |
| test_files_none_graceful_handling | Test Files None graceful handling | Import fallback Files | pipe module | None | Handles None gracefully | Low | [ ] | | |
| test_users_none_graceful_handling | Test Users None graceful handling | Import fallback Users | pipe module | None | Handles None gracefully | Low | [ ] | | |
| test_aioredis_none_graceful_handling | Test aioredis None graceful handling | Import fallback aioredis | pipe module | None | Handles None gracefully | Low | [ ] | | |
| test_pyzipper_none_graceful_handling | Test pyzipper None graceful handling | Import fallback pyzipper | pipe module | None | Handles None gracefully | Low | [ ] | | |
| test_emit_status_no_handler | Test emit_status no handler | Status emit no handler | Pipe._emit_status | MagicMock | Returns without error | Low | [ ] | | |
| test_breaker_window_seconds_setter | Test breaker_window_seconds setter | Breaker window setter | Pipe._breaker_window_seconds | None | Sets value | Low | [ ] | | |
| test_log_worker_loop_none_queue | Test log_worker_loop None queue | Log worker None queue | Pipe._log_worker_loop | None | Returns early | Low | [ ] | | |
| test_ensure_error_formatter_creates_event_emitter_handler | Test ensure_error_formatter creates event_emitter_handler | Error formatter handler | Pipe._ensure_error_formatter | None | Creates both handlers | Low | [ ] | | |
| test_maybe_start_redis_creates_task | Test maybe_start_redis creates task | Redis task creation | Pipe._maybe_start_redis | None | Creates task | Low | [ ] | | |
| test_compression_enabled_setter | Test compression_enabled setter | Compression setter | Pipe._compression_enabled | None | Sets value | Low | [ ] | | |
| test_compression_min_bytes_setter | Test compression_min_bytes setter | Compression bytes setter | Pipe._compression_min_bytes | None | Sets value | Low | [ ] | | |
| test_encrypt_all_getter_no_store | Test encrypt_all getter no store | Encrypt all no store | Pipe._encrypt_all | None | Returns False | Low | [ ] | | |
| test_encrypt_all_setter_no_store | Test encrypt_all setter no store | Encrypt all setter no store | Pipe._encrypt_all | None | No crash | Low | [ ] | | |
| test_encrypt_all_setter_with_store | Test encrypt_all setter with store | Encrypt all setter | Pipe._encrypt_all | None | Sets value | Low | [ ] | | |
| test_redis_client_getter_no_store | Test redis_client getter no store | Redis client no store | Pipe._redis_client | None | Returns None | Low | [ ] | | |
| test_redis_client_setter_no_store | Test redis_client setter no store | Redis client setter no store | Pipe._redis_client | MagicMock | No crash | Low | [ ] | | |
| test_redis_enabled_getter_no_store | Test redis_enabled getter no store | Redis enabled no store | Pipe._redis_enabled | None | Returns False | Low | [ ] | | |
| test_redis_enabled_setter_no_store | Test redis_enabled setter no store | Redis enabled setter no store | Pipe._redis_enabled | None | No crash | Low | [ ] | | |
| test_sum_pricing_values_string_conversion | Test sum_pricing_values string conversion | Pricing string convert | Pipe._sum_pricing_values | None | Converts string | Low | [ ] | | |
| test_sum_pricing_values_empty_string | Test sum_pricing_values empty string | Pricing empty string | Pipe._sum_pricing_values | None | Returns (0, 0) | Low | [ ] | | |
| test_sum_pricing_values_invalid_string | Test sum_pricing_values invalid string | Pricing invalid | Pipe._sum_pricing_values | None | Returns (0, 0) | Low | [ ] | | |
| test_extract_task_output_text | Test extract_task_output_text | Task output extraction | Pipe._extract_task_output_text | None | Returns string | Low | [ ] | | |
| test_quote_identifier | Test quote_identifier | Quote identifier | Pipe._quote_identifier | None | Returns quoted string | Low | [ ] | | |
| test_init_artifact_store_delegation | Test init_artifact_store delegation | Artifact store init | Pipe._init_artifact_store | None | No crash | Low | [ ] | | |


## `tests/test_reasoning.py`

| Test Name | Description | What It Tests | Code Under Test | Mocks/Fixtures | Assertions | Drift Risk | Check Done | Codex Notes | Codex TODO |
|-----------|-------------|---------------|-----------------|----------------|------------|------------|------------|-------------|------------|
| test_get_storage_context_caches_result | Tests storage context caching mechanism | Verifies _get_storage_context caches result from pipe._resolve_storage_context | ReasoningTracker._get_storage_context (lines 109-113) | _StubPipe with mocked _resolve_storage_context_returns | Verifies cached result persists across calls | Low - Pure caching logic |  | Covers cache hit scenario | None |
| test_get_storage_context_returns_none_tuple_when_none | Tests storage context with None values | Verifies _get_storage_context handles (None, None) properly | ReasoningTracker._get_storage_context (lines 109-113) | _StubPipe returning (None, None) | Asserts result == (None, None) | Low - Edge case handling |  | Covers None cache scenario | None |
| test_persist_generated_image_returns_none_without_context | Tests image persistence without storage context | Verifies _persist_generated_image returns None when no context | ReasoningTracker._persist_generated_image (lines 118-129) | _StubPipe with (None, None) context | Asserts result is None | Low - Guard clause |  | Early return on missing context | None |
| test_persist_generated_image_extracts_extension_from_mime | Tests MIME type extension extraction | Verifies PNG/JPG MIME types map to correct extensions | ReasoningTracker._persist_generated_image (lines 118-129) | _StubPipe with valid context | Verifies file-123 returned for both PNG/JPG | Low - String parsing |  | MIME parsing for filenames | None |
| test_persist_generated_image_handles_invalid_mime | Tests invalid MIME type handling | Verifies graceful handling of MIME without slash | ReasoningTracker._persist_generated_image (lines 118-129) | _StubPipe with valid context | Returns file-123 even with invalid MIME | Low - Defensive coding |  | Fallback for malformed MIME | None |
| test_validate_base64_size_accepts_small | Tests base64 size validation for small strings | Verifies small strings pass size check | ReasoningTracker._validate_base64_size (lines 143-145) | None | Asserts True for small string | Low - Size threshold |  | Accepts under 10MB threshold | None |
| test_validate_base64_size_rejects_huge | Tests base64 size validation for huge strings | Verifies >10MB strings rejected | ReasoningTracker._validate_base64_size (lines 143-145) | None | Asserts False for 15MB string | Low - Size threshold |  | Rejects over 10MB threshold | None |
| test_materialize_image_from_str_empty_returns_none | Tests empty string materialization | Verifies empty/whitespace strings return None | ReasoningTracker._materialize_image_from_str (line 152) | None | Asserts None for "" and "   " | Low - Input validation |  | Guard clause for empty input | None |
| test_materialize_image_from_str_data_url_success | Tests data URL parsing and persistence | Verifies data URL successfully parsed and persisted | ReasoningTracker._materialize_image_from_str (lines 152-202) | _StubPipe, AsyncMock event_emitter, valid data URL | Returns /api/v1/files/file-123/content | Medium - Data URL parsing |  | Full happy path for data URLs | None |
| test_materialize_image_from_str_data_url_persist_fails | Tests data URL when persistence fails | Verifies original URL returned when upload fails | ReasoningTracker._materialize_image_from_str (line 168) | _StubPipe with _upload_to_owui_storage_returns=None | Returns original data URL | Medium - Error handling |  | Fallback to original on persist fail | None |
| test_materialize_image_from_str_invalid_data_url | Tests invalid data URL handling | Verifies invalid data URLs return None | ReasoningTracker._materialize_image_from_str (line 169) | _StubPipe with _parse_data_url returning None | Returns None | Low - Validation |  | Parse failure handling | None |
| test_materialize_image_from_str_http_url_passthrough | Tests HTTP/HTTPS URL passthrough | Verifies URLs are passed through unchanged | ReasoningTracker._materialize_image_from_str (lines 172-173) | None | Returns same URL for https://, http://, /api/v1/ | Low - Passthrough logic |  | URL formats preserved | None |
| test_materialize_image_from_str_extracts_base64_after_comma | Tests base64 extraction from prefixed string | Verifies base64 extracted from "prefix;base64,<data>" | ReasoningTracker._materialize_image_from_str (lines 177-178) | _StubPipe with valid context | Returns /api/v1/files/file-123/content | Medium - String parsing |  | Handles prefixed base64 format | None |
| test_materialize_image_from_str_cleaned_empty_returns_none | Tests cleaned string becoming empty | Verifies strings that clean to empty return None | ReasoningTracker._materialize_image_from_str (lines 180-181) | None | Returns None for "prefix;base64," | Low - Edge case |  | After-cleanup validation | None |
| test_materialize_image_from_str_huge_base64_rejected | Tests huge base64 rejection | Verifies >10MB base64 rejected | ReasoningTracker._materialize_image_from_str (lines 183-184) | None | Returns None for 15MB string | Low - Size validation |  | Size limit enforcement | None |
| test_materialize_image_from_str_invalid_base64 | Tests invalid base64 handling | Verifies invalid base64 returns None | ReasoningTracker._materialize_image_from_str (lines 188-189) | None | Returns None for "not-valid-base64!!!" | Low - Validation |  | Base64 decode error handling | None |
| test_materialize_image_from_str_raw_base64_persist_fails | Tests raw base64 when persist fails | Verifies data URL returned when persist fails | ReasoningTracker._materialize_image_from_str (line 202) | _StubPipe with _upload_to_owui_storage_returns=None | Returns data:image/png;base64,<b64> | Medium - Error recovery |  | Fallback data URL generation | None |
| test_materialize_image_from_str_raw_base64_emits_status | Tests raw base64 status emission | Verifies status emitted during persist | ReasoningTracker._materialize_image_from_str (lines 194-201) | _StubPipe, AsyncMock event_emitter | Asserts _emit_status called once | Low - Event emission |  | Status update during upload | None |
| test_materialize_image_entry_none_returns_none | Tests None entry handling | Verifies None entry returns None | ReasoningTracker._materialize_image_entry (lines 207-208) | None | Returns None | Low - Guard clause |  | Null safety | None |
| test_materialize_image_entry_string_delegates | Tests string entry delegation | Verifies string delegates to _materialize_image_from_str | ReasoningTracker._materialize_image_entry (lines 210-211) | None | Returns passed-through URL | Low - Delegation |  | String type handling | None |
| test_materialize_image_entry_dict_with_url | Tests dict with URL keys | Verifies extraction from "url" and "image_url" keys | ReasoningTracker._materialize_image_entry (lines 215-218) | None | Returns URLs from both key variants | Low - Key extraction |  | Multiple URL key formats | None |
| test_materialize_image_entry_dict_with_nested_candidate | Tests nested URL extraction | Verifies nested dict URL extraction | ReasoningTracker._materialize_image_entry (lines 219-222) | None | Returns nested URL | Low - Nested access |  | Nested structure support | None |
| test_materialize_image_entry_dict_with_base64 | Tests dict with base64 data | Verifies base64 from b64_json/mime_type keys | ReasoningTracker._materialize_image_entry (lines 225-251) | _StubPipe, AsyncMock event_emitter | Returns /api/v1/files/file-123/content | Medium - Dict parsing |  | Base64 dict format | None |
| test_materialize_image_entry_dict_huge_base64_skipped | Tests huge base64 in dict | Verifies >10MB base64 in dict skipped | ReasoningTracker._materialize_image_entry (lines 229-230) | None | Returns None | Low - Size validation |  | Dict-based size check | None |
| test_materialize_image_entry_dict_invalid_base64_skipped | Tests invalid base64 in dict | Verifies invalid base64 in dict skipped | ReasoningTracker._materialize_image_entry (lines 231-234) | None | Returns None | Low - Validation |  | Dict-based validation | None |
| test_materialize_image_entry_dict_base64_persist_fails | Tests dict base64 persist failure | Verifies fallback data URL when persist fails | ReasoningTracker._materialize_image_entry (line 252) | _StubPipe with _upload_to_owui_storage_returns=None | Returns data:image/jpeg;base64,<b64> | Medium - Error recovery |  | Dict-based fallback | None |
| test_materialize_image_entry_unsupported_returns_none | Tests unsupported entry types | Verifies empty dict and list return None | ReasoningTracker._materialize_image_entry (line 254) | None | Returns None for {} and [] | Low - Type validation |  | Unsupported type handling | None |
| test_materialize_images_from_item_non_dict_returns_empty | Tests non-dict event handling | Verifies non-dict events return empty list | ReasoningTracker.materialize_images_from_item (lines 263-264) | None | Returns [] for string | Low - Type check |  | Type guard | None |
| test_materialize_images_from_item_no_item_returns_empty | Tests missing item field | Verifies events without item return empty | ReasoningTracker.materialize_images_from_item (lines 266-268) | None | Returns [] for {} and {"item": "not dict"} | Low - Structure validation |  | Item field validation | None |
| test_materialize_images_from_item_no_id_returns_empty | Tests missing item ID | Verifies items without ID return empty | ReasoningTracker.materialize_images_from_item (lines 270-272) | None | Returns [] when no ID or empty ID | Low - ID validation |  | ID presence check | None |
| test_materialize_images_from_item_duplicate_skipped | Tests duplicate item ID handling | Verifies duplicate IDs skipped | ReasoningTracker.materialize_images_from_item (lines 273-274) | Tracker with pre-populated processed_image_item_ids | Returns [] for duplicate ID | Low - Deduplication |  | Duplicate prevention | None |
| test_materialize_images_from_item_non_image_skipped | Tests non-image item type | Verifies non-image types skipped | ReasoningTracker.materialize_images_from_item (lines 277-279) | None | Returns [] for type="text" | Low - Type filter |  | Image type filtering | None |
| test_materialize_images_from_item_list_output | Tests image item with list output | Verifies list output processing | ReasoningTracker.materialize_images_from_item (lines 287-291) | None | Returns list of URLs | Low - List processing |  | Multiple images | None |
| test_materialize_images_from_item_single_output | Tests image item with single output | Verifies single content output | ReasoningTracker.materialize_images_from_item (lines 292-295) | None | Returns [URL] | Low - Single item |  | Single image | None |
| test_extract_reasoning_text_non_dict_returns_empty | Tests non-dict event extraction | Verifies non-dict returns empty string | ReasoningTracker._extract_reasoning_text (lines 302-303) | None | Returns "" | Low - Type check |  | Type guard | None |
| test_extract_reasoning_text_delta_key | Tests delta key extraction | Verifies text from delta key | ReasoningTracker._extract_reasoning_text (lines 306-309) | None | Returns "thinking..." | Low - Key access |  | Delta field | None |
| test_extract_reasoning_text_text_key | Tests text key extraction | Verifies text from text key | ReasoningTracker._extract_reasoning_text (lines 306-309) | None | Returns "reasoning content" | Low - Key access |  | Text field | None |
| test_extract_reasoning_text_nested_part_text | Tests nested part.text extraction | Verifies nested part.text extraction | ReasoningTracker._extract_reasoning_text (lines 312-316) | None | Returns "nested thinking" | Low - Nested access |  | Nested structure | None |
| test_extract_reasoning_text_nested_part_content_list | Tests nested part.content list | Verifies content list text concatenation | ReasoningTracker._extract_reasoning_text (lines 318-330) | None | Returns "fragment1fragment2" | Medium - List processing |  | Content array handling | None |
| test_extract_reasoning_text_nested_part_content_string_entries | Tests content list with mixed types | Verifies string and dict entries in content | ReasoningTracker._extract_reasoning_text (lines 327-328) | None | Returns "string1dict-textstring2" | Medium - Mixed types |  | Mixed content types | None |
| test_extract_reasoning_text_no_matches | Tests no matching keys | Verifies empty string when no matches | ReasoningTracker._extract_reasoning_text (line 332) | None | Returns "" | Low - Fallback |  | No match scenario | None |
| test_reasoning_stream_key_from_item_id | Tests key from item_id | Verifies extraction from item_id field | ReasoningTracker._reasoning_stream_key (lines 337-339) | None | Returns "item-123" | Low - Field access |  | item_id extraction | None |
| test_reasoning_stream_key_from_output_item_added | Tests key from output_item.added | Verifies extraction from output_item.added event | ReasoningTracker._reasoning_stream_key (lines 341-346) | None | Returns "item-456" | Low - Event type handling |  | added event | None |
| test_reasoning_stream_key_from_output_item_done | Tests key from output_item.done | Verifies extraction from output_item.done event | ReasoningTracker._reasoning_stream_key (lines 341-346) | None | Returns "item-789" | Low - Event type handling |  | done event | None |
| test_reasoning_stream_key_uses_active_item | Tests fallback to active item | Verifies active_reasoning_item_id fallback | ReasoningTracker._reasoning_stream_key (lines 348-349) | Tracker with active_reasoning_item_id set | Returns "active-item" | Low - Fallback logic |  | Active item fallback | None |
| test_reasoning_stream_key_default | Tests default key | Verifies "__reasoning__" default | ReasoningTracker._reasoning_stream_key (line 351) | None | Returns "__reasoning__" | Low - Default value |  | Default key | None |
| test_append_reasoning_text_empty_incoming | Tests empty text appending | Verifies empty text returns empty | ReasoningTracker._append_reasoning_text (lines 363-365) | None | Returns "" | Low - Guard clause |  | Empty input handling | None |
| test_append_reasoning_text_first_chunk | Tests first chunk for key | Verifies first chunk initialization | ReasoningTracker._append_reasoning_text (lines 370-372) | None | Updates buffers and returns text | Low - Initialization |  | First chunk handling | None |
| test_append_reasoning_text_duplicate_snapshot | Tests duplicate snapshot | Verifies duplicate returns empty | ReasoningTracker._append_reasoning_text (lines 373-375) | Tracker with existing buffer | Returns "" | Low - Deduplication |  | Exact duplicate | None |
| test_append_reasoning_text_growing_snapshot | Tests growing snapshot | Verifies suffix extraction from growing text | ReasoningTracker._append_reasoning_text (lines 376-378) | Tracker with prefix buffer | Returns "-suffix" | Medium - Diff logic |  | Incremental growth | None |
| test_append_reasoning_text_shrinking_snapshot | Tests shrinking snapshot | Verifies shrinking text returns empty | ReasoningTracker._append_reasoning_text (lines 379-381) | Tracker with longer buffer | Returns "" | Low - Validation |  | Shrinking detection | None |
| test_append_reasoning_text_misaligned_allowed | Tests misaligned with allow flag | Verifies misaligned accepted when allowed | ReasoningTracker._append_reasoning_text (lines 383-384) | Tracker with buffer, allow_misaligned=True | Returns "totally-different" | Medium - Alignment control |  | Allow misalignment | None |
| test_append_reasoning_text_misaligned_disallowed | Tests misaligned without allow flag | Verifies misaligned rejected when not allowed | ReasoningTracker._append_reasoning_text (lines 383-384) | Tracker with buffer, allow_misaligned=False | Returns "" | Medium - Alignment control |  | Reject misalignment | None |
| test_maybe_emit_reasoning_status_disabled | Tests status emission when disabled | Verifies no emission when disabled | ReasoningTracker._maybe_emit_reasoning_status (lines 403-404) | AsyncMock event_emitter, disabled tracker | event_emitter not called | Low - Feature flag |  | Disabled state | None |
| test_maybe_emit_reasoning_status_no_emitter | Tests status emission without emitter | Verifies no error when no emitter | ReasoningTracker._maybe_emit_reasoning_status (lines 405-406) | event_emitter=None | No exception raised | Low - Null safety |  | Missing emitter | None |
| test_maybe_emit_reasoning_status_empty_buffer | Tests empty buffer status | Verifies no emission for empty buffer | ReasoningTracker._maybe_emit_reasoning_status (lines 408-411) | AsyncMock event_emitter | event_emitter not called | Low - Guard clause |  | Empty buffer | None |
| test_maybe_emit_reasoning_status_force | Tests forced status emission | Verifies force=True emits immediately | ReasoningTracker._maybe_emit_reasoning_status (line 413) | AsyncMock event_emitter, buffered text | Emits status event | Low - Force flag |  | Force emission | None |
| test_maybe_emit_reasoning_status_on_punctuation | Tests punctuation trigger | Verifies emission on punctuation | ReasoningTracker._maybe_emit_reasoning_status (lines 418-419) | AsyncMock event_emitter | Emits on "." | Low - Trigger logic |  | Punctuation trigger | None |
| test_maybe_emit_reasoning_status_on_length | Tests length threshold trigger | Verifies emission at 200 char threshold | ReasoningTracker._maybe_emit_reasoning_status (lines 421-422) | AsyncMock event_emitter, 200 char buffer | Emits on length | Low - Threshold |  | Length trigger | None |
| test_maybe_emit_reasoning_status_on_idle | Tests idle timeout trigger | Verifies emission after idle period | ReasoningTracker._maybe_emit_reasoning_status (lines 424-432) | AsyncMock event_emitter, 50 char buffer | Emits on idle | Medium - Time-based |  | Idle trigger | None |
| test_maybe_emit_reasoning_status_clears_buffer | Tests buffer clearing | Verifies buffer cleared and timestamp updated | ReasoningTracker._maybe_emit_reasoning_status (lines 443-444) | AsyncMock event_emitter | Buffer empty, timestamp set | Low - State update |  | Post-emit cleanup | None |
| test_maybe_emit_reasoning_status_no_emit_when_thresholds_not_met | Tests no emission scenario | Verifies no emission when thresholds not met | ReasoningTracker._maybe_emit_reasoning_status (line 435) | AsyncMock event_emitter, recent timestamp | event_emitter not called | Medium - Threshold logic |  | All thresholds failed | None |
| test_is_reasoning_event_reasoning_delta | Tests reasoning event detection | Verifies response.reasoning.* events detected | ReasoningTracker._is_reasoning_event (lines 450-452) | None | True for .delta/.done, False for summary | Low - String matching |  | Reasoning event types | None |
| test_is_reasoning_event_content_part | Tests content part detection | Verifies reasoning content part types | ReasoningTracker._is_reasoning_event (lines 455-461) | None | True for reasoning/summary types | Medium - Part type logic |  | Content part filtering | None |
| test_is_reasoning_event_non_reasoning | Tests non-reasoning detection | Verifies non-reasoning events return False | ReasoningTracker._is_reasoning_event (line 463) | None | False for output_text/completed | Low - Negative case |  | Non-reasoning events | None |
| test_process_reasoning_event_non_reasoning_returns_none | Tests non-reasoning event processing | Verifies non-reasoning events return None | ReasoningTracker.process_reasoning_event (lines 483-484) | Lambda normalizer | Returns None | Low - Guard clause |  | Early return | None |
| test_process_reasoning_event_activates_stream | Tests stream activation | Verifies reasoning_stream_active set | ReasoningTracker.process_reasoning_event (line 486) | Lambda normalizer | reasoning_stream_active=True | Low - State change |  | Stream activation | None |
| test_process_reasoning_event_invalid_key_returns_none | Tests invalid key handling | Verifies empty key returns None | ReasoningTracker.process_reasoning_event (line 490) | monkeypatch to return "" | Returns None, stream still active | Medium - Mocked dependency |  | Empty key case | None |
| test_process_reasoning_event_with_default_key | Tests default key usage | Verifies __reasoning__ default works | ReasoningTracker.process_reasoning_event | Lambda normalizer | reasoning_stream_active=True | Low - Default path |  | Default key path | None |
| test_process_reasoning_event_marks_incremental | Tests incremental marking | Verifies key marked as incremental | ReasoningTracker.process_reasoning_event (lines 497-498) | Lambda normalizer | Key in reasoning_stream_has_incremental | Low - Set operation |  | Incremental tracking | None |
| test_process_reasoning_event_emits_delta | Tests delta emission | Verifies reasoning:delta event emitted | ReasoningTracker.process_reasoning_event (lines 508-519) | AsyncMock event_emitter | reasoning:delta event with delta | Medium - Event emission |  | Delta event | None |
| test_process_reasoning_event_emits_completed | Tests completed emission | Verifies reasoning:completed event emitted | ReasoningTracker.process_reasoning_event (lines 523-539) | AsyncMock event_emitter | reasoning:completed event, flags set | Medium - Event emission |  | Completed event | None |
| test_process_reasoning_event_skips_duplicate_completed | Tests duplicate completed skip | Verifies duplicate completed skipped | ReasoningTracker.process_reasoning_event (lines 530, 538) | AsyncMock event_emitter, completed set | No completed event | Low - Deduplication |  | Duplicate prevention | None |
| test_process_reasoning_event_returns_append | Tests return value | Verifies appended text returned | ReasoningTracker.process_reasoning_event (line 541) | Lambda normalizer | Returns "new text" | Low - Return value |  | Append result | None |
| test_process_citation_event_wrong_type | Tests wrong citation type | Verifies non-url_citation returns None | ReasoningTracker.process_citation_event (lines 553-555) | None | Returns None | Low - Type check |  | Type filtering | None |
| test_process_citation_event_strips_utm | Tests UTM parameter stripping | Verifies utm_source removed from URL | ReasoningTracker.process_citation_event (lines 558-560) | _StubPipe, AsyncMock event_emitter | URL without utm_source | Medium - URL parsing |  | UTM cleanup | None |
| test_process_citation_event_deduplicates | Tests citation deduplication | Verifies duplicate URLs skipped | ReasoningTracker.process_citation_event (lines 564-565) | AsyncMock event_emitter, populated ordinal_by_url | Returns None | Low - Deduplication |  | Duplicate detection | None |
| test_process_citation_event_extracts_host | Tests host extraction | Verifies host extracted from URL | ReasoningTracker.process_citation_event (lines 567-580) | _StubPipe, AsyncMock event_emitter | source.name = "example.com" | Medium - URL parsing |  | Host extraction | None |
| test_process_citation_event_emits_and_stores | Tests citation emit and store | Verifies citation emitted and stored | ReasoningTracker.process_citation_event (lines 582-586) | _StubPipe, AsyncMock event_emitter | _emit_citation called, citation stored | Low - State update |  | Emit and store | None |
| test_process_citation_event_no_emitter | Tests citation without emitter | Verifies citation stored without emitter | ReasoningTracker.process_citation_event (lines 582-583) | event_emitter=None | Citation stored, no emit | Low - Null safety |  | Missing emitter | None |
| test_track_reasoning_item_sets_active_id | Tests active ID setting | Verifies active_reasoning_item_id set | ReasoningTracker.track_reasoning_item (lines 591-598) | None | active_reasoning_item_id = "reasoning-item-1" | Low - State update |  | ID tracking | None |
| test_track_reasoning_item_ignores_non_reasoning | Tests non-reasoning type ignore | Verifies non-reasoning types ignored | ReasoningTracker.track_reasoning_item (lines 595-598) | None | active_reasoning_item_id = None | Low - Type filter |  | Type filtering | None |
| test_track_reasoning_item_handles_missing_id | Tests missing ID handling | Verifies missing ID handled | ReasoningTracker.track_reasoning_item (lines 596-598) | None | active_reasoning_item_id = None | Low - Validation |  | Missing ID | None |
| test_track_reasoning_item_handles_non_dict_item | Tests non-dict item handling | Verifies non-dict item handled | ReasoningTracker.track_reasoning_item (lines 591-592) | None | active_reasoning_item_id = None | Low - Type check |  | Type guard | None |
| test_get_final_reasoning_buffer | Tests final buffer retrieval | Verifies accumulated buffer returned | ReasoningTracker.get_final_reasoning_buffer (line 603) | Tracker with buffer set | Returns accumulated text | Low - Getter |  | Buffer accessor | None |
| test_get_citations | Tests citations retrieval | Verifies all citations returned | ReasoningTracker.get_citations (line 608) | Tracker with citations | Returns list of 2 citations | Low - Getter |  | Citations accessor | None |
| test_should_persist_reasoning_never | Tests never persist | Verifies "never" returns False | ReasoningTracker.should_persist_reasoning (lines 613-614) | persist_reasoning="never" | Returns False | Low - Config check |  | Never mode | None |
| test_should_persist_reasoning_next_reply | Tests next_reply persist | Verifies "next_reply" returns True | ReasoningTracker.should_persist_reasoning (lines 613-614) | persist_reasoning="next_reply" | Returns True | Low - Config check |  | Next reply mode | None |
| test_should_persist_reasoning_conversation | Tests conversation persist | Verifies "conversation" returns True | ReasoningTracker.should_persist_reasoning (lines 613-614) | persist_reasoning="conversation" | Returns True | Low - Config check |  | Conversation mode | None |
| test_is_reasoning_active | Tests reasoning active state | Verifies reasoning_stream_active returned | ReasoningTracker.is_reasoning_active (line 619) | None | Returns False/True | Low - Getter |  | State accessor | None |
| test_integration_with_real_pipe | Integration test with real Pipe | Tests full workflow with real Pipe instance | ReasoningTracker with Pipe | pipe_instance_async fixture, AsyncMock event_emitter | Delta processed, buffer updated, completed emitted | High - Integration |  | Full integration | None |
| test_both_thinking_modes | Tests "both" thinking mode | Verifies both delta and status emitted | ReasoningTracker with thinking_mode="both" | AsyncMock event_emitter | Both reasoning:delta and status events | Medium - Mode logic |  | Both mode | None |
| test_status_only_mode | Tests "status" thinking mode | Verifies only status emitted | ReasoningTracker with thinking_mode="status" | AsyncMock event_emitter | status event, no reasoning:delta | Medium - Mode logic |  | Status-only mode | None |
| test_disabled_reasoning_returns_early | Tests disabled reasoning | When ENABLE_REASONING=False, no changes | Pipe._apply_reasoning_preferences | pipe_instance, valves with ENABLE_REASONING=False | body.reasoning unchanged | Low - Feature flag |  | Disabled path | None |
| test_model_supports_reasoning_sets_config | Tests reasoning config setting | Model with reasoning param gets config dict | Pipe._apply_reasoning_preferences | pipe_instance, ModelFamily specs | body.reasoning = {"effort": "medium", "enabled": True} | Medium - Config logic |  | Reasoning param support | None |
| test_model_supports_reasoning_with_summary | Tests summary mode setting | Summary mode added to config when not disabled | Pipe._apply_reasoning_preferences | pipe_instance, ModelFamily specs | body.reasoning includes "summary": "auto" | Low - Config field |  | Summary mode | None |
| test_model_supports_reasoning_preserves_existing_effort | Tests existing effort preservation | Existing effort not overwritten | Pipe._apply_reasoning_preferences | pipe_instance, body with effort="xhigh" | body.reasoning["effort"] = "xhigh" preserved | Medium - Preservation logic |  | Effort preservation | None |
| test_model_supports_reasoning_preserves_existing_summary | Tests existing summary preservation | Existing summary not overwritten | Pipe._apply_reasoning_preferences | pipe_instance, body with summary="auto" | body.reasoning["summary"] = "auto" preserved | Medium - Preservation logic |  | Summary preservation | None |
| test_model_supports_reasoning_clears_include_reasoning | Tests include_reasoning clearing | include_reasoning cleared for reasoning models | Pipe._apply_reasoning_preferences | pipe_instance, body with include_reasoning=True | body.include_reasoning = None | Low - Field clearing |  | Clear legacy flag | None |
| test_model_supports_legacy_only_sets_include_flag | Tests legacy include_reasoning | Only include_reasoning set for legacy models | Pipe._apply_reasoning_preferences | pipe_instance, ModelFamily with include_reasoning | body.include_reasoning = True | Medium - Legacy support |  | Legacy param | None |
| test_model_supports_legacy_only_effort_none_disables | Tests effort=none disables | effort="none" sets include_reasoning=False | Pipe._apply_reasoning_preferences | pipe_instance, effort="none" | body.include_reasoning = False | Low - Disable logic |  | None effort | None |
| test_model_supports_legacy_only_effort_none_string_disables | Tests effort="none" string disables | String "none" sets include_reasoning=False | Pipe._apply_reasoning_preferences | pipe_instance, effort="none" | body.include_reasoning = False | Low - String handling |  | None string | None |
| test_model_supports_neither_disables_all | Tests no support disables all | Models without support get all disabled | Pipe._apply_reasoning_preferences | pipe_instance, ModelFamily with empty params | body.reasoning=None, include_reasoning=False | Low - Unsupported path |  | Unsupported models | None |
| test_model_supports_both_prefers_reasoning | Tests both param preference | reasoning dict preferred over include_reasoning | Pipe._apply_reasoning_preferences | pipe_instance, ModelFamily with both params | body.reasoning is dict, include_reasoning=None | Medium - Priority logic |  | Preference order | None |
| test_reasoning_body_is_non_dict_gets_replaced | Tests non-dict replacement | Non-dict reasoning replaced with config | Pipe._apply_reasoning_preferences | pipe_instance, body.reasoning="invalid" | body.reasoning = {"effort": "low", "enabled": True} | Medium - Type coercion |  | Invalid type handling | None |
| test_empty_effort_returns_early | Tests empty effort early return | Empty effort returns without changes | Pipe._apply_task_reasoning_preferences | pipe_instance, effort="" | body.reasoning = None | Low - Guard clause |  | Empty effort | None |
| test_whitespace_effort_processes_as_empty_string | Tests whitespace effort | Whitespace effort processes to empty string | Pipe._apply_task_reasoning_preferences | pipe_instance, effort="   " | body.reasoning = {"effort": "", "enabled": True} | Medium - Edge case |  | Whitespace handling | Document behavior |
| test_model_supports_reasoning_sets_effort | Tests task effort setting | Task effort set in reasoning config | Pipe._apply_task_reasoning_preferences | pipe_instance, effort="HIGH" | body.reasoning = {"effort": "high", "enabled": True} | Low - Config setting |  | Task effort | None |
| test_model_supports_reasoning_normalizes_effort | Tests effort normalization | Effort normalized to lowercase and trimmed | Pipe._apply_task_reasoning_preferences | pipe_instance, effort="  Medium  " | body.reasoning["effort"] = "medium" | Low - String processing |  | Normalization | None |
| test_model_supports_reasoning_overwrites_existing_effort | Tests effort overwrite | Task effort overwrites existing effort | Pipe._apply_task_reasoning_preferences | pipe_instance, body with effort="low" | body.reasoning["effort"] = "high" | Medium - Override logic |  | Task override | None |
| test_model_supports_reasoning_handles_non_dict_reasoning | Tests non-dict handling | Non-dict reasoning replaced | Pipe._apply_task_reasoning_preferences | pipe_instance, body.reasoning="invalid" | body.reasoning = {"effort": "high", "enabled": True} | Medium - Type handling |  | Type coercion | None |
| test_model_supports_reasoning_clears_include_reasoning | Tests include_reasoning clearing | include_reasoning cleared for reasoning | Pipe._apply_task_reasoning_preferences | pipe_instance, body with include_reasoning=True | body.include_reasoning = None | Low - Field clearing |  | Clear flag | None |
| test_model_supports_legacy_only_sets_include_flag | Tests legacy flag setting | include_reasoning set for legacy models | Pipe._apply_task_reasoning_preferences | pipe_instance, ModelFamily with include_reasoning | body.include_reasoning = True | Medium - Legacy support |  | Legacy support | None |
| test_model_supports_legacy_only_effort_none_disables | Tests none effort disables | effort="none" sets include_reasoning=False | Pipe._apply_task_reasoning_preferences | pipe_instance, effort="none" | body.include_reasoning = False | Low - Disable logic |  | None disables | None |
| test_model_supports_legacy_only_effort_minimal_disables | Tests minimal effort disables | effort="minimal" sets include_reasoning=False | Pipe._apply_task_reasoning_preferences | pipe_instance, effort="minimal" | body.include_reasoning = False | Low - Disable logic |  | Minimal disables | None |
| test_model_supports_legacy_only_effort_low_enables | Tests low effort enables | effort="low" sets include_reasoning=True | Pipe._apply_task_reasoning_preferences | pipe_instance, effort="low" | body.include_reasoning = True | Low - Enable logic |  | Low enables | None |
| test_model_supports_neither_disables_all | Tests neither support disables | No support disables all flags | Pipe._apply_task_reasoning_preferences | pipe_instance, ModelFamily with empty params | body.reasoning=None, include_reasoning=False | Low - Unsupported path |  | Unsupported models | None |
| test_non_gemini_model_clears_config | Tests non-Gemini clearing | Non-Gemini models get thinking_config cleared | Pipe._apply_gemini_thinking_config | pipe_instance, non-Gemini model | body.thinking_config = None | Low - Model filter |  | Non-Gemini path | None |
| test_gemini_3_model_sets_thinking_level | Tests Gemini 3 level setting | Gemini 3 sets thinking_level from effort | Pipe._apply_gemini_thinking_config | pipe_instance, google/gemini-3-pro | thinking_config = {"include_thoughts": True, "thinking_level": "HIGH"} | High - Gemini-specific |  | Gemini 3 config | None |
| test_gemini_3_model_low_effort_maps_to_low_level | Tests low effort mapping | effort="low" maps to thinking_level="LOW" | Pipe._apply_gemini_thinking_config | pipe_instance, effort="low" | thinking_config["thinking_level"] = "LOW" | Medium - Effort mapping |  | Low mapping | None |
| test_gemini_3_model_minimal_effort_maps_to_low_level | Tests minimal effort mapping | effort="minimal" maps to thinking_level="LOW" | Pipe._apply_gemini_thinking_config | pipe_instance, effort="minimal" | thinking_config["thinking_level"] = "LOW" | Medium - Effort mapping |  | Minimal mapping | None |
| test_gemini_3_model_override_level_low | Tests level override to LOW | GEMINI_THINKING_LEVEL="low" overrides | Pipe._apply_gemini_thinking_config | pipe_instance, GEMINI_THINKING_LEVEL="low" | thinking_config["thinking_level"] = "LOW" | Low - Override |  | Low override | None |
| test_gemini_3_model_override_level_high | Tests level override to HIGH | GEMINI_THINKING_LEVEL="high" overrides | Pipe._apply_gemini_thinking_config | pipe_instance, GEMINI_THINKING_LEVEL="high" | thinking_config["thinking_level"] = "HIGH" | Low - Override |  | High override | None |
| test_gemini_3_model_effort_none_disables_thinking | Tests effort=none disables | effort="none" disables thinking_config | Pipe._apply_gemini_thinking_config | pipe_instance, effort="none" | thinking_config=None, include_reasoning=False | Low - Disable logic |  | None disables | None |
| test_gemini_25_model_sets_thinking_budget | Tests Gemini 2.5 budget setting | Gemini 2.5 sets thinking_budget from effort | Pipe._apply_gemini_thinking_config | pipe_instance, google/gemini-2.5-flash | thinking_config = {"include_thoughts": True, "thinking_budget": 1024} | High - Gemini-specific |  | Gemini 2.5 config | None |
| test_gemini_25_model_high_effort_doubles_budget | Tests high effort budget doubling | effort="high" doubles budget | Pipe._apply_gemini_thinking_config | pipe_instance, effort="high", budget=1000 | thinking_config["thinking_budget"] = 2000 | Medium - Budget calc |  | High doubles | None |
| test_gemini_25_model_low_effort_halves_budget | Tests low effort budget halving | effort="low" halves budget | Pipe._apply_gemini_thinking_config | pipe_instance, effort="low", budget=1000 | thinking_config["thinking_budget"] = 500 | Medium - Budget calc |  | Low halves | None |
| test_gemini_25_model_minimal_effort_quarters_budget | Tests minimal effort budget quartering | effort="minimal" quarters budget | Pipe._apply_gemini_thinking_config | pipe_instance, effort="minimal", budget=1000 | thinking_config["thinking_budget"] = 250 | Medium - Budget calc |  | Minimal quarters | None |
| test_gemini_25_model_xhigh_effort_quadruples_budget | Tests xhigh effort budget quadrupling | effort="xhigh" quadruples budget | Pipe._apply_gemini_thinking_config | pipe_instance, effort="xhigh", budget=1000 | thinking_config["thinking_budget"] = 4000 | Medium - Budget calc |  | Xhigh quadruples | None |
| test_gemini_25_model_zero_budget_returns_zero | Tests zero budget handling | Zero budget returns 0 | Pipe._apply_gemini_thinking_config | pipe_instance, budget=0 | thinking_config["thinking_budget"] = 0 | Low - Edge case |  | Zero budget | None |
| test_gemini_25_model_negative_budget_helper_returns_none | Tests negative budget helper | Helper returns None for negative budget | _map_effort_to_gemini_budget | budget=-1 | Returns None | Low - Validation |  | Negative budget | None |
| test_gemini_25_model_effort_none_disables_thinking | Tests effort=none disables | effort="none" disables thinking_config | Pipe._apply_gemini_thinking_config | pipe_instance, effort="none" | thinking_config=None, include_reasoning=False | Low - Disable logic |  | None disables | None |
| test_reasoning_not_requested_no_thinking_config | Tests no reasoning request | No reasoning request = no thinking_config | Pipe._apply_gemini_thinking_config | pipe_instance, no reasoning/include_reasoning | thinking_config=None, include_reasoning=False | Low - Guard clause |  | Not requested | None |
| test_reasoning_enabled_false_no_thinking_config | Tests reasoning.enabled=False | enabled=False = no thinking_config | Pipe._apply_gemini_thinking_config | pipe_instance, reasoning.enabled=False | thinking_config=None | Low - Disabled check |  | Disabled | None |
| test_reasoning_exclude_true_no_thinking_config | Tests reasoning.exclude=True | exclude=True = no thinking_config | Pipe._apply_gemini_thinking_config | pipe_instance, reasoning.exclude=True | thinking_config=None | Low - Exclude check |  | Excluded | None |
| test_include_reasoning_flag_triggers_thinking_config | Tests include_reasoning triggers | include_reasoning=True triggers thinking_config | Pipe._apply_gemini_thinking_config | pipe_instance, include_reasoning=True | thinking_config is not None | Medium - Flag trigger |  | Flag triggers | None |
| test_gemini_3_effort_from_valve_when_not_in_reasoning | Tests valve effort fallback | Effort from valve when not in reasoning dict | Pipe._apply_gemini_thinking_config | pipe_instance, valve effort="minimal" | thinking_config["thinking_level"] = "LOW" | Medium - Fallback logic |  | Valve fallback | None |
| test_gemini_3_effort_from_reasoning_dict_takes_precedence | Tests reasoning dict precedence | reasoning.effort overrides valve | Pipe._apply_gemini_thinking_config | pipe_instance, reasoning.effort="high" | thinking_config["thinking_level"] = "HIGH" | Medium - Precedence |  | Dict precedence | None |
| test_gemini_3_level_none_from_include_flag_with_none_effort | Tests level=None path | include_reasoning=True + effort="none" = None level | Pipe._apply_gemini_thinking_config (lines 168-170) | pipe_instance, include_reasoning=True, effort="none" | thinking_config=None, include_reasoning=False | High - Complex path |  | None level path | None |
| test_gemini_25_budget_none_from_include_flag_with_none_effort | Tests budget=None path | include_reasoning=True + effort="none" = None budget | Pipe._apply_gemini_thinking_config (lines 175-177) | pipe_instance, include_reasoning=True, effort="none" | thinking_config=None, include_reasoning=False | High - Complex path |  | None budget path | None |
| test_no_reasoning_flags_returns_false | Tests no flags returns False | No reasoning flags = no retry | Pipe._should_retry_without_reasoning | pipe_instance, no flags | Returns False | Low - Guard clause |  | No flags | None |
| test_include_reasoning_true_triggers_retry | Tests include_reasoning retry | include_reasoning=True + matching error = retry | Pipe._should_retry_without_reasoning | pipe_instance, include_reasoning=True, matching error | Returns True, flags cleared | Medium - Retry logic |  | Retry triggered | None |
| test_reasoning_dict_triggers_retry | Tests reasoning dict retry | reasoning dict + matching error = retry | Pipe._should_retry_without_reasoning | pipe_instance, reasoning dict, matching error | Returns True, reasoning cleared | Medium - Retry logic |  | Dict retry | None |
| test_thinking_config_triggers_retry | Tests thinking_config retry | thinking_config + matching error = retry | Pipe._should_retry_without_reasoning | pipe_instance, thinking_config, matching error | Returns True, thinking_config cleared | Medium - Retry logic |  | Config retry | None |
| test_unrelated_error_message_returns_false | Tests unrelated error | Unrelated error message = no retry | Pipe._should_retry_without_reasoning | pipe_instance, unrelated error | Returns False, flags unchanged | Low - Message matching |  | Unrelated error | None |
| test_trigger_phrase_in_str_error | Tests trigger in str(error) | Trigger phrase in str() = retry | Pipe._should_retry_without_reasoning | pipe_instance, error with trigger in reason | Returns True | Medium - String conversion |  | str() trigger | None |
| test_case_insensitive_match | Tests case insensitive matching | Case-insensitive trigger matching | Pipe._should_retry_without_reasoning | pipe_instance, uppercase trigger | Returns True | Low - Case handling |  | Case insensitive | None |
| test_non_string_message_candidates_skipped | Tests non-string message skip | Non-string messages skipped without error | Pipe._should_retry_without_reasoning | pipe_instance, dict upstream_message | Returns False | Medium - Type safety |  | Non-string skip | None |
| test_logs_info_when_retrying | Tests retry logging | Info logged when retrying | Pipe._should_retry_without_reasoning | pipe_instance, caplog | Log message contains model name | Low - Logging |  | Retry logging | None |
| test_lazy_initialization | Tests lazy manager init | ReasoningConfigManager lazily initialized | Pipe._ensure_reasoning_config_manager | pipe_instance | Manager created on first call | Low - Lazy loading |  | Lazy init | None |
| test_shared_instance | Tests shared manager instance | Same instance returned on subsequent calls | Pipe._ensure_reasoning_config_manager | pipe_instance | manager1 is manager2 | Low - Singleton pattern |  | Shared instance | None |
| test_manager_has_pipe_reference | Tests manager pipe reference | Manager has reference to parent pipe | Pipe._ensure_reasoning_config_manager | pipe_instance | manager._pipe is pipe_instance | Low - Reference |  | Pipe reference | None |
| test_manager_has_logger | Tests manager logger | Manager has logger instance | Pipe._ensure_reasoning_config_manager | pipe_instance | manager.logger is not None | Low - Logger |  | Logger present | None |
| test_manager_has_valves | Tests manager valves | Manager has valves reference | Pipe._ensure_reasoning_config_manager | pipe_instance | manager.valves is pipe.valves | Low - Reference |  | Valves reference | None |
| test_reasoning_with_none_model | Tests None/empty model | Handles empty model gracefully | Pipe._apply_reasoning_preferences | pipe_instance, model="" | body.reasoning = None | Low - Edge case |  | Empty model | None |
| test_gemini_exact_model_name_match | Tests exact Gemini name | Handles exact "google/gemini-3" name | Pipe._apply_gemini_thinking_config | pipe_instance, model="google/gemini-3" | thinking_config with thinking_level | Medium - Name matching |  | Exact name | None |
| test_gemini_25_exact_model_name_match | Tests exact Gemini 2.5 name | Handles exact "google/gemini-2.5" name | Pipe._apply_gemini_thinking_config | pipe_instance, model="google/gemini-2.5" | thinking_config with thinking_budget | Medium - Name matching |  | Exact 2.5 name | None |
| test_gemini_budget_rounds_to_int | Tests budget rounding | Budget calculation rounds to int | Pipe._apply_gemini_thinking_config | pipe_instance, budget=999, effort="minimal" | thinking_config["thinking_budget"] = 250 | Low - Rounding |  | Int rounding | None |
| test_gemini_budget_minimum_is_one | Tests budget minimum | Budget minimum is 1 (not 0 from rounding) | Pipe._apply_gemini_thinking_config | pipe_instance, budget=3, effort="minimal" | thinking_config["thinking_budget"] = 1 | Low - Minimum value |  | Minimum 1 | None |
| test_all_retry_flags_cleared_on_match | Tests all flags cleared | All reasoning flags cleared on retry | Pipe._should_retry_without_reasoning | pipe_instance, all flags set, matching error | All flags cleared | Low - State cleanup |  | Complete cleanup | None |
| test_materialize_data_url_persists_and_emits_status | Tests data URL persist and emit | Data URL persisted and status emitted | ReasoningTracker._materialize_image_from_str | _StubPipeImageTests, AsyncMock _persist_generated_image | Returns /api/v1/files/file-1/content, _emit_status called | Medium - Integration |  | Persist and emit | None |
| test_materialize_image_entry_from_base64_dict | Tests base64 dict materialization | Base64 dict entry materialized | ReasoningTracker._materialize_image_entry | _StubPipeImageTests, AsyncMock _persist_generated_image | Returns /api/v1/files/file-2/content, _emit_status called | Medium - Dict processing |  | Base64 dict | None |
| test_materialize_image_entry_returns_existing_url | Tests existing URL return | Existing URL returned without persist | ReasoningTracker._materialize_image_entry | _StubPipeImageTests, AsyncMock _persist_generated_image | Returns URL, _persist_generated_image not called | Low - Passthrough |  | URL passthrough | None |


## `tests/test_registry_plumbing.py`

| Test Name | Description | What It Tests | Code Under Test | Mocks/Fixtures | Assertions | Drift Risk | Check Done | Codex Notes | Codex TODO |
|-----------|-------------|---------------|-----------------|----------------|------------|------------|------------|-------------|------------|
| `test_registry_refresh_populates_models_and_specs` | Verifies registry refresh loads models and specs from API | Tests that `ensure_loaded` successfully fetches models from API, normalizes IDs, and builds spec dictionary with features | `OpenRouterModelRegistry.ensure_loaded()`, `OpenRouterModelRegistry.list_models()`, `OpenRouterModelRegistry.api_model_id()`, `OpenRouterModelRegistry._specs` | `DummySession` and `DummyResponse` mock HTTP calls; `reset_registry` autouse fixture clears all registry state | (1) `models[0]["id"] == "author.model"` - normalized ID format, (2) `api_model_id("author.model") == "author/model"` - reverse mapping works, (3) `"author.model" in specs` - spec exists, (4) `"function_calling" in specs["author.model"]["features"]` - features derived from supported_parameters | MEDIUM - OpenRouter API schema changes (supported_parameters, architecture, pricing fields) could break parsing | YES | Integration test using custom mocks instead of aioresponses. Tests full ETL pipeline: fetch -> normalize -> derive features. Validates bidirectional ID mapping (author.model <-> author/model). Feature derivation includes tools, reasoning, modalities, web_search. | Verify alignment with actual OpenRouter /models schema in `.external/openrouter_docs` and `.external/models-openrouter-2025-11-30-pretty.json`. Consider migration to aioresponses for consistency. |
| `test_registry_cache_prevents_refresh` | Validates cache prevents unnecessary HTTP refresh when cache is fresh | Tests that `ensure_loaded` uses cached models and skips HTTP when `_next_refresh_after` is in the future | `OpenRouterModelRegistry.ensure_loaded()`, cache expiry logic (`_next_refresh_after`, `_last_fetch`) | `aioresponses` mocks HTTP endpoint; `reset_registry` fixture; pre-populated `_specs` and `_models` with future `_next_refresh_after` timestamp | (1) `reg._models == [{"id": "demo", "norm_id": "demo", "name": "Demo"}]` - models unchanged, (2) `len(mock_http.requests) == 0` - no HTTP call made | LOW - Cache logic is internal timing code, stable unless refactored | YES | Uses real aiohttp.ClientSession and aioresponses. Tests real cache expiry logic and timestamp checking. Cache set to expire 999s in future. Mock configured but should not be called. Validates cache-hit optimization path. | None - test pattern is current best practice |
| `test_registry_refresh_failure_uses_cache` | Tests registry falls back to cached models when HTTP refresh fails | Tests that `ensure_loaded` uses cached models and does not raise exception when network error occurs during refresh | `OpenRouterModelRegistry.ensure_loaded()`, `_refresh()` error handling, cache fallback logic | `aioresponses` mocks HTTP to raise RuntimeError; `reset_registry` fixture; pre-populated `_specs` and `_models`; `_last_fetch=0` forces refresh attempt | (1) `reg._models == [{"id": "demo", "norm_id": "demo", "name": "Demo"}]` - cached models preserved, (2) `len(mock_http.requests) == 1` - HTTP was attempted | LOW - Error handling stable | YES | Tests graceful degradation when API unavailable. Forces cache expiry (`_last_fetch=0`) to trigger refresh, then simulates network failure. Validates fail-soft behavior: stale cache is better than no data. Real HTTP stack exercised with injected failure. | None - resilience pattern validated |
| `test_registry_raises_when_key_missing` | Verifies registry validation raises error when API key is empty | Tests that `ensure_loaded` raises ValueError when `api_key` parameter is empty string | `OpenRouterModelRegistry.ensure_loaded()` validation logic | `DummySession` and `DummyResponse` with empty data; `reset_registry` fixture | `pytest.raises(ValueError)` - empty API key triggers validation error | LOW - Input validation stable | YES | Simple guard test for required parameter. Uses minimal mocks since validation happens before HTTP. Empty string `api_key=""` should fail fast. Validates defensive programming. | None - basic validation pattern |
| `test_registry_refresh_error_no_cache` | Tests that registry raises error when refresh fails and no cache available | Tests that `ensure_loaded` propagates exception when HTTP fails and `_models` is empty (cold start failure) | `OpenRouterModelRegistry.ensure_loaded()`, `_refresh()` error propagation | `aioresponses` mocks HTTP to raise RuntimeError; `reset_registry` fixture; explicitly empty `_models` and `_specs` | `pytest.raises(RuntimeError, match="boom")` - exception propagated when no fallback available | LOW - Error propagation stable | YES | Tests cold start failure scenario: no cached data available and API call fails. Validates fail-hard behavior when cache unavailable. Real HTTP stack with injected failure. Ensures errors surface to caller during initial bootstrap. | None - error propagation validated |
| `test_registry_record_refresh_bookkeeping` | Validates internal bookkeeping after successful and failed refresh operations | Tests `_record_refresh_success()` and `_record_refresh_failure()` update internal counters and timestamps correctly | `OpenRouterModelRegistry._record_refresh_success()`, `OpenRouterModelRegistry._record_refresh_failure()` | `reset_registry` fixture; direct method calls without HTTP | (1) `_consecutive_failures == 0` after success, (2) `_next_refresh_after >= _last_fetch` - future expiry set, (3) `_consecutive_failures == 1` after one failure, (4) `_last_error == "boom"` - error message stored | LOW - Internal bookkeeping stable | YES | Unit test of internal state management. Tests success resets failure counter and sets future expiry. Tests failure increments counter and records error message. No HTTP interaction. Pure state verification. | None - internal bookkeeping validated |
| `test_registry_feature_and_capability_derivation` | Validates feature and capability derivation from model metadata | Tests `_derive_features()`, `_supports_web_search()`, and `_derive_capabilities()` correctly interpret model metadata | `OpenRouterModelRegistry._derive_features()`, `OpenRouterModelRegistry._supports_web_search()`, `OpenRouterModelRegistry._derive_capabilities()` | `reset_registry` fixture; direct method calls with sample metadata | (1) `{"function_calling", "reasoning_summary", "web_search_tool", "vision", "image_gen_tool"}.issubset(features)` - all expected features derived, (2) `_supports_web_search({"web_search": "0.01"}) is True` - pricing detection works, (3) `capabilities["vision"] is True` - vision from input image modality, (4) `capabilities["file_upload"] is True` - file upload from FILE modality | HIGH - OpenRouter metadata schema changes (supported_parameters format, architecture field names, pricing structure) could break feature detection | YES | Pure logic tests for metadata interpretation. Tests feature flags derived from: supported_parameters (tools, reasoning), architecture.input_modalities (image, file), architecture.output_modalities (image), pricing.web_search. Case-insensitive modality matching (FILE -> file_upload). Multiple assertions covering different derivation paths. | Validate against latest OpenRouter schema. Check if new modalities or parameters added. Verify pricing.web_search format (string vs number handled). Cross-check with `.external/models-openrouter-2025-11-30-pretty.json`. |
| `test_registry_list_models_and_mapping` | Tests model listing and ID mapping functions return correct data | Tests `list_models()` merges models with specs and `api_model_id()` looks up original API format | `OpenRouterModelRegistry.list_models()`, `OpenRouterModelRegistry.api_model_id()` | `reset_registry` fixture; manually populated `_models`, `_specs`, and `_id_map` | (1) `models[0]["capabilities"]["vision"] is True` - spec capabilities merged into model, (2) `api_model_id("demo") == "provider/demo"` - ID mapping works | LOW - Simple lookup/merge logic | YES | Tests public API surface. Validates model list includes merged capabilities from specs. Tests bidirectional ID mapping: normalized "demo" maps to API format "provider/demo". No HTTP, pure data structure access. | None - data access validated |


## `tests/test_request_identifiers.py`

| Test Name | Description | What It Tests | Code Under Test | Mocks/Fixtures | Assertions | Drift Risk | Check Done | Codex Notes | Codex TODO |
|-----------|-------------|---------------|-----------------|----------------|------------|------------|------------|-------------|------------|
| test_identifier_valves_default_omit_everything | Verifies that default valve settings strip all identifier fields from payload | When all SEND_*_ID valves are False (default), user/session_id/metadata fields are removed from payload even if present | `_apply_identifier_valves_to_payload()` in `open_webui_openrouter_pipe/api/transforms.py` | None; uses `_base_payload()` helper and `Pipe.Valves()` default instance | Asserts "user" not in payload; "session_id" not in payload; "metadata" not in payload | Low - Core privacy feature ensuring identifiers are not leaked by default | [ ] | Tests default privacy-preserving behavior of valve system | |
| test_identifier_valves_populate_expected_fields[SEND_END_USER_ID] | Verifies SEND_END_USER_ID valve adds user identifier to payload | When SEND_END_USER_ID=True, user ID is added to both top-level "user" field and metadata.user_id | `_apply_identifier_valves_to_payload()` in `open_webui_openrouter_pipe/api/transforms.py` | None; parametrized with valves_kwargs={"SEND_END_USER_ID": True} | Asserts payload["user"] == "u1"; payload["metadata"]["user_id"] == "u1" | Low - Direct mapping from valve to output fields | [ ] | Tests user ID propagation per OpenRouter API spec | |
| test_identifier_valves_populate_expected_fields[SEND_SESSION_ID] | Verifies SEND_SESSION_ID valve adds session identifier to payload | When SEND_SESSION_ID=True, session ID is added to both top-level "session_id" field and metadata.session_id | `_apply_identifier_valves_to_payload()` in `open_webui_openrouter_pipe/api/transforms.py` | None; parametrized with valves_kwargs={"SEND_SESSION_ID": True} | Asserts payload["session_id"] == "s1"; payload["metadata"]["session_id"] == "s1" | Low - Direct mapping from valve to output fields | [ ] | Tests session ID propagation per OpenRouter API spec | |
| test_identifier_valves_populate_expected_fields[SEND_CHAT_ID] | Verifies SEND_CHAT_ID valve adds chat identifier to metadata only | When SEND_CHAT_ID=True, chat ID is added to metadata.chat_id (no top-level field per OpenRouter spec) | `_apply_identifier_valves_to_payload()` in `open_webui_openrouter_pipe/api/transforms.py` | None; parametrized with valves_kwargs={"SEND_CHAT_ID": True} | Asserts payload["metadata"]["chat_id"] == "c1" | Low - Metadata-only field per spec | [ ] | chat_id has no top-level OpenRouter field | |
| test_identifier_valves_populate_expected_fields[SEND_MESSAGE_ID] | Verifies SEND_MESSAGE_ID valve adds message identifier to metadata only | When SEND_MESSAGE_ID=True, message ID is added to metadata.message_id (no top-level field per OpenRouter spec) | `_apply_identifier_valves_to_payload()` in `open_webui_openrouter_pipe/api/transforms.py` | None; parametrized with valves_kwargs={"SEND_MESSAGE_ID": True} | Asserts payload["metadata"]["message_id"] == "m1" | Low - Metadata-only field per spec | [ ] | message_id has no top-level OpenRouter field | |
| test_identifier_valves_populate_expected_fields[all_valves_enabled] | Verifies all identifier valves enabled together produce complete payload | When all SEND_*_ID valves are True, all identifiers appear in correct locations | `_apply_identifier_valves_to_payload()` in `open_webui_openrouter_pipe/api/transforms.py` | None; parametrized with all four valves enabled | Asserts user=="u1", session_id=="s1", metadata contains all four IDs (user_id, session_id, chat_id, message_id) | Low - Comprehensive combination test | [ ] | Tests full identifier suite when operator enables all | |
| test_filter_openrouter_request_sanitizes_metadata_constraints | Verifies metadata sanitizer enforces OpenRouter constraints on keys/values | Invalid metadata entries (bracket chars in keys, overly long values) are stripped while valid entries are preserved | `_filter_openrouter_request()` and `_sanitize_openrouter_metadata()` in `open_webui_openrouter_pipe/api/transforms.py` | None; manually constructs payload with invalid metadata entries | Asserts metadata["user_id"] == "u1"; metadata["ok"] == "v"; "bad[key]" not in metadata; "too_long_value" not in metadata | Medium - OpenRouter may change metadata constraints | [ ] | Tests key format validation (no brackets) and value length limits (512 chars) | |


## `tests/test_request_orchestrator.py`

| Test Name | Description | What It Tests | Code Under Test | Mocks/Fixtures | Assertions | Drift Risk | Check Done | Codex Notes | Codex TODO |
|-----------|-------------|---------------|-----------------|----------------|------------|------------|------------|-------------|------------|
| test_extract_direct_uploads_returns_empty_for_invalid_pipe_meta | Test that _extract_direct_uploads returns empty dict when pipe_meta is not a dict | Direct uploads extraction validation when attachments is not a dict | RequestOrchestrator._extract_direct_uploads line 79 | aioresponses for HTTP, event_emitter callback, metadata with invalid direct_uploads (string instead of dict) | len(captured_payloads) >= 1 | LOW - Simple validation logic |  | Tests error handling for invalid metadata structure | None |
| test_extract_direct_uploads_skips_invalid_items | Test that _extract_direct_uploads skips invalid items (non-dict, missing/invalid id) | Validation and filtering of upload items: non-dict entries, invalid file_ids, duplicate file_ids | RequestOrchestrator._extract_direct_uploads lines 92-98 | aioresponses, mock_inline_owui_file_id, mixed valid/invalid items including: non-dict, None id, empty id, whitespace id, duplicates | len(captured_payloads) >= 1 | LOW - Item validation logic |  | Tests filtering logic for various invalid item types | None |
| test_inject_direct_uploads_requires_messages | Test that _inject_direct_uploads_into_messages raises ValueError without messages | Error when messages list is empty or missing | RequestOrchestrator._inject_direct_uploads_into_messages line 113 | aioresponses, event_emitter, empty messages array | No exception raised (error handled gracefully) | LOW - Basic validation |  | Tests error path for missing messages | None |
| test_inject_direct_uploads_requires_user_message | Test that _inject_direct_uploads_into_messages raises ValueError without user message | Error when no user role message found in messages | RequestOrchestrator._inject_direct_uploads_into_messages line 121 | aioresponses, messages with only system role | No exception raised (error handled) | LOW - Role validation |  | Tests error path when user message missing | None |
| test_inject_direct_uploads_handles_list_content | Test that _inject_direct_uploads_into_messages handles list content | Handling content as list of parts (multimodal) | RequestOrchestrator._inject_direct_uploads_into_messages lines 128-131 | aioresponses, mock_inline_owui_file_id, messages with content as list | len(captured_payloads) >= 1 | MEDIUM - Multimodal content handling |  | Tests content list format handling | None |
| test_inject_direct_uploads_handles_none_content | Test that _inject_direct_uploads_into_messages handles None content | Handling content as None value | RequestOrchestrator._inject_direct_uploads_into_messages lines 132-133 | aioresponses, mock_inline_owui_file_id, message with content: None | len(captured_payloads) >= 1 | LOW - None handling |  | Tests None content edge case | None |
| test_inject_direct_uploads_unsupported_content_type | Test that _inject_direct_uploads_into_messages raises error for unsupported content | Error for unsupported content type (not str, list, None) | RequestOrchestrator._inject_direct_uploads_into_messages line 135 | aioresponses, event_emitter, message with content as int (12345) | No exception raised (error handled) | LOW - Type validation |  | Tests unsupported type error path | None |
| test_sniff_audio_format_wav | Test audio format sniffing for WAV files | WAV file format detection via RIFF/WAVE signature | RequestOrchestrator._sniff_audio_format lines 177-178 | aioresponses, AsyncMock for _get_file_by_id and _read_file_record_base64, _wav_like_base64 | len(captured_payloads) >= 1 | LOW - Binary signature matching |  | Tests WAV format signature detection | None |
| test_sniff_audio_format_mp3_id3 | Test audio format sniffing for MP3 with ID3 header | MP3 detection via ID3 signature | RequestOrchestrator._sniff_audio_format lines 179-180 | aioresponses, AsyncMock, _mp3_like_base64 (ID3 header) | len(captured_payloads) >= 1 | LOW - Binary signature matching |  | Tests MP3 ID3 header detection | None |
| test_sniff_audio_format_mp3_sync | Test audio format sniffing for MP3 with sync word | MP3 detection via sync word (0xFF 0xE0+) | RequestOrchestrator._sniff_audio_format lines 181-182 | aioresponses, AsyncMock, _mp3_sync_base64 | len(captured_payloads) >= 1 | LOW - Binary signature matching |  | Tests MP3 sync word detection | None |
| test_sniff_audio_format_m4a | Test audio format sniffing for M4A files | M4A detection via ftyp signature at bytes[4:8] | RequestOrchestrator._sniff_audio_format lines 183-185 | aioresponses, AsyncMock, _m4a_like_base64 | len(captured_payloads) >= 1 | LOW - Binary signature matching |  | Tests M4A ftyp signature detection | None |
| test_sniff_audio_format_flac | Test audio format sniffing for FLAC files | FLAC detection via fLaC signature | RequestOrchestrator._sniff_audio_format lines 186-187 | aioresponses, AsyncMock, _flac_like_base64 | len(captured_payloads) >= 1 | LOW - Binary signature matching |  | Tests FLAC signature detection | None |
| test_sniff_audio_format_ogg | Test audio format sniffing for OGG files | OGG detection via OggS signature | RequestOrchestrator._sniff_audio_format lines 188-189 | aioresponses, AsyncMock, _ogg_like_base64 | len(captured_payloads) >= 1 | LOW - Binary signature matching |  | Tests OGG signature detection | None |
| test_sniff_audio_format_webm | Test audio format sniffing for WebM files | WebM detection via EBML header (0x1A 0x45 0xDF 0xA3) | RequestOrchestrator._sniff_audio_format lines 190-191 | aioresponses, AsyncMock, _webm_like_base64 | len(captured_payloads) >= 1 | LOW - Binary signature matching |  | Tests WebM EBML header detection | None |
| test_audio_with_explicit_format | Test audio upload with explicit format specified | Audio handling when format explicitly declared (no sniffing needed) | RequestOrchestrator audio processing path | aioresponses, AsyncMock, audio with format: "mp3" | len(captured_payloads) >= 1 | LOW - Direct format use |  | Tests explicit format override | None |
| test_audio_format_allowlist_from_metadata | Test that responses_audio_format_allowlist from metadata is used | Custom audio format allowlist from metadata | RequestOrchestrator lines 221-224 | aioresponses, AsyncMock, metadata with responses_audio_format_allowlist: "mp3,wav,ogg" | len(captured_payloads) >= 1 | MEDIUM - Allowlist configuration |  | Tests custom allowlist override | None |
| test_audio_file_not_found_error | Test error when audio file cannot be loaded | Audio file retrieval error (file_obj is None) | RequestOrchestrator line 232 | aioresponses, AsyncMock returning None for _get_file_by_id, event_emitter | No exception raised (error handled) | LOW - File lookup error |  | Tests missing file error path | None |
| test_audio_file_encode_error | Test error when audio file cannot be encoded | Audio base64 encoding error | RequestOrchestrator lines 234-235 | aioresponses, AsyncMock returning None for _read_file_record_base64 | No exception raised (error handled) | LOW - Encoding error |  | Tests encoding failure error path | None |
| test_audio_missing_format_error | Test error when audio format cannot be determined | Audio format detection failure (no format found) | RequestOrchestrator lines 240-241 | aioresponses, AsyncMock with random garbage data that doesn't match any signature | No exception raised (error handled) | MEDIUM - Format detection limits |  | Tests unrecognized format error | None |
| test_video_upload_injection | Test video file upload injection into messages | Video file handling and data URL construction | RequestOrchestrator lines 252-270 | aioresponses, AsyncMock, video with content_type: "video/mp4" | len(captured_payloads) >= 1 | MEDIUM - Video injection |  | Tests video upload with explicit MIME type | None |
| test_video_file_not_found_error | Test error when video file cannot be loaded | Video file retrieval error (file_obj is None) | RequestOrchestrator lines 257-258 | aioresponses, AsyncMock returning None, event_emitter | No exception raised (error handled) | LOW - File lookup error |  | Tests missing video file error path | None |
| test_video_infers_mime_type | Test that video MIME type is inferred when not provided | Video MIME type inference from file_obj.meta | RequestOrchestrator lines 263-264 | aioresponses, AsyncMock, MagicMock with meta containing content_type, _infer_file_mime_type | len(captured_payloads) >= 1 | MEDIUM - MIME inference |  | Tests MIME type inference fallback | None |
| test_video_file_encode_error | Test error when video file cannot be encoded | Video base64 encoding error | RequestOrchestrator lines 260-261 | aioresponses, AsyncMock returning None for _read_file_record_base64 | No exception raised (error handled) | LOW - Encoding error |  | Tests video encoding failure | None |
| test_direct_uploads_warnings_emitted | Test that direct upload warnings are emitted to the user | Warning extraction and notification emission for upload issues | RequestOrchestrator lines 328-344 | aioresponses, event_emitter, metadata with direct_uploads_warnings array including duplicates and empty strings | len(captured_payloads) >= 1 | MEDIUM - Warning aggregation |  | Tests warning deduplication and emission | None |
| test_endpoint_override_conflict_with_forced_responses | Test error when video requires chat_completions but model forced to responses | Endpoint override conflict detection (video + FORCE_RESPONSES_MODELS) | RequestOrchestrator lines 398-413 | aioresponses, FORCE_RESPONSES_MODELS valve set, video upload metadata, event_emitter | No exception raised (error emitted) | MEDIUM - Endpoint conflict |  | Tests incompatible endpoint/content conflict | None |
| test_use_model_max_output_tokens_sets_default | Test that USE_MODEL_MAX_OUTPUT_TOKENS sets max_output_tokens from model capabilities | Setting default max_output_tokens from model registry | RequestOrchestrator lines 446-449 | aioresponses, ModelFamily.set_dynamic_specs with max_completion_tokens, USE_MODEL_MAX_OUTPUT_TOKENS=True | len(captured_payloads) >= 1 | MEDIUM - Token limit config |  | Tests automatic token limit setting | Verify actual token value in payload |
| test_use_model_max_output_tokens_disabled | Test that max_output_tokens is set to None when disabled | max_output_tokens=None when USE_MODEL_MAX_OUTPUT_TOKENS=False | RequestOrchestrator lines 450-451 | aioresponses, USE_MODEL_MAX_OUTPUT_TOKENS=False | payload.get("max_output_tokens") is None | LOW - Disabled config |  | Tests disabled token limit feature | None |
| test_tools_registry_awaitable_success | Test that awaitable tools registry is properly awaited | Awaiting async tools registry function | RequestOrchestrator lines 526-527 | aioresponses, async function get_tools() | len(captured_payloads) >= 1 | MEDIUM - Async handling |  | Tests awaitable tools registry success | None |
| test_tools_registry_awaitable_exception | Test that exception in awaitable tools registry is handled gracefully | Exception handling when awaiting tools registry | RequestOrchestrator lines 528-535 | aioresponses, async function that raises RuntimeError, event_emitter | len(captured_payloads) >= 1 | MEDIUM - Error resilience |  | Tests tools registry error handling | None |
| test_web_search_plugin_injection | Test that web search plugin is injected when enabled | Web search plugin injection with max_results configuration | RequestOrchestrator lines 636-653 | aioresponses, ModelFamily specs with web_search_tool, REASONING_EFFORT="medium", WEB_SEARCH_MAX_RESULTS=5, feature flag | len(captured_payloads) >= 1 | HIGH - Feature integration |  | Tests web search plugin injection logic | Verify plugin structure in payload |
| test_status_css_patch_injection | Test that CSS patch is injected when ENABLE_STATUS_CSS_PATCH is True | CSS injection via __event_call__ for status formatting | RequestOrchestrator lines 280-316 | aioresponses, event_call callback, ENABLE_STATUS_CSS_PATCH=True | CSS code with "owui-status-unclamp" found in event_call invocations | MEDIUM - UI patch |  | Tests CSS injection for status display | None |
| test_task_mode_bypasses_whitelist | Test that task requests bypass model whitelist restrictions | Whitelist bypass for task mode requests (title generation) | RequestOrchestrator lines 454-461 | aioresponses, MODEL_ID valve restricting models, __task__="title_generation", caplog | Request completes despite model mismatch | MEDIUM - Access control |  | Tests task mode whitelist bypass | None |
| test_api_error_reported_to_user | Test that API errors are properly reported to the user | OpenRouterAPIError reporting to event_emitter | RequestOrchestrator lines 764-771 | aioresponses with 400 error callback, event_emitter | No exception raised (error emitted) | HIGH - Error handling |  | Tests API error user notification | None |
| test_reasoning_effort_retry_on_unsupported_value | Test retry with fallback effort when original is unsupported | Reasoning effort retry logic on unsupported_value error | RequestOrchestrator lines 710-755 | aioresponses with error then success callback, ModelFamily specs, REASONING_EFFORT="high" | call_count[0] >= 1 | HIGH - Retry logic |  | Tests reasoning effort fallback mechanism | Verify retry actually occurred |
| test_non_streaming_request | Test non-streaming request path | Non-streaming loop execution (lines 678-690) | RequestOrchestrator lines 678-690 | aioresponses, stream=False | result is not None, len(captured_payloads) >= 1 | MEDIUM - Flow variant |  | Tests non-streaming response handling | None |
| test_owui_tool_registry_list_form | Test that OWUI tool registry in list form is normalized | Normalizing list-form tool registry to dict form | RequestOrchestrator lines 570-578 | aioresponses, tools_list with mixed valid/invalid entries | len(captured_payloads) >= 1 | MEDIUM - Format normalization |  | Tests list-to-dict conversion for tools | None |
| test_tool_rename_debug_logging | Test that tool renames are logged at debug level | Debug logging for tool collision renames | RequestOrchestrator lines 623-624 | aioresponses, tools dict, caplog with DEBUG level | len(captured_payloads) >= 1 | LOW - Logging only |  | Tests debug logging for tool renames | None |
| test_decode_base64_prefix_empty_data | Test _decode_base64_prefix returns empty bytes when data is empty string | Empty data handling returns b"" | RequestOrchestrator._decode_base64_prefix line 147 | aioresponses, AsyncMock returning empty string, event_emitter | No exception raised (error emitted for missing format) | LOW - Edge case |  | Tests empty data edge case | None |
| test_decode_base64_prefix_invalid_chars | Test _decode_base64_prefix returns empty bytes for invalid base64 characters | Invalid character detection (ord > 127) | RequestOrchestrator._decode_base64_prefix line 160 | aioresponses, AsyncMock with unicode characters, event_emitter | No exception raised (error handled) | LOW - Input validation |  | Tests invalid character handling | None |
| test_decode_base64_prefix_invalid_base64_structure | Test _decode_base64_prefix handles malformed base64 with fallback decode | Base64 decode exception handling with fallback | RequestOrchestrator._decode_base64_prefix lines 165-169 | aioresponses, AsyncMock with "AAAA====AAAA", event_emitter | No exception raised | MEDIUM - Resilient parsing |  | Tests fallback decode for malformed b64 | None |
| test_sniff_audio_format_empty_prefix | Test _sniff_audio_format returns empty string when prefix is empty | Empty prefix handling returns "" | RequestOrchestrator._sniff_audio_format line 176 | aioresponses, AsyncMock returning None (encoding fails), event_emitter | No exception raised (error emitted) | LOW - Edge case |  | Tests empty prefix from failed encoding | None |
| test_files_loop_skips_invalid_file_id | Test that files loop skips items with invalid file_id | File ID validation in files loop (None, empty string) | RequestOrchestrator file processing line 197 | aioresponses, metadata with invalid file_ids, mock_inline_owui_file_id | len(captured_payloads) >= 1 | LOW - Validation |  | Tests file ID validation and skipping | None |
| test_audio_loop_skips_invalid_file_id | Test that audio loop skips items with invalid file_id | Audio file ID validation in audio loop | RequestOrchestrator audio processing line 229 | aioresponses, metadata with invalid audio file_ids, AsyncMock | len(captured_payloads) >= 1 | LOW - Validation |  | Tests audio file ID validation | None |
| test_video_loop_skips_invalid_file_id | Test that video loop skips items with invalid file_id | Video file ID validation in video loop | RequestOrchestrator video processing line 255 | aioresponses, metadata with invalid video file_ids, AsyncMock | len(captured_payloads) >= 1 | LOW - Validation |  | Tests video file ID validation | None |
| test_csv_set_with_non_string_value | Test _csv_set returns empty set when value is not a string | Non-string value handling returns set() | RequestOrchestrator._csv_set line 213 | aioresponses, responses_audio_format_allowlist=12345 (int), AsyncMock | len(captured_payloads) >= 1 | LOW - Type validation |  | Tests non-string CSV set input | None |
| test_direct_tool_server_registry_exception | Test that exception in _build_direct_tool_server_registry is handled | Direct tool server registry exception handling | RequestOrchestrator lines 548-549 | aioresponses, mock _build_direct_tool_server_registry to raise RuntimeError | len(captured_payloads) >= 1 | MEDIUM - Error resilience |  | Tests tool registry build failure handling | None |
| test_extra_tools_from_completions_body | Test that extra_tools from completions_body are merged | Merging extra_tools from body.extra_tools | RequestOrchestrator lines 555-557 | aioresponses, body with extra_tools including non-dict entries | len(captured_payloads) >= 1 | MEDIUM - Tool merging |  | Tests extra_tools merging and filtering | None |
| test_owui_tool_registry_list_skips_non_dict | Test that OWUI tool registry in list form skips non-dict entries | Skipping non-dict entries in list-form registry | RequestOrchestrator line 573 | aioresponses, tools_list with string, int, None entries | len(captured_payloads) >= 1 | LOW - Type filtering |  | Tests non-dict entry filtering | None |
| test_tool_assignment_with_owui_passthrough | Test tool assignment when TOOL_EXECUTION_MODE is 'Open-WebUI' | Tool passthrough mode (owui_tool_passthrough=True) | RequestOrchestrator line 632 | aioresponses, TOOL_EXECUTION_MODE="Open-WebUI", tools in body | len(captured_payloads) >= 1 | MEDIUM - Execution mode |  | Tests OWUI tool passthrough mode | None |
| test_web_search_skipped_with_minimal_effort | Test that web search plugin is skipped when reasoning effort is 'minimal' | Web search skipping logic for minimal effort | RequestOrchestrator lines 638-646 | aioresponses, ModelFamily specs, REASONING_EFFORT="minimal", feature flag | len(captured_payloads) >= 1 | MEDIUM - Conditional feature |  | Tests web search skipping with minimal effort | None |
| test_web_search_with_reasoning_config_effort | Test web search uses reasoning.effort from responses_body if set | Effort override from body.reasoning config | RequestOrchestrator lines 638-641 | aioresponses, ModelFamily specs, body with reasoning.effort="medium" | len(captured_payloads) >= 1 | MEDIUM - Config override |  | Tests reasoning effort override from body | None |
| test_anthropic_prompt_cache_retry | Test retry without cache_control for Anthropic models on 400 error | Anthropic prompt cache retry logic on cache error | RequestOrchestrator lines 692-708 | aioresponses with cache error then success, patches for _input_contains_cache_control and _is_anthropic_model_id, ENABLE_ANTHROPIC_PROMPT_CACHING=True | call_count[0] >= 1 | HIGH - Provider-specific retry |  | Tests Anthropic cache control retry | Verify cache_control removed on retry |
| test_reasoning_retry_without_reasoning | Test retry without reasoning when _should_retry_without_reasoning returns True | Reasoning removal retry on unsupported feature | RequestOrchestrator lines 757-762 | aioresponses with reasoning error then success, mock _should_retry_without_reasoning | call_count[0] >= 1 | HIGH - Retry logic |  | Tests reasoning removal retry | None |
| test_reasoning_effort_retry_emits_status | Test that reasoning effort retry emits status update to event emitter | Status event emission during effort retry | RequestOrchestrator lines 733-748 | aioresponses with effort error then success, ModelFamily specs, event_emitter | Status events may be present | MEDIUM - User feedback |  | Tests status notification on retry | Verify status event content |
| test_status_css_patch_skipped_without_event_call | Test that CSS patch logs debug when __event_call__ is unavailable | Debug logging when event_call is None | RequestOrchestrator line 318 | aioresponses, ENABLE_STATUS_CSS_PATCH=True, __event_call__=None | len(captured_payloads) >= 1 | LOW - Logging only |  | Tests CSS patch skip with no event_call | None |
| test_reasoning_effort_retry_initializes_dict | Test that reasoning dict is initialized when None during effort retry | Reasoning dict initialization (if not dict, make it {}) | RequestOrchestrator lines 750-752 | aioresponses with effort error then success, ModelFamily specs, body without reasoning field | call_count[0] >= 1 | MEDIUM - Initialization |  | Tests reasoning dict creation on retry | None |
| test_api_error_final_reporting_no_retry | Test that API errors are reported when no retry conditions match | Final error reporting when no retry applies | RequestOrchestrator lines 764-771 | aioresponses with 400 error, event_emitter, stream=False | Error emitted via event_emitter | HIGH - Error handling |  | Tests final error path with no retry | None |
| test_task_mode_ignores_direct_uploads | Test that task mode ignores direct uploads in metadata | Direct uploads ignored for task requests | RequestOrchestrator lines 356-362 | aioresponses, metadata with direct_uploads, __task__="title_generation" | No input_audio or file blocks in payload | MEDIUM - Task behavior |  | Tests task mode upload skipping | None |
| test_owui_metadata_tools_registry | Test that tools from metadata["tools"] are used for execution registry | OWUI-native tools from metadata["tools"] | RequestOrchestrator lines 585-591 | aioresponses, metadata with tools dict including invalid entry | len(captured_payloads) >= 1 | MEDIUM - Tool source |  | Tests metadata tools usage | None |
| test_model_restriction_not_in_catalog | Test that model restriction error is emitted for unknown models | Model catalog validation and error emission | RequestOrchestrator lines 464-488 | aioresponses with limited catalog, request for unknown model, event_emitter | Error emitted via event_emitter | HIGH - Access control |  | Tests unknown model restriction | None |
| test_tool_renames_with_collisions | Test that tool renames are logged when there are collisions | Tool rename logging when renames dict non-empty | RequestOrchestrator line 624 | aioresponses, tools dict, caplog with DEBUG | len(captured_payloads) >= 1 | LOW - Logging |  | Tests tool collision rename logging | None |


## `tests/test_request_transformer.py`

| Test Name | Description | What It Tests | Code Under Test | Mocks/Fixtures | Assertions | Drift Risk | Check Done | Codex Notes | Codex TODO |
|-----------|-------------|---------------|-----------------|----------------|------------|------------|------------|-------------|------------|
| TestSystemMessages::test_system_message_string_content | System message with string content is transformed correctly | System role with string content produces correct input_text block | transform_messages_to_input, system message handling | pipe_instance | Verifies result has 1 message with type=message, role=system, content=[{type:input_text, text:...}] | Low - Basic transformation | Yes | Tests core system message transformation with string content | None |
| TestSystemMessages::test_developer_message_string_content | Developer message with string content is transformed correctly | Developer role with string content produces correct input_text block | transform_messages_to_input, developer message handling | pipe_instance | Verifies result has 1 message with type=message, role=developer, content=[{type:input_text, text:...}] | Low - Basic transformation | Yes | Tests developer role (similar to system) | None |
| TestSystemMessages::test_system_message_list_content_strings | System message with list of strings is transformed correctly | System role with list of strings creates multiple input_text blocks | transform_messages_to_input | pipe_instance | Verifies 2 content blocks with correct text values | Low | Yes | Tests list content handling for system messages | None |
| TestSystemMessages::test_system_message_list_content_dicts_with_text | System message with list of dicts containing text key | System role extracts text from dict elements in list | transform_messages_to_input | pipe_instance | Verifies 2 content blocks extracted from dicts with text keys | Low | Yes | Tests dict content with text key extraction | None |
| TestSystemMessages::test_system_message_list_content_dicts_with_content_key | System message with list of dicts containing content key | System role extracts text from content key in dicts | transform_messages_to_input | pipe_instance | Verifies content[0].text matches content key value | Low | Yes | Tests alternate content key for text extraction | None |
| TestSystemMessages::test_system_message_dict_content_with_text | System message with dict content containing text key | System role handles dict with text key | transform_messages_to_input | pipe_instance | Verifies content=[{type:input_text, text:...}] | Low | Yes | Tests single dict content with text key | None |
| TestSystemMessages::test_system_message_dict_content_with_content_key | System message with dict content containing content key | System role handles dict with content key | transform_messages_to_input | pipe_instance | Verifies content=[{type:input_text, text:...}] | Low | Yes | Tests single dict content with content key | None |
| TestSystemMessages::test_system_message_empty_content_included | System message with empty content still creates a block | Empty system message content creates block with empty text | transform_messages_to_input | pipe_instance | Verifies 2 results, system with empty text content | Low | Yes | Ensures empty content doesn't skip message creation | None |
| TestSystemMessages::test_system_message_list_with_non_text_entries | System message list with non-text entries filters them out | Non-text entries in system message list are filtered | transform_messages_to_input | pipe_instance | Verifies only 2 valid text blocks remain | Low | Yes | Tests filtering of non-text content blocks | None |
| TestUserMessages::test_user_message_string_content | User message with string content is transformed correctly | User role with string content produces input_text block | transform_messages_to_input | pipe_instance | Verifies 1 message with type=message, role=user, content=[{type:input_text}] | Low | Yes | Basic user message transformation | None |
| TestUserMessages::test_user_message_list_content_with_text_block | User message with list content containing text blocks | User role with list of text blocks produces multiple input_text | transform_messages_to_input | pipe_instance | Verifies 2 content blocks with correct text | Low | Yes | Tests list content handling for user messages | None |
| TestUserMessages::test_user_message_empty_blocks_skipped | Empty content blocks are skipped | User message filters out None and empty dict blocks | transform_messages_to_input | pipe_instance | Verifies only 2 valid text blocks remain | Low | Yes | Tests robustness against empty/null blocks | None |
| TestUserMessages::test_user_message_unknown_block_type_passed_through | Unknown block types are passed through as-is | User message with unknown type uses identity transform | transform_messages_to_input | pipe_instance | Verifies custom_type block preserved with data field | Low | Yes | Tests fallback behavior for unknown block types | None |
| TestToolResponses::test_tool_response_string_content | Tool response with string content | Tool role with string content produces function_call_output | transform_messages_to_input | pipe_instance | Verifies type=function_call_output, call_id, output fields | Low | Yes | Basic tool response transformation | None |
| TestToolResponses::test_tool_response_dict_content | Tool response with dict content is JSON serialized | Tool role serializes dict content to JSON string | transform_messages_to_input | pipe_instance | Verifies output contains JSON serialized content | Low | Yes | Tests JSON serialization of tool output | None |
| TestToolResponses::test_tool_response_none_content | Tool response with None content produces empty string | Tool role handles None content gracefully | transform_messages_to_input | pipe_instance | Verifies output="" | Low | Yes | Tests None content handling | None |
| TestToolResponses::test_tool_response_missing_call_id_skipped | Tool response without call_id is skipped | Tool message requires tool_call_id or equivalent | transform_messages_to_input | pipe_instance | Verifies result is empty (skipped) | Low | Yes | Tests validation of required call_id | None |
| TestToolResponses::test_tool_response_empty_call_id_skipped | Tool response with empty call_id is skipped | Tool message validates call_id is not whitespace | transform_messages_to_input | pipe_instance | Verifies result is empty (skipped) | Low | Yes | Tests call_id whitespace validation | None |
| TestToolResponses::test_tool_response_id_field_fallback | Tool response uses 'id' field as fallback for call_id | Tool message extracts call_id from id field | transform_messages_to_input | pipe_instance | Verifies call_id="call_from_id" | Low | Yes | Tests fallback id extraction | None |
| TestToolResponses::test_tool_response_call_id_field_fallback | Tool response uses 'call_id' field as fallback | Tool message extracts from call_id field | transform_messages_to_input | pipe_instance | Verifies call_id="call_from_call_id" | Low | Yes | Tests call_id field extraction | None |
| TestAssistantMessages::test_assistant_message_string_content | Assistant message with string content | Assistant role with string produces output_text block | transform_messages_to_input | pipe_instance | Verifies type=message, role=assistant, content=[{type:output_text}] | Low | Yes | Basic assistant message transformation | None |
| TestAssistantMessages::test_assistant_message_with_annotations | Assistant message preserves annotations | Assistant role preserves annotations field | transform_messages_to_input | pipe_instance | Verifies annotations field present and matches | Low | Yes | Tests annotations pass-through | None |
| TestAssistantMessages::test_assistant_message_with_reasoning_details | Assistant message preserves reasoning_details | Assistant role preserves reasoning_details field | transform_messages_to_input | pipe_instance | Verifies reasoning_details field present | Low | Yes | Tests reasoning_details pass-through | None |
| TestAssistantMessages::test_assistant_message_empty_content_not_added | Assistant message with empty content is not added | Assistant with empty content produces no blocks | transform_messages_to_input | pipe_instance | Verifies result is empty | Low | Yes | Tests empty content filtering for assistant | None |
| TestAssistantMessages::test_assistant_message_list_content_extracted | Assistant message with list content extracts plain text | Assistant role extracts and joins text from list | transform_messages_to_input | pipe_instance | Verifies text parts joined in output | Low | Yes | Tests text extraction from content list | None |
| TestAssistantMessages::test_assistant_message_with_tool_calls | Assistant message with tool_calls generates function_call items | Assistant tool_calls produces separate function_call blocks | transform_messages_to_input | pipe_instance | Verifies 2 results: message and function_call with correct fields | Low | Yes | Tests tool call transformation | None |
| TestAssistantMessages::test_assistant_tool_call_dict_arguments | Tool call with dict arguments is serialized to JSON | Assistant tool_call serializes dict arguments to JSON | transform_messages_to_input | pipe_instance | Verifies arguments contains JSON serialized dict | Low | Yes | Tests argument serialization | None |
| TestAssistantMessages::test_assistant_tool_call_missing_name_skipped | Tool call without function name is skipped | Assistant validates tool_call has function name | transform_messages_to_input | pipe_instance | Verifies only 1 result (message, no function_call) | Low | Yes | Tests name validation for tool calls | None |
| TestAssistantMessages::test_assistant_tool_call_generates_id_if_missing | Tool call without id generates one | Assistant generates call_id when missing | transform_messages_to_input | pipe_instance | Verifies call_id starts with "call_" | Low | Yes | Tests auto-generation of missing call_id | None |
| TestAssistantMessages::test_assistant_tool_call_non_function_type_skipped | Tool call with non-function type is skipped | Assistant validates tool_call type is "function" | transform_messages_to_input | pipe_instance | Verifies result is empty (only non-function type) | Low | Yes | Tests type validation for tool calls | None |
| TestAssistantMessages::test_assistant_tool_call_non_dict_skipped | Non-dict tool_calls entries are skipped | Assistant validates tool_calls elements are dicts | transform_messages_to_input | pipe_instance | Verifies only 1 result (message, invalid calls skipped) | Low | Yes | Tests type validation of tool_calls array | None |
| TestTurnComputation::test_turn_indices_user_assistant_alternating | Turn indices computed correctly for alternating user/assistant | Turn computation for alternating messages | transform_messages_to_input | pipe_instance | Verifies all 4 messages present | Low | Yes | Tests basic turn indexing | None |
| TestTurnComputation::test_turn_indices_multiple_user_messages | Multiple consecutive user messages stay in same turn | Turn computation with consecutive same-role messages | transform_messages_to_input | pipe_instance | Verifies all 3 messages present | Low | Yes | Tests same-turn grouping | None |
| TestTurnComputation::test_turn_indices_assistant_before_user | Assistant message before any user starts turn 0 | Turn computation when assistant comes first | transform_messages_to_input | pipe_instance | Verifies 2 messages present | Low | Yes | Tests non-standard conversation start | None |
| TestTurnComputation::test_direct_tool_outputs_not_pruned | Direct tool messages are NOT pruned - pruning only applies to marker-replayed artifacts | Direct tool role messages bypass pruning logic | transform_messages_to_input, pruning_turns param | pipe_instance | Verifies long tool output NOT pruned (no pruning marker text) | Medium | Yes | Critical: Direct tool outputs never pruned, only artifact-replayed ones | Verify this behavior aligns with pruning requirements |
| TestTurnComputation::test_no_pruning_when_pruning_turns_zero | No pruning when pruning_turns is 0 | pruning_turns=0 disables all pruning | transform_messages_to_input, pruning_turns=0 | pipe_instance | Verifies long tool output NOT pruned | Low | Yes | Tests pruning disable flag | None |
| TestImageHandling::test_image_block_skipped_for_non_vision_model | Image blocks are skipped when model doesn't support vision | Vision capability check via ModelFamily.supports | transform_messages_to_input, model_id param | pipe_instance, ModelFamily mock | Verifies only 1 content block (text, image skipped) | Medium | Yes | Tests model vision capability filtering | Ensure ModelFamily.supports integration |
| TestImageHandling::test_image_limit_enforced | Image limit is enforced | MAX_INPUT_IMAGES_PER_REQUEST valve controls image count | transform_messages_to_input | pipe_instance, ModelFamily mock, _inline_owui_file_id mock | Verifies <=2 image blocks when limit is 2 | Medium | Yes | Tests image count limiting | None |
| TestImageHandling::test_images_only_from_latest_user_message | Images are only included from the latest user message | Image selection logic for multi-user-message conversations | transform_messages_to_input | pipe_instance, ModelFamily mock, _inline_owui_file_id mock | Verifies first user message has 0 images | Medium | Yes | Tests latest-user-message image filtering | None |
| TestAudioHandling::test_audio_block_with_data_and_format | Audio block with data and format is transformed correctly | input_audio block with data and format fields | transform_messages_to_input | pipe_instance, sample_audio_base64 | Verifies type=input_audio, format=mp3 | Low | Yes | Basic audio block transformation | None |
| TestAudioHandling::test_audio_block_with_string_data | Audio block with string data is handled | input_audio as string with mimeType | transform_messages_to_input | pipe_instance, sample_audio_base64 | Verifies type=input_audio, format=mp3 | Low | Yes | Tests string audio data handling | None |
| TestAudioHandling::test_audio_block_url_rejected | Audio URLs are rejected (not supported) | URL strings in input_audio are rejected | transform_messages_to_input | pipe_instance | Verifies data="" (rejected) | Low | Yes | Tests audio URL rejection | None |
| TestAudioHandling::test_audio_block_invalid_base64_rejected | Invalid base64 audio data is rejected | Base64 validation for audio data | transform_messages_to_input | pipe_instance | Verifies data="" (rejected) | Low | Yes | Tests base64 validation | None |
| TestAudioHandling::test_audio_format_normalization | Audio format is normalized from mime type | MIME type to format mapping (audio/wav -> wav) | transform_messages_to_input | pipe_instance, sample_audio_base64 | Verifies format="wav" | Low | Yes | Tests MIME type normalization | None |
| TestAudioHandling::test_audio_empty_data_string | Audio with empty data string returns empty block | Empty string data handling | transform_messages_to_input | pipe_instance | Verifies data="" | Low | Yes | Tests empty data handling | None |
| TestAudioHandling::test_audio_whitespace_only_data | Audio with whitespace-only data returns empty block | Whitespace-only data validation | transform_messages_to_input | pipe_instance | Verifies data="" | Low | Yes | Tests whitespace validation | None |
| TestAudioHandling::test_audio_dict_data_only | Audio dict with only data field | Audio dict without format field defaults | transform_messages_to_input | pipe_instance, sample_audio_base64 | Verifies type=input_audio, format=mp3 (default) | Low | Yes | Tests default format assignment | None |
| TestAudioHandling::test_audio_string_invalid_base64 | Audio string with invalid base64 is rejected | Base64 validation on string input_audio | transform_messages_to_input | pipe_instance | Verifies data="" | Low | Yes | Tests string base64 validation | None |
| TestVideoHandling::test_video_block_with_url_dict | Video block with URL dict is transformed | video_url with dict containing url field | transform_messages_to_input | pipe_instance | Verifies type=video_url, url field correct | Low | Yes | Basic video block transformation | None |
| TestVideoHandling::test_video_block_with_url_string | Video block with URL string is transformed | video_url as string | transform_messages_to_input | pipe_instance | Verifies video_url.url correct | Low | Yes | Tests string video URL handling | None |
| TestVideoHandling::test_video_block_fallback_to_url_field | Video block falls back to url field | video type with url field (fallback) | transform_messages_to_input | pipe_instance | Verifies video_url.url correct | Low | Yes | Tests url field fallback | None |
| TestVideoHandling::test_video_block_empty_url | Video block with empty URL returns empty URL | Empty video_url handling | transform_messages_to_input | pipe_instance | Verifies url="" | Low | Yes | Tests empty URL handling | None |
| TestVideoHandling::test_video_data_url_size_check | Large video data URLs are rejected based on size limit | VIDEO_MAX_SIZE_MB valve enforces size limit | transform_messages_to_input | pipe_instance (valves.VIDEO_MAX_SIZE_MB=1) | Verifies url="" (rejected due to size) | Medium | Yes | Tests video size limiting | None |
| TestFileHandling::test_file_block_with_file_id | File block with file_id is passed through | input_file with file_id and filename | transform_messages_to_input | pipe_instance | Verifies type=input_file, file_id, filename | Low | Yes | Basic file block pass-through | None |
| TestFileHandling::test_file_block_with_nested_file | File block with nested file dict is handled | file type with nested file object | transform_messages_to_input | pipe_instance | Verifies type=input_file, file_id extracted from nested | Low | Yes | Tests nested file structure handling | None |
| TestFileHandling::test_file_block_internal_url_converted_to_id | Internal file URL is converted to file_id | /api/v1/files/*/content URL extraction | transform_messages_to_input | pipe_instance | Verifies file_id extracted, file_url removed | Medium | Yes | Tests OWUI internal URL parsing | None |
| TestFileHandling::test_file_data_internal_url_converted_to_file_id | Internal URL in file_data is converted to file_id | file_data with internal URL extraction | transform_messages_to_input | pipe_instance | Verifies file_id extracted, file_data removed | Medium | Yes | Tests file_data internal URL parsing | None |
| TestImageSelection::test_user_then_assistant_fallback | In user_then_assistant mode, assistant images are used as fallback | IMAGE_INPUT_SELECTION valve with fallback logic | transform_messages_to_input | pipe_instance (IMAGE_INPUT_SELECTION="user_then_assistant"), ModelFamily mock, _inline_owui_file_id mock | Verifies user message present | Medium | Yes | Tests image fallback selection mode | None |
| TestAnthropicPromptCaching::test_maybe_apply_anthropic_prompt_caching_called | Verify _maybe_apply_anthropic_prompt_caching is called | Integration with Anthropic prompt caching | transform_messages_to_input, model_id param | pipe_instance, _maybe_apply_anthropic_prompt_caching mock | Verifies mock called once | Low | Yes | Tests caching integration hook | None |
| TestValvesOverride::test_custom_valves_override | Custom valves parameter overrides instance valves | valves parameter overrides instance.valves | transform_messages_to_input, valves param | pipe_instance, custom SimpleNamespace valves | Verifies no exception, 1 result | Low | Yes | Tests valves override mechanism | None |
| TestMessageIdentifier::test_message_identifier_from_id | Message identifier extracted from 'id' field | Message id field extraction | transform_messages_to_input | pipe_instance | Verifies 1 result | Low | Yes | Tests id field processing | None |
| TestMessageIdentifier::test_message_identifier_from_message_id | Message identifier extracted from 'message_id' field | Message message_id field extraction | transform_messages_to_input | pipe_instance | Verifies 1 result | Low | Yes | Tests message_id field processing | None |
| TestEdgeCases::test_empty_messages_list | Empty messages list returns empty result | Empty input handling | transform_messages_to_input | pipe_instance | Verifies result=[] | Low | Yes | Tests empty input robustness | None |
| TestEdgeCases::test_unknown_role_treated_as_assistant | Messages with unknown roles are treated as assistant messages | Unknown role fallback to assistant | transform_messages_to_input | pipe_instance | Verifies 2 results, first has role=assistant | Medium | Yes | Tests unknown role handling | Document fallback behavior |
| TestEdgeCases::test_missing_role_treated_as_assistant | Messages without role (empty string) are treated as assistant | Missing role fallback to assistant | transform_messages_to_input | pipe_instance | Verifies 2 results, first has role=assistant | Medium | Yes | Tests missing role handling | None |
| TestEdgeCases::test_none_content_handled | None content is handled gracefully | None content produces empty content array | transform_messages_to_input | pipe_instance | Verifies content=[] | Low | Yes | Tests None content robustness | None |
| TestEdgeCases::test_mixed_message_types | Mix of all message types is handled correctly | Multi-role conversation transformation | transform_messages_to_input | pipe_instance | Verifies >=6 results (all roles processed) | Low | Yes | Integration test for mixed conversation | None |
| TestEdgeCases::test_case_insensitive_roles | Roles are case-insensitive | Role name case normalization | transform_messages_to_input | pipe_instance | Verifies 4 results (all processed) | Low | Yes | Tests case-insensitive role matching | None |
| TestToolOutputPruning::test_prune_tool_output_below_min_length | Tool output below minimum length is not pruned | _TOOL_OUTPUT_PRUNE_MIN_LENGTH threshold check | transform_messages_to_input, pruning_turns param | pipe_instance | Verifies no pruning marker in output | Low | Yes | Tests minimum length threshold | None |
| TestToolOutputPruning::test_direct_tool_output_not_pruned_regardless_of_size | Direct tool outputs are preserved regardless of size (pruning is marker-based) | Direct tool messages bypass pruning (only artifacts pruned) | transform_messages_to_input, pruning_turns param | pipe_instance | Verifies full output preserved, no pruning | Medium | Yes | Critical: Direct tools never pruned | Verify artifact-only pruning design |
| TestToolOutputPruning::test_direct_tool_large_output_preserved | Large direct tool output is fully preserved | Direct tool message full preservation | transform_messages_to_input, pruning_turns param | pipe_instance | Verifies full length, exact match | Medium | Yes | Confirms direct tool preservation | None |
| TestToolOutputPruning::test_turn_computation_with_tool_messages | Tool messages are associated with their turn correctly | Turn association for tool messages | transform_messages_to_input, pruning_turns param | pipe_instance | Verifies tool output present and complete | Low | Yes | Tests tool message turn tracking | None |
| TestToolOutputPruning::test_prune_non_function_call_output_ignored | Non-function_call_output items are not pruned | Pruning only applies to function_call_output type | transform_messages_to_input, pruning_turns param | pipe_instance | Verifies no pruning marker in user message | Low | Yes | Tests type-specific pruning | None |
| TestMarkerBasedArtifactReplay::test_assistant_with_marker_no_loader | Assistant message with marker but no artifact_loader logs warning | Marker detection without loader | transform_messages_to_input, chat_id, openwebui_model_id params | pipe_instance, VALID_MARKER constant | Verifies >=1 result | Low | Yes | Tests marker handling without loader | None |
| TestMarkerBasedArtifactReplay::test_assistant_with_marker_and_loader | Assistant message with marker and artifact_loader replays artifacts | Marker-based artifact replay mechanism | transform_messages_to_input, artifact_loader param | pipe_instance, mock_artifact_loader, VALID_MARKER | Verifies >=2 results (segments + artifact) | High | Yes | Core artifact replay functionality | Critical for conversation history |
| TestMarkerBasedArtifactReplay::test_assistant_with_reasoning_artifact | Reasoning artifacts are tracked in replayed_reasoning_refs | Reasoning artifact special handling | transform_messages_to_input, replayed_reasoning_refs param | pipe_instance, mock_artifact_loader, VALID_MARKER | Verifies reasoning ref tracked in list | Medium | Yes | Tests reasoning artifact tracking | None |
| TestMarkerBasedArtifactReplay::test_artifact_loader_exception_handled | Exception from artifact_loader is caught and logged | Artifact loader error handling | transform_messages_to_input, artifact_loader param | pipe_instance, failing_loader | Verifies no exception raised, result is list | Low | Yes | Tests loader failure resilience | None |
| TestMarkerBasedArtifactReplay::test_non_replayable_artifacts_skipped | Non-replayable artifact types are skipped | Artifact type filtering (replayable check) | transform_messages_to_input, artifact_loader param | pipe_instance, mock_artifact_loader | Verifies 0 image_generation_call items | Medium | Yes | Tests artifact type filtering | Document replayable types |
| TestMarkerBasedArtifactReplay::test_artifact_function_call_output_pruned_in_old_turn | Function_call_output artifacts in old turns are pruned when paired with function_call | Artifact pruning for old turns | transform_messages_to_input, artifact_loader, pruning_turns params | pipe_instance, mock_artifact_loader, MARKER constants | Verifies pruning marker present in output | High | Yes | Core pruning for replayed artifacts | Critical distinction from direct tools |
| TestMarkerBasedArtifactReplay::test_artifact_function_call_output_not_pruned_in_recent_turn | Function_call_output artifacts in recent turns are NOT pruned | Recent turn pruning exemption | transform_messages_to_input, artifact_loader, pruning_turns params | pipe_instance, mock_artifact_loader | Verifies no pruning marker | High | Yes | Tests turn recency check for pruning | None |
| TestMarkerBasedArtifactReplay::test_artifact_function_call_short_output_not_pruned | Short function_call_output artifacts are not pruned even in old turns | Minimum length check for artifact pruning | transform_messages_to_input, artifact_loader, pruning_turns params | pipe_instance, mock_artifact_loader | Verifies short output preserved | Medium | Yes | Tests length threshold for pruning | None |
| TestMarkerBasedArtifactReplay::test_artifact_function_call_with_matching_output | Function_call artifacts paired with output are replayed correctly | Function call + output pairing | transform_messages_to_input, artifact_loader param | pipe_instance, mock_artifact_loader | Verifies both function_call and output present with correct fields | Medium | Yes | Tests complete tool call replay | None |
| TestMarkerBasedArtifactReplay::test_multiple_markers_in_assistant | Multiple markers in one assistant message are all processed | Multi-marker message handling | transform_messages_to_input, artifact_loader param | pipe_instance, mock_artifact_loader, 2 markers | Verifies >=2 message results | Medium | Yes | Tests multiple artifact replay | None |
| TestMarkerBasedArtifactReplay::test_orphaned_function_call_output_skipped | Function_call_output without matching function_call is skipped | Output orphan detection (call_id mismatch) | transform_messages_to_input, artifact_loader param | pipe_instance, mock_artifact_loader | Verifies 0 function_call_output items | Medium | Yes | Tests orphan output filtering | None |
| TestMarkerBasedArtifactReplay::test_function_call_output_with_none_output | Function call output with None output is not pruned | None output handling in pruning logic | transform_messages_to_input, artifact_loader, pruning_turns params | pipe_instance, mock_artifact_loader | Verifies no pruning marker (None handled) | Low | Yes | Tests None output edge case | None |
| TestMarkerBasedArtifactReplay::test_text_segment_with_annotations | Text segment with annotations preserves them | Annotations preservation in segmented messages | transform_messages_to_input, artifact_loader param | pipe_instance, mock_artifact_loader | Verifies at least one message has annotations | Medium | Yes | Tests annotation propagation | None |
| TestMarkerBasedArtifactReplay::test_text_segment_with_reasoning_details | Text segment with reasoning_details preserves them | Reasoning_details preservation in segmented messages | transform_messages_to_input, artifact_loader param | pipe_instance, mock_artifact_loader | Verifies at least one message has reasoning_details | Medium | Yes | Tests reasoning_details propagation | None |
| TestToolCallArguments::test_tool_call_empty_string_arguments | Empty string arguments default to {} | Empty string argument normalization | transform_messages_to_input | pipe_instance | Verifies arguments="{}" | Low | Yes | Tests empty argument handling | None |
| TestToolCallArguments::test_tool_call_whitespace_arguments | Whitespace-only arguments default to {} | Whitespace argument normalization | transform_messages_to_input | pipe_instance | Verifies arguments="{}" | Low | Yes | Tests whitespace argument handling | None |
| TestToolCallArguments::test_tool_call_none_arguments | None arguments serialize to {} | None argument handling | transform_messages_to_input | pipe_instance | Verifies arguments="{}" | Low | Yes | Tests None argument handling | None |
| TestToolCallArguments::test_tool_call_non_serializable_arguments | Non-JSON-serializable arguments fall back to {} | Serialization failure fallback | transform_messages_to_input | pipe_instance, NonSerializable class | Verifies arguments="{}" | Low | Yes | Tests serialization error handling | None |
| TestToolCallArguments::test_tool_call_function_not_dict | Tool call with non-dict function is skipped | Function field type validation | transform_messages_to_input | pipe_instance | Verifies only 1 result (message, no function_call) | Low | Yes | Tests function field validation | None |
| TestToolCallArguments::test_tool_call_empty_name_skipped | Tool call with empty name is skipped | Function name validation (whitespace) | transform_messages_to_input | pipe_instance | Verifies only 1 result (message skipped) | Low | Yes | Tests empty name validation | None |
| TestToolCallArguments::test_tool_call_uses_call_id_field | Tool call prefers call_id field over id | call_id field priority | transform_messages_to_input | pipe_instance | Verifies call_id="call_from_call_id" | Low | Yes | Tests field priority for call_id | None |
| TestToolCallArguments::test_tool_call_type_none_accepted | Tool call with type=None is accepted (defaults to function) | None type defaults to function | transform_messages_to_input | pipe_instance | Verifies function_call present with name | Low | Yes | Tests type None acceptance | None |
| TestToolResponseSerialization::test_tool_response_list_content | Tool response with list content is JSON serialized | List content JSON serialization | transform_messages_to_input | pipe_instance | Verifies output='[1, 2, 3, "four"]' | Low | Yes | Tests list serialization | None |
| TestToolResponseSerialization::test_tool_response_non_serializable_content | Tool response with non-serializable content uses str() | Non-serializable fallback to str() | transform_messages_to_input | pipe_instance, NonSerializable class | Verifies output contains str representation | Low | Yes | Tests str() fallback | None |
| TestToolResponseSerialization::test_tool_response_integer_call_id_converted | Tool response with non-string call_id is handled | Non-string call_id validation | transform_messages_to_input | pipe_instance | Verifies result is empty (non-string skipped) | Low | Yes | Tests call_id type validation | None |
| TestImageProcessing::test_image_url_with_detail_auto | Image URL with detail=auto is preserved | detail field preservation for images | transform_messages_to_input | pipe_instance, ModelFamily mock, _inline_owui_file_id mock | Verifies detail="auto" | Low | Yes | Tests detail field pass-through | None |
| TestImageProcessing::test_image_url_with_detail_high | Image URL with detail=high is preserved | detail="high" preservation | transform_messages_to_input | pipe_instance, ModelFamily mock, _inline_owui_file_id mock | Verifies detail="high" | Low | Yes | Tests high detail mode | None |
| TestImageProcessing::test_image_url_string_format | Image URL as string (not dict) is handled | image_url as string extraction | transform_messages_to_input | pipe_instance, ModelFamily mock, _inline_owui_file_id mock | Verifies image block present | Low | Yes | Tests string URL format | None |
| TestImageProcessing::test_image_empty_url_returns_none | Image block with empty URL returns None (skipped) | Empty URL validation and skipping | transform_messages_to_input | pipe_instance, ModelFamily mock | Verifies 0 image blocks | Low | Yes | Tests empty URL filtering | None |
| TestAudioProcessingEdgeCases::test_audio_data_url_format | Audio data URL format is parsed correctly | Data URL parsing for audio | transform_messages_to_input | pipe_instance, sample_audio_base64 | Verifies type=input_audio, format=mp3 | Low | Yes | Tests data URL audio parsing | None |
| TestAudioProcessingEdgeCases::test_audio_with_wav_mime_type | Audio with audio/wav mime type maps to wav format | MIME type mapping (audio/wav -> wav) | transform_messages_to_input | pipe_instance, sample_audio_base64 | Verifies format="wav" | Low | Yes | Tests WAV MIME mapping | None |
| TestAudioProcessingEdgeCases::test_audio_with_mpeg_mime_type | Audio with audio/mpeg mime type maps to mp3 format | MIME type mapping (audio/mpeg -> mp3) | transform_messages_to_input | pipe_instance, sample_audio_base64 | Verifies format="mp3" | Low | Yes | Tests MPEG MIME mapping | None |
| TestAudioProcessingEdgeCases::test_audio_empty_payload | Empty audio payload returns empty block | None input_audio handling | transform_messages_to_input | pipe_instance | Verifies data="" | Low | Yes | Tests None audio payload | None |
| TestAudioProcessingEdgeCases::test_audio_unsupported_format_defaults_to_mp3 | Unknown audio format defaults to mp3 | Unsupported format fallback | transform_messages_to_input | pipe_instance, sample_audio_base64 | Verifies format="mp3" (ogg not supported) | Low | Yes | Tests format fallback | None |
| TestVideoProcessingEdgeCases::test_video_youtube_url_detected | YouTube URLs are detected and handled specially | YouTube URL detection logic | transform_messages_to_input | pipe_instance (_is_youtube_url mocked) | Verifies "youtube" in URL | Medium | Yes | Tests YouTube URL detection | None |
| TestVideoProcessingEdgeCases::test_video_owui_file_url_passthrough | OWUI file URLs pass through without SSRF checks | Internal URL exemption from SSRF | transform_messages_to_input | pipe_instance | Verifies internal URL preserved | Medium | Yes | Tests SSRF exemption for internal URLs | Security-relevant |
| TestMarkdownImageExtraction::test_markdown_image_extracted | Markdown images in assistant text are extracted | Markdown image URL extraction from text | transform_messages_to_input | pipe_instance | Verifies 1 result processed | Low | Yes | Tests markdown parsing | None |
| TestMarkdownImageExtraction::test_multiple_markdown_images | Multiple markdown images are extracted | Multiple markdown image handling | transform_messages_to_input | pipe_instance | Verifies 1 result | Low | Yes | Tests multi-image markdown | None |
| TestExceptionHandling::test_block_transformation_exception_caught | Exceptions during block transformation are caught and logged | Block transformation error resilience | transform_messages_to_input | pipe_instance, _inline_owui_file_id mock (raises), ModelFamily mock | Verifies result present, text blocks preserved | Medium | Yes | Tests exception handling in block processing | None |
| TestBlockTypeVariations::test_image_url_type_processed | image_url type is correctly processed | image_url type handling | transform_messages_to_input | pipe_instance, ModelFamily mock, _inline_owui_file_id mock, sample_image_base64 | Verifies 1 image block | Low | Yes | Tests image_url type | None |
| TestBlockTypeVariations::test_audio_type_variations | Different audio type names are handled | "audio" type handling (vs input_audio) | transform_messages_to_input | pipe_instance, sample_audio_base64 | Verifies 1 audio block | Low | Yes | Tests audio type variant | None |
| TestBlockTypeVariations::test_video_type_variations | Different video type names are handled | "video" type handling (vs video_url) | transform_messages_to_input | pipe_instance | Verifies 1 video block | Low | Yes | Tests video type variant | None |
| TestBlockTypeVariations::test_file_type_variations | Different file type names are handled | "file" type with nested structure | transform_messages_to_input | pipe_instance | Verifies 1 file block with correct file_id | Low | Yes | Tests file type variant | None |
| TestRemoteImageDownload::test_remote_image_https_url | Remote HTTPS image URL is downloaded when model supports vision | Remote image download integration | transform_messages_to_input | pipe_instance, ModelFamily mock, aioresponses HTTP mock, sample_image_base64 | Verifies 1 result, 1 image block with image_url | Medium | Yes | Tests remote image download | Integration with aiohttp |
| TestYouTubeVideo::test_youtube_standard_url | Standard YouTube URL is passed through | YouTube URL pass-through | transform_messages_to_input | pipe_instance | Verifies "youtube.com" in URL | Low | Yes | Tests YouTube standard URL | None |
| TestYouTubeVideo::test_youtube_short_url | YouTube short URL (youtu.be) is passed through | YouTube short URL handling | transform_messages_to_input | pipe_instance | Verifies "youtu.be" in URL | Low | Yes | Tests YouTube short URL | None |
| TestPruningEdgeCases::test_prune_dict_output_serialized | Dict output in function_call_output is JSON serialized before pruning | Dict output serialization in pruning path | transform_messages_to_input, artifact_loader, pruning_turns params | pipe_instance, mock_artifact_loader | Verifies pruning marker present (after serialization) | Medium | Yes | Tests dict serialization before pruning | None |
| TestAssistantContentEdgeCases::test_assistant_dict_content | Assistant message with dict content (unusual but possible) | Dict content handling for assistant | transform_messages_to_input | pipe_instance | Verifies 1 result | Low | Yes | Tests unusual dict content format | None |
| TestAssistantContentEdgeCases::test_assistant_none_content_with_tool_calls | Assistant with None content but valid tool_calls | None content with tool_calls present | transform_messages_to_input | pipe_instance | Verifies function_call present | Low | Yes | Tests None content + tool_calls | None |
| TestUserMessageContentTypes::test_user_list_content_with_dict_text_blocks | User message with list of dict text blocks | List of text block dicts | transform_messages_to_input | pipe_instance | Verifies 2 content blocks with correct text | Low | Yes | Tests list text block handling | None |
| TestUserMessageContentTypes::test_user_list_content_with_empty_blocks_filtered | User message with empty blocks in list are filtered | Empty block filtering in user content | transform_messages_to_input | pipe_instance | Verifies 2 content blocks (empty filtered) | Low | Yes | Tests empty block filtering | None |
| TestAnnotationsAndReasoning::test_assistant_annotations_preserved | Assistant message annotations are preserved in output | Annotations preservation | transform_messages_to_input | pipe_instance | Verifies annotations field present and correct | Low | Yes | Tests annotations pass-through | None |
| TestAnnotationsAndReasoning::test_assistant_reasoning_details_preserved | Assistant message reasoning_details are preserved in output | Reasoning_details preservation | transform_messages_to_input | pipe_instance | Verifies reasoning_details present | Low | Yes | Tests reasoning_details pass-through | None |
| TestAnnotationsAndReasoning::test_assistant_both_annotations_and_reasoning | Assistant message with both annotations and reasoning_details | Both fields present simultaneously | transform_messages_to_input | pipe_instance | Verifies both fields present | Low | Yes | Tests dual metadata preservation | None |
| TestMarkdownImagesNonString::test_assistant_non_string_content_for_markdown_extraction | Non-string content for markdown image extraction returns empty list | _markdown_images_from_text type validation | transform_messages_to_input | pipe_instance | Verifies result is list, no crash | Low | Yes | Tests non-string content robustness (line 183) | None |
| TestPruneToolOutputEdgeCases::test_prune_tool_output_none_output_value | Function call output with None output is not pruned | None output early return in _prune_tool_output | transform_messages_to_input, artifact_loader, pruning_turns params | pipe_instance, mock_artifact_loader | Verifies no pruning marker (line 210-211) | Low | Yes | Tests None output pruning bypass (line 211) | None |
| TestPruneToolOutputEdgeCases::test_prune_tool_output_non_serializable_object | Function call output with non-JSON-serializable object uses str() | str() fallback for non-serializable output | transform_messages_to_input, artifact_loader, pruning_turns params | pipe_instance, mock_artifact_loader, NonSerializable class | Verifies pruning marker present (lines 215-217) | Low | Yes | Tests serialization fallback in pruning (lines 213-217) | None |
| TestPruneToolOutputEdgeCases::test_prune_tool_output_removed_chars_zero_or_less | Pruning is skipped when removed_chars <= 0 | removed_chars calculation and threshold check | transform_messages_to_input, artifact_loader, pruning_turns params | pipe_instance, mock_artifact_loader | Verifies no pruning marker (line 228) | Low | Yes | Tests pruning skip when head+tail >= total (line 228) | None |
| TestRemoteImageFilenameExtension::test_remote_image_no_extension_in_url | Remote image URL without extension gets extension from mime type | Extension derivation from MIME type | transform_messages_to_input | pipe_instance, ModelFamily mock, _download_remote_url mock, _resolve_storage_context mock, sample_image_base64 | Verifies result present (lines 443-445) | Medium | Yes | Tests extension-less filename handling (lines 443-445) | None |
| TestRemoteImageDownloadFailure::test_remote_image_download_exception | Remote image download exception is caught and logged | Download exception handling | transform_messages_to_input | pipe_instance, ModelFamily mock, _download_remote_url mock (raises) | Verifies no exception, result present (lines 455-457) | Medium | Yes | Tests download exception resilience (lines 455-457) | None |
| TestFileDataUrlProcessing::test_file_data_url_saved_to_storage | File with data URL is saved to storage | file_data data URL storage path | transform_messages_to_input, chat_id param | pipe_instance (SAVE_FILE_DATA_CONTENT=True), storage mocks | Verifies file_id="stored-file-id-123" (lines 631-644) | High | Yes | Tests file data URL upload (lines 631-644) | Critical for file handling |
| TestFileDataUrlProcessing::test_file_data_url_exception_caught | File data URL processing exception is caught | Data URL exception handling | transform_messages_to_input | pipe_instance, _parse_data_url mock (raises), _emit_error mock | Verifies no exception (lines 645-651) | Medium | Yes | Tests data URL parse exception (lines 645-651) | None |
| TestFileRemoteUrlDownload::test_file_data_remote_url_download_success | Remote URL in file_data is downloaded and stored | file_data remote URL download and storage | transform_messages_to_input, chat_id param | pipe_instance (SAVE_FILE_DATA_CONTENT=True), storage mocks, download mock, sample_image_base64 | Verifies file_id="stored-remote-file-123" (lines 653-661) | High | Yes | Tests file_data remote download (lines 653-661) | Critical for remote files |
| TestFileRemoteUrlDownload::test_file_data_remote_url_download_fails_uses_url | Failed download falls back to using URL as-is | Download failure fallback to URL | transform_messages_to_input, event_emitter param | pipe_instance (SAVE_FILE_DATA_CONTENT=True), mock_download_fail, notification mock | Verifies file_url preserved (lines 662-678) | Medium | Yes | Tests download failure fallback (lines 662-678) | None |
| TestFileRemoteUrlDownload::test_file_data_remote_url_download_exception | Remote URL download exception is caught | Remote download exception handling | transform_messages_to_input | pipe_instance (SAVE_FILE_DATA_CONTENT=True), download mock (raises), _emit_error mock | Verifies no exception (lines 679-685) | Medium | Yes | Tests download exception handling (lines 679-685) | None |
| TestFileUrlProcessing::test_file_url_data_url_saved | Data URL in file_url is saved to storage | file_url data URL storage | transform_messages_to_input, chat_id param | pipe_instance (SAVE_REMOTE_FILE_URLS=True), storage mocks, sample_image_base64 | Verifies file_id, file_url=None (lines 693-706) | High | Yes | Tests file_url data URL upload (lines 693-706) | Critical for file_url handling |
| TestFileUrlProcessing::test_file_url_data_url_exception | Data URL in file_url exception is caught | file_url data URL exception handling | transform_messages_to_input | pipe_instance (SAVE_REMOTE_FILE_URLS=True), _parse_data_url mock (raises) | Verifies no exception (lines 707-713) | Medium | Yes | Tests file_url parse exception (lines 707-713) | None |
| TestFileUrlProcessing::test_file_url_remote_download_success | Remote file_url is downloaded and stored | file_url remote download and storage | transform_messages_to_input, chat_id param | pipe_instance (SAVE_REMOTE_FILE_URLS=True), storage mocks, download mock, sample_image_base64 | Verifies file_id="stored-url-file" (lines 714-720) | High | Yes | Tests file_url remote download (lines 714-720) | Critical for remote file_url |
| TestFileUrlProcessing::test_file_url_remote_download_fails_with_fallback_label | Failed file_url download uses URL host as label | Download failure with host label fallback | transform_messages_to_input, event_emitter param | pipe_instance (SAVE_REMOTE_FILE_URLS=True), mock_download_fail, notification mock | Verifies file_url preserved (lines 721-733) | Medium | Yes | Tests host label fallback (lines 721-733) | None |
| TestFileUrlProcessing::test_file_url_remote_download_exception | Remote file_url download exception is caught | file_url download exception handling | transform_messages_to_input | pipe_instance (SAVE_REMOTE_FILE_URLS=True), download mock (raises), _emit_error mock | Verifies no exception (lines 734-740) | Medium | Yes | Tests file_url exception handling (lines 734-740) | None |
| TestFileDataRemainsAfterProcessing::test_file_data_preserved_when_not_processed | file_data is preserved in result when not saved to storage | file_data preservation when SAVE_FILE_DATA_CONTENT=False | transform_messages_to_input | pipe_instance (SAVE_FILE_DATA_CONTENT=False) | Verifies file_data preserved (line 744-745) | Medium | Yes | Tests file_data pass-through (line 745) | None |
| TestFileProcessingException::test_file_block_exception_returns_minimal_block | Exception in file processing returns minimal block | _to_input_file outer exception handler | transform_messages_to_input | pipe_instance, _resolve_storage_context mock (raises), _emit_error mock | Verifies result present (lines 753-760) | Medium | Yes | Tests _to_input_file exception handling (lines 753-760) | None |
| TestAudioProcessingEdgeCasesExtended::test_audio_dict_data_only_invalid_base64 | Audio dict with only data field containing invalid base64 | Invalid base64 handling in dict data path | transform_messages_to_input | pipe_instance | Verifies data="" (lines 902-909) | Low | Yes | Tests dict invalid base64 (lines 903-909) | None |
| TestAudioProcessingEdgeCasesExtended::test_audio_data_url_non_audio_mime | Audio data URL with non-audio mime type is rejected | Non-audio MIME type rejection | transform_messages_to_input | pipe_instance, sample_audio_base64 | Verifies data="" (lines 928-935) | Low | Yes | Tests MIME type validation (lines 929-935) | None |
| TestAudioProcessingEdgeCasesExtended::test_audio_data_url_size_validation_fails | Audio data URL failing size validation returns empty block | Size validation for audio data URLs | transform_messages_to_input | pipe_instance, _validate_base64_size mock | Verifies data="" (line 936-937) | Low | Yes | Tests size validation failure (line 937) | None |
| TestVideoSSRFProtection::test_video_ssrf_blocked_private_ip | Video URL to private IP is blocked by SSRF protection | SSRF protection for video URLs | transform_messages_to_input | pipe_instance, _is_safe_url mock (returns False), _emit_error mock | Verifies url="" (lines 1057-1064) | High | Yes | Tests video SSRF protection (lines 1057-1064) | Security-critical |
| TestVideoProcessingException::test_video_processing_exception_caught | Exception in video processing returns empty block | Video processing exception handling | transform_messages_to_input | pipe_instance, _is_youtube_url mock (raises), _emit_error mock | Verifies url="" (lines 1085-1092) | Medium | Yes | Tests video exception resilience (lines 1085-1092) | None |
| TestBlockTransformationException::test_non_image_block_exception_preserves_block | Non-image block transformation exception preserves original block | Block exception handling for non-image types | transform_messages_to_input | pipe_instance, _validate_base64_size mock (raises), _emit_error mock | Verifies >=1 content block (lines 1159-1160) | Medium | Yes | Tests non-image exception handling (lines 1159-1160) | None |
| TestAssistantImageFallbackException::test_assistant_image_fallback_exception_logged | Exception during assistant image fallback is logged | Assistant image fallback exception handling | transform_messages_to_input | pipe_instance (IMAGE_INPUT_SELECTION="user_then_assistant"), ModelFamily mock, _inline_owui_file_id mock (raises) | Verifies user message present (lines 1176-1177) | Medium | Yes | Tests fallback exception logging (lines 1176-1177) | None |
| TestVisionWarningAfterSkip::test_vision_warning_emitted_after_skipping | Vision warning is emitted after skipping all images | Vision capability warning emission | transform_messages_to_input, model_id, event_emitter params | pipe_instance, ModelFamily mock (no vision), _emit_status mock | Verifies warning message emitted (lines 1194-1204) | Medium | Yes | Tests vision warning emission (line 1200) | User feedback critical |
| TestStorageContextNoUpload::test_save_bytes_no_storage_context | _save_bytes_to_storage returns None when no storage context | Storage context None handling | transform_messages_to_input, chat_id param | pipe_instance (SAVE_FILE_DATA_CONTENT=True), _resolve_storage_context mock (returns None, None) | Verifies file block present (line 566-567) | Medium | Yes | Tests no-storage fallback (lines 566-567) | None |
| TestFilenameExtensionFromMime::test_filename_without_extension_gets_extension | Filename without extension gets extension from mime type | Extension derivation from MIME type for filenames | transform_messages_to_input, chat_id param | pipe_instance (SAVE_FILE_DATA_CONTENT=True), storage mocks, sample_image_base64 | Verifies filename ends with .pdf (lines 570-572) | Medium | Yes | Tests extension addition (lines 570-572) | None |
| TestImageStorageUpload::test_base64_image_uploaded_to_storage | Base64 image is uploaded to OWUI storage | Base64 image upload path | transform_messages_to_input, chat_id param | pipe_instance, ModelFamily mock, storage mocks, sample_image_base64 | Verifies upload called, image block present (lines 417-429) | High | Yes | Tests image upload integration (lines 403-415, 418-432) | Critical for image handling |
| TestImageStorageUpload::test_base64_image_upload_exception_caught | Exception during base64 image upload is caught | Image upload exception handling | transform_messages_to_input | pipe_instance, ModelFamily mock, storage mocks, _upload_to_owui_storage mock (raises) | Verifies no exception, result present (lines 430-436) | Medium | Yes | Tests upload exception resilience (lines 430-436) | None |
| TestImageStorageUpload::test_remote_image_uploaded_to_storage | Remote image is downloaded and uploaded to storage | Remote image download + upload path | transform_messages_to_input, chat_id param | pipe_instance, ModelFamily mock, storage mocks, download mock, sample_image_base64 | Verifies upload called (lines 438-454) | High | Yes | Tests remote image upload (lines 438-454) | Critical for remote images |
| TestImageInliningFailure::test_image_inline_returns_none_skips_image | Image block is skipped when inline returns None | None return from _inline_owui_file_id handling | transform_messages_to_input, event_emitter param | pipe_instance, ModelFamily mock, _inline_owui_file_id mock (returns None), _emit_status mock | Verifies 0 image blocks, status message (lines 471-477) | Medium | Yes | Tests file unavailable handling (lines 471-477) | User feedback important |
| TestVideoBase64StatusEmission::test_video_base64_emits_status | Video with valid base64 data URL emits status | Video base64 status emission | transform_messages_to_input, event_emitter param | pipe_instance, _emit_status mock | Verifies video URL preserved (line 1043-1047) | Low | Yes | Tests status emission (line 1043) | None |
| TestFileLabelFallbackHost::test_file_data_url_fallback_uses_host_when_no_filename | When filename is empty, use URL host as label | Host-based label fallback for file_data | transform_messages_to_input, event_emitter param | pipe_instance (SAVE_FILE_DATA_CONTENT=True), storage mocks, download mock (fails), notification mock | Verifies result present (lines 668-672) | Low | Yes | Tests host label fallback (lines 669-672) | None |
| TestFileLabelFallbackHost::test_file_url_fallback_uses_host_when_name_empty | When name_hint is empty, use URL host as label | Host-based label fallback for file_url | transform_messages_to_input, event_emitter param | pipe_instance (SAVE_REMOTE_FILE_URLS=True), storage mocks, download mock (fails), notification mock | Verifies result present (lines 724-728) | Low | Yes | Tests host label fallback (lines 725-728) | None |
| TestFileOuterException::test_file_outer_exception_returns_minimal_block | Outer exception in _to_input_file returns minimal block | _to_input_file outer exception handler | transform_messages_to_input | pipe_instance, _emit_error mock | Verifies result present (lines 753-760) | Low | Yes | Tests outer exception handling (lines 753-760) | Duplicate of TestFileProcessingException |
| TestAudioBase64SizeValidation::test_audio_base64_size_validation_in_normalize | Audio base64 that fails size validation in _normalize_base64 | Size validation in _normalize_base64 path | transform_messages_to_input | pipe_instance, _validate_base64_size mock (returns False), sample_audio_base64 | Verifies data="" (lines 831-832) | Low | Yes | Tests _normalize_base64 validation (lines 831-832) | None |
| TestBlockTransformExceptionNonImage::test_file_block_exception_preserves_original | File block exception preserves original block | File block exception preservation | transform_messages_to_input | pipe_instance, _resolve_storage_context mock (raises), _emit_error mock | Verifies >=1 content block (lines 1159-1160) | Low | Yes | Tests file block exception (lines 1159-1160) | None |
| TestVisionWarningLatestUserMessage::test_vision_warning_final_path | Vision warning emitted in final check | Vision warning final emission path | transform_messages_to_input, model_id, event_emitter params | pipe_instance (MAX_INPUT_IMAGES_PER_REQUEST=0), ModelFamily mock (no vision), _emit_status mock | Verifies warning message emitted (lines 1194-1204) | Medium | Yes | Tests vision warning final path (line 1200) | None |


## `tests/test_responses.py`

| Test Name | Description | What It Tests | Code Under Test | Mocks/Fixtures | Assertions | Drift Risk | Check Done | Codex Notes | Codex TODO |
|-----------|-------------|---------------|-----------------|----------------|------------|------------|------------|-------------|------------|
| test_pipe_creates_responses_adapter | Test that Pipe lazily creates ResponsesAdapter | Lazy initialization of ResponsesAdapter, singleton pattern | Pipe._ensure_responses_adapter(), ResponsesAdapter initialization | pipe_instance | Adapter is None initially, created on first call, returns same instance on second call | LOW | YES | Tests lazy initialization pattern for adapter | None |
| test_responses_streaming_simple_text | Test simple streaming text response from /responses endpoint | Basic streaming SSE parsing, text delta events, completion event | ResponsesAdapter streaming, send_openai_responses_streaming_request | pipe_instance_async, aioresponses | Has text deltas >= 1, has completed event == 1 | MEDIUM | YES | Basic happy path for streaming responses | Add coverage for more event types |
| test_responses_streaming_with_passthrough_deltas | Test streaming with passthrough deltas (no batching) | Delta passthrough mode when delta_char_limit=0 | ResponsesAdapter delta batching logic (lines 280-292) | pipe_instance_async, aioresponses | Exactly 3 separate delta events when passthrough enabled | MEDIUM | YES | Tests delta_char_limit=0 disables batching | None |
| test_responses_streaming_with_delta_batching | Test streaming with delta batching enabled | Delta batching reduces number of events when threshold set | ResponsesAdapter delta batching logic (lines 280-292) | pipe_instance_async, aioresponses | Number of delta events < 11 (fewer than input chars) | MEDIUM | YES | Tests delta batching with threshold=5 reduces events | None |
| test_responses_streaming_error_400 | Test error handling for 400 Bad Request | Error parsing and OpenRouterAPIError raising for 400 | ResponsesAdapter error handling (lines 122-147) | pipe_instance_async, aioresponses (400 response) | Raises OpenRouterAPIError with status 400 | LOW | YES | Tests 400 error path in streaming | None |
| test_responses_streaming_error_401_auth_failure | Test 401 Unauthorized triggers auth failure notification | Auth failure detection and notification for 401 | ResponsesAdapter auth failure logic (lines 206-216) | pipe_instance_async, aioresponses (401 response) | Raises OpenRouterAPIError with status 401 | LOW | YES | Tests 401 auth failure path | None |
| test_responses_streaming_error_403_forbidden | Test 403 Forbidden triggers auth failure notification | Auth failure detection and notification for 403 | ResponsesAdapter auth failure logic (lines 206-216) | pipe_instance_async, aioresponses (403 response) | Raises OpenRouterAPIError with status 403 | LOW | YES | Tests 403 forbidden path | None |
| test_responses_streaming_error_429_rate_limit_with_headers | Test 429 Rate Limit with Retry-After header | Rate limit error handling and header extraction | ResponsesAdapter rate limit handling (lines 126-145) | pipe_instance_async, aioresponses (429 with headers) | Raises OpenRouterAPIError with status 429, metadata has retry_after | MEDIUM | YES | Tests rate limit header parsing | Verify all rate limit header variants |
| test_responses_streaming_error_402_insufficient_credits | Test 402 Payment Required (insufficient credits) | Insufficient credits error handling | ResponsesAdapter error handling for 402 | pipe_instance_async, aioresponses (402 response) | Raises OpenRouterAPIError with status 402 | LOW | YES | Tests 402 payment required path | None |
| test_responses_streaming_error_408_timeout | Test 408 Request Timeout | Request timeout error handling | ResponsesAdapter error handling for 408 | pipe_instance_async, aioresponses (408 response) | Raises OpenRouterAPIError with status 408 | LOW | YES | Tests 408 timeout path | None |
| test_responses_streaming_error_4xx_non_special | Test generic 4xx error | Non-special status code error handling (lines 146-149) | ResponsesAdapter generic 4xx error path | pipe_instance_async, aioresponses (404 response) | Raises RuntimeError containing "404" | LOW | YES | Tests fallback for non-special 4xx errors | None |
| test_responses_streaming_breaker_open_at_start | Test breaker open check at start of stream | Circuit breaker prevents request when open (line 112) | ResponsesAdapter breaker check at stream start | pipe_instance_async, aioresponses, forced breaker failures | Raises RuntimeError with "Breaker open" message | MEDIUM | YES | Tests circuit breaker integration at stream start | Verify breaker state reset |
| test_responses_streaming_empty_data_blob_skipped | Test that empty data blobs are skipped | SSE parsing skips empty data lines (line 178-179) | ResponsesAdapter SSE parser empty line handling | pipe_instance_async, aioresponses | Has text delta and completed events (empty lines skipped) | LOW | YES | Tests SSE empty data line filtering | None |
| test_responses_streaming_comment_lines_skipped | Test that SSE comment lines (starting with :) are skipped | SSE comment line filtering (line 190-191) | ResponsesAdapter SSE parser comment handling | pipe_instance_async, aioresponses | Has text delta event (comments ignored) | LOW | YES | Tests SSE comment line filtering | None |
| test_responses_streaming_trailing_data_after_done | Test handling leftover data after [DONE] | Producer stops after [DONE] marker (lines 200-205) | ResponsesAdapter [DONE] termination logic | pipe_instance_async, aioresponses | At least 2 events received | LOW | YES | Tests stream termination at [DONE] | None |
| test_responses_streaming_worker_handles_done_marker | Test that worker handles [DONE] marker in data lines | Worker skips [DONE] marker events (line 248-249) | ResponsesAdapter worker DONE handling | pipe_instance_async, aioresponses, workers=1 | Has at least 1 text delta event | LOW | YES | Tests worker-level [DONE] handling | None |
| test_responses_streaming_queue_backlog_warning | Test event queue backlog warning | Queue backlog warning logic (lines 324-335) | ResponsesAdapter queue monitoring | pipe_instance_async, aioresponses, event_queue_warn_size=10 | Stream completes successfully with completed event | LOW | YES | Tests queue backlog warning path with many events | None |
| test_responses_streaming_null_event_skipped | Test that null events are skipped | Null event filtering (lines 342-344) | ResponsesAdapter null event handling | pipe_instance_async, aioresponses | At least 2 events without null issues | LOW | YES | Tests null event filtering logic | None |
| test_responses_streaming_non_delta_events_yielded | Test that non-delta events are yielded directly | Non-delta event passthrough (lines 371-381) | ResponsesAdapter non-delta event handling | pipe_instance_async, aioresponses | Has function call events >= 1 | MEDIUM | YES | Tests function call and other non-delta events | Verify all event types |
| test_responses_streaming_final_delta_flush | Test final delta flush at end of stream | Buffered deltas flushed at end (lines 383-385) | ResponsesAdapter final flush logic | pipe_instance_async, aioresponses, delta_char_limit=100 | Has completed event (buffered content flushed) | MEDIUM | YES | Tests final flush of buffered deltas | None |
| test_responses_nonstreaming_simple | Test non-streaming responses request | Basic non-streaming request/response (lines 411-484) | ResponsesAdapter non-streaming handler | pipe_instance_async, aioresponses | Response id, output, and usage tokens correct | MEDIUM | YES | Tests non-streaming happy path | None |
| test_responses_nonstreaming_error_429_with_headers | Test non-streaming 429 error with rate limit headers | Rate limit error and header parsing for non-streaming (lines 453-477) | ResponsesAdapter non-streaming rate limit handling | pipe_instance_async, aioresponses (429 with headers) | Raises OpenRouterAPIError with status 429, metadata has retry_after | MEDIUM | YES | Tests non-streaming rate limit handling | None |
| test_responses_nonstreaming_error_4xx_generic | Test non-streaming generic 4xx error | Non-special 4xx error handling for non-streaming (lines 478-480) | ResponsesAdapter non-streaming error path | pipe_instance_async, aioresponses (404 response) | Raises RuntimeError containing "404" | LOW | YES | Tests non-streaming generic 4xx fallback | None |
| test_responses_nonstreaming_breaker_open | Test non-streaming breaker open check | Circuit breaker prevents non-streaming request when open (line 449) | ResponsesAdapter non-streaming breaker check | pipe_instance_async, aioresponses, forced breaker failures | Raises RuntimeError with "Breaker open" message | MEDIUM | YES | Tests circuit breaker integration for non-streaming | None |
| test_responses_nonstreaming_error_400 | Test non-streaming 400 error (special status) | 400 error handling for non-streaming | ResponsesAdapter non-streaming error handling | pipe_instance_async, aioresponses (400 response) | Raises OpenRouterAPIError with status 400 | LOW | YES | Tests non-streaming 400 error path | None |
| test_responses_nonstreaming_error_401 | Test non-streaming 401 error (special status) | 401 error handling for non-streaming | ResponsesAdapter non-streaming error handling | pipe_instance_async, aioresponses (401 response) | Raises OpenRouterAPIError with status 401 | LOW | YES | Tests non-streaming 401 error path | None |
| test_responses_nonstreaming_error_402 | Test non-streaming 402 error (special status) | 402 error handling for non-streaming | ResponsesAdapter non-streaming error handling | pipe_instance_async, aioresponses (402 response) | Raises OpenRouterAPIError with status 402 | LOW | YES | Tests non-streaming 402 error path | None |
| test_responses_nonstreaming_error_408 | Test non-streaming 408 error (special status) | 408 error handling for non-streaming | ResponsesAdapter non-streaming error handling | pipe_instance_async, aioresponses (408 response) | Raises OpenRouterAPIError with status 408 | LOW | YES | Tests non-streaming 408 error path | None |
| test_responses_streaming_idle_flush_timeout | Test idle flush when timeout occurs | Idle flush timeout logic (lines 304-318) | ResponsesAdapter idle flush handling | pipe_instance_async, aioresponses, delta_char_limit=100, idle_flush_ms=1 | Stream completes successfully with completed event | MEDIUM | YES | Tests idle flush timeout path (hard to trigger) | Consider async timing tests |
| test_responses_streaming_multiline_data | Test handling of multi-line data blobs | Multi-line JSON in SSE data | ResponsesAdapter SSE parser | pipe_instance_async, aioresponses | Text deltas contain newlines | LOW | YES | Tests multi-line content in SSE events | None |
| test_responses_streaming_records_failure_with_breaker_key | Test that failures are recorded when breaker_key is provided | Failure recording for circuit breaker (lines 123-124, 223-224) | ResponsesAdapter failure recording | pipe_instance_async, aioresponses (500 error), breaker_key | Exception raised and failure recorded | MEDIUM | YES | Tests circuit breaker failure recording for streaming | None |
| test_responses_nonstreaming_records_failure_with_breaker_key | Test that non-streaming failures are recorded when breaker_key is provided | Failure recording for non-streaming circuit breaker (lines 454-455) | ResponsesAdapter non-streaming failure recording | pipe_instance_async, aioresponses (400 error), breaker_key | Exception raised and failure recorded | MEDIUM | YES | Tests circuit breaker failure recording for non-streaming | None |
| test_responses_streaming_multiple_workers | Test streaming with multiple workers configured | Multi-worker streaming setup | ResponsesAdapter worker pool | pipe_instance_async, aioresponses, workers=4 | Stream completes successfully with completed event | MEDIUM | YES | Tests multiple workers configuration | Verify worker task lifecycle |
| test_responses_streaming_reasoning_events | Test streaming with reasoning/thinking events | Reasoning event handling for o1-style models | ResponsesAdapter reasoning event passthrough | pipe_instance_async, aioresponses | Has reasoning events >= 1 | MEDIUM | YES | Tests reasoning/thinking event support | Verify o1 compatibility |
| test_responses_streaming_error_event_in_stream | Test that error events in stream trigger error handling | Mid-stream error event handling (line 351) | ResponsesAdapter error event detection | pipe_instance_async, aioresponses | Events collected or error raised | MEDIUM | YES | Tests error events within SSE stream | None |
| test_responses_streaming_done_marker | Test that [DONE] marker terminates stream | [DONE] marker terminates producer (lines 180-183) | ResponsesAdapter [DONE] termination | pipe_instance_async, aioresponses | Events after [DONE] not included | LOW | YES | Tests [DONE] terminates stream before subsequent events | None |
| test_from_completions_maps_response_format_to_text_format | Structured output config must map onto Responses text.format | CompletionsBody to ResponsesBody conversion for structured output | ResponsesBody.from_completions, response_format mapping | minimal_pipe | responses.text has format with json_schema | HIGH | YES | Tests response_format -> text.format mapping | Verify all format types |
| test_from_completions_preserves_parallel_tool_calls | parallel_tool_calls must remain set so routing can respect it | parallel_tool_calls preservation in conversion | ResponsesBody.from_completions | minimal_pipe | responses.parallel_tool_calls is False | MEDIUM | YES | Tests parallel_tool_calls parameter preservation | None |
| test_from_completions_converts_legacy_function_call_dict | Legacy function_call dicts should map to tool_choice automatically | Legacy function_call dict to tool_choice conversion | ResponsesBody.from_completions, legacy parameter mapping | minimal_pipe | responses.tool_choice has function type and name | HIGH | YES | Tests legacy function_call dict conversion | Verify all legacy formats |
| test_from_completions_converts_legacy_function_call_strings | Legacy function_call strings like 'none' should pass through unchanged | Legacy function_call string passthrough | ResponsesBody.from_completions | minimal_pipe | responses.tool_choice == "none" | MEDIUM | YES | Tests legacy function_call string handling | None |
| test_from_completions_preserves_chat_completion_only_params | Chat-only parameters must survive ResponsesBody conversion so /chat/completions fallback can use them | Chat-specific parameter preservation for fallback | ResponsesBody.from_completions | minimal_pipe | stop, seed, top_logprobs, logprobs, frequency_penalty preserved with type coercion | HIGH | YES | Tests parameter preservation and type conversion for fallback | Verify all chat-only params |
| test_from_completions_does_not_override_explicit_tool_choice | Explicit tool_choice should not be overridden by legacy function_call | tool_choice priority over function_call | ResponsesBody.from_completions | minimal_pipe | responses.tool_choice == "auto" (not overridden) | MEDIUM | YES | Tests tool_choice takes precedence over legacy | None |
| test_auto_context_trimming_enabled_by_default | Test auto context trimming is enabled by default | Default transforms configuration | Pipe._apply_context_transforms | minimal_pipe | responses.transforms == ["middle-out"] | MEDIUM | YES | Tests default auto context trimming behavior | None |
| test_auto_context_trimming_respects_explicit_transforms | Test auto context trimming respects explicit transforms | Explicit transforms override defaults | Pipe._apply_context_transforms | minimal_pipe | responses.transforms == ["custom"] (not overridden) | MEDIUM | YES | Tests explicit transforms not overridden | None |
| test_auto_context_trimming_disabled_via_valve | Test auto context trimming can be disabled via valve | AUTO_CONTEXT_TRIMMING valve control | Pipe._apply_context_transforms | minimal_pipe, valves with AUTO_CONTEXT_TRIMMING=False | responses.transforms is None | MEDIUM | YES | Tests valve disables auto context trimming | None |
| test_sanitize_request_input_strips_function_call_and_output_extras | Test sanitization removes extra fields from function_call and function_call_output | Input sanitization for function calls and outputs | Pipe._sanitize_request_input | pipe_instance | id, status removed; arguments/output serialized to JSON strings | HIGH | YES | Tests input sanitization removes OWUI-specific fields | Verify all field types |
| test_sanitize_request_input_falls_back_to_id_as_call_id | Test sanitization uses id as call_id fallback when call_id missing | call_id fallback logic in sanitization | Pipe._sanitize_request_input | pipe_instance | call_id set from id field when missing | MEDIUM | YES | Tests fallback logic for call_id field | None |


## `tests/test_search.py`

| Test Name | Description | What It Tests | Code Under Test | Mocks/Fixtures | Assertions | Drift Risk | Check Done | Codex Notes | Codex TODO |
|-----------|-------------|---------------|-----------------|----------------|------------|------------|------------|-------------|------------|
| `test_auto_default_openrouter_search_seeds_default_filter_once` | Tests that auto-default OpenRouter search filter is seeded exactly once | Verifies that when auto_default_filter=True, the openrouter_search filter is added to both filterIds and defaultFilterIds, and a metadata flag marks it as seeded | `Pipe._update_or_insert_model_with_metadata()` | `pipe_instance` fixture, `Models.get_model_by_id` patched to return empty meta model, `Models.update_model_by_id` mocked, `ModelForm` patched | Asserts update_mock called once, filterIds contains "openrouter_search", defaultFilterIds contains "openrouter_search", openrouter_search_default_seeded is True, openrouter_search_filter_id equals "openrouter_search" | HIGH - OpenRouter API changes to search feature flags or filter attachment behavior could break this | YES | Tests initial seeding of search filter when model has no existing metadata | Verify OpenRouter search filter registration and Open-WebUI filter API remain compatible |
| `test_auto_default_openrouter_search_respects_operator_disabling_default` | Tests that operator's manual removal of default filter is respected | Verifies that when operator has already seeded the default but later removed it from defaultFilterIds, the pipe does not re-add it (respects user choice) | `Pipe._update_or_insert_model_with_metadata()` | `pipe_instance` fixture, `Models.get_model_by_id` patched to return model with filterIds but empty defaultFilterIds and seeded flag, `Models.update_model_by_id` mocked, `ModelForm` patched | Asserts update_mock.call_count equals 0 (no update performed) | MEDIUM - Operator override logic must remain stable | YES | Tests idempotency and respects operator's manual configuration changes | Document this behavior for operators; ensure upgrade paths preserve this |
| `test_auto_attach_removes_filter_from_unsupported_models_but_preserves_default_ids` | Tests that filter is removed from unsupported models while preserving defaultFilterIds | Verifies that when filter_supported=False, the filter is removed from filterIds but defaultFilterIds is preserved (likely for re-attachment if support is restored) | `Pipe._update_or_insert_model_with_metadata()` | `pipe_instance` fixture, `Models.get_model_by_id` patched to return model with both filterIds and defaultFilterIds set, `Models.update_model_by_id` mocked, `ModelForm` patched | Asserts update_mock called once, filterIds is empty list, defaultFilterIds still contains "openrouter_search" | MEDIUM - OpenRouter model capability changes affecting search support | YES | Tests graceful degradation when search is not supported by model | Verify OpenRouter model capabilities API for search support detection |
| `test_disable_openrouter_search_auto_attach_prevents_filter_and_default_updates` | Tests that disable_openrouter_search_auto_attach parameter prevents all filter updates | Verifies that when model params contain disable_openrouter_search_auto_attach=True, no metadata updates occur even with auto_attach_filter=True and auto_default_filter=True | `Pipe._update_or_insert_model_with_metadata()` | `pipe_instance` fixture, `Models.get_model_by_id` patched to return model with disable flag in params, `Models.update_model_by_id` mocked, `ModelForm` patched | Asserts update_mock.call_count equals 0 | LOW - Model params schema is stable | YES | Tests per-model override to disable auto-attachment entirely | Document this parameter for operators who want manual control |
| `test_disable_openrouter_search_default_on_skips_default_filter_ids` | Tests that disable_openrouter_search_default_on parameter prevents defaultFilterIds updates | Verifies that when model params contain disable_openrouter_search_default_on=True, filter is added to filterIds but not defaultFilterIds | `Pipe._update_or_insert_model_with_metadata()` | `pipe_instance` fixture, `Models.get_model_by_id` patched to return model with disable flag in params, `Models.update_model_by_id` mocked, `ModelForm` patched | Asserts update_mock called once, filterIds contains "openrouter_search", defaultFilterIds not in meta | LOW - Model params schema is stable | YES | Tests per-model override to attach filter but not as default | Document this parameter for operators who want filter available but not on by default |
| `test_search_toggle_sets_features_and_metadata_marker` | Tests that openrouter_search_toggle filter sets web_search feature flag and metadata marker | Verifies that the Filter.inlet() method disables web_search and sets a metadata marker flag | `Filter.inlet()` from `filters.openrouter_search_toggle` | None (direct instantiation) | Asserts result["features"]["web_search"] is False, metadata["features"] is not the same object as input features (copied), metadata["features"][_FEATURE_FLAG] is True | MEDIUM - Open-WebUI features schema changes | YES | Tests filter inlet that toggles native web search off and marks metadata | Verify Open-WebUI features API and metadata handling remain compatible |
| `test_search_toggle_skips_when_metadata_invalid` | Tests that filter gracefully handles invalid metadata | Verifies that when metadata is not a dict (e.g., a string), the filter returns body unchanged | `Filter.inlet()` from `filters.openrouter_search_toggle` | None (direct instantiation) | Asserts result is body (same object), "features" not in result | LOW - Defensive programming pattern | YES | Tests error handling for malformed metadata input | Ensure all filters have similar defensive checks |
| `test_disable_native_websearch_removes_web_plugin` | Tests that disable_native_websearch flag removes web plugin from plugins list | Verifies that when disable_native_websearch=True, the web plugin is filtered out and the flag is removed from payload | `_apply_disable_native_websearch_to_payload()` | None (direct function call) | Asserts plugins list contains only non-web plugins, disable_native_websearch key removed from payload | MEDIUM - OpenRouter plugins API schema changes | YES | Tests payload transformation to disable native web search | Verify OpenRouter plugins API and web plugin identifier remain stable |
| `test_disable_native_websearch_removes_plugins_key_when_empty` | Tests that plugins key is removed when last plugin is web plugin | Verifies that when only web plugin exists and is removed, the entire plugins key is removed from payload (cleaner payload) | `_apply_disable_native_websearch_to_payload()` | None (direct function call) | Asserts "plugins" not in payload, "disable_native_websearch" not in payload | LOW - Payload cleaning logic is internal | YES | Tests payload cleanup when no plugins remain after filtering | Consider edge cases with empty plugins list |
| `test_disable_native_websearch_false_keeps_web_plugin` | Tests that disable_native_websearch=False preserves web plugin | Verifies that when flag is explicitly False, web plugin is kept and flag is removed from payload | `_apply_disable_native_websearch_to_payload()` | None (direct function call) | Asserts plugins list still contains web plugin, disable_native_websearch key removed | LOW - Boolean flag handling | YES | Tests no-op case when feature is disabled | Ensure string "false" vs boolean False handling is consistent |
| `test_disable_native_websearch_removes_web_search_options_alias_key` | Tests that disable flag also removes web_search_options key | Verifies that when using disable_native_web_search alias, both the flag and web_search_options are removed from payload | `_apply_disable_native_websearch_to_payload()` | None (direct function call) | Asserts "web_search_options" not in payload, "disable_native_web_search" not in payload | LOW - Alias handling is internal | YES | Tests alias handling and related key cleanup | Document all supported aliases for this feature flag |


## `tests/test_security_methods.py`

| Test Name | Description | What It Tests | Code Under Test | Mocks/Fixtures | Assertions | Drift Risk | Check Done | Codex Notes | Codex TODO |
|-----------|-------------|---------------|-----------------|----------------|------------|------------|------------|-------------|------------|
| test_is_safe_url_allows_public_ips | Publicly routable addresses should pass the SSRF guard | Validates that public IP addresses (e.g., 8.8.8.8) are allowed through SSRF protection | `Pipe._is_safe_url()` | `pipe_instance_async`, monkeypatch on `socket.getaddrinfo` returning 8.8.8.8 | `assert await pipe_instance_async._is_safe_url("https://example.com/image.jpg") is True` | Low - core SSRF validation logic | Yes | Tests positive case for public IP allowlisting | None |
| test_is_safe_url_blocks_private_ranges[10.0.0.1] | Private, loopback, link-local, multicast, and unique-local ranges must be rejected | Validates SSRF protection blocks private Class A addresses (10.x.x.x) | `Pipe._is_safe_url()` | `pipe_instance_async`, monkeypatch on `socket.getaddrinfo` returning 10.0.0.1 | `assert await pipe_instance_async._is_safe_url("https://example.com/resource") is False` | Low - fundamental security guard | Yes | Tests RFC 1918 private range blocking | None |
| test_is_safe_url_blocks_private_ranges[192.168.1.1] | Private, loopback, link-local, multicast, and unique-local ranges must be rejected | Validates SSRF protection blocks private Class C addresses (192.168.x.x) | `Pipe._is_safe_url()` | `pipe_instance_async`, monkeypatch on `socket.getaddrinfo` returning 192.168.1.1 | `assert await pipe_instance_async._is_safe_url("https://example.com/resource") is False` | Low - fundamental security guard | Yes | Tests RFC 1918 private range blocking | None |
| test_is_safe_url_blocks_private_ranges[172.16.0.1] | Private, loopback, link-local, multicast, and unique-local ranges must be rejected | Validates SSRF protection blocks private Class B addresses (172.16-31.x.x) | `Pipe._is_safe_url()` | `pipe_instance_async`, monkeypatch on `socket.getaddrinfo` returning 172.16.0.1 | `assert await pipe_instance_async._is_safe_url("https://example.com/resource") is False` | Low - fundamental security guard | Yes | Tests RFC 1918 private range blocking | None |
| test_is_safe_url_blocks_private_ranges[127.0.0.1] | Private, loopback, link-local, multicast, and unique-local ranges must be rejected | Validates SSRF protection blocks loopback addresses | `Pipe._is_safe_url()` | `pipe_instance_async`, monkeypatch on `socket.getaddrinfo` returning 127.0.0.1 | `assert await pipe_instance_async._is_safe_url("https://example.com/resource") is False` | Low - fundamental security guard | Yes | Tests loopback range blocking (127.0.0.0/8) | None |
| test_is_safe_url_blocks_private_ranges[169.254.169.254] | Private, loopback, link-local, multicast, and unique-local ranges must be rejected | Validates SSRF protection blocks link-local/cloud metadata addresses | `Pipe._is_safe_url()` | `pipe_instance_async`, monkeypatch on `socket.getaddrinfo` returning 169.254.169.254 | `assert await pipe_instance_async._is_safe_url("https://example.com/resource") is False` | Low - critical cloud SSRF protection | Yes | Tests AWS/cloud metadata endpoint blocking - critical for cloud deployments | None |
| test_is_safe_url_blocks_private_ranges[224.0.0.1] | Private, loopback, link-local, multicast, and unique-local ranges must be rejected | Validates SSRF protection blocks multicast addresses | `Pipe._is_safe_url()` | `pipe_instance_async`, monkeypatch on `socket.getaddrinfo` returning 224.0.0.1 | `assert await pipe_instance_async._is_safe_url("https://example.com/resource") is False` | Low - fundamental security guard | Yes | Tests multicast range blocking (224.0.0.0/4) | None |
| test_is_safe_url_blocks_private_ranges[fd00::1] | Private, loopback, link-local, multicast, and unique-local ranges must be rejected | Validates SSRF protection blocks IPv6 unique local addresses | `Pipe._is_safe_url()` | `pipe_instance_async`, monkeypatch on `socket.getaddrinfo` returning fd00::1 | `assert await pipe_instance_async._is_safe_url("https://example.com/resource") is False` | Low - fundamental security guard | Yes | Tests IPv6 ULA range blocking (fc00::/7) | None |
| test_is_safe_url_blocks_literal_loopback | Literal loopback hosts are rejected without DNS lookups | Validates that literal 127.0.0.1 in URL is blocked without DNS resolution | `Pipe._is_safe_url()` | `pipe_instance_async` | `assert await pipe_instance_async._is_safe_url("http://127.0.0.1/internal") is False` | Low - essential early rejection | Yes | Bypasses DNS lookup for obvious loopback literals - performance optimization | None |
| test_is_safe_url_handles_dns_failures | DNS errors should fall back to 'unsafe' | Validates fail-closed behavior when DNS resolution fails | `Pipe._is_safe_url()` | `pipe_instance_async`, monkeypatch on `socket.getaddrinfo` raising `socket.gaierror` | `assert await pipe_instance_async._is_safe_url("https://unknown.invalid") is False` | Low - security-critical fail-closed design | Yes | Ensures DNS failures don't bypass SSRF protection | None |
| test_is_safe_url_rejects_urls_without_hostname | file:// and data: URLs should be rejected up front | Validates that non-HTTP schemes without hostnames are blocked | `Pipe._is_safe_url()` | `pipe_instance_async` | Asserts False for `file:///etc/passwd` and `data:text/plain,hello` | Low - scheme validation is straightforward | Yes | Blocks local file access and data URI attacks | None |
| test_is_safe_url_respects_disabled_valve | When protection is disabled, even private URLs are allowed | Validates that ENABLE_SSRF_PROTECTION valve can disable SSRF checks | `Pipe._is_safe_url()`, `Pipe.Valves.ENABLE_SSRF_PROTECTION` | `pipe_instance_async` with valve set to False | `assert await pipe_instance_async._is_safe_url("http://127.0.0.1/admin") is True` | Medium - valve behavior must match documentation | Yes | Allows admin override of SSRF protection when needed | Ensure valve default is True in production |
| test_download_remote_url_halts_when_ssrf_blocks | _download_remote_url should short-circuit when SSRF validation fails | Validates that download aborts early if SSRF check fails | `Pipe._download_remote_url()`, `MultimodalHandler._is_safe_url()` | `pipe_instance_async`, AsyncMock for `_is_safe_url` returning False, monkeypatch `httpx.AsyncClient` to raise AssertionError if called | `assert result is None`, `guard.assert_awaited_once()` | Low - tests integration between SSRF guard and download | Yes | Ensures HTTP client never instantiated when SSRF blocks - prevents timing attacks | None |
| test_is_youtube_url_variants | _is_youtube_url should detect both standard and short formats | Validates YouTube URL detection for standard and shortened formats | `Pipe._is_youtube_url()` | `pipe_instance` (sync fixture) | Asserts True for youtube.com/watch, True for youtu.be, False for vimeo.com, False for empty string | Low - URL pattern matching is stable | Yes | Tests YouTube video embedding detection logic | None |
| test_status_messages_are_strings | StatusMessages entries should be non-empty strings with emoji cues | Validates StatusMessages class contains properly formatted status strings | `StatusMessages` class attributes | None | Asserts all public attributes are non-empty strings with expected emoji prefixes (IMAGE/FILE: emoji, VIDEO: emoji, AUDIO: emoji) | Medium - emoji requirements could change | Yes | Ensures user-facing status messages have visual cues | None |
| test_valve_defaults_are_sensible | Key valve defaults should stay within documented bounds | Validates that default valve values are within acceptable ranges | `Pipe.Valves()` default values | None | `assert 1 <= valves.VIDEO_MAX_SIZE_MB <= 1000`, `assert valves.ENABLE_SSRF_PROTECTION is True` | Medium - defaults may need adjustment based on deployment needs | Yes | Ensures security-critical defaults are safe | Consider adding more valve default validations |


## `tests/test_session_logs.py`

| Test Name | Description | What It Tests | Code Under Test | Mocks/Fixtures | Assertions | Drift Risk | Check Done | Codex Notes | Codex TODO |
|-----------|-------------|---------------|-----------------|----------------|------------|------------|------------|-------------|------------|
| `test_sanitize_path_component_blocks_traversal` | Validates path sanitization blocks directory traversal attacks | Path traversal prevention, slash removal, empty string fallback | `_sanitize_path_component()` | None | Asserts "../etc/passwd" is blocked, slashes removed, empty string uses fallback | LOW - Pure function, stable API | YES | Security-critical path sanitization, prevents zip slip attacks | None |
| `test_write_session_log_archive_creates_encrypted_zip` | Verifies encrypted zip archive creation with proper structure | Archive creation, AES encryption, metadata storage, JSONL formatting | `Pipe._write_session_log_archive()` | `tmp_path`, `pipe_instance` | Archive exists, contains meta.json and logs.jsonl, metadata fields correct, log events preserved | LOW - Core archival function, stable | YES | Archive includes user/chat/message IDs, request_id tracking, encrypted with pyzipper AES | None |
| `test_write_session_log_archive_preserves_per_event_request_id` | Ensures individual event request_ids are preserved in archive | Per-event request_id preservation vs bundle-level request_id | `Pipe._write_session_log_archive()` | `tmp_path`, `pipe_instance` | Bundle request_id in meta.json, individual request_ids in meta.request_ids array, events preserve original request_ids | LOW - Critical for multi-request tracking | YES | Distinguishes bundle request_id from per-event request_ids for merge scenarios | None |
| `test_enqueue_session_log_archive_skips_when_missing_ids` | Validates archive enqueue is skipped when required IDs are missing | Missing ID validation, early exit logic | `Pipe._enqueue_session_log_archive()` | `tmp_path`, `monkeypatch`, `pipe_instance` | Worker start not called when user_id is empty | LOW - Guard clause, stable behavior | YES | Prevents creating archives with incomplete metadata | None |
| `test_session_log_buffer_captures_debug_even_when_console_level_warning` | Tests that SessionLogger buffer captures DEBUG even when console level is WARNING | Dual logging levels (console vs buffer), context var usage | `SessionLogger.get_logger()`, `SessionLogger.logs` | `capsys` | WARNING in stdout, DEBUG not in stdout, both in buffer | MEDIUM - Depends on contextvars, logging filter | YES | Critical for debug diagnostics while keeping console clean | None |
| `TestSessionLogArchiveEdgeCases.test_archive_with_missing_ids_skipped` | Verifies archive is not created when user_id is missing | Missing ID skip logic at write time | `Pipe._write_session_log_archive()` | `tmp_path`, `pipe_instance` | Archive file does not exist when user_id is empty | LOW - Guard clause duplication check | YES | Complements enqueue test, validates write-time skip | None |
| `TestSessionLogArchiveEdgeCases.test_archive_password_encryption` | Tests AES encryption and password validation | pyzipper AES encryption, wrong password rejection | `Pipe._write_session_log_archive()`, `pyzipper.AESZipFile` | `tmp_path`, `pipe_instance` | Wrong password raises RuntimeError, correct password succeeds | LOW - pyzipper library stable | YES | Security validation, ensures archives are genuinely encrypted | None |
| `TestSessionLogArchiveEdgeCases.test_archive_compression_options` | Validates all compression algorithms work correctly | Compression method variation (stored, deflated, bzip2, lzma) | `Pipe._write_session_log_archive()` | `tmp_path`, `pipe_instance` | All 4 compression methods create readable archives | LOW - Compression options stable | YES | Ensures flexibility in compression choice without breaking functionality | None |
| `TestSessionLogArchiveEdgeCases.test_cleanup_deletes_old_archives` | Tests retention policy deletes archives older than retention window | Retention policy enforcement, timestamp comparison | `Pipe._cleanup_session_log_archives()` | `tmp_path`, `monkeypatch`, `pipe_instance` | Old archive deleted, new archive kept, mtime-based comparison | MEDIUM - Depends on time.time() mock, filesystem ops | YES | Critical for storage management, uses mtime for age determination | Verify production mtime handling matches test |
| `TestSessionLogArchiveEdgeCases.test_cleanup_prunes_empty_directories` | Validates empty directories are removed after archive deletion | Directory cleanup, recursive pruning | `Pipe._cleanup_session_log_archives()` | `tmp_path`, `monkeypatch`, `pipe_instance` | Archive deleted, chat_dir deleted, user_dir deleted | MEDIUM - Filesystem traversal logic | YES | Prevents directory bloat, prunes empty user/chat dirs | Monitor for edge cases with concurrent writes |
| `TestConvertJsonlToInternal.test_converts_iso_timestamp_to_epoch` | Tests ISO timestamp conversion to epoch float | ISO8601 to epoch conversion, 'ts' to 'created' field mapping | `Pipe._convert_jsonl_to_internal()` | `pipe_instance` | 'created' field exists, 'ts' removed, float type, correct epoch value | MEDIUM - Date parsing can drift with format changes | YES | Merge helper for reading external JSONL archives | None |
| `TestConvertJsonlToInternal.test_converts_z_suffix_timestamp` | Tests 'Z' suffix (Zulu time) timestamp parsing | ISO8601 Z suffix handling | `Pipe._convert_jsonl_to_internal()` | `pipe_instance` | 'created' field exists, float type | LOW - Standard ISO format | YES | Ensures UTC timezone indicator is parsed | None |
| `TestConvertJsonlToInternal.test_preserves_existing_created_field` | Tests that existing 'created' field is not overwritten | Field precedence, non-mutation of 'created' | `Pipe._convert_jsonl_to_internal()` | `pipe_instance` | 'created' unchanged, 'ts' preserved when 'created' exists | LOW - Simple precedence check | YES | Prevents data loss when both fields exist | None |
| `TestConvertJsonlToInternal.test_handles_missing_ts_field` | Tests events without 'ts' field pass through unchanged | Missing field graceful handling | `Pipe._convert_jsonl_to_internal()` | `pipe_instance` | Event unchanged when no 'ts' field | LOW - Graceful degradation | YES | Handles events already in internal format | None |
| `TestConvertJsonlToInternal.test_handles_invalid_timestamp_gracefully` | Tests fallback to current time for invalid timestamps | Error handling, time.time() fallback | `Pipe._convert_jsonl_to_internal()` | `pipe_instance` | 'created' field set to current time, value between before/after | MEDIUM - Depends on time.time() | YES | Prevents crashes on malformed archives | None |
| `TestConvertJsonlToInternal.test_does_not_mutate_original_event` | Tests that original event dict is not modified | Immutability, defensive copying | `Pipe._convert_jsonl_to_internal()` | `pipe_instance` | Original dict unchanged after conversion | LOW - Defensive coding check | YES | Prevents side effects in caller code | None |
| `TestDedupeSessionLogEvents.test_removes_exact_duplicates` | Tests exact duplicate events are removed | Deduplication logic, tuple key generation | `Pipe._dedupe_session_log_events()` | `pipe_instance` | 2 identical events reduced to 1 | LOW - Stable deduplication logic | YES | Critical for merge scenarios, prevents log bloat | None |
| `TestDedupeSessionLogEvents.test_keeps_events_with_different_timestamps` | Tests events with different timestamps are kept | Timestamp as part of dedup key | `Pipe._dedupe_session_log_events()` | `pipe_instance` | 2 events with different timestamps both kept | LOW - Key field variation | YES | Ensures timestamp is part of uniqueness criteria | None |
| `TestDedupeSessionLogEvents.test_keeps_events_with_different_request_ids` | Tests events from different request_ids are kept | request_id as part of dedup key | `Pipe._dedupe_session_log_events()` | `pipe_instance` | 2 events with different request_ids both kept | LOW - Key field variation | YES | Essential for multi-request merge scenarios | None |
| `TestDedupeSessionLogEvents.test_keeps_events_with_different_line_numbers` | Tests events from different line numbers are kept | lineno as part of dedup key | `Pipe._dedupe_session_log_events()` | `pipe_instance` | 2 events with different linenos both kept | LOW - Key field variation | YES | Line number distinguishes events from same location | None |
| `TestDedupeSessionLogEvents.test_keeps_events_with_different_messages` | Tests events with different messages are kept | Message content as part of dedup key | `Pipe._dedupe_session_log_events()` | `pipe_instance` | 2 events with different messages both kept | LOW - Key field variation | YES | Message text is primary differentiator | None |
| `TestDedupeSessionLogEvents.test_preserves_order_of_first_occurrence` | Tests first occurrence is kept for duplicates | Order preservation, first-wins strategy | `Pipe._dedupe_session_log_events()` | `pipe_instance` | First duplicate's extra field preserved | LOW - Dictionary insertion order | YES | Ensures stable ordering, first event takes precedence | None |
| `TestDedupeSessionLogEvents.test_handles_missing_fields_gracefully` | Tests events with missing fields don't crash | None/missing field handling in tuple key | `Pipe._dedupe_session_log_events()` | `pipe_instance` | 3 events with various missing fields all kept | LOW - Defensive coding | YES | Robust handling of incomplete events | None |
| `TestDedupeSessionLogEvents.test_handles_empty_list` | Tests empty list returns empty list | Edge case handling | `Pipe._dedupe_session_log_events()` | `pipe_instance` | Empty input returns empty output | LOW - Trivial edge case | YES | Prevents crashes on empty input | None |
| `TestReadSessionLogArchiveEvents.test_reads_events_from_encrypted_zip` | Tests reading events from AES-encrypted zip | Archive reading, decryption, JSONL parsing, timestamp conversion | `Pipe._read_session_log_archive_events()` | `pipe_instance` | 2 events read, timestamps converted, messages correct | MEDIUM - pyzipper, temp file handling | YES | Core merge functionality, reads existing archives | None |
| `TestReadSessionLogArchiveEvents.test_returns_empty_list_for_missing_jsonl` | Tests missing logs.jsonl returns empty list | Missing file graceful handling | `Pipe._read_session_log_archive_events()` | `pipe_instance` | Empty list when logs.jsonl not in archive | LOW - Graceful degradation | YES | Handles corrupted or incomplete archives | None |
| `TestReadSessionLogArchiveEvents.test_skips_malformed_json_lines` | Tests malformed JSON lines are skipped | JSON parsing error handling, partial success | `Pipe._read_session_log_archive_events()` | `pipe_instance` | 2 valid events parsed, malformed line skipped | MEDIUM - Error recovery logic | YES | Robust archive reading, prevents total failure on partial corruption | None |
| `TestReadSessionLogArchiveEvents.test_handles_empty_lines` | Tests empty lines in JSONL are skipped | Whitespace handling, line filtering | `Pipe._read_session_log_archive_events()` | `pipe_instance` | 2 events parsed, empty lines ignored | LOW - Basic whitespace handling | YES | Prevents parsing errors from blank lines | None |
| `TestMergeIntegration.test_merge_combines_existing_and_new_events` | Tests merge combines archive and DB events correctly | Full merge flow, sorting by timestamp | Merge logic combining multiple functions | `pipe_instance` | 4 events merged, sorted by timestamp | MEDIUM - Integration test, multi-function | YES | End-to-end merge validation, tests real-world scenario | None |
| `TestMergeIntegration.test_merge_dedupes_overlapping_events` | Tests duplicate events between archive and DB are deduplicated | Merge with deduplication | Merge flow with dedupe | `pipe_instance` | Duplicate removed, unique event kept, 2 events total | MEDIUM - Integration test | YES | Validates dedup works in merge context | None |
| `TestMergeIntegration.test_sort_is_stable_for_equal_timestamps` | Tests stable sort for events with equal timestamps | Python sort stability | Python sort() with key function | `pipe_instance` | Events with same timestamp maintain insertion order | LOW - Python stable sort guarantee | YES | Ensures deterministic ordering | None |
| `test_session_logger_thread_safety_filter_and_cleanup` | Tests SessionLogger filter and cleanup don't race | Thread safety, concurrent dictionary access, RuntimeError detection | `SessionLogger.cleanup()`, `SessionLogger` filter | None | No RuntimeError from dict iteration during modification, request_id in logs | HIGH - Concurrency, race conditions | YES | Critical for multi-threaded safety, uses ThreadPoolExecutor with 4 workers | Monitor production for race conditions under high load |
| `test_session_logger_cleanup_removes_stale_entries` | Tests cleanup removes entries older than max_age_seconds | TTL-based cleanup, timestamp expiry | `SessionLogger.cleanup()`, `SessionLogger.process_record()` | None | Old request removed, fresh request kept | MEDIUM - Time-based logic, lock usage | YES | Memory management, prevents unbounded growth | None |
| `test_session_logger_concurrent_writes_same_request` | Tests multiple threads logging to same request_id don't corrupt | Concurrent writes, deque thread safety, buffer limits | `SessionLogger` with concurrent access | None | Expected number of messages in buffer, no corruption | HIGH - Concurrency, shared state | YES | Validates thread-safe logging with 8 threads, 50 messages/thread | Stress test in production, monitor for data loss |


## `tests/test_sse_parser.py`

| Test Name | Description | What It Tests | Code Under Test | Mocks/Fixtures | Assertions | Drift Risk | Check Done | Codex Notes | Codex TODO |
|-----------|-------------|---------------|-----------------|----------------|------------|------------|------------|-------------|------------|
| test_parse_sse_stream_cleans_up_on_early_break | Verify tasks are cancelled when consumer breaks early from async for | Task cancellation during cleanup when consumer exits async iteration early | SSEParser.parse_sse_stream() cleanup logic (lines 158, 161, 167-168) | _FakeSession with 100 chunks and 0.1s delays, _FakeContent | len(events_received) >= 2 | LOW - Core cleanup mechanism | YES | Tests critical cleanup path when consumer breaks early; ensures no task leaks | None |
| test_cleanup_logs_task_errors_excluding_cancellation | Verify cleanup handles and logs non-CancelledError exceptions | Exception handling in cleanup that filters CancelledError vs other exceptions | SSEParser cleanup error logging (lines 166-173) | _FakeSession with simple stream, custom logger | len(events) == 1, events[0]["delta"] == "hello" | LOW - Error logging path | YES | Tests cleanup's exception handling path; verifies CancelledError is filtered | None |
| test_breaker_check_fails_before_request_raises | Test circuit breaker open before request | Circuit breaker check before HTTP request is sent | SSEParser.parse_sse_stream() breaker_check at line 217 | _FakeSession with chunks, breaker_check lambda returning False | pytest.raises RuntimeError match "Circuit breaker open" | MEDIUM - Depends on breaker interface | YES | Tests pre-request circuit breaker; critical for preventing requests when service is down | Verify breaker_check signature matches actual implementation |
| test_breaker_check_fails_during_stream_raises | Test circuit breaker opens during chunk iteration | Circuit breaker check during stream processing | SSEParser chunk iteration breaker check at line 239 | _FakeSession with 10 chunks, breaker_check with call counter | pytest.raises RuntimeError match "Circuit breaker open during stream" | MEDIUM - Depends on breaker interface | YES | Tests mid-stream circuit breaker; ensures streaming can be interrupted | None |
| test_http_error_calls_record_failure | Test that HTTP errors invoke record_failure callback | record_failure callback invoked on HTTP 500 errors | SSEParser HTTP error handling and record_failure call (lines 228-231) | _FakeSession status=500, record_failure callback | len(failure_recorded) > 0, pytest.raises ClientResponseError | LOW - Error callback mechanism | YES | Tests failure recording for 5xx errors; critical for circuit breaker metrics | None |
| test_http_401_error_calls_record_failure | Test 401 auth error calls record_failure | record_failure callback invoked on HTTP 401 auth errors | SSEParser HTTP error handling for auth errors | _FakeSession status=401, record_failure callback | len(failure_recorded) > 0, pytest.raises ClientResponseError | LOW - Error callback mechanism | YES | Tests failure recording for auth errors; distinct from 5xx errors | None |
| test_empty_data_lines_are_skipped | Test that empty data: lines don't produce events | Empty SSE data line handling | SSEParser data line parsing at line 260 | _FakeSession with empty data lines b"data: \n\n" | len(events) == 1, events[0]["delta"] == "valid" | LOW - SSE spec compliance | YES | Tests SSE spec compliance for empty data lines; prevents spurious events | None |
| test_remaining_event_data_emitted_at_stream_end | Test incomplete event at stream end is emitted | Remaining event data when stream ends without proper termination | SSEParser end-of-stream handling (lines 290-294) | _FakeSession with incomplete event (no trailing \n\n) | len(events) == 2, events[0]["delta"] == "first", events[1]["delta"] == "incomplete" | MEDIUM - Edge case handling | YES | Tests recovery from improperly terminated streams; ensures no data loss | None |
| test_remaining_done_not_emitted | Test [DONE] at stream end without newlines is not emitted as event | [DONE] token handling at stream end | SSEParser [DONE] detection in remaining data | _FakeSession with [DONE] without trailing newlines | len(events) == 1, events[0]["delta"] == "test" | LOW - [DONE] token handling | YES | Tests [DONE] is recognized even without proper SSE formatting | None |
| test_producer_auth_error_logs_warning | Test auth errors (401/403) log warning instead of error | Auth error logging level in producer exception handler | SSEParser._producer exception handling (lines 300-309) | _FakeSession raising OpenRouterAPIError 401, record_failure callback | len(failure_recorded) > 0, pytest.raises OpenRouterAPIError | LOW - Error logging distinction | YES | Tests that auth errors use warning level not error level; improves log noise | None |
| test_producer_non_auth_error_logs_error | Test non-auth errors log as error level | Non-auth error logging level in producer exception handler | SSEParser._producer exception handling (lines 310-315) | _FakeSession raising RuntimeError, record_failure callback | len(failure_recorded) > 0, pytest.raises RuntimeError match "Network failure" | LOW - Error logging distinction | YES | Tests that non-auth errors use error level logging | None |
| test_queue_full_sentinel_handling | Test that QueueFull exception path is correctly handled | QueueFull exception when sending sentinel during cleanup | SSEParser sentinel sending logic (lines 328-332) | Manually created Queue with maxsize=1, pre-filled queue | chunk_queue.full() assertion | LOW - Queue edge case | YES | Tests defensive handling when queue is full during cleanup; prevents hangs | None |
| test_producer_queue_full_on_sentinel | Test producer's finally block handles QueueFull when sending sentinels | Producer cleanup QueueFull handling with multiple workers | SSEParser._producer finally block sentinel sending (lines 328-332) | _FakeSession with simple stream, chunk_queue_size=1, workers=4 | chunk_queue.qsize() <= 1 | LOW - Cleanup edge case | YES | Tests producer handles QueueFull gracefully when cleanup races with full queue | None |
| test_worker_skips_done_token | Test worker ignores [DONE] tokens that slip through | Worker [DONE] token filtering | SSEParser._worker [DONE] skip logic at line 362 | Manually created queues, direct worker task | len(events) == 1, events[0][0] == 1, events[0][1]["type"] == "test" | LOW - Token filtering | YES | Tests worker defensive check against [DONE] tokens reaching worker; prevents parse errors | None |
| test_distributor_warns_on_queue_backlog | Test distributor logs warning when queue backlog is high | Queue backlog warning in distributor | SSEParser._distributor backlog check (lines 460-462) | Pre-filled Queue with 5 events, event_queue_warn_size=2 | len(events) == 5 | LOW - Monitoring/logging | YES | Tests queue backlog warning fires when threshold exceeded; aids performance monitoring | None |
| test_distributor_skips_empty_events | Test distributor logs and skips None events | Empty event (None) handling in distributor | SSEParser._distributor empty event skip (lines 472-474) | Queue with (seq, None) event | len(events) == 2, events[0]["delta"] == "a", events[1]["delta"] == "b" | LOW - Defensive coding | YES | Tests distributor handles None events defensively; prevents crashes on unexpected data | None |
| test_distributor_raises_on_extracted_error | Test distributor raises when extract_error returns an exception | Error extraction and raising in distributor | SSEParser._distributor extract_error handling (lines 485-488) | Queue with error event, extract_error callback | pytest.raises ValueError match "Extracted: Test error" | LOW - Error propagation | YES | Tests error extraction mechanism; allows custom error detection and propagation | None |
| test_distributor_continues_when_extract_error_returns_none | Test distributor continues when extract_error returns None | extract_error returning None allows normal processing | SSEParser._distributor extract_error None handling | Queue with normal event, extract_error returning None | len(events) == 1 | LOW - Normal path | YES | Tests extract_error optional error detection; verifies None allows continuation | None |
| test_delta_batching_flushes_at_threshold | Test delta events are batched and flushed at char threshold | Delta batching at character threshold | SSEParser._distributor delta batching at line 508 | Queue with multiple delta events totaling 12 chars, delta_char_limit=10 | len(events) >= 2, total_chars == 12 | MEDIUM - Batching logic | YES | Tests delta batching threshold flush; critical for performance optimization | Verify threshold calculation is correct |
| test_final_delta_flush_on_stream_completion | Test remaining buffered deltas are flushed at stream end | Final delta flush on stream completion | SSEParser._distributor final flush (lines 518-520) | Queue with deltas below threshold, delta_char_limit=1000 | len(events) == 1, events[0]["delta"] == "hello world" | LOW - Completion path | YES | Tests final flush ensures no deltas lost at stream end | None |
| test_delta_flush_on_exception | Test buffered deltas are flushed before exception propagates | Delta flush in exception path | SSEParser._distributor exception flush (lines 522-527) | Queue with delta then error, extract_error callback | len(events) == 1, events[0]["delta"] == "partial", pytest.raises RuntimeError | MEDIUM - Exception handling | YES | Tests deltas flushed before exception raised; prevents data loss on errors | None |
| test_passthrough_mode_no_batching | Test deltas pass through immediately when batching disabled | Passthrough mode with delta_char_limit=0 | SSEParser._distributor passthrough path | Queue with 3 deltas, delta_char_limit=0 | len(events) == 3, deltas == ["a", "b", "c"] | LOW - Passthrough mode | YES | Tests batching can be disabled; allows low-latency streaming | None |
| test_passthrough_skips_empty_deltas | Test empty deltas are skipped in passthrough mode | Empty delta filtering in passthrough mode | SSEParser._distributor empty delta skip | Queue with empty delta, delta_char_limit=0 | len(events) == 2, deltas == ["a", "b"] | LOW - Empty data handling | YES | Tests empty deltas filtered even in passthrough; prevents empty events | None |
| test_multiline_sse_event_parsing | Test parsing of multi-line SSE events | Multi-line SSE event reconstruction | SSEParser SSE parsing with multiple data: lines | _FakeSession with split JSON across data: lines | len(events) == 1, events[0]["delta"] == "multiline" | MEDIUM - SSE spec compliance | YES | Tests SSE spec multi-line data: handling; ensures complex events parsed correctly | None |
| test_comment_lines_are_ignored | Test SSE comment lines (starting with :) are ignored | SSE comment line handling | SSEParser comment line parsing | _FakeSession with : comment lines | len(events) == 1, events[0]["delta"] == "after_comments" | LOW - SSE spec compliance | YES | Tests SSE spec comment handling; prevents parsing comments as data | None |
| test_full_stream_integration | Integration test covering full stream processing pipeline | End-to-end stream processing with multiple event types | SSEParser.parse_sse_stream() full pipeline | _FakeSession with keepalive, deltas, completed, workers=2, batching enabled | completed_events count, total_text == "Hello World" | MEDIUM - Integration | YES | Integration test of full pipeline; validates all components work together | None |
| test_parser_configuration_bounds | Test parser enforces minimum bounds on configuration | Configuration validation and bound clamping | SSEParser.__init__() parameter validation | Direct instantiation with negative values | All config values >= minimums | LOW - Input validation | YES | Tests configuration bounds enforced; prevents invalid configurations | None |
| test_distributor_non_delta_flushes_buffer | Test non-delta event triggers flush of buffered deltas | Non-delta event triggering delta flush | SSEParser._distributor non-delta flush trigger | Queue with delta, non-delta, delta, delta_char_limit=1000 | len(events) == 3, correct ordering and types | MEDIUM - Batching logic | YES | Tests non-delta events flush buffered deltas; ensures event ordering | None |
| test_distributor_handles_out_of_order_events | Test distributor properly orders out-of-sequence events | Out-of-order event reordering via sequence numbers | SSEParser._distributor sequence ordering | Queue with events seq 2,0,1, workers=2 | deltas == ["a", "b", "c"] in order | HIGH - Concurrency correctness | YES | Tests sequence-based ordering with multiple workers; critical for parallel processing | Verify sequence numbering matches producer |


## `tests/test_storage.py`

| Test Name | Description | What It Tests | Code Under Test | Mocks/Fixtures | Assertions | Drift Risk | Check Done | Codex Notes | Codex TODO |
|-----------|-------------|---------------|-----------------|----------------|------------|------------|------------|-------------|------------|
| test_normalize_persisted_item_none_input | Test normalizing None returns None | normalize_persisted_item with None input | normalize_persisted_item() | None | assert result is None | Low | Yes | Edge case handling | None |
| test_normalize_persisted_item_not_dict | Test normalizing non-dict returns None | normalize_persisted_item with string and list inputs | normalize_persisted_item() | None | assert result is None for both cases | Low | Yes | Type validation | None |
| test_normalize_persisted_item_no_type | Test normalizing dict without type returns None | normalize_persisted_item with dict missing 'type' key | normalize_persisted_item() | None | assert result is None | Low | Yes | Schema validation | None |
| test_normalize_persisted_item_function_call_output | Test normalizing function_call_output items | normalize_persisted_item with function_call_output type | normalize_persisted_item() | None | Checks type, output conversion to string, id, call_id, status | Medium | Yes | Function call output normalization | None |
| test_normalize_persisted_item_function_call_output_none_output | Test normalizing function_call_output with None output | normalize_persisted_item with None output field | normalize_persisted_item() | None | assert output == "" | Low | Yes | None handling in output | None |
| test_normalize_persisted_item_function_call | Test normalizing function_call items | normalize_persisted_item with function_call type | normalize_persisted_item() | None | Checks type, name, arguments serialization, id, call_id | Medium | Yes | Function call normalization | None |
| test_normalize_persisted_item_function_call_string_args | Test normalizing function_call with already-string arguments | normalize_persisted_item with string arguments | normalize_persisted_item() | None | assert arguments unchanged | Low | Yes | String arguments passthrough | None |
| test_normalize_persisted_item_function_call_missing_name | Test normalizing function_call without name returns None | normalize_persisted_item with missing name field | normalize_persisted_item() | None | assert result is None | Low | Yes | Required field validation | None |
| test_normalize_persisted_item_function_call_missing_arguments | Test normalizing function_call without arguments returns None | normalize_persisted_item with missing arguments field | normalize_persisted_item() | None | assert result is None | Low | Yes | Required field validation | None |
| test_normalize_persisted_item_function_call_non_serializable_args | Test normalizing function_call with non-serializable arguments | normalize_persisted_item with custom class arguments | normalize_persisted_item() | Custom NonSerializable class | assert fallback to str() | Medium | Yes | Non-JSON serializable fallback | None |
| test_normalize_persisted_item_reasoning | Test normalizing reasoning items | normalize_persisted_item with reasoning type | normalize_persisted_item() | None | Checks type, content structure, summary, id | Medium | Yes | Reasoning normalization | None |
| test_normalize_persisted_item_reasoning_with_list_content | Test normalizing reasoning with list content | normalize_persisted_item with list content | normalize_persisted_item() | None | assert content unchanged | Low | Yes | List content passthrough | None |
| test_normalize_persisted_item_reasoning_with_empty_content | Test normalizing reasoning with empty content | normalize_persisted_item with None content | normalize_persisted_item() | None | assert content == [] | Low | Yes | Empty content handling | None |
| test_normalize_persisted_item_reasoning_with_summary | Test normalizing reasoning with summary | normalize_persisted_item with summary field | normalize_persisted_item() | None | assert summary == ["Summary text"] | Low | Yes | Summary normalization | None |
| test_normalize_persisted_item_web_search_call | Test normalizing web_search_call items | normalize_persisted_item with web_search_call and invalid action | normalize_persisted_item() | None | Checks type, action defaults to {}, id | Medium | Yes | Web search call normalization | None |
| test_normalize_persisted_item_web_search_call_with_dict_action | Test normalizing web_search_call with valid action dict | normalize_persisted_item with dict action | normalize_persisted_item() | None | assert action unchanged | Low | Yes | Valid action passthrough | None |
| test_normalize_persisted_item_file_search_call | Test normalizing file_search_call items | normalize_persisted_item with file_search_call and invalid queries | normalize_persisted_item() | None | Checks type, queries defaults to [] | Medium | Yes | File search call normalization | None |
| test_normalize_persisted_item_file_search_call_with_queries | Test normalizing file_search_call with valid queries | normalize_persisted_item with list queries | normalize_persisted_item() | None | assert queries unchanged | Low | Yes | Valid queries passthrough | None |
| test_normalize_persisted_item_image_generation_call | Test normalizing image_generation_call items | normalize_persisted_item with image_generation_call | normalize_persisted_item() | None | Checks type and id | Low | Yes | Image generation call normalization | None |
| test_normalize_persisted_item_local_shell_call | Test normalizing local_shell_call items | normalize_persisted_item with local_shell_call | normalize_persisted_item() | None | Checks type | Low | Yes | Shell call normalization | None |
| test_normalize_persisted_item_unknown_type | Test normalizing unknown type returns item as-is | normalize_persisted_item with unknown_type | normalize_persisted_item() | None | assert result == item | Low | Yes | Unknown type passthrough | None |
| test_normalize_persisted_item_preserves_existing_status | Test that existing status is preserved | normalize_persisted_item with existing status field | normalize_persisted_item() | None | assert status == "in_progress" | Low | Yes | Status preservation | None |
| test_normalize_persisted_item_preserves_existing_id | Test that existing id is preserved | normalize_persisted_item with existing id field | normalize_persisted_item() | None | assert id == "existing-id" | Low | Yes | ID preservation | None |
| test_get_fernet_no_key | Test _get_fernet returns None without encryption key | ArtifactStore._get_fernet() with empty key | _get_fernet() | pipe_instance | assert result is None | Low | Yes | No encryption key handling | None |
| test_get_fernet_with_key | Test _get_fernet returns Fernet instance with key | ArtifactStore._get_fernet() with key and caching | _get_fernet() | pipe_instance | assert fernet not None, caching works | Medium | Yes | Fernet initialization and caching | None |
| test_should_encrypt_no_key | Test _should_encrypt returns False without key | ArtifactStore._should_encrypt() without key | _should_encrypt() | pipe_instance | assert False | Low | Yes | No key disables encryption | None |
| test_should_encrypt_reasoning_with_key | Test _should_encrypt returns True for reasoning with key | ArtifactStore._should_encrypt() for reasoning type | _should_encrypt() | pipe_instance | assert True for reasoning, case insensitive | Medium | Yes | Reasoning auto-encryption | None |
| test_should_encrypt_other_type_with_key | Test _should_encrypt returns False for non-reasoning without encrypt_all | ArtifactStore._should_encrypt() for other types | _should_encrypt() | pipe_instance | assert False | Low | Yes | Selective encryption | None |
| test_should_encrypt_all | Test _should_encrypt returns True for all types with encrypt_all | ArtifactStore._should_encrypt() with encrypt_all flag | _should_encrypt() | pipe_instance | assert True for all types | Medium | Yes | Encrypt all flag | None |
| test_encrypt_payload_no_key_raises | Test _encrypt_payload raises without key | ArtifactStore._encrypt_payload() without key | _encrypt_payload() | pipe_instance | pytest.raises RuntimeError | Low | Yes | Encryption without key error | None |
| test_decrypt_payload_no_key_raises | Test _decrypt_payload raises without key | ArtifactStore._decrypt_payload() without key | _decrypt_payload() | pipe_instance | pytest.raises RuntimeError | Low | Yes | Decryption without key error | None |
| test_decrypt_payload_invalid_token_raises | Test _decrypt_payload raises on invalid token | ArtifactStore._decrypt_payload() with invalid data | _decrypt_payload() | pipe_instance | pytest.raises ValueError | Low | Yes | Invalid token handling | None |
| test_encrypt_decrypt_roundtrip | Test encryption/decryption roundtrip | ArtifactStore encrypt/decrypt cycle | _encrypt_payload(), _decrypt_payload() | pipe_instance | assert decrypted == original | High | Yes | Encryption correctness | None |
| test_encrypt_if_needed_not_encrypted | Test _encrypt_if_needed returns plain payload when not needed | ArtifactStore._encrypt_if_needed() for note type | _encrypt_if_needed() | pipe_instance | assert result == payload, is_encrypted False | Medium | Yes | Conditional encryption | None |
| test_encrypt_if_needed_encrypts | Test _encrypt_if_needed encrypts reasoning payloads | ArtifactStore._encrypt_if_needed() for reasoning | _encrypt_if_needed() | pipe_instance | assert is_encrypted True, has ciphertext | High | Yes | Reasoning encryption | None |
| test_maybe_compress_empty_data | Test _maybe_compress_payload with empty data | ArtifactStore._maybe_compress_payload() with b"" | _maybe_compress_payload() | pipe_instance | assert result == b"", compressed False | Low | Yes | Empty data handling | None |
| test_maybe_compress_disabled | Test _maybe_compress_payload when compression is disabled | ArtifactStore._maybe_compress_payload() with disabled flag | _maybe_compress_payload() | pipe_instance | assert result == original, compressed False | Low | Yes | Compression disabled | None |
| test_maybe_compress_below_threshold | Test _maybe_compress_payload with data below threshold | ArtifactStore._maybe_compress_payload() below min bytes | _maybe_compress_payload() | pipe_instance | assert result == original, compressed False | Medium | Yes | Compression threshold | None |
| test_maybe_compress_lz4_not_available | Test _maybe_compress_payload when lz4 is not available | ArtifactStore._maybe_compress_payload() without lz4 | _maybe_compress_payload() | pipe_instance, monkeypatch lz4frame to None | assert result == original, compressed False | Medium | Yes | Missing lz4 handling | None |
| test_maybe_compress_not_smaller | Test _maybe_compress_payload when compressed is not smaller | ArtifactStore._maybe_compress_payload() with small data | _maybe_compress_payload() | pipe_instance, lz4 skip check | assert compressed False | Medium | Yes | Compression not beneficial | None |
| test_encode_decode_payload_plain | Test _encode_payload_bytes and _decode_payload_bytes without compression | ArtifactStore encode/decode without compression | _encode_payload_bytes(), _decode_payload_bytes() | pipe_instance | assert decoded == original, flag check | High | Yes | Plain encoding/decoding | None |
| test_encode_decode_payload_compressed | Test _encode_payload_bytes with compression | ArtifactStore encode/decode with compression | _encode_payload_bytes(), _decode_payload_bytes() | pipe_instance, lz4 skip check | assert decoded == original after compression | High | Yes | Compressed encoding/decoding | None |
| test_decode_payload_bytes_empty | Test _decode_payload_bytes with empty bytes | ArtifactStore._decode_payload_bytes() with b"" | _decode_payload_bytes() | pipe_instance | assert result == {} | Low | Yes | Empty bytes handling | None |
| test_decode_payload_bytes_single_byte | Test _decode_payload_bytes with single byte | ArtifactStore._decode_payload_bytes() with invalid JSON | _decode_payload_bytes() | pipe_instance | pytest.raises ValueError | Low | Yes | Invalid payload handling | None |
| test_redis_cache_key_missing_values | Test _redis_cache_key returns None for missing values | ArtifactStore._redis_cache_key() with None/empty | _redis_cache_key() | pipe_instance | assert None for various invalid inputs | Low | Yes | Cache key validation | None |
| test_redis_cache_key_valid | Test _redis_cache_key returns expected key | ArtifactStore._redis_cache_key() with valid values | _redis_cache_key() | pipe_instance | assert key contains chat and item IDs | Medium | Yes | Cache key generation | None |
| test_redis_cache_rows_not_enabled | Test _redis_cache_rows does nothing when Redis is not enabled | ArtifactStore._redis_cache_rows() with disabled Redis | _redis_cache_rows() | pipe_instance | No exception raised | Low | Yes | Redis disabled behavior | None |
| test_redis_cache_rows_skips_missing_cache_key | Test _redis_cache_rows skips rows without valid cache key | ArtifactStore._redis_cache_rows() with invalid rows | _redis_cache_rows() | pipe_instance, _FakeRedis | assert no setex calls | Medium | Yes | Cache key validation in caching | None |
| test_redis_requeue_entries_no_client | Test _redis_requeue_entries does nothing without client | ArtifactStore._redis_requeue_entries() without client | _redis_requeue_entries() | pipe_instance | No exception raised | Low | Yes | No Redis client handling | None |
| test_redis_requeue_entries_empty | Test _redis_requeue_entries does nothing with empty list | ArtifactStore._redis_requeue_entries() with empty list | _redis_requeue_entries() | pipe_instance, Mock | assert pipeline not called | Low | Yes | Empty list handling | None |
| test_redis_fetch_rows_not_enabled | Test _redis_fetch_rows returns empty when not enabled | ArtifactStore._redis_fetch_rows() with disabled Redis | _redis_fetch_rows() | pipe_instance | assert result == {} | Low | Yes | Redis disabled in fetch | None |
| test_redis_fetch_rows_no_client | Test _redis_fetch_rows returns empty without client | ArtifactStore._redis_fetch_rows() without client | _redis_fetch_rows() | pipe_instance | assert result == {} | Low | Yes | No client in fetch | None |
| test_redis_fetch_rows_no_chat_id | Test _redis_fetch_rows returns empty without chat_id | ArtifactStore._redis_fetch_rows() with None chat_id | _redis_fetch_rows() | pipe_instance, Mock | assert result == {} | Low | Yes | Missing chat_id handling | None |
| test_redis_fetch_rows_with_encrypted_payload | Test _redis_fetch_rows decrypts encrypted payloads | ArtifactStore._redis_fetch_rows() with encrypted data | _redis_fetch_rows() | pipe_instance, _FakeRedis | assert decrypted text matches | High | Yes | Redis fetch with decryption | None |
| test_redis_fetch_rows_decryption_failure | Test _redis_fetch_rows handles decryption failures | ArtifactStore._redis_fetch_rows() with invalid ciphertext | _redis_fetch_rows() | pipe_instance, _FakeRedis, caplog | assert item not in result | Medium | Yes | Decryption error handling | None |
| test_redis_fetch_rows_invalid_json | Test _redis_fetch_rows handles invalid JSON | ArtifactStore._redis_fetch_rows() with non-JSON data | _redis_fetch_rows() | pipe_instance, _FakeRedis | assert result == {} | Medium | Yes | Invalid JSON in Redis | None |
| test_redis_fetch_rows_none_value | Test _redis_fetch_rows skips None values | ArtifactStore._redis_fetch_rows() with None from mget | _redis_fetch_rows() | pipe_instance, _FakeRedis | assert result == {} | Low | Yes | None value handling | None |
| test_redis_enqueue_fallback_on_failure | Test _redis_enqueue_rows falls back to direct DB on failure | ArtifactStore._redis_enqueue_rows() with Redis failure | _redis_enqueue_rows() | _install_fake_store, _FailingRedis, caplog | assert direct DB called, warning logged | High | Yes | Redis failure fallback | None |
| test_flush_redis_queue_db_failure_requeues | Test _flush_redis_queue requeues on DB failure | ArtifactStore._flush_redis_queue() with DB error | _flush_redis_queue() | _install_fake_store, _FakeRedis, failing persist | assert items requeued | High | Yes | DB failure during flush | None |
| test_flush_redis_queue_lock_release_failure | Test _flush_redis_queue handles lock release failure | ArtifactStore._flush_redis_queue() with lock release error | _flush_redis_queue() | _install_fake_store, _FakeRedis | No exception raised | Medium | Yes | Lock release error handling | None |
| test_flush_redis_queue_lock_not_released | Test _flush_redis_queue logs when lock was not released | ArtifactStore._flush_redis_queue() with wrong token | _flush_redis_queue() | _install_fake_store, _FakeRedis, caplog | assert warning logged | Medium | Yes | Lock release failure detection | None |
| test_flush_redis_queue_bytes_data | Test _flush_redis_queue handles bytes data from Redis | ArtifactStore._flush_redis_queue() with bytes from lpop | _flush_redis_queue() | _install_fake_store, _FakeRedis | assert items persisted | Medium | Yes | Bytes data handling | None |
| test_flush_redis_queue_unexpected_type | Test _flush_redis_queue handles unexpected data type | ArtifactStore._flush_redis_queue() with int from lpop | _flush_redis_queue() | _install_fake_store, _FakeRedis, caplog | assert warning logged | Medium | Yes | Type validation in queue | None |
| test_flush_redis_queue_non_object_json | Test _flush_redis_queue handles non-object JSON | ArtifactStore._flush_redis_queue() with JSON string | _flush_redis_queue() | _install_fake_store, _FakeRedis, caplog | assert warning logged | Medium | Yes | JSON object validation | None |
| test_db_fetch_sync_encrypted_string_payload | Test _db_fetch_sync handles encrypted string payloads | ArtifactStore._db_fetch_sync() with string ciphertext | _db_fetch_sync() | _install_fake_store, _FakeModel | assert decrypted correctly | High | Yes | String payload decryption | None |
| test_db_fetch_sync_decryption_failure | Test _db_fetch_sync handles decryption failures | ArtifactStore._db_fetch_sync() with invalid ciphertext | _db_fetch_sync() | _install_fake_store, _FakeModel, caplog | assert item not in result | Medium | Yes | Decryption error in fetch | None |
| test_db_fetch_sync_touch_failure | Test _db_fetch_sync handles touch update failures gracefully | ArtifactStore._db_fetch_sync() with update failure | _db_fetch_sync() | _FakeSession with fail_on_update, caplog | assert result still returned | High | Yes | Touch failure doesn't break read | None |
| test_db_fetch_caches_results_in_redis | Test _db_fetch caches fetched results in Redis | ArtifactStore._db_fetch() with Redis caching | _db_fetch() | _install_fake_store, _FakeRedis, _FakeModel | assert rows cached | High | Yes | Redis caching after DB fetch | None |
| test_db_breaker_allows_empty_user_id | Test _db_breaker_allows returns True for empty user_id | ArtifactStore._db_breaker_allows() with "" | _db_breaker_allows() | pipe_instance | assert True | Low | Yes | Empty user_id bypass | None |
| test_db_breaker_allows_prunes_old_failures | Test _db_breaker_allows prunes old failures | ArtifactStore._db_breaker_allows() with old timestamps | _db_breaker_allows() | pipe_instance | assert old failures removed | Medium | Yes | Failure pruning by time | None |
| test_db_breaker_blocks_after_threshold | Test _db_breaker_allows returns False after threshold | ArtifactStore._db_breaker_allows() with threshold failures | _db_breaker_allows() | pipe_instance | assert False | High | Yes | Circuit breaker threshold | None |
| test_record_db_failure_no_user_id | Test _record_db_failure does nothing for empty user_id | ArtifactStore._record_db_failure() with "" | _record_db_failure() | pipe_instance | assert no change | Low | Yes | Empty user_id in record | None |
| test_reset_db_failure_clears_failures | Test _reset_db_failure clears failures for user | ArtifactStore._reset_db_failure() | _reset_db_failure() | pipe_instance | assert failures cleared | Medium | Yes | Failure reset | None |
| test_reset_db_failure_no_user_id | Test _reset_db_failure does nothing for empty user_id | ArtifactStore._reset_db_failure() with "" | _reset_db_failure() | pipe_instance | No exception | Low | Yes | Empty user_id in reset | None |
| test_record_failure_generic_no_user | Test _record_failure does nothing without user_id | ArtifactStore._record_failure() with "" | _record_failure() | pipe_instance | assert no change | Low | Yes | Generic failure record validation | None |
| test_record_failure_generic_with_user | Test _record_failure records failure for user | ArtifactStore._record_failure() with user | _record_failure() | pipe_instance | assert failure recorded | Medium | Yes | Generic failure recording | None |
| test_shutdown_without_executor | Test shutdown when executor is None | ArtifactStore.shutdown() without executor | shutdown() | pipe_instance | No exception | Low | Yes | No executor shutdown | None |
| test_shutdown_with_executor | Test shutdown shuts down executor | ArtifactStore.shutdown() with executor | shutdown() | pipe_instance, ThreadPoolExecutor | assert executor set to None | Medium | Yes | Executor shutdown | None |
| test_shutdown_executor_type_error | Test shutdown handles TypeError from executor.shutdown | ArtifactStore.shutdown() with old executor | shutdown() | pipe_instance, _OldExecutor | No exception | Medium | Yes | Backward compat for executor | None |
| test_shutdown_executor_generic_error | Test shutdown handles generic errors from executor.shutdown | ArtifactStore.shutdown() with failing executor | shutdown() | pipe_instance, _FailingExecutor, caplog | No exception, logs error | Medium | Yes | Executor shutdown error handling | None |
| test_run_cleanup_once_no_model | Test _run_cleanup_once returns early without model | ArtifactStore._run_cleanup_once() without model | _run_cleanup_once() | pipe_instance | No exception | Low | Yes | No model in cleanup | None |
| test_cleanup_sync_exception | Test _cleanup_sync handles and re-raises exceptions | ArtifactStore._cleanup_sync() with query failure | _cleanup_sync() | pipe_instance, _FailingSession | pytest.raises SQLAlchemyError | Medium | Yes | Cleanup error propagation | None |
| test_ensure_artifact_store_missing_pipe_id | Test _ensure_artifact_store raises without pipe_id | ArtifactStore._ensure_artifact_store() without id | _ensure_artifact_store() | pipe_instance | pytest.raises RuntimeError | Low | Yes | Pipe ID requirement | None |
| test_ensure_artifact_store_skip_when_unchanged | Test _ensure_artifact_store skips when signature unchanged | ArtifactStore._ensure_artifact_store() with same signature | _ensure_artifact_store() | pipe_instance, Mock | assert init not called | Medium | Yes | Signature-based skip | None |
| test_ensure_artifact_store_lz4_warning | Test _ensure_artifact_store warns when LZ4 unavailable | ArtifactStore._ensure_artifact_store() without lz4 | _ensure_artifact_store() | pipe_instance, monkeypatch, caplog | assert warning logged | Medium | Yes | LZ4 unavailable warning | None |
| test_init_artifact_store_missing_pipe_id | Test _init_artifact_store raises without pipe_id | ArtifactStore._init_artifact_store() without id | _init_artifact_store() | pipe_instance, _install_internal_db | pytest.raises RuntimeError | Low | Yes | Init pipe ID requirement | None |
| test_init_artifact_store_no_engine | Test _init_artifact_store disables when engine unavailable | ArtifactStore._init_artifact_store() without engine | _init_artifact_store() | pipe_instance, caplog | assert disabled warning | Medium | Yes | No engine handling | None |
| test_discover_engine_metadata_obj_schema | Test _discover_owui_engine_and_schema uses metadata_obj | ArtifactStore._discover_owui_engine_and_schema() | _discover_owui_engine_and_schema() | pipe_instance, _DB mock | assert schema from metadata_obj | Medium | Yes | Schema discovery from metadata_obj | None |
| test_discover_engine_from_env_module | Test _discover_owui_engine_and_schema uses open_webui.env | ArtifactStore._discover_owui_engine_and_schema() | _discover_owui_engine_and_schema() | pipe_instance, env module mock | assert schema from env | Medium | Yes | Schema from env module | None |
| test_discover_engine_from_attr | Test _discover_owui_engine_and_schema uses engine attribute | ArtifactStore._discover_owui_engine_and_schema() | _discover_owui_engine_and_schema() | pipe_instance, _DB mock | assert engine from attr | Medium | Yes | Engine from attribute | None |
| test_discover_engine_from_bind | Test _discover_owui_engine_and_schema uses bind attribute | ArtifactStore._discover_owui_engine_and_schema() | _discover_owui_engine_and_schema() | pipe_instance, _Session mock | assert engine from bind | Medium | Yes | Engine from session bind | None |
| test_redis_state_invalid_uvicorn_workers | Test _initialize_redis_state handles invalid UVICORN_WORKERS | ArtifactStore._initialize_redis_state() with invalid env | _initialize_redis_state() | Pipe(), monkeypatch, caplog | assert warning logged | Medium | Yes | Invalid worker count handling | None |
| test_redis_state_multi_worker_warnings | Test _initialize_redis_state warns on multi-worker issues | ArtifactStore._initialize_redis_state() without Redis URL | _initialize_redis_state() | Pipe(), monkeypatch, caplog | Warnings expected | Medium | Yes | Multi-worker without Redis | None |
| test_redis_state_websocket_manager_not_redis | Test warning when WEBSOCKET_MANAGER is not redis | ArtifactStore._initialize_redis_state() with local websocket | _initialize_redis_state() | Pipe(), monkeypatch, caplog | Warning expected | Medium | Yes | Websocket manager mismatch | None |
| test_maybe_heal_no_engine | Test _maybe_heal_index_conflict returns False without engine | ArtifactStore._maybe_heal_index_conflict() without engine | _maybe_heal_index_conflict() | pipe_instance | assert False | Low | Yes | No engine in heal | None |
| test_maybe_heal_no_table | Test _maybe_heal_index_conflict returns False without table | ArtifactStore._maybe_heal_index_conflict() without table | _maybe_heal_index_conflict() | pipe_instance | assert False | Low | Yes | No table in heal | None |
| test_maybe_heal_no_ix_in_message | Test _maybe_heal_index_conflict returns False without ix_ in message | ArtifactStore._maybe_heal_index_conflict() with other error | _maybe_heal_index_conflict() | pipe_instance | assert False | Low | Yes | Non-index error detection | None |
| test_maybe_heal_with_schema | Test _maybe_heal_index_conflict with schema qualification | ArtifactStore._maybe_heal_index_conflict() with schema | _maybe_heal_index_conflict() | pipe_instance, _DummyTable, _DummyEngine | assert drop index executed | High | Yes | Schema-qualified index drop | None |
| test_maybe_heal_drop_fails | Test _maybe_heal_index_conflict handles drop failures | ArtifactStore._maybe_heal_index_conflict() with drop error | _maybe_heal_index_conflict() | pipe_instance, _DummyEngine, caplog | assert False, warning logged | Medium | Yes | Index drop failure handling | None |
| test_quote_identifier | Test _quote_identifier handles special characters | ArtifactStore._quote_identifier() | _quote_identifier() | None | assert quotes and escaping correct | Medium | Yes | SQL identifier quoting | None |
| test_delete_artifacts_sync_no_session | Test _delete_artifacts_sync returns early without session | ArtifactStore._delete_artifacts_sync() without session | _delete_artifacts_sync() | pipe_instance | No exception | Low | Yes | No session in delete | None |
| test_delete_artifacts_sync_rollback_on_error | Test _delete_artifacts_sync rolls back on error | ArtifactStore._delete_artifacts_sync() with delete error | _delete_artifacts_sync() | pipe_instance, _FailingSession | pytest.raises, rollback called | High | Yes | Delete rollback on error | None |
| test_delete_artifacts_empty_refs | Test _delete_artifacts returns early for empty refs | ArtifactStore._delete_artifacts() with empty list | _delete_artifacts() | pipe_instance, Mock | No executor call | Low | Yes | Empty refs handling | None |
| test_delete_artifacts_no_executor | Test _delete_artifacts returns early without executor | ArtifactStore._delete_artifacts() without executor | _delete_artifacts() | pipe_instance | No exception | Low | Yes | No executor in delete | None |
| test_make_db_row_no_chat_id | Test _make_db_row returns None without chat_id | ArtifactStore._make_db_row() without chat_id | _make_db_row() | _install_fake_store | assert None | Low | Yes | Chat ID validation | None |
| test_make_db_row_no_model | Test _make_db_row returns None without model | ArtifactStore._make_db_row() without model | _make_db_row() | pipe_instance | assert None | Low | Yes | Model validation | None |
| test_make_db_row_invalid_payload | Test _make_db_row returns None for non-dict payload | ArtifactStore._make_db_row() with string payload | _make_db_row() | _install_fake_store | assert None | Low | Yes | Payload type validation | None |
| test_make_db_row_valid | Test _make_db_row returns valid row dict | ArtifactStore._make_db_row() with valid inputs | _make_db_row() | _install_fake_store | assert all fields present | Medium | Yes | Valid row creation | None |
| test_prepare_rows_empty | Test _prepare_rows_for_storage with empty rows | ArtifactStore._prepare_rows_for_storage() with [] | _prepare_rows_for_storage() | pipe_instance | No exception | Low | Yes | Empty rows handling | None |
| test_prepare_rows_non_dict_items | Test _prepare_rows_for_storage skips non-dict items | ArtifactStore._prepare_rows_for_storage() with invalid items | _prepare_rows_for_storage() | pipe_instance | No exception | Low | Yes | Non-dict item filtering | None |
| test_prepare_rows_encrypted_adds_enc_v | Test _prepare_rows_for_storage adds enc_v to encrypted rows | ArtifactStore._prepare_rows_for_storage() with encrypted | _prepare_rows_for_storage() | pipe_instance | assert enc_v added | Medium | Yes | Encryption version tagging | None |
| test_prepare_rows_encrypts_reasoning | Test _prepare_rows_for_storage encrypts reasoning items | ArtifactStore._prepare_rows_for_storage() with reasoning | _prepare_rows_for_storage() | pipe_instance | assert encrypted, has ciphertext | High | Yes | Reasoning encryption during prep | None |
| test_artifact_cleanup_worker_exception_handling | Test _artifact_cleanup_worker handles exceptions and logs them | ArtifactStore._artifact_cleanup_worker() with errors | _artifact_cleanup_worker() | pipe_instance, monkeypatch, caplog | assert warning logged | Medium | Yes | Cleanup worker error handling | None |
| test_db_persist_direct_no_executor | Test _db_persist_direct returns empty without executor | ArtifactStore._db_persist_direct() without executor | _db_persist_direct() | pipe_instance | assert result == [] | Low | Yes | No executor in persist | None |
| test_db_persist_direct_no_model | Test _db_persist_direct returns empty without model | ArtifactStore._db_persist_direct() without model | _db_persist_direct() | pipe_instance, ThreadPoolExecutor | assert result == [] | Low | Yes | No model in persist | None |
| test_db_persist_direct_caches_in_redis | Test _db_persist_direct caches in Redis when enabled | ArtifactStore._db_persist_direct() with Redis | _db_persist_direct() | _install_fake_store, mock cache | assert rows cached | High | Yes | Redis caching after persist | None |
| test_db_persist_direct_resets_failure | Test _db_persist_direct resets failure counter on success | ArtifactStore._db_persist_direct() with success | _db_persist_direct() | _install_fake_store, mock reset | assert reset called | Medium | Yes | Failure counter reset | None |
| test_discover_engine_and_schema_from_get_db_context | Test discovery from get_db_context with get_bind | ArtifactStore._discover_owui_engine_and_schema() | _discover_owui_engine_and_schema() | pipe_instance, _Session with get_bind | assert engine and schema correct | High | Yes | Engine from context manager | None |
| test_init_artifact_store_with_sqlite | Test artifact store initialization with SQLite | ArtifactStore._init_artifact_store() with SQLite | _init_artifact_store() | pipe_instance, _install_internal_db | assert model, session, table name set | High | Yes | SQLite initialization | None |
| test_maybe_heal_index_conflict_drops_indexes | Test index conflict healing drops and recreates indexes | ArtifactStore._maybe_heal_index_conflict() full flow | _maybe_heal_index_conflict() | pipe_instance, _DummyTable, _DummyEngine | assert True, statements executed | High | Yes | Index conflict resolution | None |
| test_db_persist_and_fetch_roundtrip | Test persist and fetch roundtrip | ArtifactStore persist/fetch cycle | _db_persist_sync(), _db_fetch_sync() | _install_fake_store | assert fetched data matches | High | Yes | Persist/fetch integration | None |
| test_db_persist_direct_and_fetch_async | Test async persist and fetch | ArtifactStore async persist/fetch | _db_persist(), _db_fetch() | _install_fake_store | assert fetched data matches | High | Yes | Async persist/fetch integration | None |
| test_delete_and_cleanup_paths | Test delete and cleanup operations | ArtifactStore delete and cleanup | _cleanup_sync(), _delete_artifacts() | _install_fake_store, _FakeModel | assert old deleted, recent kept, manual delete works | High | Yes | Delete and cleanup integration | None |
| test_duplicate_key_detection | Test duplicate key error detection | ArtifactStore._is_duplicate_key_error() | _is_duplicate_key_error() | pipe_instance | assert True/False for various errors | Medium | Yes | Duplicate key detection | None |
| test_redis_enqueue_cache_and_fetch | Test Redis enqueue, cache, and fetch | ArtifactStore Redis operations | _redis_enqueue_rows(), _redis_fetch_rows() | _install_fake_store, _FakeRedis | assert fetched data matches | High | Yes | Redis enqueue/fetch integration | None |
| test_redis_flush_queue_and_pubsub | Test Redis queue flush and pubsub | ArtifactStore Redis flush and listener | _flush_redis_queue(), _redis_pubsub_listener() | _install_fake_store, _FakeRedis, caplog | assert items persisted, invalid items logged | High | Yes | Redis queue processing | None |
| test_redis_periodic_flusher_exits | Test Redis periodic flusher exits cleanly | ArtifactStore._redis_periodic_flusher() | _redis_periodic_flusher() | _install_fake_store, _FakeRedis, monkeypatch | No exception, exits on disable | Medium | Yes | Periodic flusher lifecycle | None |
| test_encode_crockford_rejects_negative_value | Test Crockford encoding rejects negative values | persistence_mod._encode_crockford() | _encode_crockford() | None | pytest.raises ValueError | Low | Yes | Negative value validation | None |
| test_sanitize_table_fragment_truncates_and_normalizes | Test table fragment sanitization | persistence_mod._sanitize_table_fragment() | _sanitize_table_fragment() | None | assert length limit, lowercase, alphanumeric | Medium | Yes | Table name sanitization | None |
| test_wait_for_handles_sync_and_async | Test _wait_for utility for sync and async | persistence_mod._wait_for() | _wait_for() | None | assert handles both types | Medium | Yes | Async utility function | None |
| test_decode_payload_bytes_invalid_flag_and_json | Test payload decoding with invalid flag and JSON | ArtifactStore._decode_payload_bytes() | _decode_payload_bytes() | pipe_instance | pytest.raises ValueError for both | Medium | Yes | Invalid payload validation | None |
| test_lz4_decompress_missing_module_raises | Test LZ4 decompression without module | ArtifactStore._lz4_decompress() | _lz4_decompress() | pipe_instance, monkeypatch | assert empty ok, pytest.raises for data | Medium | Yes | LZ4 module check | None |
| test_prepare_rows_for_storage_sets_enc_v | Test encryption version setting during row prep | ArtifactStore._prepare_rows_for_storage() | _prepare_rows_for_storage() | pipe_instance | assert enc_v set, non-dict skipped | Medium | Yes | Encryption version handling | None |
| test_make_db_row_missing_message_id_warns | Test _make_db_row warns on missing message_id | ArtifactStore._make_db_row() without message_id | _make_db_row() | _install_fake_store, caplog | assert None, warning logged | Medium | Yes | Message ID validation | None |
| test_db_persist_sync_returns_existing_ids | Test _db_persist_sync returns IDs for already-persisted rows | ArtifactStore._db_persist_sync() with _persisted flag | _db_persist_sync() | _install_fake_store | assert existing IDs returned, flag removed | High | Yes | Already-persisted handling | None |
| test_db_persist_sync_skips_missing_payload | Test _db_persist_sync skips rows with missing payload | ArtifactStore._db_persist_sync() with None payload | _db_persist_sync() | _install_fake_store, caplog | assert result empty, warning logged | Medium | Yes | Missing payload validation | None |
| test_db_persist_skips_when_breaker_open | Test _db_persist skips when circuit breaker is open | ArtifactStore._db_persist() with breaker open | _db_persist() | _install_fake_store, monkeypatch | assert empty result, failure recorded | High | Yes | Circuit breaker integration | None |
| test_db_persist_records_failure_on_exception | Test _db_persist records failure on exception | ArtifactStore._db_persist() with Redis error | _db_persist() | _install_fake_store, monkeypatch | assert empty result, failure recorded | High | Yes | Exception failure recording | None |
| test_db_persist_direct_duplicate_key_returns_ids | Test _db_persist_direct returns IDs on duplicate key | ArtifactStore._db_persist_direct() with duplicate error | _db_persist_direct() | _install_fake_store, monkeypatch | assert IDs returned | High | Yes | Duplicate key handling | None |
| test_db_fetch_breaker_disables_reads | Test _db_fetch skips when circuit breaker is open | ArtifactStore._db_fetch() with breaker open | _db_fetch() | _install_fake_store, monkeypatch | assert empty result, failure recorded | High | Yes | Breaker blocks reads | None |
| test_db_fetch_handles_exception_returns_cache | Test _db_fetch handles exception and returns cache | ArtifactStore._db_fetch() with fetch error | _db_fetch() | _install_fake_store, monkeypatch | assert empty result, failure recorded | High | Yes | Fetch exception handling | None |
| test_delete_artifacts_deletes_redis_cache | Test _delete_artifacts deletes Redis cache entries | ArtifactStore._delete_artifacts() with Redis | _delete_artifacts() | _install_fake_store, _FakeRedis | assert Redis keys deleted | High | Yes | Redis cache invalidation | None |
| test_redis_periodic_flusher_disables_after_failures | Test periodic flusher disables after failure limit | ArtifactStore._redis_periodic_flusher() with failures | _redis_periodic_flusher() | _install_fake_store, _FailingRedis | assert Redis disabled | High | Yes | Failure limit enforcement | None |
| test_flush_redis_queue_skips_without_lock | Test _flush_redis_queue skips when lock not acquired | ArtifactStore._flush_redis_queue() without lock | _flush_redis_queue() | _install_fake_store, _FakeRedis | No exception | Medium | Yes | Lock acquisition check | None |
| test_db_fetch_sync_touches_created_at_best_effort | Test _db_fetch_sync touches created_at during fetch | ArtifactStore._db_fetch_sync() with touch | _db_fetch_sync() | pipe_instance, MagicMock | assert results correct, update called, commit called | High | Yes | Timestamp touch on fetch | None |
| test_db_fetch_sync_touch_failure_never_breaks_read | Test touch failures don't break reads | ArtifactStore._db_fetch_sync() with touch error | _db_fetch_sync() | pipe_instance, MagicMock with failing update | assert results correct, rollback called | High | Yes | Touch failure isolation | None |
| test_normalize_function_call_serializes_arguments_and_ids | Test function call normalization with serialization | _normalize_persisted_item() for function_call | _normalize_persisted_item() | None | assert arguments JSON, status, IDs | Medium | Yes | Function call serialization | None |
| test_normalize_function_call_output_assigns_defaults | Test function call output normalization | _normalize_persisted_item() for function_call_output | _normalize_persisted_item() | None | assert output string, call_id, status | Medium | Yes | Function output defaults | None |
| test_normalize_reasoning_and_file_search_payloads | Test reasoning and search payload normalization | _normalize_persisted_item() for multiple types | _normalize_persisted_item() | None | assert content/summary/queries/action structures | Medium | Yes | Multiple type normalization | None |
| test_classify_function_call_artifacts_identifies_orphans | Test function call artifact classification | _classify_function_call_artifacts() | _classify_function_call_artifacts() | None | assert valid, orphaned calls, orphaned outputs | High | Yes | Artifact pairing logic | None |
| test_dedupe_tools_prefers_latest_definition | Test tool deduplication prefers latest | _dedupe_tools() | _dedupe_tools() | None | assert latest version kept, non-dict skipped | Medium | Yes | Tool deduplication | None |


## `tests/test_streaming_handler.py`

| Test Name | Description | What It Tests | Code Under Test | Mocks/Fixtures | Assertions | Drift Risk | Check Done | Codex Notes | Codex TODO |
|-----------|-------------|---------------|-----------------|----------------|------------|------------|------------|-------------|------------|
| TestStreamingHandlerInit.test_streaming_handler_init_via_pipe | Test StreamingHandler is properly initialized via Pipe | StreamingHandler initialization through Pipe instance | StreamingHandler.__init__ | pipe_instance | handler is not None, handler.logger/valves/_pipe correct | Low | [ ] | Verifies composition pattern | - |
| TestWrapEventEmitter.test_wrap_event_emitter_none_returns_noop | Test wrapping None emitter returns a no-op function | _wrap_event_emitter with None input | _wrap_event_emitter | None | No exceptions raised | Low | [ ] | Edge case for None emitter | - |
| TestWrapEventEmitter.test_wrap_event_emitter_suppress_chat_messages | Test wrapping emitter with chat message suppression | _wrap_event_emitter suppress_chat_messages flag | _wrap_event_emitter | Custom async emitter | len(emitted)==2, types correct | Low | [ ] | Filter logic verification | - |
| TestWrapEventEmitter.test_wrap_event_emitter_suppress_completion | Test wrapping emitter with completion suppression | _wrap_event_emitter suppress_completion flag | _wrap_event_emitter | Custom async emitter | len(emitted)==2, types correct | Low | [ ] | Filter logic verification | - |
| TestWrapEventEmitter.test_wrap_event_emitter_suppress_both | Test wrapping emitter with both suppressions | _wrap_event_emitter both flags enabled | _wrap_event_emitter | Custom async emitter | len(emitted)==1, only status | Low | [ ] | Combined filter logic | - |
| TestEndpointSelection.test_select_llm_endpoint_default_responses | Test default endpoint selection returns responses | _select_llm_endpoint default behavior | Pipe._select_llm_endpoint | pipe_instance | result=="responses" | Low | [ ] | Default config validation | - |
| TestEndpointSelection.test_select_llm_endpoint_force_chat_completions | Test endpoint selection with FORCE_CHAT_COMPLETIONS_MODELS | _select_llm_endpoint with force chat completions | Pipe._select_llm_endpoint | pipe_instance | result=="chat_completions" | Medium | [ ] | Valve override logic | - |
| TestEndpointSelection.test_select_llm_endpoint_force_responses | Test endpoint selection with FORCE_RESPONSES_MODELS | _select_llm_endpoint with force responses | Pipe._select_llm_endpoint | pipe_instance | result=="responses" | Medium | [ ] | Valve override logic | - |
| TestEndpointSelection.test_select_llm_endpoint_with_forced_flag | Test _select_llm_endpoint_with_forced returns forced flag | _select_llm_endpoint_with_forced return tuple | Pipe._select_llm_endpoint_with_forced | pipe_instance | endpoint and forced flag correct | Low | [ ] | Return value structure | - |
| TestEndpointSelection.test_select_llm_endpoint_default_chat_completions | Test endpoint selection with DEFAULT_LLM_ENDPOINT=chat_completions | _select_llm_endpoint default override | Pipe._select_llm_endpoint | pipe_instance | result=="chat_completions" | Low | [ ] | Default endpoint valve | - |
| TestEndpointSelection.test_select_llm_endpoint_debug_logging_responses | Test debug logging for endpoint selection (responses) | Debug logging behavior | Pipe._select_llm_endpoint | pipe_instance, caplog | result in valid values | Low | [ ] | Logging verification | - |
| TestEndpointSelection.test_select_llm_endpoint_debug_logging_chat | Test debug logging for endpoint selection (chat_completions) | Debug logging with chat endpoint | Pipe._select_llm_endpoint | pipe_instance, caplog | result=="chat_completions" | Low | [ ] | Logging verification | - |
| TestLooksLikeResponsesUnsupported.test_looks_like_responses_unsupported_with_code | Test detecting unsupported responses from error code | _looks_like_responses_unsupported code detection | StreamingHandler._looks_like_responses_unsupported | OpenRouterAPIError | returns True | Low | [ ] | Error code pattern | - |
| TestLooksLikeResponsesUnsupported.test_looks_like_responses_unsupported_message_patterns | Test detecting unsupported responses from error messages | _looks_like_responses_unsupported message patterns | StreamingHandler._looks_like_responses_unsupported | OpenRouterAPIError | returns True for all patterns | Medium | [ ] | Multiple message patterns | - |
| TestLooksLikeResponsesUnsupported.test_looks_like_responses_unsupported_false_for_other_errors | Test that unrelated errors return False | _looks_like_responses_unsupported negative cases | StreamingHandler._looks_like_responses_unsupported | OpenRouterAPIError | returns False | Low | [ ] | False positive prevention | - |
| TestLooksLikeResponsesUnsupported.test_looks_like_responses_unsupported_non_api_error | Test with non-OpenRouterAPIError exception | _looks_like_responses_unsupported with non-API errors | StreamingHandler._looks_like_responses_unsupported | ValueError, CustomError | returns False/True appropriately | Low | [ ] | Exception type handling | - |
| TestLooksLikeResponsesUnsupported.test_looks_like_responses_unsupported_chat_completions_pattern | Test detection of chat/completions pattern in error | _looks_like_responses_unsupported chat pattern | StreamingHandler._looks_like_responses_unsupported | OpenRouterAPIError | returns True | Low | [ ] | Specific pattern detection | - |
| TestLooksLikeResponsesUnsupported.test_looks_like_responses_unsupported_no_response_keyword | Test returns False when no response keyword in message | _looks_like_responses_unsupported keyword check | StreamingHandler._looks_like_responses_unsupported | OpenRouterAPIError | returns False | Low | [ ] | Keyword guard | - |
| TestLooksLikeResponsesUnsupported.test_looks_like_responses_unsupported_xai_pattern | Test detection of xai-responses-v1 pattern | _looks_like_responses_unsupported xai pattern | StreamingHandler._looks_like_responses_unsupported | OpenRouterAPIError | returns True | Low | [ ] | Provider-specific pattern | - |
| TestLooksLikeResponsesUnsupported.test_looks_like_responses_unsupported_non_api_error_with_attrs | Test non-OpenRouterAPIError with response-related attributes | _looks_like_responses_unsupported with custom attrs | StreamingHandler._looks_like_responses_unsupported | CustomError with attrs | returns True | Low | [ ] | Attribute-based detection | - |
| TestLooksLikeResponsesUnsupported.test_looks_like_responses_unsupported_endpoint_not_supported_code | Test detection of endpoint_not_supported code | _looks_like_responses_unsupported code pattern | StreamingHandler._looks_like_responses_unsupported | OpenRouterAPIError | returns True | Low | [ ] | Error code pattern | - |
| TestLooksLikeResponsesUnsupported.test_looks_like_responses_unsupported_responses_not_supported_code | Test detection of responses_not_supported code | _looks_like_responses_unsupported code pattern | StreamingHandler._looks_like_responses_unsupported | OpenRouterAPIError | returns True | Low | [ ] | Error code pattern | - |
| TestStreamingLoopBasic.test_streaming_loop_session_required | Test that streaming loop requires a session | _run_streaming_loop session validation | Pipe._run_streaming_loop | pipe_instance_async | raises RuntimeError | Low | [ ] | Input validation | - |
| TestStreamingLoopBasic.test_streaming_loop_metadata_coerced_to_dict | Test that non-dict metadata is coerced to empty dict | _run_streaming_loop metadata handling | Pipe._run_streaming_loop | monkeypatch, pipe_instance_async | result=="Hello" | Low | [ ] | Defensive coding | - |
| TestStreamingLoopBasic.test_streaming_loop_no_final_response_emits_error | Test streaming loop emits error when no final response | _run_streaming_loop error handling | Pipe._run_streaming_loop | monkeypatch, pipe_instance_async, caplog | Error logged | Low | [ ] | Error recovery | - |
| TestPersistReasoning.test_cleanup_replayed_reasoning_next_reply | Test _cleanup_replayed_reasoning with next_reply mode | Replayed reasoning cleanup | Pipe._cleanup_replayed_reasoning | monkeypatch, pipe_instance_async | Refs deleted | Low | [ ] | Cleanup logic | - |
| TestPersistReasoning.test_cleanup_replayed_reasoning_conversation_mode_skips | Test _cleanup_replayed_reasoning skips in conversation mode | Conversation mode skip | Pipe._cleanup_replayed_reasoning | monkeypatch, pipe_instance_async | No deletion | Low | [ ] | Mode-based behavior | - |
| TestAPIErrorHandling.test_openrouter_api_error_handling | Test handling of OpenRouterAPIError during streaming | Error handling mid-stream | Pipe._run_streaming_loop | monkeypatch, pipe_instance_async | result=="" | Medium | [ ] | Error recovery | - |
| TestLoopLimitAndFunctionExecution.test_loop_limit_reached | Test behavior when MAX_FUNCTION_CALL_LOOPS limit is reached | Loop limit enforcement | Pipe._run_streaming_loop | monkeypatch, pipe_instance_async | Limit notification | Medium | [ ] | Safety limit | - |
| TestLoopLimitAndFunctionExecution.test_function_execution_with_persist_tools | Test function execution with PERSIST_TOOL_RESULTS enabled | Tool persistence | Pipe._run_streaming_loop | monkeypatch, pipe_instance_async | Tool results persisted | Medium | [ ] | Persistence integration | - |
| TestValidateBase64Size.test_validate_base64_size_method_on_pipe | Test _validate_base64_size method on Pipe class | Base64 size validation | Pipe._validate_base64_size | pipe_instance | Returns bool | Low | [ ] | Size validation | - |
| TestFinalStatus.test_final_status_with_stream_window | Test final status includes stream window timing | Final status emission | Pipe._run_streaming_loop | monkeypatch, pipe_instance_async | Final status with done=True | Low | [ ] | Status completion | - |
| TestResponseOutputEdgeCases.test_response_output_with_non_dict_items | Test handling of non-dict items in response output | Non-dict output handling | Pipe._run_streaming_loop | monkeypatch, pipe_instance_async | result=="Hello" | Low | [ ] | Defensive coding | - |
| TestResponseOutputEdgeCases.test_response_output_wrong_role | Test response output with wrong role is skipped | Role filtering | Pipe._run_streaming_loop | monkeypatch, pipe_instance_async | result=="Hello" | Low | [ ] | Role validation | - |
| test_queue_valves_unbounded_defaults | Verify unbounded (0) defaults prevent deadlock | Queue valve defaults | Pipe.valves | pipe_instance | Defaults are 0 | Low | [ ] | Deadlock prevention | - |
| test_valve_descriptions_warn_deadlock | Verify valve descriptions document deadlock risks | Valve documentation | Pipe.Valves.model_fields | pipe_instance | Descriptions contain deadlock | Low | [ ] | Documentation verification | - |
| test_warn_condition_logic[0-1000-30-False] | Test drain loop warning condition matches implementation | _should_warn_event_queue_backlog | Pipe._should_warn_event_queue_backlog | Parametrized values | Expected warning result | Low | [ ] | Warning logic | - |
| test_warn_condition_logic[1000-100-30-True] | Test drain loop warning condition matches implementation | _should_warn_event_queue_backlog | Pipe._should_warn_event_queue_backlog | Parametrized values | Expected warning result | Low | [ ] | Warning logic | - |
| test_warn_condition_logic[1000-1000-0-False] | Test drain loop warning condition matches implementation | _should_warn_event_queue_backlog | Pipe._should_warn_event_queue_backlog | Parametrized values | Expected warning result | Low | [ ] | Warning logic | - |
| test_warn_condition_logic[1000-1000-29.9-False] | Test drain loop warning condition matches implementation | _should_warn_event_queue_backlog | Pipe._should_warn_event_queue_backlog | Parametrized values | Expected warning result | Low | [ ] | Warning logic | - |
| test_warn_condition_logic[1000-1000-30.0-True] | Test drain loop warning condition matches implementation | _should_warn_event_queue_backlog | Pipe._should_warn_event_queue_backlog | Parametrized values | Expected warning result | Low | [ ] | Warning logic | - |
| test_warn_condition_logic[1000-1000-60-True] | Test drain loop warning condition matches implementation | _should_warn_event_queue_backlog | Pipe._should_warn_event_queue_backlog | Parametrized values | Expected warning result | Low | [ ] | Warning logic | - |
| test_warn_condition_logic[1200-1000-0-False] | Test drain loop warning condition matches implementation | _should_warn_event_queue_backlog | Pipe._should_warn_event_queue_backlog | Parametrized values | Expected warning result | Low | [ ] | Warning logic | - |
| test_warn_condition_logic[1200-1000-100-True] | Test drain loop warning condition matches implementation | _should_warn_event_queue_backlog | Pipe._should_warn_event_queue_backlog | Parametrized values | Expected warning result | Low | [ ] | Warning logic | - |
| test_warn_condition_logic[1200-1000-29-False] | Test drain loop warning condition matches implementation | _should_warn_event_queue_backlog | Pipe._should_warn_event_queue_backlog | Parametrized values | Expected warning result | Low | [ ] | Warning logic | - |
| test_warn_condition_logic[1200-1000-30-True] | Test drain loop warning condition matches implementation | _should_warn_event_queue_backlog | Pipe._should_warn_event_queue_backlog | Parametrized values | Expected warning result | Low | [ ] | Warning logic | - |
| test_warn_condition_logic[5000-1000-30-True] | Test drain loop warning condition matches implementation | _should_warn_event_queue_backlog | Pipe._should_warn_event_queue_backlog | Parametrized values | Expected warning result | Low | [ ] | Warning logic | - |
| test_warn_condition_logic[999-1000-0-False] | Test drain loop warning condition matches implementation | _should_warn_event_queue_backlog | Pipe._should_warn_event_queue_backlog | Parametrized values | Expected warning result | Low | [ ] | Warning logic | - |
| test_warn_condition_logic[999-1000-30-False] | Test drain loop warning condition matches implementation | _should_warn_event_queue_backlog | Pipe._should_warn_event_queue_backlog | Parametrized values | Expected warning result | Low | [ ] | Warning logic | - |
| test_warn_condition_logic[999-1000-60-False] | Test drain loop warning condition matches implementation | _should_warn_event_queue_backlog | Pipe._should_warn_event_queue_backlog | Parametrized values | Expected warning result | Low | [ ] | Warning logic | - |
| test_queue_valve_constraints | Verify valve constraints allow unbounded and bounded configurations | Valve metadata constraints | Pipe.Valves.model_fields | None | ge=0 constraints | Low | [ ] | Pydantic validation | - |
| test_valve_accepts_various_queue_sizes[0-0] | Verify valves accept various queue size configurations | Queue size acceptance | Pipe.valves | pipe_instance | Values accepted | Low | [ ] | Configuration flexibility | - |
| test_valve_accepts_various_queue_sizes[100-200] | Verify valves accept various queue size configurations | Queue size acceptance | Pipe.valves | pipe_instance | Values accepted | Low | [ ] | Configuration flexibility | - |
| test_valve_accepts_various_queue_sizes[1000-1000] | Verify valves accept various queue size configurations | Queue size acceptance | Pipe.valves | pipe_instance | Values accepted | Low | [ ] | Configuration flexibility | - |
| test_valve_accepts_various_queue_sizes[50-50] | Verify valves accept various queue size configurations | Queue size acceptance | Pipe.valves | pipe_instance | Values accepted | Low | [ ] | Configuration flexibility | - |
| test_warning_cooldown_prevents_spam | Verify 30-second cooldown prevents log spam | Warning cooldown | Pipe._should_warn_event_queue_backlog | None | [30.0,60.0,90.0] | Low | [ ] | Spam prevention | - |
| test_unbounded_queue_semantics | Document that maxsize=0 means unbounded in asyncio.Queue | Queue semantics | asyncio.Queue | None | maxsize==0 unbounded | Low | [ ] | API documentation | - |
| test_warning_size_minimum[1000] | Verify warning size minimum prevents spam on normal loads | Warning minimum | Pipe.valves | pipe_instance | Values >=100 | Low | [ ] | Spam prevention | - |
| test_warning_size_minimum[100] | Verify warning size minimum prevents spam on normal loads | Warning minimum | Pipe.valves | pipe_instance | Values >=100 | Low | [ ] | Spam prevention | - |
| test_warning_size_minimum[5000] | Verify warning size minimum prevents spam on normal loads | Warning minimum | Pipe.valves | pipe_instance | Values >=100 | Low | [ ] | Spam prevention | - |
| test_warning_size_minimum[500] | Verify warning size minimum prevents spam on normal loads | Warning minimum | Pipe.valves | pipe_instance | Values >=100 | Low | [ ] | Spam prevention | - |
| test_completion_events_preserve_streamed_text | Verify completion events preserve streamed text | Completion content preservation | Pipe._run_streaming_loop | monkeypatch, pipe_instance_async | output=="Hello world" | Low | [ ] | Content integrity | - |
| test_streaming_loop_handles_openrouter_errors | Test that OpenRouter errors are reported via real _report_openrouter_error | Error reporting | Pipe._run_streaming_loop | monkeypatch, pipe_instance_async | Status events with error | Medium | [ ] | Error path | - |
| test_streaming_loop_reasoning_status_and_tools | Test reasoning status updates and tool execution | Combined reasoning and tools | Pipe._run_streaming_loop | monkeypatch, pipe_instance_async | Reasoning persisted | High | [ ] | Complex integration | - |
| test_pipe_stream_mode_outputs_openai_reasoning_chunks | Test reasoning events in open_webui mode | Open WebUI reasoning | Pipe._run_streaming_loop | monkeypatch, pipe_instance_async | reasoning:delta events | Medium | [ ] | Thinking box | - |
| test_thinking_output_mode_open_webui_suppresses_thinking_status | Test open_webui mode suppresses thinking status | Status suppression | Pipe._run_streaming_loop | monkeypatch, pipe_instance_async | reasoning:delta, no status text | Medium | [ ] | Mode differentiation | - |
| test_thinking_output_mode_status_suppresses_reasoning_events | Test status mode suppresses reasoning events | Reasoning suppression | Pipe._run_streaming_loop | monkeypatch, pipe_instance_async | No reasoning:delta, status text | Medium | [ ] | Mode differentiation | - |
| test_reasoning_summary_only_streams_to_reasoning_box_in_open_webui_mode | Test reasoning summary streams to reasoning box | Summary streaming | Pipe._run_streaming_loop | monkeypatch, pipe_instance_async | reasoning:delta, completed | Medium | [ ] | Summary handling | - |
| test_reasoning_summary_part_done_does_not_replay_after_incremental | Test reasoning summary part done not replayed | Incremental dedup | Pipe._run_streaming_loop | monkeypatch, pipe_instance_async | Single delta | Medium | [ ] | Deduplication | - |
| test_reasoning_done_snapshots_do_not_replay_after_delta | Test reasoning done snapshots not replayed | Snapshot dedup | Pipe._run_streaming_loop | monkeypatch, pipe_instance_async | Single delta | Medium | [ ] | Deduplication | - |
| test_function_call_status_invalid_json_arguments_does_not_crash | Test function call with invalid JSON arguments | Invalid JSON handling | Pipe._run_streaming_loop | monkeypatch, pipe_instance_async | result=="OK" | Medium | [ ] | Error handling | - |
| test_legacy_tool_execution_invalid_arguments_returns_failed_output | Test legacy tool execution with invalid arguments | Legacy tool error | Pipe._execute_function_calls_legacy | pipe_instance_async | Invalid arguments in output | Low | [ ] | Error propagation | - |
| test_anthropic_interleaved_thinking_header_applied | Test Anthropic interleaved thinking header | Beta header application | Pipe._maybe_apply_anthropic_beta_headers | pipe_instance | Header present/absent | Low | [ ] | Provider-specific | - |
| test_function_call_loop_limit_emits_warning | Test function call loop limit warning | Loop limit notification | Pipe._run_streaming_loop | monkeypatch, pipe_instance_async | Notification emitted | Medium | [ ] | User notification | - |
| test_unbounded_queue_handles_large_event_burst | Verify unbounded queues handle 10K events without deadlock | Queue stress test | Pipe._run_streaming_loop | monkeypatch | len(result)>0, events>0 | Low | [ ] | Stress testing | - |
| test_bounded_queue_configuration_affects_streaming | Verify bounded queue configuration is used | Queue config | Pipe._run_streaming_loop | monkeypatch | Streaming succeeds | Low | [ ] | Config application | - |
| test_event_queue_backlog_warning_triggers_during_streaming | Verify backlog warnings during actual streaming | Warning emission | Pipe._run_streaming_loop | monkeypatch | Streaming completes | Low | [ ] | Warning path | - |
| test_queue_handles_rapid_start_stop_cycles | Verify queues handle multiple rapid streaming cycles | Lifecycle test | Pipe._run_streaming_loop | monkeypatch | 5 cycles succeed | Low | [ ] | Resource cleanup | - |
| test_middleware_stream_queue_valves_defaults | Test middleware stream queue valve defaults | Valve defaults | Pipe.valves | pipe_instance | Defaults correct | Low | [ ] | Configuration | - |
| test_try_put_middleware_stream_nowait_does_not_raise_when_full | Test try_put_nowait doesn't raise when full | Queue overflow handling | Pipe._try_put_middleware_stream_nowait | pipe_instance_async | No exception | Low | [ ] | Graceful degradation | - |
| test_put_middleware_stream_item_times_out_when_full | Test put_middleware_stream_item times out | Timeout handling | Pipe._put_middleware_stream_item | pipe_instance_async | raises TimeoutError | Low | [ ] | Timeout enforcement | - |
| TestStreamingCoreAdditionalCoverage.test_reasoning_status_idle_seconds_trigger | Test reasoning status emits after idle seconds | Idle timeout | Pipe._run_streaming_loop | monkeypatch, pipe_instance_async | Thinking status | Low | [ ] | Timing logic | - |
| TestStreamingCoreAdditionalCoverage.test_materialize_image_with_storage_context | Test image materialization with storage context | Image storage | Pipe._run_streaming_loop | monkeypatch, pipe_instance_async | Image in result | Medium | [ ] | Storage integration | - |
| TestStreamingCoreAdditionalCoverage.test_materialize_image_data_url_with_storage | Test image materialization from data URL | Data URL processing | Pipe._run_streaming_loop | monkeypatch, pipe_instance_async | result is not None | Medium | [ ] | Data URL handling | - |
| TestStreamingCoreAdditionalCoverage.test_materialize_image_from_str_http_url | Test image returns HTTP URLs directly | URL passthrough | Pipe._run_streaming_loop | monkeypatch, pipe_instance_async | URL in result | Low | [ ] | URL handling | - |
| TestStreamingCoreAdditionalCoverage.test_materialize_image_entry_nested_url | Test image entry with nested URL dict | Nested structure | Pipe._run_streaming_loop | monkeypatch, pipe_instance_async | nested URL in result | Low | [ ] | Structure handling | - |
| TestStreamingCoreAdditionalCoverage.test_materialize_image_jpg_mime_conversion | Test image materialization converts jpg to jpeg | MIME conversion | Pipe._run_streaming_loop | monkeypatch, pipe_instance_async | result is not None | Low | [ ] | MIME handling | - |
| TestStreamingCoreAdditionalCoverage.test_append_output_block_ends_with_newline | Test _append_output_block adds proper newlines | Output formatting | Pipe._run_streaming_loop | monkeypatch, pipe_instance_async | Content in result | Low | [ ] | Formatting | - |
| TestStreamingCoreAdditionalCoverage.test_extract_reasoning_from_non_dict_event | Test _extract_reasoning_text handles non-dict | Non-dict guard | Pipe._run_streaming_loop | monkeypatch, pipe_instance_async | result=="Done." | Low | [ ] | Defensive coding | - |
| TestStreamingCoreAdditionalCoverage.test_extract_reasoning_from_item_non_dict | Test _extract_reasoning_text_from_item with non-dict | Non-dict content | Pipe._run_streaming_loop | monkeypatch, pipe_instance_async | result=="Done." | Low | [ ] | Defensive coding | - |
| TestStreamingCoreAdditionalCoverage.test_append_reasoning_empty_candidate | Test _append_reasoning_text with empty string | Empty handling | Pipe._run_streaming_loop | monkeypatch, pipe_instance_async | Real thought in deltas | Low | [ ] | Empty guard | - |
| TestStreamingCoreAdditionalCoverage.test_append_reasoning_current_starts_with_candidate | Test _append_reasoning_text when current starts with candidate | Cumulative reasoning | Pipe._run_streaming_loop | monkeypatch, pipe_instance_async | result=="Done." | Low | [ ] | Cumulative handling | - |
| TestStreamingCoreAdditionalCoverage.test_tool_call_arguments_delta_empty | Test tool call arguments delta with empty delta | Empty delta | Pipe._run_streaming_loop | monkeypatch, pipe_instance_async | tool_calls events | Low | [ ] | Empty handling | - |
| TestStreamingCoreAdditionalCoverage.test_tool_call_arguments_done_no_suffix_computed | Test arguments.done with non-computable suffix | Suffix computation | Pipe._run_streaming_loop | monkeypatch, pipe_instance_async | tool_calls events | Low | [ ] | Edge case | - |
| TestStreamingCoreAdditionalCoverage.test_message_type_item_skipped | Test message type output items are skipped | Item filtering | Pipe._run_streaming_loop | monkeypatch, pipe_instance_async | result=="World" | Low | [ ] | Type filtering | - |
| TestStreamingCoreAdditionalCoverage.test_function_call_raw_arguments_str | Test function call with raw_text else branch | Non-string args | Pipe._run_streaming_loop | monkeypatch, pipe_instance_async, caplog | result is not None | Low | [ ] | Type conversion | - |
| TestStreamingCoreAdditionalCoverage.test_web_search_open_page_url_only | Test web search open_page with URL only | URL-only open_page | Pipe._run_streaming_loop | monkeypatch, pipe_instance_async | Status with URL | Low | [ ] | Partial data | - |
| TestStreamingCoreAdditionalCoverage.test_web_search_open_page_title_only | Test web search open_page with title only | Title-only open_page | Pipe._run_streaming_loop | monkeypatch, pipe_instance_async | Status with title | Low | [ ] | Partial data | - |
| TestStreamingCoreAdditionalCoverage.test_tool_passthrough_exception_handling | Test tool passthrough exception path | Exception logging | Pipe._run_streaming_loop | monkeypatch, pipe_instance_async, caplog | Code path runs | Medium | [ ] | Error handling | - |
| TestStreamingCoreAdditionalCoverage.test_nonstreaming_tool_calls_response_exception | Test non-streaming tool_calls response build exception | Exception handling | Pipe._run_nonstreaming_loop | monkeypatch, pipe_instance_async, caplog | isinstance(result, dict) | Medium | [ ] | Error handling | - |
| TestStreamingCoreAdditionalCoverage.test_loop_limit_error_template_fallback | Test loop limit reached with error template fallback | Template fallback | Pipe._run_streaming_loop | monkeypatch, pipe_instance_async | limit in result | Medium | [ ] | Fallback logic | - |
| TestStreamingCoreAdditionalCoverage.test_session_log_cancelled_status | Test session log with cancelled status | Cancelled handling | Pipe._run_streaming_loop | monkeypatch, pipe_instance_async | raises CancelledError | Medium | [ ] | Cancellation | - |
| TestStreamingCoreAdditionalCoverage.test_session_log_persist_exception | Test session log persist exception handling | Persist failure | Pipe._run_streaming_loop | monkeypatch, pipe_instance_async, caplog | result=="Hello" | Medium | [ ] | Error recovery | - |
| TestStreamingCoreAdditionalCoverage.test_chats_citation_persistence_exception | Test Chats citation persistence exception | Citation error | Pipe._run_streaming_loop | monkeypatch, pipe_instance_async, caplog | result=="Hello" | Medium | [ ] | Error recovery | - |
| TestStreamingCoreAdditionalCoverage.test_assistant_annotations_persistence | Test assistant annotations extraction and persistence | Annotations persist | Pipe._run_streaming_loop | monkeypatch, pipe_instance_async | result=="Hello" | Medium | [ ] | Persistence | - |
| TestStreamingCoreAdditionalCoverage.test_assistant_reasoning_details_persistence | Test reasoning_details extraction and persistence | Reasoning persist | Pipe._run_streaming_loop | monkeypatch, pipe_instance_async | result=="Hello" | Medium | [ ] | Persistence | - |
| TestStreamingCoreAdditionalCoverage.test_reasoning_details_persistence_exception | Test reasoning_details persistence exception handling | Persist error | Pipe._run_streaming_loop | monkeypatch, pipe_instance_async, caplog | result=="Hello" | Medium | [ ] | Error recovery | - |
| TestStreamingCoreAdditionalCoverage.test_looks_like_responses_unsupported_non_api_error_chat_completions | Test _looks_like_responses_unsupported with non-API error | Chat completions pattern | StreamingHandler._looks_like_responses_unsupported | CustomError | returns True | Low | [ ] | Pattern detection | - |
| TestStreamingCoreAdditionalCoverage.test_looks_like_responses_unsupported_non_api_error_xai_responses | Test _looks_like_responses_unsupported with xai pattern | xai pattern | StreamingHandler._looks_like_responses_unsupported | CustomError | returns True | Low | [ ] | Pattern detection | - |
| TestStreamingCoreAdditionalCoverage.test_looks_like_responses_unsupported_non_api_error_no_response | Test returns False when no response keyword | Keyword guard | StreamingHandler._looks_like_responses_unsupported | CustomError | returns False | Low | [ ] | Guard logic | - |
| TestStreamingCoreAdditionalCoverage.test_persist_tool_normalization_warning | Test warning when normalization returns None | Normalization warning | Pipe._run_streaming_loop | monkeypatch, pipe_instance_async, caplog | Code path runs | Medium | [ ] | Warning path | - |
| TestStreamingCoreAdditionalCoverage.test_materialize_image_validate_base64_size_fails | Test image materialization when base64 validation fails | Size validation | Pipe._run_streaming_loop | monkeypatch, pipe_instance_async | No image in result | Low | [ ] | Validation | - |
| TestStreamingCoreAdditionalCoverage.test_delayed_thinking_task_timeout_path | Test delayed thinking task timeout path | Thinking timeout | Pipe._run_streaming_loop | monkeypatch, pipe_instance_async | result=="Hello" | Low | [ ] | Timeout logic | - |
| TestStreamingCoreAdditionalCoverage.test_tool_call_empty_tool_name | Test tool call with empty tool name is skipped | Empty name skip | Pipe._run_streaming_loop | monkeypatch, pipe_instance_async | No tool_calls | Low | [ ] | Validation | - |
| TestStreamingCoreAdditionalCoverage.test_annotations_persistence_skips_wrong_role | Test annotations not extracted from non-assistant messages | Role filtering | Pipe._run_streaming_loop | monkeypatch, pipe_instance_async | No annotations | Low | [ ] | Role validation | - |
| TestStreamingCoreAdditionalCoverage.test_annotations_persistence_skips_wrong_type | Test annotations extraction skips non-message type | Type filtering | Pipe._run_streaming_loop | monkeypatch, pipe_instance_async | result=="Hello" | Low | [ ] | Type validation | - |
| TestStreamingCoreAdditionalCoverage.test_reasoning_details_skips_non_dict_items | Test reasoning_details extraction skips non-dict | Non-dict skip | Pipe._run_streaming_loop | monkeypatch, pipe_instance_async | result=="Hello" | Low | [ ] | Type validation | - |
| TestStreamingCoreAdditionalCoverage.test_select_llm_endpoint_with_force_chat_completions | Test endpoint selection forces chat_completions | Force endpoint | Pipe._streaming_handler._select_llm_endpoint_with_forced | pipe_instance_async | endpoint correct | Low | [ ] | Config override | - |
| TestStreamingCoreAdditionalCoverage.test_select_llm_endpoint_with_force_responses | Test endpoint selection forces responses | Force responses | Pipe._streaming_handler._select_llm_endpoint_with_forced | pipe_instance_async | endpoint correct | Low | [ ] | Config override | - |
| TestStreamingCoreAdditionalCoverage.test_session_log_with_request_id | Test session log persistence with request_id set | Request ID logging | Pipe._run_streaming_loop | monkeypatch, pipe_instance_async | Logs persisted | Medium | [ ] | Session logging | - |
| TestStreamingCoreAdditionalCoverage.test_session_log_with_tool_passthrough | Test session log with tool passthrough | Tool log path | Pipe._run_streaming_loop | monkeypatch, pipe_instance_async | Logs persisted | Medium | [ ] | Tool logging | - |
| TestStreamingCoreAdditionalCoverage.test_annotations_with_list_and_upsert_call | Test annotations persistence calls upsert | Upsert call | Pipe._run_streaming_loop | monkeypatch, pipe_instance_async | result=="Hello" | Low | [ ] | DB integration | - |
| TestStreamingCoreAdditionalCoverage.test_annotations_persistence_with_exception_emits_notification | Test annotations persistence exception emits notification | Error notification | Pipe._run_streaming_loop | monkeypatch, pipe_instance_async | result=="Hello" | Medium | [ ] | Error handling | - |
| TestStreamingCoreAdditionalCoverage.test_reasoning_details_persistence_with_exception_emits_notification | Test reasoning_details persistence exception emits notification | Error notification | Pipe._run_streaming_loop | monkeypatch, pipe_instance_async | result=="Hello" | Medium | [ ] | Error handling | - |
| TestStreamingCoreAdditionalCoverage.test_looks_like_responses_unsupported_with_not_supported_pattern | Test with not supported pattern | Pattern detection | StreamingHandler._looks_like_responses_unsupported | CustomError | returns True | Low | [ ] | Pattern | - |
| TestStreamingCoreAdditionalCoverage.test_looks_like_responses_unsupported_with_does_not_support | Test with does not support pattern | Pattern detection | StreamingHandler._looks_like_responses_unsupported | CustomError | returns True | Low | [ ] | Pattern | - |
| TestStreamingCoreAdditionalCoverage.test_looks_like_responses_unsupported_with_unsupported | Test with unsupported pattern | Pattern detection | StreamingHandler._looks_like_responses_unsupported | CustomError | returns True | Low | [ ] | Pattern | - |
| TestStreamingCoreAdditionalCoverage.test_looks_like_responses_unsupported_api_error_with_code | Test API error with code | Error code | StreamingHandler._looks_like_responses_unsupported | OpenRouterAPIError | returns True | Low | [ ] | Code detection | - |
| TestStreamingCoreAdditionalCoverage.test_looks_like_responses_unsupported_api_error_message_patterns | Test API error message patterns | Message patterns | StreamingHandler._looks_like_responses_unsupported | OpenRouterAPIError | All return True | Low | [ ] | Multiple patterns | - |
| TestNonAPIErrorResponsesUnsupported.test_non_api_error_with_xai_responses_pattern | Test non-API error with xai-responses-v1 pattern | xai pattern | StreamingHandler._looks_like_responses_unsupported | CustomError | returns True | Low | [ ] | Pattern | - |
| TestNonAPIErrorResponsesUnsupported.test_non_api_error_with_openai_responses_pattern | Test non-API error with openai-responses-v1 pattern | openai pattern | StreamingHandler._looks_like_responses_unsupported | CustomError | returns True | Low | [ ] | Pattern | - |
| TestNonAPIErrorResponsesUnsupported.test_non_api_error_with_chat_completions_pattern | Test non-API error with chat/completions pattern | chat pattern | StreamingHandler._looks_like_responses_unsupported | CustomError | returns True | Low | [ ] | Pattern | - |
| TestNonAPIErrorResponsesUnsupported.test_non_api_error_without_response_keyword | Test non-API error returns False without keyword | Keyword guard | StreamingHandler._looks_like_responses_unsupported | CustomError | returns True | Low | [ ] | Guard | - |
| TestNonAPIErrorResponsesUnsupported.test_non_api_error_no_response_or_responses_keyword | Test non-API error without response/responses keywords | No keyword | StreamingHandler._looks_like_responses_unsupported | CustomError | returns False | Low | [ ] | Guard | - |
| TestNonAPIErrorResponsesUnsupported.test_non_api_error_with_attributes | Test non-API error with openrouter_message attribute | Attribute access | StreamingHandler._looks_like_responses_unsupported | CustomError with attrs | returns True | Low | [ ] | Attribute | - |
| TestToolPassthroughExceptionHandling.test_tool_passthrough_build_payload_exception | Test exception during tool_calls payload building | Exception handling | Pipe._run_streaming_loop | monkeypatch, pipe_instance_async, caplog | Warning logged | Medium | [ ] | Error path | - |
| TestNonStreamingToolPassthroughException.test_nonstreaming_tool_passthrough_build_response_exception | Test exception during non-streaming tool_calls response | Exception handling | Pipe._run_nonstreaming_loop | monkeypatch, pipe_instance_async, caplog | Graceful handling | Medium | [ ] | Error path | - |
| TestPersistToolsNormalizationFailure.test_persist_tools_normalization_returns_none | Test persist tools when normalization returns None | Normalization failure | Pipe._run_streaming_loop | monkeypatch, pipe_instance_async, caplog | result is not None | Medium | [ ] | Failure path | - |
| TestImagePersistenceWithStatusMessages.test_image_generation_data_url_processing | Test image generation with data URL | Data URL image | Pipe._run_streaming_loop | monkeypatch, pipe_instance_async | Image in result | Medium | [ ] | Image handling | - |
| TestImagePersistenceWithStatusMessages.test_image_generation_with_url_result | Test image generation with URL result | URL image | Pipe._run_streaming_loop | monkeypatch, pipe_instance_async | URL in result | Low | [ ] | URL handling | - |
| TestAppendOutputBlockEmpty.test_append_output_block_empty_snippet | Test empty snippet returns current unchanged | Empty handling | Pipe._run_streaming_loop | monkeypatch, pipe_instance_async | result=="Hello" | Low | [ ] | Empty guard | - |
| TestNormalizeSurrogateEmptyCombined.test_surrogate_normalize_empty_combined | Test surrogate normalization returns empty | Empty combined | Pipe._run_streaming_loop | monkeypatch, pipe_instance_async | result=="Hello" | Low | [ ] | Empty handling | - |
| TestExtractReasoningTextNonDict.test_extract_reasoning_text_non_dict | Test reasoning text extraction returns empty for non-dict | Non-dict guard | Pipe._run_streaming_loop | monkeypatch, pipe_instance_async | result=="Done.", deltas | Low | [ ] | Type guard | - |
| TestExtractReasoningTextFromItemNonDict.test_extract_reasoning_text_from_item_non_dict | Test reasoning extraction from non-dict item | Non-dict item | Pipe._run_streaming_loop | monkeypatch, pipe_instance_async | result=="Done." | Low | [ ] | Type guard | - |
| TestAppendReasoningTextEmpty.test_append_reasoning_text_empty_candidate | Test reasoning text append with empty candidate | Empty candidate | Pipe._run_streaming_loop | monkeypatch, pipe_instance_async | result=="Done.", deltas | Low | [ ] | Empty guard | - |
| TestThinkingTasksDelayedStatus.test_thinking_task_model_started_before_timeout | Test thinking task exits early when model_started | Early exit | Pipe._run_streaming_loop | monkeypatch, pipe_instance_async | result=="Hello" | Low | [ ] | Timing | - |
| TestToolPassthroughStreamingFirstDelta.test_tool_passthrough_streaming_first_delta | Test tool passthrough streaming first delta | First delta | Pipe._run_streaming_loop | monkeypatch, pipe_instance_async | tool_calls | Low | [ ] | Delta handling | - |
| TestToolPassthroughNameSent.test_tool_passthrough_name_sent_tracking | Test tool passthrough tracks name_sent | Name tracking | Pipe._run_streaming_loop | monkeypatch, pipe_instance_async | name in first call | Low | [ ] | State tracking | - |
| TestFunctionCallRawTextConversion.test_function_call_non_string_non_json_arguments | Test function call with non-string arguments | Type conversion | Pipe._run_streaming_loop | monkeypatch, pipe_instance_async, caplog | Graceful handling | Low | [ ] | Type handling | - |
| TestMaxFunctionCallLoopsTemplateException.test_max_function_call_loops_with_custom_template | Test max function call loops with template | Custom template | Pipe._run_streaming_loop | monkeypatch, pipe_instance_async | Template rendered | Low | [ ] | Template | - |
| TestSessionLogSegmentPersistException.test_session_log_persist_exception_handled | Test session log persist exception is caught | Exception handling | Pipe._run_streaming_loop | monkeypatch, pipe_instance_async, caplog | result=="Hello" | Medium | [ ] | Error recovery | - |
| TestSegmentStatusCancelled.test_segment_status_cancelled | Test segment_status is set to cancelled | Cancellation | Pipe._run_streaming_loop | monkeypatch, pipe_instance_async | raises CancelledError | Medium | [ ] | Status | - |
| TestSegmentStatusError.test_segment_status_error | Test segment_status is set to error | Error status | Pipe._run_streaming_loop | monkeypatch, pipe_instance_async | result=="" | Medium | [ ] | Status | - |
| TestNonAPIErrorReturningFalse.test_non_api_error_has_response_but_no_pattern_match | Test non-API error with response but no pattern | No pattern | StreamingHandler._looks_like_responses_unsupported | CustomError | returns False | Low | [ ] | Pattern | - |
| TestReasoningStatusReturnEarly.test_reasoning_status_empty_text_returns_early | Test empty reasoning text returns early | Empty text | Pipe._run_streaming_loop | monkeypatch, pipe_instance_async | result=="Done." | Low | [ ] | Early return | - |
| TestNonStreamingToolCallsNonDictItem.test_nonstreaming_tool_calls_non_dict_item_skipped | Test non-dict items skipped in debug logging | Non-dict skip | Pipe._run_nonstreaming_loop | monkeypatch, pipe_instance_async, caplog | Result ok | Low | [ ] | Logging | - |
| TestAnnotationsAndReasoningDetailsExtraction.test_final_response_skips_non_dict_items | Test non-dict items in output skipped | Non-dict skip | Pipe._run_streaming_loop | monkeypatch, pipe_instance_async | result=="Hello" | Low | [ ] | Filtering | - |
| TestPersistToolsNormalizationReturnsNone.test_persist_tools_make_db_row_returns_none | Test persist tools when _make_db_row returns None | DB row failure | Pipe._run_streaming_loop | monkeypatch, pipe_instance_async, caplog | Warning or result | Medium | [ ] | Failure path | - |
| TestAPIErrorCodePatterns.test_api_error_no_patterns_match_returns_false | Test API error where no patterns match | No pattern | StreamingHandler._looks_like_responses_unsupported | OpenRouterAPIError | returns False | Low | [ ] | Pattern | - |
| TestChatsImportFallback.test_chats_import_fallback_is_none_when_not_present | Test Chats is None when import fails | Import fallback | streaming_core | None | hasattr Chats | Low | [ ] | Import guard | - |
| TestReasoningStatusEmitGuard.test_reasoning_status_not_emitted_when_conditions_unmet | Test reasoning status not emitted when no conditions met | Emit guard | Pipe._run_streaming_loop | monkeypatch, pipe_instance_async | No short text status | Low | [ ] | Guard logic | - |
| TestImagePersistenceExtConversion.test_image_persistence_jpg_to_jpeg_conversion | Test jpg extension is converted to jpeg | Extension conversion | Pipe._run_streaming_loop | monkeypatch, pipe_instance_async | Image or emitted | Low | [ ] | MIME handling | - |
| TestMaterializeImageFromStr.test_materialize_empty_string_returns_none | Test empty string returns None | Empty string | Pipe._run_streaming_loop | monkeypatch, pipe_instance_async | result=="Done" | Low | [ ] | Empty guard | - |
| TestMaterializeImageFromStr.test_materialize_data_url_invalid_returns_none | Test invalid data URL returns None | Invalid URL | Pipe._run_streaming_loop | monkeypatch, pipe_instance_async | result=="Done" | Low | [ ] | Validation | - |
| TestMaterializeImageFromStr.test_materialize_raw_base64_with_prefix | Test raw base64 with ;base64, prefix | Prefix handling | Pipe._run_streaming_loop | monkeypatch, pipe_instance_async | Some result | Low | [ ] | Prefix parsing | - |
| TestMaterializeImageFromStr.test_materialize_invalid_base64_returns_none | Test invalid base64 string returns None | Invalid base64 | Pipe._run_streaming_loop | monkeypatch, pipe_instance_async | result=="Done" | Low | [ ] | Validation | - |
| TestMaterializeImageEntry.test_materialize_image_entry_with_b64_json | Test image entry with b64_json key | b64_json handling | Pipe._run_streaming_loop | monkeypatch, pipe_instance_async | Some result | Low | [ ] | Entry parsing | - |
| TestMaterializeImageEntry.test_materialize_image_entry_invalid_b64_continues | Test image entry with invalid b64 continues | Invalid b64 | Pipe._run_streaming_loop | monkeypatch, pipe_instance_async | URL fallback | Low | [ ] | Fallback | - |
| TestMaterializeImageEntry.test_append_output_block_empty_returns_current | Test empty block returns current | Empty block | Pipe._run_streaming_loop | monkeypatch, pipe_instance_async | result=="Text only" | Low | [ ] | Empty handling | - |
| TestSurrogateNormalization.test_normalize_surrogate_empty_combined | Test surrogate normalization with empty combined | Empty combined | Pipe._run_streaming_loop | monkeypatch, pipe_instance_async | result=="Hello" | Low | [ ] | Empty handling | - |
| TestExtractReasoningText.test_extract_reasoning_text_non_dict_returns_empty | Test reasoning text extraction non-dict | Non-dict | Pipe._run_streaming_loop | monkeypatch, pipe_instance_async | result=="Hello" | Low | [ ] | Type guard | - |
| TestExtractReasoningTextFromItem.test_extract_reasoning_from_item_non_dict | Test reasoning extraction from non-dict item | Non-dict item | Pipe._run_streaming_loop | monkeypatch, pipe_instance_async | result=="Hello" | Low | [ ] | Type guard | - |
| TestAppendReasoningText.test_append_reasoning_empty_candidate | Test reasoning append with empty candidate | Empty candidate | Pipe._run_streaming_loop | monkeypatch, pipe_instance_async | result=="Hello" | Low | [ ] | Empty guard | - |
| TestLaterTimeout.test_later_timeout_emits_status | Test _later emits status after timeout | Timeout emit | Pipe._run_streaming_loop | monkeypatch, pipe_instance_async | Thinking status | Low | [ ] | Timeout | - |
| TestRawArgumentsFallback.test_raw_arguments_str_fallback | Test raw_arguments str() fallback | Fallback | Pipe._run_streaming_loop | monkeypatch, pipe_instance_async | Graceful handling | Low | [ ] | Fallback | - |
| TestToolCallsPayloadNonDict.test_tool_calls_payload_non_dict_skipped | Test non-dict in tool_calls_payload skipped | Non-dict skip | Pipe._run_streaming_loop | monkeypatch, pipe_instance_async, caplog | tool_calls | Low | [ ] | Filtering | - |
| TestNonStreamingToolCallsException.test_nonstreaming_tool_calls_build_exception | Test exception building non-streaming tool_calls | Exception | Pipe._run_streaming_loop | monkeypatch, pipe_instance_async, caplog | Graceful handling | Medium | [ ] | Error path | - |
| TestPersistToolsNormalizationNone.test_persist_tools_normalization_returns_none | Test persist tools when normalization returns None | Normalization | Pipe._run_streaming_loop | monkeypatch, pipe_instance_async, caplog | Warning or result | Medium | [ ] | Failure path | - |
| TestLoopLimitTemplateException.test_loop_limit_template_exception_exercises_handler | Test loop limit exception handler | Handler exercise | Pipe._run_streaming_loop | monkeypatch, pipe_instance_async | Result with limit | Medium | [ ] | Error handler | - |
| TestSessionLogSegmentStatus.test_session_log_cancelled_status | Test session log with cancelled status | Cancelled | Pipe._run_streaming_loop | monkeypatch, pipe_instance_async | raises CancelledError | Medium | [ ] | Status | - |
| TestSessionLogSegmentStatus.test_session_log_error_status | Test session log with error status | Error status | Pipe._run_streaming_loop | monkeypatch, pipe_instance_async | Status=error | Medium | [ ] | Status | - |
| TestSessionLogPersistException.test_session_log_persist_exception_logged | Test session log persist exception logged | Exception log | Pipe._run_streaming_loop | monkeypatch, pipe_instance_async, caplog | result=="Hello" | Medium | [ ] | Logging | - |
| TestDataUrlImagePersistence.test_data_url_persist_success_emits_status | Test data URL persistence path | Persist success | Pipe._run_streaming_loop | monkeypatch, pipe_instance_async | Image or Done | Medium | [ ] | Persistence | - |
| TestImagePersistenceFailFallback.test_data_url_persist_fail_returns_original | Test data URL returns original on failure | Fallback | Pipe._run_streaming_loop | monkeypatch, pipe_instance_async | Data URL or result | Medium | [ ] | Fallback | - |
| TestImageB64JsonPersistence.test_b64_json_persist_success | Test b64_json image persistence success | Persist success | Pipe._run_streaming_loop | monkeypatch, pipe_instance_async | Uploaded or Done | Medium | [ ] | Persistence | - |
| TestRawBase64Persistence.test_raw_base64_with_semicolon_prefix_persistence | Test raw base64 with prefix persistence | Prefix persist | Pipe._run_streaming_loop | monkeypatch, pipe_instance_async | Uploaded or Done | Low | [ ] | Persistence | - |
| TestValidateBase64SizeFails.test_base64_size_too_large_returns_none | Test base64 too large returns None | Size limit | Pipe._run_streaming_loop | monkeypatch, pipe_instance_async | result=="Done" | Low | [ ] | Size validation | - |
| TestAppendOutputBlockEmptySnippet.test_append_output_block_whitespace_only | Test whitespace-only block | Whitespace | Pipe._run_streaming_loop | monkeypatch, pipe_instance_async | result=="Hello" | Low | [ ] | Whitespace | - |
| TestLaterTimeoutWithDelayedStream.test_later_timeout_fires_before_model_started | Test _later fires thinking status with delay | Delayed status | Pipe._run_streaming_loop | monkeypatch, pipe_instance_async | Multiple thinking | Low | [ ] | Timeout | - |
| TestToolCallsPayloadDebugLogging.test_tool_calls_debug_path_exercised | Test debug logging for tool calls | Debug log | Pipe._run_streaming_loop | monkeypatch, pipe_instance_async, caplog | tool_calls or result | Low | [ ] | Logging | - |
| TestRawArgumentsNonJsonNonString.test_function_call_with_non_serializable_arguments | Test function call with array arguments | Array args | Pipe._run_streaming_loop | monkeypatch, pipe_instance_async | Graceful handling | Low | [ ] | Type handling | - |
| TestSessionLogPersistExceptionCoverage.test_session_log_persist_exception_path_exists | Verify session log exception path exists | Code inspection | streaming_core source | None | Path in source | Low | [ ] | Code verification | - |
| TestExtractReasoningFromNonDictEvent.test_reasoning_delta_non_dict_event_handled | Test reasoning delta non-dict handled | Non-dict event | Pipe._run_streaming_loop | monkeypatch, pipe_instance_async | result=="Answer", deltas | Low | [ ] | Type handling | - |
| TestEmptyReasoningDelta.test_reasoning_empty_delta_skipped | Test empty reasoning delta skipped | Empty delta | Pipe._run_streaming_loop | monkeypatch, pipe_instance_async | result=="Answer" | Low | [ ] | Empty handling | - |
| TestNormalizeSurrogateEmpty.test_surrogate_normalize_consecutive_empty | Test consecutive empty strings | Consecutive empty | Pipe._run_streaming_loop | monkeypatch, pipe_instance_async | result=="Content" | Low | [ ] | Empty handling | - |
| TestJpgMimeTypeConversion.test_jpg_mime_type_converted_to_jpeg | Test image/jpg converted to image/jpeg | MIME conversion | Pipe._run_streaming_loop | monkeypatch, pipe_instance_async | jpeg in filename | Low | [ ] | MIME handling | - |
| TestStreamingLoopBasic.test_streaming_loop_multiple_text_deltas | Test proper concatenation of multiple text deltas | Multiple delta handling | Pipe._run_streaming_loop | monkeypatch, pipe_instance_async | result=="Hello beautiful world!" | Low | [ ] | Core streaming | - |
| TestStreamingLoopBasic.test_streaming_loop_empty_delta | Test handling of empty delta strings | Empty delta handling | Pipe._run_streaming_loop | monkeypatch, pipe_instance_async | result=="Hello" | Low | [ ] | Edge case | - |
| TestStreamingLoopBasic.test_streaming_loop_response_done_event | Test handling of response.done event type | Event type handling | Pipe._run_streaming_loop | monkeypatch, pipe_instance_async | result=="Hello" | Low | [ ] | Event handling | - |
| TestStreamingLoopBasic.test_streaming_loop_response_created_event | Test handling of response.created event | Created event | Pipe._run_streaming_loop | monkeypatch, pipe_instance_async | result=="Created!" | Low | [ ] | Event handling | - |
| TestStreamingLoopBasic.test_streaming_loop_content_part_added | Test handling of response.content_part.added event | Content part | Pipe._run_streaming_loop | monkeypatch, pipe_instance_async | Hello in result | Low | [ ] | Event handling | - |
| TestStreamingLoopBasic.test_streaming_loop_with_usage_stats | Test handling of usage statistics in completed response | Usage stats | Pipe._run_streaming_loop | monkeypatch, pipe_instance_async | completion events | Low | [ ] | Token tracking | - |
| TestStreamingLoopBasic.test_streaming_loop_response_error_event | Test handling of response.error events | Error event | Pipe._run_streaming_loop | monkeypatch, pipe_instance_async | Starting in result | Low | [ ] | Error handling | - |
| TestStreamingLoopBasic.test_streaming_loop_cancellation | Test proper handling of cancellation | CancelledError | Pipe._run_streaming_loop | monkeypatch, pipe_instance_async | raises CancelledError | Medium | [ ] | Cancellation | - |
| TestStreamingLoopBasic.test_streaming_loop_message_in_progress | Test message item with in_progress status | In progress status | Pipe._run_streaming_loop | monkeypatch, pipe_instance_async | Responding in status | Low | [ ] | Status update | - |
| TestStreamingLoopBasic.test_streaming_loop_api_model_override | Test that api_model is used instead of model | Model override | Pipe._run_streaming_loop | monkeypatch, pipe_instance_async | captured model correct | Low | [ ] | Model selection | - |
| TestToolPassthrough.test_streaming_loop_tool_passthrough_delta | Test tool call argument streaming in passthrough mode | Tool delta | Pipe._run_streaming_loop | monkeypatch, pipe_instance_async | tool_calls events | Medium | [ ] | Tool passthrough | - |
| TestToolPassthrough.test_streaming_loop_tool_passthrough_no_call_id | Test tool passthrough skips events without call_id | No call_id | Pipe._run_streaming_loop | monkeypatch, pipe_instance_async | no tool_calls | Low | [ ] | Validation | - |
| TestToolPassthrough.test_streaming_loop_tool_passthrough_nonstream_response | Test tool passthrough with non-streaming body | Non-streaming | Pipe._run_streaming_loop | monkeypatch, pipe_instance_async | tool_calls events | Medium | [ ] | Non-stream path | - |
| TestToolPassthrough.test_streaming_loop_tool_passthrough_exposed_name_mapping | Test tool passthrough with exposed_to_origin name mapping | Name mapping | Pipe._run_streaming_loop | monkeypatch, pipe_instance_async | mapped name | Low | [ ] | Name mapping | - |
| TestToolPassthrough.test_streaming_loop_tool_passthrough_exception_handling | Test that exceptions in tool passthrough are logged | Exception handling | Pipe._run_streaming_loop | monkeypatch, pipe_instance_async, caplog | Warning logged | Medium | [ ] | Error path | - |
| TestToolPassthrough.test_tool_passthrough_arguments_done_suffix_calculation | Test arguments done suffix calculation | Suffix calculation | Pipe._run_streaming_loop | monkeypatch, pipe_instance_async | tool_calls | Low | [ ] | Suffix logic | - |
| TestToolPassthrough.test_tool_passthrough_dict_arguments | Test tool passthrough with dict arguments | Dict arguments | Pipe._run_streaming_loop | monkeypatch, pipe_instance_async | tool_calls | Low | [ ] | Dict handling | - |
| TestWebSearchStatus.test_streaming_loop_web_search_action_search | Test web search action search | Search action | Pipe._run_streaming_loop | monkeypatch, pipe_instance_async | Status with Searching | Low | [ ] | Web search | - |
| TestWebSearchStatus.test_streaming_loop_web_search_action_open_page | Test web search action open_page | Open page action | Pipe._run_streaming_loop | monkeypatch, pipe_instance_async | Status with Reading | Low | [ ] | Web search | - |
| TestWebSearchStatus.test_streaming_loop_web_search_action_find_in_page | Test web search action find_in_page | Find in page | Pipe._run_streaming_loop | monkeypatch, pipe_instance_async | Status with Finding | Low | [ ] | Web search | - |
| TestCitationAnnotations.test_streaming_loop_citation_annotation | Test citation annotation handling | Citation | Pipe._run_streaming_loop | monkeypatch, pipe_instance_async | Citation in result | Low | [ ] | Citations | - |
| TestCitationAnnotations.test_streaming_loop_duplicate_citation_skipped | Test duplicate citation is skipped | Deduplication | Pipe._run_streaming_loop | monkeypatch, pipe_instance_async | Single citation | Low | [ ] | Dedup | - |
| TestImageGeneration.test_streaming_loop_image_generation_call_url | Test image generation call with URL | Image URL | Pipe._run_streaming_loop | monkeypatch, pipe_instance_async | URL in result | Low | [ ] | Image gen | - |
| TestImageGeneration.test_streaming_loop_image_generation_duplicate_skipped | Test duplicate image is skipped | Deduplication | Pipe._run_streaming_loop | monkeypatch, pipe_instance_async | Single image | Low | [ ] | Dedup | - |
| TestImageGeneration.test_image_generation_base64_persistence | Test image generation with base64 persistence | Base64 persist | Pipe._run_streaming_loop | monkeypatch, pipe_instance_async, sample_image_base64 | Image persisted | Medium | [ ] | Persistence | - |
| TestImageGeneration.test_image_generation_data_url_format | Test image generation data URL format | Data URL | Pipe._run_streaming_loop | monkeypatch, pipe_instance_async, sample_image_base64 | Data URL | Low | [ ] | Format | - |
| TestImageGeneration.test_image_generation_invalid_base64 | Test image generation with invalid base64 | Invalid b64 | Pipe._run_streaming_loop | monkeypatch, pipe_instance_async | Graceful handling | Low | [ ] | Validation | - |
| TestImageGeneration.test_image_generation_nested_result | Test image generation with nested result | Nested result | Pipe._run_streaming_loop | monkeypatch, pipe_instance_async | URL extracted | Low | [ ] | Nesting | - |
| TestImageGeneration.test_append_output_block_formatting | Test append output block formatting | Formatting | Pipe._run_streaming_loop | monkeypatch, pipe_instance_async | Correct format | Low | [ ] | Format | - |
| TestImageGeneration.test_image_generation_processing_error | Test image generation processing error | Error handling | Pipe._run_streaming_loop | monkeypatch, pipe_instance_async, caplog | Error logged | Medium | [ ] | Error path | - |
| TestReasoningThinking.test_streaming_loop_thinking_both_mode | Test streaming loop thinking both mode | Both mode | Pipe._run_streaming_loop | monkeypatch, pipe_instance_async | reasoning and status | Medium | [ ] | Thinking mode | - |
| TestReasoningThinking.test_streaming_loop_reasoning_content_part_done | Test reasoning content part done event | Part done | Pipe._run_streaming_loop | monkeypatch, pipe_instance_async | Reasoning emitted | Low | [ ] | Part handling | - |
| TestReasoningThinking.test_streaming_loop_reasoning_output_item_done_with_summary | Test reasoning output item done with summary | Summary | Pipe._run_streaming_loop | monkeypatch, pipe_instance_async | Summary emitted | Low | [ ] | Summary | - |
| TestReasoningThinking.test_streaming_loop_thinking_status_only_mode | Test streaming loop status only thinking mode | Status mode | Pipe._run_streaming_loop | monkeypatch, pipe_instance_async | Status events | Medium | [ ] | Status mode | - |
| TestReasoningThinking.test_streaming_loop_reasoning_disabled | Test streaming loop with reasoning disabled | Disabled | Pipe._run_streaming_loop | monkeypatch, pipe_instance_async | No reasoning | Low | [ ] | Disabled | - |
| TestReasoningThinking.test_reasoning_status_max_chars_trigger | Test reasoning status max chars trigger | Max chars | Pipe._run_streaming_loop | monkeypatch, pipe_instance_async | Status at chars | Low | [ ] | Threshold | - |
| TestReasoningThinking.test_reasoning_status_punctuation_trigger | Test reasoning status punctuation trigger | Punctuation | Pipe._run_streaming_loop | monkeypatch, pipe_instance_async | Status at punct | Low | [ ] | Trigger | - |
| TestReasoningThinking.test_reasoning_status_no_emitter | Test reasoning status without emitter | No emitter | Pipe._run_streaming_loop | monkeypatch, pipe_instance_async | No exception | Low | [ ] | Null check | - |
| TestReasoningThinking.test_reasoning_buffer_cumulative_dedup | Test reasoning buffer cumulative deduplication | Deduplication | Pipe._run_streaming_loop | monkeypatch, pipe_instance_async | No duplicates | Low | [ ] | Dedup | - |
| TestReasoningThinking.test_reasoning_buffer_misaligned_text | Test reasoning buffer with misaligned text | Misalignment | Pipe._run_streaming_loop | monkeypatch, pipe_instance_async | Correct output | Low | [ ] | Edge case | - |
| TestReasoningThinking.test_reasoning_summary_text_done_with_title | Test reasoning summary text done with title | Title | Pipe._run_streaming_loop | monkeypatch, pipe_instance_async | Title in summary | Low | [ ] | Title | - |
| TestReasoningThinking.test_reasoning_summary_text_done_empty | Test reasoning summary text done empty | Empty summary | Pipe._run_streaming_loop | monkeypatch, pipe_instance_async | No error | Low | [ ] | Empty | - |
| TestReasoningThinking.test_empty_reasoning_delta | Test empty reasoning delta | Empty delta | Pipe._run_streaming_loop | monkeypatch, pipe_instance_async | Skipped | Low | [ ] | Empty | - |
| TestReasoningThinking.test_extract_reasoning_from_part_content_list | Test extract reasoning from part content list | Content list | Pipe._run_streaming_loop | monkeypatch, pipe_instance_async | Extracted | Low | [ ] | Extraction | - |
| TestReasoningThinking.test_thinking_tasks_delayed_status | Test thinking tasks delayed status | Delayed | Pipe._run_streaming_loop | monkeypatch, pipe_instance_async | Delayed status | Low | [ ] | Timing | - |
| TestSurrogatePairHandling.test_streaming_loop_surrogate_pairs_in_text | Test surrogate pairs in text | Surrogate pairs | Pipe._run_streaming_loop | monkeypatch, pipe_instance_async | Correct output | Low | [ ] | Unicode | - |
| TestSurrogatePairHandling.test_surrogate_carry_across_deltas | Test surrogate carry across deltas | Carry over | Pipe._run_streaming_loop | monkeypatch, pipe_instance_async | Correct output | Low | [ ] | Unicode | - |
| TestSurrogatePairHandling.test_surrogate_empty_combined_text | Test surrogate empty combined text | Empty | Pipe._run_streaming_loop | monkeypatch, pipe_instance_async | No error | Low | [ ] | Empty | - |
| TestToolListHandling.test_streaming_loop_tools_as_list | Test streaming loop with tools as list | Tools list | Pipe._run_streaming_loop | monkeypatch, pipe_instance_async | Tools used | Low | [ ] | Tool format | - |
| TestToolListHandling.test_streaming_loop_tools_list_no_callables_warning | Test tools list without callables warns | Warning | Pipe._run_streaming_loop | monkeypatch, pipe_instance_async, caplog | Warning logged | Low | [ ] | Validation | - |
| TestToolListHandling.test_tool_registry_from_dict | Test tool registry from dict format | Dict format | Pipe._run_streaming_loop | monkeypatch, pipe_instance_async | Tools used | Low | [ ] | Tool format | - |
| TestNonStreamingLoop.test_nonstreaming_loop_session_required | Test non-streaming loop requires session | Session | Pipe._run_nonstreaming_loop | pipe_instance_async | raises RuntimeError | Low | [ ] | Validation | - |
| TestNonStreamingLoop.test_nonstreaming_loop_suppresses_chat_messages | Test non-streaming suppresses chat messages | Suppression | Pipe._run_nonstreaming_loop | monkeypatch, pipe_instance_async | No chat:message | Low | [ ] | Suppression | - |
| TestNonStreamingLoop.test_nonstreaming_tool_passthrough_returns_dict | Test non-streaming tool passthrough returns dict | Dict return | Pipe._run_nonstreaming_loop | monkeypatch, pipe_instance_async | isinstance dict | Low | [ ] | Return type | - |
| TestNonStreamingLoop.test_nonstreaming_tool_passthrough_no_model_in_metadata | Test non-streaming with no model in metadata | No model | Pipe._run_nonstreaming_loop | monkeypatch, pipe_instance_async | Graceful | Low | [ ] | Missing data | - |
| TestFunctionCalls.test_streaming_loop_function_call_empty_arguments | Test function call with empty arguments | Empty args | Pipe._run_streaming_loop | monkeypatch, pipe_instance_async | Handled | Low | [ ] | Empty args | - |
| TestFunctionCalls.test_streaming_loop_function_call_dict_arguments | Test function call with dict arguments | Dict args | Pipe._run_streaming_loop | monkeypatch, pipe_instance_async | Processed | Low | [ ] | Dict args | - |
| TestFunctionCalls.test_function_call_unparsed_arguments | Test function call with unparsed arguments | Unparsed | Pipe._run_streaming_loop | monkeypatch, pipe_instance_async | Handled | Low | [ ] | Parsing | - |
| TestFunctionCalls.test_function_call_list_arguments | Test function call with list arguments | List args | Pipe._run_streaming_loop | monkeypatch, pipe_instance_async | Handled | Low | [ ] | List args | - |
| TestFunctionCalls.test_function_call_empty_arguments_object | Test function call with empty arguments object | Empty obj | Pipe._run_streaming_loop | monkeypatch, pipe_instance_async, caplog | Handled | Low | [ ] | Empty obj | - |
| TestOutputItemTypes.test_streaming_loop_file_search_call | Test file search call item | File search | Pipe._run_streaming_loop | monkeypatch, pipe_instance_async | Processed | Low | [ ] | Special item | - |
| TestOutputItemTypes.test_streaming_loop_local_shell_call | Test local shell call item | Shell call | Pipe._run_streaming_loop | monkeypatch, pipe_instance_async | Processed | Low | [ ] | Special item | - |
| TestOutputItemTypes.test_streaming_loop_mcp_tool_item | Test MCP tool item | MCP tool | Pipe._run_streaming_loop | monkeypatch, pipe_instance_async | Processed | Low | [ ] | Special item | - |
| TestOutputItemTypes.test_streaming_loop_computer_call_item | Test computer call item | Computer call | Pipe._run_streaming_loop | monkeypatch, pipe_instance_async | Processed | Low | [ ] | Special item | - |
| TestOutputItemTypes.test_streaming_loop_code_interpreter_item | Test code interpreter item | Code interp | Pipe._run_streaming_loop | monkeypatch, pipe_instance_async | Processed | Low | [ ] | Special item | - |
| TestPersistReasoning.test_streaming_loop_persist_reasoning_next_reply | Test reasoning persistence in next_reply mode | Persist | Pipe._run_streaming_loop | monkeypatch, pipe_instance_async | Persisted | Medium | [ ] | Persistence | - |


## `tests/test_structured_output.py`

| Test Name | Description | What It Tests | Code Under Test | Mocks/Fixtures | Assertions | Drift Risk | Check Done | Codex Notes | Codex TODO |
|-----------|-------------|---------------|-----------------|----------------|------------|------------|------------|-------------|------------|
| `test_filter_openrouter_request_translates_response_format_to_text_format` | Validates that `response_format` with `json_schema` type is correctly translated to OpenRouter's `text.format` structure | Tests the translation of OpenAI-style `response_format` (containing `type: json_schema` with nested `json_schema` object containing `name` and `schema`) into OpenRouter's `text.format` field. The original `response_format` field should be removed and `text.format` should contain the unwrapped schema details. | `_filter_openrouter_request` function | None | 1. Asserts `response_format` is NOT in filtered output, 2. Asserts `filtered["text"]["format"]` equals `{"type": "json_schema", "name": "demo", "schema": {"type": "object"}}` (unwrapped from nested structure) | Medium - Depends on OpenRouter API text.format schema structure; if OpenRouter changes this format or adds new response_format types, test may fail or miss edge cases |  | Tests critical API translation layer between OpenAI and OpenRouter structured output formats. The unwrapping logic (removing nested `json_schema` key) is the key transformation. | Verify OpenRouter docs for current text.format spec; add test cases for other response_format types (e.g., json_object); test error handling for malformed schemas |
| `test_filter_openrouter_request_prefers_existing_text_format` | Validates that when both `text.format` and `response_format` are present, the existing `text.format` takes precedence and is preserved while `response_format` is removed | Tests precedence logic: if payload already contains `text.format`, it should NOT be overwritten by `response_format` translation. The `response_format` field should still be removed. | `_filter_openrouter_request` function | None | 1. Asserts `response_format` is NOT in filtered output, 2. Asserts `filtered["text"]["format"]` equals `{"type": "json_object"}` (the original text.format, not the response_format translation) | Medium - Precedence logic could change if requirements evolve; ambiguous which format should win in conflict scenarios |  | Tests critical precedence rule: explicit OpenRouter format overrides OpenAI format. This prevents accidental overwrites when users explicitly set OpenRouter's native format. | Document WHY text.format has precedence; add logging when precedence is applied; test with identical vs conflicting formats |
| `test_filter_openrouter_request_drops_invalid_text_format` | Validates that invalid `text.format` values (unsupported type) are completely removed from the filtered payload | Tests validation and sanitization: when `text.format.type` contains an invalid value (`nope`), the entire `text` field should be dropped rather than passing invalid data to OpenRouter | `_filter_openrouter_request` function | None | Asserts `text` is NOT in filtered output when format type is invalid | High - Depends on hardcoded list of valid format types; if OpenRouter adds new format types, this validation could incorrectly drop them; no explicit list of valid types visible in test |  | Tests defensive programming: drops invalid data rather than propagating it. However, test doesn't reveal WHAT the valid types are (json_schema, json_object, text?). The validation logic must exist in `_filter_openrouter_request`. | Find and document the complete list of valid text.format types; test boundary cases (empty string, null, missing type); add test for partially valid formats (valid type but invalid schema) |
| `test_responses_payload_to_chat_maps_text_format_to_response_format` | Validates reverse transformation: OpenRouter's `text.format` is correctly mapped back to OpenAI-style `response_format` when converting Responses API payload to Chat Completions payload | Tests the reverse translation from OpenRouter format to OpenAI format. Input uses Responses API structure (with `input` array containing `type: message` objects) and `text.format`. Output should use Chat Completions structure with `response_format`. | `_responses_payload_to_chat_completions_payload` function | None | Asserts `chat["response_format"]` equals `{"type": "json_object"}` (extracted from text.format) | Medium - Reverse translation must stay in sync with forward translation; if either changes independently, round-trip consistency breaks |  | Tests reverse transformation from OpenRouter to OpenAI format. Note: the transformation is direct copy (json_object stays json_object), unlike the forward direction which unwraps json_schema. This asymmetry is important. | Test round-trip consistency (forward then reverse); verify handling of json_schema format in reverse (does it re-wrap?); test with missing text.format |
| `test_responses_payload_to_chat_prefers_response_format_over_text_format` | Validates that when both `response_format` and `text.format` are present in Responses API payload, `response_format` takes precedence in the Chat Completions output | Tests precedence logic in reverse direction: if Responses payload contains both formats, `response_format` (already in OpenAI format) should be preferred over translating `text.format`. This is the inverse of the second test's precedence rule. | `_responses_payload_to_chat_completions_payload` function | None | Asserts `chat["response_format"]` equals `{"type": "json_object"}` (from response_format, not the text.format which has json_schema) | Medium - Precedence logic must be consistent across transformations; policy could change based on use case analysis |  | Tests reverse precedence: native format (response_format) overrides non-native format (text.format). This mirrors the forward precedence but in opposite direction. Ensures idempotency when response_format passes through. | Verify both precedence rules are documented and justified; test edge case where formats conflict (different types); add warning logs when precedence is applied |


## `tests/test_task_model_adapter.py`

| Test Name | Description | What It Tests | Code Under Test | Mocks/Fixtures | Assertions | Drift Risk | Check Done | Codex Notes | Codex TODO |
|-----------|-------------|---------------|-----------------|----------------|------------|------------|------------|-------------|------------|
| `test_extract_task_output_text_non_dict_response` | Tests extraction with non-dict response types | Validates that _extract_task_output_text handles non-dict responses gracefully and returns empty string (line 48 coverage) | `TaskModelAdapter._extract_task_output_text()` | `pipe_instance` fixture | Asserts empty string returned for None, string, list, and number inputs | Low - edge case handling for defensive programming | Yes | Covers defensive guard clause for invalid response types; ensures no AttributeError when response is not a dict | |
| `test_extract_task_output_text_non_message_item` | Tests extraction when output items are not of message type | Validates that non-message items in output array are skipped correctly (line 55 coverage) | `TaskModelAdapter._extract_task_output_text()` | `pipe_instance` fixture | Asserts only message type items are processed, others (function_call, thinking, string) are skipped | Low - validates filtering logic | Yes | Tests heterogeneous output array with multiple types; ensures only message items contribute to extracted text | |
| `test_extract_task_output_text_item_missing_type` | Tests extraction when output items lack type field | Validates that items without 'type' key are skipped (line 55 coverage) | `TaskModelAdapter._extract_task_output_text()` | `pipe_instance` fixture | Asserts empty string when output items don't have 'type' key | Low - defensive coding for malformed responses | Yes | Guards against KeyError when API returns malformed output items | |
| `test_extract_task_output_text_non_dict_content` | Tests extraction with non-dict content items | Validates that non-dict content items are skipped (line 58 coverage) | `TaskModelAdapter._extract_task_output_text()` | `pipe_instance` fixture | Asserts only dict content items are processed; string, number, None are skipped | Low - content validation logic | Yes | Ensures robust handling of malformed content arrays within messages | |
| `test_extract_task_output_text_fallback_output_text` | Tests fallback extraction from output_text field | Validates fallback to top-level output_text field when output array is empty (line 65 coverage) | `TaskModelAdapter._extract_task_output_text()` | `pipe_instance` fixture | Asserts text extracted from output_text field when output array is empty | Medium - depends on provider-specific response format | Yes | Some providers return collapsed output_text field; critical fallback for compatibility | |
| `test_extract_task_output_text_combined_output_and_fallback` | Tests extraction combines both output items and fallback field | Validates that both output array text and output_text field are combined (line 65 coverage) | `TaskModelAdapter._extract_task_output_text()` | `pipe_instance` fixture | Asserts both "From output" and "From fallback" present in result | Medium - aggregation logic | Yes | Tests full extraction combining structured output and fallback text | |
| `test_extract_task_output_text_fallback_not_string` | Tests that non-string fallback field is ignored | Validates that output_text field must be string type (line 64 coverage) | `TaskModelAdapter._extract_task_output_text()` | `pipe_instance` fixture | Asserts non-string output_text is ignored, only valid content extracted | Low - type checking | Yes | Defensive programming to prevent crashes on malformed fallback field | |
| `test_task_name_with_string` | Tests _task_name helper with string inputs | Validates _task_name extracts task name from string and strips whitespace | `TaskModelAdapter._task_name()` | `pipe_instance` fixture | Asserts string returned as-is with whitespace stripped | Low - simple string handling | Yes | Basic helper validation for task identification | |
| `test_task_name_with_dict` | Tests _task_name helper with dict inputs | Validates _task_name extracts task name from dict keys (type, task, name) | `TaskModelAdapter._task_name()` | `pipe_instance` fixture | Asserts task name extracted from various dict key formats; empty string for missing keys | Low - dict key extraction | Yes | Supports multiple task specification formats in API responses | |
| `test_task_name_with_other_types` | Tests _task_name helper with invalid types | Validates _task_name returns empty string for non-string/non-dict inputs | `TaskModelAdapter._task_name()` | `pipe_instance` fixture | Asserts empty string for None, number, list inputs | Low - defensive programming | Yes | Guards against TypeError when task context is invalid type | |
| `test_task_model_request_session_none` | Tests that None session raises RuntimeError | Validates _run_task_model_request requires HTTP session (line 141 coverage) | `TaskModelAdapter._run_task_model_request()` | `pipe_instance_async` fixture | Asserts RuntimeError raised with "HTTP session is required" message | High - critical validation for async operations | Yes | Prevents undefined behavior when session is not provided | |
| `test_task_model_request_use_model_max_output_tokens` | Tests that USE_MODEL_MAX_OUTPUT_TOKENS applies model spec limits | Validates max_output_tokens set from model spec when valve enabled (lines 111-114 coverage) | `TaskModelAdapter._run_task_model_request()` | `pipe_instance_async` fixture, aioresponses, ModelFamily.set_dynamic_specs | Asserts max_output_tokens=4096 in captured payload when valve is True | High - feature flag controlling token limits | Yes | Critical for respecting model-specific completion limits from registry | Verify ModelFamily spec structure stays consistent |
| `test_task_model_request_use_model_max_output_tokens_already_set` | Tests that explicit max_output_tokens is preserved | Validates explicit max_output_tokens not overridden by model spec (lines 111-114 coverage) | `TaskModelAdapter._run_task_model_request()` | `pipe_instance_async` fixture, aioresponses, ModelFamily.set_dynamic_specs | Asserts explicit max_output_tokens=1000 preserved in payload | High - precedence logic for token limits | Yes | User-specified limits should override automatic defaults | |
| `test_task_model_request_use_model_max_output_tokens_disabled` | Tests that max_output_tokens removed when valve disabled | Validates max_output_tokens removed from body when USE_MODEL_MAX_OUTPUT_TOKENS=False (line 116 coverage) | `TaskModelAdapter._run_task_model_request()` | `pipe_instance_async` fixture, aioresponses | Asserts max_output_tokens not present in payload when valve is False | High - valve controls OpenRouter API parameter | Yes | Ensures clean request when feature is disabled | |
| `test_task_model_request_empty_output_retries` | Tests retry logic when API returns empty output | Validates _run_task_model_request retries and returns error message for empty responses (lines 176-206 coverage) | `TaskModelAdapter._run_task_model_request()` | `pipe_instance_async` fixture, aioresponses with callback tracking | Asserts "[Task error]" in result, task name present, call_count==2 (1 retry) | Medium - retry logic critical for reliability | Yes | Handles provider errors where API succeeds but returns no content | Verify retry count matches expected policy |
| `test_task_model_request_generic_exception_retry` | Tests retry on generic 500 exception | Validates retry on server errors (lines 180-199 coverage) | `TaskModelAdapter._run_task_model_request()` | `pipe_instance_async` fixture, aioresponses with 500 error | Asserts "[Task error]" in result, call_count==2 | Medium - transient error handling | Yes | Implements resilience for temporary server failures | |
| `test_task_model_request_auth_failure_no_retry` | Tests that 401 errors do not trigger retry | Validates authentication failures exit immediately without retry (lines 182-196 coverage) | `TaskModelAdapter._run_task_model_request()` | `pipe_instance_async` fixture, aioresponses with 401 error | Asserts call_count==1 (no retry) | High - prevents credential hammering | Yes | Critical security best practice: don't retry auth failures to avoid account lockout | |
| `test_task_model_request_auth_failure_403` | Tests that 403 errors do not trigger retry | Validates forbidden errors exit immediately without retry (lines 182-196 coverage) | `TaskModelAdapter._run_task_model_request()` | `pipe_instance_async` fixture, aioresponses with 403 error | Asserts call_count==1 (no retry) | High - security and quota protection | Yes | Prevents wasting quota/credits on known-failing auth requests | |
| `test_task_model_request_task_name_in_error` | Tests that task_context dict is parsed in error message | Validates task name extracted from dict task_context for error reporting (line 201 coverage) | `TaskModelAdapter._run_task_model_request()` | `pipe_instance_async` fixture, aioresponses with 500 error | Asserts "custom_task" present in error message | Low - error message formatting | Yes | Improves debuggability by including task type in error output | |
| `test_task_model_request_fallback_task_name` | Tests fallback to "task" when task_context is None | Validates default task name used when context not provided (line 201 coverage) | `TaskModelAdapter._run_task_model_request()` | `pipe_instance_async` fixture, aioresponses with 500 error | Asserts "task" present in error message | Low - error message fallback | Yes | Ensures error messages always have context even without explicit task name | |
| `test_task_model_request_success_with_usage` | Tests successful request tracks usage correctly | Validates success path with usage tracking (lines 153-170 coverage) | `TaskModelAdapter._run_task_model_request()` | `pipe_instance_async` fixture, aioresponses | Asserts result matches expected output "Generated Title" | Medium - core success flow | Yes | Validates happy path with user_id and pipe_id for analytics | |
| `test_task_model_request_success_after_retry` | Tests successful completion after initial failure | Validates retry succeeds on second attempt (lines 197-199 coverage) | `TaskModelAdapter._run_task_model_request()` | `pipe_instance_async` fixture, aioresponses with conditional callback | Asserts result=="Success on retry", call_count==2 | Medium - resilience validation | Yes | Confirms retry mechanism achieves eventual success | |
| `test_extract_task_output_text_empty_output_list` | Tests extraction with empty output array | Validates empty output array returns empty string | `TaskModelAdapter._extract_task_output_text()` | `pipe_instance` fixture | Asserts result=="" | Low - edge case | Yes | Minimal valid response structure | |
| `test_extract_task_output_text_empty_content_list` | Tests extraction with empty message content | Validates message with no content items returns empty string | `TaskModelAdapter._extract_task_output_text()` | `pipe_instance` fixture | Asserts result=="" | Low - edge case | Yes | Message present but no actual content | |
| `test_extract_task_output_text_output_not_list` | Tests that non-list output field returns empty string | Validates output must be list type | `TaskModelAdapter._extract_task_output_text()` | `pipe_instance` fixture | Asserts result=="" for string output | Low - defensive type checking | Yes | Guards against malformed response where output is wrong type | |
| `test_extract_task_output_text_content_wrong_type` | Tests that non-output_text content items are ignored | Validates only output_text type items are extracted | `TaskModelAdapter._extract_task_output_text()` | `pipe_instance` fixture | Asserts image content skipped, output_text extracted | Low - content type filtering | Yes | Ensures only text content contributes to task result | |
| `test_extract_task_output_text_empty_text` | Tests that empty/None text fields are filtered | Validates text must be non-empty string | `TaskModelAdapter._extract_task_output_text()` | `pipe_instance` fixture | Asserts only "valid" text extracted, empty/None filtered | Low - data cleaning | Yes | Prevents empty strings polluting output | |
| `test_extract_task_output_text_multiple_messages` | Tests extraction from multiple message items | Validates all messages in output array are processed | `TaskModelAdapter._extract_task_output_text()` | `pipe_instance` fixture | Asserts both "First" and "Second" present in result | Medium - multi-message aggregation | Yes | Handles multi-turn or structured responses with multiple messages | |
| `test_task_model_request_model_id_normalization` | Tests that dotted model IDs are normalized | Validates model ID format conversion openai.gpt -> openai/gpt (line 107 coverage) | `TaskModelAdapter._run_task_model_request()` | `pipe_instance_async` fixture, aioresponses | Asserts successful request with normalized model ID | Medium - model registry integration | Yes | Ensures consistent model ID format for OpenRouter API | Depends on normalize_model_id implementation |
| `test_task_model_adapter_initialization` | Tests adapter constructor | Validates TaskModelAdapter initializes with pipe and logger | `TaskModelAdapter.__init__()` | `pipe_instance` fixture | Asserts _pipe and logger attributes set correctly | Low - basic initialization | Yes | Sanity check for object construction | |


## `tests/test_timing_logger.py`

| Test Name | Description | What It Tests | Code Under Test | Mocks/Fixtures | Assertions | Drift Risk | Check Done | Codex Notes | Codex TODO |
|-----------|-------------|---------------|-----------------|----------------|------------|------------|------------|-------------|------------|
| `test_format_iso_utc_with_invalid_timestamp` | Test _format_iso_utc exception handling with overflow timestamp | When fromtimestamp raises OverflowError/OSError due to extremely large timestamp (1e20), fallback to datetime.now() returns valid ISO timestamp | `timing_logger._format_iso_utc(invalid_timestamp)` with timestamp=1e20 (lines 86-87) | `_reset_timing_state` fixture (autouse) | `assert result.endswith("Z")`, `assert "T" in result` (ISO format validation) | LOW - tests error path fallback behavior | YES - targets lines 86-87 exception handling | Tests exception path when timestamp conversion fails. Uses extremely large timestamp beyond year 9999 to trigger overflow. | Verify similar tests exist for other timestamp edge cases if module evolves |
| `test_format_iso_utc_with_negative_overflow` | Test _format_iso_utc with negative timestamp causing exception | Very negative timestamps (-1e20) cause exceptions, fallback to datetime.now() returns valid ISO timestamp | `timing_logger._format_iso_utc(invalid_timestamp)` with timestamp=-1e20 (lines 86-87) | `_reset_timing_state` fixture (autouse) | `assert result.endswith("Z")`, `assert "T" in result` (ISO format validation) | LOW - tests error path fallback behavior | YES - targets lines 86-87 exception handling | Tests negative overflow scenario. Ensures fallback works for both positive and negative edge cases. | Consider adding boundary value tests (year 1, year 9999) |
| `test_record_event_when_timing_disabled` | Test _record_event early return when timing is disabled | When timing is disabled (enabled=False), _record_event returns early without recording events (line 100) | `timing_logger._record_event(event)` with timing disabled via `set_timing_context("req-disabled", enabled=False)` (line 100) | `_reset_timing_state` fixture (autouse), `tmp_path` fixture, file configured at tmp_path/"timing.jsonl" | `assert tl.get_timing_events("req-disabled") == []`, `assert path.read_text() == ""` | LOW - tests disabled state, stable contract | YES - targets line 100 early return | Tests that disabled timing bypasses all recording. Both in-memory and file should be empty. | Monitor if additional timing states are added |
| `test_record_event_when_no_request_id` | Test _record_event early return when no request_id set | When request_id is None, _record_event returns early without recording (line 103) | `timing_logger._record_event(event)` with `_timing_enabled.set(True)` but `_timing_request_id.set(None)` (line 103) | `_reset_timing_state` fixture (autouse), `tmp_path` fixture, manually sets internal context vars | `assert path.read_text() == ""` (no events written to file) | MEDIUM - tests internal state manipulation | YES - targets line 103 early return | Directly manipulates ContextVars to test edge case. Timing enabled but no request_id. | Ensure test updates if request_id validation changes |
| `test_record_event_handles_write_exception` | Test _record_event write exception handling | When file write raises IOError, exception is caught silently and event is still added to in-memory buffer (lines 122-123) | `timing_logger.timing_mark("test_mark")` with mocked file handle that raises IOError on write (lines 122-123) | `_reset_timing_state` fixture (autouse), `tmp_path` fixture, `mock.MagicMock()` for file handle with `write.side_effect=IOError("Disk full")` | `assert len(events) == 1`, `assert events[0]["label"] == "test_mark"` (event in memory despite write failure) | MEDIUM - tests error handling, depends on mock behavior | YES - targets lines 122-123 exception handling | Tests silent failure on disk write errors. Events should still accumulate in memory. Uses mock to simulate disk full scenario. | Verify exception types covered match all possible write errors |
| `test_configure_timing_file_closes_existing_handle` | Test configure_timing_file closing existing handle when reconfigured | When configure_timing_file is called with new path, existing file handle is closed before opening new one (lines 154-158) | `timing_logger.configure_timing_file(str(path1))` then `configure_timing_file(str(path2))` (lines 154-158) | `_reset_timing_state` fixture (autouse), `tmp_path` fixture for two file paths | `assert tl._timing_file_handle is not None`, `assert tl._timing_file_path.name == "second.jsonl"` | LOW - tests resource cleanup, standard behavior | YES - targets lines 154-158 close existing handle | Tests proper cleanup when switching timing files. Ensures no resource leaks. | Monitor if file handle lifecycle changes |
| `test_configure_timing_file_handles_close_exception` | Test configure_timing_file handling exception when closing existing file | When closing existing file raises IOError, exception is caught and new file is still opened successfully (lines 154-158) | `timing_logger.configure_timing_file(str(path2))` after replacing handle with mock that raises on close (lines 154-158) | `_reset_timing_state` fixture (autouse), `tmp_path` fixture, `mock.MagicMock()` with `close.side_effect=IOError("Close failed")` | `assert tl.configure_timing_file(str(path2)) is True`, `assert tl._timing_file_path.name == "second.jsonl"` | MEDIUM - tests error recovery during reconfiguration | YES - targets lines 154-158 exception handling | Tests resilience when closing previous file fails. Should still successfully open new file. | Verify similar exception handling exists elsewhere in file management |
| `test_configure_timing_file_returns_false_on_open_failure` | Test configure_timing_file returns False when open() fails | When open() fails (path doesn't exist and can't be created), returns False and state remains None (lines 168-171) | `timing_logger.configure_timing_file(invalid_path)` with path="/proc/nonexistent/subdir/timing.jsonl" (lines 168-171) | `_reset_timing_state` fixture (autouse), uses /proc read-only path | `assert result is False`, `assert tl._timing_file_path is None`, `assert tl._timing_file_handle is None` | LOW - tests failure case, clear contract | YES - targets lines 168-171 open failure | Tests graceful failure when file can't be created. Uses /proc (read-only on Unix) to trigger error. | Ensure test is portable across platforms (Windows behavior) |
| `test_configure_timing_file_with_permission_error` | Test configure_timing_file handles permission errors gracefully | When open() raises PermissionError, returns False and state remains None (lines 168-171) | `timing_logger.configure_timing_file(path)` with mocked open() raising PermissionError (lines 168-171) | `_reset_timing_state` fixture (autouse), `tmp_path` fixture, `mock.patch("builtins.open", side_effect=PermissionError)` | `assert result is False`, `assert tl._timing_file_path is None`, `assert tl._timing_file_handle is None` | MEDIUM - tests permission handling with mock | YES - targets lines 168-171 open failure | Tests specific PermissionError handling. More controlled than relying on filesystem. | Verify all relevant OSError subclasses are handled |
| `test_close_timing_file_handles_close_exception` | Test close_timing_file exception handling when closing file | When file.close() raises IOError, exception is caught and state is cleaned up (lines 185-186) | `timing_logger.close_timing_file()` with mocked handle that raises IOError on close (lines 185-186) | `_reset_timing_state` fixture (autouse), `tmp_path` fixture, `mock.MagicMock()` with `close.side_effect=IOError("Close failed")` | `assert tl._timing_file_handle is None`, `assert tl._timing_file_path is None` (state cleaned despite exception) | MEDIUM - tests exception handling and cleanup | YES - targets lines 185-186 exception handling | Tests that close always cleans state even if close() raises. Prevents resource leaks. | Monitor if additional cleanup steps are added |
| `test_ensure_timing_file_configured_handles_close_exception_on_path_change` | Test ensure_timing_file_configured handles close exception when path changes | When path changes and closing old handle raises, exception is caught and new file is opened (lines 219-220) | `timing_logger.ensure_timing_file_configured(str(path2))` after replacing handle with mock that raises on close (lines 219-220) | `_reset_timing_state` fixture (autouse), `tmp_path` fixture, `mock.MagicMock()` with `close.side_effect=IOError("Close failed")` | `assert result is True`, `assert tl._timing_file_path.name == "second.jsonl"` | MEDIUM - tests error recovery during path change | YES - targets lines 219-220 exception handling | Tests resilience of ensure_timing_file_configured when switching files. Should recover from close errors. | Verify ensure vs configure have consistent error handling |
| `test_clear_timing_events_removes_request_events` | Test clear_timing_events removes events for specified request | clear_timing_events removes all events associated with a request_id from in-memory buffer (lines 272-273) | `timing_logger.clear_timing_events("req-clear")` after adding marks (lines 272-273) | `_reset_timing_state` fixture (autouse), `tmp_path` fixture, timing context set to "req-clear" | `assert len(events) == 2` (before clear), `assert events == []` (after clear) | LOW - tests cleanup function, straightforward | YES - targets lines 272-273 clear function | Tests that clear_timing_events properly removes events from buffer. Verifies cleanup functionality. | Monitor if clear affects persistence beyond in-memory buffer |
| `test_clear_timing_events_nonexistent_request` | Test clear_timing_events handles non-existent request gracefully | Calling clear_timing_events with unknown request_id doesn't raise, returns empty (lines 272-273) | `timing_logger.clear_timing_events("nonexistent-request")` (lines 272-273) | `_reset_timing_state` fixture (autouse) | No exception raised, `assert events == []` | LOW - tests graceful handling of missing keys | YES - targets lines 272-273 clear function | Tests defensive programming. Should handle missing keys gracefully without errors. | Ensure consistent behavior across all getter/setter functions |
| `test_format_timing_jsonl_empty_events` | Test format_timing_jsonl returns empty string when no events | When request has no events, format_timing_jsonl returns empty string (line 287) | `timing_logger.format_timing_jsonl("nonexistent-request")` (line 287) | `_reset_timing_state` fixture (autouse) | `assert result == ""` | LOW - tests empty case, simple contract | YES - targets line 287 empty events | Tests handling of empty event buffers. Should return empty string rather than error. | Verify consistent empty handling across formatting functions |
| `test_format_timing_jsonl_with_malformed_event` | Test format_timing_jsonl skips malformed events that can't be JSON serialized | When events buffer contains non-serializable objects, those events are skipped during formatting (lines 292-294) | `timing_logger.format_timing_jsonl("req-malformed")` after manually injecting non-serializable object (lines 292-294) | `_reset_timing_state` fixture (autouse), `tmp_path` fixture, manually injects NonSerializable class instance into buffer | `assert "normal_mark" in result`, `assert len(lines) >= 1`, `assert valid_event["label"] == "normal_mark"` | MEDIUM - tests error recovery in formatting | YES - targets lines 292-294 malformed exception | Tests resilience when event buffer contains corrupted data. Should skip bad events and format valid ones. | Monitor if serialization error handling changes |
| `test_timed_async_function_with_timing_enabled` | Test @timed decorator records enter/exit for async functions when enabled | @timed decorator wraps async functions and records enter/exit events with elapsed time (lines 428-443) | `@tl.timed` decorator on async function with `asyncio.sleep(0.01)` (lines 428-443) | `_reset_timing_state` fixture (autouse), `tmp_path` fixture, timing context "req-async" enabled, uses `asyncio.run()` | `assert result == "async_result"`, `assert len(events) == 2`, `assert events[0]["event"] == "enter"`, `assert events[1]["event"] == "exit"`, `assert events[1]["elapsed_ms"] >= 10` | MEDIUM - tests async decorator path, timing sensitive | YES - targets lines 428-443 async @timed | Tests that @timed works correctly with async/await. Records enter, tracks time, records exit. Verifies elapsed_ms calculation. | Monitor if decorator signature changes or async handling evolves |
| `test_timed_async_function_with_timing_disabled` | Test @timed bypasses timing for async functions when disabled | When timing is disabled, @timed decorator doesn't record any events for async functions (lines 428-443) | `@tl.timed` decorator on async function with timing disabled (lines 428-443) | `_reset_timing_state` fixture (autouse), `tmp_path` fixture, timing context "req-async-disabled" enabled=False, uses `asyncio.run()` | `assert result == "async_result"`, `assert events == []` | LOW - tests disabled path for async | YES - targets lines 428-443 async @timed disabled | Tests that disabled timing bypasses decorator overhead for async functions. No events recorded. | Ensure consistent disabled behavior across sync/async |
| `test_timed_async_function_with_exception` | Test @timed records exit even when async function raises | @timed decorator records exit event with elapsed time even when async function raises exception (lines 428-443) | `@tl.timed` decorator on async function that raises ValueError after sleep (lines 428-443) | `_reset_timing_state` fixture (autouse), `tmp_path` fixture, timing context "req-async-exc" enabled, uses `asyncio.run()` and `pytest.raises` | `pytest.raises(ValueError, match="Async error")`, `assert len(events) == 2`, `assert events[1]["event"] == "exit"`, `assert "elapsed_ms" in events[1]` | MEDIUM - tests exception handling in async decorator | YES - targets lines 428-443 async @timed with exception | Tests that decorator properly records timing even during exceptions. Uses try/finally pattern. | Verify exception re-raising doesn't interfere with timing |
| `test_timed_sync_function_with_exception` | Test @timed records exit even when sync function raises | @timed decorator records enter/exit events even when sync function raises exception | `@tl.timed` decorator on sync function that raises ValueError | `_reset_timing_state` fixture (autouse), `tmp_path` fixture, timing context "req-sync-exc" enabled, uses `pytest.raises` | `pytest.raises(ValueError, match="Sync error")`, `assert len(events) == 2`, `assert events[0]["event"] == "enter"`, `assert events[1]["event"] == "exit"` | MEDIUM - tests exception handling in sync decorator | YES - complementary to async exception test | Tests sync path of decorator exception handling. Ensures consistent behavior with async version. | Monitor for differences between sync/async exception paths |
| `test_timing_scope_with_exception` | Test timing_scope context manager records exit when block raises | timing_scope records enter and exit (with elapsed_ms) even when context block raises exception | `tl.timing_scope("error_scope")` context manager with ValueError raised inside (context manager protocol) | `_reset_timing_state` fixture (autouse), `tmp_path` fixture, timing context "req-scope-exc" enabled, uses `pytest.raises` | `pytest.raises(ValueError, match="Scope error")`, `assert len(events) == 2`, `assert events[1]["event"] == "exit"`, `assert "elapsed_ms" in events[1]` | MEDIUM - tests context manager exception handling | YES - tests context manager exit path | Tests that context manager __exit__ properly records timing even during exceptions. Critical for accurate profiling. | Verify context manager protocol implementation is correct |
| `test_timing_mark_records_event_with_correct_format` | Test timing_mark creates event with correct structure | timing_mark creates properly formatted event with all required fields (event, label, request_id, ts, perf_ts) | `timing_logger.timing_mark("checkpoint_1")` | `_reset_timing_state` fixture (autouse), `tmp_path` fixture, timing context "req-mark" enabled | `assert len(events) == 1`, `assert event["event"] == "mark"`, `assert event["label"] == "checkpoint_1"`, `assert event["request_id"] == "req-mark"`, `assert "ts" in event`, `assert "perf_ts" in event` | LOW - tests basic mark functionality | YES - integration test for mark | Tests that mark events have correct structure. Validates all required fields are present. | Monitor if event schema evolves |
| `test_get_timing_events_nonexistent_request` | Test get_timing_events returns empty list for unknown request | When request_id doesn't exist in buffer, returns empty list rather than error | `timing_logger.get_timing_events("unknown-request-id")` | `_reset_timing_state` fixture (autouse) | `assert events == []` | LOW - tests missing key handling | YES - tests getter with missing data | Tests defensive programming in getter. Should return empty list for unknown keys. | Ensure consistent missing key behavior across all getters |
| `test_multiple_requests_isolated` | Test events from different requests are properly isolated | Events for different request_ids are stored separately and don't interfere | Multiple `set_timing_context()` and `timing_mark()` calls with different request_ids | `_reset_timing_state` fixture (autouse), `tmp_path` fixture, two request contexts "req-1" and "req-2" | `assert len(events_1) == 1`, `assert events_1[0]["label"] == "mark_req1"`, `assert len(events_2) == 1`, `assert events_2[0]["label"] == "mark_req2"` | LOW - tests request isolation | YES - integration test for multi-request | Tests that concurrent/sequential requests maintain separate event buffers. Critical for request tracing. | Monitor if request isolation mechanism changes |
| `test_timed_decorator_label_format` | Test @timed decorator creates appropriate label from function name | @timed decorator generates labels containing the function name | `@tl.timed` decorator on function named `my_test_function` | `_reset_timing_state` fixture (autouse), `tmp_path` fixture, timing context "req-label" enabled | `assert result == 42`, `assert len(events) == 2`, `assert "my_test_function" in events[0]["label"]` | LOW - tests label generation | YES - tests decorator label creation | Tests that decorator extracts function name for labels. Important for profiling readability. | Verify label format consistency across different function types |
| `test_close_timing_file_when_not_open` | Test close_timing_file is safe to call when no file is open | Calling close_timing_file when no file is open doesn't raise and is idempotent | `timing_logger.close_timing_file()` called twice with no file open | `_reset_timing_state` fixture (autouse) | No exception raised, `assert tl._timing_file_handle is None`, `assert tl._timing_file_path is None` | LOW - tests idempotency | YES - tests close without open | Tests defensive programming. close should be safe to call multiple times. | Ensure cleanup functions are always safe to call |
| `test_ensure_timing_file_configured_same_path` | Test ensure_timing_file_configured returns True for same path | When called with same path as already configured, returns True without reopening | `configure_timing_file(path)` then `ensure_timing_file_configured(path)` with same path | `_reset_timing_state` fixture (autouse), `tmp_path` fixture | `assert tl.configure_timing_file(str(path)) is True`, `assert tl.ensure_timing_file_configured(str(path)) is True`, `assert tl._timing_file_path.name == "timing.jsonl"` | LOW - tests idempotency of ensure | YES - tests ensure with matching path | Tests that ensure doesn't unnecessarily reopen file if path matches. Optimization check. | Monitor if path comparison logic changes |
| `test_timing_scope_disabled_early_return` | Test timing_scope yields immediately when timing disabled | When timing is disabled, timing_scope context manager yields without recording (lines 355-356) | `tl.timing_scope("should_not_record")` context manager with timing disabled | `_reset_timing_state` fixture (autouse), `tmp_path` fixture, timing context "req-scope-disabled" enabled=False | `assert executed is True`, `assert events == []`, `assert path.read_text() == ""` | LOW - tests disabled context manager | YES - targets lines 355-356 early return | Tests that disabled timing bypasses context manager overhead. No events in memory or file. | Ensure consistent disabled behavior across all timing functions |
| `test_timing_scope_enabled_records_events` | Test timing_scope records enter/exit events when timing enabled | When timing is enabled, timing_scope records enter event on __enter__ and exit event with elapsed_ms on __exit__ | `tl.timing_scope("my_scope")` context manager with timing enabled | `_reset_timing_state` fixture (autouse), `tmp_path` fixture, timing context "req-scope-enabled" enabled=True | `assert len(events) == 2`, `assert events[0]["event"] == "enter"`, `assert events[0]["label"] == "my_scope"`, `assert events[1]["event"] == "exit"`, `assert "elapsed_ms" in events[1]` | LOW - tests basic context manager | YES - tests context manager happy path | Tests standard context manager usage. Verifies enter/exit event pairs with timing. | Monitor if context manager adds additional fields |
| `test_timing_scope_disabled_no_overhead` | Test timing_scope with disabled timing has minimal overhead | When timing is disabled and no file configured, timing_scope executes without errors | `tl.timing_scope("zero_overhead")` with timing disabled and no file | `_reset_timing_state` fixture (autouse), timing context "req-no-overhead" enabled=False | `assert result == 42` (block executes normally) | LOW - tests no-op behavior | YES - tests minimal overhead scenario | Tests that disabled timing has zero side effects. No file, no recording, just pass-through. | Ensure overhead is truly minimal (no unnecessary checks) |


## `tests/test_tool_registry.py`

| Test Name | Description | What It Tests | Code Under Test | Mocks/Fixtures | Assertions | Drift Risk | Check Done | Codex Notes | Codex TODO |
|-----------|-------------|---------------|-----------------|----------------|------------|------------|------------|-------------|------------|
| `test_dedupe_empty_list` | Empty list returns empty list | Deduplication with empty input | `_dedupe_tools([])` | None | `assert _dedupe_tools([]) == []` | Low |  | Basic edge case, always valid | None |
| `test_dedupe_none` | None returns empty list | Deduplication with None input | `_dedupe_tools(None)` | None | `assert _dedupe_tools(None) == []` | Low |  | Basic edge case, always valid | None |
| `test_dedupe_non_dict_items_filtered` | Non-dict items are filtered out | Filtering of invalid tool items (strings, numbers, None) | `_dedupe_tools()` with mixed list | None | Checks 2 tools remain, names include "foo" and "bar" | Low |  | Validates type filtering in dedup | None |
| `test_dedupe_last_wins` | Later entries with same identity win | Deduplication strategy (last wins) | `_dedupe_tools()` with duplicates | None | Checks 1 tool, description == "second" | Medium |  | Tests conflict resolution; verify impl still uses last-wins | Check if API expectations match |
| `test_dedupe_non_function_tools` | Non-function tools use (type, None) as key | Deduplication of non-function tools (web_search, code_interpreter) | `_dedupe_tools()` with non-function types | None | Checks 2 types, includes "web_search" and "code_interpreter" | Medium |  | Tests special dedup logic for non-function tools | Verify types list still valid |
| `test_dedupe_null_type_filtered` | Tools with no type are filtered out | Filtering of tools without type field | `_dedupe_tools()` with missing type | None | Checks 1 tool, name == "valid" | Low |  | Type validation in dedup | None |
| `test_normalize_valid_tool` | Valid tool spec is normalized correctly | Normalization of valid function tool spec | `_normalize_responses_function_tool_spec()` | None | Checks type, name, description, parameters fields | Low |  | Happy path normalization | None |
| `test_normalize_non_dict` | Non-dict input returns None | Input validation (string, int, None) | `_normalize_responses_function_tool_spec()` | None | All return None | Low |  | Type guard validation | None |
| `test_normalize_non_function_type` | Non-function type returns None | Type field validation | `_normalize_responses_function_tool_spec()` with "web_search" | None | Returns None | Low |  | Ensures only function tools normalized | None |
| `test_normalize_missing_name` | Missing name returns None | Required field validation | `_normalize_responses_function_tool_spec()` without name | None | Returns None | Low |  | Name field is required | None |
| `test_normalize_empty_name` | Empty or whitespace-only name returns None | Name content validation | `_normalize_responses_function_tool_spec()` with empty/whitespace name | None | Both return None | Low |  | Validates non-empty name | None |
| `test_normalize_non_string_name` | Non-string name returns None | Name type validation | `_normalize_responses_function_tool_spec()` with name=123 | None | Returns None | Low |  | Name must be string | None |
| `test_normalize_name_stripped` | Name is stripped of whitespace | Whitespace handling in name | `_normalize_responses_function_tool_spec()` with padded name | None | result["name"] == "test_func" | Low |  | Normalization strips whitespace | None |
| `test_normalize_empty_description_omitted` | Empty or whitespace-only description is omitted | Description field normalization | `_normalize_responses_function_tool_spec()` with empty/whitespace description | None | "description" not in result | Low |  | Empty descriptions removed | None |
| `test_normalize_non_dict_parameters_omitted` | Non-dict parameters are omitted | Parameters validation | `_normalize_responses_function_tool_spec()` with "invalid" params | None | "parameters" not in result | Low |  | Only dict parameters accepted | None |
| `test_normalize_with_strictify` | Strictify transforms parameters schema | Strictify parameter application | `_normalize_responses_function_tool_spec()` with strictify=True | None | parameters.additionalProperties == False | Medium |  | Strictify adds schema constraints | Verify strictify impl still matches |
| `test_valid_tool_cfg` | Valid tool config is transformed correctly | OWUI tool config to responses spec conversion | `_responses_spec_from_owui_tool_cfg()` | None | Checks type, name, description fields | Low |  | Happy path OWUI conversion | None |
| `test_non_dict_cfg` | Non-dict config returns None | Input type validation for OWUI config | `_responses_spec_from_owui_tool_cfg()` with string/None | None | Both return None | Low |  | Type guard for config | None |
| `test_missing_spec` | Missing spec returns None | Required spec field validation | `_responses_spec_from_owui_tool_cfg()` without spec | None | Returns None | Low |  | Spec field required | None |
| `test_non_dict_spec` | Non-dict spec returns None | Spec type validation | `_responses_spec_from_owui_tool_cfg()` with spec="not a dict" | None | Returns None | Low |  | Spec must be dict | None |
| `test_missing_name_in_spec` | Missing name in spec returns None | Name field in spec validation | `_responses_spec_from_owui_tool_cfg()` with spec missing name | None | Returns None | Low |  | Name required in spec | None |
| `test_empty_name_in_spec` | Empty name in spec returns None | Name content validation in spec | `_responses_spec_from_owui_tool_cfg()` with empty name | None | Returns None | Low |  | Non-empty name required | None |
| `test_missing_parameters_default` | Missing parameters defaults to empty object schema | Default parameters handling | `_responses_spec_from_owui_tool_cfg()` without parameters | None | parameters == {"type": "object", "properties": {}} | Medium |  | Default schema for missing params | Verify default still matches spec |
| `test_non_dict_parameters_default` | Non-dict parameters defaults to empty object schema | Invalid parameters handling | `_responses_spec_from_owui_tool_cfg()` with "invalid" params | None | parameters == {"type": "object", "properties": {}} | Medium |  | Fallback for invalid params | None |
| `test_missing_description_uses_name` | Missing description defaults to tool name | Default description handling | `_responses_spec_from_owui_tool_cfg()` without description | None | description == "my_tool" | Medium |  | Name used as fallback description | None |
| `test_owui_request_tools_prefix` | OWUI request tools get 'owui__' prefix | Prefix determination for owui_request_tools | `_tool_prefix_for_collision("owui_request_tools", None)` | None | Returns "owui__" | Medium |  | Source-specific prefix logic | Verify prefix strategy still used |
| `test_direct_tool_server_prefix` | Direct tool servers get 'direct__' prefix | Prefix for direct_tool_server | `_tool_prefix_for_collision("direct_tool_server", None)` | None | Returns "direct__" | Medium |  | Direct tools prefix | None |
| `test_extra_tools_prefix` | Extra tools get 'extra__' prefix | Prefix for extra_tools | `_tool_prefix_for_collision("extra_tools", None)` | None | Returns "extra__" | Medium |  | Extra tools prefix | None |
| `test_registry_direct_tool_prefix` | Registry tools with direct=True get 'direct__' prefix | Prefix for registry tools with direct flag | `_tool_prefix_for_collision("owui_registry_tools", {"direct": True})` | None | Returns "direct__" | Medium |  | Direct flag in registry tools | None |
| `test_registry_non_direct_tool_prefix` | Registry tools without direct flag get 'tool__' prefix | Prefix for non-direct registry tools | `_tool_prefix_for_collision()` with various non-direct configs | None | All return "tool__" | Medium |  | Default registry prefix | None |
| `test_empty_inputs` | Empty inputs return empty results | Handling of all-None inputs | `_build_collision_safe_tool_specs_and_registry()` with all None | None | tools/registry/exposed_to_origin all empty | Low |  | Empty state handling | None |
| `test_request_tools_with_callable` | Request tools with callable executor are included | Request tool with matching executor | `_build_collision_safe_tool_specs_and_registry()` | None | Checks 1 tool, in registry, in exposed_to_origin | Medium |  | Request tool + executor matching | Verify matching logic |
| `test_request_tools_without_callable_skipped` | Request tools without callable executor are skipped (non-passthrough mode) | Request tool without executor | `_build_collision_safe_tool_specs_and_registry()` | logging.getLogger("test") | tools/registry empty | Medium |  | Orphaned tools filtered in pipeline mode | None |
| `test_passthrough_mode_includes_without_callable` | Passthrough mode includes tools without callable | Passthrough mode behavior | `_build_collision_safe_tool_specs_and_registry()` with passthrough=True | None | 1 tool, empty registry | High |  | Passthrough bypasses executor requirement | Verify passthrough still exists |
| `test_collision_renaming` | Tools with same name from different sources get renamed | Collision resolution with prefixing | `_build_collision_safe_tool_specs_and_registry()` with owui+direct same name | None | 2 tools, at least one has "__search" prefix | High |  | Critical collision handling logic | Verify collision algorithm |
| `test_extra_tools_with_executor` | Extra tools with matching executor are included | Extra tools with builtin executor | `_build_collision_safe_tool_specs_and_registry()` | None | 1 tool, in registry | Medium |  | Extra tools execution path | None |
| `test_extra_tools_without_executor_skipped` | Extra tools without executor are skipped in non-passthrough mode | Orphaned extra tools | `_build_collision_safe_tool_specs_and_registry()` | logging.getLogger("test") | Empty tools | Medium |  | Extra tools require executor | None |
| `test_pick_executor_prefers_builtin` | _pick_executor prefers builtin registry for request tools | Executor preference order (builtin first) | `_build_collision_safe_tool_specs_and_registry()` with builtin+owui | None | 1 tool in registry | High |  | Executor preference algorithm | Verify preference order |
| `test_pick_executor_falls_back_to_owui` | _pick_executor falls back to owui when builtin not available | Fallback to owui registry | `_build_collision_safe_tool_specs_and_registry()` with only owui | None | 1 tool in registry | High |  | Fallback chain to owui | None |
| `test_pick_executor_falls_back_to_direct` | _pick_executor falls back to direct when builtin and owui not available | Fallback to direct registry | `_build_collision_safe_tool_specs_and_registry()` with only direct | None | 2 tools, one with extra__/direct__ prefix | High |  | Fallback chain to direct | None |
| `test_duplicate_collision_with_hash` | Multiple collisions with same prefix get hash suffix | Hash suffix for duplicate prefixes | `_build_collision_safe_tool_specs_and_registry()` with 4 sources of "common" | None | All names unique | High |  | Critical hash collision handling | Verify hash algorithm |
| `test_direct_registry_without_callable_skipped` | Direct registry entries without callable are skipped (non-passthrough) | Direct registry validation | `_build_collision_safe_tool_specs_and_registry()` | None | Empty tools | Medium |  | Direct tools need callable | None |
| `test_owui_registry_tool_not_in_request_names` | OWUI registry tools not in request names are added | Adding unique OWUI tools | `_build_collision_safe_tool_specs_and_registry()` | None | 1 tool with correct name | Medium |  | OWUI tools addition logic | None |
| `test_owui_registry_tool_in_request_names_skipped` | OWUI registry tools already in request names are skipped | Deduplication of OWUI vs request | `_build_collision_safe_tool_specs_and_registry()` | None | Only 1 tool (duplicate skipped) | High |  | Prevents duplicate request tools | None |
| `test_tool_cfg_spec_parameters_updated` | Tool cfg spec parameters are updated from normalized spec | Parameter update in registry | `_build_collision_safe_tool_specs_and_registry()` | None | Checks cfg spec name | Medium |  | Registry spec synchronization | Verify update logic |
| `test_passthrough_mode_skips_registry_population` | In passthrough mode, exec_registry is not populated | Registry behavior in passthrough | `_build_collision_safe_tool_specs_and_registry()` with passthrough=True | None | Tools present, registry empty, exposed_to_origin populated | High |  | Passthrough skips registry | None |
| `test_tool_cfg_without_callable_not_in_registry` | Tool cfg without callable is not added to exec_registry (line 372 coverage) | Callable=None handling | `_build_collision_safe_tool_specs_and_registry()` with callable=None | logging.getLogger("test") | Empty tools/registry | Medium |  | Filters tools with no callable | None |
| `test_no_function_calling_support_returns_empty` | Model without function calling returns empty tools | Model capability check | `build_tools()` with "no-tool-model" | mock_valves, mock_responses_body | Returns [] | High |  | Model feature gate | Verify capability check |
| `test_passthrough_mode_bypasses_model_check` | Passthrough mode bypasses model capability check | Passthrough overrides model check | `build_tools()` with TOOL_EXECUTION_MODE="Open-WebUI" | mock_valves, mock_responses_body | Non-empty result | High |  | Passthrough bypasses feature gate | None |
| `test_dict_tools_transformed` | Dict-style __tools__ are transformed via ResponsesBody | Dict tools handling | `build_tools()` with tools_dict | mock_valves, mock_responses_body | Result is list | Medium |  | Dict-to-list transformation | Verify transform still used |
| `test_list_tools_filtered` | List-style tools are filtered to include only dicts | List filtering | `build_tools()` with mixed list | mock_valves, mock_responses_body | Only dict items in result | Medium |  | Type filtering for tools | None |
| `test_extra_tools_appended` | Extra tools are appended to the result | Extra tools parameter | `build_tools()` with extra_tools | mock_valves, mock_responses_body | extra_tool in result | Medium |  | Extra tools integration | None |
| `test_features_parameter_accepted` | Features parameter is accepted (for future use) | Features parameter handling | `build_tools()` with features dict | mock_valves, mock_responses_body | Result is list | Low |  | Future extensibility | None |
| `test_prefer_builtin_finds_in_builtin` | Test that prefer='builtin' finds executor in builtin registry first | Executor preference: builtin first | `_build_collision_safe_tool_specs_and_registry()` | None | 1 tool, in registry | High |  | Builtin preference path | Verify preference logic |
| `test_prefer_owui_fallback` | Test fallback to owui when builtin not found | Executor fallback: owui | `_build_collision_safe_tool_specs_and_registry()` | None | 1 tool in registry | High |  | OWUI fallback path | None |
| `test_prefer_direct_fallback` | Test fallback to direct when builtin and owui not found | Executor fallback: direct | `_build_collision_safe_tool_specs_and_registry()` | None | 2 tools, one with prefix | High |  | Direct fallback path | None |
| `test_no_executor_found` | Test when no executor is found in any registry | No executor available | `_build_collision_safe_tool_specs_and_registry()` | logging.getLogger("test") | Empty tools/registry | Medium |  | Orphaned tool handling | None |
| `test_non_dict_registry_values_filtered` | Non-dict values in registries are filtered out | Registry validation | `_build_collision_safe_tool_specs_and_registry()` with invalid registry entries | None | Only 1 valid tool | Medium |  | Registry type validation | None |
| `test_invalid_request_tool_specs_filtered` | Invalid request tool specs are filtered out | Request tool validation | `_build_collision_safe_tool_specs_and_registry()` with invalid specs | None | Only 1 valid tool | Medium |  | Request spec validation | None |
| `test_origin_key_fallback` | Origin key uses fallback when not provided | Origin_key fallback logic | `_build_collision_safe_tool_specs_and_registry()` | None | Tool in exposed_to_origin | Medium |  | Default origin_key behavior | None |
| `test_cfg_spec_not_dict_handled` | Tool cfg with non-dict spec in registry is handled | Spec type handling | `_build_collision_safe_tool_specs_and_registry()` | None | 1 tool | Low |  | Robust spec handling | None |
| `test_strictify_applies_to_all_sources` | Strictify flag applies to tools from all sources | Global strictify application | `_build_collision_safe_tool_specs_and_registry()` with strictify=True | None | parameters.additionalProperties == False | Medium |  | Strictify propagation | None |
| `test_direct_registry_invalid_spec_skipped` | Direct registry entries with invalid spec are skipped (line 285) | Direct registry spec validation | `_build_collision_safe_tool_specs_and_registry()` | None | Only 1 valid tool | Medium |  | Direct spec filtering | None |
| `test_owui_registry_invalid_spec_skipped` | OWUI registry entries with invalid spec are skipped (line 303) | OWUI registry spec validation | `_build_collision_safe_tool_specs_and_registry()` | None | Only 1 valid tool | Medium |  | OWUI spec filtering | None |
| `test_owui_registry_no_callable_skipped_non_passthrough` | OWUI registry entries without callable are skipped in non-passthrough mode (line 308) | OWUI callable requirement | `_build_collision_safe_tool_specs_and_registry()` | None | Only 1 valid tool | Medium |  | OWUI callable validation | None |
| `test_extra_tools_invalid_spec_skipped` | Extra tools with invalid spec are skipped (line 323) | Extra tools spec validation | `_build_collision_safe_tool_specs_and_registry()` | None | Only 1 valid tool | Medium |  | Extra spec filtering | None |
| `test_hash_collision_suffix_applied` | Hash suffix is applied when exposed_name already exists (lines 357-360) | Hash collision handling | `_build_collision_safe_tool_specs_and_registry()` with multiple servers | None | 2 unique names, both with direct__ prefix, one with hash | High |  | Critical hash suffix logic | Verify hash generation |
| `test_tool_cfg_not_dict_in_final_loop` | Tool cfg that is not a dict is skipped in final loop (line 372 branch) | Tool_cfg validation in final loop | `_build_collision_safe_tool_specs_and_registry()` with callable=None | logging.getLogger("test") | Empty tools/registry | Medium |  | Final loop validation | None |
| `test_passthrough_with_valid_tool_cfg_skips_registry` | In passthrough mode, even valid tool_cfg is not added to registry (line 369-370) | Passthrough registry skip | `_build_collision_safe_tool_specs_and_registry()` with passthrough=True | None | Tools present, empty registry, exposed_to_origin populated | High |  | Passthrough registry behavior | None |
| `test_direct_entry_with_passthrough_includes_without_callable` | Direct entries without callable are included in passthrough mode | Passthrough includes all direct | `_build_collision_safe_tool_specs_and_registry()` with passthrough=True | None | 1 tool without callable | Medium |  | Passthrough permits no callable | None |
| `test_owui_registry_with_passthrough_includes_without_callable` | OWUI registry entries without callable are included in passthrough mode | Passthrough includes all OWUI | `_build_collision_safe_tool_specs_and_registry()` with passthrough=True | None | 1 tool without callable | Medium |  | Passthrough permits no callable | None |
| `test_extra_tools_with_passthrough_includes_without_executor` | Extra tools without executor are included in passthrough mode | Passthrough includes orphaned extra | `_build_collision_safe_tool_specs_and_registry()` with passthrough=True | None | 1 tool without executor | Medium |  | Passthrough permits orphaned tools | None |


## `tests/test_tools.py`

This file contains 216 comprehensive tests covering tool_executor.py, tool_registry.py, tool_worker.py, and tool passthrough/execution features. Tests were created to achieve 90%+ coverage for the tools module.

| Test Name | Description | What It Tests | Code Under Test | Mocks/Fixtures | Assertions | Drift Risk | Check Done | Codex Notes | Codex TODO |
|-----------|-------------|---------------|-----------------|----------------|------------|------------|------------|-------------|------------|
| test_execute_function_calls_with_context_missing_tool_name | Test that calls with missing/empty tool name return proper error | Error handling for missing/empty tool name in context-based execution | `_execute_function_calls()` lines 93-101 | Pipe instance, ToolExecutionContext | Checks output contains "Tool call missing name" | LOW - Basic validation |  | Tests error path for missing tool name in new context-based tool execution | None |
| test_execute_function_calls_with_context_tool_not_found | Test that calls to non-existent tools return proper error | Error handling for tool not found in registry | `_execute_function_calls()` lines 103-112 | Pipe instance, ToolExecutionContext, empty tools dict | Checks output contains "Tool not found" | LOW - Registry lookup |  | Verifies tool registry lookup failure handling | None |
| test_execute_function_calls_with_context_circuit_breaker_skips | Test that tools skipped by circuit breaker emit notifications | Circuit breaker integration with tool execution | `_execute_function_calls()` lines 114-123, circuit breaker | Pipe instance, ToolExecutionContext, mock emitter, force 20 failures | Checks skip/completion status | MED - Circuit breaker state |  | Tests circuit breaker prevents tool execution after failures | Verify circuit breaker reset logic |
| test_execute_function_calls_with_context_no_callable | Test that tools without callables return proper error | Validation of tool configuration | `_execute_function_calls()` lines 125-134 | Pipe instance, tool config without callable | Checks output contains "no callable" | LOW - Config validation |  | Ensures tools must have callable function | None |
| test_execute_function_calls_with_context_empty_args_required_params | Test that empty string args with required params raise error | Parameter validation for required arguments | `_execute_function_calls()` lines 137-149 | Pipe instance, tool with required params | Checks "Missing tool arguments" or "Invalid arguments" | LOW - Validation logic |  | Tests required parameter enforcement | None |
| test_execute_function_calls_with_context_invalid_json_args | Test that invalid JSON args return proper error | JSON parsing and error handling | `_execute_function_calls()` lines 154-163 | Pipe instance, invalid JSON string | Checks "Invalid arguments" in output | LOW - JSON parsing |  | Validates JSON argument parsing | None |
| test_execute_function_calls_with_context_origin_logging | Test that origin_source and origin_name are logged | Logging of tool origin metadata | `_execute_function_calls()` lines 177-186 | Pipe instance, tool with origin metadata, queue manual resolution | Checks queued item created and future resolved | MED - Async queue behavior |  | Verifies origin tracking for tools | None |
| test_execute_function_calls_with_context_idle_timeout | Test that idle timeout raises RuntimeError | Idle timeout handling in tool execution | `_execute_function_calls()` lines 196-208 | Pipe instance, 0.01s idle timeout | Checks RuntimeError with "idle timeout" | MED - Timeout logic |  | Tests idle timeout triggers proper error | Verify timeout handling in production |
| test_execute_function_calls_with_context_timeout_error_propagation | Test that context.timeout_error is raised at end | Error propagation from context | `_execute_function_calls()` line 225 | Pipe instance, pre-set timeout_error | Checks RuntimeError contains error message | LOW - Error propagation |  | Verifies timeout errors propagate correctly | None |
| test_build_direct_tool_server_registry_invalid_metadata | Test that invalid metadata returns empty registry | Input validation for metadata | `_build_direct_tool_server_registry()` line 251 | Invalid metadata (string not dict) | Checks empty registry and specs | LOW - Type validation |  | Guards against invalid metadata types | None |
| test_build_direct_tool_server_registry_no_tool_servers | Test that missing tool_servers returns empty registry | Handling of missing tool_servers key | `_build_direct_tool_server_registry()` lines 253-254 | Metadata without tool_servers | Checks empty registry and specs | LOW - Key validation |  | Handles missing tool_servers gracefully | None |
| test_build_direct_tool_server_registry_no_event_call | Test that missing event_call returns empty registry | Validation of required event_call parameter | `_build_direct_tool_server_registry()` lines 255-257 | Metadata with tools but event_call=None | Checks empty registry and specs | LOW - Param validation |  | Ensures event_call is required | None |
| test_build_direct_tool_server_registry_invalid_server_entry | Test that invalid server entries are skipped | Filtering of invalid server configurations | `_build_direct_tool_server_registry()` lines 261-262 | Invalid server entries (strings, None, ints) | Checks empty registry | LOW - Type filtering |  | Skips non-dict server entries | None |
| test_build_direct_tool_server_registry_empty_specs | Test that servers without specs are skipped | Validation of server specs | `_build_direct_tool_server_registry()` line 264 | Server without specs key | Checks empty registry | LOW - Spec validation |  | Requires specs for tool servers | None |
| test_build_direct_tool_server_registry_invalid_spec_entry | Test that invalid spec entries are skipped | Filtering invalid tool specs | `_build_direct_tool_server_registry()` lines 286-287 | Mixed valid/invalid specs | Checks only valid_tool in registry | LOW - Spec filtering |  | Filters out invalid tool specs | None |
| test_build_direct_tool_server_registry_callable_execution | Test that generated callable executes properly | Direct tool callable generation and execution | `_build_direct_tool_server_registry()` lines 307-351 | Mock event_call, tool with parameters | Checks event_call payload contains tool data | MED - Callable generation |  | Tests complete callable creation and execution flow | None |
| test_build_direct_tool_server_registry_callable_no_event_call | Test that callable with None event_call returns error | Runtime validation of event_call | Callable with _event_call=None | Manual callable test | Checks error "Direct tool execution unavailable" | LOW - Null check |  | Tests event_call None handling | None |
| test_build_direct_tool_server_registry_callable_exception | Test that callable handles exceptions gracefully | Exception handling in tool callables | Callable exception handling lines 342-351 | Failing event_call, mock emitter | Checks error dict returned | MED - Exception handling |  | Ensures tool errors don't crash | None |
| test_build_direct_tool_server_registry_outer_exception | Test that outer exception returns empty registry | Top-level exception handling | `_build_direct_tool_server_registry()` lines 380-382 | BadDict that raises on .get() | Checks empty registry and specs | LOW - Exception safety |  | Prevents crashes from bad metadata | None |
| test_legacy_execute_missing_tool_name | Test legacy execution with missing tool name | Legacy path error handling | `_execute_function_calls_legacy()` line 401 | Empty tool name | Checks "Tool error" and "completed" status | LOW - Basic validation |  | Legacy fallback handles missing names | None |
| test_legacy_execute_tool_not_found | Test legacy execution with non-existent tool | Legacy path tool lookup | `_execute_function_calls_legacy()` line 405 | Non-existent tool name | Checks "Tool error" and "not found" | LOW - Registry lookup |  | Legacy path tool not found handling | None |
| test_legacy_execute_no_callable | Test legacy execution with tool missing callable | Legacy path callable validation | `_execute_function_calls_legacy()` line 409 | Tool without callable | Checks "Tool error" and "no callable" | LOW - Validation |  | Legacy path requires callable | None |
| test_legacy_execute_empty_args_with_required | Test legacy execution with empty args and required params | Legacy path parameter validation | `_execute_function_calls_legacy()` lines 421-424 | Empty args with required params | Checks "Tool error" with "empty string" or "missing" | LOW - Validation |  | Legacy enforces required params | None |
| test_legacy_execute_empty_args_no_required | Test legacy execution with empty args but no required params | Legacy path allows empty args when no requirements | `_execute_function_calls_legacy()` line 424 | Empty args, no required params | Checks call count == 1 and status "completed" | LOW - Validation logic |  | Empty args OK when not required | None |
| test_legacy_execute_sync_callable | Test legacy execution with sync callable | Legacy path sync function support | `_execute_function_calls_legacy()` line 434 | Sync (non-async) callable | Checks execution and output | LOW - Sync support |  | Legacy supports sync callables | None |
| test_legacy_execute_tool_exception | Test legacy execution when tool raises exception | Legacy exception handling | Tool exception in legacy path | Tool that raises ValueError | Checks "completed" status and error in output | MED - Exception handling |  | Legacy catches and reports tool errors | None |
| test_legacy_execute_tool_returns_none | Test legacy execution when tool returns None | Legacy None handling | Tool returns None | Tool returning None | Checks "completed" status and empty output | LOW - None handling |  | Legacy handles None returns | None |
| test_notify_tool_breaker_no_emitter | Test that notify_tool_breaker does nothing without emitter | Null emitter handling | `_notify_tool_breaker()` line 463 | event_emitter=None | No exception raised | LOW - Null safety |  | Gracefully handles missing emitter | None |
| test_notify_tool_breaker_emitter_exception | Test that emitter exceptions are suppressed | Emitter exception safety | `_notify_tool_breaker()` lines 476-478 | Emitter that raises | No exception propagated | MED - Exception suppression |  | Prevents emitter crashes | None |
| test_notify_tool_breaker_success | Test successful notification emission | Normal notification flow | `_notify_tool_breaker()` | Mock emitter | Checks event emitted with tool name | LOW - Happy path |  | Normal breaker notification | None |
| test_build_tool_output_status_normalization | Test that invalid statuses are normalized to 'completed' | Status normalization logic | `_build_tool_output()` | Invalid status string | Checks status == "completed" | LOW - Normalization |  | Invalid statuses normalized | None |
| test_build_tool_output_valid_statuses | Test that valid statuses are preserved | Status preservation | `_build_tool_output()` | Valid statuses: completed, incomplete, in_progress | Checks statuses preserved | LOW - Validation |  | Valid statuses unchanged | None |
| test_build_tool_output_missing_call_id | Test that missing call_id generates a new one | Call ID generation | `_build_tool_output()` | Empty dict (no call_id) | Checks call_id and id generated | LOW - ID generation |  | Auto-generates missing call IDs | None |
| test_tool_executor_initialization | Test ToolExecutor initializes correctly | Constructor validation | ToolExecutor.__init__() | Pipe instance | Checks attributes set correctly | LOW - Constructor |  | Basic initialization | None |
| test_execute_function_calls_breaker_only_skips_records_failure | Test that all calls being breaker-skipped records a failure | Circuit breaker failure recording | Breaker skip path line 191-192 | Force all tools skipped | Checks outputs length >= 1 | MED - Failure tracking |  | Breaker skips recorded as failures | Verify failure count increments |
| test_execute_function_calls_with_none_arguments | Test that None arguments are handled correctly | None argument handling | Arguments parsing | arguments=None | Checks queue item created and resolved | LOW - None handling |  | Handles None args | None |
| test_execute_function_calls_whitespace_tool_name | Test that whitespace-only tool names are handled | Whitespace validation | Tool name validation | Tool name "   " | Checks error for missing/not found | LOW - Validation |  | Whitespace-only names rejected | None |
| test_legacy_execute_parallel_calls | Test legacy execution handles parallel calls correctly | Legacy parallel execution | `_execute_function_calls_legacy()` with asyncio.gather | Two async tools | Checks both executed | MED - Async execution |  | Legacy supports parallel execution | None |
| test_build_direct_tool_server_registry_with_parameters | Test building registry with proper parameter filtering | Parameter filtering in callables | Callable parameter filtering lines 320-321 | Tool with defined parameters | Checks only allowed params passed | MED - Param filtering |  | Only spec-defined params passed | None |
| test_execute_function_calls_empty_args_no_required_in_context | Test empty string args with no required params in context-based path | Context path empty args handling | `_execute_function_calls()` line 150 | Empty args, no required | Checks args parsed as {} | LOW - Args parsing |  | Empty args OK when not required | None |
| test_build_direct_tool_server_registry_openapi_fallback | Test OpenAPI fallback conversion | OpenAPI conversion path lines 268-276 | Server with openapi, no specs | Checks registry and specs types | MED - OpenAPI fallback |  | Falls back to OpenAPI conversion | Test OpenAPI conversion |
| test_build_direct_tool_server_registry_spec_exception | Test that exceptions in spec processing are handled | Spec exception handling lines 361-364 | BadSpec that raises | Checks isinstance registry dict | MED - Exception safety |  | Spec errors don't crash | None |
| test_build_direct_tool_server_registry_server_exception | Test that exceptions in server processing are handled | Server exception handling lines 365-368 | BadServer that raises | Checks isinstance registry dict | MED - Exception safety |  | Server errors don't crash | None |
| test_build_direct_tool_server_registry_transform_exception | Test that exception in transform_owui_tools is handled | Transform exception handling lines 377-378 | Valid registry | Checks registry and specs | MED - Transform safety |  | Transform errors handled | None |
| test_legacy_execute_invalid_json_arguments | Test legacy execution with invalid JSON arguments | Legacy JSON parsing lines 428-430 | Invalid JSON string | Checks "Tool error" and "Invalid arguments" | LOW - JSON parsing |  | Legacy validates JSON args | None |
| test_legacy_execute_dict_arguments | Test legacy execution with dict arguments (already parsed) | Legacy pre-parsed args | Dict arguments | Checks kwargs received and completed | LOW - Dict support |  | Legacy accepts dict args | None |
| test_execute_function_calls_fallback_to_legacy | Test that _execute_function_calls falls back to legacy when no context | Legacy fallback lines 79-81 | No TOOL_CONTEXT set | Checks execution via legacy path | MED - Fallback logic |  | Falls back to legacy when no context | None |
| test_build_direct_tool_server_no_session_id | Test direct tool callable when metadata has no session_id | Session ID handling | Callable with no session_id | Checks session_id is None | LOW - Null session |  | Handles missing session ID | None |
| test_build_direct_tool_server_no_parameters | Test direct tool callable when spec has no parameters | No parameters handling | Spec without parameters | Checks params == {} | LOW - No params |  | Handles tools without params | None |
| test_execute_function_calls_with_dict_arguments | Test context-based execution with dict arguments (already parsed) | Context path dict args | Dict arguments | Checks args == {"key": "value"} | LOW - Dict support |  | Context path accepts dict args | None |
| test_multiple_tools_with_various_errors | Test handling multiple tools with various error conditions | Multiple error scenarios | Various error conditions | Checks all 4 calls have outputs | MED - Error handling |  | Handles mixed success/error scenarios | None |
| test_direct_tool_callable_event_call_becomes_none | Test direct tool callable handles runtime None _event_call | Runtime event_call validation | Callable with event_call | Checks normal execution | LOW - Validation |  | Tests event_call presence check | None |
| test_build_direct_tool_server_registry_spec_with_failing_dict | Test spec processing with a dict-like object that raises on certain ops | Failing dict handling lines 361-364 | FailingDict that raises on keys() | Checks isinstance registry dict | MED - Resilience |  | Handles failing dict operations | None |
| test_build_direct_tool_server_metadata_get_fails | Test callable handles failing metadata.get() | Metadata.get() exception lines 326-327 | FailingMetadata.get() raises | Checks session_id is None | MED - Exception handling |  | Handles metadata access errors | None |
| test_build_direct_tool_server_bad_properties_keys | Test callable handles failing properties.keys() | Properties.keys() exception lines 320-321 | FailingProperties.keys() raises | Checks params == {} | MED - Exception handling |  | Handles properties access errors | None |
| test_build_direct_tool_server_spec_params_access_fails | Test spec processing when parameters access fails | Parameters access exception lines 300-301 | FailingParams.get() raises | Checks registry length == 1 | MED - Exception handling |  | Handles parameter access errors | None |
| test_build_tools_returns_empty_when_model_does_not_support_function_calling | Test that build_tools returns [] when model doesn't support function calling | Model capability check | build_tools() with unsupported model | ModelFamily.supports=False | Checks tools == [] | MED - Feature detection |  | Respects model capabilities | None |
| test_build_tools_includes_tools_when_passthrough_enabled | Test that tools are included when passthrough is enabled even if model doesn't support function calling | Passthrough mode bypass | build_tools() in passthrough mode | ModelFamily.supports=False, passthrough=True | Checks tools included | MED - Passthrough logic |  | Passthrough bypasses capability check | None |
| test_build_tools_with_dict_tools | Test build_tools with dict-format __tools__ | Dict tools processing | build_tools() with dict | Sample OWUI tools | Checks 2 tools with correct names | LOW - Dict processing |  | Processes dict-format tools | None |
| test_build_tools_with_list_tools | Test build_tools with list-format __tools__ (already OpenAI format) | List tools processing | build_tools() with list | List with invalid entry | Checks 2 valid tools, invalid filtered | LOW - List processing |  | Processes list-format tools, filters invalid | None |
| test_build_tools_with_extra_tools | Test build_tools with extra_tools parameter | Extra tools parameter | build_tools() with extra_tools | Extra tools list | Checks extra_tool included | LOW - Extra tools |  | Supports extra_tools parameter | None |
| test_build_tools_deduplicates | Test that build_tools deduplicates tools with same name | Deduplication logic | build_tools() with duplicates | Two tools with same name | Checks 1 tool, last wins | MED - Dedup logic |  | Deduplicates by name, last wins | None |
| test_build_tools_with_strict_calling | Test build_tools with strict tool calling enabled | Strict mode application | build_tools() with strictify=True | Strict mode enabled | Checks additionalProperties: false | MED - Strictification |  | Applies strict mode to tools | None |
| test_build_tools_with_empty_tools | Test build_tools with empty tools dict | Empty input handling | build_tools() with {} | Empty dict | Checks tools == [] | LOW - Empty input |  | Handles empty tools | None |
| test_build_tools_with_none_features | Test build_tools with features=None (default) | None features handling | build_tools() with features=None | None features | Checks tools == [] | LOW - None handling |  | Handles None features | None |
| test_dedupe_tools_empty_list | Test deduplication with empty list | Empty list handling | _dedupe_tools([]) | Empty list | Checks result == [] | LOW - Edge case |  | Handles empty list | None |
| test_dedupe_tools_none | Test deduplication with None | None handling | _dedupe_tools(None) | None input | Checks result == [] | LOW - None handling |  | Handles None input | None |
| test_dedupe_tools_non_dict_items | Test that non-dict items are filtered out | Type filtering | _dedupe_tools() with mixed types | String, int, None items | Checks only dict item remains | LOW - Type filtering |  | Filters non-dict items | None |
| test_dedupe_tools_non_function_types | Test deduplication with non-function tool types | Non-function types | _dedupe_tools() with web_search, code_interpreter | Non-function types | Checks dedup by type, last wins | MED - Type handling |  | Handles non-function tool types | None |
| test_dedupe_tools_mixed_types | Test deduplication with mixed function and non-function tools | Mixed types | _dedupe_tools() with mixed | function and web_search | Checks all 3 tools | LOW - Mixed handling |  | Handles mixed tool types | None |
| test_dedupe_tools_no_type_key | Test that tools without type key are filtered | Missing type key | _dedupe_tools() with no type | Tool without type | Checks filtered out | LOW - Validation |  | Requires type key | None |
| test_dedupe_tools_empty_type | Test that tools with empty/None type are filtered | Empty type handling | _dedupe_tools() with empty/None type | Empty and None type | Checks filtered out | LOW - Validation |  | Requires non-empty type | None |
| test_normalize_valid_tool | Test normalization of a valid function tool | Normal operation | _normalize_responses_function_tool_spec() | Valid tool | Checks all fields preserved | LOW - Happy path |  | Normalizes valid tools | None |
| test_normalize_non_dict_returns_none | Test that non-dict input returns None | Type validation | _normalize_responses_function_tool_spec() | String, int, None, list | Checks None returned | LOW - Type check |  | Rejects non-dict input | None |
| test_normalize_non_function_type_returns_none | Test that non-function type returns None | Type filtering | _normalize_responses_function_tool_spec() | web_search type | Checks None returned | LOW - Type check |  | Only processes function type | None |
| test_normalize_missing_type_returns_none | Test that missing type returns None | Type requirement | _normalize_responses_function_tool_spec() | No type key | Checks None returned | LOW - Validation |  | Requires type field | None |
| test_normalize_invalid_name_returns_none | Test that invalid name returns None | Name validation | _normalize_responses_function_tool_spec() | Int, empty, whitespace, None names | Checks None returned | LOW - Validation |  | Validates name field | None |
| test_normalize_strips_name | Test that name is stripped of whitespace | Name normalization | _normalize_responses_function_tool_spec() | Name with spaces | Checks name stripped | LOW - Normalization |  | Strips whitespace from name | None |
| test_normalize_with_strictify | Test normalization with strictify enabled | Strictify integration | _normalize_responses_function_tool_spec() with strictify | strictify=True | Checks additionalProperties: false | LOW - Strictify |  | Applies strictify | None |
| test_normalize_without_parameters | Test normalization without parameters | Optional parameters | _normalize_responses_function_tool_spec() | No parameters | Checks parameters not in result | LOW - Optional field |  | Parameters optional | None |
| test_normalize_with_empty_description | Test that empty description is not included | Empty description handling | _normalize_responses_function_tool_spec() | Empty description | Checks description not in result | LOW - Empty field |  | Omits empty description | None |
| test_normalize_with_whitespace_description | Test that whitespace-only description is not included | Whitespace description | _normalize_responses_function_tool_spec() | Whitespace description | Checks description not in result | LOW - Validation |  | Omits whitespace-only description | None |
| test_normalize_strips_description | Test that description is stripped | Description normalization | _normalize_responses_function_tool_spec() | Description with spaces | Checks description stripped | LOW - Normalization |  | Strips description | None |
| test_normalize_non_dict_parameters_ignored | Test that non-dict parameters are ignored | Parameters type check | _normalize_responses_function_tool_spec() | String parameters | Checks parameters not in result | LOW - Type check |  | Ignores non-dict parameters | None |
| test_valid_tool_cfg | Test conversion of a valid OWUI tool config | Normal operation | _responses_spec_from_owui_tool_cfg() | Valid tool config | Checks all fields converted | LOW - Happy path |  | Converts OWUI config | None |
| test_non_dict_returns_none | Test that non-dict input returns None | Type validation | _responses_spec_from_owui_tool_cfg() | String, int, None | Checks None returned | LOW - Type check |  | Rejects non-dict | None |
| test_missing_spec_returns_none | Test that missing spec returns None | Spec requirement | _responses_spec_from_owui_tool_cfg() | No spec key | Checks None returned | LOW - Validation |  | Requires spec | None |
| test_non_dict_spec_returns_none | Test that non-dict spec returns None | Spec type check | _responses_spec_from_owui_tool_cfg() | String spec | Checks None returned | LOW - Type check |  | Spec must be dict | None |
| test_invalid_name_returns_none | Test that invalid name returns None | Name validation | _responses_spec_from_owui_tool_cfg() | Invalid names | Checks None returned | LOW - Validation |  | Validates name | None |
| test_missing_parameters_uses_default | Test that missing parameters uses default object schema | Default parameters | _responses_spec_from_owui_tool_cfg() | No parameters | Checks default object schema | LOW - Defaults |  | Uses default params schema | None |
| test_non_dict_parameters_uses_default | Test that non-dict parameters uses default object schema | Parameters type fallback | _responses_spec_from_owui_tool_cfg() | Invalid parameters | Checks default object schema | LOW - Fallback |  | Fallback to default params | None |
| test_missing_description_uses_name | Test that missing description uses name as fallback | Description fallback | _responses_spec_from_owui_tool_cfg() | No description | Checks description == name | LOW - Fallback |  | Uses name as description fallback | None |
| test_with_strictify | Test conversion with strictify enabled | Strictify integration | _responses_spec_from_owui_tool_cfg() with strictify | strictify=True | Checks additionalProperties: false | LOW - Strictify |  | Applies strictify | None |
| test_owui_request_tools_prefix | Test prefix for owui_request_tools source | Prefix determination | _tool_prefix_for_collision() | owui_request_tools | Checks "owui__" | LOW - Prefix logic |  | Correct prefix for request tools | None |
| test_direct_tool_server_prefix | Test prefix for direct_tool_server source | Prefix determination | _tool_prefix_for_collision() | direct_tool_server | Checks "direct__" | LOW - Prefix logic |  | Correct prefix for direct tools | None |
| test_extra_tools_prefix | Test prefix for extra_tools source | Prefix determination | _tool_prefix_for_collision() | extra_tools | Checks "extra__" | LOW - Prefix logic |  | Correct prefix for extra tools | None |
| test_registry_tools_with_direct_flag | Test prefix for registry tools with direct flag | Conditional prefix | _tool_prefix_for_collision() | owui_registry_tools with direct=True | Checks "direct__" | LOW - Conditional |  | Direct flag changes prefix | None |
| test_registry_tools_without_direct_flag | Test prefix for registry tools without direct flag | Default prefix | _tool_prefix_for_collision() | owui_registry_tools with direct=False | Checks "tool__" | LOW - Default |  | Default prefix for registry | None |
| test_registry_tools_with_none_cfg | Test prefix for registry tools with None config | None handling | _tool_prefix_for_collision() | owui_registry_tools with None cfg | Checks "tool__" | LOW - None handling |  | Handles None config | None |
| test_unknown_source | Test prefix for unknown source defaults to tool__ | Unknown source handling | _tool_prefix_for_collision() | unknown_source | Checks "tool__" | LOW - Default |  | Unknown sources get default | None |
| test_empty_inputs | Test with all empty inputs | Empty inputs | _build_collision_safe_tool_specs_and_registry() | All None/empty | Checks empty results | LOW - Edge case |  | Handles all empty inputs | None |
| test_request_tools_with_matching_executor | Test request tools that have matching executors | Executor matching | _build_collision_safe_tool_specs_and_registry() | Request + builtin registry | Checks tool in tools and exec_reg | MED - Registry matching |  | Matches request to builtin | None |
| test_request_tools_without_callable_skipped | Test that request tools without callable are skipped in pipeline mode | Pipeline mode filtering | _build_collision_safe_tool_specs_and_registry() | Request without executor | Checks tools == [] | MED - Mode logic |  | Pipeline requires executors | None |
| test_request_tools_without_callable_included_in_passthrough | Test that request tools without callable are included in passthrough mode | Passthrough inclusion | _build_collision_safe_tool_specs_and_registry() | Request tool, passthrough=True | Checks tool included | MED - Passthrough |  | Passthrough includes all tools | None |
| test_direct_registry_tools | Test direct registry tools are included | Direct registry processing | _build_collision_safe_tool_specs_and_registry() | Direct registry | Checks tool included | LOW - Registry |  | Processes direct registry | None |
| test_direct_registry_without_callable_skipped | Test direct registry tools without callable are skipped in pipeline mode | Pipeline filtering | _build_collision_safe_tool_specs_and_registry() | Direct without callable | Checks tools == [] | MED - Filtering |  | Pipeline requires callable | None |
| test_owui_registry_tools | Test OWUI registry tools are included | OWUI registry processing | _build_collision_safe_tool_specs_and_registry() | OWUI registry | Checks tool included | LOW - Registry |  | Processes OWUI registry | None |
| test_owui_registry_skips_request_duplicates | Test that OWUI registry skips tools already in request tools | Deduplication | _build_collision_safe_tool_specs_and_registry() | Request + OWUI same name | Checks only 1 tool | MED - Dedup logic |  | Request takes precedence | None |
| test_owui_registry_without_callable_skipped | Test OWUI registry tools without callable are skipped in pipeline mode | Pipeline filtering | _build_collision_safe_tool_specs_and_registry() | OWUI without callable | Checks tools == [] | MED - Filtering |  | Pipeline requires callable | None |
| test_extra_tools_with_executor | Test extra tools that have matching executors | Extra tools processing | _build_collision_safe_tool_specs_and_registry() | Extra + builtin | Checks tool and executor | LOW - Extra tools |  | Processes extra tools | None |
| test_extra_tools_without_callable_skipped | Test that extra tools without callable are skipped in pipeline mode | Pipeline filtering | _build_collision_safe_tool_specs_and_registry() | Extra without executor | Checks tools == [] | MED - Filtering |  | Pipeline requires executor | None |
| test_extra_tools_included_in_passthrough | Test that extra tools without callable are included in passthrough mode | Passthrough inclusion | _build_collision_safe_tool_specs_and_registry() | Extra, passthrough=True | Checks tool included | MED - Passthrough |  | Passthrough includes extras | None |
| test_collision_renaming | Test that colliding tool names are renamed | Collision detection and renaming | _build_collision_safe_tool_specs_and_registry() | Multiple same-name tools | Checks prefixed names | HIGH - Collision logic |  | Renames colliding tools | Verify prefix uniqueness |
| test_collision_with_hash_digest | Test that further collisions add hash digest | Hash suffix generation | _build_collision_safe_tool_specs_and_registry() | Multiple direct with same name | Checks hash suffix added | HIGH - Hash logic |  | Adds hash for further collisions | None |
| test_invalid_request_tools_skipped | Test that invalid request tools are skipped | Request validation | _build_collision_safe_tool_specs_and_registry() | Invalid request tools | Checks tools == [] | LOW - Validation |  | Filters invalid requests | None |
| test_invalid_direct_registry_skipped | Test that invalid direct registry entries are skipped | Direct validation | _build_collision_safe_tool_specs_and_registry() | Invalid direct entries | Checks tools == [] | LOW - Validation |  | Filters invalid direct entries | None |
| test_invalid_owui_registry_skipped | Test that invalid OWUI registry entries are skipped | OWUI validation | _build_collision_safe_tool_specs_and_registry() | Invalid OWUI entries | Checks tools == [] | LOW - Validation |  | Filters invalid OWUI entries | None |
| test_invalid_extra_tools_skipped | Test that invalid extra tools are skipped | Extra validation | _build_collision_safe_tool_specs_and_registry() | Invalid extra tools | Checks tools == [] | LOW - Validation |  | Filters invalid extras | None |
| test_exec_registry_includes_spec_updates | Test that exec registry includes updated spec with parameters | Spec update tracking | _build_collision_safe_tool_specs_and_registry() | Request with params | Checks spec updated in exec_reg | MED - Spec tracking |  | Tracks spec updates in registry | None |
| test_passthrough_mode_skips_exec_registry | Test that passthrough mode doesn't populate exec_registry | Passthrough behavior | _build_collision_safe_tool_specs_and_registry() | Passthrough=True | Checks exec_reg == {} | MED - Mode logic |  | Passthrough skips exec registry | None |
| test_pick_executor_preference_builtin | Test that _pick_executor prefers builtin entries first | Executor preference order | _build_collision_safe_tool_specs_and_registry() | Builtin + OWUI same name | Checks builtin callable chosen | MED - Priority logic |  | Builtin takes precedence | None |
| test_pick_executor_fallback_to_owui | Test that _pick_executor falls back to OWUI when no builtin | Executor fallback | _build_collision_safe_tool_specs_and_registry() | OWUI only | Checks OWUI callable chosen | MED - Fallback |  | Falls back to OWUI | None |
| test_pick_executor_fallback_to_direct | Test that _pick_executor falls back to direct when no builtin/owui | Executor fallback chain | _build_collision_safe_tool_specs_and_registry() | Direct + extra | Checks direct callable chosen | MED - Fallback chain |  | Falls back to direct | None |
| test_strictify_applied_to_tools | Test that strictify is applied to tool parameters | Strictify application | _build_collision_safe_tool_specs_and_registry() | strictify=True | Checks additionalProperties: false | LOW - Strictify |  | Applies strictify to all tools | None |
| test_direct_registry_without_origin_key_uses_generated | Test that direct registry entries without origin_key get generated one | Origin key generation | _build_collision_safe_tool_specs_and_registry() | Direct without origin_key | Checks tool name correct | LOW - Key generation |  | Generates missing origin keys | None |
| test_owui_registry_without_origin_key_uses_generated | Test that OWUI registry entries without origin_key get generated one | Origin key generation | _build_collision_safe_tool_specs_and_registry() | OWUI without origin_key | Checks tool name correct | LOW - Key generation |  | Generates missing origin keys | None |
| test_exec_registry_cfg_without_spec_dict | Test exec_registry handling when tool_cfg has non-dict spec | Spec validation | _build_collision_safe_tool_specs_and_registry() | Request tool | Checks spec updated properly | LOW - Validation |  | Handles spec updates | None |
| test_build_tools_with_real_pipe | Test build_tools with a real Pipe instance's valves | Integration test | build_tools() with real pipe | Pipe instance, mock body | Checks tool built | LOW - Integration |  | Works with real pipe | None |
| test_collision_safe_registry_with_pipe_execution | Test that tools from collision-safe registry can be executed | End-to-end execution | Full flow: registry -> execution | Pipe execution | Checks tool executed with correct output | HIGH - E2E |  | Full execution flow works | None |
| test_string_containing_call_id | String containing call_id should return True | String search | _args_reference_call() | String with call ID | Checks True | LOW - String search |  | Detects call ID in string | None |
| test_string_not_containing_call_id | String not containing call_id should return False | String search negative | _args_reference_call() | String without call ID | Checks False | LOW - String search |  | Doesn't false positive | None |
| test_dict_with_nested_call_id | Dict containing call_id in nested structure should return True | Dict traversal | _args_reference_call() | Nested dict | Checks True | MED - Recursion |  | Traverses nested dicts | None |
| test_dict_without_call_id | Dict not containing call_id should return False | Dict traversal negative | _args_reference_call() | Dict without call ID | Checks False | MED - Recursion |  | Doesn't false positive in dicts | None |
| test_list_with_nested_call_id | List containing call_id in nested structure should return True | List traversal | _args_reference_call() | Nested list | Checks True | MED - Recursion |  | Traverses nested lists | None |
| test_list_without_call_id | List not containing call_id should return False | List traversal negative | _args_reference_call() | List without call ID | Checks False | MED - Recursion |  | Doesn't false positive in lists | None |
| test_deeply_nested_structure | Deeply nested structure containing call_id should return True | Deep recursion | _args_reference_call() | Deeply nested | Checks True for present, False for missing | MED - Deep recursion |  | Handles deep nesting | None |
| test_integer_returns_false | Integer type should return False | Type handling | _args_reference_call() | Integer | Checks False | LOW - Type handling |  | Handles integers | None |
| test_float_returns_false | Float type should return False | Type handling | _args_reference_call() | Float | Checks False | LOW - Type handling |  | Handles floats | None |
| test_none_returns_false | None type should return False | None handling | _args_reference_call() | None | Checks False | LOW - None handling |  | Handles None | None |
| test_bool_returns_false | Boolean type should return False | Boolean handling | _args_reference_call() | True/False | Checks False | LOW - Type handling |  | Handles booleans | None |
| test_empty_string | Empty string should return False | Empty string | _args_reference_call() | "" | Checks False | LOW - Edge case |  | Handles empty string | None |
| test_empty_dict | Empty dict should return False | Empty dict | _args_reference_call() | {} | Checks False | LOW - Edge case |  | Handles empty dict | None |
| test_empty_list | Empty list should return False | Empty list | _args_reference_call() | [] | Checks False | LOW - Edge case |  | Handles empty list | None |
| test_same_name_allows_batching | Calls with same name should be batchable | Batching logic | _can_batch_tool_calls() | Same tool name | Checks True | MED - Batching |  | Same name batchable | None |
| test_different_names_blocks_batching | Calls with different names should not be batchable | Batching logic | _can_batch_tool_calls() | Different names | Checks False | MED - Batching |  | Different names not batchable | None |
| test_depends_on_in_first_blocks | depends_on in first call should block batching | Dependency detection | _can_batch_tool_calls() | First has depends_on | Checks False | MED - Dependencies |  | depends_on blocks batching | None |
| test_depends_on_in_candidate_blocks | depends_on in candidate call should block batching | Dependency detection | _can_batch_tool_calls() | Candidate has depends_on | Checks False | MED - Dependencies |  | depends_on blocks batching | None |
| test_underscore_depends_on_blocks | _depends_on in args should block batching | Alternative dependency key | _can_batch_tool_calls() | _depends_on in args | Checks False | MED - Dependencies |  | _depends_on blocks batching | None |
| test_sequential_blocks | sequential in args should block batching | Sequential flag | _can_batch_tool_calls() | sequential=True | Checks False | MED - Sequential |  | sequential blocks batching | None |
| test_no_batch_blocks | no_batch in args should block batching | No-batch flag | _can_batch_tool_calls() | no_batch=True | Checks False | MED - No-batch |  | no_batch blocks batching | None |
| test_candidate_references_first_call_id | Candidate referencing first's call_id should block batching | Cross-reference detection | _can_batch_tool_calls() | Candidate refs first | Checks False | HIGH - Cross-ref |  | Cross-refs block batching | None |
| test_first_references_candidate_call_id | First referencing candidate's call_id should block batching | Cross-reference detection | _can_batch_tool_calls() | First refs candidate | Checks False | HIGH - Cross-ref |  | Cross-refs block batching | None |
| test_missing_call_id_in_first | Missing call_id in first should still allow batching check | Missing ID handling | _can_batch_tool_calls() | First missing call_id | Checks True | MED - Edge case |  | Handles missing IDs | None |
| test_missing_call_id_in_candidate | Missing call_id in candidate should still allow batching check | Missing ID handling | _can_batch_tool_calls() | Candidate missing call_id | Checks True | MED - Edge case |  | Handles missing IDs | None |
| test_basic_single_item_execution | Single item should be executed and queue terminated | Basic worker loop | _tool_worker_loop() | Single item + None | Checks batch == [["call-1"]] | MED - Worker loop |  | Basic execution works | None |
| test_batch_same_tool_name | Multiple calls with same name should be batched | Batching behavior | _tool_worker_loop() | 3 same-name calls | Checks batched together | HIGH - Batching |  | Batches same-name tools | None |
| test_batch_different_tools_split | Different tool names should create separate batches | Batch splitting | _tool_worker_loop() | Mixed tool names | Checks separate batches | HIGH - Batching |  | Splits different tools | None |
| test_batch_cap_enforced | Batch cap should limit batch size | Batch size limit | _tool_worker_loop() | 5 items, cap=2 | Checks >= 3 batches | MED - Cap enforcement |  | Enforces batch cap | None |
| test_allow_batch_false_no_batching | Items with allow_batch=False should not be batched | Allow-batch flag | _tool_worker_loop() | allow_batch=False | Checks separate batches | MED - Flag handling |  | Respects allow_batch flag | None |
| test_idle_timeout_triggers_break | Idle timeout should break loop and set timeout_error | Idle timeout | _tool_worker_loop() | idle_timeout=0.01 | Checks timeout_error set | HIGH - Timeout |  | Idle timeout works | None |
| test_idle_timeout_zero_message_variant | Idle timeout of 0 should use alternate message | Timeout message | _tool_worker_loop() | idle_timeout=0.001 | Checks timeout_error not None | LOW - Message variant |  | Handles small timeout | None |
| test_none_idle_timeout_waits_indefinitely | None idle_timeout should wait for items without timeout | None timeout | _tool_worker_loop() | idle_timeout=None | Checks no timeout_error | MED - None timeout |  | None timeout waits indefinitely | None |
| test_none_item_terminates_with_pending | None item should terminate loop; pending items continue if available | None termination | _tool_worker_loop() | Immediate None | Checks batches == [] | LOW - Termination |  | None terminates cleanly | None |
| test_none_in_batch_collection_requeues | None encountered during batch collection should be re-added to pending | None in batch | _tool_worker_loop() | Call + None | Checks batch processed | MED - None handling |  | None during batch handled | None |
| test_unbatchable_next_requeues_to_pending | Non-batchable next item should be re-added to pending | Pending requeue | _tool_worker_loop() | Different tool names | Checks separate batches | MED - Requeue logic |  | Requeues unbatchable items | None |
| test_finally_cleanup_resolves_pending_futures | Finally block should resolve pending futures with cancellation | Finally cleanup | _tool_worker_loop() finally | Pre-resolved future | Checks future done | MED - Cleanup |  | Finally cleans up | None |
| test_finally_cleanup_with_undone_future | Finally block should set result on undone futures | Finally with undone | _tool_worker_loop() finally | Slow execution + timeout | Checks timeout_error set | HIGH - Cleanup |  | Finally handles undone futures | None |
| test_task_done_called_for_from_queue_items | task_done should be called for items from queue | Queue management | _tool_worker_loop() | Queue items | Checks queue.join() succeeds | MED - Queue mgmt |  | Calls task_done properly | None |
| test_batch_with_dependent_items_splits | Items with dependencies should not be batched together | Dependency splitting | _tool_worker_loop() | Dependent items | Checks separate batches | HIGH - Dependencies |  | Dependencies split batches | None |
| test_empty_queue_immediate_none | Empty queue with immediate None should exit cleanly | Empty queue | _tool_worker_loop() | Immediate None | Checks batches == [], no timeout | LOW - Edge case |  | Handles empty queue | None |
| test_multiple_batches_same_tool_cap_limit | Multiple items of same tool with low cap should create multiple batches | Multiple batches | _tool_worker_loop() | 3 items, cap=2 | Checks 2 batches | MED - Multiple batches |  | Creates multiple batches | None |
| test_pending_with_none_continues_processing | Pending None item should allow processing to continue | Pending None | _tool_worker_loop() | Different tools + None | Checks both processed | MED - None handling |  | Processes pending None correctly | None |
| test_idle_timeout_preserves_first_error | Second timeout should not overwrite first timeout_error | Error preservation | _tool_worker_loop() | Pre-set error + timeout | Checks original error preserved | MED - Error handling |  | Preserves first error | None |
| test_cross_reference_blocks_batch | Call referencing another call_id should not batch | Cross-reference | _tool_worker_loop() | Cross-referenced calls | Checks separate batches | HIGH - Cross-ref |  | Cross-refs block batching | None |
| test_queue_empty_during_batch_breaks_inner_loop | QueueEmpty during batch collection should break inner loop | QueueEmpty handling | _tool_worker_loop() | Single item | Checks batch processed | LOW - Queue behavior |  | Handles QueueEmpty | None |
| test_from_queue_false_in_pending_skips_task_done | Items with from_queue=False should not call task_done | from_queue flag | _tool_worker_loop() finally | Timeout scenario | Checks timeout_error set | MED - Flag handling |  | Handles from_queue flag | None |
| test_none_with_from_queue_true_calls_task_done | None item from queue should call task_done | None task_done | _tool_worker_loop() | None item | Checks queue.join() succeeds | LOW - Queue mgmt |  | Calls task_done for None | None |
| test_none_in_batch_collection_handled_correctly | None encountered during batch collection is properly handled | None during batch | _tool_worker_loop() | Call + None | Checks no timeout, batch processed | MED - None handling |  | None in batch handled correctly | None |
| test_already_done_future_in_finally_not_modified | Already-done futures in finally should not be modified | Done future handling | _tool_worker_loop() finally | Pre-set future | Checks original result preserved | MED - Future handling |  | Doesn't modify done futures | None |
| test_timeout_error_used_in_finally_message | timeout_error should be used in finally cancelled message | Error message | _tool_worker_loop() finally | Timeout scenario | Checks timeout_error contains "idle" | LOW - Messaging |  | Uses timeout_error in message | None |
| test_cancelled_status_in_finally_output | Cancelled items in finally should have cancelled status | Cancel status | _tool_worker_loop() finally | Timeout scenario | Checks status "cancelled" or "ok" | MED - Status |  | Sets cancelled status | None |
| test_finally_resolves_undone_futures_on_exception | Finally block should resolve undone futures when exception occurs | Exception cleanup | _tool_worker_loop() with exception | Worker that raises | Checks call2 cancelled | HIGH - Exception safety |  | Finally runs on exception | None |
| test_finally_skips_none_in_pending | Finally block should skip None items in pending list | None skip in finally | _tool_worker_loop() with exception | None in pending | No crash | LOW - None handling |  | Skips None in finally | None |
| test_finally_uses_default_message_when_no_timeout_error | Finally block should use default message when timeout_error is None | Default message | _tool_worker_loop() with exception | Worker that raises | Exception propagated | LOW - Messaging |  | Uses default message | None |
| test_finally_skips_items_from_pending_not_from_queue | Test that finally handles the from_queue flag correctly | from_queue in finally | _tool_worker_loop() | Timeout scenario | Checks timeout_error set | MED - Flag handling |  | Handles from_queue correctly | None |
| test_complex_batch_scenario | Complex scenario with mixed batchable/unbatchable items | Complex batching | _tool_worker_loop() | Mixed scenarios | Checks >= 3 batches, all done | HIGH - Integration |  | Handles complex scenarios | None |
| test_all_items_unbatchable | All items marked unbatchable should run sequentially | Sequential execution | _tool_worker_loop() | All allow_batch=False | Checks 3 separate batches | MED - Sequential |  | Runs unbatchable sequentially | None |
| test_tool_passthrough_nonstreaming_returns_tool_calls | Test that non-streaming tool passthrough mode returns tool_calls without executing them | Non-streaming passthrough | Full pipe() flow in Open-WebUI mode | aioresponses mocks, Pipe instance | Checks tool_calls in response, no execution | HIGH - Passthrough |  | Non-streaming passthrough works | None |
| test_tool_passthrough_streaming_emits_tool_calls_event | Test that streaming tool passthrough mode emits chat:tool_calls events without executing | Streaming passthrough | Full pipe() streaming in Open-WebUI mode | aioresponses mocks, Pipe instance | Checks chat:tool_calls events emitted | HIGH - Passthrough |  | Streaming passthrough emits events | None |
| test_transform_messages_to_input_replays_owui_tool_results | Test message transformation replays OWUI tool results | Message transformation | transform_messages_to_input() | Assistant + tool messages | Checks function_call and function_call_output created | MED - Transformation |  | Replays tool results correctly | None |
| test_build_tools_openwebui_mode_keeps_tools_and_does_not_strictify | Test that Open-WebUI mode passes through tools without strictification | Passthrough mode behavior | build_tools() in Open-WebUI mode | Model without tool support, strictify=True | Checks tools included, no strict applied | MED - Mode logic |  | Open-WebUI bypasses strictify | None |
| test_tool_passthrough_streaming_does_not_repeat_function_name | Test that streaming tool passthrough doesn't repeat function name in delta events | Streaming delta behavior | Streaming SSE events with deltas | aioresponses with incremental deltas | Checks name in first event only | MED - Event emission |  | Doesn't repeat function name | None |
| test_strictify_preserves_required_fields | Test that strictify preserves required fields | Strictify required handling | _strictify_schema() | Schema with required | Checks required preserved, optional nullable | LOW - Strictify |  | Preserves required fields | None |
| test_strictify_keeps_optional_fields_optional | Test that strictify keeps optional fields optional | Strictify optional handling | _strictify_schema() | Schema without required | Checks all fields nullable | LOW - Strictify |  | Makes optional nullable | None |
| test_strictify_handles_nested_objects | Test that strictify handles nested objects | Nested strictification | _strictify_schema() | Nested object schema | Checks nested required/optional handling | MED - Recursion |  | Handles nested objects | None |
| test_strictify_adds_type_to_empty_property | Test that empty property schemas get default type 'object' | Empty schema handling | _strictify_schema() | Empty property {} | Checks type "object" added | MED - Type inference |  | Adds type to empty schemas | Bug fix for empty schemas |
| test_strictify_adds_type_to_schema_with_only_description | Test that schemas with only description get default type | Description-only schema | _strictify_schema() | Description without type | Checks type "object" added | MED - Type inference |  | Infers type from description | Bug fix |
| test_strictify_handles_nested_empty_schemas | Test that nested empty schemas are handled correctly | Nested empty schemas | _strictify_schema() | Nested empty {} | Checks type added to nested | MED - Recursion |  | Handles nested empty | Bug fix |
| test_strictify_adds_type_to_empty_items | Test that empty items schemas get default type | Empty array items | _strictify_schema() | Array with empty items | Checks items type "object" | MED - Type inference |  | Adds type to empty items | Bug fix |
| test_strictify_handles_empty_anyof_branch | Test that empty anyOf branches get default type | Empty anyOf | _strictify_schema() | anyOf with empty branch | Checks type added to branch | MED - Type inference |  | Handles empty anyOf | Bug fix |
| test_strictify_infers_object_type_from_properties | Test that schemas with properties but no type get 'object' inferred | Type inference from properties | _strictify_schema() | Properties without type | Checks type inferred as object | MED - Type inference |  | Infers object from properties | Bug fix |
| test_strictify_infers_array_type_from_items | Test that schemas with items but no type get 'array' inferred | Type inference from items | _strictify_schema() | items without type | Checks type inferred as array | MED - Type inference |  | Infers array from items | Bug fix |
| test_strictify_preserves_existing_behavior_for_valid_schemas | Ensure fix doesn't break existing functionality | Regression test | _strictify_schema() | Valid schema | Checks unchanged behavior | HIGH - Regression |  | No regression from bug fixes | None |
| test_strictify_handles_auth_headers_scenario | Test the exact scenario from the bug report | Bug scenario | _strictify_schema() | session: {} | Checks type added | HIGH - Bug fix |  | Fixes reported bug | None |
| test_collision_safe_tool_renaming_executes_both | Test that colliding tools are renamed and both execute | Collision renaming + execution | Full flow: build registry + execute | Builtin + direct with same name | Checks both execute with different outputs | HIGH - Collision |  | Collision renaming works end-to-end | None |
| test_collision_safe_tool_registry_passthrough_keeps_origin_map | Test passthrough mode keeps origin map for colliding tools | Passthrough collision handling | build registry in passthrough | Request + direct same name, passthrough | Checks origin_map correct, no exec_reg | MED - Passthrough |  | Passthrough tracks origins | None |
| test_registry_tool_ids_tool_still_executes | Test registry tools with IDs still execute | Registry execution | Full flow: OWUI registry + execute | OWUI registry tool | Checks tool executes | MED - Registry |  | Registry tools execute | None |
| test_args_reference_call_detects_nested_call_ids | Test nested call ID detection | Nested call ID search | _args_reference_call() | Nested structure | Checks True for present, False for absent | MED - Recursion |  | Detects nested call IDs | None |
| test_can_batch_tool_calls_blocks_dependencies_and_cross_refs | Test batching blocked by dependencies and cross-refs | Dependency/cross-ref blocking | _can_batch_tool_calls() | Dependencies and refs | Checks False for both | HIGH - Dependencies |  | Dependencies block batching | None |
| test_tool_worker_batches_and_executes_separately | Test worker batches and executes tools | Worker batching | _tool_worker_loop() | Mixed tool names | Checks correct batching | HIGH - Worker |  | Worker batches correctly | None |
| test_tool_worker_idle_timeout_sets_error | Test worker idle timeout sets error | Worker timeout | _tool_worker_loop() | idle_timeout=0.01 | Checks timeout_error with "idle" | MED - Timeout |  | Worker timeout works | None |
| test_tool_exception_logs_stack_trace | Test tool exceptions log stack traces | Exception logging | _execute_tool_batch() | Tool that raises | Checks debug log with exc_info | MED - Logging |  | Exceptions logged with stack trace | None |
| test_execute_function_calls_rejects_empty_string_args_when_required | Test empty string args rejected when params required | Required param validation | _execute_function_calls() | Empty args with required | Checks not called, error output | LOW - Validation |  | Rejects empty args when required | None |
| test_shutdown_tool_context_times_out_and_cancels | Test shutdown timeout cancels workers | Shutdown timeout | _shutdown_tool_context() | Stuck worker, short timeout | Checks task cancelled, warning logged | HIGH - Shutdown |  | Shutdown timeout works | None |
| test_chat_tools_to_responses_tools_converts_function_shape | Test Chat Completions tools converted to Responses API shape | Tool format conversion | _chat_tools_to_responses_tools() | Chat format tools | Checks flattened to Responses format | MED - Conversion |  | Converts tool formats | None |
| test_responsesbody_from_completions_keeps_and_normalizes_tools | Test ResponsesBody from Completions keeps and normalizes tools | Body conversion | ResponsesBody.from_completions() | Completions with tools | Checks tools normalized in body | MED - Conversion |  | Normalizes tools in conversion | None |

### Summary

- **Total Tests**: 216
- **Coverage Target**: 90%+ for tools module (tool_executor.py, tool_registry.py, tool_worker.py)
- **High Drift Risk**: 10 tests (collision logic, batching, cross-references, dependencies, passthrough, shutdown, exception handling)
- **Medium Drift Risk**: 82 tests (async behavior, timeouts, queue management, registry logic, type inference, error handling)
- **Low Drift Risk**: 124 tests (validation, type checks, edge cases, happy paths)

### Key Test Areas

1. **Tool Execution** (tests 1-52): Context-based and legacy execution paths, error handling, timeouts, circuit breakers
2. **Tool Registry** (tests 53-126): Building, deduplication, normalization, collision handling, strictification
3. **Tool Worker** (tests 127-172): Batching logic, dependencies, cross-references, timeouts, cleanup
4. **Tool Passthrough** (tests 173-177): Open-WebUI mode, streaming/non-streaming, event emission
5. **Tool Schema** (tests 178-189): Strictification, type inference, bug fixes for empty schemas
6. **Integration** (tests 190-216): End-to-end flows, collision renaming, execution, conversions

### Critical Findings

1. **Type Inference Bug Fixes**: Tests 178-189 cover fixes for empty schemas missing type field (bug reported by users)
2. **Collision Handling**: Tests verify complete collision detection, renaming, and execution flow
3. **Batching Logic**: Extensive coverage of batching rules, dependencies, cross-references
4. **Passthrough Mode**: Full coverage of Open-WebUI tool passthrough (streaming and non-streaming)
5. **Exception Safety**: Comprehensive exception handling throughout tool execution chain


## `tests/test_transform_messages.py`

| Test Name | Description | What It Tests | Code Under Test | Mocks/Fixtures | Assertions | Drift Risk | Check Done | Codex Notes | Codex TODO |
|-----------|-------------|---------------|-----------------|----------------|------------|------------|------------|-------------|------------|
| test_transform_messages_skips_orphaned_function_calls | Verifies orphaned function_call artifacts (with no matching output) are excluded from transformed output | Function call artifact filtering when no corresponding function_call_output exists | `Pipe.transform_messages_to_input`, `_classify_function_call_artifacts` | Helper `_run_transform` creates Pipe instance; custom artifact loader returns artifacts by ULID | Asserts no function_call type entries exist in tool_entries when output is missing | Medium - depends on artifact marker serialization format and orphan detection logic | Yes | Uses `generate_item_id()` for ULID generation and `_serialize_marker()` for embedding | None |
| test_transform_messages_keeps_complete_function_call_pairs | Verifies complete function_call/function_call_output pairs are preserved in output | Function call artifact retention when both call and output exist with matching call_id | `Pipe.transform_messages_to_input`, `_classify_function_call_artifacts` | Helper `_run_transform` creates Pipe instance; custom artifact loader returns paired artifacts | Asserts tool_entries contain both function_call and function_call_output with matching call_id "tool_ok" | Medium - depends on call_id matching logic and artifact pair detection | Yes | Tests the happy path for tool call/output pairs | None |
| test_transform_messages_skips_orphaned_function_call_outputs | Verifies orphaned function_call_output artifacts (with no matching call) are excluded | Function call output artifact filtering when no corresponding function_call exists | `Pipe.transform_messages_to_input`, `_classify_function_call_artifacts` | Helper `_run_transform` creates Pipe instance; custom artifact loader returns orphan output | Asserts no function_call_output type entries exist in tool_entries when call is missing | Medium - depends on orphan output detection logic | Yes | Inverse of orphaned function_calls test | None |
| test_classify_function_call_artifacts_partitions_sets | Verifies the classifier correctly partitions artifacts into valid pairs, orphan calls, and orphan outputs | Direct unit test of `_classify_function_call_artifacts` helper function | `_classify_function_call_artifacts` | None - direct function call with test payloads | Asserts valid set contains "shared", orphan_calls contains "only_call", orphan_outputs contains "only_output" | Low - tests isolated helper function with explicit inputs | Yes | Tests function directly without going through Pipe; includes irrelevant artifact type "reasoning" | None |
| test_transform_limits_user_images | Verifies image count limiting per MAX_INPUT_IMAGES_PER_REQUEST valve setting | Image limit enforcement and status emission when excess images are dropped | `Pipe.transform_messages_to_input` with MAX_INPUT_IMAGES_PER_REQUEST=1 | `pipe_instance_async` fixture; monkeypatched `_inline_owui_file_id`; fake event emitter; `_reset_model_specs` autouse fixture; `ModelFamily.set_dynamic_specs` for vision model | Asserts only 1 image retained (img-a), and "Dropped" appears in status messages | Medium - depends on valve configuration, ModelFamily specs, and status emission format | Yes | Sets vision feature via dynamic specs; uses fake inline returning data URL with file_id | None |
| test_transform_falls_back_to_assistant_images | Verifies assistant message images are extracted and rehydrated into following user turn | Image extraction from assistant markdown and injection into user message content | `Pipe.transform_messages_to_input` with vision model | `pipe_instance_async` fixture; monkeypatched `_inline_owui_file_id`; `_reset_model_specs` autouse fixture | Asserts user turn content contains input_image with assistant-img URL | High - depends on markdown image parsing and cross-message image rehydration logic | Yes | Tests fallback behavior for assistant-generated images that need to be referenced | None |
| test_transform_rehydration_drops_uninlineable_assistant_images | Verifies assistant images that fail to inline are dropped while successful ones are kept | Error handling during image inlining when some files are unavailable | `Pipe.transform_messages_to_input` with vision model | `pipe_instance_async` fixture; monkeypatched `_inline_owui_file_id` returns None for "missing-img"; `_reset_model_specs` autouse fixture | Asserts exactly 1 image (ok-img) retained, missing-img dropped | Medium - depends on inline failure handling and partial success behavior | Yes | Tests graceful degradation when some images cannot be fetched | None |
| test_transform_respects_user_turn_only_selection | Verifies IMAGE_INPUT_SELECTION="user_turn_only" prevents assistant image fallback | Valve-controlled image selection mode that ignores assistant message images | `Pipe.transform_messages_to_input` with IMAGE_INPUT_SELECTION="user_turn_only" | `pipe_instance_async` fixture; monkeypatched `_inline_owui_file_id`; `_reset_model_specs` autouse fixture | Asserts no input_image blocks in user turn content despite assistant having images | Medium - depends on IMAGE_INPUT_SELECTION valve implementation | Yes | Tests configuration that disables assistant image rehydration | None |
| test_transform_skips_images_when_model_lacks_vision | Verifies images are dropped with status warning when model lacks vision capability | Vision capability detection and graceful handling for text-only models | `Pipe.transform_messages_to_input` with text-only model (no vision feature) | `pipe_instance_async` fixture; monkeypatched `_inline_owui_file_id`; fake event emitter; `_reset_model_specs` autouse fixture; `ModelFamily.set_dynamic_specs` with empty features | Asserts no input_image blocks in content, and status contains "does not accept image inputs" | Medium - depends on ModelFamily feature detection and status messaging | Yes | Uses empty feature set to simulate text-only model | None |
| test_transform_preserves_system_and_developer_message_text_exactly | Verifies system and developer messages preserve exact text including whitespace | Text content preservation without normalization for system/developer roles | `Pipe.transform_messages_to_input` | `pipe_instance_async` fixture; `_reset_model_specs` autouse fixture | Asserts exact match of transformed system message with leading/trailing whitespace preserved; asserts developer message content blocks preserve exact text | Low - tests basic text preservation which is fundamental behavior | Yes | Tests both string content and array content with mixed types for developer role | None |


## `tests/test_valve_validation.py`

| Test Name | Description | What It Tests | Code Under Test | Mocks/Fixtures | Assertions | Drift Risk | Check Done | Codex Notes | Codex TODO |
|-----------|-------------|---------------|-----------------|----------------|------------|------------|------------|-------------|------------|
| `TestEncryptedStr::test_encrypted_str_roundtrip` | Verifies EncryptedStr encryption and decryption work correctly with WEBUI_SECRET_KEY | Full roundtrip: encrypt plaintext  verify encrypted format  decrypt  verify original value recovered | `EncryptedStr.encrypt()`, `EncryptedStr.decrypt()` methods (lines ~483-515 in main code) | `monkeypatch` fixture to set `WEBUI_SECRET_KEY="unit-test-webui-secret"` | `encrypted != original_value`, `encrypted.startswith("encrypted:")`, `decrypted == original_value` | Medium - relies on stable Fernet encryption format and prefix convention | Yes | Tests encryption when secret key is available; validates encrypted prefix format | Verify encryption algorithm hasn't changed; check key derivation logic |
| `TestEncryptedStr::test_encrypted_str_without_webui_secret` | Verifies values are stored/returned plaintext when no WEBUI_SECRET_KEY exists | No-encryption fallback path: encrypt without key  decrypt without key  verify passthrough behavior | `EncryptedStr.encrypt()`, `EncryptedStr.decrypt()` no-key code paths | `monkeypatch` fixture to delete `WEBUI_SECRET_KEY` | `encrypted == value`, `decrypted == value` | Low - fallback behavior is simple passthrough | Yes | Tests graceful degradation when encryption isn't configured | Ensure no exceptions raised in no-key scenarios |
| `TestEncryptedStr::test_encrypt_empty_string_returns_early` | Verifies empty string early return without encryption (line 483) | Edge case: empty string input returns immediately without processing | `EncryptedStr.encrypt()` early return path for empty strings (line 483) | `monkeypatch` fixture to set `WEBUI_SECRET_KEY` | `result == ""` | Low - early return is straightforward | Yes | Explicit line 483 coverage; prevents unnecessary encryption operations | Verify line number still accurate after refactoring |
| `TestEncryptedStr::test_encrypt_already_encrypted_returns_early` | Verifies already-encrypted values return immediately (line 483 startswith check) | Edge case: idempotency check prevents double encryption | `EncryptedStr.encrypt()` early return path for "encrypted:" prefix (line 483) | `monkeypatch` fixture to set `WEBUI_SECRET_KEY` | `result == already_encrypted` | Low - prefix check is simple | Yes | Tests idempotency; prevents double-encryption bugs | Verify prefix constant hasn't changed |
| `TestEncryptedStr::test_decrypt_with_invalid_token_returns_original` | Verifies malformed encrypted data returns gracefully (lines 512-515) | Error handling: InvalidToken exception caught and original value returned | `EncryptedStr.decrypt()` exception handling for malformed data (lines 512-515) | `monkeypatch` fixture to set `WEBUI_SECRET_KEY` | `result == malformed` | Medium - relies on Fernet exception type and exception handling | Yes | Tests defensive programming; prevents crashes on corrupted data | Verify exception type still matches; check if logging exists |
| `TestUserValveInheritNormalization::test_user_valve_inherit_converted_to_none` | Verifies 'inherit' string is converted to None by validator (lines 1453-1454) | Validator execution: _normalize_inherit converts "inherit" to None before Pydantic validation | `Pipe.UserValves` validator `_normalize_inherit` (lines 1453-1454) | None | ValidationError raised with `input_type=NoneType` in error message | Medium - depends on validator ordering and Pydantic internals | Yes | Proves validator runs and transforms input; documents that None causes validation error for Literal fields | Verify validator still exists; check if Literal field definition changed |
| `TestUserValveInheritNormalization::test_user_valve_inherit_case_insensitive` | Verifies 'INHERIT', 'Inherit', '  inherit  ' all normalize to None | Case-insensitive and whitespace-tolerant normalization | `Pipe.UserValves` validator `_normalize_inherit` case/whitespace handling | None | ValidationError raised with `input_type=NoneType` for all variants | Low - string normalization is straightforward | Yes | Tests robustness of inherit detection; prevents user input variations from bypassing logic | Add more edge cases like tabs, mixed whitespace |
| `TestValveNumericBounds::test_valve_numeric_bounds_enforced` | Verifies Pydantic ge/le constraints reject invalid numeric valve values | Field constraints: tests minimum value enforcement on numeric settings | `Pipe.Valves` field constraints: `HTTP_CONNECT_TIMEOUT_SECONDS`, `MAX_CONCURRENT_REQUESTS`, `SSE_WORKERS_PER_REQUEST` | None | ValidationError raised for all three zero-value attempts | Low - Pydantic constraint enforcement is stable | Yes | Tests data integrity; prevents configuration errors that would cause runtime failures | Add tests for upper bounds (le constraints); test boundary values (1, max) |
| `TestValveEnvironmentDefaults::test_default_log_level_from_env` | Verifies LOG_LEVEL defaults from GLOBAL_LOG_LEVEL environment variable | Environment integration: LOG_LEVEL valve reads from env var | `Pipe.Valves` LOG_LEVEL field default factory | `monkeypatch` fixture to set `GLOBAL_LOG_LEVEL="DEBUG"` | `valves.LOG_LEVEL == "DEBUG"` | Medium - depends on env var naming and default factory implementation | Yes | Tests configuration source priority; validates environment variable integration | Check if env var name changed; verify precedence over hardcoded defaults |
| `TestValveEnvironmentDefaults::test_invalid_log_level_env_falls_back_to_info` | Verifies invalid GLOBAL_LOG_LEVEL values are normalized to INFO | Validation: invalid log level falls back to safe default | `Pipe.Valves` LOG_LEVEL normalization/validation logic | `monkeypatch` fixture to set `GLOBAL_LOG_LEVEL="nope"` | `valves.LOG_LEVEL == "INFO"` | Low - fallback to INFO is defensive | Yes | Tests error handling for misconfiguration; prevents invalid log levels | Check if normalization happens in validator or field default; verify INFO is still default |
| `TestValveEnvironmentDefaults::test_api_key_default_from_env` | Verifies API_KEY defaults from OPENROUTER_API_KEY environment variable | Environment integration: API_KEY reads from env and encrypts | `Pipe.Valves` API_KEY field default factory with EncryptedStr | `monkeypatch` fixture to set `OPENROUTER_API_KEY`, delete `WEBUI_SECRET_KEY` | `isinstance(valves.API_KEY, EncryptedStr)`, decrypted value equals env var | Medium - depends on env var name and encryption integration | Yes | Tests secrets management; validates environment variable to encrypted field flow | Verify env var name unchanged; test with WEBUI_SECRET_KEY present |
| `TestValveValidation::test_valve_boolean_defaults` | Verifies boolean valve fields have correct type defaults | Type checking: ensures boolean fields are actually booleans | `Pipe.Valves` boolean fields: `AUTO_FALLBACK_CHAT_COMPLETIONS`, `PERSIST_TOOL_RESULTS`, `ENCRYPT_ALL`, `ENABLE_LZ4_COMPRESSION` | None | `isinstance()` checks for all four boolean fields | Low - type enforcement is stable | Yes | Tests data model integrity; prevents type confusion | Expand to verify actual default values (True/False); check for new boolean fields |
| `TestValveValidation::test_valve_pattern_defaults` | Verifies pattern valve fields are strings and default to empty | Type and default checking: glob pattern fields start as empty strings | `Pipe.Valves` pattern fields: `FORCE_CHAT_COMPLETIONS_MODELS`, `FORCE_RESPONSES_MODELS` | None | `isinstance()` checks for string type | Low - string field type is stable | Yes | Tests configuration fields for model filtering; verifies sensible defaults | Add assertion for empty string default; test pattern parsing logic |
| `TestValveValidation::test_valve_encryption_key_default` | Verifies ARTIFACT_ENCRYPTION_KEY defaults to empty EncryptedStr | Type and default checking: encryption key field initialized properly | `Pipe.Valves` ARTIFACT_ENCRYPTION_KEY field | None | `isinstance(valves.ARTIFACT_ENCRYPTION_KEY, EncryptedStr)`, decrypted value equals empty string | Low - field initialization is straightforward | Yes | Tests artifact encryption setup; validates empty default for optional key | Check if empty string is correct default or should be None |
| `TestValveValidation::test_valve_compression_settings` | Verifies compression valve settings are validated | Type and constraint checking: compression feature configuration | `Pipe.Valves` compression fields: `ENABLE_LZ4_COMPRESSION`, `MIN_COMPRESS_BYTES` | None | `isinstance()` for boolean, `>= 0` constraint for min bytes | Low - simple field validation | Yes | Tests performance optimization feature configuration | Add more specific assertions for default values; test actual compression thresholds |
| `TestValveValidation::test_valve_breaker_settings` | Verifies circuit breaker valve settings are validated | Constraint checking: circuit breaker positive value requirements | `Pipe.Valves` breaker fields: `BREAKER_MAX_FAILURES`, `BREAKER_WINDOW_SECONDS`, `BREAKER_HISTORY_SIZE` | None | All three fields `> 0` | Low - positive constraint is simple | Yes | Tests reliability feature configuration; prevents invalid breaker state | Add tests for breaker behavior with these settings; verify defaults are reasonable |
| `TestValveValidation::test_valve_concurrency_settings` | Verifies concurrency valve settings are validated | Constraint checking: concurrency limits properly configured | `Pipe.Valves` concurrency fields: `MAX_CONCURRENT_REQUESTS`, `MAX_PARALLEL_TOOLS_GLOBAL`, `MAX_PARALLEL_TOOLS_PER_REQUEST` | None | First field `> 0`, last two fields `>= 0` (allow zero for unlimited) | Low - numeric constraints are stable | Yes | Tests performance/safety configuration; validates concurrent operation limits | Test boundary cases (1, very large numbers); verify interaction between global and per-request limits |
