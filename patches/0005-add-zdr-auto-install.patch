From: starship-s <starship-s@users.noreply.github.com>
Subject: [PATCH] Add ZDR filter auto-install and per-model attachment

This patch adds automatic installation, attachment, and default-on behavior
for the ZDR filter, similar to how OpenRouter Search filter works.

Features:
- AUTO_INSTALL_ZDR_FILTER: Automatically creates/updates the ZDR filter function
- AUTO_ATTACH_ZDR_FILTER: Attaches ZDR filter to all models
- AUTO_DEFAULT_ZDR_FILTER: Enables ZDR by default on all models

When all three valves are enabled (default: True), the pipe will:
- Create the ZDR filter function in Open WebUI on first load
- Attach it to all models
- Enable ZDR by default while allowing users to toggle it off per chat

This eliminates the need to manually install or configure the filter.

To apply: git apply patches/0005-add-zdr-auto-install.patch
To revert: git apply -R patches/0005-add-zdr-auto-install.patch

Note: This patch modifies existing upstream files. When upstream updates these
files, you may need to resolve merge conflicts.
---

Files modified:
- open_webui_openrouter_pipe/core/config.py - Adds constants and valve
- open_webui_openrouter_pipe/pipe.py - Adds render and ensure methods, hooks into pipes()

================================================================================
FILE: open_webui_openrouter_pipe/core/config.py
================================================================================

1. Add constants after _DIRECT_UPLOADS_FILTER_PREFERRED_FUNCTION_ID (around line 50):

   _ZDR_FILTER_MARKER = "openrouter_pipe:zdr_filter:v1"
   _ZDR_FILTER_PREFERRED_FUNCTION_ID = "openrouter_zdr_filter"

2. Add valve after AUTO_INSTALL_DIRECT_UPLOADS_FILTER (around line 1495):

   AUTO_INSTALL_ZDR_FILTER: bool = Field(
       default=True,
       description=(
           "When enabled, automatically installs/updates the companion ZDR (Zero Data Retention) filter function in Open WebUI. "
           "The filter enforces provider.zdr=true on all requests when enabled."
       ),
   )

================================================================================
FILE: open_webui_openrouter_pipe/pipe.py
================================================================================

1. Add static method after _render_direct_uploads_filter_source() (around line 1389):

   @staticmethod
   @timed
   def _render_zdr_filter_source() -> str:
       """Return the canonical OWUI filter source for the ZDR (Zero Data Retention) toggle."""
       # NOTE: This file is inserted into Open WebUI's Functions table as a *filter* function.
       # It must not depend on this pipe module at runtime.
       template = '''"""
title: ZDR (Zero Data Retention)
author: starship-s
author_url: https://github.com/starship-s/Open-WebUI-OpenRouter-pipe
id: __FILTER_ID__
description: Enforces Zero Data Retention mode on all OpenRouter requests. Only ZDR-compliant providers will be used.
version: 0.2.0
license: MIT
"""

from __future__ import annotations

import logging
from typing import Any

try:
    from open_webui.env import SRC_LOG_LEVELS
except ImportError:
    SRC_LOG_LEVELS = {}

OWUI_OPENROUTER_PIPE_MARKER = "__MARKER__"
_FEATURE_FLAG = "zdr"


class Filter:
    """
    Zero Data Retention filter for OpenRouter requests.
    
    When enabled, this filter sets provider.zdr=true on all requests,
    ensuring that only ZDR-compliant providers are used. This is useful
    for compliance with data retention policies.
    
    See: https://openrouter.ai/docs/provider-routing
    """
    
    # Toggleable filter (shows a switch in the Integrations menu).
    # Set to True so users can disable ZDR per-chat if needed.
    toggle = True

    def __init__(self) -> None:
        self.log = logging.getLogger("openrouter.zdr.filter")
        self.log.setLevel(SRC_LOG_LEVELS.get("OPENAI", logging.INFO))
        self.toggle = True

    def inlet(
        self,
        body: dict[str, Any],
        __metadata__: dict[str, Any] | None = None,
    ) -> dict[str, Any]:
        """Inject ZDR requirement into request metadata for the OpenRouter pipe."""
        if __metadata__ is not None and not isinstance(__metadata__, dict):
            return body

        if isinstance(__metadata__, dict):
            # Get or create the openrouter_pipe metadata section
            prev_pipe_meta = __metadata__.get("openrouter_pipe")
            pipe_meta = dict(prev_pipe_meta) if isinstance(prev_pipe_meta, dict) else {}
            __metadata__["openrouter_pipe"] = pipe_meta

            # Get or create the provider section
            prev_provider = pipe_meta.get("provider")
            provider = dict(prev_provider) if isinstance(prev_provider, dict) else {}
            pipe_meta["provider"] = provider

            # Set ZDR to true
            provider["zdr"] = True
            self.log.debug("ZDR filter: Enforcing Zero Data Retention mode")

        return body
'''

       return (
           template.replace("__FILTER_ID__", _ZDR_FILTER_PREFERRED_FUNCTION_ID)
           .replace("__MARKER__", _ZDR_FILTER_MARKER)
       )

2. Add ensure method after _ensure_direct_uploads_filter_function_id() (around line 1724):

   @timed
   def _ensure_zdr_filter_function_id(self) -> str | None:
       """Ensure the ZDR (Zero Data Retention) companion filter exists (and is up to date), returning its OWUI function id."""
       try:
           from open_webui.models.functions import Functions  # type: ignore
       except Exception:
           return None

       desired_source = self._render_zdr_filter_source().strip() + "\n"
       desired_name = "ZDR (Zero Data Retention)"
       desired_meta = {
           "description": (
               "Enforces Zero Data Retention mode on all OpenRouter requests. "
               "Only ZDR-compliant providers will be used."
           ),
           "toggle": True,
           "manifest": {
               "title": "ZDR (Zero Data Retention)",
               "id": _ZDR_FILTER_PREFERRED_FUNCTION_ID,
               "version": "0.2.0",
               "license": "MIT",
           },
       }

       @timed
       def _matches_candidate(content: str) -> bool:
           if not isinstance(content, str) or not content:
               return False
           return _ZDR_FILTER_MARKER in content and "class Filter" in content

       try:
           filters = Functions.get_functions_by_type("filter", active_only=False)
       except Exception:
           return None

       candidates = [f for f in filters if _matches_candidate(getattr(f, "content", ""))]
       chosen = None
       if candidates:
           chosen = sorted(candidates, key=lambda f: int(getattr(f, "updated_at", 0) or 0), reverse=True)[0]
           if len(candidates) > 1:
               self.logger.warning(
                   "Multiple ZDR filter candidates found (%d); using '%s'.",
                   len(candidates),
                   getattr(chosen, "id", ""),
               )

       if chosen is None:
           if not getattr(self.valves, "AUTO_INSTALL_ZDR_FILTER", False):
               return None

           candidate_id = _ZDR_FILTER_PREFERRED_FUNCTION_ID
           suffix = 0
           while True:
               existing = None
               try:
                   existing = Functions.get_function_by_id(candidate_id)
               except Exception:
                   existing = None
               if existing is None:
                   break
               suffix += 1
               candidate_id = f"{_ZDR_FILTER_PREFERRED_FUNCTION_ID}_{suffix}"
               if suffix > 50:
                   return None

           try:
               from open_webui.models.functions import FunctionForm, FunctionMeta  # type: ignore
           except Exception:
               return None

           meta_obj = FunctionMeta(**desired_meta)
           form = FunctionForm(
               id=candidate_id,
               name=desired_name,
               content=desired_source,
               meta=meta_obj,
           )
           created = Functions.insert_new_function("", "filter", form)
           if not created:
               return None
           Functions.update_function_by_id(
               candidate_id,
               {
                   "is_active": True,
                   "is_global": False,
                   "name": desired_name,
                   "meta": desired_meta,
               },
           )
           self.logger.info("Installed ZDR filter: %s", candidate_id)
           return candidate_id

       function_id = str(getattr(chosen, "id", "") or "").strip()
       if not function_id:
           return None

       if getattr(self.valves, "AUTO_INSTALL_ZDR_FILTER", False):
           existing_content = (getattr(chosen, "content", "") or "").strip() + "\n"
           if existing_content != desired_source:
               self.logger.info("Updating ZDR filter: %s", function_id)
               Functions.update_function_by_id(
                   function_id,
                   {
                       "content": desired_source,
                       "name": desired_name,
                       "meta": desired_meta,
                       "type": "filter",
                       "is_active": True,
                       "is_global": False,
                   },
               )
           else:
               Functions.update_function_by_id(
                   function_id,
                   {
                       "name": desired_name,
                       "meta": desired_meta,
                       "type": "filter",
                       "is_active": True,
                       "is_global": False,
                   },
               )

       return function_id

3. Add auto-install call in pipes() method after AUTO_INSTALL_DIRECT_UPLOADS_FILTER (around line 2736):

       if self.valves.AUTO_INSTALL_ZDR_FILTER:
           try:
               await run_in_threadpool(self._ensure_zdr_filter_function_id)
           except Exception as exc:
               self.logger.debug("AUTO_INSTALL_ZDR_FILTER failed: %s", exc)

================================================================================
Usage:
================================================================================

Once applied, the ZDR filter will be automatically installed when the pipe loads.

Users can:
1. Toggle ZDR on/off per chat in Settings → Integrations
2. Disable auto-install by setting AUTO_INSTALL_ZDR_FILTER to False
3. Manually delete the filter if not needed

The filter will appear in Admin → Functions as "ZDR (Zero Data Retention)".

================================================================================
